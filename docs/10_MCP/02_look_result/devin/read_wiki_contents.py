CallToolResult(content=[TextContent(type='text', text='# Page: Overview\n\n# Overview\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThe React repository at https://github.com/facebook/react is a monorepo containing the implementation of React, a JavaScript library for building user interfaces. This repository includes:\n\n- The core `react` package providing the public API (hooks, components, JSX runtime)\n- Multiple renderer implementations for different platforms (DOM, Native, test environments)\n- The `react-reconciler` package implementing the Fiber architecture\n- Server-side rendering systems (Fizz for HTML streaming, Flight for Server Components)\n- The `scheduler` package for cooperative task scheduling\n- Build tooling, feature flags, and development tools\n\nThis document provides a high-level overview of the repository structure and major systems. For detailed information about specific subsystems, see:\n- Feature flag management: [Feature Flags System](#2)\n- Build and packaging: [Build System and Package Distribution](#3)\n- Core reconciliation algorithm: [React Reconciler](#4)\n- Server rendering: [Server-Side Rendering](#5)\n- Platform implementations: [Platform Implementations](#6)\n- Developer tools: [Developer Tools and Debugging](#7)\n\n---\n\n## Repository Structure\n\nThe React repository uses a **Yarn workspaces** monorepo structure with 13 packages under the `packages/` directory. The root [package.json:3-5]() defines the workspace configuration.\n\n```mermaid\ngraph TB\n    subgraph "Monorepo Root"\n        Root[react repository]\n        PackageJSON["package.json<br/>Workspace configuration"]\n        Scripts["scripts/<br/>Build & tooling"]\n    end\n    \n    subgraph "packages/ Directory"\n        React["react<br/>Core API"]\n        ReactDOM["react-dom<br/>DOM renderer"]\n        Reconciler["react-reconciler<br/>Fiber algorithm"]\n        Scheduler["scheduler<br/>Task scheduling"]\n        ReactNative["react-native-renderer<br/>Native platform"]\n        ReactArt["react-art<br/>Canvas/SVG renderer"]\n        TestRenderer["react-test-renderer<br/>Testing utilities"]\n        NoopRenderer["react-noop-renderer<br/>Test infrastructure"]\n        ReactIs["react-is<br/>Type checks"]\n        DevTools["react-devtools-*<br/>Debugging tools"]\n        ESLintPlugin["eslint-plugin-react-hooks<br/>Linting rules"]\n        JestReact["jest-react<br/>Test matchers"]\n        ServerPackages["react-server-dom-*<br/>Server Components"]\n    end\n    \n    Root --> PackageJSON\n    Root --> Scripts\n    Root --> React\n    Root --> ReactDOM\n    Root --> Reconciler\n    Root --> Scheduler\n    Root --> ReactNative\n    Root --> ReactArt\n    Root --> TestRenderer\n    Root --> NoopRenderer\n    Root --> ReactIs\n    Root --> DevTools\n    Root --> ESLintPlugin\n    Root --> JestReact\n    Root --> ServerPackages\n```\n\n**Sources:** [package.json:1-5](), [packages/react/package.json:1-7](), [packages/react-dom/package.json:1-10](), [packages/react-reconciler/package.json:1-10]()\n\n---\n\n## Package Categories and Dependencies\n\nThe repository\'s packages are organized by functional category:\n\n| Category | Packages | Purpose |\n|----------|----------|---------|\n| **Core API** | `react` | Public-facing React API, hooks (`useState`, `useEffect`), JSX runtime |\n| **Reconciler** | `react-reconciler` | Fiber reconciliation algorithm, work loop, scheduling |\n| **DOM Renderer** | `react-dom` | Browser DOM manipulation, event system, hydration |\n| **Native Renderer** | `react-native-renderer` | React Native platform integration |\n| **Scheduler** | `scheduler` | Cooperative task scheduling with priority queues |\n| **Server Rendering** | `react-dom` (server exports), `react-server-dom-*` | Fizz (streaming HTML), Flight (Server Components) |\n| **Test Infrastructure** | `react-test-renderer`, `react-noop-renderer`, `jest-react` | Testing utilities and test environments |\n| **Developer Tools** | `react-devtools-*`, `react-debug-tools` | Browser extensions, component inspection |\n| **Utilities** | `react-is`, `react-art` | Type checking, Canvas/SVG rendering |\n| **Linting** | `eslint-plugin-react-hooks` | Rules of Hooks enforcement |\n\n```mermaid\ngraph LR\n    subgraph "Public API Layer"\n        ReactPkg["react<br/>v19.3.0"]\n    end\n    \n    subgraph "Renderer Layer"\n        ReactDOM["react-dom<br/>Client & Server"]\n        ReactNative["react-native-renderer"]\n        ReactArt["react-art"]\n        TestRenderer["react-test-renderer"]\n    end\n    \n    subgraph "Core Engine"\n        Reconciler["react-reconciler<br/>v0.34.0<br/>Fiber algorithm"]\n        Scheduler["scheduler<br/>v0.28.0<br/>Priority queues"]\n    end\n    \n    ReactPkg -->|peer dependency| ReactDOM\n    ReactPkg -->|peer dependency| ReactNative\n    ReactPkg -->|peer dependency| ReactArt\n    ReactPkg -->|peer dependency| TestRenderer\n    \n    ReactDOM --> Reconciler\n    ReactNative --> Reconciler\n    ReactArt --> Reconciler\n    TestRenderer --> Reconciler\n    \n    Reconciler --> Scheduler\n    ReactDOM -->|dependency| Scheduler\n    ReactNative -->|dependency| Scheduler\n    ReactArt -->|dependency| Scheduler\n    TestRenderer -->|dependency| Scheduler\n```\n\n**Sources:** [packages/react/package.json:1-52](), [packages/react-dom/package.json:19-21](), [packages/react-reconciler/package.json:28-33](), [packages/scheduler/package.json:1-27]()\n\n---\n\n## Major System Components\n\nThe React codebase is organized around several interconnected systems:\n\n### Feature Flags System\n\nThe **Feature Flags** system (`ReactFeatureFlags.js` and environment-specific forks) controls which features are enabled in different deployment targets (Facebook web, React Native FB, React Native OSS, test environments). This is the highest-importance system (importance score: 820.92) as it affects all other packages.\n\nSee [Feature Flags System](#2) for detailed documentation.\n\n### Build System\n\nThe **Build System** uses **Rollup** to generate bundles across multiple module formats (CommonJS, ESM) and environments (Node.js, browser, Bun, React Native). The build is configured through:\n- `scripts/rollup/build-all-release-channels.js` - Main build orchestrator\n- `scripts/rollup/bundles.js` - Bundle definitions (importance: 365.86)\n- `scripts/rollup/forks.js` - Module replacement configuration\n- `scripts/shared/inlinedHostConfigs.js` - Renderer configurations (importance: 317.91)\n\nSee [Build System and Package Distribution](#3) for detailed documentation.\n\n### Fiber Reconciler\n\nThe **Fiber Reconciler** (`react-reconciler` package) implements React\'s core rendering algorithm. It manages:\n- Virtual DOM diffing and updates\n- Work loop with interruptible rendering\n- Lane-based priority scheduling\n- Suspense and error boundaries\n- Host configuration abstraction for platform independence\n\nSee [React Reconciler](#4) for detailed documentation.\n\n### Server Rendering\n\nReact provides two server-side rendering systems:\n- **Fizz** (`ReactFizzServer`) - Streaming HTML with Suspense support\n- **Flight** (`ReactFlightServer`) - Server Components with RSC protocol\n\nSee [Server-Side Rendering](#5) for detailed documentation.\n\n### Developer Tools\n\nThe **React DevTools** system provides component inspection, profiling, and debugging capabilities through browser extensions and standalone applications. The DevTools backend hooks into React renderers via `__REACT_DEVTOOLS_GLOBAL_HOOK__`.\n\nSee [Developer Tools and Debugging](#7) for detailed documentation.\n\n**Sources:** [scripts/rollup/build-all-release-channels.js](), [scripts/shared/inlinedHostConfigs.js](), [packages/react-reconciler/package.json:1-34]()\n\n---\n\n## Code Organization and File Structure\n\nThe repository follows a consistent structure across packages:\n\n```mermaid\ngraph TB\n    subgraph "Package Structure"\n        PkgRoot["packages/package-name/"]\n        PkgJSON["package.json<br/>Metadata, exports"]\n        SrcDir["src/<br/>Source code"]\n        NPMDir["npm/<br/>Wrapper files"]\n        CJSDir["cjs/<br/>Build output (gitignored)"]\n    end\n    \n    subgraph "Source Organization"\n        MainFiles["Entry points<br/>index.js, client.js, server.js"]\n        ImplFiles["Implementation files<br/>React*.js"]\n        ForksDir["forks/<br/>Environment-specific variants"]\n        TestsDir["__tests__/<br/>Jest test files"]\n    end\n    \n    subgraph "Build Artifacts"\n        DevBuild["*-dev.js<br/>Development builds"]\n        ProdBuild["*-prod.js<br/>Production builds"]\n        ProfileBuild["*-profiling.js<br/>Profiling builds"]\n    end\n    \n    PkgRoot --> PkgJSON\n    PkgRoot --> SrcDir\n    PkgRoot --> NPMDir\n    PkgRoot --> CJSDir\n    \n    SrcDir --> MainFiles\n    SrcDir --> ImplFiles\n    SrcDir --> ForksDir\n    SrcDir --> TestsDir\n    \n    CJSDir --> DevBuild\n    CJSDir --> ProdBuild\n    CJSDir --> ProfileBuild\n```\n\n**Key conventions:**\n\n1. **Entry points** follow naming conventions:\n   - `index.js` - Main entry point\n   - `client.js` - Client-side only code\n   - `server.js`, `server.node.js`, `server.browser.js` - Server rendering variants\n   - `*.react-server.js` - Server Components environment\n\n2. **Fork files** enable environment-specific implementations:\n   - `ReactFeatureFlags.www.js` - Facebook web\n   - `ReactFeatureFlags.native-fb.js` - React Native FB\n   - `ReactFeatureFlags.native-oss.js` - React Native OSS\n   - `ReactFiberConfig.dom.js`, `ReactFiberConfig.native.js` - Host configs\n\n3. **Shared code** lives in `packages/shared/`:\n   - `ReactVersion.js` - Current version string\n   - `ReactSymbols.js` - Internal symbols\n   - Various utility modules\n\n**Sources:** [packages/react-dom/package.json:51-126](), [packages/react/package.json:11-42](), [packages/shared/ReactVersion.js:1-16]()\n\n---\n\n## Development Tools and Configuration\n\n### ESLint Configuration\n\nThe repository uses a comprehensive ESLint configuration with custom rules:\n\n```mermaid\ngraph TB\n    subgraph "ESLint Setup"\n        MainConfig[".eslintrc.js<br/>Root configuration"]\n        CustomRules["scripts/eslint-rules/<br/>react-internal rules"]\n        Plugin["eslint-plugin-react-hooks<br/>Published package"]\n    end\n    \n    subgraph "Environment-Specific Configs"\n        CJSConfig["scripts/rollup/validate/<br/>eslintrc.cjs.js"]\n        ESMConfig["scripts/rollup/validate/<br/>eslintrc.esm.js"]\n        FBConfig["scripts/rollup/validate/<br/>eslintrc.fb.js"]\n        RNConfig["scripts/rollup/validate/<br/>eslintrc.rn.js"]\n    end\n    \n    MainConfig --> CustomRules\n    MainConfig --> Plugin\n    \n    MainConfig -.->|validates| CJSConfig\n    MainConfig -.->|validates| ESMConfig\n    MainConfig -.->|validates| FBConfig\n    MainConfig -.->|validates| RNConfig\n```\n\n**Custom rules include:**\n- `react-internal/prod-error-codes` - Enforces error code extraction\n- `react-internal/warning-args` - Validates warning message literals\n- `react-internal/safe-string-coercion` - Type-safe string conversion\n- `react-internal/no-production-logging` - Removes console calls in production\n- `no-for-of-loops` - Prevents Symbol polyfill requirement\n\n**Sources:** [.eslintrc.js:1-658](), [scripts/rollup/validate/eslintrc.cjs.js:1-112](), [packages/eslint-plugin-react-hooks/package.json:1-68]()\n\n### Flow Type Checking\n\nThe repository uses **Flow** for type checking with environment-specific configurations generated by `scripts/flow/createFlowConfigs.js`. This script creates separate `.flowconfig` files for each renderer to handle module resolution with forked implementations.\n\n```mermaid\ngraph LR\n    Template["scripts/flow/config/<br/>flowconfig template"]\n    Generator["createFlowConfigs.js<br/>Config generation"]\n    \n    Template --> Generator\n    \n    Generator --> DOMConfig["scripts/flow/dom/<br/>.flowconfig"]\n    Generator --> NativeConfig["scripts/flow/native/<br/>.flowconfig"]\n    Generator --> CustomConfig["scripts/flow/custom/<br/>.flowconfig"]\n    \n    Generator -.->|uses| HostConfigs["inlinedHostConfigs.js<br/>Renderer definitions"]\n```\n\n**Sources:** [scripts/flow/createFlowConfigs.js:1-153](), [scripts/flow/config/flowconfig:1-45](), [scripts/flow/environment.js:1-636]()\n\n### Testing Infrastructure\n\nThe repository uses **Jest** for testing with custom matchers and utilities:\n\n- `jest-react` package provides custom matchers for React-specific assertions\n- `react-test-renderer` enables snapshot testing without a DOM\n- `react-noop-renderer` provides a test-only renderer for reconciler testing\n- `internal-test-utils` contains shared test helpers\n\nTest files follow the pattern `**/__tests__/**/*.js` and are excluded from production builds.\n\n**Sources:** [package.json:121-123](), [packages/jest-react/package.json:1-32](), [packages/react-test-renderer/package.json:1-35](), [packages/react-noop-renderer/package.json:1-32]()\n\n---\n\n## Build Constants and Globals\n\nReact uses several global constants that are replaced at build time:\n\n| Constant | Purpose | Set By |\n|----------|---------|--------|\n| `__DEV__` | Development mode flag | Rollup replace plugin |\n| `__PROFILE__` | Profiling build flag | Build configuration |\n| `__EXPERIMENTAL__` | Experimental features flag | Release channel |\n| `__VARIANT__` | A/B test variant (www only) | Dynamic loading |\n| `__TEST__` | Test environment flag | Jest configuration |\n\nThese constants enable **dead code elimination** during production builds, significantly reducing bundle size.\n\n```mermaid\ngraph TB\n    subgraph "Source Code"\n        Code["Source with<br/>if (__DEV__) { ... }"]\n    end\n    \n    subgraph "Build Process"\n        RollupReplace["@rollup/plugin-replace<br/>Constant substitution"]\n        ClosureCompiler["Google Closure Compiler<br/>Dead code elimination"]\n    end\n    \n    subgraph "Output"\n        DevBundle["*-dev.js<br/>__DEV__ = true"]\n        ProdBundle["*-prod.js<br/>__DEV__ = false<br/>Dev code removed"]\n    end\n    \n    Code --> RollupReplace\n    RollupReplace --> DevBundle\n    RollupReplace --> ClosureCompiler\n    ClosureCompiler --> ProdBundle\n```\n\n**Sources:** [scripts/flow/environment.js:12-14](), [scripts/rollup/validate/eslintrc.cjs.js:43-60](), [.eslintrc.js:639-648]()\n\n---\n\n## Package Export Strategy\n\nReact packages use **conditional exports** in `package.json` to provide different entry points for different environments:\n\n```mermaid\ngraph TB\n    subgraph "Import Resolution"\n        UserImport["import { ... } from \'react-dom\'"]\n    end\n    \n    subgraph "Conditional Exports"\n        ReactServer["react-server condition<br/>react-dom.react-server.js"]\n        NodeEnv["node condition<br/>server.node.js"]\n        BrowserEnv["browser condition<br/>server.browser.js"]\n        WorkerdEnv["workerd condition<br/>server.edge.js"]\n        DefaultEnv["default<br/>index.js"]\n    end\n    \n    UserImport --> ReactServer\n    UserImport --> NodeEnv\n    UserImport --> BrowserEnv\n    UserImport --> WorkerdEnv\n    UserImport --> DefaultEnv\n```\n\nThe `exports` field in [packages/react-dom/package.json:51-126]() demonstrates this pattern:\n- `react-server` condition provides Server Components-compatible exports\n- `node`, `browser`, `workerd`, `deno`, `bun` conditions select runtime-specific code\n- `default` provides the fallback for other environments\n\n**Sources:** [packages/react-dom/package.json:51-126](), [packages/react/package.json:24-42]()\n\n---\n\n## Version and Release Management\n\nThe repository maintains version information in multiple locations:\n\n1. **Source of truth:** [packages/shared/ReactVersion.js:15]() exports the current version string (`\'19.3.0\'`)\n2. **Package manifests:** Each `package.json` declares its version\n3. **Dependency versions:** Peer and regular dependencies specify version ranges\n\nThe versioning strategy follows semantic versioning:\n- `react` and `react-dom` share the same major.minor.patch version\n- `react-reconciler` uses a separate version (`0.34.0`)\n- `scheduler` has an independent version (`0.28.0`)\n\n**Sources:** [packages/shared/ReactVersion.js:1-16](), [packages/react/package.json:7](), [packages/react-dom/package.json:3](), [packages/react-reconciler/package.json:4](), [packages/scheduler/package.json:3]()\n\n---\n\n# Page: Repository Structure and Packages\n\n# Repository Structure and Packages\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes the organizational structure of the React monorepo, detailing how packages are arranged within the Yarn workspaces, their interdependencies, and their specific purposes. It covers core library packages, platform-specific renderers, server-side rendering packages, and development tooling packages.\n\nFor information about the build system that processes these packages, see [Build System and Package Distribution](#3). For details on feature flag configuration that affects package behavior across environments, see [Feature Flags System](#2).\n\n---\n\n## Monorepo Workspace Structure\n\nThe React repository is organized as a Yarn monorepo using workspaces. The root [`package.json:3-4`]() declares a single workspace pattern:\n\n```json\n"workspaces": [\n  "packages/*"\n]\n```\n\nAll publishable and internal packages reside under the `packages/` directory. The workspace configuration allows packages to reference each other using symbolic links during development, while maintaining separate `package.json` files for individual publishing.\n\n### Workspace Configuration Diagram\n\n```mermaid\ngraph TB\n    Root["Root package.json<br/>Workspace manager<br/>Shared devDependencies"]\n    PackagesDir["packages/ directory<br/>13 workspace members"]\n    \n    React["react/<br/>Core library API"]\n    ReactDOM["react-dom/<br/>DOM renderer"]\n    ReactReconciler["react-reconciler/<br/>Fiber reconciler"]\n    Scheduler["scheduler/<br/>Cooperative scheduler"]\n    ReactNative["react-native-renderer/<br/>Native renderer"]\n    ReactArt["react-art/<br/>Canvas/SVG renderer"]\n    ReactTestRenderer["react-test-renderer/<br/>Test snapshot renderer"]\n    ReactNoop["react-noop-renderer/<br/>Test reconciler"]\n    EslintPlugin["eslint-plugin-react-hooks/<br/>Hooks linting rules"]\n    ReactIs["react-is/<br/>Type checking utilities"]\n    JestReact["jest-react/<br/>Test matchers"]\n    Shared["shared/<br/>Internal utilities"]\n    \n    Root --> PackagesDir\n    PackagesDir --> React\n    PackagesDir --> ReactDOM\n    PackagesDir --> ReactReconciler\n    PackagesDir --> Scheduler\n    PackagesDir --> ReactNative\n    PackagesDir --> ReactArt\n    PackagesDir --> ReactTestRenderer\n    PackagesDir --> ReactNoop\n    PackagesDir --> EslintPlugin\n    PackagesDir --> ReactIs\n    PackagesDir --> JestReact\n    PackagesDir --> Shared\n```\n\n**Sources:** [`package.json:1-164`](), [`packages/react/package.json`](), [`packages/react-dom/package.json`]()\n\n---\n\n## Core Library Packages\n\n### react\n\nThe `react` package provides the foundational API for building user interfaces, including:\n- Component base classes and hooks API\n- JSX transformation runtime (`jsx-runtime.js`, `jsx-dev-runtime.js`)\n- React Server Components support (`react.react-server.js`)\n- Compiler runtime support (`compiler-runtime.js`)\n\n**Package Configuration:**\n\n| Property | Value |\n|----------|-------|\n| Main Entry | `index.js` |\n| Version | `19.3.0` |\n| Peer Dependencies | None (provides base API) |\n\nThe package exports multiple entry points via the `exports` field in [`packages/react/package.json:24-42`]():\n- `.` - Main React API with conditional `react-server` export\n- `./jsx-runtime` - JSX transformation runtime\n- `./jsx-dev-runtime` - Development JSX runtime with debugging\n- `./compiler-runtime` - React Compiler support functions\n\n**Sources:** [`packages/react/package.json:1-52`](), [`packages/shared/ReactVersion.js:15`]()\n\n### react-dom\n\nThe `react-dom` package implements the DOM renderer with extensive platform-specific entry points:\n\n**Client-Side Rendering:**\n- `client.js` - Modern client entry using `createRoot`\n- `index.js` - Legacy and compatibility entry\n\n**Server-Side Rendering:**\n- `server.node.js` - Node.js streaming SSR\n- `server.browser.js` - Browser-compatible SSR\n- `server.edge.js` - Edge runtime SSR\n- `server.bun.js` - Bun runtime SSR\n- `static.node.js` - Static pre-rendering for Node.js\n- `static.browser.js` - Static pre-rendering for browsers\n- `static.edge.js` - Static pre-rendering for edge runtimes\n\n**Testing Utilities:**\n- `test-utils.js` - DOM testing helpers\n- `unstable_testing.js` - Experimental testing APIs\n\nThe package uses conditional exports to select the appropriate implementation based on runtime environment. From [`packages/react-dom/package.json:51-125`](), the exports use conditions like `react-server`, `workerd`, `bun`, `deno`, `worker`, `node`, `edge-light`, and `browser`.\n\n**Dependencies:**\n\n| Dependency | Type | Version |\n|------------|------|---------|\n| `scheduler` | Dependency | `^0.28.0` |\n| `react` | Peer Dependency | `^19.3.0` |\n\n**Sources:** [`packages/react-dom/package.json:1-127`]()\n\n### react-reconciler\n\nThe `react-reconciler` package exposes the Fiber reconciler as a standalone API for building custom renderers. It implements the core reconciliation algorithm that all React renderers use.\n\n**Entry Points:**\n- `index.js` - Main reconciler API\n- `constants.js` - Fiber-related constants\n- `reflection.js` - Reconciler reflection utilities\n\nThis package is used internally by `react-dom`, `react-native-renderer`, `react-test-renderer`, and `react-art`. It provides a host config interface that renderers must implement to integrate with the reconciler.\n\n**Dependencies:**\n\n| Dependency | Type | Version |\n|------------|------|---------|\n| `scheduler` | Dependency | `^0.28.0` |\n| `react` | Peer Dependency | `^19.3.0` |\n\n**Sources:** [`packages/react-reconciler/package.json:1-34`]()\n\n### scheduler\n\nThe `scheduler` package provides cooperative scheduling primitives used by the reconciler to prioritize and time-slice work:\n\n**Entry Points:**\n- `index.js` - Main scheduler API\n- `index.native.js` - React Native-specific implementation\n- `unstable_mock.js` - Deterministic mock for testing\n- `unstable_post_task.js` - Browser Scheduler API integration\n\nThe scheduler manages priority queues and uses `MessageChannel` or other APIs to yield control back to the browser between units of work.\n\n**Sources:** [`packages/scheduler/package.json:1-27`]()\n\n---\n\n## Package Dependency Graph\n\n```mermaid\ngraph TB\n    subgraph "Public Packages"\n        React["react<br/>Core API + Hooks"]\n        ReactDOM["react-dom<br/>DOM Renderer"]\n        ReactArt["react-art<br/>Canvas/SVG Renderer"]\n        ReactNative["react-native-renderer<br/>Native Renderer"]\n        ReactTestRenderer["react-test-renderer<br/>Test Renderer"]\n    end\n    \n    subgraph "Internal Packages"\n        ReactReconciler["react-reconciler<br/>Fiber Reconciler"]\n        Scheduler["scheduler<br/>Cooperative Scheduler"]\n        Shared["shared<br/>Internal Utilities"]\n        ReactNoop["react-noop-renderer<br/>Test Infrastructure"]\n    end\n    \n    subgraph "Development Tools"\n        EslintPlugin["eslint-plugin-react-hooks<br/>Linting Rules"]\n        JestReact["jest-react<br/>Test Matchers"]\n        ReactIs["react-is<br/>Type Checking"]\n    end\n    \n    ReactDOM --> ReactReconciler\n    ReactArt --> ReactReconciler\n    ReactNative --> ReactReconciler\n    ReactTestRenderer --> ReactReconciler\n    ReactNoop --> ReactReconciler\n    \n    ReactReconciler --> Scheduler\n    ReactDOM --> Scheduler\n    ReactArt --> Scheduler\n    ReactNative --> Scheduler\n    ReactTestRenderer --> Scheduler\n    \n    ReactDOM -.peer.-> React\n    ReactArt -.peer.-> React\n    ReactNative -.peer.-> React\n    ReactTestRenderer -.peer.-> React\n    ReactReconciler -.peer.-> React\n    \n    EslintPlugin -.dev.-> React\n    JestReact -.peer.-> React\n    JestReact -.peer.-> ReactTestRenderer\n    \n    ReactDOM --> Shared\n    ReactReconciler --> Shared\n    Scheduler --> Shared\n```\n\n**Sources:** [`packages/react-dom/package.json:19-21`](), [`packages/react-reconciler/package.json:28-33`](), [`packages/react-test-renderer/package.json:21-26`]()\n\n---\n\n## Renderer Packages\n\n### react-native-renderer\n\nAn internal package (not published to npm) that implements the React renderer for React Native environments. It supports both the legacy and Fabric architectures.\n\n**Configuration:**\n\n| Property | Value |\n|----------|-------|\n| Version | `16.0.0` (internal) |\n| Private | `true` |\n| Dependencies | `scheduler: ^0.28.0` |\n| Peer Dependencies | `react: ^18.0.0` |\n\nThis package has platform-specific behavior controlled by global variables:\n- `nativeFabricUIManager` - Fabric UI manager interface\n- `RN$enableMicrotasksInReact` - Microtask scheduling flag\n\n**Sources:** [`packages/react-native-renderer/package.json:1-16`](), [`.eslintrc.js:462-467`]()\n\n### react-art\n\nThe `react-art` package provides a renderer for vector graphics using the ART library, supporting Canvas, SVG, and VML (for IE8) outputs.\n\n**Public Exports:**\n- `index.js` - Main ART renderer\n- `Circle.js` - Circle shape component\n- `Rectangle.js` - Rectangle shape component\n- `Wedge.js` - Wedge/arc shape component\n\n**Dependencies:**\n\n| Dependency | Type | Version |\n|------------|------|---------|\n| `art` | Dependency | `^0.10.1` |\n| `create-react-class` | Dependency | `^15.6.2` |\n| `scheduler` | Dependency | `^0.28.0` |\n| `react` | Peer Dependency | `^19.3.0` |\n\n**Sources:** [`packages/react-art/package.json:1-41`]()\n\n### react-test-renderer\n\nA specialized renderer for snapshot testing that renders React components to pure JavaScript objects without requiring a DOM.\n\n**Entry Points:**\n- `index.js` - Main test renderer\n- `shallow.js` - Shallow rendering utilities\n\n**Dependencies:**\n\n| Dependency | Type | Version |\n|------------|------|---------|\n| `react-is` | Dependency | `^19.3.0` |\n| `scheduler` | Dependency | `^0.28.0` |\n| `react` | Peer Dependency | `^19.3.0` |\n\n**Sources:** [`packages/react-test-renderer/package.json:1-35`]()\n\n### react-noop-renderer\n\nAn internal test package providing mock implementations for testing the Fiber reconciler, Fizz server renderer, and Flight protocol without a real host environment.\n\n**Entry Points:**\n- `index.js` - Client-side noop renderer\n- `persistent.js` - Persistent mode noop renderer\n- `server.js` - Noop server renderer\n- `flight-client.js` - Flight client implementation\n- `flight-server.js` - Flight server implementation\n- `flight-modules.js` - Flight module system\n\nThis package is marked as `private: true` and depends on internal packages:\n- `react-reconciler`\n- `react-client`\n- `react-server`\n\n**Sources:** [`packages/react-noop-renderer/package.json:1-32`]()\n\n---\n\n## Development Tooling Packages\n\n### eslint-plugin-react-hooks\n\nAn ESLint plugin that enforces the Rules of Hooks and provides linting for React Hooks usage patterns.\n\n**Key Features:**\n- Enforces hook call ordering and conditional usage restrictions\n- Validates exhaustive dependencies for effect hooks\n- TypeScript type definitions included (`index.d.ts`)\n\n**Build Process:**\nThe plugin includes a build step that compiles the React Compiler:\n```json\n"scripts": {\n  "build:compiler": "cd ../../compiler && yarn workspace babel-plugin-react-compiler build",\n  "test": "yarn build:compiler && jest"\n}\n```\n\n**Dependencies:**\n\n| Dependency | Purpose |\n|------------|---------|\n| `@babel/core` | AST parsing and traversal |\n| `@babel/parser` | JavaScript/TypeScript parsing |\n| `hermes-parser` | Alternative parser for Flow |\n| `zod` | Configuration schema validation |\n\n**Peer Dependencies:**\n- ESLint versions 3.x through 9.x\n\n**Sources:** [`packages/eslint-plugin-react-hooks/package.json:1-68`]()\n\n### react-is\n\nA utility package for checking React element types and determining what kind of element a value represents.\n\n**Package Configuration:**\n\n| Property | Value |\n|----------|-------|\n| Version | `19.3.0` |\n| Side Effects | `false` (tree-shakeable) |\n| Main Entry | `index.js` |\n\nThis package is used internally by `react-test-renderer` and other tools to identify element types without depending on the full React package.\n\n**Sources:** [`packages/react-is/package.json:1-26`]()\n\n### jest-react\n\nProvides Jest matchers and utilities specifically designed for testing React components.\n\n**Peer Dependencies:**\n\n| Dependency | Supported Versions |\n|------------|-------------------|\n| `jest` | 23.x - 29.x |\n| `react` | `^19.0.0` |\n| `react-test-renderer` | `^19.0.0` |\n\n**Sources:** [`packages/jest-react/package.json:1-32`]()\n\n---\n\n## Package Organization by Purpose\n\n```mermaid\ngraph LR\n    subgraph "User-Facing APIs"\n        React["react<br/>Component API, Hooks"]\n        ReactDOM["react-dom<br/>Browser Rendering"]\n    end\n    \n    subgraph "Renderer Implementations"\n        RN["react-native-renderer<br/>iOS/Android UI"]\n        Art["react-art<br/>Vector Graphics"]\n        Test["react-test-renderer<br/>Snapshot Testing"]\n    end\n    \n    subgraph "Core Infrastructure"\n        Reconciler["react-reconciler<br/>Diff Algorithm"]\n        Sched["scheduler<br/>Priority Scheduling"]\n    end\n    \n    subgraph "Developer Experience"\n        Eslint["eslint-plugin-react-hooks<br/>Code Quality"]\n        JestReact["jest-react<br/>Test Utilities"]\n        ReactIs["react-is<br/>Type Checking"]\n    end\n    \n    subgraph "Internal Testing"\n        Noop["react-noop-renderer<br/>Mock Environment"]\n    end\n    \n    React --> |"used by"| ReactDOM\n    React --> |"used by"| RN\n    React --> |"used by"| Art\n    React --> |"used by"| Test\n    \n    Reconciler --> |"powers"| ReactDOM\n    Reconciler --> |"powers"| RN\n    Reconciler --> |"powers"| Art\n    Reconciler --> |"powers"| Test\n    Reconciler --> |"tested by"| Noop\n    \n    Sched --> |"schedules"| Reconciler\n    \n    Eslint -.-> |"validates"| React\n    ReactIs --> |"supports"| Test\n    JestReact -.-> |"tests"| Test\n```\n\n**Sources:** [`package.json:1-164`](), [`packages/react/package.json`](), [`packages/react-reconciler/package.json`]()\n\n---\n\n## Build System Configuration\n\n### Shared Development Dependencies\n\nThe root [`package.json:6-120`]() declares all development dependencies used across packages:\n\n**Build Tools:**\n- `rollup: ^3.29.5` - Module bundler\n- `@rollup/plugin-babel: ^6.0.3` - Babel integration\n- `@rollup/plugin-commonjs: ^24.0.1` - CommonJS module support\n- `@rollup/plugin-typescript: ^12.1.2` - TypeScript support\n- `google-closure-compiler: ^20230206.0.0` - Advanced optimization\n\n**Transpilation:**\n- `@babel/core: ^7.11.1` - Babel compiler core\n- `flow-bin: ^0.279.0` - Flow type checker\n- `typescript: ^5.4.3` - TypeScript compiler\n\n**Testing:**\n- `jest: ^29.4.2` - Test framework\n- `jest-environment-jsdom: ^29.4.2` - DOM environment\n- `@types/eslint: ^9.6.1` - TypeScript definitions\n\n**Linting:**\n- `eslint: ^7.7.0` - Linter\n- `prettier: ^3.3.3` - Code formatter\n\n**Sources:** [`package.json:6-120`]()\n\n### Build Scripts\n\nThe root package defines several build scripts in [`package.json:124-157`]():\n\n| Script | Purpose |\n|--------|---------|\n| `build` | Build all packages for all release channels |\n| `build-for-devtools` | Build experimental packages for DevTools |\n| `build-for-flight-dev` | Build Server Components packages for development |\n| `lint` | Run ESLint on all packages |\n| `test` | Run Jest tests |\n| `test-stable` | Run tests against stable release channel |\n| `test-www` | Run tests for Facebook www environment |\n\n**Sources:** [`package.json:124-157`]()\n\n---\n\n## Flow Type Configuration\n\nThe repository uses Flow for type checking with multiple configurations for different renderer environments. The script [`scripts/flow/createFlowConfigs.js:1-153`]() generates environment-specific `.flowconfig` files.\n\n### Flow Configuration Generation\n\n```mermaid\ngraph TB\n    ConfigTemplate["config/flowconfig<br/>Template with placeholders"]\n    CreateScript["createFlowConfigs.js<br/>Configuration generator"]\n    InlinedConfigs["inlinedHostConfigs<br/>Renderer definitions"]\n    \n    DOMConfig["flow/dom/.flowconfig<br/>DOM renderer config"]\n    NativeConfig["flow/native/.flowconfig<br/>Native renderer config"]\n    ArtConfig["flow/art/.flowconfig<br/>ART renderer config"]\n    \n    ForkDiscovery["Fork Discovery<br/>Scans packages/*/forks/"]\n    ModuleMappings["Module Mappings<br/>Maps forked files to renderers"]\n    IgnorePaths["Ignore Paths<br/>Excludes other renderer paths"]\n    \n    ConfigTemplate --> CreateScript\n    InlinedConfigs --> CreateScript\n    ForkDiscovery --> CreateScript\n    \n    CreateScript --> ModuleMappings\n    CreateScript --> IgnorePaths\n    \n    ModuleMappings --> DOMConfig\n    IgnorePaths --> DOMConfig\n    \n    ModuleMappings --> NativeConfig\n    IgnorePaths --> NativeConfig\n    \n    ModuleMappings --> ArtConfig\n    IgnorePaths --> ArtConfig\n```\n\nThe configuration generation process:\n1. Reads the template from [`scripts/flow/config/flowconfig:1-45`]()\n2. Discovers all forked files in `packages/*/forks/` directories\n3. Maps forked implementations to specific renderers (e.g., `ReactFiberConfig.dom.js`)\n4. Generates ignore patterns for other renderers\' code paths\n5. Writes separate `.flowconfig` files for each renderer\n\n**Key Forked Files:**\n- `ReactFiberConfig` - Reconciler host config\n- `ReactServerStreamConfig` - Server streaming config\n- `ReactFizzConfig` - HTML streaming config\n- `ReactFlightServerConfig` - Server Components config\n- `ReactFlightClientConfig` - Server Components client config\n\n**Sources:** [`scripts/flow/createFlowConfigs.js:1-153`](), [`scripts/flow/config/flowconfig:1-45`]()\n\n---\n\n## ESLint Configuration by Environment\n\nThe repository uses different ESLint configurations for different output targets, defined in [`scripts/rollup/validate/`]():\n\n### ESLint Configuration Matrix\n\n| Configuration | Parser | ECMAVersion | Source Type | Purpose |\n|---------------|--------|-------------|-------------|---------|\n| `eslintrc.cjs.js` | `espree` | 2020 | `script` | CommonJS builds |\n| `eslintrc.cjs2015.js` | `espree` | 2015 | `script` | ES2015 CommonJS builds |\n| `eslintrc.esm.js` | `espree` | 2020 | `module` | ES Module builds |\n| `eslintrc.fb.js` | `espree` | 5 | `script` | Facebook internal builds |\n| `eslintrc.rn.js` | `espree` | 5 | `script` | React Native builds |\n\nEach configuration declares environment-specific globals. For example, [`scripts/rollup/validate/eslintrc.fb.js:8-70`]() includes:\n- ES6+ globals: `Map`, `Set`, `Symbol`, `Proxy`, `WeakRef`\n- Typed arrays: `Int8Array`, `Uint8Array`, etc.\n- Platform-specific: `__DEV__`, `trustedTypes`, `AsyncLocalStorage`\n\n**Sources:** [`scripts/rollup/validate/eslintrc.cjs.js:1-112`](), [`scripts/rollup/validate/eslintrc.fb.js:1-96`](), [`scripts/rollup/validate/eslintrc.rn.js:1-98`]()\n\n---\n\n## Package Manager Configuration\n\nThe repository uses Yarn 1.x as specified in [`package.json:163`]():\n\n```json\n"packageManager": "yarn@1.22.22"\n```\n\n### Yarn Resolutions\n\nThe repository overrides specific transitive dependencies via resolutions in [`package.json:159-162`]():\n\n```json\n"resolutions": {\n  "react-is": "npm:react-is",\n  "jsdom": "22.1.0"\n}\n```\n\nThis ensures consistent versions of `react-is` across all packages and pins `jsdom` to a specific version for test stability.\n\n**Sources:** [`package.json:159-164`]()\n\n---\n\n## Summary of Key Packages\n\n| Package | Type | Purpose | Exported |\n|---------|------|---------|----------|\n| `react` | Core | Public component API and hooks | Yes |\n| `react-dom` | Renderer | DOM rendering with SSR support | Yes |\n| `react-reconciler` | Infrastructure | Fiber reconciler for custom renderers | Yes |\n| `scheduler` | Infrastructure | Cooperative scheduling primitives | Yes |\n| `react-native-renderer` | Renderer | React Native platform renderer | No (internal) |\n| `react-art` | Renderer | Canvas/SVG vector graphics | Yes |\n| `react-test-renderer` | Testing | Snapshot testing without DOM | Yes |\n| `react-noop-renderer` | Testing | Mock renderer for internal tests | No (internal) |\n| `eslint-plugin-react-hooks` | Tooling | Hooks linting rules | Yes |\n| `react-is` | Utility | Element type checking | Yes |\n| `jest-react` | Testing | Jest matchers for React | Yes |\n| `shared` | Infrastructure | Internal shared utilities | No (internal) |\n\n**Sources:** All package.json files referenced throughout this document\n\n---\n\n# Page: Feature Flags System\n\n# Feature Flags System\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/shared/ReactFeatureFlags.js](packages/shared/ReactFeatureFlags.js)\n- [packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js](packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js)\n- [packages/shared/forks/ReactFeatureFlags.native-fb.js](packages/shared/forks/ReactFeatureFlags.native-fb.js)\n- [packages/shared/forks/ReactFeatureFlags.native-oss.js](packages/shared/forks/ReactFeatureFlags.native-oss.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.js](packages/shared/forks/ReactFeatureFlags.test-renderer.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js](packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.www.js](packages/shared/forks/ReactFeatureFlags.test-renderer.www.js)\n- [packages/shared/forks/ReactFeatureFlags.www-dynamic.js](packages/shared/forks/ReactFeatureFlags.www-dynamic.js)\n- [packages/shared/forks/ReactFeatureFlags.www.js](packages/shared/forks/ReactFeatureFlags.www.js)\n- [scripts/flow/xplat.js](scripts/flow/xplat.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThe Feature Flags System is React\'s comprehensive mechanism for controlling experimental features, platform-specific behavior, and gradual feature rollouts across different environments and release channels. It enables the same codebase to be compiled with different behaviors for Facebook\'s internal infrastructure (www), React Native Facebook internal (native-fb), React Native open source (native-oss), and test renderers, while also supporting A/B testing and runtime-controllable flags in production environments.\n\nThis document covers the flag definition structure, forking mechanism, dynamic flag integration, build-time macros, and flag lifecycle management. For information about how the build system processes these flags, see [Build System and Package Distribution](#3). For information about how flags affect reconciler behavior, see [React Reconciler](#4).\n\n## System Architecture\n\nThe feature flag system is structured as a base definition file with environment-specific forks that override default values. The system supports both static flags (determined at build time) and dynamic flags (controllable at runtime via gatekeepers or feature management systems).\n\n```mermaid\ngraph TB\n    subgraph "Base Definitions"\n        BaseFlags["ReactFeatureFlags.js<br/>Canonical flag definitions"]\n    end\n    \n    subgraph "Static Forks"\n        WWWFork["ReactFeatureFlags.www.js<br/>Facebook internal"]\n        NativeFBFork["ReactFeatureFlags.native-fb.js<br/>React Native FB"]\n        NativeOSSFork["ReactFeatureFlags.native-oss.js<br/>React Native OSS"]\n        TestRendererFork["ReactFeatureFlags.test-renderer.js<br/>Test renderer"]\n        TestRendererWWWFork["ReactFeatureFlags.test-renderer.www.js<br/>Test renderer www"]\n        TestRendererNativeFBFork["ReactFeatureFlags.test-renderer.native-fb.js<br/>Test renderer native-fb"]\n    end\n    \n    subgraph "Dynamic Forks"\n        WWWDynamic["ReactFeatureFlags.www-dynamic.js<br/>Gatekeeper integration"]\n        NativeFBDynamic["ReactFeatureFlags.native-fb-dynamic.js<br/>Native feature flags"]\n    end\n    \n    subgraph "Build-Time Macros"\n        ExperimentalMacro["__EXPERIMENTAL__<br/>Experimental channel"]\n        ProfileMacro["__PROFILE__<br/>Profiling builds"]\n        VariantMacro["__VARIANT__<br/>A/B testing"]\n    end\n    \n    subgraph "Runtime Integration"\n        Gatekeeper["Gatekeeper System<br/>Facebook infrastructure"]\n        ReactNativeFlags["ReactNativeInternalFeatureFlags<br/>Native module"]\n    end\n    \n    BaseFlags --> WWWFork\n    BaseFlags --> NativeFBFork\n    BaseFlags --> NativeOSSFork\n    BaseFlags --> TestRendererFork\n    BaseFlags --> TestRendererWWWFork\n    BaseFlags --> TestRendererNativeFBFork\n    \n    WWWFork --> WWWDynamic\n    NativeFBFork --> NativeFBDynamic\n    \n    WWWDynamic --> Gatekeeper\n    NativeFBDynamic --> ReactNativeFlags\n    \n    ExperimentalMacro --> WWWFork\n    ExperimentalMacro --> NativeFBFork\n    ExperimentalMacro --> BaseFlags\n    ProfileMacro --> WWWFork\n    ProfileMacro --> NativeFBFork\n    ProfileMacro --> BaseFlags\n    VariantMacro --> WWWDynamic\n    VariantMacro --> NativeFBDynamic\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:1-259](), [packages/shared/forks/ReactFeatureFlags.www.js:1-121](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:1-92](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:1-91]()\n\n## Base Feature Flag Definitions\n\nThe base feature flag definitions reside in `ReactFeatureFlags.js` and serve as the canonical source of all flags with their default values for open source builds. This file organizes flags into explicit lifecycle categories that document their intended purpose and stability.\n\n### Flag Organization Structure\n\n```mermaid\ngraph LR\n    BaseFlags["ReactFeatureFlags.js"]\n    \n    BaseFlags --> LandOrRemoveZero["Land or remove (zero effort)<br/>Lines 10-16"]\n    BaseFlags --> Killswitch["Killswitch<br/>Lines 18-26"]\n    BaseFlags --> LandOrRemoveModerate["Land or remove (moderate effort)<br/>Lines 28-36"]\n    BaseFlags --> SlatedForRemoval["Slated for removal (significant effort)<br/>Lines 38-62"]\n    BaseFlags --> OngoingExperiments["Ongoing experiments<br/>Lines 64-152"]\n    BaseFlags --> ReadyForMajor["Ready for next major<br/>Lines 154-196"]\n    BaseFlags --> ChoppingBlock["Chopping Block<br/>Lines 198-223"]\n    BaseFlags --> DebuggingDevTools["Debugging and DevTools<br/>Lines 225-259"]\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:10-259]()\n\n### Key Flag Categories\n\n| Category | Purpose | Example Flags | Lines |\n|----------|---------|---------------|-------|\n| **Killswitch** | Emergency disable switches for production issues | `enableHydrationLaneScheduling` | [25]() |\n| **Land or remove (moderate)** | Flags requiring migration effort | `disableSchedulerTimeoutInWorkLoop` | [35]() |\n| **Slated for removal** | Deprecated features awaiting migration | `enableSuspenseCallback`, `enableScopeAPI`, `enableCreateEventHandleAPI` | [52, 55, 58]() |\n| **Ongoing experiments** | Active feature development | `enableLegacyCache`, `enableTaint`, `enableViewTransition` | [77, 81, 85]() |\n| **Ready for next major** | Features planned for next major release | `disableLegacyContext`, `disableLegacyMode`, `renameElementSymbol` | [177, 195, 167]() |\n| **Debugging and DevTools** | Profiling and development tools | `enableProfilerTimer`, `enableComponentPerformanceTrack` | [229, 235]() |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:10-259]()\n\n### Common Flag Patterns\n\nThe base file defines several patterns of flags:\n\n**Boolean Feature Toggles:**\n```\nexport const enableHalt: boolean = true;\nexport const enableViewTransition: boolean = true;\nexport const enableGestureTransition = __EXPERIMENTAL__;\n```\n\n**Expiration Timeouts:**\n```\nexport const retryLaneExpirationMs = 5000;\nexport const syncLaneExpirationMs = 250;\nexport const transitionLaneExpirationMs = 5000;\n```\n\n**Limits and Thresholds:**\n```\nexport const ownerStackLimit = 1e4;\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:83-141, 167-172, 258]()\n\n## Fork Mechanism\n\nThe fork mechanism allows different builds to use different implementations of the feature flags module. During the build process, Rollup\'s module resolution is configured to substitute the appropriate fork based on the target bundle type.\n\n### Fork Resolution Process\n\n```mermaid\ngraph TB\n    BuildProcess["Rollup Build Process"]\n    \n    BuildProcess --> BundleType{"Bundle Type"}\n    \n    BundleType -->|"FB_WWW"| WWW["packages/shared/forks/<br/>ReactFeatureFlags.www.js"]\n    BundleType -->|"RN_FB"| NativeFB["packages/shared/forks/<br/>ReactFeatureFlags.native-fb.js"]\n    BundleType -->|"RN_OSS"| NativeOSS["packages/shared/forks/<br/>ReactFeatureFlags.native-oss.js"]\n    BundleType -->|"TEST_RENDERER"| TestRenderer["packages/shared/forks/<br/>ReactFeatureFlags.test-renderer.js"]\n    BundleType -->|"TEST_RENDERER_WWW"| TestRendererWWW["packages/shared/forks/<br/>ReactFeatureFlags.test-renderer.www.js"]\n    BundleType -->|"TEST_RENDERER_NATIVE_FB"| TestRendererNativeFB["packages/shared/forks/<br/>ReactFeatureFlags.test-renderer.native-fb.js"]\n    BundleType -->|"Default"| Base["packages/shared/<br/>ReactFeatureFlags.js"]\n    \n    WWW --> Import1["Import in reconciler/renderers"]\n    NativeFB --> Import1\n    NativeOSS --> Import1\n    TestRenderer --> Import1\n    TestRendererWWW --> Import1\n    TestRendererNativeFB --> Import1\n    Base --> Import1\n```\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:1-121](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:1-92](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:1-91]()\n\n### Fork Type Verification\n\nEach fork file includes Flow type verification at the end to ensure it exports the same interface as the base file:\n\n```\n((((null: any): ExportsType): FeatureFlagsType): ExportsType);\n```\n\nThis type assertion ensures that:\n1. The fork exports all flags defined in the base\n2. The fork doesn\'t export extra flags not in the base\n3. Type signatures match exactly\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:120](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:91](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:90]()\n\n### Platform-Specific Flag Values\n\nDifferent forks set different default values based on platform capabilities and requirements:\n\n| Flag | Base | www | native-fb | native-oss |\n|------|------|-----|-----------|------------|\n| `enableLegacyFBSupport` | false | true | false | false |\n| `disableLegacyMode` | true | true | false | false |\n| `enableMoveBefore` | false | false | true | true |\n| `enableSuspenseCallback` | false | true | true | false |\n| `enableScopeAPI` | false | true | false | false |\n| `enableViewTransition` | true | true | false | true |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:61, 195, 184, 52, 55, 85](), [packages/shared/forks/ReactFeatureFlags.www.js:55, 101, 53, 87, 85](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:51, 39, 46, 62, 60](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:37, 24, 31, 50, 47, 65]()\n\n## Dynamic Feature Flags\n\nDynamic feature flags enable runtime control of features in internal Meta builds through gatekeeper systems. These flags are re-exported from platform-specific feature flag modules and their values can change without redeploying code.\n\n### www Dynamic Flags\n\nThe `ReactFeatureFlags.www.js` fork imports dynamic flags from a runtime module:\n\n```mermaid\ngraph LR\n    WWWFork["ReactFeatureFlags.www.js"]\n    DynamicModule["ReactFeatureFlags.www-dynamic.js"]\n    GatekeeperSystem["Gatekeeper System<br/>Meta infrastructure"]\n    RuntimeValue["Runtime Flag Values"]\n    \n    DynamicModule -->|"require(\'ReactFeatureFlags\')"| GatekeeperSystem\n    GatekeeperSystem --> RuntimeValue\n    RuntimeValue --> WWWFork\n    WWWFork -->|"Destructure and re-export"| Exports["Exported Flags"]\n    \n    WWWFork -->|"Lines 17-39"| ExportedDynamic["alwaysThrottleRetries<br/>disableLegacyContextForFunctionComponents<br/>enableObjectFiber<br/>enableRetryLaneExpiration<br/>enableTransitionTracing<br/>enableViewTransition<br/>enableComponentPerformanceTrack<br/>..."]\n```\n\nThe www fork destructures and re-exports specific flags from the dynamic module:\n\n```\nexport const {\n  alwaysThrottleRetries,\n  disableLegacyContextForFunctionComponents,\n  disableSchedulerTimeoutInWorkLoop,\n  enableHiddenSubtreeInsertionEffectCleanup,\n  enableInfiniteRenderLoopDetection,\n  enableNoCloningMemoCache,\n  enableObjectFiber,\n  enableRetryLaneExpiration,\n  enableTransitionTracing,\n  ...\n} = dynamicFeatureFlags;\n```\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:15-39]()\n\n### Native Facebook Dynamic Flags\n\nThe native-fb fork imports dynamic flags from the `ReactNativeInternalFeatureFlags` native module:\n\n```\nimport * as dynamicFlagsUntyped from \'ReactNativeInternalFeatureFlags\';\nconst dynamicFlags: DynamicExportsType = (dynamicFlagsUntyped: any);\n\nexport const {\n  alwaysThrottleRetries,\n  enableHiddenSubtreeInsertionEffectCleanup,\n  enableObjectFiber,\n  enableEagerAlternateStateNodeCleanup,\n  passChildrenWhenCloningPersistedNodes,\n  renameElementSymbol,\n  enableFragmentRefs,\n  enableFragmentRefsScrollIntoView,\n  enableFragmentRefsInstanceHandles,\n} = dynamicFlags;\n```\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.native-fb.js:16-31](), [scripts/flow/xplat.js:10-12]()\n\n### __VARIANT__ Testing Pattern\n\nDynamic flag definition files use the `__VARIANT__` macro to enable A/B testing during development. The build system runs tests twice: once with `__VARIANT__ = true` and once with `__VARIANT__ = false`:\n\n```\nexport const alwaysThrottleRetries: boolean = __VARIANT__;\nexport const disableLegacyContextForFunctionComponents: boolean = __VARIANT__;\nexport const enableObjectFiber: boolean = __VARIANT__;\nexport const enableRetryLaneExpiration: boolean = __VARIANT__;\n```\n\nThis allows testing both code paths for flags that will be dynamically controlled in production.\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www-dynamic.js:13-42](), [packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js:10-30]()\n\n## Build-Time Macros\n\nBuild-time macros are special identifiers that are replaced with boolean values during the build process. These enable conditional compilation based on build configuration.\n\n### Macro Types and Usage\n\n```mermaid\ngraph TB\n    SourceCode["Source Code with Macros"]\n    \n    SourceCode --> Experimental["__EXPERIMENTAL__"]\n    SourceCode --> Profile["__PROFILE__"]\n    SourceCode --> Variant["__VARIANT__"]\n    \n    Experimental -->|"Experimental builds"| ExpTrue["true"]\n    Experimental -->|"Stable builds"| ExpFalse["false"]\n    \n    Profile -->|"Profiling builds"| ProfTrue["true"]\n    Profile -->|"Production builds"| ProfFalse["false"]\n    \n    Variant -->|"Test run 1"| VarTrue["true"]\n    Variant -->|"Test run 2"| VarFalse["false"]\n    \n    ExpTrue --> ClosureCompiler["Closure Compiler<br/>Dead code elimination"]\n    ExpFalse --> ClosureCompiler\n    ProfTrue --> ClosureCompiler\n    ProfFalse --> ClosureCompiler\n    VarTrue --> ClosureCompiler\n    VarFalse --> ClosureCompiler\n    \n    ClosureCompiler --> OptimizedBundle["Optimized Bundle<br/>Unused paths removed"]\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:77-126, 229-256](), [packages/shared/forks/ReactFeatureFlags.www.js:41-69]()\n\n### __EXPERIMENTAL__ Macro\n\nUsed to enable features only in experimental release channels:\n\n```\nexport const enableLegacyCache = __EXPERIMENTAL__;\nexport const enableAsyncIterableChildren = __EXPERIMENTAL__;\nexport const enableTaint = __EXPERIMENTAL__;\nexport const enableGestureTransition = __EXPERIMENTAL__;\n```\n\nIn the www fork, `__EXPERIMENTAL__` is also used for the new modern build variant:\n\n```\nexport const disableLegacyContext = __EXPERIMENTAL__;\nexport const disableTextareaChildren = __EXPERIMENTAL__;\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:77, 79, 81, 87](), [packages/shared/forks/ReactFeatureFlags.www.js:69, 91]()\n\n### __PROFILE__ Macro\n\nUsed to enable profiling and performance measurement features:\n\n```\nexport const enableProfilerTimer = __PROFILE__;\nexport const enableProfilerCommitHooks = __PROFILE__;\nexport const enableProfilerNestedUpdatePhase = __PROFILE__;\nexport const enableUpdaterTracking = __PROFILE__;\nexport const enableSchedulingProfiler: boolean = \n  !enableComponentPerformanceTrack && __PROFILE__;\n```\n\nThis enables React DevTools profiling capabilities without impacting production bundle size.\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:229, 248, 251, 256, 244-245](), [packages/shared/forks/ReactFeatureFlags.www.js:44-47, 66-67]()\n\n### __VARIANT__ Macro\n\nUsed in dynamic flag definition files to simulate gatekeepers during testing:\n\n```\nexport const alwaysThrottleRetries: boolean = __VARIANT__;\nexport const enableObjectFiber: boolean = __VARIANT__;\nexport const enableRetryLaneExpiration: boolean = __VARIANT__;\nexport const enableTransitionTracing: boolean = __VARIANT__;\n```\n\nThe test infrastructure runs tests multiple times with different `__VARIANT__` values to ensure both code paths work correctly.\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www-dynamic.js:16-24](), [packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js:20-29]()\n\n## Feature Flag Lifecycle\n\nFlags move through different lifecycle stages as features are developed, stabilized, and eventually removed. The base file explicitly documents these stages through code comments and organization.\n\n### Lifecycle Stage Flow\n\n```mermaid\nstateDiagram-v2\n    [*] --> OngoingExperiment: New feature flag\n    OngoingExperiment --> ReadyForMajor: Feature stabilized\n    OngoingExperiment --> SlatedForRemoval: Feature rejected\n    ReadyForMajor --> LandOrRemove: Released in major\n    SlatedForRemoval --> LandOrRemove: Migration complete\n    LandOrRemove --> [*]: Flag removed\n    \n    OngoingExperiment --> Killswitch: Production issue\n    Killswitch --> OngoingExperiment: Issue resolved\n    Killswitch --> SlatedForRemoval: Feature abandoned\n    \n    note right of OngoingExperiment: Lines 64-152<br/>Active development\n    note right of ReadyForMajor: Lines 154-196<br/>Next major release\n    note right of SlatedForRemoval: Lines 38-62<br/>Awaiting cleanup\n    note right of Killswitch: Lines 18-26<br/>Emergency disable\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:10-259]()\n\n### Stage Definitions\n\n**Ongoing Experiments (Lines 64-152):**\nFeatures under active development that may change or be reverted. Examples:\n- `enableYieldingBeforePassive`: Yield to browser event loop before passive effects\n- `enableThrottledScheduling`: Intentionally yield less to block high framerate animations\n- `enableViewTransition`: View transition API integration\n- `enableSuspenseyImages`: Enhanced image loading with Suspense\n\n**Ready for Next Major (Lines 154-196):**\nFeatures that are stable and will be enabled by default in the next major release:\n- `disableLegacyContext`: Remove legacy context API\n- `disableLegacyMode`: Remove legacy rendering mode\n- `renameElementSymbol`: Update internal element representation\n- `enableReactTestRendererWarning`: Warn about test renderer usage\n\n**Slated for Removal (Lines 38-62):**\nDeprecated features that didn\'t ship but can\'t be deleted until internal migrations complete:\n- `enableSuspenseCallback`: Legacy Suspense callback API\n- `enableScopeAPI`: Experimental Scope support\n- `enableCreateEventHandleAPI`: Experimental event handle API\n- `enableLegacyFBSupport`: Legacy Primer support on Facebook internal\n\n**Killswitch (Lines 18-26):**\nFlags that exist to quickly disable features if they cause production issues:\n- `enableHydrationLaneScheduling`: Can be disabled if hydration scheduling causes issues\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:64-152, 154-196, 38-62, 18-26]()\n\n## Integration with Build System\n\nThe feature flag system integrates deeply with the build pipeline through module forking and macro replacement. The build system selects the appropriate fork based on the bundle configuration.\n\n### Build-Time Flag Resolution\n\n```mermaid\ngraph TB\n    BundleConfig["scripts/rollup/bundles.js<br/>Bundle configuration"]\n    ForksConfig["scripts/rollup/forks.js<br/>Fork mappings"]\n    RollupPlugin["Rollup Plugin<br/>Module resolution"]\n    \n    BundleConfig --> BundleType["Bundle Type<br/>FB_WWW, RN_OSS, etc."]\n    ForksConfig --> ForkMapping["Fork Mapping<br/>shared/ReactFeatureFlags  shared/forks/ReactFeatureFlags.www"]\n    \n    BundleType --> RollupPlugin\n    ForkMapping --> RollupPlugin\n    \n    RollupPlugin --> ResolvedModule["Resolved Module<br/>packages/shared/forks/ReactFeatureFlags.www.js"]\n    \n    ResolvedModule --> BabelTransform["Babel Transform<br/>Macro replacement"]\n    \n    BabelTransform --> ExperimentalTrue["__EXPERIMENTAL__  true"]\n    BabelTransform --> ExperimentalFalse["__EXPERIMENTAL__  false"]\n    BabelTransform --> ProfileTrue["__PROFILE__  true"]\n    BabelTransform --> ProfileFalse["__PROFILE__  false"]\n    \n    ExperimentalTrue --> ClosureCompiler["Closure Compiler<br/>Dead code elimination"]\n    ExperimentalFalse --> ClosureCompiler\n    ProfileTrue --> ClosureCompiler\n    ProfileFalse --> ClosureCompiler\n    \n    ClosureCompiler --> FinalBundle["Final Bundle<br/>Optimized code"]\n```\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:1-121](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:1-92]()\n\n### Fork Selection Examples\n\nDifferent bundle types resolve to different forks:\n\n| Bundle Type | Fork Path | Purpose |\n|-------------|-----------|---------|\n| `FB_WWW` | `shared/forks/ReactFeatureFlags.www.js` | Facebook internal web |\n| `RN_FB` | `shared/forks/ReactFeatureFlags.native-fb.js` | React Native Facebook internal |\n| `RN_OSS` | `shared/forks/ReactFeatureFlags.native-oss.js` | React Native open source |\n| `NODE_DEV`, `NODE_PROD` | `shared/ReactFeatureFlags.js` | Node.js builds (base) |\n| `UMD_DEV`, `UMD_PROD` | `shared/ReactFeatureFlags.js` | Browser UMD builds (base) |\n\nFor test renderer builds, additional specialized forks are used:\n\n| Bundle Type | Fork Path |\n|-------------|-----------|\n| Test renderer (www) | `shared/forks/ReactFeatureFlags.test-renderer.www.js` |\n| Test renderer (native-fb) | `shared/forks/ReactFeatureFlags.test-renderer.native-fb.js` |\n| Test renderer (default) | `shared/forks/ReactFeatureFlags.test-renderer.js` |\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:1](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:1](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:1](), [packages/shared/forks/ReactFeatureFlags.test-renderer.www.js:1](), [packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js:1](), [packages/shared/forks/ReactFeatureFlags.test-renderer.js:1]()\n\n## Flag Consumption in Runtime Code\n\nRuntime code imports feature flags from `shared/ReactFeatureFlags` and the build system resolves this to the appropriate fork:\n\n```\nimport {\n  enableProfilerTimer,\n  enableSuspenseCallback,\n  enableTransitionTracing,\n  enableLegacyHidden,\n} from \'shared/ReactFeatureFlags\';\n```\n\nThe reconciler, renderers, and other systems check these flags to conditionally enable features:\n\n```javascript\nif (enableTransitionTracing) {\n  // Transition tracing logic\n}\n\nif (enableProfilerTimer) {\n  // Profiling timer logic\n}\n```\n\nAfter Babel macro replacement and Closure Compiler dead code elimination, only the active code path remains in the final bundle.\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:1-259]()\n\n## Special Flag Categories\n\n### Profiling Flags\n\nProfiling flags are controlled by the `__PROFILE__` macro and enable performance measurement features:\n\n| Flag | Purpose | Lines |\n|------|---------|-------|\n| `enableProfilerTimer` | Gather timing metrics for Profiler subtrees | [229]() |\n| `enableComponentPerformanceTrack` | Add performance.measure() marks for Chrome | [235]() |\n| `enableSchedulingProfiler` | User timing marks for experimental timeline | [244-245]() |\n| `enableProfilerCommitHooks` | Record commit phase durations | [248]() |\n| `enableProfilerNestedUpdatePhase` | Differentiate update vs cascading-update | [251]() |\n| `enableUpdaterTracking` | Track which Fibers schedule render work | [256]() |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:229, 235, 244-245, 248, 251, 256]()\n\n### Expiration and Timeout Flags\n\nThese flags control timing behaviors in the scheduler and reconciler:\n\n| Flag | Default Value | Purpose | Lines |\n|------|---------------|---------|-------|\n| `enableRetryLaneExpiration` | false | Enable expiration time for retry lanes | [137]() |\n| `retryLaneExpirationMs` | 5000 | Retry lane expiration timeout | [138]() |\n| `syncLaneExpirationMs` | 250 | Sync lane expiration timeout | [139]() |\n| `transitionLaneExpirationMs` | 5000 | Transition lane expiration timeout | [140]() |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:137-140]()\n\n### Legacy API Deprecation Flags\n\nFlags controlling the removal of legacy APIs:\n\n| Flag | Status | Purpose | Lines |\n|------|--------|---------|-------|\n| `disableLegacyContext` | Ready for major | Remove static contextTypes API | [177]() |\n| `disableLegacyContextForFunctionComponents` | Ready for major | Remove legacy context from function components only | [181]() |\n| `disableLegacyMode` | Ready for major | Remove legacy rendering mode | [195]() |\n| `enableLegacyHidden` | Slated for removal | Legacy hidden subtree API (FB-only) | [111]() |\n| `enableLegacyFBSupport` | Slated for removal | Legacy Primer support | [61]() |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:177, 181, 195, 111, 61]()\n\n## Flag Naming Conventions\n\nThe codebase follows consistent naming conventions for feature flags:\n\n**Enable/Disable Prefix:**\n- `enable*`: Positive feature flags (e.g., `enableViewTransition`, `enableTaint`)\n- `disable*`: Negative feature flags for deprecations (e.g., `disableLegacyContext`, `disableClientCache`)\n\n**Lifecycle Indicators:**\n- Flags in "Slated for removal" section typically start with `enable` but are set to `false`\n- Flags in "Ready for next major" that deprecate features use `disable` prefix\n- Killswitch flags are typically feature enables that can be toggled to `false` for emergency rollback\n\n**Timing/Configuration Suffixes:**\n- `*Ms`: Millisecond timeouts (e.g., `retryLaneExpirationMs`)\n- `*Limit`: Numeric limits (e.g., `ownerStackLimit`)\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:1-259]()\n\n## Summary Table: All Feature Flags\n\n| Flag Name | Base | www | native-fb | native-oss | test-renderer | Category |\n|-----------|------|-----|-----------|------------|---------------|----------|\n| `enableHydrationLaneScheduling` | true | true | true | true | true | Killswitch |\n| `disableSchedulerTimeoutInWorkLoop` | false | dynamic | false | false | false | Land/remove (moderate) |\n| `enableSuspenseCallback` | false | true | true | false | false | Slated for removal |\n| `enableScopeAPI` | false | true | false | false | false | Slated for removal |\n| `enableCreateEventHandleAPI` | false | true | false | false | false | Slated for removal |\n| `enableLegacyFBSupport` | false | true | false | false | false | Slated for removal |\n| `enableYieldingBeforePassive` | false | false | false | false | true | Ongoing |\n| `enableThrottledScheduling` | false | false | false | false | false | Ongoing |\n| `enableLegacyCache` | __EXPERIMENTAL__ | true | false | false | __EXPERIMENTAL__ | Ongoing |\n| `enableTaint` | __EXPERIMENTAL__ | false | true | true | true | Ongoing |\n| `enableHalt` | true | true | true | true | true | Ongoing |\n| `enableViewTransition` | true | dynamic | false | true | false | Ongoing |\n| `disableLegacyContext` | true | __EXPERIMENTAL__ | false | true | true | Ready for major |\n| `disableLegacyMode` | true | true | false | false | true | Ready for major |\n| `renameElementSymbol` | true | dynamic | dynamic | true | false | Ready for major |\n\n**Sources:** All ReactFeatureFlags files listed above\n\n---\n\n# Page: Build System and Package Distribution\n\n# Build System and Package Distribution\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React\'s build system architecture, which compiles source code into distributable packages for multiple environments and platforms. The system uses Rollup as its core bundler, applies environment-specific transformations, and generates dozens of bundle variants from a shared codebase.\n\nFor information about feature flags that control which code is included in each build, see [Feature Flags System](#2). For details on how the built artifacts integrate with CI/CD, see [CI/CD and Artifact Management](#3.3).\n\n---\n\n## Build Pipeline Overview\n\nReact\'s build system transforms source files through a multi-stage pipeline, generating bundles for different environments (Node.js, browsers, React Native, Facebook internal) with different optimizations (development, production, profiling).\n\n### Build Orchestration Flow\n\n```mermaid\ngraph TB\n    CLI["yarn build<br/>(package.json:126)"]\n    BuildScript["scripts/rollup/build-all-release-channels.js"]\n    BuildCore["scripts/rollup/build.js"]\n    \n    CLI --> BuildScript\n    BuildScript --> BuildCore\n    \n    subgraph "Bundle Configuration"\n        BundlesJS["bundles.js<br/>Bundle definitions"]\n        ForksJS["forks.js<br/>Module replacements"]\n        HostConfigs["inlinedHostConfigs.js<br/>Platform mappings"]\n    end\n    \n    BuildCore --> BundlesJS\n    BuildCore --> ForksJS\n    BuildCore --> HostConfigs\n    \n    subgraph "Plugin Pipeline"\n        FlowRemoval["Flow Type Removal<br/>or TypeScript"]\n        Babel["Babel Transform<br/>getBabelConfig()"]\n        Replace["Replace Plugin<br/>__DEV__, __EXPERIMENTAL__"]\n        Closure["Closure Compiler<br/>SIMPLE mode"]\n        Prettier["Prettier<br/>Code formatting"]\n    end\n    \n    BuildCore --> FlowRemoval\n    FlowRemoval --> Babel\n    Babel --> Replace\n    Replace --> Closure\n    Closure --> Prettier\n    \n    subgraph "Output Generation"\n        Wrappers["wrappers.js<br/>Add headers & guards"]\n        OutputPath["packaging.js<br/>Determine output paths"]\n        Files["Build artifacts<br/>build/node_modules/"]\n    end\n    \n    Prettier --> Wrappers\n    Wrappers --> OutputPath\n    OutputPath --> Files\n```\n\n**Sources:** [scripts/rollup/build.js:1-700](), [package.json:126](), [scripts/rollup/bundles.js:1-100](), [scripts/rollup/forks.js:1-485](), [scripts/rollup/packaging.js:1-292](), [scripts/rollup/wrappers.js:1-300]()\n\n---\n\n## Bundle Type System\n\nThe build system generates multiple bundle types from the same source code. Each bundle type represents a combination of environment, module format, and optimization level.\n\n### Bundle Type Definitions\n\n| Bundle Type | Module Format | Environment | Description |\n|------------|---------------|-------------|-------------|\n| `NODE_DEV` | CommonJS | Node.js | Development build with full error messages |\n| `NODE_PROD` | CommonJS | Node.js | Production build with minified errors |\n| `NODE_PROFILING` | CommonJS | Node.js | Production with profiling instrumentation |\n| `NODE_ES2015` | CommonJS | Node.js | ES2015+ syntax preserved |\n| `ESM_DEV` | ES Modules | Browser/Node | Development ES modules |\n| `ESM_PROD` | ES Modules | Browser/Node | Production ES modules |\n| `BUN_DEV` | CommonJS | Bun runtime | Development for Bun |\n| `BUN_PROD` | CommonJS | Bun runtime | Production for Bun |\n| `FB_WWW_DEV` | CommonJS | Facebook web | Facebook development build |\n| `FB_WWW_PROD` | CommonJS | Facebook web | Facebook production build |\n| `FB_WWW_PROFILING` | CommonJS | Facebook web | Facebook profiling build |\n| `RN_OSS_DEV` | CommonJS | React Native OSS | RN open source development |\n| `RN_OSS_PROD` | CommonJS | React Native OSS | RN open source production |\n| `RN_OSS_PROFILING` | CommonJS | React Native OSS | RN open source profiling |\n| `RN_FB_DEV` | CommonJS | React Native FB | RN internal development |\n| `RN_FB_PROD` | CommonJS | React Native FB | RN internal production |\n| `RN_FB_PROFILING` | CommonJS | React Native FB | RN internal profiling |\n| `BROWSER_SCRIPT` | IIFE | Browser | Standalone browser script |\n| `CJS_DTS` | CommonJS | TypeScript | Type definitions for CJS |\n| `ESM_DTS` | ES Modules | TypeScript | Type definitions for ESM |\n\n**Sources:** [scripts/rollup/bundles.js:10-54](), [scripts/rollup/build.js:50-71]()\n\n### Bundle Configuration Structure\n\n```mermaid\ngraph LR\n    Bundle["Bundle Object"]\n    \n    Bundle --> Entry["entry<br/>\'react\' or \'react-dom\'"]\n    Bundle --> BundleTypes["bundleTypes[]<br/>NODE_DEV, NODE_PROD, etc."]\n    Bundle --> ModuleType["moduleType<br/>ISOMORPHIC, RENDERER, etc."]\n    Bundle --> Global["global<br/>\'React\' or \'ReactDOM\'"]\n    Bundle --> Externals["externals[]<br/>Dependencies"]\n    Bundle --> MinifyFlag["minifyWithProdErrorCodes<br/>boolean"]\n    Bundle --> WrapFlag["wrapWithModuleBoundaries<br/>boolean"]\n    Bundle --> Condition["condition<br/>\'react-server\' or undefined"]\n    \n    ModuleType --> ISOMORPHIC["ISOMORPHIC<br/>Core React package"]\n    ModuleType --> RENDERER["RENDERER<br/>ReactDOM, ReactNative"]\n    ModuleType --> RECONCILER["RECONCILER<br/>react-reconciler"]\n    ModuleType --> RENDERER_UTILS["RENDERER_UTILS<br/>TestUtils, plugins"]\n```\n\n**Sources:** [scripts/rollup/bundles.js:56-68](), [scripts/rollup/bundles.js:69-885]()\n\n---\n\n## Module Forking Mechanism\n\nThe forking system allows different modules to be substituted based on the target environment. This enables shipping different implementations of the same interface to different platforms without runtime checks.\n\n### Fork Resolution Process\n\n```mermaid\ngraph TB\n    ImportStmt["Import Statement<br/>import X from \'shared/ReactFeatureFlags\'"]\n    \n    ForksConfig["forks.js<br/>Fork definitions"]\n    ImportStmt --> ForksConfig\n    \n    ForksConfig --> BundleCheck{"Check bundleType"}\n    \n    BundleCheck -->|"FB_WWW_*"| WWWFork["ReactFeatureFlags.www.js"]\n    BundleCheck -->|"RN_FB_*"| NativeFBFork["ReactFeatureFlags.native-fb.js"]\n    BundleCheck -->|"RN_OSS_*"| NativeOSSFork["ReactFeatureFlags.native-oss.js"]\n    BundleCheck -->|"Other"| Default["ReactFeatureFlags.js"]\n    \n    WWWFork --> Plugin["useForks plugin<br/>Replaces module path"]\n    NativeFBFork --> Plugin\n    NativeOSSFork --> Plugin\n    Default --> Plugin\n    \n    Plugin --> RollupBundle["Final bundle with<br/>correct module"]\n```\n\n### Key Forked Modules\n\n| Source Module | Purpose | Fork Variants |\n|--------------|---------|---------------|\n| `ReactFeatureFlags.js` | Feature flag definitions | `www.js`, `native-fb.js`, `native-oss.js`, `test-renderer.js` |\n| `ReactSharedInternals.js` | Shared state object | `ReactSharedInternalsClient.js`, `ReactSharedInternalsServer.js` |\n| `ReactFiberConfig.js` | Renderer host config | Platform-specific implementations (dom, native, etc.) |\n| `ReactFlightServerConfig.js` | Flight server config | `dom`, `webpack`, `turbopack`, `parcel`, etc. |\n| `ReactFlightClientConfig.js` | Flight client config | Platform-specific client implementations |\n| `EventListener.js` | Event attachment | `EventListener-www.js` for Facebook |\n\n**Sources:** [scripts/rollup/forks.js:52-482](), [scripts/rollup/build.js:398](), [scripts/rollup/modules.js:64-81]()\n\n### Fork Function Signature\n\nEach entry in `forks.js` is a function that receives context and returns the replacement path:\n\n```\n(bundleType, entry, dependencies, moduleType, bundle) => string | Error | null\n```\n\n- Returns `null` if no fork is needed\n- Returns a file path string to replace the module\n- Returns an Error object for modules that should error if imported\n\n**Sources:** [scripts/rollup/forks.js:52-89](), [scripts/rollup/modules.js:64-81]()\n\n---\n\n## Host Configuration System\n\nHost configs define platform-specific behavior for renderers. The `inlinedHostConfigs.js` file maps entry points to platform implementations.\n\n### Host Config Structure\n\n```mermaid\ngraph TB\n    Entry["Entry Point<br/>react-dom"]\n    \n    HostConfig["inlinedHostConfigs.js<br/>Configuration array"]\n    Entry --> HostConfig\n    \n    HostConfig --> ShortName["shortName<br/>\'dom-browser\', \'dom-node\', etc."]\n    HostConfig --> EntryPoints["entryPoints[]<br/>Associated entry points"]\n    HostConfig --> Paths["paths[]<br/>Included source paths"]\n    HostConfig --> Flags["Feature flags<br/>isServerSupported, isFlightSupported"]\n    \n    ShortName --> FiberConfig["ReactFiberConfig.{shortName}.js"]\n    ShortName --> FizzConfig["ReactFizzConfig.{shortName}.js"]\n    ShortName --> FlightServerConfig["ReactFlightServerConfig.{shortName}.js"]\n    ShortName --> FlightClientConfig["ReactFlightClientConfig.{shortName}.js"]\n    \n    FiberConfig --> FindFork["findNearestExistingForkFile()<br/>Segment matching"]\n    FizzConfig --> FindFork\n    FlightServerConfig --> FindFork\n    FlightClientConfig --> FindFork\n    \n    FindFork --> Segments["Try segments:<br/>\'dom-browser\'<br/>\'dom\'<br/>until match found"]\n```\n\n### Host Config Examples\n\n| Short Name | Entry Points | Server Support | Flight Support |\n|-----------|--------------|----------------|----------------|\n| `dom-browser` | `react-dom`, `react-dom/client` | Yes | Yes |\n| `dom-node` | `react-dom/server.node` | Yes | Yes |\n| `dom-edge` | `react-dom/server.edge` | Yes | Yes |\n| `dom-bun` | `react-dom/server.bun` | Yes | Yes |\n| `native-fb` | `react-native-renderer` | No | No |\n| `native-oss` | `react-native-renderer` | No | No |\n\n**Sources:** [scripts/shared/inlinedHostConfigs.js:9-500](), [scripts/rollup/forks.js:242-436]()\n\n### Segmented Fork Resolution\n\nThe `findNearestExistingForkFile` function implements a fallback mechanism:\n\n```mermaid\ngraph LR\n    Start["Host config:<br/>\'dom-browser\'"]\n    \n    Start --> Try1["Try: ReactFiberConfig.dom-browser.js"]\n    Try1 -->|exists| Use1["Use this file"]\n    Try1 -->|not found| Try2["Try: ReactFiberConfig.dom.js"]\n    Try2 -->|exists| Use2["Use this file"]\n    Try2 -->|not found| Error["Throw error:<br/>No fork found"]\n```\n\n**Sources:** [scripts/rollup/forks.js:29-43]()\n\n---\n\n## Plugin Pipeline\n\nThe build system applies a series of Rollup plugins to transform source code. The order is critical for correctness.\n\n### Plugin Execution Sequence\n\n```mermaid\ngraph TB\n    Source["Source Files<br/>.js, .ts files"]\n    \n    Source --> Dynamic["dynamicImports()<br/>Keep dynamic imports external"]\n    \n    Dynamic --> TypeCheck{"Has tsconfig?"}\n    TypeCheck -->|Yes| TS["typescript plugin<br/>Compile TypeScript"]\n    TypeCheck -->|No| Flow["flowRemoveTypes<br/>Strip Flow annotations"]\n    \n    TS --> CommonJS["commonjs plugin<br/>Handle CJS modules"]\n    Flow --> CommonJS\n    \n    CommonJS --> Forks["useForks()<br/>Module replacement"]\n    Forks --> Forbid["forbidFBJSImports()<br/>Prevent fbjs imports"]\n    Forbid --> Resolve["resolve plugin<br/>Node resolution"]\n    \n    Resolve --> Strip["stripBanner()<br/>Remove license headers"]\n    Strip --> BabelPlugin["babel()<br/>ES6+ transformation"]\n    \n    BabelPlugin --> StrictRemove["Remove \'use strict\'<br/>String replacement"]\n    StrictRemove --> ReplacePlugin["replace()<br/>__DEV__, __EXPERIMENTAL__"]\n    \n    ReplacePlugin --> External["externalRuntime()<br/>Fizz runtime transform"]\n    External --> TopLevel["Top-level definitions<br/>Wrappers"]\n    \n    TopLevel --> ClosureCheck{"Needs Closure?"}\n    ClosureCheck -->|Yes| ClosurePlugin["closure()<br/>SIMPLE compilation"]\n    ClosureCheck -->|No| Skip["Skip"]\n    \n    ClosurePlugin --> PrettierPlugin["prettier()<br/>Reformat code"]\n    Skip --> PrettierPlugin\n    \n    PrettierPlugin --> License["License header<br/>Wrappers"]\n    License --> Sizes["sizes()<br/>Record bundle size"]\n    \n    Sizes --> Output["Final Bundle"]\n```\n\n**Sources:** [scripts/rollup/build.js:354-546]()\n\n### Babel Configuration\n\nThe Babel plugin applies different transformations based on bundle type and development mode:\n\n```mermaid\ngraph LR\n    GetBabelConfig["getBabelConfig()"]\n    \n    GetBabelConfig --> Base["Base plugins:<br/>class-properties<br/>object-rest-spread<br/>template-literals<br/>transform-spread<br/>etc."]\n    \n    Base --> DevCheck{"isDevelopment?"}\n    DevCheck -->|Yes| ES5["Add ES5 plugins:<br/>arrow-functions<br/>block-scoping<br/>shorthand-properties<br/>etc."]\n    DevCheck -->|No| Skip["Skip ES5<br/>(Closure handles)"]\n    \n    ES5 --> ErrorCheck{"minifyWithProdErrorCodes?"}\n    Skip --> ErrorCheck\n    ErrorCheck -->|Yes & Prod| Errors["transform-error-messages<br/>Replace with codes"]\n    ErrorCheck -->|No| NoErrors["Keep full messages"]\n```\n\n**Sources:** [scripts/rollup/build.js:143-172](), [scripts/rollup/build.js:111-141]()\n\n---\n\n## Package Output Structure\n\nBuilt artifacts are organized into a specific directory structure for npm distribution and internal use.\n\n### Output Directory Layout\n\n```mermaid\ngraph TB\n    Build["build/"]\n    \n    Build --> NodeModules["node_modules/"]\n    Build --> Facebook["facebook-www/"]\n    Build --> ReactNative["react-native/"]\n    \n    NodeModules --> ReactPkg["react/"]\n    NodeModules --> ReactDOMPkg["react-dom/"]\n    NodeModules --> OtherPkgs["Other packages..."]\n    \n    ReactPkg --> ReactCJS["cjs/<br/>CommonJS builds"]\n    ReactPkg --> ReactFiles["index.js<br/>jsx-runtime.js<br/>compiler-runtime.js"]\n    \n    ReactDOMPkg --> DOMCJS["cjs/<br/>CommonJS builds"]\n    ReactDOMPkg --> DOMESM["esm/<br/>ESM builds (if any)"]\n    ReactDOMPkg --> DOMFiles["index.js<br/>client.js<br/>server.node.js<br/>server.browser.js"]\n    \n    Facebook --> Shims["shims/<br/>Facebook-specific"]\n    Facebook --> WWWFiles["React-www.js<br/>ReactDOM-www.js"]\n    \n    ReactNative --> Implementations["implementations/<br/>RN renderer files"]\n    ReactNative --> RNShims["shims/<br/>RN-specific"]\n```\n\n**Sources:** [scripts/rollup/packaging.js:48-114]()\n\n### Path Determination Logic\n\nThe `getBundleOutputPath` function maps bundle configuration to output paths:\n\n| Bundle Type | Package Name | Output Path Pattern |\n|------------|--------------|-------------------|\n| `NODE_DEV`, `NODE_PROD`, `NODE_PROFILING` | Any | `build/node_modules/{pkg}/cjs/{filename}` |\n| `ESM_DEV`, `ESM_PROD` | Any | `build/node_modules/{pkg}/esm/{filename}` |\n| `FB_WWW_*` | Any | `build/facebook-www/{filename}` |\n| `RN_OSS_*` | `react-native-renderer` | `build/react-native/implementations/{filename}` |\n| `RN_FB_*` | `react-native-renderer` | `build/react-native/implementations/{filename}.fb.js` |\n| `RN_FB_*` | Other | `build/facebook-react-native/{pkg}/cjs/{filename}` |\n| `BROWSER_SCRIPT` | Any | `build/node_modules/{pkg}/{bundle.outputPath}` |\n\n**Sources:** [scripts/rollup/packaging.js:48-115]()\n\n---\n\n## Npm Package Preparation\n\nAfter building, packages must be prepared for npm publication. This involves copying metadata files, filtering entry points, and creating tarballs.\n\n### Package Preparation Flow\n\n```mermaid\ngraph TB\n    PrepareNpm["prepareNpmPackages()"]\n    \n    PrepareNpm --> Scan["Scan build/node_modules/<br/>for packages"]\n    \n    Scan --> ForEach["For each package:"]\n    \n    ForEach --> Copy["Copy files:<br/>LICENSE<br/>package.json<br/>README.md<br/>npm/ contents"]\n    \n    Copy --> Filter["filterOutEntrypoints()<br/>Remove unbundled entry points"]\n    \n    Filter --> ReadPkg["Read package.json"]\n    ReadPkg --> CheckFiles["Check files[] array"]\n    \n    CheckFiles --> CheckBundle{"Entry point<br/>has bundle?"}\n    CheckBundle -->|Yes| Keep["Keep in files[]"]\n    CheckBundle -->|No| Remove["Remove from files[]<br/>Delete file<br/>Remove from exports{}"]\n    \n    Remove --> UpdatePkg["Write updated package.json"]\n    Keep --> UpdatePkg\n    \n    UpdatePkg --> Pack["npm pack<br/>Create .tgz"]\n    Pack --> Extract["Extract tarball<br/>Strip \'package/\' prefix"]\n    Extract --> Cleanup["Delete .tgz"]\n```\n\n**Sources:** [scripts/rollup/packaging.js:253-284](), [scripts/rollup/packaging.js:171-251]()\n\n### Entry Point Filtering\n\nThe `filterOutEntrypoints` function uses a map to determine which entry points should exist:\n\n```mermaid\ngraph LR\n    EntryMap["entryPointsToHasBundle<br/>Map<entry, boolean>"]\n    \n    EntryMap --> BuildMap["Built during bundle<br/>iteration"]\n    \n    BuildMap --> Check["For each file<br/>in package.json:"]\n    \n    Check --> EntryName["Convert filename<br/>to entry name"]\n    EntryName --> Lookup["Look up in map"]\n    \n    Lookup --> HasBundle{"Has bundle in<br/>this channel?"}\n    HasBundle -->|true| Keep["Keep file"]\n    HasBundle -->|false| RemoveFile["Remove from package"]\n    HasBundle -->|undefined| ExtraFile["Extra file<br/>(keep)"]\n    \n    RemoveFile --> UpdateExports["Update exports field"]\n    RemoveFile --> UpdateBrowser["Update browser field"]\n```\n\n**Sources:** [scripts/rollup/packaging.js:158-251]()\n\n---\n\n## Code Wrapping and Headers\n\nDifferent bundle types require different code wrappers, headers, and guards. The `wrappers.js` module handles this transformation.\n\n### Wrapper Application\n\n```mermaid\ngraph TB\n    Source["Rollup output"]\n    \n    Source --> TopLevel["wrapWithTopLevelDefinitions()<br/>Bundle-type specific wrapper"]\n    \n    TopLevel --> DevGuard{"Is development<br/>bundle?"}\n    \n    DevGuard -->|NODE_DEV| NodeDev["Wrap in:<br/>if (process.env.NODE_ENV !== \'production\')"]\n    DevGuard -->|FB_WWW_DEV| WWWDev["Wrap in:<br/>if (__DEV__)"]\n    DevGuard -->|RN_*_DEV| RNDev["Wrap in:<br/>if (__DEV__)"]\n    DevGuard -->|Production| NoProd["No guard needed"]\n    \n    NodeDev --> DevTools["wrapWithRegisterInternalModule()<br/>DevTools registration"]\n    WWWDev --> DevTools\n    RNDev --> DevTools\n    NoProd --> ProdCheck{"wrapWithModule<br/>Boundaries?"}\n    \n    DevTools --> ProdCheck\n    ProdCheck -->|Yes| ModuleBoundary["Add __REACT_DEVTOOLS_GLOBAL_HOOK__<br/>registration calls"]\n    ProdCheck -->|No| Skip["Skip"]\n    \n    ModuleBoundary --> License["wrapWithLicenseHeader()<br/>Add copyright header"]\n    Skip --> License\n    \n    License --> Final["Final bundle code"]\n```\n\n**Sources:** [scripts/rollup/wrappers.js:32-50](), [scripts/rollup/wrappers.js:58-169](), [scripts/rollup/build.js:446-520]()\n\n### License Header Format\n\nAll bundles include a standard MIT license header:\n\n```\n/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n```\n\n**Sources:** [scripts/rollup/wrappers.js:53-56]()\n\n---\n\n## Bundle Type-Specific Behaviors\n\nDifferent bundle types have unique compilation and optimization requirements.\n\n### Development vs Production Differences\n\n| Aspect | Development | Production |\n|--------|------------|------------|\n| `__DEV__` constant | `true` | `false` |\n| Error messages | Full text | Error codes (minified) |\n| Babel plugins | Full ES5 transform | Minimal (Closure handles) |\n| Closure Compiler | Not used | SIMPLE mode |\n| Guard wrappers | `if (process.env.NODE_ENV !== "production")` | None |\n| Source maps | Not generated | Not generated |\n\n**Sources:** [scripts/rollup/build.js:253-280](), [scripts/rollup/build.js:432-442](), [scripts/rollup/build.js:469-500]()\n\n### Profiling Bundles\n\nProfiling bundles are production builds with the `__PROFILE__` flag set to `true`. They include:\n\n- All production optimizations\n- Additional performance tracking code\n- Profiler hooks enabled\n\n**Sources:** [scripts/rollup/build.js:283-310](), [scripts/rollup/build.js:432-442]()\n\n### Facebook Internal Bundles\n\nFacebook bundles (`FB_WWW_*` and `RN_FB_*`) have special characteristics:\n\n- Use different feature flag forks (`ReactFeatureFlags.www.js`, `ReactFeatureFlags.native-fb.js`)\n- Support dynamic flags via `__VARIANT__` or external gatekeeper systems\n- May use Facebook-specific event listener wrappers\n- Output to separate directories (`facebook-www/`, `facebook-react-native/`)\n\n**Sources:** [scripts/rollup/bundles.js:19-21](), [scripts/rollup/forks.js:180-188](), [scripts/rollup/packaging.js:64-94]()\n\n---\n\n## Build Commands and Workflow\n\nThe monorepo provides several build commands for different use cases.\n\n### Primary Build Commands\n\n| Command | Description | Implementation |\n|---------|-------------|----------------|\n| `yarn build` | Build all release channels | [package.json:126]()  `build-all-release-channels.js` |\n| `yarn build --type=NODE` | Build only Node bundles | [scripts/rollup/build.js:94-98]() |\n| `yarn build react/index,react-dom/index` | Build specific entry points | [scripts/rollup/build.js:100-104]() |\n| `yarn build --watch` | Watch mode for development | [scripts/rollup/build.js:106]() |\n\n**Sources:** [package.json:124-157](), [scripts/rollup/build.js:94-106]()\n\n### Specialized Build Targets\n\n```mermaid\ngraph LR\n    BuildCommands["Build Commands"]\n    \n    BuildCommands --> DevTools["build-for-devtools<br/>Subset for DevTools testing"]\n    BuildCommands --> Flight["build-for-flight-dev<br/>Server Components dev"]\n    BuildCommands --> VT["build-for-vt-dev<br/>View Transitions dev"]\n    \n    DevTools --> Subset1["react, react-dom,<br/>react-is, scheduler,<br/>react-test-renderer"]\n    Flight --> Subset2["react, react-dom,<br/>react-server-dom-*"]\n    VT --> Subset3["react, react-dom,<br/>server bundles"]\n```\n\n**Sources:** [package.json:127-131]()\n\n---\n\n## Module Resolution and Dependencies\n\nThe build system needs to resolve modules and determine dependencies for bundling.\n\n### Dependency Resolution\n\n```mermaid\ngraph TB\n    Entry["Bundle entry point"]\n    \n    Entry --> GetDeps["getDependencies()<br/>modules.js"]\n    \n    GetDeps --> LoadPkg["Load package.json<br/>for entry point"]\n    \n    LoadPkg --> Extract["Extract:<br/>dependencies{}<br/>peerDependencies{}"]\n    \n    Extract --> Merge["Merge into<br/>single array"]\n    \n    Merge --> Externals["Mark as external<br/>in Rollup config"]\n    \n    Externals --> Bundle["Bundle generation<br/>(external deps excluded)"]\n```\n\n**Sources:** [scripts/rollup/modules.js:50-61](), [scripts/rollup/build.js:653-654]()\n\n### Global Variable Mapping\n\nFor bundles that expose globals (UMD-style), the system maps package names to global variables:\n\n| Package Name | Global Variable |\n|-------------|-----------------|\n| `react` | `React` |\n| `react-dom` | `ReactDOM` |\n| `react-dom/server` | `ReactDOMServer` |\n| `scheduler` | `Scheduler` |\n| `scheduler/unstable_mock` | `SchedulerMock` |\n\n**Sources:** [scripts/rollup/modules.js:31-38](), [scripts/rollup/build.js:650]()\n\n---\n\n## Build Validation\n\nAfter building, the system validates the output to catch build pipeline bugs.\n\n### Validation Process\n\n```mermaid\ngraph TB\n    Validate["yarn lint-build"]\n    \n    Validate --> Scan["Scan build/ directory<br/>for .js files"]\n    \n    Scan --> Categorize{"Determine<br/>bundle type"}\n    \n    Categorize --> CJS["CJS bundles<br/>eslintrc.cjs.js"]\n    Categorize --> CJS2015["CJS ES2015 bundles<br/>eslintrc.cjs2015.js"]\n    Categorize --> ESM["ESM bundles<br/>eslintrc.esm.js"]\n    Categorize --> FB["FB bundles<br/>eslintrc.fb.js"]\n    Categorize --> RN["RN bundles<br/>eslintrc.rn.js"]\n    \n    CJS --> ESLint["Run ESLint<br/>with config"]\n    CJS2015 --> ESLint\n    ESM --> ESLint\n    FB --> ESLint\n    RN --> ESLint\n    \n    ESLint --> Check["Check for:<br/>- Undefined globals<br/>- Invalid syntax<br/>- Closure artifacts"]\n    \n    Check --> Report["Report errors"]\n```\n\n**Sources:** [scripts/rollup/validate/index.js:1-100](), [package.json:135]()\n\n### Validation Rules\n\nEach bundle type has specific global variables and syntax requirements:\n\n- **CJS**: ES2020 features, Node.js globals (`process`, `Buffer`)\n- **CJS ES2015**: ES2015+ features, Node.js globals\n- **ESM**: ES2020 features, module syntax\n- **FB**: ES5 syntax, `__DEV__` global\n- **RN**: ES5 syntax, React Native globals (`nativeFabricUIManager`)\n\n**Sources:** [scripts/rollup/validate/eslintrc.cjs.js:1-111](), [scripts/rollup/validate/eslintrc.fb.js:1-100](), [scripts/rollup/validate/eslintrc.rn.js:1-96]()\n\n---\n\n## Environment-Specific Entry Points\n\nReact packages use conditional exports and entry point suffixes to select the correct implementation.\n\n### Entry Point Fork Resolution\n\n```mermaid\ngraph TB\n    Entry["Bundle entry:<br/>react-dom"]\n    \n    Entry --> Resolve["require.resolve()<br/>Get full path"]\n    \n    Resolve --> Fork["resolveEntryFork()"]\n    \n    Fork --> IsFB{"Is Facebook<br/>bundle?"}\n    \n    IsFB -->|Yes| TryModern["Try: .modern.fb.js<br/>(if experimental)"]\n    IsFB -->|No| TryChannel["Try: .experimental.js<br/>or .stable.js"]\n    \n    TryModern --> ExistsModern{"File exists?"}\n    ExistsModern -->|Yes| UseModern["Use modern FB fork"]\n    ExistsModern -->|No| TryClassic["Try: .classic.fb.js<br/>or .fb.js"]\n    \n    TryClassic --> UseClassic["Use if exists<br/>else try channel fork"]\n    \n    TryChannel --> UseChannel["Use channel fork<br/>or fallback to .js"]\n    \n    UseModern --> DevCheck{"Is development?"}\n    UseClassic --> DevCheck\n    UseChannel --> DevCheck\n    \n    DevCheck -->|Yes| TryDev["Try: .development.js"]\n    DevCheck -->|No| UseProd["Use production file"]\n    \n    TryDev --> FinalEntry["Resolved entry path"]\n    UseProd --> FinalEntry\n```\n\n**Sources:** [scripts/rollup/build.js:585-633]()\n\n### Conditional Exports in package.json\n\nReact packages use Node.js conditional exports to select implementations:\n\n```json\n{\n  "exports": {\n    ".": {\n      "react-server": "./react.react-server.js",\n      "default": "./index.js"\n    },\n    "./server": {\n      "react-server": "./server.react-server.js",\n      "workerd": "./server.edge.js",\n      "bun": "./server.bun.js",\n      "node": "./server.node.js",\n      "browser": "./server.browser.js",\n      "default": "./server.node.js"\n    }\n  }\n}\n```\n\n**Sources:** [packages/react-dom/package.json:51-125](), [packages/react/package.json:24-43]()\n\n---\n\n## Summary\n\nReact\'s build system is a sophisticated multi-stage pipeline that:\n\n1. **Reads configuration** from `bundles.js`, `forks.js`, and `inlinedHostConfigs.js`\n2. **Processes source files** through TypeScript/Flow removal, Babel, and Closure Compiler\n3. **Applies environment-specific forks** to swap modules based on target platform\n4. **Generates dozens of bundle variants** for different environments and optimization levels\n5. **Wraps code** with appropriate headers, guards, and DevTools registration\n6. **Organizes output** into platform-specific directory structures\n7. **Prepares npm packages** by filtering entry points and creating tarballs\n8. **Validates output** using ESLint to catch build pipeline errors\n\nThe system enables React to maintain a single codebase while shipping optimized, platform-specific implementations to Node.js, browsers, React Native, and Facebook\'s internal infrastructure.\n\n---\n\n# Page: Build Pipeline and Module Forking\n\n# Build Pipeline and Module Forking\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/react-reconciler/src/ReactFiberOffscreenComponent.js](packages/react-reconciler/src/ReactFiberOffscreenComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React\'s build system architecture, which transforms the monorepo\'s source code into distributable packages for different environments and platforms. The build pipeline uses Rollup to generate hundreds of bundle variants from shared source code, employing a sophisticated module forking mechanism to adapt behavior for specific deployment targets (Facebook internal, React Native, Node.js, browsers, etc.) without maintaining separate codebases.\n\nFor information about feature flags that control which features are enabled in each environment, see [Feature Flags System](#2). For details on release channels and versioning, see [Release Channels and Versioning](#3.2). For CI/CD and artifact preparation, see [CI/CD and Artifact Management](#3.3).\n\n---\n\n## Build System Architecture\n\nThe React build system is orchestrated by [scripts/rollup/build.js]() and centers around three core concepts:\n\n1. **Bundle Definitions** - Configurations specifying entry points, target environments, and module formats\n2. **Module Forking** - Environment-specific module replacement\n3. **Plugin Pipeline** - Sequential transformations applied to source code\n\n### Bundle Configuration System\n\nBundle definitions in [scripts/rollup/bundles.js:69-1244]() specify all possible build outputs. Each bundle configuration contains:\n\n| Property | Purpose |\n|----------|---------|\n| `bundleTypes` | Array of target bundle types (NODE_DEV, FB_WWW_PROD, etc.) |\n| `moduleType` | Classification (ISOMORPHIC, RENDERER, RECONCILER, RENDERER_UTILS) |\n| `entry` | Source entry point path |\n| `global` | Global variable name for UMD/IIFE bundles |\n| `externals` | External dependencies not to bundle |\n| `minifyWithProdErrorCodes` | Whether to replace error messages with codes in production |\n| `wrapWithModuleBoundaries` | Whether to wrap with module boundary markers |\n\n**Bundle Types by Environment**\n\n```mermaid\ngraph TB\n    subgraph "Module Formats"\n        CJS["CommonJS<br/>(NODE_DEV/PROD/PROFILING)"]\n        ESM["ES Modules<br/>(ESM_DEV/PROD)"]\n        IIFE["IIFE<br/>(BROWSER_SCRIPT)"]\n        ES2015["ES2015<br/>(NODE_ES2015)"]\n    end\n    \n    subgraph "Facebook Internal"\n        FBWWW["FB WWW<br/>(FB_WWW_DEV/PROD/PROFILING)"]\n        RNFB["RN Facebook<br/>(RN_FB_DEV/PROD/PROFILING)"]\n    end\n    \n    subgraph "Open Source"\n        BUN["Bun Runtime<br/>(BUN_DEV/PROD)"]\n        RNOSS["RN OSS<br/>(RN_OSS_DEV/PROD/PROFILING)"]\n    end\n    \n    subgraph "TypeScript"\n        CJSDTS["CJS Type Defs<br/>(CJS_DTS)"]\n        ESMDTS["ESM Type Defs<br/>(ESM_DTS)"]\n    end\n```\n\nSources: [scripts/rollup/bundles.js:10-54]()\n\n---\n\n## Module Forking Mechanism\n\nModule forking allows React to replace specific modules with environment-specific implementations at build time. The forking system is defined in [scripts/rollup/forks.js:52-482]().\n\n### Fork Resolution Process\n\n```mermaid\ngraph TB\n    ImportRequest["Import Request<br/>(\'./packages/shared/ReactFeatureFlags.js\')"]\n    \n    GetForks["getForks()<br/>[modules.js:64-81]"]\n    \n    LookupFork["Lookup in forks map<br/>[forks.js:52]"]\n    \n    EvalFunction["Evaluate fork function<br/>(bundleType, entry, deps, moduleType, bundle)"]\n    \n    Decision{Fork<br/>Applies?}\n    \n    ReturnFork["Return fork path<br/>e.g., ReactFeatureFlags.www.js"]\n    \n    ReturnNull["Return null<br/>(use original)"]\n    \n    ApplyFork["useForks plugin applies replacement<br/>[plugins/use-forks-plugin.js]"]\n    \n    ImportRequest --> GetForks\n    GetForks --> LookupFork\n    LookupFork --> EvalFunction\n    EvalFunction --> Decision\n    Decision -->|"Yes"| ReturnFork\n    Decision -->|"No"| ReturnNull\n    ReturnFork --> ApplyFork\n```\n\nSources: [scripts/rollup/forks.js:52-482](), [scripts/rollup/modules.js:64-81]()\n\n### Critical Forked Modules\n\n**ReactFeatureFlags.js**\n\nThe feature flags module has environment-specific forks:\n\n- `ReactFeatureFlags.www.js` - Facebook web builds\n- `ReactFeatureFlags.native-fb.js` - Facebook React Native builds\n- `ReactFeatureFlags.native-oss.js` - Open source React Native builds\n- `ReactFeatureFlags.test-renderer.js` - Test renderer builds\n\nFork logic: [scripts/rollup/forks.js:134-191]()\n\n**ReactFiberConfig.js (Host Configuration)**\n\nThis module provides the host environment abstraction for the reconciler. Different renderers have different implementations:\n\n```mermaid\ngraph LR\n    ReactFiberConfig["ReactFiberConfig.js<br/>(abstract interface)"]\n    \n    subgraph "Fork Resolution"\n        FindRenderer["Find renderer in<br/>inlinedHostConfigs"]\n        BuildPath["Build fork path<br/>ReactFiberConfig.{shortName}.js"]\n        TrySegments["Try segmented names<br/>dom-browser  dom"]\n    end\n    \n    subgraph "Implementations"\n        DOMBrowser["ReactFiberConfig.dom-browser.js<br/>(Browser DOM)"]\n        DOMNode["ReactFiberConfig.dom-node.js<br/>(Node.js SSR)"]\n        NativeFB["ReactFiberConfig.native-fb.js<br/>(RN Facebook)"]\n        NativeOSS["ReactFiberConfig.native-oss.js<br/>(RN OSS)"]\n        Test["ReactFiberConfig.test.js<br/>(Test renderer)"]\n    end\n    \n    ReactFiberConfig --> FindRenderer\n    FindRenderer --> BuildPath\n    BuildPath --> TrySegments\n    TrySegments --> DOMBrowser\n    TrySegments --> DOMNode\n    TrySegments --> NativeFB\n    TrySegments --> NativeOSS\n    TrySegments --> Test\n```\n\nFork logic: [scripts/rollup/forks.js:242-274]()\n\nThe `findNearestExistingForkFile` function [scripts/rollup/forks.js:29-43]() tries progressively shorter segment combinations:\n- `ReactFiberConfig.dom-browser.js`\n- `ReactFiberConfig.dom.js`\n- (fallback to error if none found)\n\n**ReactSharedInternals.js**\n\nForked to prevent circular dependencies when the `react` package imports shared internals:\n\n- Inside `react` package  uses `ReactSharedInternalsClient.js`\n- Inside `react-server` condition  uses `ReactSharedInternalsServer.js`\n- Other packages  uses default `ReactSharedInternals.js`\n\nFork logic: [scripts/rollup/forks.js:55-89]()\n\n**Server Configuration Modules**\n\nThree related config modules for server rendering:\n\n| Module | Purpose | Fork Examples |\n|--------|---------|---------------|\n| `ReactServerStreamConfig.js` | Stream handling | `ReactServerStreamConfig.dom-browser.js` |\n| `ReactFizzConfig.js` | HTML rendering (Fizz) | `ReactFizzConfig.dom-node.js` |\n| `ReactFlightServerConfig.js` | Server Components (Flight) | `ReactFlightServerConfig.dom-node-webpack.js` |\n\nFork logic: [scripts/rollup/forks.js:276-392]()\n\n---\n\n## Entry Point Forking\n\nBeyond module forking, the build system also forks entire entry points based on environment and release channel.\n\n### Entry Fork Resolution Algorithm\n\n```mermaid\ngraph TB\n    Start["resolveEntryFork()<br/>[build.js:585-633]"]\n    \n    IsFB{Is FB<br/>Bundle?}\n    \n    TryModernClassic["Try .modern.fb.js or .classic.fb.js<br/>(based on __EXPERIMENTAL__)"]\n    \n    TryGenericFB["Try .fb.js"]\n    \n    TryExperimentalStable["Try .experimental.js or .stable.js<br/>(based on __EXPERIMENTAL__)"]\n    \n    UsePlain["Use plain .js"]\n    \n    CheckDev{Is<br/>DEV?}\n    \n    TryDevVariant["Try .development.js variant<br/>at each step"]\n    \n    Return["Return resolved path"]\n    \n    Start --> IsFB\n    IsFB -->|Yes| TryModernClassic\n    TryModernClassic --> CheckDev\n    CheckDev -->|Yes| TryDevVariant\n    CheckDev -->|No| TryGenericFB\n    TryDevVariant --> TryGenericFB\n    TryGenericFB --> TryExperimentalStable\n    IsFB -->|No| TryExperimentalStable\n    TryExperimentalStable --> UsePlain\n    UsePlain --> Return\n```\n\nSources: [scripts/rollup/build.js:585-633]()\n\n**Example Entry Point Variants**\n\nFor `packages/react-dom/src/ReactDOMFB.js`:\n- `ReactDOMFB.modern.fb.js` - Facebook experimental builds\n- `ReactDOMFB.classic.fb.js` - Facebook stable builds  \n- `ReactDOMFB.js` - Base implementation\n\nFor `packages/react/index.js`:\n- `index.experimental.js` - OSS experimental builds\n- `index.stable.js` - OSS stable builds\n- `index.js` - Base implementation\n\n---\n\n## Plugin Pipeline\n\nThe Rollup plugin pipeline transforms source code through multiple stages. The pipeline is constructed in [scripts/rollup/build.js:354-546]().\n\n### Pipeline Stages\n\n```mermaid\ngraph TB\n    Source["Source Code<br/>(Flow/TypeScript)"]\n    \n    DynamicImports["dynamicImports()<br/>Externalize dynamic imports"]\n    \n    TypeRemoval["typescript() or flowRemoveTypes<br/>Strip type annotations"]\n    \n    CommonJS["commonjs()<br/>(TypeScript only)"]\n    \n    Forks["useForks()<br/>Apply module replacements"]\n    \n    ForbidFBJS["forbidFBJSImports()<br/>Block fbjs imports"]\n    \n    Resolve["resolve()<br/>Node module resolution"]\n    \n    StripBanner["stripBanner()<br/>Remove individual license headers"]\n    \n    Babel["babel()<br/>Transpile to ES2015 (+ ES5 in DEV)"]\n    \n    RemoveStrict["Remove \'use strict\'<br/>from individual modules"]\n    \n    Replace["replace()<br/>__DEV__, __PROFILE__, __EXPERIMENTAL__"]\n    \n    ExternalRuntime["externalRuntime()<br/>(for server-external-runtime)"]\n    \n    TopLevel["wrapWithTopLevelDefinitions()<br/>Module boundaries"]\n    \n    Closure["closure()<br/>Minification (SIMPLE mode)"]\n    \n    Prettier["prettier()<br/>Format output"]\n    \n    License["wrapWithLicenseHeader()<br/>Add license"]\n    \n    Sizes["sizes()<br/>Record bundle size"]\n    \n    Output["Output Bundle"]\n    \n    Source --> DynamicImports\n    DynamicImports --> TypeRemoval\n    TypeRemoval --> CommonJS\n    CommonJS --> Forks\n    Forks --> ForbidFBJS\n    ForbidFBJS --> Resolve\n    Resolve --> StripBanner\n    StripBanner --> Babel\n    Babel --> RemoveStrict\n    RemoveStrict --> Replace\n    Replace --> ExternalRuntime\n    ExternalRuntime --> TopLevel\n    TopLevel --> Closure\n    Closure --> Prettier\n    Prettier --> License\n    License --> Sizes\n    Sizes --> Output\n```\n\nSources: [scripts/rollup/build.js:380-539]()\n\n### Key Plugin Details\n\n**Babel Configuration** [scripts/rollup/build.js:143-172]()\n\nBase plugins (all builds):\n- `@babel/plugin-proposal-class-properties` (loose)\n- `@babel/plugin-proposal-object-rest-spread` (loose)\n- `@babel/plugin-transform-template-literals` (loose)\n- `@babel/plugin-transform-for-of`\n- `@babel/plugin-transform-spread` (loose)\n- `@babel/plugin-transform-parameters`\n- `@babel/plugin-transform-destructuring` (loose)\n- Custom `transform-object-assign`\n\nAdditional ES5 plugins (DEV builds only):\n- `@babel/plugin-transform-literals`\n- `@babel/plugin-transform-arrow-functions`\n- `@babel/plugin-transform-block-scoped-functions`\n- `@babel/plugin-transform-shorthand-properties`\n- `@babel/plugin-transform-computed-properties`\n- `@babel/plugin-transform-block-scoping`\n\n**Closure Compiler Configuration** [scripts/rollup/build.js:470-500]()\n\nSettings:\n- `compilation_level: \'SIMPLE\'` - Basic minification without aggressive optimizations\n- `language_in: \'ECMASCRIPT_2020\'`\n- `language_out: \'ECMASCRIPT5_STRICT\'` (except NODE_ES2015  ES2020, BROWSER_SCRIPT  ES5)\n- `renaming: false` - Preserve symbol names (let gzip handle compression)\n- `assume_function_wrapper: true` - Prevent global variable pollution\n\n**Constant Replacement** [scripts/rollup/build.js:432-442]()\n\nThe `replace()` plugin substitutes build-time constants:\n\n```javascript\n__DEV__  \'true\' (development) or \'false\' (production)\n__PROFILE__  \'true\' (profiling/dev) or \'false\' (production)\nprocess.env.NODE_ENV  "\'development\'" or "\'production\'"\n__EXPERIMENTAL__  true/false (based on RELEASE_CHANNEL)\n```\n\n---\n\n## Host Configuration System\n\nThe host configuration system allows React to target different platforms (DOM, React Native, custom renderers) through a common abstraction layer.\n\n### Host Config Registry\n\nHost configurations are registered in [scripts/shared/inlinedHostConfigs.js:9-357](). Each configuration specifies:\n\n| Property | Description |\n|----------|-------------|\n| `shortName` | Identifier for fork resolution (e.g., "dom-browser", "native-fb") |\n| `entryPoints` | Array of entry points that use this config |\n| `paths` | File paths that should use this config |\n| `isServerSupported` | Whether server rendering is supported |\n| `isFlightSupported` | Whether Server Components are supported |\n\n**Major Host Configurations**\n\n```mermaid\ngraph TB\n    subgraph "Browser Environments"\n        DOMBrowser["dom-browser<br/>ReactDOM in browsers<br/>entryPoints: react-dom, react-dom/client"]\n        DOMEdge["dom-edge<br/>Edge runtime<br/>entryPoints: react-dom-server.edge.js"]\n        DOMBun["dom-bun<br/>Bun runtime<br/>entryPoints: react-dom-server.bun.js"]\n    end\n    \n    subgraph "Server Environments"\n        DOMNode["dom-node<br/>Node.js SSR<br/>entryPoints: react-dom-server.node.js"]\n        DOMNodeWebpack["dom-node-webpack<br/>Webpack bundler<br/>entryPoints: react-server-dom-webpack"]\n        DOMNodeTurbopack["dom-node-turbopack<br/>Turbopack bundler<br/>entryPoints: react-server-dom-turbopack"]\n    end\n    \n    subgraph "React Native"\n        NativeFB["native-fb<br/>RN Facebook<br/>entryPoints: react-native-renderer"]\n        NativeOSS["native-oss<br/>RN OSS<br/>entryPoints: react-native-renderer"]\n    end\n    \n    subgraph "Other"\n        ART["art<br/>React ART<br/>entryPoints: react-art"]\n        Test["test<br/>Test renderer<br/>entryPoints: react-test-renderer"]\n        Custom["custom<br/>Custom renderers<br/>entryPoints: react-reconciler"]\n    end\n```\n\nSources: [scripts/shared/inlinedHostConfigs.js:9-357]()\n\n### Fork Path Resolution\n\nThe `findNearestExistingForkFile` function [scripts/rollup/forks.js:29-43]() resolves forks by trying progressively shorter path segments:\n\n```javascript\n// For shortName "dom-node-webpack" and base path \n// "ReactFiberConfig.", tries:\n// 1. ReactFiberConfig.dom-node-webpack.js\n// 2. ReactFiberConfig.dom-node.js  \n// 3. ReactFiberConfig.dom.js\n// Returns first that exists\n```\n\nThis allows sharing implementations across related configs (e.g., `dom-browser` and `dom-node` can share `dom` forks).\n\n---\n\n## Bundle Output Paths\n\nBundle outputs are organized by environment and package. Output path generation is in [scripts/rollup/packaging.js:48-115]().\n\n### Output Directory Structure\n\n```mermaid\ngraph TB\n    BuildRoot["build/"]\n    \n    NodeModules["node_modules/<br/>(OSS packages)"]\n    FBWWW["facebook-www/<br/>(FB internal)"]\n    ReactNative["react-native/<br/>(RN builds)"]\n    FBRN["facebook-react-native/<br/>(FB RN)"]\n    \n    subgraph "Package Structure"\n        PackageDir["&lt;package-name&gt;/"]\n        CJS["cjs/<br/>(CommonJS)"]\n        ESM["esm/<br/>(ES Modules)"]\n        Files["*.js (entry points)"]\n        Package["package.json"]\n    end\n    \n    BuildRoot --> NodeModules\n    BuildRoot --> FBWWW\n    BuildRoot --> ReactNative\n    BuildRoot --> FBRN\n    \n    NodeModules --> PackageDir\n    PackageDir --> CJS\n    PackageDir --> ESM\n    PackageDir --> Files\n    PackageDir --> Package\n```\n\nSources: [scripts/rollup/packaging.js:48-115]()\n\n**Path Generation by Bundle Type**\n\n| Bundle Type | Output Path Pattern |\n|-------------|-------------------|\n| NODE_DEV/PROD/PROFILING | `build/node_modules/<package>/cjs/<filename>` |\n| ESM_DEV/PROD | `build/node_modules/<package>/esm/<filename>` |\n| BUN_DEV/PROD | `build/node_modules/<package>/cjs/<filename>` |\n| FB_WWW_* | `build/facebook-www/<filename>` |\n| RN_OSS_* | `build/react-native/implementations/<filename>` |\n| RN_FB_* (react-native-renderer) | `build/react-native/implementations/<filename>.fb.js` |\n| RN_FB_* (other packages) | `build/facebook-react-native/<package>/cjs/<filename>` |\n| BROWSER_SCRIPT | `build/node_modules/<package>/<outputPath>` |\n\nCode: [scripts/rollup/packaging.js:48-115]()\n\n---\n\n## Code Wrappers\n\nDifferent bundle types require different code wrappers for module boundaries and conditional loading. Wrapper logic is in [scripts/rollup/wrappers.js]().\n\n### Top-Level Definition Wrappers\n\n**NODE_DEV Wrapper** [scripts/rollup/wrappers.js:86-95]()\n\n```javascript\n\'use strict\';\n\nif (process.env.NODE_ENV !== "production") {\n  (function() {\n    // ... bundle code ...\n  })();\n}\n```\n\n**FB_WWW_DEV Wrapper** [scripts/rollup/wrappers.js:107-116]()\n\n```javascript\n\'use strict\';\n\nif (__DEV__) {\n  (function() {\n    // ... bundle code ...\n  })();\n}\n```\n\n**RN_OSS_DEV Wrapper** [scripts/rollup/wrappers.js:128-137]()\n\n```javascript\n\'use strict\';\n\nif (__DEV__) {\n  (function() {\n    // ... bundle code ...\n  })();\n}\n```\n\nSources: [scripts/rollup/wrappers.js:58-169]()\n\n### Reconciler Wrappers\n\nThe reconciler (react-reconciler package) uses a special factory function wrapper that accepts a host config:\n\n**NODE_DEV Reconciler** [scripts/rollup/wrappers.js:172-186]()\n\n```javascript\n\'use strict\';\n\nif (process.env.NODE_ENV !== "production") {\n  module.exports = function $$$reconciler($$$config) {\n    var exports = {};\n    // ... bundle code ...\n    return exports;\n  };\n  module.exports.default = module.exports;\n  Object.defineProperty(module.exports, "__esModule", { value: true });\n}\n```\n\nThis allows custom renderers to provide their own host config at runtime.\n\nSources: [scripts/rollup/wrappers.js:171-263]()\n\n### License Headers\n\nLicense headers vary by bundle type. Example for OSS builds [scripts/rollup/wrappers.js:326-336]():\n\n```javascript\n/**\n * @license React\n * <filename>\n *\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n```\n\nFacebook builds include Flow/lint directives [scripts/rollup/wrappers.js:362-374]():\n\n```javascript\n/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n * ...\n * @noflow\n * @nolint\n * @preventMunge\n * @preserve-invariant-messages\n */\n```\n\nSources: [scripts/rollup/wrappers.js:265-492]()\n\n---\n\n## Build Orchestration\n\nThe main build script [scripts/rollup/build.js]() orchestrates the entire build process.\n\n### Build Execution Flow\n\n```mermaid\ngraph TB\n    Start["buildEverything()<br/>[build.js:828]"]\n    \n    Clean["asyncRimRaf(\'build/\')<br/>Clean output directory"]\n    \n    EnumerateBundles["Enumerate all bundles<br/>[bundles.js:69-1244]"]\n    \n    FilterBundles["Filter by CLI args<br/>(--type, names)"]\n    \n    CISplit["Split across CI nodes<br/>(CI_TOTAL, CI_INDEX)"]\n    \n    ForEachBundle["For each bundle"]\n    \n    Prebuild{Has<br/>prebuild?}\n    \n    RunPrebuild["runShellCommand(bundle.prebuild)"]\n    \n    CreateBundle["createBundle(bundle, bundleType)<br/>[build.js:635-751]"]\n    \n    ResolveEntry["resolveEntryFork()<br/>Pick entry point variant"]\n    \n    GetForks["getForks()<br/>Get module replacements"]\n    \n    ConfigureRollup["Configure Rollup<br/>(input, plugins, externals)"]\n    \n    RunRollup["rollup.rollup(config)"]\n    \n    WriteOutput["result.write(outputPath)"]\n    \n    CopyShims["copyAllShims()<br/>Copy www & RN shims"]\n    \n    PrepareNPM["prepareNpmPackages()<br/>npm pack & extract"]\n    \n    Sync{Sync to<br/>FB repos?}\n    \n    SyncFB["Sync to fbsource/www"]\n    \n    PrintStats["Print build statistics"]\n    \n    Start --> Clean\n    Clean --> EnumerateBundles\n    EnumerateBundles --> FilterBundles\n    FilterBundles --> CISplit\n    CISplit --> ForEachBundle\n    ForEachBundle --> Prebuild\n    Prebuild -->|Yes| RunPrebuild\n    Prebuild -->|No| CreateBundle\n    RunPrebuild --> CreateBundle\n    CreateBundle --> ResolveEntry\n    ResolveEntry --> GetForks\n    GetForks --> ConfigureRollup\n    ConfigureRollup --> RunRollup\n    RunRollup --> WriteOutput\n    WriteOutput --> ForEachBundle\n    ForEachBundle -->|More| ForEachBundle\n    ForEachBundle -->|Done| CopyShims\n    CopyShims --> PrepareNPM\n    PrepareNPM --> Sync\n    Sync -->|Yes| SyncFB\n    Sync -->|No| PrintStats\n    SyncFB --> PrintStats\n```\n\nSources: [scripts/rollup/build.js:828-896]()\n\n### Bundle Filtering\n\nThe build supports filtering via command-line arguments:\n\n**By Bundle Type** (`--type` flag)\n\n```bash\n# Build only Facebook www bundles\nyarn build --type=fb_www\n\n# Build multiple types\nyarn build --type=node_dev,node_prod\n```\n\nCode: [scripts/rollup/build.js:94-98]()\n\n**By Bundle Name** (positional arguments)\n\n```bash\n# Build only react-dom\nyarn build react-dom\n\n# Build multiple packages\nyarn build react react-dom\n```\n\nCode: [scripts/rollup/build.js:100-104](), [scripts/rollup/build.js:548-583]()\n\n**Skip Logic** [scripts/rollup/build.js:548-583]()\n\nA bundle is skipped if:\n1. Its `bundleTypes` array doesn\'t include the target bundle type\n2. User specified `--type` flags and none match\n3. User specified names and the bundle\'s entry doesn\'t match\n\n### Package Preparation\n\nAfter building, packages are prepared for npm publishing [scripts/rollup/packaging.js:253-284]():\n\n1. Copy metadata files (LICENSE, package.json, README.md)\n2. Copy npm/ directory contents (wrapper files)\n3. Filter out non-built entry points from package.json\n4. Run `npm pack` to create tarball\n5. Extract tarball to final location\n6. Delete tarball\n\nThe filtering step [scripts/rollup/packaging.js:171-251]() removes entry points that weren\'t built in the current release channel from `package.json` files field and exports map.\n\nSources: [scripts/rollup/packaging.js:253-284](), [scripts/rollup/packaging.js:171-251]()\n\n---\n\n## External Dependencies\n\nThe build system tracks external dependencies and their import side effects.\n\n### Import Side Effects Registry\n\n[scripts/rollup/modules.js:10-28]() declares whether externals have side effects during import:\n\n```javascript\nconst importSideEffects = Object.freeze({\n  fs: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  \'fs/promises\': HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  path: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  stream: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  \'prop-types/checkPropTypes\': HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  scheduler: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  react: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  \'react-dom\': HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  // ...\n});\n```\n\nThis allows tree-shaking unused DEV-only imports in production builds. The `pureExternalModules` list is passed to Rollup\'s treeshake configuration [scripts/rollup/build.js:656-666]().\n\n### Known Globals\n\nFor UMD/IIFE bundles, external dependencies are mapped to global variables [scripts/rollup/modules.js:31-38]():\n\n```javascript\nconst knownGlobals = Object.freeze({\n  react: \'React\',\n  \'react-dom\': \'ReactDOM\',\n  \'react-dom/server\': \'ReactDOMServer\',\n  scheduler: \'Scheduler\',\n  \'scheduler/unstable_mock\': \'SchedulerMock\',\n  ReactNativeInternalFeatureFlags: \'ReactNativeInternalFeatureFlags\',\n});\n```\n\nSources: [scripts/rollup/modules.js:10-38](), [scripts/rollup/build.js:656-666]()\n\n---\n\n## Special Cases and Edge Cases\n\n### Facebook-Specific Entry Point Aliasing\n\nIn Facebook builds, multiple public entry points may alias to a single internal entry point. For example, `react-dom` and `react-dom/client` both resolve to `ReactDOMFB.js` [scripts/jest/setupHostConfigs.js:18-56]().\n\n### DevTools Integration\n\nCertain bundles wrap code with DevTools hooks for profiling [scripts/rollup/wrappers.js:32-51]():\n\n```javascript\nif (\n  typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== \'undefined\' &&\n  typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart === \'function\'\n) {\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error());\n}\n// ... bundle code ...\nif (\n  typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== \'undefined\' &&\n  typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop === \'function\'\n) {\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error());\n}\n```\n\nThis is controlled by `wrapWithModuleBoundaries` in bundle configs.\n\n### Reconciler Factory Pattern\n\nThe `react-reconciler` package exports a factory function rather than direct exports [scripts/rollup/wrappers.js:171-263](), allowing custom renderers to provide their own host config:\n\n```javascript\nconst Reconciler = require(\'react-reconciler\');\nconst reconciler = Reconciler({\n  // custom host config\n  createInstance() { /*...*/ },\n  appendInitialChild() { /*...*/ },\n  // ...\n});\n```\n\n### .new and .old File System\n\nThe React codebase uses a `.new.js` / `.old.js` suffix pattern for staged changes (not explicitly shown in build code but mentioned in documentation). The build system doesn\'t special-case these - they\'re selected via the entry point or fork resolution mechanisms.\n\nSources: [scripts/rollup/wrappers.js:32-51](), [scripts/rollup/wrappers.js:171-263](), [scripts/jest/setupHostConfigs.js:18-56]()\n\n---\n\n# Page: Release Channels and Versioning\n\n# Release Channels and Versioning\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/shared/ReactFeatureFlags.js](packages/shared/ReactFeatureFlags.js)\n- [packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js](packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js)\n- [packages/shared/forks/ReactFeatureFlags.native-fb.js](packages/shared/forks/ReactFeatureFlags.native-fb.js)\n- [packages/shared/forks/ReactFeatureFlags.native-oss.js](packages/shared/forks/ReactFeatureFlags.native-oss.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.js](packages/shared/forks/ReactFeatureFlags.test-renderer.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js](packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.www.js](packages/shared/forks/ReactFeatureFlags.test-renderer.www.js)\n- [packages/shared/forks/ReactFeatureFlags.www-dynamic.js](packages/shared/forks/ReactFeatureFlags.www-dynamic.js)\n- [packages/shared/forks/ReactFeatureFlags.www.js](packages/shared/forks/ReactFeatureFlags.www.js)\n- [scripts/flow/xplat.js](scripts/flow/xplat.js)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React\'s release channel system and versioning strategy, which enables the codebase to ship different feature sets to different environments from a single source tree. The release channel system determines which experimental features are included in builds, how entry points are resolved, and where build artifacts are placed.\n\nFor information about how feature flags control individual features within a release channel, see [Feature Flags System](#2). For details on the build pipeline that processes these channels, see [Build Pipeline and Module Forking](#3.1).\n\n---\n\n## Release Channel Fundamentals\n\nReact uses a release channel system to control which features are enabled at build time. The `RELEASE_CHANNEL` environment variable determines the channel, which propagates throughout the build system as the `__EXPERIMENTAL__` constant.\n\n### Channel Types\n\n| Channel | __EXPERIMENTAL__ Value | Purpose |\n|---------|----------------------|---------|\n| `experimental` | `true` | Includes all experimental features, used for canary releases and internal testing |\n| `stable` (default) | `true` (when unset) | Standard releases with stable features only |\n| Facebook-specific | varies | Internal Facebook builds may use custom channels |\n\nThe core logic appears in [scripts/rollup/bundles.js:3-8]() and [scripts/rollup/build.js:31-38]():\n\n```javascript\nconst RELEASE_CHANNEL = process.env.RELEASE_CHANNEL;\n\nconst __EXPERIMENTAL__ =\n  typeof RELEASE_CHANNEL === \'string\'\n    ? RELEASE_CHANNEL === \'experimental\'\n    : true;\n```\n\n**Key behavior**: When `RELEASE_CHANNEL` is undefined, `__EXPERIMENTAL__` defaults to `true`, making experimental the default during development.\n\n### Release Channel Flow\n\n```mermaid\ngraph TB\n    EnvVar["process.env.RELEASE_CHANNEL"]\n    CheckType{"typeof === \'string\'?"}\n    CheckValue{"value === \'experimental\'?"}\n    DefaultTrue["__EXPERIMENTAL__ = true"]\n    SetTrue["__EXPERIMENTAL__ = true"]\n    SetFalse["__EXPERIMENTAL__ = false"]\n    \n    EnvVar --> CheckType\n    CheckType -->|"Yes"| CheckValue\n    CheckType -->|"No (undefined)"| DefaultTrue\n    CheckValue -->|"Yes"| SetTrue\n    CheckValue -->|"No"| SetFalse\n    \n    DefaultTrue --> PropagateToPlugins["Propagate to Rollup plugins"]\n    SetTrue --> PropagateToPlugins\n    SetFalse --> PropagateToPlugins\n    \n    PropagateToPlugins --> ReplacePlugin["@rollup/plugin-replace"]\n    PropagateToPlugins --> EntryForkResolution["Entry Point Fork Resolution"]\n    PropagateToPlugins --> FeatureFlagSelection["Feature Flag Configuration"]\n    \n    ReplacePlugin --> CodeTransform["__EXPERIMENTAL__  true/false in source"]\n    EntryForkResolution --> FileSelection[".experimental.js vs .stable.js"]\n    FeatureFlagSelection --> FlagValues["Flag true/false values"]\n```\n\nSources: [scripts/rollup/bundles.js:3-8](), [scripts/rollup/build.js:31-38](), [scripts/rollup/build.js:432-442]()\n\n---\n\n## Bundle Types and Target Environments\n\nReact generates multiple bundle variants for different environments, runtimes, and optimization levels. These bundle types form a matrix with release channels to determine the final build artifacts.\n\n### Bundle Type Categories\n\nThe build system defines bundle types in [scripts/rollup/bundles.js:10-31]():\n\n**Node.js Bundles**\n- `NODE_ES2015` - ES2015+ syntax for modern Node\n- `NODE_DEV` - Development builds with guards\n- `NODE_PROD` - Minified production builds\n- `NODE_PROFILING` - Profiling-enabled builds\n\n**Browser Bundles**\n- `ESM_DEV` - ES modules for development\n- `ESM_PROD` - ES modules for production\n- `BROWSER_SCRIPT` - Standalone browser scripts\n\n**Facebook Internal**\n- `FB_WWW_DEV` - Facebook web development\n- `FB_WWW_PROD` - Facebook web production\n- `FB_WWW_PROFILING` - Facebook web with profiling\n\n**React Native**\n- `RN_OSS_DEV/PROD/PROFILING` - Open source React Native\n- `RN_FB_DEV/PROD/PROFILING` - Facebook\'s internal React Native\n\n**Bun Runtime**\n- `BUN_DEV` - Bun development builds\n- `BUN_PROD` - Bun production builds\n\n### Bundle Type Characteristics\n\n```mermaid\ngraph LR\n    BundleType["Bundle Type"]\n    \n    subgraph "Production vs Development"\n        ProdCheck["isProductionBundleType()"]\n        DevGuards["if (process.env.NODE_ENV !== \'production\')"]\n        DevCode["Development-only code"]\n    end\n    \n    subgraph "Profiling"\n        ProfCheck["isProfilingBundleType()"]\n        ProfFlag["__PROFILE__ = true"]\n        ProfFeatures["Profiling APIs enabled"]\n    end\n    \n    subgraph "Module Format"\n        FormatCheck["getFormat()"]\n        CJS["CommonJS (cjs)"]\n        ESM["ES Modules (es)"]\n        IIFE["IIFE (iife)"]\n    end\n    \n    subgraph "Environment Flags"\n        FlagsCheck["getBundleTypeFlags()"]\n        IsFBWWW["isFBWWWBundle"]\n        IsRN["isRNBundle"]\n        IsFBRN["isFBRNBundle"]\n    end\n    \n    BundleType --> ProdCheck\n    BundleType --> ProfCheck\n    BundleType --> FormatCheck\n    BundleType --> FlagsCheck\n    \n    ProdCheck --> DevGuards\n    DevGuards --> DevCode\n    \n    ProfCheck --> ProfFlag\n    ProfFlag --> ProfFeatures\n    \n    FormatCheck --> CJS\n    FormatCheck --> ESM\n    FormatCheck --> IIFE\n    \n    FlagsCheck --> IsFBWWW\n    FlagsCheck --> IsRN\n    FlagsCheck --> IsFBRN\n```\n\nThe classification logic is in [scripts/rollup/build.js:253-310]():\n\n```javascript\nfunction isProductionBundleType(bundleType) {\n  switch (bundleType) {\n    case NODE_DEV:\n    case FB_WWW_DEV:\n    case RN_OSS_DEV:\n      return false;\n    case NODE_PROD:\n    case FB_WWW_PROD:\n      return true;\n    // ...\n  }\n}\n```\n\nSources: [scripts/rollup/bundles.js:10-54](), [scripts/rollup/build.js:225-310](), [scripts/rollup/build.js:312-338]()\n\n---\n\n## Entry Point Fork Resolution\n\nReact uses file naming conventions to provide different implementations for different release channels and environments. The build system resolves these "forks" at build time.\n\n### Fork Resolution Priority\n\nEntry points are resolved with the following priority order, from most specific to least specific:\n\n1. `.modern.fb.js` / `.classic.fb.js` (Facebook builds)\n2. `.fb.js` (generic Facebook)\n3. `.experimental.js` / `.stable.js` (release channel)\n4. `.development.js` (development mode)\n5. `.js` (base file)\n\n### Entry Point Resolution Algorithm\n\n```mermaid\ngraph TB\n    ResolveEntry["resolveEntryFork(resolvedEntry, isFBBundle, isDev)"]\n    \n    CheckFB{"isFBBundle?"}\n    \n    subgraph "Facebook Fork Resolution"\n        TryModernFB["Try: entry.modern.fb.js"]\n        ExistsModernFB{"File exists?"}\n        TryModernFBDev["Try: entry.modern.fb.development.js"]\n        ExistsModernFBDev{"File exists?"}\n        \n        TryClassicFB["Try: entry.classic.fb.js"]\n        ExistsClassicFB{"File exists?"}\n        TryClassicFBDev["Try: entry.classic.fb.development.js"]\n        ExistsClassicFBDev{"File exists?"}\n        \n        TryGenericFB["Try: entry.fb.js"]\n        ExistsGenericFB{"File exists?"}\n        TryGenericFBDev["Try: entry.fb.development.js"]\n        ExistsGenericFBDev{"File exists?"}\n    end\n    \n    subgraph "Channel Fork Resolution"\n        TryExp["Try: entry.experimental.js"]\n        ExistsExp{"File exists?"}\n        TryExpDev["Try: entry.experimental.development.js"]\n        ExistsExpDev{"File exists?"}\n        \n        TryStable["Try: entry.stable.js"]\n        ExistsStable{"File exists?"}\n        TryStableDev["Try: entry.stable.development.js"]\n        ExistsStableDev{"File exists?"}\n    end\n    \n    TryPlainDev["Try: entry.development.js"]\n    ExistsPlainDev{"File exists?"}\n    \n    UsePlain["Use: entry.js"]\n    \n    ResolveEntry --> CheckFB\n    \n    CheckFB -->|"Yes && __EXPERIMENTAL__"| TryModernFBDev\n    CheckFB -->|"Yes && !__EXPERIMENTAL__"| TryClassicFBDev\n    CheckFB -->|"No"| TryExpDev\n    \n    TryModernFBDev --> ExistsModernFBDev\n    ExistsModernFBDev -->|"Yes && isDev"| Return1["Return modern.fb.development.js"]\n    ExistsModernFBDev -->|"No"| TryModernFB\n    \n    TryModernFB --> ExistsModernFB\n    ExistsModernFB -->|"Yes"| Return2["Return modern.fb.js"]\n    ExistsModernFB -->|"No"| TryGenericFBDev\n    \n    TryClassicFBDev --> ExistsClassicFBDev\n    ExistsClassicFBDev -->|"Yes && isDev"| Return3["Return classic.fb.development.js"]\n    ExistsClassicFBDev -->|"No"| TryClassicFB\n    \n    TryClassicFB --> ExistsClassicFB\n    ExistsClassicFB -->|"Yes"| Return4["Return classic.fb.js"]\n    ExistsClassicFB -->|"No"| TryGenericFBDev\n    \n    TryGenericFBDev --> ExistsGenericFBDev\n    ExistsGenericFBDev -->|"Yes && isDev"| Return5["Return fb.development.js"]\n    ExistsGenericFBDev -->|"No"| TryGenericFB\n    \n    TryGenericFB --> ExistsGenericFB\n    ExistsGenericFB -->|"Yes"| Return6["Return fb.js"]\n    ExistsGenericFB -->|"No"| TryExpDev\n    \n    TryExpDev --> ExistsExpDev\n    ExistsExpDev -->|"Yes && isDev && __EXPERIMENTAL__"| Return7["Return experimental.development.js"]\n    ExistsExpDev -->|"No"| TryExp\n    \n    TryExp --> ExistsExp\n    ExistsExp -->|"Yes && __EXPERIMENTAL__"| Return8["Return experimental.js"]\n    ExistsExp -->|"No"| TryStableDev\n    \n    TryStableDev --> ExistsStableDev\n    ExistsStableDev -->|"Yes && isDev && !__EXPERIMENTAL__"| Return9["Return stable.development.js"]\n    ExistsStableDev -->|"No"| TryStable\n    \n    TryStable --> ExistsStable\n    ExistsStable -->|"Yes && !__EXPERIMENTAL__"| Return10["Return stable.js"]\n    ExistsStable -->|"No"| TryPlainDev\n    \n    TryPlainDev --> ExistsPlainDev\n    ExistsPlainDev -->|"Yes && isDev"| Return11["Return development.js"]\n    ExistsPlainDev -->|"No"| UsePlain\n    \n    UsePlain --> Return12["Return entry.js"]\n```\n\nThe implementation is in [scripts/rollup/build.js:585-633]():\n\n```javascript\nfunction resolveEntryFork(resolvedEntry, isFBBundle, isDev) {\n  if (isFBBundle) {\n    const resolvedFBEntry = resolvedEntry.replace(\n      \'.js\',\n      __EXPERIMENTAL__ ? \'.modern.fb.js\' : \'.classic.fb.js\'\n    );\n    const devFBEntry = resolvedFBEntry.replace(\'.js\', \'.development.js\');\n    if (isDev && fs.existsSync(devFBEntry)) {\n      return devFBEntry;\n    }\n    if (fs.existsSync(resolvedFBEntry)) {\n      return resolvedFBEntry;\n    }\n    // Falls through to generic .fb.js, then to channel forks\n  }\n  \n  const resolvedForkedEntry = resolvedEntry.replace(\n    \'.js\',\n    __EXPERIMENTAL__ ? \'.experimental.js\' : \'.stable.js\'\n  );\n  // ...\n}\n```\n\nSources: [scripts/rollup/build.js:585-633](), [scripts/jest/setupHostConfigs.js:7-99]()\n\n---\n\n## Interaction with Feature Flags\n\nRelease channels directly influence which feature flag configurations are loaded. The fork resolution system (documented in [Feature Flags System](#2)) selects flag files based on both the bundle type and release channel.\n\n### Feature Flag Fork Selection\n\nThe feature flag forking logic in [scripts/rollup/forks.js:134-191]() demonstrates the relationship:\n\n```javascript\n\'./packages/shared/ReactFeatureFlags.js\': (bundleType, entry) => {\n  switch (entry) {\n    case \'react-native-renderer\':\n      switch (bundleType) {\n        case RN_FB_DEV:\n        case RN_FB_PROD:\n          return \'./packages/shared/forks/ReactFeatureFlags.native-fb.js\';\n        case RN_OSS_DEV:\n        case RN_OSS_PROD:\n          return \'./packages/shared/forks/ReactFeatureFlags.native-oss.js\';\n      }\n    default:\n      switch (bundleType) {\n        case FB_WWW_DEV:\n        case FB_WWW_PROD:\n          return \'./packages/shared/forks/ReactFeatureFlags.www.js\';\n      }\n  }\n  return null; // Use canonical flags\n}\n```\n\n### Channel-Dependent Flag Values\n\nCertain flags have their values controlled by `__EXPERIMENTAL__`:\n\n```mermaid\ngraph LR\n    subgraph "Canonical Flags"\n        CanonicalFile["ReactFeatureFlags.js"]\n        FlagDefinitions["Flag = __EXPERIMENTAL__"]\n    end\n    \n    subgraph "Environment Forks"\n        WWWFork["ReactFeatureFlags.www.js"]\n        NativeFBFork["ReactFeatureFlags.native-fb.js"]\n        NativeOSSFork["ReactFeatureFlags.native-oss.js"]\n        TestRendererFork["ReactFeatureFlags.test-renderer.js"]\n    end\n    \n    subgraph "Dynamic Flags"\n        WWWDynamic["ReactFeatureFlags.www-dynamic.js"]\n        NativeFBDynamic["ReactFeatureFlags.native-fb-dynamic.js"]\n        VariantFlag["Flag = __VARIANT__"]\n    end\n    \n    EXPERIMENTAL["__EXPERIMENTAL__ constant"]\n    \n    EXPERIMENTAL --> CanonicalFile\n    CanonicalFile --> FlagDefinitions\n    \n    FlagDefinitions -.overrides.-> WWWFork\n    FlagDefinitions -.overrides.-> NativeFBFork\n    FlagDefinitions -.overrides.-> NativeOSSFork\n    FlagDefinitions -.overrides.-> TestRendererFork\n    \n    WWWFork --> WWWDynamic\n    NativeFBFork --> NativeFBDynamic\n    \n    WWWDynamic --> VariantFlag\n    NativeFBDynamic --> VariantFlag\n```\n\nExamples from [packages/shared/ReactFeatureFlags.js:75-100]():\n\n```javascript\nexport const enableLegacyCache = __EXPERIMENTAL__;\nexport const enableAsyncIterableChildren = __EXPERIMENTAL__;\nexport const enableTaint = __EXPERIMENTAL__;\nexport const enableGestureTransition = __EXPERIMENTAL__;\nexport const enableFizzBlockingRender = __EXPERIMENTAL__;\n```\n\nSources: [scripts/rollup/forks.js:134-191](), [packages/shared/ReactFeatureFlags.js:75-100](), [packages/shared/forks/ReactFeatureFlags.www.js:1-119]()\n\n---\n\n## Build Output Organization\n\nBuild artifacts are organized by environment, with different directory structures for different deployment targets.\n\n### Output Path Resolution\n\nThe `getBundleOutputPath()` function in [scripts/rollup/packaging.js:48-115]() determines where each bundle is written:\n\n| Bundle Type | Output Path Pattern | Example |\n|-------------|-------------------|---------|\n| NODE_ES2015, NODE_DEV, NODE_PROD, NODE_PROFILING | `build/node_modules/{package}/cjs/{filename}` | `build/node_modules/react/cjs/react.development.js` |\n| ESM_DEV, ESM_PROD | `build/node_modules/{package}/esm/{filename}` | `build/node_modules/react/esm/react.development.js` |\n| BUN_DEV, BUN_PROD | `build/node_modules/{package}/cjs/{filename}` | `build/node_modules/react-dom/cjs/react-dom-server.bun.development.js` |\n| FB_WWW_* | `build/facebook-www/{filename}` | `build/facebook-www/React-prod.classic.js` |\n| RN_OSS_* | `build/react-native/implementations/{filename}` | `build/react-native/implementations/ReactFabric-prod.js` |\n| RN_FB_* (most packages) | `build/facebook-react-native/{package}/cjs/{filename}` | `build/facebook-react-native/react/cjs/react.production.js` |\n| RN_FB_* (renderer) | `build/react-native/implementations/{filename}.fb.js` | `build/react-native/implementations/ReactFabric-prod.fb.js` |\n| BROWSER_SCRIPT | `build/node_modules/{package}/{outputPath}` | `build/node_modules/react-dom/unstable_server-external-runtime.js` |\n\n### Build Directory Structure\n\n```mermaid\ngraph TB\n    BuildRoot["build/"]\n    \n    subgraph "npm Packages"\n        NodeModules["node_modules/"]\n        PackageDir["react/, react-dom/, etc."]\n        CJSDir["cjs/"]\n        ESMDir["esm/"]\n        CJSFiles["*.development.js<br/>*.production.js<br/>*.profiling.js"]\n        ESMFiles["*.development.js<br/>*.production.js"]\n    end\n    \n    subgraph "Facebook Web"\n        FBWWW["facebook-www/"]\n        WWWFiles["React-prod.classic.js<br/>React-dev.classic.js<br/>ReactDOM-prod.modern.js"]\n        WWWShims["shims/"]\n    end\n    \n    subgraph "React Native"\n        RN["react-native/"]\n        RNImplementations["implementations/"]\n        RNShims["shims/"]\n        RNFiles["ReactFabric-dev.js<br/>ReactFabric-prod.fb.js"]\n    end\n    \n    subgraph "Facebook React Native"\n        FBRN["facebook-react-native/"]\n        FBRNPackages["react/, react-dom/, etc."]\n        FBRNCJSDir["cjs/"]\n        FBRNCJSFiles["*.development.js<br/>*.production.js"]\n    end\n    \n    BuildRoot --> NodeModules\n    BuildRoot --> FBWWW\n    BuildRoot --> RN\n    BuildRoot --> FBRN\n    \n    NodeModules --> PackageDir\n    PackageDir --> CJSDir\n    PackageDir --> ESMDir\n    CJSDir --> CJSFiles\n    ESMDir --> ESMFiles\n    \n    FBWWW --> WWWFiles\n    FBWWW --> WWWShims\n    \n    RN --> RNImplementations\n    RN --> RNShims\n    RNImplementations --> RNFiles\n    \n    FBRN --> FBRNPackages\n    FBRNPackages --> FBRNCJSDir\n    FBRNCJSDir --> FBRNCJSFiles\n```\n\nSources: [scripts/rollup/packaging.js:48-115](), [scripts/rollup/packaging.js:117-137]()\n\n---\n\n## Package Preparation and Distribution\n\nAfter building, packages undergo preparation steps to make them ready for distribution. The process varies by target environment.\n\n### npm Package Preparation\n\nThe `prepareNpmPackages()` function in [scripts/rollup/packaging.js:253-284]() performs the following steps:\n\n1. **Copy package metadata**: LICENSE, package.json, README.md, npm/ directory\n2. **Filter entry points**: Remove entry points not built for the current channel using `filterOutEntrypoints()`\n3. **Pack and extract**: Use `npm pack` to create a tarball, then extract it\n\n### Entry Point Filtering\n\nThe `filterOutEntrypoints()` function in [scripts/rollup/packaging.js:171-251]() removes entry points from package.json that weren\'t built for the current release channel:\n\n```mermaid\ngraph TB\n    PackageJSON["Read package.json"]\n    FilesArray["files: []"]\n    ExportsField["exports: {}"]\n    BrowserField["browser: {}"]\n    \n    IterateFiles["For each file in files[]"]\n    DetermineEntry["Determine entry point name"]\n    CheckBundle{"Has bundle for<br/>this entry?"}\n    \n    KeepFile["Keep in files[]<br/>Keep in exports"]\n    RemoveFile["Remove from files[]<br/>Delete from exports<br/>unlink() from disk"]\n    \n    WriteJSON["Write updated package.json"]\n    \n    PackageJSON --> FilesArray\n    PackageJSON --> ExportsField\n    PackageJSON --> BrowserField\n    \n    FilesArray --> IterateFiles\n    IterateFiles --> DetermineEntry\n    DetermineEntry --> CheckBundle\n    \n    CheckBundle -->|"Yes"| KeepFile\n    CheckBundle -->|"No (wrong channel)"| RemoveFile\n    \n    KeepFile --> WriteJSON\n    RemoveFile --> WriteJSON\n```\n\nThe function uses the `entryPointsToHasBundle` map built in [scripts/rollup/packaging.js:158-169]():\n\n```javascript\nlet entryPointsToHasBundle = new Map();\nfor (const bundle of Bundles.bundles) {\n  const hasNonFBBundleTypes = bundle.bundleTypes.some(\n    type =>\n      type !== FB_WWW_DEV && type !== FB_WWW_PROD && type !== FB_WWW_PROFILING\n  );\n  entryPointsToHasBundle.set(bundle.entry, hasNonFBBundleTypes);\n}\n```\n\nThis ensures that if a bundle is only built for internal Facebook use, it won\'t appear in the public npm package.\n\n### Conditional Package Exports\n\nReact uses package.json `exports` field to provide different entry points based on environment. Entry points may include suffixes like `.react-server` or `.rsc` that inherit their bundle status from the base entry point:\n\n```javascript\nif (entry.endsWith(\'.react-server\')) {\n  hasBundle = entryPointsToHasBundle.get(\n    entry.slice(0, \'.react-server\'.length * -1)\n  );\n} else if (entry.endsWith(\'.rsc\')) {\n  hasBundle = entryPointsToHasBundle.get(\n    entry.slice(0, \'.rsc\'.length * -1)\n  );\n}\n```\n\nFrom [scripts/rollup/packaging.js:197-205]().\n\n### Server Entry Point Distribution\n\nReact provides multiple server rendering entry points with conditional loading based on `process.env.NODE_ENV`. These are demonstrated in npm wrapper files:\n\n**Node.js Server** - [packages/react-dom/npm/server.node.js:1-19]():\n```javascript\nvar l, s;\nif (process.env.NODE_ENV === \'production\') {\n  l = require(\'./cjs/react-dom-server-legacy.node.production.js\');\n  s = require(\'./cjs/react-dom-server.node.production.js\');\n} else {\n  l = require(\'./cjs/react-dom-server-legacy.node.development.js\');\n  s = require(\'./cjs/react-dom-server.node.development.js\');\n}\n\nexports.renderToString = l.renderToString;\nexports.renderToStaticMarkup = l.renderToStaticMarkup;\nexports.renderToPipeableStream = s.renderToPipeableStream;\n```\n\n**Browser Server** - [packages/react-dom/npm/server.browser.js:1-17]()\n\n**Bun Server** - [packages/react-dom/npm/server.bun.js:1-20]()\n\n**Edge Runtime** - [packages/react-dom/npm/server.edge.js:1-18]()\n\nEach runtime has slightly different API surfaces based on capabilities. For example, `renderToPipeableStream` is only available in Node.js and Bun, not in the browser.\n\nSources: [scripts/rollup/packaging.js:158-273](), [packages/react-dom/npm/server.node.js:1-19](), [packages/react-dom/npm/server.browser.js:1-17](), [packages/react-dom/npm/server.bun.js:1-20]()\n\n---\n\n## Release Channel Usage in Tests\n\nThe test infrastructure respects release channels through environment setup. The `setupHostConfigs.js` file in [scripts/jest/setupHostConfigs.js:7-99]() uses the same `resolveEntryFork()` logic to ensure tests load the correct entry points.\n\n### Test Environment Globals\n\nTests can set global flags to simulate different environments:\n\n- `global.__WWW__` - Simulates Facebook web environment\n- `global.__XPLAT__` - Simulates cross-platform (React Native) environment  \n- `global.__DEV__` - Simulates development vs production mode\n- `__EXPERIMENTAL__` - Set based on test configuration to simulate different channels\n\nThese globals interact with `resolveEntryFork()` to load the appropriate module variants:\n\n```javascript\nfunction mockReact() {\n  jest.mock(\'react\', () => {\n    const resolvedEntryPoint = resolveEntryFork(\n      require.resolve(\'react\'),\n      global.__WWW__ || global.__XPLAT__,\n      global.__DEV__\n    );\n    return jest.requireActual(resolvedEntryPoint);\n  });\n}\n```\n\nFrom [scripts/jest/setupHostConfigs.js:101-115]().\n\nSources: [scripts/jest/setupHostConfigs.js:7-115]()\n\n---\n\n# Page: CI/CD and Artifact Management\n\n# CI/CD and Artifact Management\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\nThis document describes the build artifact generation, packaging, and distribution system in the React repository. It covers the build pipeline that produces multiple bundle variants, npm package preparation, Facebook internal synchronization, and validation processes.\n\nFor information about the build system\'s bundle configuration and plugin pipeline, see [Build Pipeline and Module Forking](#3.1). For release channel management, see [Release Channels and Versioning](#3.2).\n\n---\n\n## Build Artifact Structure\n\nThe React build system generates artifacts in multiple formats and configurations, organized by deployment target and environment.\n\n### Bundle Types\n\nThe build system produces 13 distinct bundle types, each targeting specific runtime environments:\n\n| Bundle Type | Format | Environment | Purpose |\n|------------|--------|-------------|---------|\n| `NODE_ES2015` | CJS | Node.js | ES2015+ features, modern Node |\n| `NODE_DEV` | CJS | Node.js | Development with DEV checks |\n| `NODE_PROD` | CJS | Node.js | Production, minified |\n| `NODE_PROFILING` | CJS | Node.js | Production with profiling |\n| `BUN_DEV` | CJS | Bun runtime | Development for Bun |\n| `BUN_PROD` | CJS | Bun runtime | Production for Bun |\n| `ESM_DEV` | ESM | Browsers/Bundlers | ES Module development |\n| `ESM_PROD` | ESM | Browsers/Bundlers | ES Module production |\n| `FB_WWW_DEV` | CJS | Facebook web | Internal development |\n| `FB_WWW_PROD` | CJS | Facebook web | Internal production |\n| `FB_WWW_PROFILING` | CJS | Facebook web | Internal profiling |\n| `RN_OSS_DEV` | CJS | React Native OSS | RN open source dev |\n| `RN_OSS_PROD` | CJS | React Native OSS | RN open source prod |\n| `RN_OSS_PROFILING` | CJS | React Native OSS | RN open source profiling |\n| `RN_FB_DEV` | CJS | React Native FB | RN internal dev |\n| `RN_FB_PROD` | CJS | React Native FB | RN internal prod |\n| `RN_FB_PROFILING` | CJS | React Native FB | RN internal profiling |\n| `BROWSER_SCRIPT` | IIFE | Browser | Direct script inclusion |\n\n**Sources:** [scripts/rollup/bundles.js:10-31](), [scripts/rollup/build.js:50-71]()\n\n### Output Directory Structure\n\n```mermaid\ngraph TB\n    Build["build/"]\n    \n    NodeModules["node_modules/"]\n    FacebookWWW["facebook-www/"]\n    FacebookRN["facebook-react-native/"]\n    ReactNative["react-native/"]\n    \n    Build --> NodeModules\n    Build --> FacebookWWW\n    Build --> FacebookRN\n    Build --> ReactNative\n    \n    NodeModules --> ReactPkg["react/"]\n    NodeModules --> ReactDOMPkg["react-dom/"]\n    NodeModules --> SchedulerPkg["scheduler/"]\n    \n    ReactPkg --> ReactCJS["cjs/"]\n    ReactPkg --> ReactESM["esm/"]\n    ReactPkg --> ReactNPM["npm/"]\n    \n    ReactDOMPkg --> DOMcjs["cjs/"]\n    ReactDOMPkg --> DOMesm["esm/"]\n    \n    FacebookWWW --> WWWBundles["*.js (FB_WWW_* bundles)"]\n    FacebookWWW --> WWWShims["shims/"]\n    \n    ReactNative --> RNImplementations["implementations/"]\n    ReactNative --> RNShims["shims/"]\n    \n    FacebookRN --> FBRNReact["react/cjs/"]\n    FacebookRN --> FBRNReactDOM["react-dom/cjs/"]\n    FacebookRN --> FBRNScheduler["scheduler/cjs/"]\n```\n\n**Sources:** [scripts/rollup/packaging.js:48-114]()\n\n---\n\n## Build Pipeline\n\n### Build Orchestration\n\nThe build process is orchestrated by `build.js`, which coordinates bundle generation across all configurations:\n\n```mermaid\ngraph TB\n    Entry["Build Entry Point<br/>scripts/rollup/build.js"]\n    \n    ParseArgs["Parse CLI Arguments<br/>--type, bundle names, --watch"]\n    LoadBundles["Load Bundle Configs<br/>from bundles.js"]\n    FilterBundles["Filter by Requested<br/>Types and Names"]\n    \n    Entry --> ParseArgs\n    ParseArgs --> LoadBundles\n    LoadBundles --> FilterBundles\n    \n    subgraph "For Each Bundle"\n        ResolveEntry["Resolve Entry Fork<br/>resolveEntryFork()"]\n        GetPlugins["Build Plugin Pipeline<br/>getPlugins()"]\n        ConfigRollup["Configure Rollup<br/>input, external, treeshake"]\n        RunRollup["Execute Rollup Build"]\n        WrapOutput["Apply Wrappers<br/>license, module boundaries"]\n        RecordSize["Record Bundle Size<br/>to Stats"]\n    end\n    \n    FilterBundles --> ResolveEntry\n    ResolveEntry --> GetPlugins\n    GetPlugins --> ConfigRollup\n    ConfigRollup --> RunRollup\n    RunRollup --> WrapOutput\n    WrapOutput --> RecordSize\n    \n    RecordSize --> PackagePrep["Prepare NPM Packages<br/>prepareNpmPackages()"]\n    RecordSize --> CopyShims["Copy Shims<br/>copyAllShims()"]\n    RecordSize --> Sync["Sync to Facebook<br/>if --sync-* args"]\n```\n\n**Sources:** [scripts/rollup/build.js:635-785](), [scripts/rollup/build.js:94-108]()\n\n### Entry Point Resolution\n\nEntry points use a forking mechanism to select environment-specific implementations:\n\n```mermaid\ngraph LR\n    BaseEntry["base/entry.js"]\n    \n    FBModern[".modern.fb.js"]\n    FBClassic[".classic.fb.js"]\n    FBGeneric[".fb.js"]\n    Experimental[".experimental.js"]\n    Stable[".stable.js"]\n    DevVariant[".development.js"]\n    \n    BaseEntry -->|"FB_WWW + __EXPERIMENTAL__"| FBModern\n    BaseEntry -->|"FB_WWW + !__EXPERIMENTAL__"| FBClassic\n    BaseEntry -->|"FB_WWW (fallback)"| FBGeneric\n    BaseEntry -->|"!FB + __EXPERIMENTAL__"| Experimental\n    BaseEntry -->|"!FB + !__EXPERIMENTAL__"| Stable\n    \n    FBModern -.->|"isDev"| DevVariant\n    Experimental -.->|"isDev"| DevVariant\n```\n\n**Sources:** [scripts/rollup/build.js:585-633]()\n\n### Plugin Pipeline\n\nEach bundle type uses a customized Rollup plugin pipeline:\n\n```mermaid\ngraph TB\n    SourceCode["Source Code<br/>(Flow/TypeScript)"]\n    \n    subgraph "Preprocessing"\n        DynamicImports["dynamicImports()<br/>Keep dynamic imports external"]\n        TypeRemoval["Flow/TypeScript Removal<br/>flowRemoveTypes() or typescript()"]\n        CommonJS["commonjs()<br/>For TypeScript bundles only"]\n    end\n    \n    subgraph "Module Resolution"\n        Forks["useForks()<br/>Environment-specific modules"]\n        ForbidFB["forbidFBJSImports()<br/>Prevent fbjs imports"]\n        Resolve["resolve()<br/>Node module resolution"]\n    end\n    \n    subgraph "Transformation"\n        StripBanner["stripBanner()<br/>Remove license headers"]\n        Babel["babel()<br/>ES2015+  ES5"]\n        RemoveStrict["Remove \'use strict\'"]\n        Replace["replace()<br/>__DEV__, __PROFILE__, etc"]\n        External["externalRuntime()<br/>For server-external-runtime"]\n    end\n    \n    subgraph "Optimization"\n        TopLevel["wrapWithTopLevelDefinitions()<br/>Module boundaries"]\n        Closure["closure()<br/>Google Closure Compiler"]\n        Prettier["prettier()<br/>Format output"]\n    end\n    \n    subgraph "Finalization"\n        License["wrapWithLicenseHeader()"]\n        Sizes["sizes()<br/>Record bundle metrics"]\n    end\n    \n    SourceCode --> DynamicImports\n    DynamicImports --> TypeRemoval\n    TypeRemoval --> CommonJS\n    CommonJS --> Forks\n    Forks --> ForbidFB\n    ForbidFB --> Resolve\n    Resolve --> StripBanner\n    StripBanner --> Babel\n    Babel --> RemoveStrict\n    RemoveStrict --> Replace\n    Replace --> External\n    External --> TopLevel\n    TopLevel --> Closure\n    Closure --> Prettier\n    Prettier --> License\n    License --> Sizes\n```\n\n**Sources:** [scripts/rollup/build.js:354-546]()\n\n---\n\n## Package Preparation\n\n### NPM Package Generation Process\n\nAfter building, artifacts are prepared for npm distribution:\n\n```mermaid\ngraph TB\n    BuildComplete["Build Complete<br/>Artifacts in build/"]\n    \n    CopyFiles["Copy Package Files<br/>LICENSE, README.md, package.json"]\n    CopyNPM["Copy npm/ Directory<br/>Wrapper files"]\n    \n    FilterEntries["filterOutEntrypoints()<br/>Remove unbundled entries"]\n    ReadPkgJSON["Read package.json"]\n    CheckFiles["Check files[] array"]\n    \n    subgraph "Entry Point Filtering"\n        FindEntry["For each file in files[]"]\n        CheckBundle["Check entryPointsToHasBundle Map"]\n        HasBundle{Has Bundle?}\n        KeepFile["Keep in files[]"]\n        RemoveFile["Remove from files[]<br/>Delete file<br/>Update exports, browser"]\n    end\n    \n    NPMPack["npm pack build/node_modules/PKG"]\n    ExtractTar["Extract .tgz"]\n    StripPackage["Strip \'package/\' prefix"]\n    \n    BuildComplete --> CopyFiles\n    CopyFiles --> CopyNPM\n    CopyNPM --> FilterEntries\n    \n    FilterEntries --> ReadPkgJSON\n    ReadPkgJSON --> CheckFiles\n    CheckFiles --> FindEntry\n    FindEntry --> CheckBundle\n    CheckBundle --> HasBundle\n    HasBundle -->|Yes| KeepFile\n    HasBundle -->|No| RemoveFile\n    \n    RemoveFile --> NPMPack\n    KeepFile --> NPMPack\n    NPMPack --> ExtractTar\n    ExtractTar --> StripPackage\n```\n\n**Sources:** [scripts/rollup/packaging.js:253-273](), [scripts/rollup/packaging.js:171-251]()\n\n### Package Structure Example (react-dom)\n\nThe `react-dom` package demonstrates multi-environment entry points:\n\n| Entry Point | File | Condition | Bundle Type |\n|-------------|------|-----------|-------------|\n| `.` | `index.js` | default | NODE_DEV/PROD |\n| `.` | `react-dom.react-server.js` | react-server | SERVER |\n| `./client` | `client.js` | default | NODE_DEV/PROD |\n| `./client` | `client.react-server.js` | react-server | SERVER |\n| `./server` | `server.node.js` | node | NODE_DEV/PROD |\n| `./server` | `server.browser.js` | browser/worker | BROWSER |\n| `./server` | `server.edge.js` | edge-light/workerd | EDGE |\n| `./server` | `server.bun.js` | bun | BUN_DEV/PROD |\n| `./profiling` | `profiling.js` | default | NODE_PROFILING |\n| `./test-utils` | `test-utils.js` | default | NODE_DEV/PROD |\n\n**Sources:** [packages/react-dom/package.json:51-125]()\n\n### Bundle Output Path Mapping\n\nThe `getBundleOutputPath()` function maps bundles to their destination paths:\n\n```mermaid\ngraph TB\n    Bundle["Bundle Configuration"]\n    \n    NodeESM["NODE_ES2015/ESM_*<br/> build/node_modules/PKG/esm/"]\n    NodeCJS["NODE_DEV/PROD/PROFILING<br/> build/node_modules/PKG/cjs/"]\n    BunCJS["BUN_DEV/PROD<br/> build/node_modules/PKG/cjs/"]\n    \n    FBWWW["FB_WWW_*<br/> build/facebook-www/"]\n    \n    RNOSSImpl["RN_OSS_* (react-native-renderer)<br/> build/react-native/implementations/"]\n    RNFBImpl["RN_FB_* (react-native-renderer)<br/> build/react-native/implementations/*.fb.js"]\n    RNFBPkg["RN_FB_* (other packages)<br/> build/facebook-react-native/PKG/cjs/"]\n    \n    BrowserScript["BROWSER_SCRIPT<br/> build/node_modules/PKG/outputPath"]\n    \n    Bundle --> NodeESM\n    Bundle --> NodeCJS\n    Bundle --> BunCJS\n    Bundle --> FBWWW\n    Bundle --> RNOSSImpl\n    Bundle --> RNFBImpl\n    Bundle --> RNFBPkg\n    Bundle --> BrowserScript\n```\n\n**Sources:** [scripts/rollup/packaging.js:48-114]()\n\n---\n\n## Facebook Internal Synchronization\n\n### Sync Infrastructure\n\nThe `sync.js` module provides utilities to copy build artifacts to Facebook\'s internal repositories:\n\n```mermaid\ngraph TB\n    BuildArtifacts["Build Artifacts"]\n    \n    SyncFBSource["Sync to fbsource<br/>--sync-fbsource PATH"]\n    SyncWWW["Sync to www<br/>--sync-www PATH"]\n    \n    subgraph "fbsource Sync"\n        RNPath["xplat/js/react-native-github/<br/>Libraries/Renderer/"]\n        CopyRN["Copy RN_FB_* bundles"]\n    end\n    \n    subgraph "www Sync"\n        WWWPath["~/www/"]\n        CopyWWW["Copy FB_WWW_* bundles"]\n    end\n    \n    BuildArtifacts --> SyncFBSource\n    BuildArtifacts --> SyncWWW\n    \n    SyncFBSource --> RNPath\n    RNPath --> CopyRN\n    \n    SyncWWW --> WWWPath\n    WWWPath --> CopyWWW\n```\n\n**Sources:** [scripts/rollup/sync.js:1-47]()\n\n### Shim Files\n\nEnvironment-specific shims are copied to build outputs:\n\n- **Facebook WWW**: [scripts/rollup/shims/facebook-www]()  `build/facebook-www/shims/`\n- **React Native**: [scripts/rollup/shims/react-native]()  `build/react-native/shims/`\n- **RN Types**: [react-native-renderer/src/ReactNativeTypes.js]()  `build/react-native/shims/ReactNativeTypes.js`\n\n**Sources:** [scripts/rollup/packaging.js:117-137]()\n\n---\n\n## Build Validation\n\n### Artifact Linting System\n\nAfter the build completes, all artifacts are validated using ESLint with environment-specific configurations:\n\n```mermaid\ngraph TB\n    Validate["validate/index.js"]\n    \n    GlobFiles["Glob build/**/*.js"]\n    DetermineFormat["getFormat(filepath)"]\n    \n    FormatFB{Format?}\n    FormatRN[RN]\n    FormatCJS[CJS]\n    FormatCJS2015[CJS2015]\n    FormatESM[ESM]\n    \n    ConfigFB["eslintrc.fb.js"]\n    ConfigRN["eslintrc.rn.js"]\n    ConfigCJS["eslintrc.cjs.js"]\n    ConfigCJS2015["eslintrc.cjs2015.js"]\n    ConfigESM["eslintrc.esm.js"]\n    \n    RunESLint["ESLint.lintFiles()"]\n    CheckResults["Check for Errors"]\n    ReportErrors["Log Errors with Context"]\n    \n    Validate --> GlobFiles\n    GlobFiles --> DetermineFormat\n    DetermineFormat --> FormatFB\n    \n    FormatFB -->|fb| ConfigFB\n    FormatFB -->|rn| ConfigRN\n    FormatFB -->|cjs| ConfigCJS\n    FormatFB -->|cjs2015| ConfigCJS2015\n    FormatFB -->|esm| ConfigESM\n    \n    ConfigFB --> RunESLint\n    ConfigRN --> RunESLint\n    ConfigCJS --> RunESLint\n    ConfigCJS2015 --> RunESLint\n    ConfigESM --> RunESLint\n    \n    RunESLint --> CheckResults\n    CheckResults --> ReportErrors\n```\n\n**Sources:** [scripts/rollup/validate/index.js:11-100]()\n\n### Environment-Specific ESLint Rules\n\nEach build format has specific global variable and syntax constraints:\n\n| Format | Parser | ECMAScript | Unique Globals |\n|--------|--------|------------|----------------|\n| `fb` | ESLint (ES5) | ES5 | `__DEV__` |\n| `rn` | ESLint (ES5) | ES5 | `__DEV__`, `nativeFabricUIManager`, `RN$enableMicrotasksInReact` |\n| `cjs` | ESLint (ES2020) | ES2020 | Node.js globals (`process`, `Buffer`, `setImmediate`) |\n| `cjs2015` | ESLint (ES2020) | ES2020 | Same as CJS, plus ES2015+ features |\n| `esm` | ESLint (ES2020) | ES2020 | Same as CJS |\n\nAll formats validate:\n- No undefined variables (`no-undef`)\n- No shadowing restricted names (`no-shadow-restricted-names`)\n- No `JSCompiler_OptimizeArgumentsArray_*` identifiers (GCC optimization artifact)\n\n**Sources:** [scripts/rollup/validate/eslintrc.fb.js:1-112](), [scripts/rollup/validate/eslintrc.rn.js:1-97](), [scripts/rollup/validate/eslintrc.cjs.js:1-111](), [scripts/rollup/validate/eslintrc.cjs2015.js:1-111](), [scripts/rollup/validate/eslintrc.esm.js:1-112]()\n\n---\n\n## Build Script Integration\n\n### Primary Build Commands\n\nThe root `package.json` defines build workflows:\n\n```mermaid\ngraph LR\n    BuildCmd["yarn build"]\n    BuildReleaseChannels["build-all-release-channels.js"]\n    \n    BuildDevTools["yarn build-for-devtools"]\n    BuildFlight["yarn build-for-flight-dev"]\n    BuildVT["yarn build-for-vt-dev"]\n    \n    BuildCmd --> BuildReleaseChannels\n    BuildReleaseChannels --> BuildStable["Build stable channel"]\n    BuildReleaseChannels --> BuildExperimental["Build experimental channel"]\n    \n    BuildDevTools --> FilteredBuild1["react, react-dom, scheduler<br/>NODE_DEV/PROD, experimental"]\n    BuildFlight --> FilteredBuild2["RSC packages<br/>NODE_DEV, ESM_PROD, NODE_ES2015"]\n    BuildVT --> FilteredBuild3["View Transitions<br/>NODE_DEV, experimental"]\n```\n\nKey command arguments:\n- `--type=BUNDLE_TYPE`: Filter by bundle type (e.g., `NODE_DEV`, `FB_WWW_PROD`)\n- Bundle names: Filter by entry point (e.g., `react/index`, `react-dom/server`)\n- `--watch`: Enable watch mode for development\n- `--sync-fbsource PATH`: Sync to Facebook internal monorepo\n- `--sync-www PATH`: Sync to Facebook www repository\n\n**Sources:** [package.json:124-157]()\n\n### Release Channel Environment Variable\n\nThe `RELEASE_CHANNEL` environment variable controls which feature flag fork is used:\n\n- `RELEASE_CHANNEL=experimental`: Enables experimental features, uses `.experimental.js` forks\n- `RELEASE_CHANNEL=stable`: Uses stable feature flags, uses `.stable.js` forks\n- Undefined: Defaults to experimental\n\n**Sources:** [scripts/rollup/build.js:31-38](), [scripts/rollup/bundles.js:3-8]()\n\n---\n\n## Artifact Metadata\n\n### Bundle Size Tracking\n\nThe `sizes-plugin` records bundle sizes during build:\n\n```javascript\n// In getPlugins()\nsizes({\n  getSize: (size, gzip) => {\n    const currentSizes = Stats.currentBuildResults.bundleSizes;\n    const recordIndex = currentSizes.findIndex(\n      record =>\n        record.filename === filename && record.bundleType === bundleType\n    );\n    const index = recordIndex !== -1 ? recordIndex : currentSizes.length;\n    currentSizes[index] = {\n      filename,\n      bundleType,\n      packageName,\n      size,\n      gzip,\n    };\n  },\n})\n```\n\nThis data is stored in the `Stats` module and used for size regression analysis.\n\n**Sources:** [scripts/rollup/build.js:522-538]()\n\n### Version Management\n\nThe canonical version is maintained in `ReactVersion.js`:\n\n```javascript\nexport default \'19.3.0\';\n```\n\nThis version is:\n- Used at runtime for DevTools compatibility\n- Injected into package.json files during package preparation\n- Referenced by release scripts\n\n**Sources:** [packages/shared/ReactVersion.js:1-16](), [packages/react/package.json:7](), [packages/react-dom/package.json:3]()\n\n---\n\n## Code Wrapping and Headers\n\n### Module Boundary Wrappers\n\nThe `wrappers.js` module provides environment-specific code wrapping:\n\n**Development Bundles (NODE_DEV, FB_WWW_DEV, RN_OSS_DEV, RN_FB_DEV)**:\n```javascript\n\'use strict\';\n\nif (__DEV__) {  // or process.env.NODE_ENV !== "production"\n  (function() {\n    // Bundle code here\n  })();\n}\n```\n\n**Production Bundles**: No wrapping, direct execution\n\n**Reconciler Bundles with DevTools**:\n```javascript\n\'use strict\';\nif (typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== \'undefined\' &&\n    typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart === \'function\') {\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error());\n}\n// Bundle code\nif (typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== \'undefined\' &&\n    typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop === \'function\') {\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error());\n}\n```\n\n**Sources:** [scripts/rollup/wrappers.js:32-169]()\n\n### License Headers\n\nAll production artifacts include the MIT license header:\n\n```\n/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n```\n\n**Sources:** [scripts/rollup/wrappers.js:53-56]()\n\n---\n\n# Page: React Reconciler\n\n# React Reconciler\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-debug-tools/src/ReactDebugHooks.js](packages/react-debug-tools/src/ReactDebugHooks.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspection-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspection-test.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegration-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegration-test.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegrationDOM-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegrationDOM-test.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/CustomHooks.js](packages/react-devtools-shell/src/app/InspectableElements/CustomHooks.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberHooks.js](packages/react-reconciler/src/ReactFiberHooks.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRoot.js](packages/react-reconciler/src/ReactFiberRoot.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactInternalTypes.js](packages/react-reconciler/src/ReactInternalTypes.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactHooks-test.internal.js](packages/react-reconciler/src/__tests__/ReactHooks-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFizzHooks.js](packages/react-server/src/ReactFizzHooks.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightHooks.js](packages/react-server/src/ReactFlightHooks.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactHooks.js](packages/react/src/ReactHooks.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\nThe React Reconciler is the platform-agnostic core reconciliation algorithm that coordinates React updates. It implements the Fiber architecture, manages component lifecycles, schedules work, and delegates host-specific operations to pluggable renderers through the `ReactFiberConfig` interface.\n\n**Scope**: This page covers the reconciler\'s architecture, work loop execution, phase separation, and coordination mechanisms. For specific renderer implementations (DOM, Native), see [Rendering Targets](#4). For server-side rendering systems (Fizz, Flight), see [Server-Side Rendering](#5). For Hooks implementation details, see [React Hooks System](#3.2). For scheduling and priority details, see [Lane-Based Priority and Scheduling](#3.4).\n\n---\n\n## Reconciler Architecture Overview\n\n```mermaid\ngraph TB\n    subgraph "React Public API"\n        JSX["JSX / React.createElement"]\n        Hooks["useState/useEffect/..."]\n        Context["Context API"]\n    end\n    \n    subgraph "Reconciler Core (react-reconciler/src/)"\n        ReconcilerAPI["ReactFiberReconciler.js<br/>createContainer()<br/>updateContainer()"]\n        WorkLoop["ReactFiberWorkLoop.js<br/>performWorkOnRoot()<br/>renderRootSync/Concurrent()"]\n        BeginWork["ReactFiberBeginWork.js<br/>beginWork()<br/>updateFunctionComponent()"]\n        CompleteWork["ReactFiberCompleteWork.js<br/>completeWork()<br/>createInstance()"]\n        CommitWork["ReactFiberCommitWork.js<br/>commitMutationEffects()<br/>commitLayoutEffects()"]\n        Hooks2["ReactFiberHooks.js<br/>renderWithHooks()<br/>mountState()/updateState()"]\n    end\n    \n    subgraph "Fiber Data Structure"\n        FiberNode["Fiber (ReactInternalTypes.js)<br/>tag: WorkTag<br/>stateNode: any<br/>memoizedState: any<br/>updateQueue: UpdateQueue"]\n        FiberRoot["FiberRoot<br/>current: Fiber<br/>containerInfo: Container<br/>pendingLanes: Lanes"]\n    end\n    \n    subgraph "Host Configuration"\n        HostConfig["ReactFiberConfig.js<br/>createInstance()<br/>appendChild()<br/>commitUpdate()"]\n    end\n    \n    subgraph "Renderers"\n        DOM["ReactFiberConfigDOM"]\n        Native["ReactFiberConfigNative"]\n    end\n    \n    JSX --> ReconcilerAPI\n    Hooks --> Hooks2\n    Context --> BeginWork\n    \n    ReconcilerAPI --> WorkLoop\n    WorkLoop --> BeginWork\n    BeginWork --> CompleteWork\n    CompleteWork --> CommitWork\n    Hooks2 --> BeginWork\n    \n    BeginWork --> FiberNode\n    CompleteWork --> FiberNode\n    WorkLoop --> FiberRoot\n    \n    CompleteWork --> HostConfig\n    CommitWork --> HostConfig\n    \n    HostConfig --> DOM\n    HostConfig --> Native\n    \n    style WorkLoop fill:#f9f9f9\n    style HostConfig fill:#f9f9f9\n```\n\nThe reconciler operates through a two-phase render cycle: the **render phase** (interruptible) walks the Fiber tree calling `beginWork` and `completeWork`, and the **commit phase** (synchronous) applies changes to the host environment.\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1-1279](), [packages/react-reconciler/src/ReactFiberReconciler.js:1-354](), [packages/react-reconciler/src/ReactInternalTypes.js:88-207]()\n\n---\n\n## Fiber Data Structure\n\nThe **Fiber** is the fundamental unit of work in the reconciler. Each Fiber node represents a component instance and its associated work.\n\n```mermaid\ngraph LR\n    subgraph "Fiber Node Structure"\n        Fiber["Fiber<br/>ReactInternalTypes.js:88-207"]\n        \n        Identity["Identity Fields<br/>tag: WorkTag<br/>key: string | null<br/>elementType: any<br/>type: any<br/>stateNode: any"]\n        \n        Tree["Tree Structure<br/>return: Fiber | null<br/>child: Fiber | null<br/>sibling: Fiber | null<br/>index: number"]\n        \n        State["State & Props<br/>pendingProps: mixed<br/>memoizedProps: mixed<br/>memoizedState: any<br/>updateQueue: UpdateQueue"]\n        \n        Effects["Effects<br/>flags: Flags<br/>subtreeFlags: Flags<br/>deletions: Array<Fiber>"]\n        \n        Scheduling["Scheduling<br/>lanes: Lanes<br/>childLanes: Lanes<br/>alternate: Fiber | null"]\n    end\n    \n    Fiber --> Identity\n    Fiber --> Tree\n    Fiber --> State\n    Fiber --> Effects\n    Fiber --> Scheduling\n```\n\n| Field | Purpose |\n|-------|---------|\n| `tag` | WorkTag identifying component type (FunctionComponent, ClassComponent, HostComponent, etc.) |\n| `stateNode` | Reference to DOM node, class instance, or other host instance |\n| `memoizedState` | Output state from last render; for hooks, this is the linked list of Hook objects |\n| `updateQueue` | Queue of state updates and effects to process |\n| `flags` | Side-effect flags (Placement, Update, Deletion, Passive, etc.) |\n| `lanes` | Priority lanes representing pending work on this fiber |\n| `alternate` | Double-buffering: points to the current tree\'s corresponding fiber during updates |\n\n**Sources**: [packages/react-reconciler/src/ReactInternalTypes.js:88-207](), [packages/react-reconciler/src/ReactFiber.js:136-209]()\n\n---\n\n## Work Loop Execution Model\n\nThe work loop is the heart of the reconciler, managing the progression through render and commit phases.\n\n```mermaid\ngraph TB\n    Start["scheduleUpdateOnFiber()<br/>ReactFiberWorkLoop.js:916"]\n    \n    EnsureScheduled["ensureRootIsScheduled()<br/>Determine next work lanes"]\n    \n    PerformWork["performWorkOnRoot()<br/>ReactFiberWorkLoop.js:1066"]\n    \n    TimeSlice{"shouldTimeSlice?<br/>!forceSync &&<br/>!includesBlockingLane()"}\n    \n    RenderSync["renderRootSync()<br/>ReactFiberWorkLoop.js:1499"]\n    RenderConcurrent["renderRootConcurrent()<br/>ReactFiberWorkLoop.js:1416"]\n    \n    WorkLoopSync["workLoopSync()<br/>while (workInProgress !== null)<br/>  performUnitOfWork()"]\n    \n    WorkLoopConcurrent["workLoopConcurrent()<br/>while (workInProgress !== null<br/>  && !shouldYield())<br/>  performUnitOfWork()"]\n    \n    UnitOfWork["performUnitOfWork()<br/>ReactFiberWorkLoop.js:1794"]\n    \n    BeginPhase["beginWork()<br/>ReactFiberBeginWork.js"]\n    CompletePhase["completeUnitOfWork()<br/>completeWork()"]\n    \n    CommitRoot["commitRoot()<br/>ReactFiberWorkLoop.js:2386"]\n    \n    CommitBeforeMutation["commitBeforeMutationEffects()"]\n    CommitMutation["commitMutationEffects()"]\n    CommitLayout["commitLayoutEffects()"]\n    CommitPassive["flushPassiveEffects()"]\n    \n    Start --> EnsureScheduled\n    EnsureScheduled --> PerformWork\n    PerformWork --> TimeSlice\n    \n    TimeSlice -->|Yes| RenderConcurrent\n    TimeSlice -->|No| RenderSync\n    \n    RenderSync --> WorkLoopSync\n    RenderConcurrent --> WorkLoopConcurrent\n    \n    WorkLoopSync --> UnitOfWork\n    WorkLoopConcurrent --> UnitOfWork\n    \n    UnitOfWork --> BeginPhase\n    BeginPhase --> CompletePhase\n    \n    CompletePhase --> CommitRoot\n    \n    CommitRoot --> CommitBeforeMutation\n    CommitBeforeMutation --> CommitMutation\n    CommitMutation --> CommitLayout\n    CommitLayout --> CommitPassive\n```\n\n### Render Phase\n\nThe render phase walks the Fiber tree and determines what changes are needed. It consists of two sub-phases:\n\n**Begin Work** ([ReactFiberBeginWork.js:1400-2900]()):\n- Processes the component (calls render, hooks, etc.)\n- Reconciles children using `reconcileChildren`\n- Returns the next child fiber to process\n- Key functions: `updateFunctionComponent`, `updateClassComponent`, `updateHostComponent`\n\n**Complete Work** ([ReactFiberCompleteWork.js:600-1200]()):\n- Creates or updates host instances via `createInstance`, `finalizeInitialChildren`\n- Bubbles up side-effect flags from children\n- Returns to parent, then processes sibling\n\nThe render phase is **interruptible** in concurrent mode  `shouldYield()` allows pausing to handle higher-priority work.\n\n### Commit Phase\n\nThe commit phase applies the work from the render phase. It is **synchronous and uninterruptible**:\n\n1. **Before Mutation** ([ReactFiberCommitWork.js:343-591]()): `getSnapshotBeforeUpdate`, prepare for DOM mutations\n2. **Mutation** ([ReactFiberCommitWork.js:2400-3100]()): Apply DOM changes (insert, update, delete nodes)\n3. **Layout** ([ReactFiberCommitWork.js:593-870]()): `componentDidMount`, `useLayoutEffect`, ref attachment\n4. **Passive** ([ReactFiberCommitWork.js:2629-2800]()): `useEffect` (scheduled after paint)\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1066-1800](), [packages/react-reconciler/src/ReactFiberBeginWork.js:341-470](), [packages/react-reconciler/src/ReactFiberCommitWork.js:343-870]()\n\n---\n\n## Host Configuration Abstraction\n\nThe reconciler delegates all platform-specific operations through the `ReactFiberConfig` interface. This enables React to target multiple platforms without modifying core logic.\n\n```mermaid\ngraph TB\n    subgraph "Reconciler Operations"\n        CreateInst["createInstance() call<br/>in completeWork()"]\n        AppendChild["appendChild() call<br/>in commitMutationEffects()"]\n        CommitUpdate["commitUpdate() call<br/>in commitMutationEffects()"]\n    end\n    \n    subgraph "ReactFiberConfig Interface"\n        Config["ReactFiberConfig.js<br/>Platform-specific implementation"]\n        \n        Methods["Key Methods:<br/>createInstance(type, props)<br/>createTextInstance(text)<br/>appendChild(parent, child)<br/>insertBefore(parent, child, before)<br/>removeChild(parent, child)<br/>commitUpdate(instance, type, oldProps, newProps)<br/>finalizeInitialChildren(instance, type, props)<br/>prepareForCommit(container)<br/>resetAfterCommit(container)"]\n    end\n    \n    subgraph "Renderer Implementations"\n        DOMConfig["ReactFiberConfigDOM.js<br/>DOM-specific"]\n        FabricConfig["ReactFiberConfigFabric.js<br/>React Native Fabric"]\n        NoopConfig["ReactNoop.js<br/>Testing"]\n    end\n    \n    CreateInst --> Config\n    AppendChild --> Config\n    CommitUpdate --> Config\n    \n    Config --> Methods\n    \n    Methods --> DOMConfig\n    Methods --> FabricConfig\n    Methods --> NoopConfig\n```\n\n### Mutation vs Persistence\n\nRenderers implement one of two strategies:\n\n**Mutation Mode** (DOM, React Native Legacy):\n- `supportsMutation = true`\n- Modifies host instances in place\n- Methods: `appendChild`, `removeChild`, `commitUpdate`\n\n**Persistence Mode** (React Native Fabric):\n- `supportsPersistence = true`\n- Clones and replaces entire subtrees\n- Methods: `cloneInstance`, `createContainerChildSet`, `replaceContainerChildren`\n\n### Example: DOM Renderer Integration\n\n```\ncompleteWork()  createInstance()  document.createElement()\ncommitMutationEffects()  appendChild()  parentInstance.appendChild()\ncommitMutationEffects()  commitUpdate()  updateProperties()\n```\n\nThe reconciler calls high-level operations like `createInstance`; the DOM renderer translates these to `document.createElement()`, `node.appendChild()`, etc.\n\n**Sources**: [packages/react-reconciler/src/ReactFiberCompleteWork.js:105-129](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-50](), [packages/react-reconciler/src/ReactFiberCommitWork.js:154-186]()\n\n---\n\n## Reconciliation and Diffing\n\nWhen React updates a component, it reconciles the new children with the existing Fiber tree.\n\n```mermaid\ngraph TB\n    ReconcileChildren["reconcileChildren()<br/>ReactFiberBeginWork.js:341"]\n    \n    MountOrUpdate{"current === null?"}\n    \n    MountChildren["mountChildFibers()<br/>No side-effects tracking"]\n    ReconcileExisting["reconcileChildFibers()<br/>Track Placement, Deletion"]\n    \n    ChildReconciler["ChildReconciler<br/>ReactChildFiber.js"]\n    \n    SingleChild["reconcileSingleElement()<br/>Single child reconciliation"]\n    ArrayChildren["reconcileChildrenArray()<br/>List reconciliation with keys"]\n    \n    PlacementFlag["Mark Fiber with Placement flag"]\n    DeletionFlag["Add old Fiber to deletions array"]\n    UpdateFlag["Reuse existing Fiber, update props"]\n    \n    ReconcileChildren --> MountOrUpdate\n    MountOrUpdate -->|Mount| MountChildren\n    MountOrUpdate -->|Update| ReconcileExisting\n    \n    MountChildren --> ChildReconciler\n    ReconcileExisting --> ChildReconciler\n    \n    ChildReconciler --> SingleChild\n    ChildReconciler --> ArrayChildren\n    \n    SingleChild --> PlacementFlag\n    ArrayChildren --> PlacementFlag\n    ArrayChildren --> DeletionFlag\n    ArrayChildren --> UpdateFlag\n```\n\n### Array Reconciliation Algorithm\n\nWhen reconciling an array of children ([ReactChildFiber.js:800-1200]()):\n\n1. **First Pass**: Walk old and new children in parallel, matching by `key` (if provided) or `index`\n   - If `key` matches and `type` matches: reuse Fiber, update props\n   - If mismatch: break and proceed to repositioning\n\n2. **Deletions**: Remaining old children not matched are marked for deletion\n\n3. **Insertions**: Remaining new children create new Fibers with `Placement` flag\n\n4. **Key Map**: For complex reorderings, build a map of `key  Fiber` to efficiently find matches\n\nThe reconciler marks each Fiber with flags:\n- `Placement`: Needs to be inserted into DOM\n- `Update`: Props changed, needs DOM update\n- `Deletion`: Needs to be removed from DOM\n\n**Sources**: [packages/react-reconciler/src/ReactFiberBeginWork.js:341-404](), [packages/react-reconciler/src/ReactChildFiber.js:800-1200]()\n\n---\n\n## Global State and Work-in-Progress\n\nThe reconciler maintains global mutable state during rendering:\n\n```mermaid\ngraph LR\n    subgraph "Global State (ReactFiberWorkLoop.js)"\n        ExecutionContext["executionContext: ExecutionContext<br/>NoContext | RenderContext | CommitContext"]\n        WIPRoot["workInProgressRoot: FiberRoot | null"]\n        WIP["workInProgress: Fiber | null"]\n        WIPLanes["workInProgressRootRenderLanes: Lanes"]\n        WIPExitStatus["workInProgressRootExitStatus: RootExitStatus<br/>RootInProgress | RootCompleted | RootSuspended..."]\n    end\n    \n    subgraph "Current vs Work-in-Progress"\n        CurrentTree["current tree<br/>Visible on screen"]\n        WIPTree["workInProgress tree<br/>Being built"]\n        Alternate["Fibers linked via<br/>alternate pointer"]\n    end\n    \n    ExecutionContext -.-> WIPRoot\n    WIPRoot --> WIP\n    WIPRoot --> CurrentTree\n    CurrentTree --> Alternate\n    Alternate --> WIPTree\n```\n\n**Double Buffering**: React maintains two Fiber trees:\n- **Current tree**: The currently rendered tree, visible to the user\n- **Work-in-progress tree**: The tree being built during an update\n\nEach Fiber\'s `alternate` pointer links to its counterpart in the other tree. After commit, the work-in-progress tree becomes the current tree via pointer swap ([ReactFiberWorkLoop.js:2600-2650]()).\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:406-526](), [packages/react-reconciler/src/ReactFiber.js:360-480]()\n\n---\n\n## Render Exit Statuses\n\nThe render phase can exit in multiple states ([ReactFiberWorkLoop.js:413-420]()):\n\n| Status | Description |\n|--------|-------------|\n| `RootInProgress` | Render is still in progress |\n| `RootCompleted` | Render completed successfully |\n| `RootErrored` | Render hit an error |\n| `RootSuspended` | Render suspended waiting for data |\n| `RootSuspendedWithDelay` | Suspended with throttling delay |\n| `RootSuspendedAtTheShell` | Suspended during initial shell, show fallback immediately |\n| `RootFatalErrored` | Fatal error, cannot recover |\n\nThe status determines whether to commit immediately, retry, or show a Suspense fallback.\n\n---\n\n## Error Handling and Boundaries\n\nError handling propagates up the Fiber tree until an error boundary is found.\n\n```mermaid\ngraph TB\n    ThrowException["throwException()<br/>ReactFiberThrow.js"]\n    \n    FindBoundary["Find nearest Suspense or ErrorBoundary<br/>Walk up fiber.return chain"]\n    \n    Boundary{"Boundary type?"}\n    \n    ErrorBoundary["Error Boundary (ClassComponent)<br/>getDerivedStateFromError<br/>componentDidCatch"]\n    \n    SuspenseBoundary["Suspense Boundary<br/>Show fallback UI"]\n    \n    CreateUpdate["createClassErrorUpdate()<br/>Schedule re-render with error"]\n    \n    ShowFallback["Mark SuspenseComponent with<br/>DidCapture flag"]\n    \n    UnwindWork["unwindWork()<br/>ReactFiberUnwindWork.js<br/>Clean up context stacks"]\n    \n    ThrowException --> FindBoundary\n    FindBoundary --> Boundary\n    \n    Boundary -->|Error| ErrorBoundary\n    Boundary -->|Suspense| SuspenseBoundary\n    \n    ErrorBoundary --> CreateUpdate\n    SuspenseBoundary --> ShowFallback\n    \n    CreateUpdate --> UnwindWork\n    ShowFallback --> UnwindWork\n```\n\nWhen an error or promise is thrown:\n\n1. `throwException()` is called with the thrown value\n2. Walk up the tree to find an appropriate boundary\n3. For errors: call `getDerivedStateFromError` on error boundary, schedule re-render\n4. For Suspense: mark boundary with `DidCapture`, prepare to show fallback\n5. `unwindWork()` cleans up any context stacks, unwinds to the boundary\n6. Restart render from the boundary\n\n**Sources**: [packages/react-reconciler/src/ReactFiberThrow.js:400-600](), [packages/react-reconciler/src/ReactFiberUnwindWork.js:63-180](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1900-2100]()\n\n---\n\n## Concurrent Features and Interruption\n\nIn concurrent mode, the render phase can be interrupted to handle higher-priority updates.\n\n```mermaid\ngraph TB\n    WorkLoop["workLoopConcurrent()<br/>ReactFiberWorkLoop.js:1794"]\n    \n    CheckYield{"shouldYield()?<br/>Time slice expired?"}\n    \n    Continue["performUnitOfWork()<br/>Continue rendering"]\n    \n    Yield["Yield to browser<br/>Return from work loop"]\n    \n    Schedule["Schedule continuation<br/>Scheduler.scheduleCallback()"]\n    \n    HighPriorityInterrupt["High-priority update arrives<br/>prepareFreshStack()<br/>Discard WIP, restart"]\n    \n    WorkLoop --> CheckYield\n    CheckYield -->|No| Continue\n    Continue --> WorkLoop\n    \n    CheckYield -->|Yes| Yield\n    Yield --> Schedule\n    \n    Continue -.->|Update arrives| HighPriorityInterrupt\n    HighPriorityInterrupt --> WorkLoop\n```\n\n**Interruption points**:\n- Between units of work (fibers)\n- `shouldYield()` checks if time slice exhausted\n- New higher-priority updates can discard work-in-progress\n\n**Resumption**:\n- Work-in-progress state is preserved\n- Can resume from `workInProgress` fiber\n- Or restart from root for higher priority\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1776-1850](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1300-1400]()\n\n---\n\n## Component Types and Tags\n\nThe reconciler handles different component types via the `WorkTag` enum.\n\n```mermaid\ngraph TB\n    subgraph "Host Components"\n        HostRoot["HostRoot = 3<br/>Root of Fiber tree"]\n        HostComponent["HostComponent = 5<br/>DOM element (div, span)"]\n        HostText["HostText = 6<br/>Text node"]\n        HostPortal["HostPortal = 4<br/>ReactDOM.createPortal"]\n    end\n    \n    subgraph "React Components"\n        FunctionComponent["FunctionComponent = 0<br/>Function components"]\n        ClassComponent["ClassComponent = 1<br/>Class components"]\n        ForwardRef["ForwardRef = 11<br/>React.forwardRef"]\n        MemoComponent["MemoComponent = 14<br/>React.memo"]\n        SimpleMemoComponent["SimpleMemoComponent = 15<br/>Memo with simple comparison"]\n    end\n    \n    subgraph "Async Components"\n        SuspenseComponent["SuspenseComponent = 13<br/>React.Suspense"]\n        SuspenseListComponent["SuspenseListComponent = 23<br/>React.SuspenseList"]\n        OffscreenComponent["OffscreenComponent = 22<br/>Hidden content"]\n        ActivityComponent["ActivityComponent = 25<br/>React.Activity"]\n    end\n    \n    subgraph "Other"\n        Fragment["Fragment = 7<br/>React.Fragment"]\n        ContextProvider["ContextProvider = 10<br/>Context.Provider"]\n        ContextConsumer["ContextConsumer = 9<br/>Context.Consumer"]\n        Profiler["Profiler = 12<br/>React.Profiler"]\n    end\n```\n\nThe `tag` field on each Fiber determines which code path `beginWork` and `completeWork` take.\n\n**Example dispatching** ([ReactFiberBeginWork.js:3800-4100]()):\n```\nswitch (workInProgress.tag) {\n  case FunctionComponent:\n    return updateFunctionComponent(...)\n  case ClassComponent:\n    return updateClassComponent(...)\n  case HostComponent:\n    return updateHostComponent(...)\n  ...\n}\n```\n\n**Sources**: [packages/react-reconciler/src/ReactWorkTags.js:1-60](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3800-4100]()\n\n---\n\n## Context System\n\nReact Context is implemented at the reconciler level.\n\n```mermaid\ngraph TB\n    subgraph "Context Definition"\n        CreateContext["React.createContext(defaultValue)<br/>Returns Context object"]\n        ContextObject["Context = {<br/>  $$typeof: REACT_CONTEXT_TYPE<br/>  _currentValue: any<br/>  Provider: ReactProviderType<br/>  Consumer: ReactContext<br/>}"]\n    end\n    \n    subgraph "Provider in Tree"\n        ProviderFiber["Fiber with tag=ContextProvider<br/>type = Context<br/>pendingProps.value = newValue"]\n        \n        PushProvider["pushProvider()<br/>ReactFiberNewContext.js:200<br/>Push value onto stack"]\n    end\n    \n    subgraph "Consumer in Tree"\n        ConsumerFiber["Component using useContext()<br/>or Context.Consumer"]\n        \n        ReadContext["readContext(Context)<br/>ReactFiberNewContext.js:250<br/>Read from stack"]\n        \n        Dependencies["fiber.dependencies = {<br/>  lanes: Lanes<br/>  firstContext: ContextDependency<br/>}"]\n    end\n    \n    subgraph "Change Propagation"\n        ValueChange["Provider value changes"]\n        Propagate["propagateContextChange()<br/>ReactFiberNewContext.js:300<br/>Mark consumers with lanes"]\n    end\n    \n    CreateContext --> ContextObject\n    ContextObject --> ProviderFiber\n    ProviderFiber --> PushProvider\n    \n    PushProvider --> ConsumerFiber\n    ConsumerFiber --> ReadContext\n    ReadContext --> Dependencies\n    \n    ValueChange --> Propagate\n    Propagate --> ConsumerFiber\n```\n\n**Context mechanism**:\n1. **Stack-based**: Providers push values onto a stack as the tree is traversed\n2. **Dependencies**: Consuming components record a dependency in `fiber.dependencies`\n3. **Bailout prevention**: When context value changes, `propagateContextChange()` marks all consumers with update lanes, preventing bailout\n\n**Key functions**:\n- `pushProvider()` - Push new context value onto stack ([ReactFiberNewContext.js:200-250]())\n- `readContext()` - Read current context value and record dependency ([ReactFiberNewContext.js:250-350]())\n- `propagateContextChange()` - Mark consumers for update when value changes ([ReactFiberNewContext.js:400-550]())\n\n**Sources**: [packages/react-reconciler/src/ReactFiberNewContext.js:200-550](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3200-3350]()\n\n---\n\n## Scheduling Entry Points\n\nUpdates enter the reconciler through several paths:\n\n```mermaid\ngraph TB\n    subgraph "Public API Entry Points"\n        Root["root.render(element)<br/>ReactFiberReconciler.js:356"]\n        SetState["this.setState(update)<br/>classComponentUpdater"]\n        UseState["setStateFromHook<br/>from useState()"]\n        ForceUpdate["this.forceUpdate()"]\n    end\n    \n    subgraph "Update Creation"\n        CreateUpdate["createUpdate(lane)<br/>ReactFiberClassUpdateQueue.js:200"]\n        UpdatePayload["Update = {<br/>  lane: Lane<br/>  tag: UpdateState<br/>  payload: any<br/>  callback: Function | null<br/>  next: Update<br/>}"]\n    end\n    \n    subgraph "Enqueueing"\n        EnqueueUpdate["enqueueUpdate(fiber, update, lane)<br/>ReactFiberClassUpdateQueue.js:500"]\n        \n        ConcurrentUpdate["enqueueConcurrentHookUpdate()<br/>For hooks updates"]\n        \n        UpdateQueue["fiber.updateQueue<br/>Circular linked list"]\n    end\n    \n    subgraph "Scheduling"\n        ScheduleUpdate["scheduleUpdateOnFiber()<br/>ReactFiberWorkLoop.js:916"]\n        RequestLane["requestUpdateLane(fiber)<br/>Determine priority"]\n        MarkRootUpdated["markRootUpdated(root, lane)"]\n        EnsureScheduled["ensureRootIsScheduled(root)<br/>Schedule work with Scheduler"]\n    end\n    \n    Root --> CreateUpdate\n    SetState --> CreateUpdate\n    UseState --> ConcurrentUpdate\n    ForceUpdate --> CreateUpdate\n    \n    CreateUpdate --> UpdatePayload\n    UpdatePayload --> EnqueueUpdate\n    ConcurrentUpdate --> EnqueueUpdate\n    \n    EnqueueUpdate --> UpdateQueue\n    UpdateQueue --> ScheduleUpdate\n    \n    ScheduleUpdate --> RequestLane\n    ScheduleUpdate --> MarkRootUpdated\n    ScheduleUpdate --> EnsureScheduled\n```\n\n**Update lifecycle**:\n1. User calls `setState()` or `render()`\n2. Create an `Update` object with priority lane\n3. Enqueue update onto fiber\'s `updateQueue`\n4. Call `scheduleUpdateOnFiber()` with root and lane\n5. `ensureRootIsScheduled()` schedules work with Scheduler based on lanes\n\n**Sources**: [packages/react-reconciler/src/ReactFiberReconciler.js:356-461](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:916-1042](), [packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:165-243]()\n\n---\n\n## Batching and Synchronization\n\nThe reconciler batches updates to minimize renders.\n\n```mermaid\ngraph TB\n    subgraph "Batching Mechanisms"\n        ExecutionContext2["executionContext flag<br/>BatchedContext = 0b001<br/>RenderContext = 0b010<br/>CommitContext = 0b100"]\n        \n        BatchedUpdates["batchedUpdates(fn)<br/>Set BatchedContext<br/>Execute fn<br/>Clear BatchedContext"]\n        \n        FlushSync["flushSync(fn)<br/>Force synchronous render<br/>Execute fn<br/>flushSyncWork()"]\n    end\n    \n    subgraph "Update Accumulation"\n        Update1["setState() call 1"]\n        Update2["setState() call 2"]\n        Update3["setState() call 3"]\n        \n        Accumulated["All updates on same fiber<br/>merged into updateQueue"]\n    end\n    \n    subgraph "Rendering"\n        SingleRender["Single render pass<br/>processes all updates"]\n    end\n    \n    ExecutionContext2 --> BatchedUpdates\n    BatchedUpdates --> Update1\n    BatchedUpdates --> Update2\n    BatchedUpdates --> Update3\n    \n    Update1 --> Accumulated\n    Update2 --> Accumulated\n    Update3 --> Accumulated\n    \n    Accumulated --> SingleRender\n    \n    FlushSync -.->|Forces| SingleRender\n```\n\n**Automatic batching**: In React 18+, all updates are automatically batched within a single event, timeout, or promise callback. The `executionContext` prevents nested flush operations.\n\n**Manual control**:\n- `flushSync()` - Force synchronous rendering ([ReactFiberWorkLoop.js:1244-1278]())\n- `batchedUpdates()` - Explicit batching (mostly legacy) ([ReactFiberWorkLoop.js:2832-2850]())\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1244-1278](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:2832-2850]()\n\n---\n\n## Refs and Imperative Handles\n\nThe reconciler manages refs and provides imperative access to instances.\n\n```mermaid\ngraph TB\n    subgraph "Ref Types"\n        CallbackRef["Callback Ref<br/>ref={(node) => {...}}"]\n        ObjectRef["Object Ref<br/>ref={useRef()}"]\n        StringRef["String Ref (legacy)<br/>ref=\'myRef\'"]\n    end\n    \n    subgraph "Ref Attachment"\n        CommitLayoutPhase["Layout Effects Phase<br/>commitLayoutEffects()"]\n        \n        AttachRef["safelyAttachRef()<br/>ReactFiberCommitEffects.js:650"]\n        \n        SetRef["Set ref.current = instance<br/>or call ref(instance)"]\n    end\n    \n    subgraph "Ref Cleanup"\n        BeforeUpdate["Before mutation or unmount"]\n        \n        DetachRef["safelyDetachRef()<br/>ReactFiberCommitEffects.js:680"]\n        \n        ClearRef["Set ref.current = null<br/>or call ref(null)"]\n    end\n    \n    subgraph "Imperative Handle"\n        UseImperativeHandle["useImperativeHandle()<br/>Customize ref value"]\n        \n        ImperativeInstance["Custom instance object<br/>returned by callback"]\n    end\n    \n    CallbackRef --> CommitLayoutPhase\n    ObjectRef --> CommitLayoutPhase\n    StringRef --> CommitLayoutPhase\n    \n    CommitLayoutPhase --> AttachRef\n    AttachRef --> SetRef\n    \n    BeforeUpdate --> DetachRef\n    DetachRef --> ClearRef\n    \n    UseImperativeHandle --> ImperativeInstance\n    ImperativeInstance --> AttachRef\n```\n\n**Ref lifecycle**:\n1. **Detachment**: Before mutations, call `safelyDetachRef()` to clear old refs\n2. **Attachment**: In layout phase, call `safelyAttachRef()` to set new refs\n3. **Instance**: For host components, ref points to DOM node; for class components, to class instance; for function components with `useImperativeHandle`, to custom object\n\n**Sources**: [packages/react-reconciler/src/ReactFiberCommitEffects.js:650-720](), [packages/react-reconciler/src/ReactFiberHooks.js:2100-2200]()\n\n---\n\n## Profiler Integration\n\nThe reconciler integrates with React DevTools Profiler to track render times.\n\n```mermaid\ngraph TB\n    subgraph "Timing Collection"\n        ProfilerTimer["enableProfilerTimer<br/>feature flag"]\n        \n        ActualDuration["fiber.actualDuration<br/>Time spent in this render"]\n        \n        TreeBaseDuration["fiber.treeBaseDuration<br/>Total time for subtree"]\n        \n        RecordStart["startProfilerTimer()<br/>ReactProfilerTimer.js:200"]\n        \n        RecordStop["stopProfilerTimerIfRunning()<br/>ReactProfilerTimer.js:250"]\n    end\n    \n    subgraph "Profiler Component"\n        ProfilerTag["<Profiler id=\'x\' onRender={callback}>"]\n        \n        OnRenderCallback["onRender(id, phase, actualDuration,<br/>  baseDuration, startTime, commitTime)"]\n    end\n    \n    subgraph "DevTools Hook"\n        DevToolsHook["__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        \n        MarkRenderStarted["markRenderStarted(lane)"]\n        MarkRenderStopped["markRenderStopped()"]\n        OnCommitRoot["onCommitRoot(root)"]\n    end\n    \n    ProfilerTimer --> RecordStart\n    ProfilerTimer --> RecordStop\n    \n    RecordStart --> ActualDuration\n    RecordStop --> TreeBaseDuration\n    \n    ActualDuration --> ProfilerTag\n    TreeBaseDuration --> ProfilerTag\n    \n    ProfilerTag --> OnRenderCallback\n    \n    RecordStart --> MarkRenderStarted\n    RecordStop --> MarkRenderStopped\n    ActualDuration --> OnCommitRoot\n    \n    MarkRenderStarted --> DevToolsHook\n    MarkRenderStopped --> DevToolsHook\n    OnCommitRoot --> DevToolsHook\n```\n\n**Profiler mechanism**:\n- `actualDuration`: Time spent rendering this component in the current render\n- `treeBaseDuration`: Estimated time to re-render entire subtree (cached from previous render)\n- `startProfilerTimer()` / `stopProfilerTimerIfRunning()`: Record timing around component render\n- `<Profiler>` component invokes `onRender` callback with timing data after commit\n- DevTools hook receives notifications of render start/stop/commit\n\n**Sources**: [packages/react-reconciler/src/ReactProfilerTimer.js:150-350](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:720-780](), [packages/react-reconciler/src/ReactFiberDevToolsHook.js:200-350]()\n\n---\n\n## Concurrent Mode Rendering Patterns\n\n### Selective Hydration\n\nThe reconciler supports hydrating server-rendered content selectively based on user interactions.\n\n```mermaid\ngraph TB\n    HydrateRoot["hydrateRoot(container, element)"]\n    \n    Dehydrated["Dehydrated Suspense boundary<br/>Server-rendered fallback"]\n    \n    UserClick["User clicks inside boundary"]\n    \n    UpgradePriority["Upgrade hydration lane<br/>to higher priority"]\n    \n    HydrateBoundary["Hydrate clicked boundary first<br/>Before other boundaries"]\n    \n    ThrowException2["If data not ready:<br/>throw SelectiveHydrationException"]\n    \n    HydrateRoot --> Dehydrated\n    Dehydrated --> UserClick\n    UserClick --> UpgradePriority\n    UpgradePriority --> HydrateBoundary\n    HydrateBoundary --> ThrowException2\n```\n\nWhen a user interacts with a dehydrated boundary, React prioritizes hydrating that boundary to make it interactive quickly.\n\n**Sources**: [packages/react-reconciler/src/ReactFiberBeginWork.js:311-317](), [packages/react-reconciler/src/ReactFiberReconciler.js:489-520]()\n\n### Offscreen Rendering\n\n`OffscreenComponent` allows pre-rendering content that\'s not yet visible.\n\n```mermaid\ngraph TB\n    Offscreen["<Offscreen mode=\'hidden\'>"]\n    \n    Hidden["Content rendered but not visible<br/>style={{ visibility: \'hidden\' }}"]\n    \n    DeferredLane["Scheduled at OffscreenLane<br/>Low priority"]\n    \n    Visible["<Offscreen mode=\'visible\'>"]\n    \n    Reveal["Content becomes visible<br/>Re-render at higher priority"]\n    \n    Offscreen --> Hidden\n    Hidden --> DeferredLane\n    DeferredLane --> Visible\n    Visible --> Reveal\n```\n\nOffscreen components are rendered at low priority and kept in the DOM with `visibility: hidden`, then revealed instantly when needed.\n\n**Sources**: [packages/react-reconciler/src/ReactFiberBeginWork.js:613-871](), [packages/react-reconciler/src/ReactFiberOffscreenComponent.js:1-50]()\n\n---\n\n## Summary\n\nThe React Reconciler is the core reconciliation engine that:\n\n- **Manages Fiber trees**: Double-buffered trees with `current` and `workInProgress`\n- **Coordinates render phases**: Interruptible render phase, synchronous commit phase\n- **Abstracts platforms**: Delegates host operations through `ReactFiberConfig` interface\n- **Schedules work**: Priority-based scheduling using lanes and the Scheduler\n- **Handles updates**: Batches updates, processes update queues, reconciles children\n- **Supports features**: Hooks, Context, Suspense, Error Boundaries, Concurrent Rendering\n\nKey entry points:\n- `createContainer()` / `updateContainer()` - Initialize and update roots\n- `scheduleUpdateOnFiber()` - Schedule work on a fiber\n- `performWorkOnRoot()` - Execute render and commit phases\n- `beginWork()` / `completeWork()` - Walk the fiber tree\n- `commitMutationEffects()` / `commitLayoutEffects()` - Apply changes to host\n\nThe reconciler is platform-agnostic, enabling React to target DOM, Native, Canvas, and custom renderers while maintaining a single core algorithm.\n\n---\n\n# Page: Fiber Architecture and Data Structures\n\n# Fiber Architecture and Data Structures\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberOffscreenComponent.js](packages/react-reconciler/src/ReactFiberOffscreenComponent.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis page documents React\'s Fiber data structure, the FiberRoot container, the double-buffering technique using current and work-in-progress trees, and the tree traversal mechanisms using child/sibling/return pointers. These are the foundational data structures that enable React\'s incremental reconciliation.\n\nFor related topics, see:\n- Work loop execution and render/commit phases: [Work Loop and Rendering Phases](#4.2)\n- Hooks implementation: [React Hooks System](#4.3)\n- Priority scheduling: [Lane-Based Scheduling and Priorities](#4.4)\n- Error and Suspense handling: [Suspense and Error Boundaries](#4.5)\n- Host-specific operations: [Host Configuration Abstraction](#4.6)\n\n## FiberRoot: The Container\n\nThe `FiberRoot` is the container object that holds the entire fiber tree and coordinates rendering. It is created by `createFiberRoot` in [ReactFiberRoot.js:109-225]() when calling `createRoot()` or `createContainer()`.\n\n### FiberRoot Structure\n\nKey fields defined in [ReactInternalTypes.js:253-334]():\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `containerInfo` | `Container` | The host container (e.g., DOM node) |\n| `current` | `Fiber` | Pointer to the current HostRoot fiber |\n| `finishedWork` | `Fiber \\| null` | Work-in-progress root after render completes |\n| `pendingLanes` | `Lanes` | Lanes with pending work |\n| `suspendedLanes` | `Lanes` | Lanes suspended by promises |\n| `pingedLanes` | `Lanes` | Lanes that have been pinged to retry |\n| `expiredLanes` | `Lanes` | Lanes that have expired |\n| `callbackNode` | `mixed` | Scheduler callback node |\n| `callbackPriority` | `Lane` | Priority of scheduled callback |\n| `hydrationCallbacks` | `null \\| SuspenseHydrationCallbacks` | Hydration callbacks |\n| `context` | `Object \\| null` | Context object for legacy context |\n| `pendingContext` | `Object \\| null` | Pending context updates |\n\n**Diagram: FiberRoot and HostRoot Relationship**\n\n```mermaid\ngraph TB\n    ContainerDiv["containerInfo<br/>(DOM div)"]\n    FiberRoot["FiberRoot"]\n    CurrentHostRoot["current<br/>(HostRoot fiber)"]\n    WIPHostRoot["finishedWork<br/>(HostRoot fiber WIP)"]\n    \n    FiberRoot -->|"containerInfo"| ContainerDiv\n    FiberRoot -->|"current"| CurrentHostRoot\n    FiberRoot -->|"finishedWork"| WIPHostRoot\n    \n    CurrentHostRoot -->|"stateNode"| FiberRoot\n    WIPHostRoot -->|"stateNode"| FiberRoot\n    \n    CurrentHostRoot -.->|"alternate"| WIPHostRoot\n    WIPHostRoot -.->|"alternate"| CurrentHostRoot\n    \n    CurrentHostRoot -->|"child"| CurrentApp["App fiber (current)"]\n    WIPHostRoot -->|"child"| WIPApp["App fiber (WIP)"]\n```\n\nThe `HostRoot` fiber (tag = 3) is special:\n- Its `stateNode` points back to the `FiberRoot`\n- It has no React element (it\'s the root of the React tree)\n- Its `memoizedState` contains the initial element passed to `render()` [ReactInternalTypes.js:246-251]()\n\nSources: [ReactFiberRoot.js:109-225](), [ReactInternalTypes.js:253-334](), [ReactInternalTypes.js:246-251]()\n\n## The Fiber Data Structure\n\n### Fiber Node Definition\n\nA Fiber is React\'s internal unit of work, representing a component instance, DOM node, or other React element. It is a mutable JavaScript object containing all information needed for reconciliation, scheduling, and effects.\n\nThe `FiberNode` constructor is defined in [ReactFiber.js:138-211](). React provides two implementations:\n- Class-based: `createFiberImplClass` (default)\n- Object literal: `createFiberImplObject` (controlled by `enableObjectFiber` flag)\n\n### Fiber Fields by Category\n\n| Field Category | Key Fields | Purpose |\n|---------------|------------|---------|\n| **Instance Identity** | `tag`, `key`, `elementType`, `type` | Identify what this fiber represents |\n| **Instance State** | `stateNode` | Reference to component instance, DOM node, or other state |\n| **Tree Structure** | `return`, `child`, `sibling`, `index` | Form the fiber tree via pointers |\n| **Refs** | `ref`, `refCleanup` | Handle ref attachment and cleanup |\n| **Props** | `pendingProps`, `memoizedProps` | Props being processed and last rendered props |\n| **State** | `memoizedState`, `updateQueue` | Component state and pending updates |\n| **Context** | `dependencies` | Context subscriptions |\n| **Mode** | `mode` | Bitfield for ConcurrentMode, StrictMode, etc. |\n| **Effects** | `flags`, `subtreeFlags`, `deletions` | Side-effects to perform in commit phase |\n| **Scheduling** | `lanes`, `childLanes` | Work priority for this fiber and its subtree |\n| **Double Buffering** | `alternate` | Link to counterpart fiber in other tree |\n| **Profiling** | `actualDuration`, `selfBaseDuration`, etc. | Timing information (if enabled) |\n\n**Fiber Creation:**\n\nNew fibers are created by `createFiber` [ReactFiber.js:303-305]():\n```javascript\nconst createFiber = enableObjectFiber\n  ? createFiberImplObject\n  : createFiberImplClass;\n```\n\nSources: [ReactFiber.js:138-211](), [ReactFiber.js:226-305](), [ReactInternalTypes.js:89-205]()\n\n### Work Tags\n\nEach fiber\'s `tag` field identifies its type, defined in [ReactWorkTags.js:10-37]():\n\n| Tag Constant | Value | Represents |\n|--------------|-------|------------|\n| `FunctionComponent` | 0 | Function component |\n| `ClassComponent` | 1 | Class component |\n| `HostRoot` | 3 | Root of a fiber tree (container) |\n| `HostComponent` | 5 | Platform element (e.g., DOM `<div>`) |\n| `HostText` | 6 | Text node |\n| `HostPortal` | 4 | Portal to different container |\n| `Fragment` | 7 | `React.Fragment` |\n| `Mode` | 8 | StrictMode, ConcurrentMode, etc. |\n| `ContextProvider` | 10 | `Context.Provider` |\n| `ContextConsumer` | 9 | `Context.Consumer` |\n| `ForwardRef` | 11 | `React.forwardRef()` wrapper |\n| `Profiler` | 12 | `<Profiler>` component |\n| `SuspenseComponent` | 13 | `<Suspense>` boundary |\n| `MemoComponent` | 14 | `React.memo()` wrapper |\n| `SimpleMemoComponent` | 15 | Optimized memo for simple functions |\n| `LazyComponent` | 16 | `React.lazy()` wrapper |\n| `OffscreenComponent` | 22 | Hidden/deferred subtree |\n| `CacheComponent` | 24 | Cache boundary |\n| `TracingMarkerComponent` | 25 | Transition tracing marker |\n\nThe tag determines how the fiber is processed during reconciliation (in `beginWork`/`completeWork`) and what lifecycle methods or hooks it supports.\n\nSources: [ReactWorkTags.js:10-37](), [ReactFiber.js:146]()\n\n## Double Buffering: Current and Work-in-Progress Trees\n\nReact maintains two fiber trees using a technique called double buffering:\n- **Current tree**: Reflects what\'s currently rendered on screen\n- **Work-in-progress tree**: Being constructed during the render phase\n\n### The `alternate` Pointer\n\nEach fiber has an `alternate` field pointing to its counterpart in the other tree [ReactFiber.js:177]():\n\n```mermaid\ngraph LR\n    subgraph Current["Current Tree (on screen)"]\n        C_Root["HostRoot"]\n        C_App["App"]\n        C_Div["div"]\n        C_Text["\'Hello\'"]\n    end\n    \n    subgraph WorkInProgress["Work-in-Progress Tree (being built)"]\n        W_Root["HostRoot"]\n        W_App["App"]\n        W_Div["div"]\n        W_Text["\'Hello World\'"]\n    end\n    \n    C_Root <-.alternate.-> W_Root\n    C_App <-.alternate.-> W_App\n    C_Div <-.alternate.-> W_Div\n    C_Text <-.alternate.-> W_Text\n```\n\n**Diagram: Alternate Pointers Between Trees**\n\n### Creating Work-in-Progress Fibers\n\nThe `createWorkInProgress` function [ReactFiber.js:327-383]() manages fiber reuse:\n\n**On first update (alternate is null):**\n1. Creates new fiber with `createFiber()`\n2. Copies `elementType`, `type`, `stateNode` from current\n3. Sets up bidirectional `alternate` pointers\n4. Initializes with `pendingProps`\n\n**On subsequent updates (alternate exists):**\n1. Reuses existing alternate fiber\n2. Resets flags: `flags = NoFlags`, `subtreeFlags = NoFlags`\n3. Clears `deletions` array\n4. Updates `pendingProps` to new props\n5. Resets `lanes` and `childLanes`\n\n**Benefits of double buffering:**\n- Memory efficiency: reuses fiber objects across renders\n- Enables bailout optimizations by comparing to `current`\n- Allows interruption: work-in-progress can be discarded if superseded\n- Atomic updates: switch trees by updating single pointer (`FiberRoot.current`)\n\nSources: [ReactFiber.js:327-383](), [ReactFiber.js:177]()\n\n### Tree Swap on Commit\n\nAfter rendering completes successfully, the work-in-progress tree becomes current via a single pointer update in `commitRootImpl` [ReactFiberWorkLoop.js:2268-2826]():\n\n```javascript\nroot.current = finishedWork;\n```\n\nThe previous current tree becomes the new work-in-progress alternate for the next update.\n\nSources: [ReactFiberWorkLoop.js:2268-2826]()\n\n## Work Loop Architecture\n\n### Overview: `performWorkOnRoot`\n\nThe work loop orchestrates rendering and committing. The main entry point is `performWorkOnRoot` [ReactFiberWorkLoop.js:940-1089](), which:\n\n1. Prepares the work-in-progress root\n2. Executes the render phase (`renderRootSync` or `renderRootConcurrent`)\n3. If successful, executes the commit phase (`commitRoot`)\n4. Handles errors and suspensions\n5. Schedules any remaining work\n\n```mermaid\ngraph TB\n    ScheduleUpdate["scheduleUpdateOnFiber()<br/>(mark fiber with lane)"]\n    EnsureScheduled["ensureRootIsScheduled()<br/>(schedule work on root)"]\n    PerformWork["performWorkOnRoot()<br/>(process scheduled work)"]\n    \n    DetermineMode{"Sync or<br/>Concurrent?"}\n    RenderSync["renderRootSync()<br/>(uninterruptible)"]\n    RenderConcurrent["renderRootConcurrent()<br/>(can yield)"]\n    \n    WorkLoop["workLoopSync() or<br/>workLoopConcurrent()"]\n    PerformUnit["performUnitOfWork()"]\n    \n    CheckExitStatus{"Exit Status?"}\n    CommitRoot["commitRoot()<br/>(apply changes)"]\n    HandleError["Handle error/<br/>suspension"]\n    \n    ScheduleUpdate --> EnsureScheduled\n    EnsureScheduled --> PerformWork\n    PerformWork --> DetermineMode\n    \n    DetermineMode -->|"includes SyncLane"| RenderSync\n    DetermineMode -->|"concurrent lanes"| RenderConcurrent\n    \n    RenderSync --> WorkLoop\n    RenderConcurrent --> WorkLoop\n    WorkLoop --> PerformUnit\n    \n    PerformUnit --> CheckExitStatus\n    CheckExitStatus -->|"RootCompleted"| CommitRoot\n    CheckExitStatus -->|"RootErrored/<br/>RootSuspended"| HandleError\n```\n\n**Diagram: Work Loop Execution Flow**\n\nSources: [ReactFiberWorkLoop.js:940-1089](), [ReactFiberWorkLoop.js:1643-1846]()\n\n### Work Loop State Variables\n\nKey module-level state in [ReactFiberWorkLoop.js:423-496]():\n\n```javascript\nlet workInProgressRoot: FiberRoot | null = null;     // Root being rendered\nlet workInProgress: Fiber | null = null;             // Current fiber being processed\nlet workInProgressRootRenderLanes: Lanes = NoLanes; // Lanes being rendered\n\nlet workInProgressSuspendedReason: SuspendedReason = NotSuspended;\nlet workInProgressThrownValue: mixed = null;\n\nlet workInProgressRootExitStatus: RootExitStatus = RootInProgress;\n```\n\nThese variables track the current render\'s state globally within the reconciler.\n\nSources: [ReactFiberWorkLoop.js:423-496]()\n\n## The Render Phase\n\nThe render phase builds the work-in-progress tree by traversing fibers depth-first. This phase is **interruptible** in concurrent mode.\n\n### Work Loop Functions\n\nTwo variants exist [ReactFiberWorkLoop.js:1848-1856]():\n\n**Synchronous (uninterruptible):**\n```javascript\nfunction workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress);\n  }\n}\n```\n\n**Concurrent (interruptible):**\n```javascript\nfunction workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress);\n  }\n}\n```\n\nThe concurrent version checks `shouldYield()` from Scheduler to yield control back to the browser.\n\nSources: [ReactFiberWorkLoop.js:1848-1856]()\n\n### Unit of Work: `performUnitOfWork`\n\nEach iteration processes one fiber [ReactFiberWorkLoop.js:1858-1884]():\n\n```javascript\nfunction performUnitOfWork(unitOfWork: Fiber): void {\n  const current = unitOfWork.alternate;\n  \n  let next = beginWork(current, unitOfWork, renderLanes);\n  \n  unitOfWork.memoizedProps = unitOfWork.pendingProps;\n  \n  if (next === null) {\n    completeUnitOfWork(unitOfWork);\n  } else {\n    workInProgress = next;\n  }\n}\n```\n\n**Flow:**\n1. Call `beginWork` to process the fiber and generate children\n2. If `beginWork` returns a child, set it as next `workInProgress`\n3. If no child, call `completeUnitOfWork` to finish this fiber and move to sibling/parent\n\nSources: [ReactFiberWorkLoop.js:1858-1884]()\n\n### Begin Work: `beginWork`\n\nThe `beginWork` function [ReactFiberBeginWork.js:3649-4221]() is a large switch statement that processes each fiber type:\n\n```mermaid\ngraph TB\n    BeginWork["beginWork(current, workInProgress, lanes)"]\n    \n    CheckBailout{"Can bailout?<br/>(props unchanged &&<br/>no work in subtree)"}\n    BailoutPath["bailoutOnAlreadyFinishedWork()"]\n    \n    SwitchTag["Switch on workInProgress.tag"]\n    \n    FuncComp["updateFunctionComponent()<br/>(call renderWithHooks)"]\n    ClassComp["updateClassComponent()<br/>(process lifecycle, call render)"]\n    HostRoot["updateHostRoot()<br/>(process update queue)"]\n    HostComp["updateHostComponent()<br/>(no render, just reconcile)"]\n    HostText["updateHostText()<br/>(text has no children)"]\n    Suspense["updateSuspenseComponent()<br/>(check fallback/primary)"]\n    Fragment["updateFragment()<br/>(just reconcile children)"]\n    \n    ReconcileChildren["reconcileChildren()<br/>(diff algorithm)"]\n    ReturnChild["Return child<br/>(or null)"]\n    \n    BeginWork --> CheckBailout\n    CheckBailout -->|Yes| BailoutPath\n    CheckBailout -->|No| SwitchTag\n    \n    SwitchTag --> FuncComp\n    SwitchTag --> ClassComp\n    SwitchTag --> HostRoot\n    SwitchTag --> HostComp\n    SwitchTag --> HostText\n    SwitchTag --> Suspense\n    SwitchTag --> Fragment\n    \n    FuncComp --> ReconcileChildren\n    ClassComp --> ReconcileChildren\n    HostRoot --> ReconcileChildren\n    HostComp --> ReconcileChildren\n    Fragment --> ReconcileChildren\n    \n    ReconcileChildren --> ReturnChild\n    BailoutPath --> ReturnChild\n    Suspense --> ReturnChild\n    HostText --> ReturnChild\n```\n\n**Diagram: beginWork Processing Flow**\n\n#### Key Operations in `beginWork`:\n\n1. **Bailout optimization** [ReactFiberBeginWork.js:3798-3823](): If props haven\'t changed and there\'s no work scheduled in the subtree, skip processing\n\n2. **Component-specific updates**:\n   - `updateFunctionComponent` [ReactFiberBeginWork.js:1363-1434](): Calls `renderWithHooks` to execute the function\n   - `updateClassComponent` [ReactFiberBeginWork.js:1179-1298](): Processes lifecycle methods and calls `render()`\n   - `updateHostComponent` [ReactFiberBeginWork.js:1745-1791](): For DOM elements, just prepares for children reconciliation\n\n3. **Child reconciliation** [ReactFiberBeginWork.js:340-371](): Calls `reconcileChildren` which:\n   - Uses `mountChildFibers` for initial mount (no placement flags)\n   - Uses `reconcileChildFibers` for updates (tracks side-effects)\n   - Implements React\'s diffing algorithm in [ReactChildFiber.js]()\n\nSources: [ReactFiberBeginWork.js:3649-4221](), [ReactFiberBeginWork.js:340-371](), [ReactChildFiber.js]()\n\n### Complete Work: `completeWork`\n\nAfter all children are processed, `completeUnitOfWork` [ReactFiberWorkLoop.js:1886-1949]() calls `completeWork` [ReactFiberCompleteWork.js:652-1441]() to finalize the fiber.\n\n```mermaid\ngraph TB\n    CompleteWork["completeWork(current, workInProgress, lanes)"]\n    \n    SwitchTag["Switch on workInProgress.tag"]\n    \n    HostComp["HostComponent"]\n    HostText["HostText"]\n    HostRoot["HostRoot"]\n    Suspense["SuspenseComponent"]\n    ContextProv["ContextProvider"]\n    \n    CheckMount{"current === null?<br/>(initial mount)"}\n    \n    CreateInstance["createInstance()<br/>(create DOM node)"]\n    AppendChildren["appendAllChildren()<br/>(attach child DOM nodes)"]\n    FinalizeProps["finalizeInitialChildren()<br/>(set props, event listeners)"]\n    \n    UpdateCheck{"Props changed?"}\n    MarkUpdate["Mark fiber with Update flag"]\n    \n    BubbleProps["bubbleProperties()<br/>(aggregate flags/lanes from children)"]\n    ReturnNull["Return null<br/>(move to sibling/parent)"]\n    \n    CompleteWork --> SwitchTag\n    \n    SwitchTag --> HostComp\n    SwitchTag --> HostText\n    SwitchTag --> HostRoot\n    SwitchTag --> Suspense\n    SwitchTag --> ContextProv\n    \n    HostComp --> CheckMount\n    CheckMount -->|"Yes (mount)"| CreateInstance\n    CreateInstance --> AppendChildren\n    AppendChildren --> FinalizeProps\n    \n    CheckMount -->|"No (update)"| UpdateCheck\n    UpdateCheck -->|Yes| MarkUpdate\n    \n    FinalizeProps --> BubbleProps\n    MarkUpdate --> BubbleProps\n    HostText --> BubbleProps\n    HostRoot --> BubbleProps\n    Suspense --> BubbleProps\n    ContextProv --> BubbleProps\n    \n    BubbleProps --> ReturnNull\n```\n\n**Diagram: completeWork Processing Flow**\n\n#### Key Operations in `completeWork`:\n\nFor **HostComponent** (DOM elements) on mount [ReactFiberCompleteWork.js:652-1441]():\n1. `createInstance` - Creates the DOM node via host config\n2. `appendAllChildren` - Walks the fiber tree and attaches child DOM nodes\n3. `finalizeInitialChildren` - Sets initial props and event listeners\n4. Marks with Update flag if needed (e.g., autoFocus)\n\nFor **HostComponent** on update:\n1. Calls `updateHostComponent` [ReactFiberCompleteWork.js:455-540]()\n2. If old props !== new props, marks fiber with Update flag\n3. The actual prop update happens in commit phase\n\n**Property Bubbling** [ReactFiberCompleteWork.js:1443-1543]():\n- Aggregates all child `flags` into `subtreeFlags`\n- Aggregates all child `lanes` and `childLanes` into this fiber\'s `childLanes`\n- Enables efficient subtree skipping during traversal\n\nSources: [ReactFiberCompleteWork.js:652-1441](), [ReactFiberCompleteWork.js:242-346](), [ReactFiberCompleteWork.js:1443-1543]()\n\n### Traversal Pattern: Depth-First with Siblings\n\nThe work loop implements depth-first traversal with sibling processing [ReactFiberWorkLoop.js:1886-1949]():\n\n```\n1. Begin work on fiber A\n2. If A has child B, begin work on B (go deeper)\n3. If B has no child, complete work on B\n4. If B has sibling C, begin work on C\n5. If no sibling, complete parent A\n6. Continue until root is complete\n```\n\nThis ensures proper parentchildsibling ordering.\n\nSources: [ReactFiberWorkLoop.js:1886-1949]()\n\n## The Commit Phase\n\nOnce render phase completes successfully (`RootCompleted`), the commit phase applies all changes to the host environment. This phase is **uninterruptible** and **synchronous**.\n\n### Commit Phase Structure\n\nThe `commitRootImpl` function [ReactFiberWorkLoop.js:2268-2826]() orchestrates commit in three sub-phases plus passive effects:\n\n```mermaid\ngraph LR\n    Start["commitRootImpl(root, recoverableErrors, lanes)"]\n    \n    BeforeMut["Before Mutation Phase<br/>commitBeforeMutationEffects()"]\n    MutPhase["Mutation Phase<br/>commitMutationEffects()"]\n    SwapTrees["root.current = finishedWork<br/>(swap trees)"]\n    LayoutPhase["Layout Phase<br/>commitLayoutEffects()"]\n    \n    SchedulePassive["Schedule Passive Effects<br/>scheduleCallback(commitPassiveMountEffects)"]\n    \n    CleanupSync["Cleanup & schedule<br/>next work"]\n    \n    Start --> BeforeMut\n    BeforeMut --> MutPhase\n    MutPhase --> SwapTrees\n    SwapTrees --> LayoutPhase\n    LayoutPhase --> SchedulePassive\n    SchedulePassive --> CleanupSync\n```\n\n**Diagram: Commit Phase Sub-phases**\n\nSources: [ReactFiberWorkLoop.js:2268-2826]()\n\n### Before Mutation Phase\n\n`commitBeforeMutationEffects` [ReactFiberCommitWork.js:344-363]() traverses the tree and:\n\n1. Calls `getSnapshotBeforeUpdate` on class components [ReactFiberCommitWork.js:475-574]()\n2. Schedules useEffect hooks (doesn\'t run them yet)\n3. Handles view transition tracking (if enabled)\n4. Detects focus changes for `beforeActiveInstanceBlur`\n\n**Key point:** This phase reads from the DOM *before* any mutations, allowing components to capture information (e.g., scroll position).\n\nSources: [ReactFiberCommitWork.js:344-363](), [ReactFiberCommitWork.js:475-574]()\n\n### Mutation Phase\n\n`commitMutationEffects` [ReactFiberCommitWork.js:856-1097]() applies actual DOM changes:\n\n```mermaid\ngraph TB\n    MutationEffects["commitMutationEffects(root, finishedWork, lanes)"]\n    \n    RecursiveTraverse["Recursively traverse tree<br/>commitMutationEffectsOnFiber()"]\n    \n    CheckFlags["Check fiber.flags"]\n    \n    ContentReset["ContentReset:<br/>clearTextContent()"]\n    Ref["Ref:<br/>safelyDetachRef()"]\n    Visibility["Visibility:<br/>Hide/show instances"]\n    Placement["Placement:<br/>commitPlacement()"]\n    Update["Update:<br/>commitWork()"]\n    ChildDeletion["ChildDeletion:<br/>commitDeletionEffects()"]\n    \n    PlacementOps["Insert DOM node into parent<br/>via insertBefore/appendChild"]\n    UpdateOps["Update DOM properties<br/>updateProperties()"]\n    DeletionOps["Remove DOM node<br/>removeChild()"]\n    \n    MutationEffects --> RecursiveTraverse\n    RecursiveTraverse --> CheckFlags\n    \n    CheckFlags --> ContentReset\n    CheckFlags --> Ref\n    CheckFlags --> Visibility\n    CheckFlags --> Placement\n    CheckFlags --> Update\n    CheckFlags --> ChildDeletion\n    \n    Placement --> PlacementOps\n    Update --> UpdateOps\n    ChildDeletion --> DeletionOps\n```\n\n**Diagram: Mutation Phase Operations**\n\n**Key operations:**\n- **Placement** [ReactFiberCommitWork.js](): Inserts new or moved DOM nodes using `insertBefore` or `appendChild`\n- **Update** [ReactFiberCommitWork.js](): Updates properties on existing DOM nodes via `updateProperties`\n- **Deletion** [ReactFiberCommitWork.js](): Recursively unmounts components and removes DOM nodes\n- **Visibility** [ReactFiberCommitWork.js](): Hides/shows DOM nodes for Suspense/Offscreen\n\nSources: [ReactFiberCommitWork.js:856-1097](), [ReactFiberCommitHostEffects.js]()\n\n### Tree Swap\n\nBetween mutation and layout phases [ReactFiberWorkLoop.js:2268-2826]():\n\n```javascript\nroot.current = finishedWork;\n```\n\nThis swaps the work-in-progress tree to become the current tree. From this point forward, the newly committed tree represents what\'s on screen.\n\nSources: [ReactFiberWorkLoop.js:2268-2826]()\n\n### Layout Phase\n\n`commitLayoutEffects` [ReactFiberCommitWork.js:594-854]() runs immediately after DOM mutations, while browser is still processing layout:\n\n1. **Class components** [ReactFiberCommitWork.js:607-638](): \n   - Calls `componentDidMount` on mount\n   - Calls `componentDidUpdate` on update\n   - Invokes `setState` callbacks\n\n2. **Function components** [ReactFiberCommitWork.js:607-619]():\n   - Calls `useLayoutEffect` effect functions\n\n3. **Refs** [ReactFiberCommitWork.js:635-637]():\n   - Calls `safelyAttachRef` to set refs to current instances\n\n4. **Host components** [ReactFiberCommitWork.js:657-697]():\n   - Calls `commitMount` for initial mount side-effects (e.g., autoFocus)\n\n**Key point:** This phase can synchronously read layout from the DOM. `useLayoutEffect` runs here specifically to allow synchronous DOM measurements before paint.\n\nSources: [ReactFiberCommitWork.js:594-854](), [ReactFiberCommitEffects.js]()\n\n### Passive Effects Phase\n\n`commitPassiveEffects` [ReactFiberWorkLoop.js:2858-3025]() runs **asynchronously** after browser paint, scheduled via `scheduleCallback`:\n\n```javascript\nscheduleCallback(NormalSchedulerPriority, () => {\n  flushPassiveEffects();\n  return null;\n});\n```\n\n**Two passes:**\n\n1. **Unmount effects** [ReactFiberCommitWork.js:2446-2593]():\n   - Calls cleanup functions from previous `useEffect` hooks\n   - Invokes `componentWillUnmount` on unmounted class components\n\n2. **Mount effects** [ReactFiberCommitWork.js:2595-2774]():\n   - Calls effect functions from current `useEffect` hooks\n\n**Key characteristics:**\n- Runs after paint (non-blocking)\n- Lower priority than layout effects\n- Ideal for side-effects that don\'t need synchronous DOM access (data fetching, subscriptions)\n\nSources: [ReactFiberWorkLoop.js:2858-3025](), [ReactFiberCommitWork.js:2446-2774]()\n\n## Error Handling and Suspension\n\n### Unwinding on Errors/Suspensions\n\nWhen `beginWork` or other code throws during render, React unwinds the stack using `unwindWork` [ReactFiberUnwindWork.js:66-235]():\n\n1. Walks back up the tree via `return` pointers\n2. Pops context stacks to maintain consistency\n3. Looks for error boundaries (`ClassComponent` with `getDerivedStateFromError` or `componentDidCatch`)\n4. Looks for Suspense boundaries (`SuspenseComponent`)\n5. Marks boundary with `ShouldCapture` flag\n\n```javascript\n// Simplified unwinding logic\nfunction unwindWork(current, workInProgress, renderLanes) {\n  switch (workInProgress.tag) {\n    case ClassComponent:\n      if (flags & ShouldCapture) {\n        workInProgress.flags = (flags & ~ShouldCapture) | DidCapture;\n        return workInProgress; // Re-render this boundary\n      }\n      return null;\n    \n    case SuspenseComponent:\n      if (flags & ShouldCapture) {\n        workInProgress.flags = (flags & ~ShouldCapture) | DidCapture;\n        return workInProgress; // Show fallback\n      }\n      return null;\n    \n    // ... other cases pop context\n  }\n}\n```\n\nSources: [ReactFiberUnwindWork.js:66-235]()\n\n### Handling Thrown Values\n\n`throwException` [ReactFiberThrow.js]() processes different types of thrown values:\n\n**Promises (Suspense):**\n- Attaches ping listener to the promise\n- Finds nearest Suspense boundary\n- Marks boundary to show fallback\n\n**Errors:**\n- Finds nearest error boundary\n- Creates error update with `getDerivedStateFromError` or `componentDidCatch`\n- Schedules re-render of boundary\n\n**Special values:**\n- `SelectiveHydrationException`: Signals need to interrupt current render for hydration\n\nSources: [ReactFiberThrow.js]()\n\n### Suspended Work Tracking\n\nWhen work suspends [ReactFiberWorkLoop.js:1987-2134]():\n\n```javascript\nworkInProgressSuspendedReason = SuspendedOnData;\nworkInProgressThrownValue = thrownValue;\n```\n\nThe work loop checks this state and:\n- Attempts to unwind to a Suspense boundary\n- May continue rendering siblings to "pre-warm" them\n- Marks lanes for retry when promise resolves\n\nSources: [ReactFiberWorkLoop.js:1987-2134]()\n\n## Integration with Scheduler\n\n### Scheduling Root Work\n\n`ensureRootIsScheduled` [ReactFiberRootScheduler.js:185-403]() is called after updates are enqueued:\n\n1. Determines next lanes to process via `getNextLanes`\n2. Calculates Scheduler priority from lane priority via `lanesToEventPriority`\n3. Schedules callback:\n   - **Sync lanes**: Uses microtask or immediate callback\n   - **Concurrent lanes**: Uses `Scheduler_scheduleCallback` with appropriate priority\n\n```javascript\nconst schedulerPriorityLevel = lanesToEventPriority(nextLanes);\nconst newCallbackNode = scheduleCallback(\n  schedulerPriorityLevel,\n  performWorkOnRoot.bind(null, root)\n);\n```\n\nSources: [ReactFiberRootScheduler.js:185-403]()\n\n### Yielding to Browser\n\nIn concurrent mode, `workLoopConcurrent` [ReactFiberWorkLoop.js:1851-1856]() checks `shouldYield()` from Scheduler:\n\n```javascript\nfunction workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress);\n  }\n}\n```\n\nIf `shouldYield()` returns true:\n- Work loop exits\n- Current render state is preserved in module variables\n- Scheduler callback is re-scheduled\n- When callback runs again, rendering resumes from `workInProgress`\n\nThis enables:\n- Responding to higher-priority user input\n- Keeping frame rate high during complex renders\n- Time-slicing long operations\n\nSources: [ReactFiberWorkLoop.js:1851-1856](), [Scheduler.js]()\n\n### Priority Mapping\n\nLane priorities map to Scheduler priorities [ReactEventPriorities.js]():\n\n| React Lane | Scheduler Priority |\n|------------|-------------------|\n| `SyncLane` | `ImmediatePriority` |\n| `InputContinuousLane` | `UserBlockingPriority` |\n| `DefaultLane` | `NormalPriority` |\n| `TransitionLanes` | `NormalPriority` |\n| `RetryLanes` | `NormalPriority` |\n| `IdleLane` | `IdlePriority` |\n\nSources: [ReactEventPriorities.js](), [ReactFiberLane.js]()\n\n## Profiling and Performance Tracking\n\n### Profiler Timing\n\nWhen `enableProfilerTimer` is enabled, each fiber tracks timing information [ReactFiber.js:179-197]():\n\n```javascript\nfiber.actualDuration = -0;        // Time spent rendering this update\nfiber.actualStartTime = -1.1;     // When rendering started\nfiber.selfBaseDuration = -0;      // Base time excluding children\nfiber.treeBaseDuration = -0;      // Base time including children\n```\n\nThese are updated during:\n- `performUnitOfWork` starts the timer\n- `completeWork` stops and accumulates duration\n- Child durations are subtracted to compute self time\n\nThe `Profiler` component [ReactFiberBeginWork.js:1136-1177]() uses these to report render times via the `onRender` callback.\n\nSources: [ReactFiber.js:179-197](), [ReactProfilerTimer.js]()\n\n### Performance Track Logging\n\n`ReactFiberPerformanceTrack` [ReactFiberPerformanceTrack.js]() logs performance events to browser DevTools Performance panel:\n\n**Component tracks:**\n- `logComponentRender` logs individual component render times with color-coded severity\n- `logComponentMount/Unmount` logs lifecycle events\n- Tracks props changes and deep equality warnings\n\n**Lane tracks:**\n- Separate tracks for Blocking, Gesture, Transition, Suspense, Idle\n- Shows update propagation and priority changes\n- Visualizes which updates triggered renders\n\n**Event tracking:**\n- Correlates user events with resulting updates\n- Tracks cascading updates (updates triggered during render)\n- Measures time from event to commit\n\nSources: [ReactFiberPerformanceTrack.js:221-450]()\n\n## Summary\n\nThe Fiber architecture and work loop provide React\'s reconciliation mechanism with these key characteristics:\n\n**Fiber Structure:**\n- Mutable plain objects forming a linked tree\n- Double-buffered (current  work-in-progress)\n- Tracks props, state, effects, and scheduling information\n\n**Work Loop:**\n- Depth-first traversal via `performUnitOfWork`\n- **Render phase** (interruptible): `beginWork`  `completeWork`\n- **Commit phase** (uninterruptible): before-mutation  mutation  layout  passive\n\n**Key Capabilities:**\n- Incremental rendering with yielding to browser\n- Priority-based scheduling via lanes\n- Efficient bailout and memoization\n- Error boundaries and Suspense\n- Profiling and performance tracking\n\nThis architecture enables React to:\n- Keep UIs responsive during complex updates\n- Prioritize user interactions over background work\n- Gracefully handle async operations and errors\n- Provide detailed performance insights\n\nSources: [ReactFiberWorkLoop.js](), [ReactFiberBeginWork.js](), [ReactFiberCompleteWork.js](), [ReactFiberCommitWork.js](), [ReactFiber.js](), [ReactProfilerTimer.js](), [ReactFiberPerformanceTrack.js]()\n\n---\n\n# Page: Work Loop and Rendering Phases\n\n# Work Loop and Rendering Phases\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\nThis document describes the reconciler\'s work loop execution and the three phases of processing the Fiber tree: **begin work**, **complete work**, and **commit work**. The work loop is the core mechanism that processes fibers, determines what changed, and applies updates to the host environment.\n\nFor information about the Fiber data structure itself, see [Fiber Architecture and Data Structures](#4.1). For details on scheduling and priority management, see [Lane-Based Scheduling and Priorities](#4.4). For the commit phase effects system, see [React Hooks System](#4.3).\n\n## Overview\n\nThe work loop is implemented in [packages/react-reconciler/src/ReactFiberWorkLoop.js](). It orchestrates two distinct phases:\n\n| Phase | Purpose | Can be interrupted? |\n|-------|---------|-------------------|\n| **Render Phase** | Traverse the Fiber tree, compute changes, and mark effects | Yes (in concurrent mode) |\n| **Commit Phase** | Apply computed changes to the host environment | No (synchronous) |\n\nThe render phase processes fibers through two sub-phases: `beginWork` and `completeWork`. The commit phase executes through three sub-phases: `commitBeforeMutationEffects`, `commitMutationEffects`, and `commitLayoutEffects`.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1-3000]()\n\n## Work Loop Execution\n\n### Entry Points and Root Processing\n\nWork on a root begins through one of two main entry points:\n\n```\nperformSyncWorkOnRoot(root)      // Synchronous, uninterruptible\nperformConcurrentWorkOnRoot(root) // Concurrent, can yield\n```\n\nBoth functions follow this pattern:\n1. Prepare the work-in-progress root and lanes\n2. Enter the render phase (`renderRootSync` or `renderRootConcurrent`)\n3. If render completes successfully, enter commit phase (`commitRoot`)\n\n**Render Phase Entry:**\n\n```mermaid\ngraph TB\n    scheduleUpdateOnFiber["scheduleUpdateOnFiber(root, fiber, lane)"]\n    ensureRoot["ensureRootIsScheduled(root)"]\n    performSync["performSyncWorkOnRoot(root)"]\n    performConcurrent["performConcurrentWorkOnRoot(root)"]\n    \n    scheduleUpdateOnFiber --> ensureRoot\n    ensureRoot -->|"SyncLane"| performSync\n    ensureRoot -->|"other lanes"| performConcurrent\n    \n    performSync --> renderRootSync["renderRootSync(root, lanes)"]\n    performConcurrent --> renderRootConcurrent["renderRootConcurrent(root, lanes)"]\n    \n    renderRootSync --> prepareFresh["prepareFreshStack(root, lanes)<br/>Creates workInProgress tree"]\n    renderRootConcurrent --> prepareFresh\n    \n    prepareFresh --> setContext["executionContext |= RenderContext"]\n    setContext --> workLoopSync["workLoopSync()"]\n    setContext --> workLoopConcurrent["workLoopConcurrent()"]\n    \n    workLoopSync --> exitRender["exitStatus = RootCompleted/RootErrored/etc"]\n    workLoopConcurrent --> exitRender\n```\n\nThe `prepareFreshStack` function creates the work-in-progress tree by calling `createWorkInProgress(root.current, null)`, which either reuses the existing alternate fiber or creates a new one.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:966-1092](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1116-1300]()\n\n### The Work Loops\n\nThe actual work loop is remarkably simple:\n\n```javascript\n// Synchronous mode - never yields\nfunction workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress);\n  }\n}\n\n// Concurrent mode - yields when shouldYield() returns true\nfunction workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress);\n  }\n}\n```\n\nThe `workInProgress` variable points to the current Fiber being processed. `performUnitOfWork` processes one unit of work and advances to the next fiber.\n\nThe `shouldYield()` function is imported from the Scheduler package and checks if the current time slice has expired. In concurrent mode, React will pause work and return control to the browser if `shouldYield()` returns true, allowing the browser to handle higher-priority work like user input.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1801-1812](), [packages/react-reconciler/src/Scheduler.js:70-76]()\n\n### Work Loop State Variables\n\nThe work loop maintains several module-level variables that track the current state:\n\n| Variable | Type | Purpose |\n|----------|------|---------|\n| `workInProgressRoot` | `FiberRoot \\| null` | The root currently being worked on |\n| `workInProgress` | `Fiber \\| null` | The fiber currently being processed |\n| `workInProgressRootRenderLanes` | `Lanes` | The lanes being rendered |\n| `workInProgressSuspendedReason` | `SuspendedReason` | Why work is suspended (0-9: NotSuspended, SuspendedOnError, SuspendedOnData, etc.) |\n| `workInProgressRootExitStatus` | `RootExitStatus` | Final status: RootInProgress, RootCompleted, RootErrored, RootSuspended, etc. |\n| `workInProgressThrownValue` | `mixed` | The value that was thrown (promise, error, etc.) |\n| `executionContext` | `ExecutionContext` | Bitmask tracking current context: NoContext, RenderContext, CommitContext |\n\nThe `executionContext` variable tracks what phase React is currently executing:\n\n```javascript\nconst NoContext = 0b000;\nconst RenderContext = 0b010;  // Currently in render phase\nconst CommitContext = 0b100;  // Currently in commit phase\n```\n\nThis prevents re-entrant updates and helps detect improper usage patterns.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:418-458]()\n\n## Render Phase: Begin Work and Complete Work\n\nThe render phase processes the Fiber tree in a depth-first traversal, calling `beginWork` on the way down and `completeWork` on the way up.\n\n### performUnitOfWork Flow\n\n```mermaid\ngraph TB\n    start["performUnitOfWork(unitOfWork)"]\n    begin["next = beginWork(current, unitOfWork, lanes)"]\n    hasNext{"next !== null?"}\n    complete["completeUnitOfWork(unitOfWork)"]\n    advance["workInProgress = next"]\n    \n    start --> begin\n    begin --> hasNext\n    hasNext -->|"Yes (has child)"| advance\n    hasNext -->|"No (no child)"| complete\n    advance --> return["return to workLoop"]\n    complete --> return\n```\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1814-1848]()\n\n### Begin Work Phase\n\nThe `beginWork` function in [packages/react-reconciler/src/ReactFiberBeginWork.js]() is responsible for:\n\n1. Determining if the fiber\'s work can be skipped (bailout optimization)\n2. Creating or updating child fibers based on the fiber\'s tag\n3. Returning the first child fiber to process next\n\n**Begin Work Dispatch by Fiber Tag:**\n\n```mermaid\ngraph TB\n    beginWork["beginWork(current, workInProgress, renderLanes)"]\n    \n    checkBailout{"Can bailout?"}\n    bailout["bailoutOnAlreadyFinishedWork()"]\n    \n    beginWork --> checkBailout\n    checkBailout -->|"Yes"| bailout\n    \n    checkBailout -->|"No"| switch{"workInProgress.tag"}\n    \n    switch -->|"FunctionComponent"| updateFunction["updateFunctionComponent()"]\n    switch -->|"ClassComponent"| updateClass["updateClassComponent()"]\n    switch -->|"HostComponent"| updateHost["updateHostComponent()"]\n    switch -->|"HostRoot"| updateRoot["updateHostRoot()"]\n    switch -->|"SuspenseComponent"| updateSuspense["updateSuspenseComponent()"]\n    switch -->|"OffscreenComponent"| updateOffscreen["updateOffscreenComponent()"]\n    \n    updateFunction --> reconcile["reconcileChildren()"]\n    updateClass --> reconcile\n    updateHost --> reconcile\n    updateRoot --> reconcile\n    updateSuspense --> reconcile\n    updateOffscreen --> reconcile\n    \n    reconcile --> returnChild["return workInProgress.child"]\n```\n\n**Key Begin Work Functions:**\n\n| Function | Fiber Tag | Responsibility |\n|----------|-----------|----------------|\n| `updateFunctionComponent` | FunctionComponent, ForwardRef, SimpleMemoComponent | Calls `renderWithHooks` to execute function body and hooks |\n| `updateClassComponent` | ClassComponent | Processes lifecycle: `componentWillMount`, `getDerivedStateFromProps`, `render`, etc. |\n| `updateHostComponent` | HostComponent | Processes DOM elements (div, span, etc.), marks props updates |\n| `updateHostRoot` | HostRoot | Processes root container, applies context updates |\n| `updateSuspenseComponent` | SuspenseComponent | Manages fallback vs primary content based on suspension state |\n| `updateOffscreenComponent` | OffscreenComponent | Handles hidden subtrees and prerendering |\n| `reconcileChildren` | (all) | Core diffing algorithm - reconciles current children with new children |\n\nThe `bailoutOnAlreadyFinishedWork` function is called when a component can skip re-rendering. It checks if `workInProgress.lanes` and `renderLanes` have no overlap, and if so, clones the children without doing any work.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberBeginWork.js:3746-4016](), [packages/react-reconciler/src/ReactFiberBeginWork.js:340-371](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3569-3633]()\n\n### Complete Work Phase\n\nWhen `beginWork` returns `null` (no more children to process), `completeUnitOfWork` is called. This function:\n\n1. Calls `completeWork` on the current fiber\n2. Collects subtree flags by bubbling them up\n3. Moves to the next sibling or returns to the parent\n\n**Complete Unit of Work Flow:**\n\n```mermaid\ngraph TB\n    start["completeUnitOfWork(unitOfWork)"]\n    loop["Loop: completedWork = unitOfWork"]\n    complete["completeWork(current, completedWork, lanes)"]\n    hasFlags{"completedWork.flags & Incomplete?"}\n    unwind["unwindWork() - handle errors"]\n    \n    start --> loop\n    loop --> complete\n    complete --> hasFlags\n    \n    hasFlags -->|"Yes (error)"| unwind\n    hasFlags -->|"No (success)"| bubble["bubbleProperties(completedWork)<br/>Aggregate child flags"]\n    \n    bubble --> resetLanes["Reset completedWork.lanes = NoLanes"]\n    resetLanes --> hasSibling{"completedWork.sibling !== null?"}\n    \n    hasSibling -->|"Yes"| returnSibling["workInProgress = sibling<br/>Return to performUnitOfWork"]\n    hasSibling -->|"No"| moveParent["completedWork = completedWork.return"]\n    \n    moveParent --> atRoot{"completedWork === null?"}\n    atRoot -->|"Yes (at root)"| exit["workInProgress = null<br/>Render phase complete"]\n    atRoot -->|"No"| loop\n```\n\nDuring `completeUnitOfWork`, if the `Incomplete` flag is set, it indicates an error or suspension occurred. The function then calls `unwindWork` to clean up context stacks and find an error boundary or suspense boundary.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1850-1980]()\n\nThe `completeWork` function in [packages/react-reconciler/src/ReactFiberCompleteWork.js]() handles:\n\n- Creating host instances (DOM nodes) for new HostComponents\n- Updating props that changed\n- Marking Update flags when work is needed\n- Handling hydration for server-rendered content\n\n**Key Complete Work Responsibilities:**\n\n| Fiber Tag | Complete Work Action |\n|-----------|---------------------|\n| HostComponent | Create DOM node, append children, finalize props |\n| HostText | Create text node |\n| HostRoot | Finalize container if using persistence mode |\n| SuspenseComponent | Determine if showing fallback or primary content |\n| OffscreenComponent | Handle visibility transitions |\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1850-1980](), [packages/react-reconciler/src/ReactFiberCompleteWork.js:845-1400]()\n\n### Flags and Subtree Flags\n\nDuring the render phase, fibers are marked with **flags** indicating what effects need to be applied during commit. The `bubbleProperties` function propagates these flags up the tree:\n\n```javascript\nfunction bubbleProperties(completedWork) {\n  let subtreeFlags = NoFlags;\n  let child = completedWork.child;\n  \n  // Collect flags from all children\n  while (child !== null) {\n    subtreeFlags |= child.subtreeFlags;\n    subtreeFlags |= child.flags;\n    child = child.sibling;\n  }\n  \n  completedWork.subtreeFlags = subtreeFlags;\n}\n```\n\nThis allows ancestor fibers to know if any descendant has effects, enabling efficient traversal during commit.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCompleteWork.js:662-724]()\n\n## Commit Phase\n\nOnce the render phase completes successfully (`workInProgressRootExitStatus === RootCompleted`), the commit phase begins. The commit phase is **synchronous and uninterruptible** - it must complete once started.\n\n### Commit Root Entry\n\n```mermaid\ngraph TB\n    renderComplete["renderRoot completes successfully"]\n    finishConcurrent["finishQueueingConcurrentUpdates()"]\n    commitRoot["commitRoot(root, recoverableErrors, transitions)"]\n    \n    renderComplete --> finishConcurrent\n    finishConcurrent --> commitRoot\n    \n    commitRoot --> commitImpl["commitRootImpl(root, recoverableErrors, transitions, renderPriorityLevel)"]\n    \n    commitImpl --> beforeMutation["commitBeforeMutationEffects(root, finishedWork)"]\n    commitImpl --> mutation["commitMutationEffects(root, finishedWork, lanes)"]\n    commitImpl --> layout["commitLayoutEffects(finishedWork, root, lanes)"]\n```\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:2210-2350]()\n\n### Commit Sub-Phases\n\nThe commit phase executes in three sequential sub-phases:\n\n#### 1. Before Mutation Phase\n\n**Purpose:** Run effects that read the DOM before mutations occur\n\n**Key Function:** `commitBeforeMutationEffects(root, firstChild, committedLanes)`\n\nThis phase traverses the tree and for each fiber:\n\n| Fiber Tag | Action |\n|-----------|--------|\n| ClassComponent | Calls `instance.getSnapshotBeforeUpdate(prevProps, prevState)` |\n| HostRoot | Clears container if needed |\n| FunctionComponent | Updates ref.impl for `useImperativeHandle` |\n\nThe traversal pattern uses `nextEffect` pointer and processes:\n1. Deletions array on each fiber\n2. The fiber itself via `commitBeforeMutationEffectsOnFiber`\n3. Children recursively\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:343-362](), [packages/react-reconciler/src/ReactFiberCommitWork.js:474-569]()\n\n#### 2. Mutation Phase\n\n**Purpose:** Apply all DOM mutations (insertions, updates, deletions)\n\n**Key Function:** `commitMutationEffects(root, finishedWork, committedLanes)`\n\nThis is where the actual DOM changes occur:\n\n| Operation | Function | What It Does |\n|-----------|----------|--------------|\n| Insert/Move | `commitPlacement(finishedWork)` | Inserts fiber\'s host instance into parent using `insertBefore` or `appendChild` |\n| Update | `commitUpdate(instance, updatePayload, type, oldProps, newProps)` | Updates DOM properties using `updateProperties` |\n| Delete | `commitDeletion(root, deletion)` | Recursively unmounts subtree and removes from DOM |\n| Text Update | `commitTextUpdate(textInstance, oldText, newText)` | Updates text node\'s `nodeValue` |\n| Ref Update | `safelyDetachRef(fiber)` / `safelyAttachRef(fiber)` | Detaches old refs, attaches new ones |\n\n**Critical Moment:** After mutations complete, the tree switch occurs:\n\n```javascript\nroot.current = finishedWork;\n```\n\nThe work-in-progress tree becomes the current tree. From this point, the new tree is "live."\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:1817-1900](), [packages/react-reconciler/src/ReactFiberCommitHostEffects.js:250-485](), [packages/react-reconciler/src/ReactFiberCommitHostEffects.js:132-150]()\n\n#### 3. Layout Phase\n\n**Purpose:** Run effects that need to read the updated DOM layout\n\n**Key Function:** `commitLayoutEffects(finishedRoot, finishedWork, committedLanes)`\n\nThis phase runs synchronously after mutations and calls:\n\n| Fiber Tag | Lifecycle Methods Called |\n|-----------|-------------------------|\n| ClassComponent | `componentDidMount()` or `componentDidUpdate(prevProps, prevState, snapshot)` |\n| FunctionComponent | Layout effects from `useLayoutEffect(() => { ... })` |\n| HostRoot | Root-level callbacks if any |\n| Profiler | `onRender(id, phase, actualDuration, ...)` |\n\nThe layout effect execution order:\n1. Traverse tree depth-first\n2. Call `commitHookLayoutEffects(fiber, HookLayout | HookHasEffect)` for function components\n3. Call `commitClassLayoutLifecycles(fiber, current)` for class components\n4. Attach refs via `safelyAttachRef(fiber, fiber.return)`\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:590-800](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:1-150]()\n\n**Commit Phase Timeline:**\n\n```mermaid\ngraph LR\n    start["Commit Begins"]\n    before["Before Mutation<br/>getSnapshotBeforeUpdate"]\n    switch["Switch Trees<br/>root.current = finishedWork"]\n    mutation["Mutation<br/>Apply DOM changes"]\n    layout["Layout<br/>componentDidMount<br/>useLayoutEffect"]\n    passive["Passive Effects<br/>useEffect<br/>(scheduled async)"]\n    \n    start --> before\n    before --> mutation\n    mutation --> switch\n    switch --> layout\n    layout --> passive\n```\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:2510-2900]()\n\n### Passive Effects (useEffect)\n\nUnlike layout effects which run synchronously during commit, passive effects (from `useEffect`) are scheduled to run **after** the commit phase completes. They run in a separate task:\n\n**Passive Effect Scheduling Flow:**\n\n```mermaid\ngraph TB\n    beforeMut["Before Mutation Phase"]\n    detectPassive["Detect fibers with PassiveMask flag"]\n    scheduleCallback["scheduleCallback(NormalPriority, flushPassiveEffects)"]\n    \n    beforeMut --> detectPassive\n    detectPassive --> scheduleCallback\n    \n    layoutDone["Layout Phase Complete"]\n    layoutDone --> yieldToBrowser["Yield to browser"]\n    \n    yieldToBrowser --> passiveTask["Scheduler picks up passive effects task"]\n    passiveTask --> flushPassive["flushPassiveEffects()"]\n    \n    flushPassive --> unmount["commitPassiveUnmountEffects(root, finishedWork)<br/>Run cleanup functions"]\n    unmount --> mount["commitPassiveMountEffects(root, finishedWork)<br/>Run effect create functions"]\n```\n\n**Key Functions:**\n\n- `commitPassiveUnmountEffects`: Walks tree and calls `destroy()` functions from previous render\n- `commitPassiveMountEffects`: Walks tree and calls effect `create()` functions, storing returned cleanup\n- `commitHookPassiveUnmountEffects(fiber, HookPassive | HookHasEffect)`: Processes individual hook effects\n- `commitHookPassiveMountEffects(fiber, HookPassive | HookHasEffect)`: Runs effect callbacks\n\nThe separation allows the browser to paint before running effects, improving perceived performance.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:2300-2500](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:150-300]()\n\n## Error Handling and Suspension\n\n### Suspended Render\n\nIf during `beginWork` a component throws a promise (Suspense) or encounters an error, the work loop enters a suspended state:\n\n```mermaid\ngraph TB\n    beginWork["beginWork throws"]\n    caught["try/catch in performUnitOfWork or workLoopConcurrent"]\n    handleThrow["handleThrow(root, thrownValue)"]\n    \n    beginWork --> caught\n    caught --> handleThrow\n    \n    handleThrow --> classify{"Classify thrown value"}\n    \n    classify -->|"SuspenseException"| suspendedOnData["workInProgressSuspendedReason = SuspendedOnData"]\n    classify -->|"Error object"| suspendedOnError["workInProgressSuspendedReason = SuspendedOnError"]\n    classify -->|"SuspenseActionException"| suspendedOnAction["workInProgressSuspendedReason = SuspendedOnAction"]\n    classify -->|"Wakeable/Promise"| suspendedOnImmediate["workInProgressSuspendedReason = SuspendedOnImmediate"]\n    \n    suspendedOnData --> throwException["throwException(root, errorInfo, lane)"]\n    suspendedOnError --> throwException\n    suspendedOnAction --> throwException\n    suspendedOnImmediate --> throwException\n    \n    throwException --> getSuspense["getSuspenseHandler() - find nearest Suspense boundary"]\n    getSuspense --> markCapture["boundary.flags |= ShouldCapture"]\n    markCapture --> attachPing["Attach ping listener to promise"]\n    attachPing --> unwind["Begin unwinding: unwindUnitOfWork()"]\n```\n\n**Key Suspension Reasons (workInProgressSuspendedReason):**\n\n| Reason | Value | Triggered By |\n|--------|-------|--------------|\n| NotSuspended | 0 | Normal execution |\n| SuspendedOnError | 1 | Error thrown during render |\n| SuspendedOnData | 2 | Promise thrown from `use(promise)` or legacy Suspense |\n| SuspendedOnImmediate | 3 | Promise without fallback |\n| SuspendedOnAction | 9 | Server Action suspended |\n\nWhen a promise is thrown, React:\n1. Finds the nearest Suspense boundary via `getSuspenseHandler()`\n2. Marks it with `ShouldCapture` flag\n3. Attaches a ping listener that will schedule a retry when the promise resolves\n4. Unwinds the stack to the boundary\n5. Re-renders from the boundary, this time rendering the fallback\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1610-1800](), [packages/react-reconciler/src/ReactFiberThrow.js:200-600](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:441-451]()\n\n### Unwind Work\n\nWhen unwinding due to an error or suspension, `unwindWork` is called on each fiber to clean up:\n\n**Unwind Work By Fiber Tag:**\n\n| Fiber Tag | Cleanup Actions |\n|-----------|----------------|\n| ClassComponent | `popLegacyContext(workInProgress)` if context provider |\n| HostRoot | `popHostContainer`, `popTopLevelLegacyContextObject`, `popRootTransition`, `popCacheProvider` |\n| HostComponent | `popHostContext(workInProgress)` |\n| SuspenseComponent | `popSuspenseHandler(workInProgress)` |\n| OffscreenComponent | `popHiddenContext`, `popSuspenseHandler` |\n| CacheComponent | `popCacheProvider` |\n\nIf the fiber has the `ShouldCapture` flag, `unwindWork` converts it to `DidCapture` and returns the fiber, telling the work loop to re-render from this point (for error boundaries and Suspense boundaries).\n\nThe function `unwindInterruptedWork` is similar but used when work is interrupted (e.g., higher priority update arrives), and doesn\'t handle error capture.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberUnwindWork.js:66-200]()\n\n## Complete Work Loop Diagram\n\n```mermaid\ngraph TB\n    update["State update or initial render"]\n    schedule["scheduleUpdateOnFiber(root, fiber, lane)"]\n    ensureScheduled["ensureRootIsScheduled(root)"]\n    \n    update --> schedule\n    schedule --> ensureScheduled\n    \n    ensureScheduled --> performRoot["performSyncWorkOnRoot or<br/>performConcurrentWorkOnRoot"]\n    \n    performRoot --> prepareStack["prepareFreshStack(root, lanes)<br/>Create workInProgress tree"]\n    \n    prepareStack --> workLoop["workLoopSync() or<br/>workLoopConcurrent()"]\n    \n    workLoop --> performUnit["performUnitOfWork(workInProgress)"]\n    \n    performUnit --> beginPhase["beginWork(current, workInProgress, lanes)"]\n    \n    beginPhase --> hasChild{"Returns child?"}\n    \n    hasChild -->|"Yes"| nextFiber["workInProgress = child<br/>Continue loop"]\n    hasChild -->|"No"| completePhase["completeUnitOfWork(workInProgress)"]\n    \n    completePhase --> completeWork["completeWork(current, completedWork, lanes)"]\n    \n    completeWork --> hasSibling{"Has sibling?"}\n    \n    hasSibling -->|"Yes"| nextSibling["workInProgress = sibling<br/>Continue loop"]\n    hasSibling -->|"No"| parent["Move to parent"]\n    \n    parent --> atRoot{"At root?"}\n    atRoot -->|"No"| completeWork\n    atRoot -->|"Yes"| checkStatus{"Exit status?"}\n    \n    checkStatus -->|"RootCompleted"| commitPhase["Commit Phase"]\n    checkStatus -->|"RootSuspended"| scheduleRetry["Schedule retry"]\n    checkStatus -->|"RootErrored"| handleError["Handle error"]\n    \n    commitPhase --> beforeMutation["Before Mutation Sub-Phase"]\n    beforeMutation --> mutationPhase["Mutation Sub-Phase"]\n    mutationPhase --> switchCurrent["root.current = finishedWork"]\n    switchCurrent --> layoutPhase["Layout Sub-Phase"]\n    layoutPhase --> schedulePassive["Schedule Passive Effects"]\n    schedulePassive --> done["Commit Complete"]\n    \n    nextFiber --> performUnit\n    nextSibling --> performUnit\n```\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:400-3000](), [packages/react-reconciler/src/ReactFiberBeginWork.js:1-4000](), [packages/react-reconciler/src/ReactFiberCompleteWork.js:1-1400](), [packages/react-reconciler/src/ReactFiberCommitWork.js:1-3500]()\n\n---\n\n# Page: React Hooks System\n\n# React Hooks System\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-debug-tools/src/ReactDebugHooks.js](packages/react-debug-tools/src/ReactDebugHooks.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspection-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspection-test.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegration-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegration-test.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegrationDOM-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegrationDOM-test.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/CustomHooks.js](packages/react-devtools-shell/src/app/InspectableElements/CustomHooks.js)\n- [packages/react-reconciler/src/ReactFiberHooks.js](packages/react-reconciler/src/ReactFiberHooks.js)\n- [packages/react-reconciler/src/ReactFiberOffscreenComponent.js](packages/react-reconciler/src/ReactFiberOffscreenComponent.js)\n- [packages/react-reconciler/src/ReactFiberRoot.js](packages/react-reconciler/src/ReactFiberRoot.js)\n- [packages/react-reconciler/src/ReactInternalTypes.js](packages/react-reconciler/src/ReactInternalTypes.js)\n- [packages/react-reconciler/src/__tests__/ReactHooks-test.internal.js](packages/react-reconciler/src/__tests__/ReactHooks-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js)\n- [packages/react-server/src/ReactFizzHooks.js](packages/react-server/src/ReactFizzHooks.js)\n- [packages/react-server/src/ReactFlightHooks.js](packages/react-server/src/ReactFlightHooks.js)\n- [packages/react/src/ReactHooks.js](packages/react/src/ReactHooks.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes the React Hooks System implementation, including the dispatcher pattern, hook data structures, effect execution lifecycle, and debugging capabilities. Hooks enable function components to use state and lifecycle features without writing classes.\n\nFor information about the overall reconciliation process that invokes hooks, see [Fiber Architecture and Work Loop](#4.1). For server-side rendering specifics, see [React Fizz (Streaming SSR)](#5.1). For static analysis of hook usage, see [ESLint Plugin for React Hooks](#7.2).\n\n## Architecture Overview\n\nThe hooks system uses a **dispatcher pattern** to provide different implementations based on component lifecycle phase. During render, hooks resolve to mount, update, or rerender dispatchers. Hook state is stored as a linked list on `fiber.memoizedState`, while effects form a circular list on `fiber.updateQueue.lastEffect`.\n\n**Hooks System Architecture**\n\n```mermaid\ngraph TB\n    subgraph "Public API Layer"\n        ReactHooks["React.useState<br/>React.useEffect<br/>React.useCallback<br/>etc."]\n    end\n    \n    subgraph "Dispatcher Resolution"\n        resolveDispatcher["resolveDispatcher()<br/>ReactSharedInternals.H"]\n        MountDispatcher["HooksDispatcherOnMount"]\n        UpdateDispatcher["HooksDispatcherOnUpdate"]\n        RerenderDispatcher["HooksDispatcherOnRerender"]\n        ContextOnlyDispatcher["ContextOnlyDispatcher"]\n    end\n    \n    subgraph "Core Render Function"\n        renderWithHooks["renderWithHooks()<br/>Sets dispatcher, calls component"]\n        finishRenderingHooks["finishRenderingHooks()<br/>Resets state"]\n    end\n    \n    subgraph "Hook Implementation"\n        mountState["mountState()<br/>Initialize hook"]\n        updateState["updateState()<br/>Process updates"]\n        mountEffect["mountEffect()<br/>Create effect"]\n        updateEffect["updateEffect()<br/>Update effect"]\n    end\n    \n    subgraph "Data Structures"\n        HookList["Hook Linked List<br/>fiber.memoizedState"]\n        UpdateQueue["UpdateQueue<br/>pending updates"]\n        EffectList["Effect Circular List<br/>fiber.updateQueue.lastEffect"]\n    end\n    \n    subgraph "Commit Phase"\n        commitHookEffectListMount["commitHookEffectListMount()"]\n        commitHookEffectListUnmount["commitHookEffectListUnmount()"]\n        flushPassiveEffects["flushPassiveEffects()"]\n    end\n    \n    ReactHooks --> resolveDispatcher\n    resolveDispatcher --> MountDispatcher\n    resolveDispatcher --> UpdateDispatcher\n    resolveDispatcher --> RerenderDispatcher\n    resolveDispatcher --> ContextOnlyDispatcher\n    \n    MountDispatcher --> renderWithHooks\n    UpdateDispatcher --> renderWithHooks\n    RerenderDispatcher --> renderWithHooks\n    \n    renderWithHooks --> mountState\n    renderWithHooks --> updateState\n    renderWithHooks --> mountEffect\n    renderWithHooks --> updateEffect\n    renderWithHooks --> finishRenderingHooks\n    \n    mountState --> HookList\n    updateState --> HookList\n    updateState --> UpdateQueue\n    mountEffect --> EffectList\n    updateEffect --> EffectList\n    \n    EffectList --> commitHookEffectListMount\n    EffectList --> commitHookEffectListUnmount\n    EffectList --> flushPassiveEffects\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1-200](), [packages/react/src/ReactHooks.js:1-242]()\n\n## Public Hooks API\n\nThe public API is exposed through `packages/react/src/ReactHooks.js`. Each hook function calls `resolveDispatcher()` to obtain the current dispatcher from `ReactSharedInternals.H`, then delegates to the dispatcher implementation.\n\n**Available Hooks**\n\n| Hook | Purpose | Stateful |\n|------|---------|----------|\n| `useState` | Local component state | Yes |\n| `useReducer` | State with reducer logic | Yes |\n| `useEffect` | Side effects after paint | No |\n| `useLayoutEffect` | Side effects before paint | No |\n| `useInsertionEffect` | CSS-in-JS insertions | No |\n| `useContext` | Read context value | No |\n| `useRef` | Mutable reference | Yes |\n| `useMemo` | Memoized value | Yes |\n| `useCallback` | Memoized callback | Yes |\n| `useImperativeHandle` | Customize ref value | No |\n| `useDebugValue` | DevTools label | No |\n| `useId` | Stable unique ID | Yes |\n| `useTransition` | Non-blocking updates | Yes |\n| `useDeferredValue` | Defer value updates | Yes |\n| `useSyncExternalStore` | Subscribe to external store | Yes |\n| `useOptimistic` | Optimistic UI updates | Yes |\n| `useActionState` | Form action state | Yes |\n| `use` | Read Promise/Context | No |\n\n**Dispatcher Resolution Flow**\n\n```mermaid\ngraph LR\n    App["Component calls<br/>useState()"]\n    resolveDispatcher["resolveDispatcher()"]\n    SharedInternals["ReactSharedInternals.H"]\n    \n    CurrentDispatcher{{"Current<br/>Dispatcher?"}}\n    \n    Mount["HooksDispatcherOnMount"]\n    Update["HooksDispatcherOnUpdate"]\n    Rerender["HooksDispatcherOnRerender"]\n    ContextOnly["ContextOnlyDispatcher"]\n    \n    mountState["mountState()"]\n    updateState["updateState()"]\n    \n    App --> resolveDispatcher\n    resolveDispatcher --> SharedInternals\n    SharedInternals --> CurrentDispatcher\n    \n    CurrentDispatcher -->|"First render"| Mount\n    CurrentDispatcher -->|"Subsequent render"| Update\n    CurrentDispatcher -->|"Render phase update"| Rerender\n    CurrentDispatcher -->|"Outside render"| ContextOnly\n    \n    Mount --> mountState\n    Update --> updateState\n    Rerender --> updateState\n    ContextOnly -->|"Throws error"| Error["Invalid hook call"]\n```\n\nSources: [packages/react/src/ReactHooks.js:24-42](), [packages/react/src/ReactHooks.js:66-71]()\n\n## Dispatcher Pattern\n\nThe dispatcher is a dynamic vtable that changes based on component lifecycle phase. `renderWithHooks()` sets the appropriate dispatcher before calling the component function, ensuring hooks resolve to the correct implementation.\n\n**Dispatcher Implementations**\n\n| Dispatcher | When Used | Behavior |\n|------------|-----------|----------|\n| `HooksDispatcherOnMount` | First render (`current === null`) | Initializes hook state, creates linked list |\n| `HooksDispatcherOnUpdate` | Subsequent renders | Reuses existing hooks, processes updates |\n| `HooksDispatcherOnRerender` | Render phase updates | Handles setState during render |\n| `ContextOnlyDispatcher` | Outside component render | Throws "Invalid hook call" error |\n| `HooksDispatcherOnMountInDEV` | DEV first render | Validates hook order, dependencies |\n| `HooksDispatcherOnUpdateInDEV` | DEV subsequent render | Validates hook order changes |\n\n**renderWithHooks Execution Flow**\n\n```mermaid\ngraph TB\n    Start["renderWithHooks(current, workInProgress, Component)"]\n    \n    SetContext["Set module state:<br/>renderLanes = nextRenderLanes<br/>currentlyRenderingFiber = workInProgress"]\n    \n    ResetFiber["Reset fiber state:<br/>workInProgress.memoizedState = null<br/>workInProgress.updateQueue = null"]\n    \n    CheckCurrent{{"current === null ||<br/>current.memoizedState === null"}}\n    \n    SetMount["ReactSharedInternals.H =<br/>HooksDispatcherOnMount"]\n    SetUpdate["ReactSharedInternals.H =<br/>HooksDispatcherOnUpdate"]\n    \n    CallComponent["children = Component(props, secondArg)"]\n    \n    CheckRerender{{"didScheduleRenderPhaseUpdateDuringThisPass"}}\n    \n    RerenderLoop["renderWithHooksAgain():<br/>Loop while updates scheduled<br/>Use HooksDispatcherOnRerender"]\n    \n    StrictModeCheck{{"StrictMode enabled?"}}\n    \n    DoubleInvoke["Double invoke component<br/>for side effect detection"]\n    \n    Finish["finishRenderingHooks():<br/>Reset dispatcher to ContextOnlyDispatcher"]\n    \n    Return["Return children"]\n    \n    Start --> SetContext\n    SetContext --> ResetFiber\n    ResetFiber --> CheckCurrent\n    \n    CheckCurrent -->|"Yes (mount)"| SetMount\n    CheckCurrent -->|"No (update)"| SetUpdate\n    \n    SetMount --> CallComponent\n    SetUpdate --> CallComponent\n    \n    CallComponent --> CheckRerender\n    \n    CheckRerender -->|"Yes"| RerenderLoop\n    CheckRerender -->|"No"| StrictModeCheck\n    \n    RerenderLoop --> StrictModeCheck\n    \n    StrictModeCheck -->|"Yes"| DoubleInvoke\n    StrictModeCheck -->|"No"| Finish\n    \n    DoubleInvoke --> Finish\n    Finish --> Return\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:503-632](), [packages/react-reconciler/src/ReactFiberHooks.js:634-750]()\n\n## Hook Data Structures\n\n### Hook Linked List\n\nEach hook call appends a `Hook` object to a singly-linked list stored on `fiber.memoizedState`. The list order must remain constant across renders (enforced by DEV warnings).\n\n**Hook Object Structure**\n\n```mermaid\ngraph LR\n    Fiber["Fiber Node"]\n    \n    subgraph "fiber.memoizedState"\n        Hook1["Hook {<br/>memoizedState: any<br/>baseState: any<br/>baseQueue: Update | null<br/>queue: UpdateQueue | null<br/>next: Hook | null<br/>}"]\n        \n        Hook2["Hook {<br/>memoizedState: any<br/>...next<br/>}"]\n        \n        Hook3["Hook {<br/>memoizedState: any<br/>...next<br/>}"]\n    end\n    \n    Fiber --> Hook1\n    Hook1 -->|"next"| Hook2\n    Hook2 -->|"next"| Hook3\n    Hook3 -->|"next"| Null["null"]\n```\n\nThe `Hook` type definition:\n\n```typescript\ntype Hook = {\n  memoizedState: any,      // Current state value or effect list\n  baseState: any,          // State before pending updates\n  baseQueue: Update | null, // Updates skipped by priority\n  queue: any,              // UpdateQueue for useState/useReducer\n  next: Hook | null        // Next hook in list\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:195-201](), [packages/react-reconciler/src/ReactFiberHooks.js:980-999]()\n\n### UpdateQueue Structure\n\nState hooks (`useState`, `useReducer`) maintain an `UpdateQueue` to track pending updates. Updates form a circular linked list and are processed in order during render.\n\n**UpdateQueue and Update Structure**\n\n```mermaid\ngraph TB\n    Hook["Hook"]\n    \n    subgraph "hook.queue (UpdateQueue)"\n        Queue["UpdateQueue {<br/>pending: Update | null<br/>lanes: Lanes<br/>dispatch: Function<br/>lastRenderedReducer: Function<br/>lastRenderedState: any<br/>}"]\n    end\n    \n    subgraph "Circular Update List"\n        Update1["Update {<br/>lane: Lane<br/>action: any<br/>hasEagerState: boolean<br/>eagerState: any<br/>next: Update<br/>}"]\n        \n        Update2["Update {<br/>lane: Lane<br/>action: any<br/>...next<br/>}"]\n        \n        Update3["Update {<br/>lane: Lane<br/>action: any<br/>...next<br/>}"]\n    end\n    \n    Hook -->|"queue"| Queue\n    Queue -->|"pending"| Update3\n    Update3 -->|"next"| Update1\n    Update1 -->|"next"| Update2\n    Update2 -->|"next"| Update3\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:165-181](), [packages/react-reconciler/src/ReactFiberHooks.js:175-181]()\n\n### Effect Circular List\n\nEffects (`useEffect`, `useLayoutEffect`, `useInsertionEffect`) are stored in a circular linked list on `fiber.updateQueue.lastEffect`. Each `Effect` object contains the effect function, cleanup function, dependencies, and flags.\n\n**Effect Data Structure**\n\n```typescript\ntype Effect = {\n  tag: HookFlags,              // HookPassive | HookLayout | HookInsertion\n  inst: EffectInstance,        // { destroy: Function | void }\n  create: () => (() => void) | void,  // Effect function\n  deps: Array<mixed> | void | null,   // Dependency array\n  next: Effect                 // Next effect in circular list\n}\n\ntype FunctionComponentUpdateQueue = {\n  lastEffect: Effect | null,   // Tail of circular effect list\n  events: Array<any> | null,   // Event functions\n  stores: Array<any> | null,   // Store consistency checks\n  memoCache: MemoCache | null  // Compiler cache\n}\n```\n\nThe `lastEffect` pointer points to the **last** effect in the circular list, so `lastEffect.next` is the **first** effect.\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:217-227](), [packages/react-reconciler/src/ReactFiberHooks.js:247-252]()\n\n## Core Hook Implementations\n\n### State Hooks: useState and useReducer\n\n`useState` is implemented as a specialized `useReducer` with a basic state reducer. Both follow the mount/update pattern.\n\n**useState/useReducer Implementation Flow**\n\n```mermaid\ngraph TB\n    Call["useState(initialState)<br/>or useReducer(reducer, initialArg, init)"]\n    \n    CreateWIP["createWorkInProgressHook()"]\n    \n    CheckPhase{{"Mount or Update?"}}\n    \n    subgraph "Mount Phase"\n        InitState["Calculate initial state:<br/>- useState: call initializer if function<br/>- useReducer: call init(initialArg) if provided"]\n        CreateQueue["Create UpdateQueue:<br/>queue = {<br/>  pending: null,<br/>  lanes: NoLanes,<br/>  dispatch: null,<br/>  lastRenderedReducer: reducer,<br/>  lastRenderedState: initialState<br/>}"]\n        BindDispatch["dispatch = dispatchSetState.bind(null, fiber, queue)"]\n        StoreState["hook.memoizedState = initialState<br/>hook.queue = queue"]\n        ReturnMount["Return [initialState, dispatch]"]\n    end\n    \n    subgraph "Update Phase"\n        CloneHook["Clone hook from current:<br/>workInProgressHook = {<br/>  memoizedState: currentHook.memoizedState,<br/>  baseState: currentHook.baseState,<br/>  baseQueue: currentHook.baseQueue,<br/>  queue: currentHook.queue<br/>}"]\n        \n        CheckUpdates{{"queue.pending !== null?"}}\n        \n        ProcessQueue["Process update queue:<br/>- Apply baseQueue (skipped updates)<br/>- Apply pending updates<br/>- Calculate new state<br/>- Determine if state changed"]\n        \n        UpdateBaseState["Update baseState, baseQueue<br/>for next render"]\n        \n        ReturnUpdate["Return [newState, dispatch]"]\n    end\n    \n    Call --> CreateWIP\n    CreateWIP --> CheckPhase\n    \n    CheckPhase -->|"Mount"| InitState\n    InitState --> CreateQueue\n    CreateQueue --> BindDispatch\n    BindDispatch --> StoreState\n    StoreState --> ReturnMount\n    \n    CheckPhase -->|"Update"| CloneHook\n    CloneHook --> CheckUpdates\n    \n    CheckUpdates -->|"Yes"| ProcessQueue\n    CheckUpdates -->|"No"| ReturnUpdate\n    \n    ProcessQueue --> UpdateBaseState\n    UpdateBaseState --> ReturnUpdate\n```\n\n**Eager State Computation**\n\nWhen `setState` is called, React attempts to compute the new state eagerly (outside render) if the queue is empty. If the new state equals the current state (using `Object.is`), React can bail out of the render entirely.\n\n```mermaid\ngraph TB\n    SetState["setState(action)<br/>or dispatch(action)"]\n    \n    CheckContext{{"Is inside render?"}}\n    \n    RenderPhaseUpdate["Enqueue render phase update:<br/>Store in renderPhaseUpdates Map"]\n    \n    CreateUpdate["Create Update object:<br/>update = {<br/>  lane: requestUpdateLane(),<br/>  action: action,<br/>  hasEagerState: false,<br/>  eagerState: null,<br/>  next: null<br/>}"]\n    \n    EnqueueConcurrent["enqueueConcurrentHookUpdate(fiber, queue, update, lane)"]\n    \n    CheckEager{{"Queue is empty &<br/>alternate exists?"}}\n    \n    ComputeEager["Eager computation:<br/>eagerState = lastRenderedReducer(lastRenderedState, action)"]\n    \n    CheckSame{{"Object.is(eagerState, currentState)?"}}\n    \n    MarkEager["update.hasEagerState = true<br/>update.eagerState = eagerState"]\n    \n    BailOut["Bail out:<br/>Do not schedule update<br/>Return immediately"]\n    \n    ScheduleUpdate["scheduleUpdateOnFiber(fiber, lane)"]\n    \n    SetState --> CheckContext\n    \n    CheckContext -->|"Yes"| RenderPhaseUpdate\n    CheckContext -->|"No"| CreateUpdate\n    \n    CreateUpdate --> EnqueueConcurrent\n    EnqueueConcurrent --> CheckEager\n    \n    CheckEager -->|"Yes"| ComputeEager\n    CheckEager -->|"No"| ScheduleUpdate\n    \n    ComputeEager --> CheckSame\n    \n    CheckSame -->|"Yes"| MarkEager\n    CheckSame -->|"No"| ScheduleUpdate\n    \n    MarkEager --> BailOut\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1095-1253](), [packages/react-reconciler/src/ReactFiberHooks.js:2648-2861]()\n\n### Effect Hooks: useEffect, useLayoutEffect, useInsertionEffect\n\nEffect hooks create `Effect` objects and append them to the circular effect list. The `tag` field determines when the effect is executed:\n\n- `HookInsertion`: During commit before mutations (for CSS-in-JS)\n- `HookLayout`: During commit after mutations, before paint (sync)\n- `HookPassive`: After commit and paint (async via scheduler)\n\n**Effect Mount and Update**\n\n```mermaid\ngraph TB\n    CallEffect["useEffect(create, deps)"]\n    \n    CreateWIP["createWorkInProgressHook()"]\n    \n    CheckPhase{{"Mount or Update?"}}\n    \n    subgraph "Mount Phase"\n        CreateEffect["Create Effect object:<br/>effect = {<br/>  tag: HookPassive | HookHasEffect,<br/>  inst: { destroy: undefined },<br/>  create: create,<br/>  deps: deps,<br/>  next: null<br/>}"]\n        \n        AppendEffect["Append to circular list:<br/>fiber.updateQueue.lastEffect = effect"]\n        \n        MarkFlag["Mark fiber flag:<br/>fiber.flags |= PassiveEffect"]\n    end\n    \n    subgraph "Update Phase"\n        CheckDeps{{"areHookInputsEqual(nextDeps, prevDeps)?"}}\n        \n        CreateNoOpEffect["Create Effect without HookHasEffect:<br/>effect.tag = HookPassive<br/>(won\'t fire)"]\n        \n        CreateNewEffect["Create Effect with HookHasEffect:<br/>effect.tag = HookPassive | HookHasEffect<br/>(will fire)"]\n        \n        UpdateList["Update circular list"]\n    end\n    \n    CallEffect --> CreateWIP\n    CreateWIP --> CheckPhase\n    \n    CheckPhase -->|"Mount"| CreateEffect\n    CreateEffect --> AppendEffect\n    AppendEffect --> MarkFlag\n    \n    CheckPhase -->|"Update"| CheckDeps\n    \n    CheckDeps -->|"Deps unchanged"| CreateNoOpEffect\n    CheckDeps -->|"Deps changed"| CreateNewEffect\n    \n    CreateNoOpEffect --> UpdateList\n    CreateNewEffect --> UpdateList\n    UpdateList --> MarkFlag\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1956-2023](), [packages/react-reconciler/src/ReactFiberHooks.js:2025-2069]()\n\n### Ref Hook: useRef\n\n`useRef` is a simple hook that stores a mutable object with a `current` property. The ref object identity remains stable across renders.\n\n```mermaid\ngraph LR\n    Call["useRef(initialValue)"]\n    \n    CreateWIP["createWorkInProgressHook()"]\n    \n    CheckPhase{{"Mount or Update?"}}\n    \n    Mount["Mount:<br/>ref = { current: initialValue }<br/>hook.memoizedState = ref"]\n    \n    Update["Update:<br/>ref = hook.memoizedState"]\n    \n    Return["Return ref"]\n    \n    Call --> CreateWIP\n    CreateWIP --> CheckPhase\n    CheckPhase -->|"Mount"| Mount\n    CheckPhase -->|"Update"| Update\n    Mount --> Return\n    Update --> Return\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1764-1779]()\n\n### Memoization Hooks: useMemo and useCallback\n\n`useMemo` and `useCallback` cache computed values based on dependency arrays. During mount, they compute and store the value. During update, they check dependencies and either reuse or recompute.\n\n**useMemo Implementation**\n\n```mermaid\ngraph TB\n    Call["useMemo(create, deps)"]\n    \n    CreateWIP["createWorkInProgressHook()"]\n    \n    CheckPhase{{"Mount or Update?"}}\n    \n    subgraph "Mount Phase"\n        CallCreate["value = create()"]\n        StoreMount["hook.memoizedState = [value, deps]"]\n        ReturnMount["Return value"]\n    end\n    \n    subgraph "Update Phase"\n        GetPrev["prevState = hook.memoizedState<br/>[prevValue, prevDeps] = prevState"]\n        \n        CheckDeps{{"areHookInputsEqual(nextDeps, prevDeps)?"}}\n        \n        ReuseValue["Return prevValue"]\n        \n        RecomputeValue["value = create()<br/>hook.memoizedState = [value, nextDeps]"]\n        \n        ReturnNew["Return value"]\n    end\n    \n    Call --> CreateWIP\n    CreateWIP --> CheckPhase\n    \n    CheckPhase -->|"Mount"| CallCreate\n    CallCreate --> StoreMount\n    StoreMount --> ReturnMount\n    \n    CheckPhase -->|"Update"| GetPrev\n    GetPrev --> CheckDeps\n    \n    CheckDeps -->|"Yes"| ReuseValue\n    CheckDeps -->|"No"| RecomputeValue\n    \n    RecomputeValue --> ReturnNew\n```\n\n`useCallback(fn, deps)` is implemented as `useMemo(() => fn, deps)`.\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1890-1931](), [packages/react-reconciler/src/ReactFiberHooks.js:1933-1954]()\n\n## Effect Execution Lifecycle\n\nEffects are executed during the commit phase, but at different times based on their type. The fiber flags (`PassiveEffect`, `UpdateEffect`) indicate which effects need to be processed.\n\n**Effect Execution Timeline**\n\n```mermaid\ngraph TB\n    subgraph "Render Phase"\n        RenderComponent["renderWithHooks()<br/>Component executes"]\n        CollectEffects["Effects collected in<br/>fiber.updateQueue.lastEffect"]\n        MarkFlags["Set fiber.flags:<br/>PassiveEffect, UpdateEffect, etc."]\n    end\n    \n    subgraph "Commit Phase - Before Mutation"\n        BeforeMutation["commitBeforeMutationEffects()"]\n        Snapshots["No effect execution<br/>(getSnapshotBeforeUpdate)"]\n    end\n    \n    subgraph "Commit Phase - Mutation"\n        Mutation["commitMutationEffects()"]\n        InsertionUnmount["commitHookEffectListUnmount(HookInsertion):<br/>Run insertion effect cleanups"]\n    end\n    \n    subgraph "Commit Phase - Layout"\n        Layout["commitLayoutEffects()"]\n        \n        InsertionMount["commitHookEffectListMount(HookInsertion):<br/>Run insertion effects"]\n        \n        LayoutUnmount["commitHookEffectListUnmount(HookLayout):<br/>Run layout effect cleanups"]\n        \n        LayoutMount["commitHookEffectListMount(HookLayout):<br/>Run layout effects (useLayoutEffect)"]\n    end\n    \n    subgraph "After Paint - Async"\n        SchedulePassive["scheduleCallback(NormalPriority, flushPassiveEffects)"]\n        \n        FlushPassive["flushPassiveEffects()"]\n        \n        PassiveUnmount["commitHookPassiveUnmountEffects():<br/>Run passive effect cleanups"]\n        \n        PassiveMount["commitHookPassiveMountEffects():<br/>Run passive effects (useEffect)"]\n    end\n    \n    RenderComponent --> CollectEffects\n    CollectEffects --> MarkFlags\n    \n    MarkFlags --> BeforeMutation\n    BeforeMutation --> Snapshots\n    \n    Snapshots --> Mutation\n    Mutation --> InsertionUnmount\n    \n    InsertionUnmount --> Layout\n    Layout --> InsertionMount\n    InsertionMount --> LayoutUnmount\n    LayoutUnmount --> LayoutMount\n    \n    LayoutMount --> SchedulePassive\n    SchedulePassive --> FlushPassive\n    FlushPassive --> PassiveUnmount\n    PassiveUnmount --> PassiveMount\n```\n\n**Effect Tag Bits**\n\n| Tag | Constant | Meaning |\n|-----|----------|---------|\n| `HookHasEffect` | `0b001` | Effect should fire this render |\n| `HookInsertion` | `0b010` | Insertion effect (CSS-in-JS) |\n| `HookLayout` | `0b100` | Layout effect (sync after mutations) |\n| `HookPassive` | `0b1000` | Passive effect (async after paint) |\n\nEffects only execute if `effect.tag & HookHasEffect !== 0`. During mount, all effects have `HookHasEffect`. During update, only effects with changed dependencies have `HookHasEffect`.\n\nSources: [packages/react-reconciler/src/ReactHookEffectTags.js:1-21](), [packages/react-reconciler/src/ReactFiberHooks.js:1956-2023]()\n\n## Server-Side Hooks Implementation\n\nThe Fizz server renderer (`packages/react-server/src/ReactFizzHooks.js`) provides a separate hooks implementation optimized for synchronous server rendering. Key differences:\n\n- **No effects**: `useEffect`, `useLayoutEffect`, `useInsertionEffect` are no-ops\n- **Simpler state management**: No concurrent updates or lanes\n- **Synchronous execution**: No scheduling or yielding\n- **Render phase updates**: Handled via re-render loop with `renderPhaseUpdates` Map\n\n**Server Hook State Management**\n\n```mermaid\ngraph TB\n    PrepareHooks["prepareToUseHooks(request, task, componentIdentity)"]\n    \n    SetContext["Set module state:<br/>currentlyRenderingComponent = componentIdentity<br/>currentlyRenderingTask = task<br/>currentlyRenderingRequest = request"]\n    \n    CallComponent["Component(props, context)"]\n    \n    CreateWIPHook["createWorkInProgressHook():<br/>Create or reuse hook"]\n    \n    CheckRerender{{"didScheduleRenderPhaseUpdate?"}}\n    \n    RerenderLoop["Loop while updates scheduled:<br/>Apply renderPhaseUpdates<br/>Re-call Component()"]\n    \n    FinishHooks["finishHooks():<br/>Return children"]\n    \n    ResetState["resetHooksState():<br/>Clear module state"]\n    \n    PrepareHooks --> SetContext\n    SetContext --> CallComponent\n    \n    CallComponent --> CreateWIPHook\n    CreateWIPHook --> CheckRerender\n    \n    CheckRerender -->|"Yes"| RerenderLoop\n    RerenderLoop --> CheckRerender\n    \n    CheckRerender -->|"No"| FinishHooks\n    FinishHooks --> ResetState\n```\n\n**Server useActionState Hook**\n\n`useActionState` (formerly `useFormState`) is special on the server. It receives permalink information and action state from the request, enabling progressive enhancement of forms.\n\nSources: [packages/react-server/src/ReactFizzHooks.js:207-316](), [packages/react-server/src/ReactFizzHooks.js:665-831]()\n\n## Debug and DevTools Integration\n\n### ReactDebugHooks\n\nThe `react-debug-tools` package provides `inspectHooks()` and `inspectHooksOfFiber()` to extract hook information for DevTools. It uses a custom dispatcher that logs all hook calls.\n\n**Hook Inspection Architecture**\n\n```mermaid\ngraph TB\n    DevTools["React DevTools"]\n    \n    InspectAPI["ReactDebugTools.inspectHooksOfFiber(fiber)"]\n    \n    subgraph "Inspection Process"\n        SaveDispatcher["Save current dispatcher"]\n        \n        SetDebugDispatcher["Set ReactSharedInternals.H = DispatcherProxy"]\n        \n        SetupContext["Setup currentFiber, currentHook<br/>from fiber.memoizedState"]\n        \n        ReplayRender["Call Component(props)<br/>to replay render"]\n        \n        LogHooks["Dispatcher logs each hook call:<br/>hookLog.push({ primitive, value, stackError })"]\n        \n        RestoreDispatcher["Restore original dispatcher"]\n        \n        BuildTree["buildTree(rootStack, hookLog):<br/>Parse stack traces<br/>Construct hook tree with nesting"]\n    end\n    \n    ReturnTree["Return HooksTree:<br/>Array of HooksNode"]\n    \n    DevTools --> InspectAPI\n    InspectAPI --> SaveDispatcher\n    SaveDispatcher --> SetDebugDispatcher\n    SetDebugDispatcher --> SetupContext\n    SetupContext --> ReplayRender\n    ReplayRender --> LogHooks\n    LogHooks --> RestoreDispatcher\n    RestoreDispatcher --> BuildTree\n    BuildTree --> ReturnTree\n    ReturnTree --> DevTools\n```\n\n**HooksNode Structure**\n\n```typescript\ntype HooksNode = {\n  id: number | null,              // Hook index for state hooks\n  isStateEditable: boolean,       // Can DevTools edit this state?\n  name: string,                   // Hook name (e.g., "State", "Effect", "Custom")\n  value: mixed,                   // Hook value\n  subHooks: Array<HooksNode>,     // Nested custom hook calls\n  debugInfo: ReactDebugInfo | null, // Debug metadata\n  hookSource: HookSource | null   // Source location { fileName, lineNumber, etc. }\n}\n```\n\nThe debug dispatcher intercepts every hook call, extracts its value from the fiber\'s hook list, and records it in `hookLog`. Stack trace parsing determines which hooks are nested inside custom hooks.\n\nSources: [packages/react-debug-tools/src/ReactDebugHooks.js:1-300](), [packages/react-debug-tools/src/ReactDebugHooks.js:996-1098]()\n\n### DEV-Only Validation\n\nIn development builds, React enforces the Rules of Hooks through several mechanisms:\n\n**Hook Order Validation**\n\n```mermaid\ngraph TB\n    Render["Component renders"]\n    \n    CheckDev{{"__DEV__ mode?"}}\n    \n    SaveTypes["Save hook types:<br/>workInProgress._debugHookTypes = hookTypesDev"]\n    \n    MountHook["mountHookTypesDev():<br/>hookTypesDev.push(hookName)"]\n    \n    UpdateHook["updateHookTypesDev():<br/>Check hookTypesDev[index] === hookName"]\n    \n    Mismatch{{"Hook type mismatch?"}}\n    \n    WarnMismatch["console.error:<br/>\'React has detected a change in the order of Hooks\'<br/>Show table of previous vs current"]\n    \n    CheckDeps["checkDepsAreArrayDev(deps):<br/>Warn if deps is not array"]\n    \n    CheckDepLength["Check deps.length matches prevDeps.length"]\n    \n    Continue["Continue render"]\n    \n    Render --> CheckDev\n    \n    CheckDev -->|"Yes"| SaveTypes\n    CheckDev -->|"No"| Continue\n    \n    SaveTypes --> MountHook\n    SaveTypes --> UpdateHook\n    \n    UpdateHook --> Mismatch\n    \n    Mismatch -->|"Yes"| WarnMismatch\n    Mismatch -->|"No"| CheckDeps\n    \n    WarnMismatch --> Continue\n    CheckDeps --> CheckDepLength\n    CheckDepLength --> Continue\n```\n\n**Validated Conditions**\n\n| Rule | Check | Error Message |\n|------|-------|---------------|\n| Hook order | `hookTypesDev[index] === currentHookName` | "React has detected a change in the order of Hooks" |\n| Dependency array | `isArray(deps)` | "received a final argument that is not an array" |\n| Dependency length | `nextDeps.length === prevDeps.length` | "changed size between renders" |\n| Effect callback | `create != null` | "requires an effect callback" |\n| Invalid context | `currentlyRenderingFiber !== null` | "Invalid hook call" |\n| Async component | `Object.prototype.toString.call(Component) !== \'[object AsyncFunction]\'` | "is an async Client Component" |\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:309-394](), [packages/react-reconciler/src/ReactFiberHooks.js:334-347]()\n\n## Hook Lifecycle Summary\n\n**Complete Hook Execution Flow**\n\n```mermaid\ngraph TB\n    subgraph "Initial Mount"\n        Mount1["renderWithHooks() sets HooksDispatcherOnMount"]\n        Mount2["Component calls hooks"]\n        Mount3["mountWorkInProgressHook() creates Hook nodes"]\n        Mount4["Hooks stored in fiber.memoizedState linked list"]\n        Mount5["Effects stored in fiber.updateQueue.lastEffect"]\n        Mount6["Fiber marked with PassiveEffect, UpdateEffect flags"]\n    end\n    \n    subgraph "Update Render"\n        Update1["renderWithHooks() sets HooksDispatcherOnUpdate"]\n        Update2["Component calls hooks"]\n        Update3["updateWorkInProgressHook() clones from current"]\n        Update4["Process update queues"]\n        Update5["Compare dependencies for effects"]\n        Update6["Mark changed effects with HookHasEffect"]\n    end\n    \n    subgraph "Commit Effects"\n        Commit1["Commit phase begins"]\n        Commit2["commitMutationEffects(): Insertion effect cleanups"]\n        Commit3["commitLayoutEffects(): Insertion + Layout effects"]\n        Commit4["Layout effect cleanups, then mounts"]\n        Commit5["scheduleCallback for passive effects"]\n        Commit6["After paint: flushPassiveEffects()"]\n        Commit7["Passive effect cleanups, then mounts"]\n    end\n    \n    subgraph "setState Called"\n        SetState1["setState(action) during event"]\n        SetState2["Create Update object"]\n        SetState3["Eager state computation if possible"]\n        SetState4["enqueueConcurrentHookUpdate()"]\n        SetState5["scheduleUpdateOnFiber()"]\n        SetState6["Triggers new render"]\n    end\n    \n    Mount1 --> Mount2\n    Mount2 --> Mount3\n    Mount3 --> Mount4\n    Mount4 --> Mount5\n    Mount5 --> Mount6\n    \n    Mount6 --> Commit1\n    \n    Update1 --> Update2\n    Update2 --> Update3\n    Update3 --> Update4\n    Update4 --> Update5\n    Update5 --> Update6\n    \n    Update6 --> Commit1\n    \n    Commit1 --> Commit2\n    Commit2 --> Commit3\n    Commit3 --> Commit4\n    Commit4 --> Commit5\n    Commit5 --> Commit6\n    Commit6 --> Commit7\n    \n    SetState1 --> SetState2\n    SetState2 --> SetState3\n    SetState3 --> SetState4\n    SetState4 --> SetState5\n    SetState5 --> SetState6\n    SetState6 --> Update1\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:503-750](), [packages/react-reconciler/src/ReactFiberHooks.js:2648-2861]()\n\n## Key Implementation Files\n\n| File | Purpose |\n|------|---------|\n| [packages/react/src/ReactHooks.js]() | Public hooks API, dispatcher resolution |\n| [packages/react-reconciler/src/ReactFiberHooks.js]() | Core hooks implementation for client-side rendering |\n| [packages/react-reconciler/src/ReactInternalTypes.js:46-66]() | `HookType`, `Dispatcher`, `Hook` type definitions |\n| [packages/react-reconciler/src/ReactInternalTypes.js:398-459]() | `Dispatcher` interface with all hook methods |\n| [packages/react-server/src/ReactFizzHooks.js]() | Server-side hooks implementation for Fizz |\n| [packages/react-debug-tools/src/ReactDebugHooks.js]() | Hook inspection for DevTools |\n| [packages/react-reconciler/src/ReactHookEffectTags.js]() | Effect type flags and constants |\n| [packages/react-reconciler/src/ReactFiberCommitWork.js]() | Effect execution during commit phase |\n\n---\n\n# Page: Lane-Based Scheduling and Priorities\n\n# Lane-Based Scheduling and Priorities\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document explains React\'s lane-based scheduling system, which assigns priority levels to updates and determines the order in which work is processed. Lanes are React\'s internal mechanism for implementing concurrent rendering, allowing high-priority updates to interrupt lower-priority work.\n\nFor information about the reconciler work loop that executes scheduled work, see [4.2](#4.2). For hook state management within the scheduling system, see [4.3](#4.3). For Suspense-specific retry scheduling, see [4.5](#4.5).\n\n## Overview\n\nThe lane system represents priority levels as bit flags in a 32-bit integer, where each bit position corresponds to a specific priority level. This allows React to efficiently perform set operations (union, intersection, difference) on groups of lanes and quickly determine the highest priority work.\n\nUpdates are assigned lanes based on their origin (user input, transition, idle work) and context (render phase, commit phase). The reconciler then selects which lanes to work on, potentially preempting lower-priority work when higher-priority updates arrive.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:1-100]()\n\n## Lane Definitions and Priority Levels\n\nThe following table lists all lane types from highest to lowest priority:\n\n| Lane Name | Binary Representation | Use Case |\n|-----------|----------------------|----------|\n| `SyncHydrationLane` | `0b...0001` | Synchronous hydration during SSR |\n| `SyncLane` | `0b...0010` | Synchronous updates (e.g., `flushSync`) |\n| `InputContinuousHydrationLane` | `0b...0100` | Hydration for continuous input |\n| `InputContinuousLane` | `0b...1000` | Continuous user input (drag, scroll) |\n| `DefaultHydrationLane` | `0b...10000` | Default hydration priority |\n| `DefaultLane` | `0b...100000` | Default updates (most `setState` calls) |\n| `GestureLane` | `0b...1000000` | Gesture-driven transitions |\n| `TransitionHydrationLane` | `0b...10000000` | Hydration for transitions |\n| `TransitionLanes` (16 lanes) | `0b...1111111100000000` | Transition updates (`startTransition`) |\n| `RetryLanes` (5 lanes) | `0b...11111000000000000000000` | Suspense boundary retries |\n| `IdleHydrationLane` | `0b...100000000000000000000000` | Idle hydration work |\n| `IdleLane` | `0b...1000000000000000000000000` | Idle updates |\n| `OffscreenLane` | `0b...10000000000000000000000000` | Offscreen/prerendering work |\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:40-93]()\n\n## Lane Representation and Bitwise Operations\n\n### Lane Type Definitions\n\n```\ntype Lanes = number;  // Set of lanes (bitwise OR of Lane values)\ntype Lane = number;   // Single lane (power of 2)\n```\n\nLanes use bitwise operations for efficient set manipulation:\n\n```mermaid\ngraph TB\n    subgraph "Lane Operations"\n        A["mergeLanes(a, b)"]\n        B["removeLanes(set, subset)"]\n        C["intersectLanes(a, b)"]\n        D["isSubsetOfLanes(set, subset)"]\n        E["includesSomeLane(a, b)"]\n        F["getHighestPriorityLane(lanes)"]\n    end\n    \n    A -->|"a | b"| OR["Bitwise OR"]\n    B -->|"set & ~subset"| AND_NOT["Bitwise AND NOT"]\n    C -->|"a & b"| AND["Bitwise AND"]\n    D -->|"(set & subset) === subset"| CHECK1["Equality Check"]\n    E -->|"(a & b) !== NoLanes"| CHECK2["Non-zero Check"]\n    F -->|"lanes & -lanes"| ISOLATE["Isolate Rightmost Bit"]\n```\n\n**Diagram: Lane Bitwise Operations**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:145-223]()\n\n### Common Lane Groupings\n\n| Group Name | Lanes Included | Purpose |\n|------------|----------------|---------|\n| `SyncUpdateLanes` | `SyncLane \\| InputContinuousLane \\| DefaultLane` | Synchronous or near-synchronous updates |\n| `UpdateLanes` | All non-hydration, non-offscreen lanes | Normal update work |\n| `NonIdleWork` | All lanes except `IdleLane` and `OffscreenLane` | Work that shouldn\'t be idle |\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:55-56]()\n\n## Lane Assignment Process\n\n### Update Lane Request Flow\n\n```mermaid\ngraph TD\n    Update["Update Triggered"]\n    Update --> CheckContext{"Execution Context?"}\n    \n    CheckContext -->|"RenderContext"| RenderPhase["pickArbitraryLane(workInProgressRootRenderLanes)"]\n    CheckContext -->|"NoContext"| CheckTransition{"In Transition?"}\n    \n    CheckTransition -->|"Yes"| RequestTransition["requestTransitionLane(transition)"]\n    CheckTransition -->|"No"| EventPriority["eventPriorityToLane(resolveUpdatePriority())"]\n    \n    RequestTransition --> ClaimTransition["claimNextTransitionLane()"]\n    ClaimTransition --> AssignedLane["Transition Lane Assigned"]\n    \n    EventPriority --> MapEvent{"Event Priority"}\n    MapEvent -->|"DiscreteEventPriority"| Sync["SyncLane"]\n    MapEvent -->|"ContinuousEventPriority"| Continuous["InputContinuousLane"]\n    MapEvent -->|"DefaultEventPriority"| Default["DefaultLane"]\n    MapEvent -->|"IdleEventPriority"| Idle["IdleLane"]\n    \n    RenderPhase --> AssignedLane\n    Sync --> AssignedLane\n    Continuous --> AssignedLane\n    Default --> AssignedLane\n    Idle --> AssignedLane\n```\n\n**Diagram: Lane Assignment Decision Tree**\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:803-847](), [packages/react-reconciler/src/ReactFiberRootScheduler.js:206-271]()\n\n### Transition Lane Allocation\n\nTransition lanes are allocated cyclically from a pool of 16 lanes:\n\n```mermaid\ngraph LR\n    T["Transition Created"] --> Pool["Transition Lane Pool<br/>(16 lanes)"]\n    Pool --> Claim["claimNextTransitionLane()"]\n    Claim --> Next["nextTransitionLane<br/>(cycling index)"]\n    Next --> Assign["Assign TransitionLane1-16"]\n    Assign --> Increment["Increment nextTransitionLane"]\n    Increment --> Wrap{"Wrapped around?"}\n    Wrap -->|"Yes"| Reset["Reset to TransitionLane1"]\n    Wrap -->|"No"| Pool\n```\n\n**Diagram: Transition Lane Cycling**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:394-439]()\n\n### Retry Lane Allocation\n\nWhen Suspense boundaries suspend, they\'re assigned retry lanes from a pool of 5 lanes:\n\n```\nclaimNextRetryLane(): Lane\n   Checks current lane against retry lane mask\n   Returns next available retry lane\n   Wraps around after lane 5\n```\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:353-385]()\n\n## Lane Selection Algorithm\n\nThe `getNextLanes()` function determines which lanes React should work on next:\n\n```mermaid\ngraph TD\n    Start["getNextLanes(root, wipLanes)"]\n    Start --> CheckPending{"pendingLanes === NoLanes?"}\n    CheckPending -->|"Yes"| ReturnNone["return NoLanes"]\n    CheckPending -->|"No"| MarkExpired["markStarvedLanesAsExpired(root, currentTime)"]\n    \n    MarkExpired --> CheckNonIdle{"includesNonIdleWork(wipLanes)?"}\n    CheckNonIdle -->|"Yes"| NonIdlePath["nonIdlePendingLanes = pendingLanes & ~IdleLanes"]\n    CheckNonIdle -->|"No"| IdlePath["Work from all pendingLanes"]\n    \n    NonIdlePath --> CheckBlocking{"includesBlockingLane()?"}\n    IdlePath --> CheckBlocking\n    \n    CheckBlocking -->|"Yes"| BlockingLanes["return blocking lanes<br/>(SyncUpdateLanes)"]\n    CheckBlocking -->|"No"| CheckExpired{"includesExpiredLane()?"}\n    \n    CheckExpired -->|"Yes"| ExpiredLanes["return expired lanes"]\n    CheckExpired -->|"No"| CheckEntangled{"Check entangled lanes"}\n    \n    CheckEntangled --> FinalLanes["return highest priority lanes"]\n```\n\n**Diagram: Lane Selection Algorithm**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:544-697]()\n\n### Priority Checks\n\nThe selection algorithm uses several helper functions to categorize lanes:\n\n| Function | Purpose |\n|----------|---------|\n| `includesBlockingLane(lanes)` | Checks if lanes include sync or input-continuous work |\n| `includesExpiredLane(root, lanes)` | Checks if any lanes have expired |\n| `includesNonIdleWork(lanes)` | Checks if work is not idle priority |\n| `includesOnlyRetries(lanes)` | Checks if only retry lanes remain |\n| `includesTransitionLane(lanes)` | Checks if transition work is present |\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:225-304]()\n\n## Root Lane Management\n\nEach `FiberRoot` maintains several lane sets to track work state:\n\n```mermaid\ngraph TD\n    subgraph FiberRoot["FiberRoot Lane State"]\n        Pending["pendingLanes<br/>All pending work"]\n        Suspended["suspendedLanes<br/>Work blocked on Suspense"]\n        Pinged["pingedLanes<br/>Suspense resolved"]\n        Expired["expiredLanes<br/>Starved lanes"]\n        Finished["finishedLanes<br/>Just committed"]\n    end\n    \n    Update["New Update"] -->|"markRootUpdated()"| Pending\n    Suspend["Suspends"] -->|"markRootSuspended()"| Suspended\n    Resolve["Promise Resolves"] -->|"markRootPinged()"| Pinged\n    TimeOut["Time Passes"] -->|"markStarvedLanesAsExpired()"| Expired\n    Commit["Commit"] -->|"markRootFinished()"| Finished\n    \n    Pending -.->|"influences"| NextLanes["getNextLanes()"]\n    Suspended -.->|"influences"| NextLanes\n    Pinged -.->|"influences"| NextLanes\n    Expired -.->|"influences"| NextLanes\n```\n\n**Diagram: Root Lane State Management**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:845-1065]()\n\n### Lane State Transitions\n\n```mermaid\nstateDiagram-v2\n    [*] --> Pending: markRootUpdated()\n    Pending --> Rendering: performWorkOnRoot()\n    Rendering --> Suspended: Suspends\n    Rendering --> Committed: Completes\n    Suspended --> Pinged: markRootPinged()\n    Pinged --> Rendering: Retry\n    Suspended --> Expired: Timeout\n    Expired --> Rendering: Force retry\n    Committed --> [*]: markRootFinished()\n```\n\n**Diagram: Lane Lifecycle**\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1116-1400](), [packages/react-reconciler/src/ReactFiberLane.js:845-949]()\n\n## Lane Entanglement\n\nEntanglement forces certain lanes to render together, ensuring consistency:\n\n```mermaid\ngraph TD\n    subgraph "Entanglement Scenarios"\n        A["Update in Transition"]\n        B["Update to Suspense Boundary"]\n        C["Context Provider Update"]\n    end\n    \n    A --> Track["Track entangled lanes<br/>root.entangledLanes"]\n    B --> Track\n    C --> Track\n    \n    Track --> Get["getEntangledLanes(root, renderLanes)"]\n    Get --> Merge["mergeLanes(renderLanes, entangled)"]\n    Merge --> Render["Render all entangled work together"]\n```\n\n**Diagram: Lane Entanglement Process**\n\nWhen an update occurs during a transition that also affects non-transition work, both must complete together to maintain consistency.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:699-787](), [packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:534-553]()\n\n### Entanglement Example\n\n```\nScenario: User in transition, context updates\n  1. Transition lane: TransitionLane1\n  2. Context update schedules: DefaultLane\n  3. Entangle: TransitionLane1 | DefaultLane\n  4. Both lanes render together\n```\n\nSources: [packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:534-553]()\n\n## Expiration and Starvation Prevention\n\nReact prevents starvation by marking lanes as expired after they wait too long:\n\n```mermaid\ngraph LR\n    Check["markStarvedLanesAsExpired()"]\n    Check --> CurrentTime["now()"]\n    CurrentTime --> Compare{"For each pending lane"}\n    \n    Compare --> CheckTime{"expirationTime > 0<br/>&& expirationTime <= currentTime?"}\n    CheckTime -->|"Yes"| MarkExpired["expiredLanes |= lane"]\n    CheckTime -->|"No"| CheckExist{"expirationTime === NoTimestamp?"}\n    \n    CheckExist -->|"Yes"| SetExpire["Set expirationTime =<br/>currentTime + timeout"]\n    CheckExist -->|"No"| Continue["Continue to next lane"]\n    \n    MarkExpired --> Continue\n    SetExpire --> Continue\n```\n\n**Diagram: Expiration Marking Process**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:789-843]()\n\n### Timeout Values\n\n| Lane Type | Timeout (ms) | Constant |\n|-----------|--------------|----------|\n| Sync lanes | 250 | `syncLaneExpirationMs` |\n| Transition lanes | 5000 | `transitionLaneExpirationMs` |\n| Retry lanes | 5000 | `retryLaneExpirationMs` |\n\nSources: [packages/shared/ReactFeatureFlags.js]() (referenced in [packages/react-reconciler/src/ReactFiberLane.js:22-28]())\n\n## Transitions and Deferred Updates\n\n### Transition Lane Characteristics\n\nTransitions use a dedicated pool of 16 lanes with special properties:\n\n1. **Interruptible**: Can be interrupted by higher-priority updates\n2. **Deferrable**: Use `useDeferredValue` to defer derived values\n3. **Suspense-aware**: Show loading states for longer waits\n4. **Batched**: Multiple transitions can be in flight simultaneously\n\n```mermaid\ngraph TD\n    StartTransition["startTransition(callback)"]\n    StartTransition --> SetTransition["Set ReactSharedInternals.T = {transition object}"]\n    SetTransition --> Callback["Execute callback()"]\n    \n    Callback --> SetState["setState() called"]\n    SetState --> RequestLane["requestUpdateLane(fiber)"]\n    RequestLane --> CheckTransition{"ReactSharedInternals.T !== null?"}\n    CheckTransition -->|"Yes"| ClaimLane["claimNextTransitionLane()"]\n    CheckTransition -->|"No"| EventLane["eventPriorityToLane()"]\n    \n    ClaimLane --> TransitionWork["Schedule as TransitionLane"]\n    EventLane --> NormalWork["Schedule as normal lane"]\n```\n\n**Diagram: Transition Update Flow**\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:824-843](), [packages/react-reconciler/src/ReactFiberRootScheduler.js:206-271]()\n\n### Deferred Lane Allocation\n\nThe `requestDeferredLane()` function allocates lanes for `useDeferredValue`:\n\n```\nrequestDeferredLane(): Lane\n   Check if already allocated: workInProgressDeferredLane\n   If prerendering: return OffscreenLane\n   Otherwise: claimNextTransitionDeferredLane()\n   Mark Suspense boundary with DidDefer flag\n```\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:863-900]()\n\n## Concurrent Rendering and Preemption\n\nThe scheduler checks if work should yield based on lane priority:\n\n```mermaid\ngraph TD\n    Rendering["Rendering fiber tree"]\n    Rendering --> CheckYield{"shouldYield()?"}\n    \n    CheckYield -->|"No"| Continue["Continue rendering"]\n    CheckYield -->|"Yes"| CheckInterrupt{"Higher priority work?"}\n    \n    CheckInterrupt -->|"Yes"| Interrupt["Interrupt render<br/>Return to work loop"]\n    CheckInterrupt -->|"No"| YieldTime["Yield to browser<br/>Resume later"]\n    \n    Continue --> NextUnit["workLoopConcurrent()"]\n    Interrupt --> Schedule["ensureRootIsScheduled()"]\n    YieldTime --> Schedule\n    \n    Schedule --> NextRender["Restart with new lanes"]\n```\n\n**Diagram: Concurrent Rendering Preemption**\n\nWhen higher-priority lanes arrive during a concurrent render, React interrupts the current work and restarts with the higher priority lanes.\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:2210-2276]()\n\n## Event Priority to Lane Mapping\n\nEvents are classified by priority and mapped to lanes:\n\n```mermaid\ngraph LR\n    subgraph Events["Event Types"]\n        Discrete["Discrete<br/>(click, keypress)"]\n        Continuous["Continuous<br/>(drag, scroll)"]\n        Default["Default<br/>(network, timers)"]\n        Idle["Idle<br/>(analytics)"]\n    end\n    \n    subgraph Priorities["Event Priorities"]\n        DiscretePri["DiscreteEventPriority"]\n        ContinuousPri["ContinuousEventPriority"]\n        DefaultPri["DefaultEventPriority"]\n        IdlePri["IdleEventPriority"]\n    end\n    \n    subgraph Lanes["Lanes"]\n        SyncL["SyncLane"]\n        InputL["InputContinuousLane"]\n        DefaultL["DefaultLane"]\n        IdleL["IdleLane"]\n    end\n    \n    Discrete --> DiscretePri\n    Continuous --> ContinuousPri\n    Default --> DefaultPri\n    Idle --> IdlePri\n    \n    DiscretePri --> SyncL\n    ContinuousPri --> InputL\n    DefaultPri --> DefaultL\n    IdlePri --> IdleL\n```\n\n**Diagram: Event to Lane Priority Mapping**\n\nSources: [packages/react-reconciler/src/ReactEventPriorities.js:14-83](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:846]()\n\n## Lane Debugging and Introspection\n\nFor development and profiling, lanes can be converted to human-readable labels:\n\n| Function | Purpose |\n|----------|---------|\n| `getLabelForLane(lane)` | Returns string label like "Sync", "Transition", "Retry" |\n| `getGroupNameOfHighestPriorityLane(lanes)` | Returns priority group: "Blocking", "Transition", "Idle" |\n| `checkIfRootIsPrerendering(root)` | Checks if root is prerendering (OffscreenLane) |\n\nThese functions are used by React DevTools and performance tracking to display which priority level is being worked on.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:1287-1412]()\n\n## Implementation Details\n\n### Key Data Structures\n\n**FiberRoot Lane Fields:**\n```\ntype FiberRoot = {\n  pendingLanes: Lanes,              // All scheduled work\n  suspendedLanes: Lanes,            // Work blocked on Suspense\n  pingedLanes: Lanes,               // Suspense resolved, ready to retry\n  expiredLanes: Lanes,              // Expired (must complete)\n  finishedLanes: Lanes,             // Just committed\n  entangledLanes: Lanes,            // Must render together\n  entanglements: LaneMap<Lanes>,    // Per-lane entanglements\n  expirationTimes: LaneMap<number>, // Expiration timestamps\n  hiddenUpdates: LaneMap<Array<ConcurrentUpdate>>, // Offscreen updates\n  ...\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberRoot.js:87-173]()\n\n### Critical Functions Reference\n\n| Function | Location | Purpose |\n|----------|----------|---------|\n| `getNextLanes()` | [ReactFiberLane.js:544-697]() | Select next lanes to render |\n| `requestUpdateLane()` | [ReactFiberWorkLoop.js:803-847]() | Determine lane for update |\n| `markRootUpdated()` | [ReactFiberLane.js:845-877]() | Mark new work on root |\n| `markRootSuspended()` | [ReactFiberLane.js:879-917]() | Mark lanes as suspended |\n| `markRootPinged()` | [ReactFiberLane.js:919-949]() | Mark suspended lanes ready |\n| `markStarvedLanesAsExpired()` | [ReactFiberLane.js:789-843]() | Expire starved lanes |\n| `includesBlockingLane()` | [ReactFiberLane.js:244-246]() | Check for blocking work |\n| `claimNextTransitionLane()` | [ReactFiberRootScheduler.js:253-271]() | Allocate transition lane |\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:1-1412](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1-3095]()\n\n---\n\n# Page: Suspense and Error Boundaries\n\n# Suspense and Error Boundaries\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberOffscreenComponent.js](packages/react-reconciler/src/ReactFiberOffscreenComponent.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes how React handles asynchronous operations and errors during rendering through two key mechanisms: **Suspense boundaries** and **Error boundaries**. Suspense boundaries enable components to declaratively wait for asynchronous data by catching thrown promises and rendering fallback UI. Error boundaries catch JavaScript errors anywhere in their child component tree and display fallback UI instead of crashing the entire application.\n\nFor information about hydration of server-rendered Suspense boundaries, see [Hydration System](#6.3). For details on how Suspense integrates with Server Components and streaming SSR, see [React Fizz (Streaming SSR)](#5.1).\n\n---\n\n## Overview: Two Boundary Types\n\nReact provides two types of boundaries that interrupt normal rendering flow:\n\n| Boundary Type | Catches | Defined By | Triggers |\n|--------------|---------|------------|----------|\n| **Suspense Boundary** | Thrown promises (async operations) | `<Suspense>` component with `fallback` prop | Components throw promises during render |\n| **Error Boundary** | JavaScript errors | Class components with `componentDidCatch` or `getDerivedStateFromError` | Errors thrown during render, lifecycle methods, or event handlers |\n\nBoth boundaries share similar mechanics for capturing exceptions during render phase and unwinding the fiber tree, but differ in what they catch and how they recover.\n\nSources: [packages/react-reconciler/src/ReactFiberBeginWork.js:1-100](), [packages/react-reconciler/src/ReactFiberClassComponent.js:1-50]()\n\n---\n\n## Suspense Boundaries\n\n### Suspense Component Structure\n\nA Suspense boundary is created using the `<Suspense>` component which accepts `fallback` and `children` props:\n\n```javascript\n<Suspense fallback={<LoadingSpinner />}>\n  <AsyncComponent />\n</Suspense>\n```\n\nInternally, Suspense is represented by the `SuspenseComponent` work tag and maintains state via `SuspenseState`:\n\n```typescript\ntype SuspenseState = {\n  dehydrated: null | SuspenseInstance,  // Non-null if SSR dehydrated\n  retryLane: Lane,                       // Lane to retry rendering\n  treeContext: TreeContext | null,       // Tree context for hydration\n  ...\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberSuspenseComponent.js:24-36](), [packages/react-reconciler/src/ReactWorkTags.js:70]()\n\n### How Suspense Works\n\n```mermaid\ngraph TB\n    Render["Component Render<br/>(beginWork)"]\n    ThrowPromise["Throw Promise<br/>Component suspends"]\n    ThrowException["throwException()<br/>ReactFiberThrow"]\n    FindBoundary["Find Suspense Boundary<br/>Walk up fiber tree"]\n    SetFlags["Set ShouldCapture flag<br/>on boundary fiber"]\n    Unwind["unwindWork()<br/>Pop contexts"]\n    ReRender["Re-render boundary<br/>with fallback"]\n    ShowFallback["Display fallback UI"]\n    PromiseResolve["Promise resolves"]\n    Ping["Ping boundary<br/>scheduleUpdateOnFiber"]\n    RetryRender["Retry with RetryLane<br/>Render children again"]\n    ShowContent["Display content"]\n    \n    Render --> ThrowPromise\n    ThrowPromise --> ThrowException\n    ThrowException --> FindBoundary\n    FindBoundary --> SetFlags\n    SetFlags --> Unwind\n    Unwind --> ReRender\n    ReRender --> ShowFallback\n    ShowFallback --> PromiseResolve\n    PromiseResolve --> Ping\n    Ping --> RetryRender\n    RetryRender --> ShowContent\n```\n\n**Suspense Flow Steps:**\n\n1. **Component Throws Promise**: During render, a component reads async data and throws a promise if data isn\'t ready\n2. **Catch in Work Loop**: The work loop catches the thrown value in `handleThrow` ([packages/react-reconciler/src/ReactFiberWorkLoop.js:1800-1900]())\n3. **throwException**: Identifies what was thrown and finds the nearest Suspense boundary ([packages/react-reconciler/src/ReactFiberThrow.js:1-100]())\n4. **Mark Boundary**: Sets `ShouldCapture` flag on the Suspense boundary fiber ([packages/react-reconciler/src/ReactFiberBeginWork.js:3800-3900]())\n5. **Unwind Stack**: Unwinds the fiber tree via `unwindWork`, popping contexts and checking each fiber for `ShouldCapture` ([packages/react-reconciler/src/ReactFiberUnwindWork.js:156-183]())\n6. **Convert to DidCapture**: When unwinding reaches the Suspense boundary, converts `ShouldCapture` to `DidCapture` flag ([packages/react-reconciler/src/ReactFiberUnwindWork.js:170-180]())\n7. **Re-render with Fallback**: Re-renders the Suspense boundary which now shows fallback instead of children ([packages/react-reconciler/src/ReactFiberBeginWork.js:3800-4000]())\n8. **Attach Listener**: Attaches a ping listener to the thrown promise via `attachPingListener` ([packages/react-reconciler/src/ReactFiberThrow.js:400-500]())\n9. **Promise Resolves**: When the promise resolves, the ping callback triggers `retryDehydratedSuspenseBoundary` or schedules an update\n10. **Retry Render**: Re-renders at a retry lane, attempting to render children again ([packages/react-reconciler/src/ReactFiberWorkLoop.js:2000-2100]())\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1800-2000](), [packages/react-reconciler/src/ReactFiberThrow.js:1-500](), [packages/react-reconciler/src/ReactFiberUnwindWork.js:156-183]()\n\n### Suspense Context and Handler Stack\n\nReact maintains a `SuspenseContext` stack to track which Suspense boundaries are active during rendering:\n\n```mermaid\ngraph TB\n    subgraph "Suspense Context Stack"\n        Root["Root (no handler)"]\n        Outer["Outer Suspense Boundary<br/>pushPrimaryTreeSuspenseHandler"]\n        Inner["Inner Suspense Boundary<br/>pushPrimaryTreeSuspenseHandler"]\n    end\n    \n    GetHandler["getSuspenseHandler()<br/>Returns current boundary"]\n    Component["Component throws promise"]\n    FindBoundary["throwException finds handler<br/>via getSuspenseHandler()"]\n    \n    Root --> Outer\n    Outer --> Inner\n    Inner -.-> GetHandler\n    Component --> FindBoundary\n    FindBoundary -.-> GetHandler\n```\n\nKey functions for managing Suspense context:\n\n- `pushPrimaryTreeSuspenseHandler(workInProgress)` - Pushes a new Suspense boundary onto the stack ([packages/react-reconciler/src/ReactFiberSuspenseContext.js:100-150]())\n- `pushFallbackTreeSuspenseHandler(workInProgress)` - Pushes when rendering fallback tree\n- `popSuspenseHandler(workInProgress)` - Pops the handler when leaving a Suspense boundary\n- `getSuspenseHandler()` - Returns the current innermost Suspense boundary ([packages/react-reconciler/src/ReactFiberSuspenseContext.js:200-250]())\n\nSources: [packages/react-reconciler/src/ReactFiberSuspenseContext.js:1-300](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3700-3800]()\n\n### Retry Mechanism and Lanes\n\nWhen a promise resolves, React needs to retry rendering the suspended tree. This is managed via **retry lanes**:\n\n```mermaid\ngraph LR\n    Suspend["Component Suspends<br/>Shows fallback"]\n    AttachPing["Attach ping listener<br/>to promise"]\n    PromiseResolve["Promise resolves"]\n    PingCallback["pingCallback invoked"]\n    ClaimRetryLane["claimNextRetryLane()<br/>Assigns RetryLane"]\n    ScheduleUpdate["scheduleUpdateOnFiber<br/>with RetryLane"]\n    RenderRoot["performWorkOnRoot<br/>renders at RetryLane"]\n    AttemptRender["Attempt to render<br/>children again"]\n    \n    Suspend --> AttachPing\n    AttachPing --> PromiseResolve\n    PromiseResolve --> PingCallback\n    PingCallback --> ClaimRetryLane\n    ClaimRetryLane --> ScheduleUpdate\n    ScheduleUpdate --> RenderRoot\n    RenderRoot --> AttemptRender\n```\n\n**Key components:**\n\n- `RetryQueue`: Stored on `workInProgress.updateQueue` for Suspense boundaries, contains `Wakeable` (promises) being tracked ([packages/react-reconciler/src/ReactFiberSuspenseComponent.js:100-120]())\n- `claimNextRetryLane()`: Assigns a specific retry lane from the `RetryLanes` bitmask ([packages/react-reconciler/src/ReactFiberLane.js:850-900]())\n- `attachPingListener()`: Attaches callback to promise that will schedule an update when resolved ([packages/react-reconciler/src/ReactFiberThrow.js:400-500]())\n- `retryDehydratedSuspenseBoundary()`: Schedules a retry for dehydrated boundaries ([packages/react-reconciler/src/ReactFiberWorkLoop.js:1200-1300]())\n\nSources: [packages/react-reconciler/src/ReactFiberSuspenseComponent.js:100-150](), [packages/react-reconciler/src/ReactFiberLane.js:850-900](), [packages/react-reconciler/src/ReactFiberThrow.js:400-500]()\n\n### Suspended Reasons\n\nThe work loop tracks why rendering is suspended via `workInProgressSuspendedReason`:\n\n| Reason | Value | Description |\n|--------|-------|-------------|\n| `NotSuspended` | 0 | Not currently suspended |\n| `SuspendedOnError` | 1 | Suspended due to an error |\n| `SuspendedOnData` | 2 | Suspended waiting for data (promise) |\n| `SuspendedOnImmediate` | 3 | Suspended on immediate priority |\n| `SuspendedOnInstance` | 4 | Suspended on resource instance |\n| `SuspendedOnInstanceAndReadyToContinue` | 5 | Instance ready, can continue |\n| `SuspendedOnDeprecatedThrowPromise` | 6 | Legacy throw promise |\n| `SuspendedAndReadyToContinue` | 7 | Suspended but ready to continue |\n| `SuspendedOnHydration` | 8 | Suspended during hydration |\n| `SuspendedOnAction` | 9 | Suspended on async action |\n\nThese reasons determine how the work loop handles the suspension and whether to unwind immediately or continue.\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:431-441]()\n\n---\n\n## Error Boundaries\n\n### Defining Error Boundaries\n\nError boundaries are class components that implement one or both of these lifecycle methods:\n\n```javascript\nclass ErrorBoundary extends React.Component {\n  static getDerivedStateFromError(error) {\n    // Update state to show fallback UI\n    return { hasError: true };\n  }\n\n  componentDidCatch(error, errorInfo) {\n    // Log error to error reporting service\n    logErrorToService(error, errorInfo);\n  }\n\n  render() {\n    if (this.state.hasError) {\n      return <h1>Something went wrong.</h1>;\n    }\n    return this.props.children;\n  }\n}\n```\n\n**Key characteristics:**\n- Must be class components (function components cannot be error boundaries)\n- `getDerivedStateFromError`: Static method called during render phase to update state\n- `componentDidCatch`: Instance method called during commit phase for side effects\n- Only catches errors in child components, not in the boundary itself\n\nSources: [packages/react-reconciler/src/ReactFiberClassComponent.js:1-100]()\n\n### Error Capture Flow\n\n```mermaid\ngraph TB\n    Render["Component Render"]\n    ThrowError["Error thrown"]\n    Catch["Work loop catches error<br/>handleThrow()"]\n    ThrowException["throwException()<br/>Classify error"]\n    WalkTree["Walk up fiber tree<br/>Find error boundary"]\n    FindBoundary{"Class with error<br/>lifecycle methods?"}\n    CreateUpdate["createClassErrorUpdate()<br/>Create error update"]\n    SetFlags["Set ShouldCapture flag<br/>on boundary"]\n    Unwind["unwindWork()<br/>Unwind to boundary"]\n    ConvertFlag["Convert ShouldCapture<br/>to DidCapture"]\n    ApplyUpdate["Process update queue<br/>Call getDerivedStateFromError"]\n    ReRender["Re-render boundary<br/>Shows fallback UI"]\n    CommitPhase["Commit phase"]\n    CallDidCatch["Call componentDidCatch<br/>with error info"]\n    \n    Render --> ThrowError\n    ThrowError --> Catch\n    Catch --> ThrowException\n    ThrowException --> WalkTree\n    WalkTree --> FindBoundary\n    FindBoundary -->|Yes| CreateUpdate\n    FindBoundary -->|No| WalkTree\n    CreateUpdate --> SetFlags\n    SetFlags --> Unwind\n    Unwind --> ConvertFlag\n    ConvertFlag --> ApplyUpdate\n    ApplyUpdate --> ReRender\n    ReRender --> CommitPhase\n    CommitPhase --> CallDidCatch\n```\n\n**Error Boundary Flow:**\n\n1. **Error Occurs**: An error is thrown during render, lifecycle method, or event handler\n2. **Catch in Work Loop**: The work loop catches the error in `handleThrow` ([packages/react-reconciler/src/ReactFiberWorkLoop.js:1800-1900]())\n3. **throwException**: Examines the error and walks up the fiber tree to find an error boundary ([packages/react-reconciler/src/ReactFiberThrow.js:200-400]())\n4. **Identify Boundary**: Looks for class components with `getDerivedStateFromError` or `componentDidCatch` ([packages/react-reconciler/src/ReactFiberThrow.js:250-350]())\n5. **Create Error Update**: Calls `createClassErrorUpdate` to create an update on the boundary\'s queue ([packages/react-reconciler/src/ReactFiberThrow.js:300-350]())\n6. **Set ShouldCapture**: Marks the error boundary fiber with `ShouldCapture` flag\n7. **Unwind**: Unwinds the stack via `unwindWork`, checking each fiber for `ShouldCapture` ([packages/react-reconciler/src/ReactFiberUnwindWork.js:77-93]())\n8. **Convert to DidCapture**: When unwinding reaches the error boundary, converts `ShouldCapture` to `DidCapture` ([packages/react-reconciler/src/ReactFiberUnwindWork.js:83-91]())\n9. **Process Update**: During re-render, processes the error update and calls `getDerivedStateFromError` ([packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:200-300]())\n10. **Render Fallback**: Re-renders the boundary with updated state showing fallback UI\n11. **Commit Phase**: During commit, calls `componentDidCatch` with error and error info ([packages/react-reconciler/src/ReactFiberCommitWork.js:1000-1100]())\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1800-1900](), [packages/react-reconciler/src/ReactFiberThrow.js:200-400](), [packages/react-reconciler/src/ReactFiberUnwindWork.js:77-93]()\n\n### Error Boundary Detection\n\nError boundaries are identified by checking for specific static and instance methods:\n\n```mermaid\ngraph LR\n    Fiber["Class Component Fiber"]\n    CheckType["Check ctor.getDerivedStateFromError"]\n    CheckInstance["Check instance.componentDidCatch"]\n    IsErrorBoundary{"Has error<br/>lifecycle?"}\n    Capture["Can capture errors"]\n    Skip["Skip, not error boundary"]\n    \n    Fiber --> CheckType\n    CheckType --> IsErrorBoundary\n    CheckInstance --> IsErrorBoundary\n    IsErrorBoundary -->|Yes| Capture\n    IsErrorBoundary -->|No| Skip\n```\n\nCode logic in `throwException`:\n\n```javascript\n// Check if this is a class component error boundary\nif (\n  sourceFiber.tag === ClassComponent &&\n  (ctor.getDerivedStateFromError !== undefined ||\n   (instance !== null && \n    typeof instance.componentDidCatch === \'function\'))\n) {\n  // This is an error boundary\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberThrow.js:250-350]()\n\n---\n\n## Throwing and Capturing Mechanism\n\n### throwException Function\n\nThe `throwException` function in `ReactFiberThrow.js` is the central dispatcher that handles both promises (Suspense) and errors (Error Boundaries):\n\n```mermaid\ngraph TB\n    ThrowException["throwException(root, returnFiber, sourceFiber, value)"]\n    CheckValue{"Check value type"}\n    IsPromise["Is Wakeable/Promise?"]\n    IsError["Is Error?"]\n    IsSuspenseException["Is SuspenseException?"]\n    HandleSuspense["Handle Suspense<br/>Find Suspense boundary<br/>Attach ping listener"]\n    HandleError["Handle Error<br/>Find Error boundary<br/>Create error update"]\n    HandleSpecial["Handle SuspenseException<br/>Special suspension handling"]\n    SetFlags["Set ShouldCapture flags<br/>on boundaries"]\n    \n    ThrowException --> CheckValue\n    CheckValue --> IsPromise\n    CheckValue --> IsError\n    CheckValue --> IsSuspenseException\n    IsPromise --> HandleSuspense\n    IsError --> HandleError\n    IsSuspenseException --> HandleSpecial\n    HandleSuspense --> SetFlags\n    HandleError --> SetFlags\n    HandleSpecial --> SetFlags\n```\n\n**Key responsibilities:**\n\n1. **Type Detection**: Determines whether the thrown value is a promise, error, or special exception type\n2. **Boundary Search**: Walks up the fiber tree from `sourceFiber` to find appropriate boundary\n3. **Flag Setting**: Marks boundaries with `ShouldCapture` flag to trigger unwinding\n4. **Listener Attachment**: For promises, attaches ping listeners for retry when resolved\n5. **Update Creation**: For errors, creates updates on error boundary components\n\nSources: [packages/react-reconciler/src/ReactFiberThrow.js:1-600]()\n\n### Fiber Flags for Capture\n\nReact uses specific flags to coordinate the capture and unwinding process:\n\n| Flag | Value | Description |\n|------|-------|-------------|\n| `ShouldCapture` | Bit flag | Marks that a fiber should capture an error/suspense |\n| `DidCapture` | Bit flag | Marks that a fiber has captured and is showing fallback |\n| `ForceClientRender` | Bit flag | Forces client-side render (hydration failure) |\n\n**Flag transitions during unwinding:**\n\n```mermaid\nstateDiagram-v2\n    [*] --> NoFlags: Normal render\n    NoFlags --> ShouldCapture: Error/Suspense thrown\n    ShouldCapture --> DidCapture: Unwinding reaches boundary\n    DidCapture --> NoFlags: Retry/recovery\n    ShouldCapture --> NoFlags: Unwinding complete (no capture)\n```\n\nThe `unwindWork` function checks and transforms these flags:\n\n```javascript\nconst flags = workInProgress.flags;\nif (flags & ShouldCapture) {\n  workInProgress.flags = (flags & ~ShouldCapture) | DidCapture;\n  // Return this fiber to re-render with fallback\n  return workInProgress;\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberFlags.js:1-200](), [packages/react-reconciler/src/ReactFiberUnwindWork.js:66-200]()\n\n### Unwinding the Fiber Tree\n\nWhen an error or promise is caught, React must unwind the fiber tree to the nearest boundary. The `unwindWork` function handles this:\n\n```mermaid\ngraph TB\n    ThrowCaught["Exception caught in work loop"]\n    StartUnwind["Begin unwinding"]\n    CheckFiber["Process current fiber<br/>unwindWork()"]\n    PopContexts["Pop contexts<br/>(Host, Suspense, etc.)"]\n    CheckFlags{"Has ShouldCapture<br/>flag?"}\n    ConvertFlags["Convert to DidCapture<br/>Return fiber"]\n    MoveUp["Move to parent fiber<br/>workInProgress.return"]\n    ReachedRoot{"Reached root?"}\n    HandleRootError["Handle uncaught error<br/>at root level"]\n    ReRenderBoundary["Re-render boundary<br/>with fallback"]\n    \n    ThrowCaught --> StartUnwind\n    StartUnwind --> CheckFiber\n    CheckFiber --> PopContexts\n    PopContexts --> CheckFlags\n    CheckFlags -->|Yes| ConvertFlags\n    CheckFlags -->|No| MoveUp\n    ConvertFlags --> ReRenderBoundary\n    MoveUp --> ReachedRoot\n    ReachedRoot -->|No| CheckFiber\n    ReachedRoot -->|Yes| HandleRootError\n```\n\nKey operations during unwinding:\n\n1. **Pop Contexts**: Each fiber type pops its associated contexts (host context, suspense context, cache context, etc.)\n2. **Check Capture Flag**: Examines whether `ShouldCapture` flag is set\n3. **Transform Flag**: Converts `ShouldCapture` to `DidCapture` for boundaries that will handle the exception\n4. **Transfer Duration**: For profiling, transfers actual duration to parent if in profile mode\n5. **Return Fiber**: Returns the boundary fiber to re-render, or null to continue unwinding\n\nThe `unwindWork` function is called for each fiber type during unwinding:\n\n- **ClassComponent**: Pops legacy context if context provider ([packages/react-reconciler/src/ReactFiberUnwindWork.js:77-93]())\n- **HostRoot**: Pops all root-level contexts ([packages/react-reconciler/src/ReactFiberUnwindWork.js:95-118]())\n- **SuspenseComponent**: Pops suspense handler and checks for dehydrated boundaries ([packages/react-reconciler/src/ReactFiberUnwindWork.js:156-183]())\n- **SuspenseListComponent**: Pops suspense list context ([packages/react-reconciler/src/ReactFiberUnwindWork.js:184-194]())\n\nSources: [packages/react-reconciler/src/ReactFiberUnwindWork.js:66-250]()\n\n---\n\n## Integration with Work Loop\n\n### Handling Throws in performWorkOnRoot\n\nThe main work loop integrates error and suspense handling via `handleThrow`:\n\n```mermaid\ngraph TB\n    PerformWork["performWorkOnRoot(root, lanes)"]\n    PrepareFresh["prepareFreshStack(root, lanes)"]\n    WorkLoop["workLoopSync() or<br/>workLoopConcurrent()"]\n    BeginWork["beginWork(current, workInProgress, lanes)"]\n    ThrowOccurs["Exception thrown"]\n    CatchBlock["try/catch block"]\n    HandleThrow["handleThrow(root, thrownValue)"]\n    ClassifyError["Classify thrown value<br/>Error vs Promise vs Special"]\n    ThrowException["throwException(root, returnFiber,<br/>sourceFiber, thrownValue)"]\n    UnwindLoop["Start unwinding loop"]\n    CompleteUnitOfWork["completeUnitOfWork() or<br/>continue work loop"]\n    \n    PerformWork --> PrepareFresh\n    PrepareFresh --> WorkLoop\n    WorkLoop --> BeginWork\n    BeginWork --> ThrowOccurs\n    ThrowOccurs --> CatchBlock\n    CatchBlock --> HandleThrow\n    HandleThrow --> ClassifyError\n    ClassifyError --> ThrowException\n    ThrowException --> UnwindLoop\n    UnwindLoop --> CompleteUnitOfWork\n```\n\nThe work loop wraps rendering in try/catch:\n\n```javascript\ndo {\n  try {\n    workLoopSync(); // or workLoopConcurrent()\n    break;\n  } catch (thrownValue) {\n    handleThrow(root, thrownValue);\n  }\n} while (true);\n```\n\nThe `handleThrow` function:\n\n1. Sets `workInProgressSuspendedReason` based on thrown value type\n2. Stores `workInProgressThrownValue` for later processing\n3. Calls `throwException` to find and mark boundaries\n4. Initiates the unwinding process\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1700-2000]()\n\n### Retry and Ping Mechanism\n\nWhen a suspended boundary is ready to retry (promise resolved), React uses the ping mechanism:\n\n```mermaid\nsequenceDiagram\n    participant C as Component\n    participant P as Promise\n    participant L as Ping Listener\n    participant S as Scheduler\n    participant WL as Work Loop\n    participant B as Suspense Boundary\n    \n    C->>P: Throw promise\n    WL->>P: Attach ping listener\n    Note over P,L: attachPingListener(root, wakeable, lanes)\n    P->>P: Promise resolves\n    P->>L: Call ping callback\n    L->>S: scheduleUpdateOnFiber(root, fiber, lane)\n    S->>WL: Schedule work at RetryLane\n    WL->>B: Re-render boundary\n    B->>C: Retry rendering component\n    C->>C: Data available, render succeeds\n```\n\n**Ping callback implementation:**\n\n```javascript\nfunction attachPingListener(root, wakeable, lanes) {\n  let pingCache = root.pingCache;\n  let threadIDs;\n  if (pingCache === null) {\n    pingCache = root.pingCache = new PossiblyWeakMap();\n    threadIDs = new Set();\n    pingCache.set(wakeable, threadIDs);\n  } else {\n    threadIDs = pingCache.get(wakeable);\n    if (threadIDs === undefined) {\n      threadIDs = new Set();\n      pingCache.set(wakeable, threadIDs);\n    }\n  }\n  \n  if (!threadIDs.has(lanes)) {\n    threadIDs.add(lanes);\n    let ping = pingSuspendedRoot.bind(null, root, wakeable, lanes);\n    wakeable.then(ping, ping);\n  }\n}\n```\n\nThe `pingSuspendedRoot` callback schedules an update at the retry lane, triggering a re-render of the suspended tree.\n\nSources: [packages/react-reconciler/src/ReactFiberThrow.js:400-500](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1000-1100]()\n\n---\n\n## Dehydrated Suspense Boundaries\n\nDuring Server-Side Rendering (SSR), Suspense boundaries can be rendered in a "dehydrated" state where the server sends placeholder markers instead of waiting for all async data. The client then "hydrates" these boundaries by matching them with real DOM nodes.\n\n### Dehydrated State Structure\n\n```mermaid\ngraph TB\n    subgraph "Server-Rendered HTML"\n        Comment1["<!-- $? --> Start marker"]\n        Fallback["Fallback UI (initially hidden)"]\n        Comment2["<!-- /$? --> End marker"]\n    end\n    \n    subgraph "SuspenseState"\n        Dehydrated["dehydrated: SuspenseInstance"]\n        RetryLane["retryLane: Lane"]\n        TreeContext["treeContext: TreeContext"]\n    end\n    \n    Comment1 -.-> Dehydrated\n    Comment2 -.-> Dehydrated\n    Dehydrated --> RetryLane\n    Dehydrated --> TreeContext\n```\n\n**Key functions for dehydrated boundaries:**\n\n- `isSuspenseInstancePending(instance)`: Checks if dehydrated boundary is still waiting\n- `isSuspenseInstanceFallback(instance)`: Checks if showing fallback\n- `reenterHydrationStateFromDehydratedSuspenseInstance()`: Re-enters hydration mode for dehydrated content ([packages/react-reconciler/src/ReactFiberHydrationContext.js:400-500]())\n\nDuring hydration, when React encounters a dehydrated Suspense boundary:\n\n1. **Detect Marker**: Identifies the `<!-- $? -->` comment marker in the DOM\n2. **Store Instance**: Stores the `SuspenseInstance` in `SuspenseState.dehydrated`\n3. **Skip Children**: Skips hydrating children initially (they\'re not yet in the DOM)\n4. **Wait for Data**: Waits for server to stream the actual content\n5. **Hydrate on Arrival**: When content arrives, hydrates the real DOM nodes\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:1-500](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3900-4100]()\n\n---\n\n## Error Boundary Lifecycle Methods\n\n### getDerivedStateFromError\n\nStatic method called during the render phase to update state in response to an error:\n\n```javascript\nstatic getDerivedStateFromError(error: Error): PartialState {\n  return { hasError: true, error };\n}\n```\n\n**Characteristics:**\n- Called during render phase (can be called multiple times)\n- Must be pure and have no side effects\n- Returns state update or null\n- Called before `componentDidCatch`\n\n**Processing in update queue:**\n\nWhen an error is caught, React creates an error update with tag `CaptureUpdate`:\n\n```javascript\nfunction createClassErrorUpdate(fiber, errorInfo, lane) {\n  const update = createUpdate(lane);\n  update.tag = CaptureUpdate;\n  update.payload = {element: null};\n  \n  const error = errorInfo.value;\n  update.callback = function() {\n    // This will be called after getDerivedStateFromError\n    onUncaughtError(error);\n  };\n  return update;\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberThrow.js:100-200](), [packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:100-200]()\n\n### componentDidCatch\n\nInstance method called during the commit phase for side effects:\n\n```javascript\ncomponentDidCatch(error: Error, errorInfo: {componentStack: string}) {\n  // Side effects like logging\n  logErrorToMyService(error, errorInfo);\n}\n```\n\n**Characteristics:**\n- Called during commit phase (effects phase)\n- Can have side effects (logging, analytics, etc.)\n- Receives error and errorInfo with component stack\n- Called after render is committed\n- Not called if boundary is unmounting\n\n**Invocation during commit:**\n\n```javascript\nfunction commitClassLifecycles(finishedWork, current) {\n  const instance = finishedWork.stateNode;\n  if (finishedWork.flags & DidCapture) {\n    // Error was caught, call componentDidCatch\n    if (typeof instance.componentDidCatch === \'function\') {\n      const error = /* error from update queue */;\n      const errorInfo = createCapturedValueFromError(error);\n      instance.componentDidCatch(error, errorInfo);\n    }\n  }\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberCommitWork.js:800-1000](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:200-400]()\n\n---\n\n## Advanced: Multiple Nested Boundaries\n\nReact can have multiple nested Suspense boundaries and error boundaries, each catching exceptions at different levels:\n\n```mermaid\ngraph TB\n    Root["Root"]\n    ErrorBoundary["Error Boundary"]\n    OuterSuspense["Outer Suspense"]\n    InnerSuspense["Inner Suspense"]\n    Component["Component"]\n    \n    Root --> ErrorBoundary\n    ErrorBoundary --> OuterSuspense\n    OuterSuspense --> InnerSuspense\n    InnerSuspense --> Component\n    \n    Component -.->|Throws promise| InnerSuspense\n    Component -.->|Throws error| ErrorBoundary\n    InnerSuspense -.->|If suspends| OuterSuspense\n```\n\n**Boundary selection rules:**\n\n1. **Innermost First**: Always captures at the nearest boundary\n2. **Type Matters**: Suspense catches promises, Error Boundaries catch errors\n3. **Fallback Hiding**: Outer boundaries can hide inner boundaries\' fallback if outer also suspends\n4. **Throttling**: React throttles showing multiple fallbacks to avoid UI flickering ([packages/react-reconciler/src/ReactFiberWorkLoop.js:500-520]())\n\n### Suspense List Coordination\n\n`<SuspenseList>` coordinates the reveal order of multiple Suspense boundaries:\n\n```javascript\n<SuspenseList revealOrder="forwards">\n  <Suspense fallback={<Spinner />}>\n    <Item1 />\n  </Suspense>\n  <Suspense fallback={<Spinner />}>\n    <Item2 />\n  </Suspense>\n  <Suspense fallback={<Spinner />}>\n    <Item3 />\n  </Suspense>\n</SuspenseList>\n```\n\nThe `SuspenseListComponent` maintains `SuspenseListRenderState` to track which children are suspended and control reveal order.\n\nSources: [packages/react-reconciler/src/ReactFiberSuspenseComponent.js:150-250](), [packages/react-reconciler/src/ReactFiberBeginWork.js:4100-4300]()\n\n---\n\n## Performance Considerations\n\n### Fallback Throttling\n\nTo prevent UI flickering from rapid fallback showing/hiding, React implements throttling:\n\n```javascript\nconst FALLBACK_THROTTLE_MS = 300;\n```\n\nIf a Suspense boundary suspends, React waits 300ms before showing the fallback, hoping the promise will resolve quickly.\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:514]()\n\n### Retry Lane Priority\n\nRetry lanes are lower priority than user-blocking updates but higher than idle work:\n\n```javascript\nconst RetryLanes = 0b0000011110000000000000000000000;\n```\n\nThis ensures retries happen promptly but don\'t block urgent user interactions.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:93-99]()\n\n### Error Boundary Re-render Optimization\n\nAfter catching an error, React skips rendering the error boundary\'s children and goes straight to the fallback, avoiding wasted work.\n\nSources: [packages/react-reconciler/src/ReactFiberBeginWork.js:1200-1300]()\n\n---\n\n# Page: Host Configuration Abstraction\n\n# Host Configuration Abstraction\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n\n</details>\n\n\n\nThe Host Configuration abstraction is React\'s platform adaptation layer that enables the reconciler to target different rendering environments (DOM, React Native, canvas, terminal, etc.) through a consistent interface. Each renderer implements a host config that translates React\'s universal operations into platform-specific actions.\n\nFor information about the reconciler\'s work loop and rendering phases, see [4.2](#4.2). For platform-specific implementations like React DOM and hydration, see [6.1](#6.1) and [6.3](#6.3).\n\n## Host Config Interface\n\nThe host config defines a contract between the reconciler and the host platform. Renderers provide implementations by passing a configuration object to `react-reconciler` which acts as a factory function wrapping the reconciler code.\n\n### Core Configuration Structure\n\n```mermaid\ngraph TB\n    Reconciler["react-reconciler<br/>(ReactFiberWorkLoop)"]\n    CustomConfig["ReactFiberConfig.custom.js<br/>Interface Definition"]\n    \n    subgraph "Platform Implementations"\n        DOMConfig["ReactFiberConfigDOM.js<br/>DOM Renderer"]\n        FabricConfig["ReactFiberConfigFabric.js<br/>RN Fabric"]\n        NativeConfig["ReactFiberConfigNative.js<br/>RN Legacy"]\n        NoopConfig["createReactNoop.js<br/>Test Renderer"]\n        TestConfig["ReactFiberConfigTestHost.js<br/>Test Renderer"]\n        ARTConfig["ReactFiberConfigART.js<br/>ART Renderer"]\n    end\n    \n    Reconciler -->|"uses via $$$config"| CustomConfig\n    CustomConfig -.->|"implemented by"| DOMConfig\n    CustomConfig -.->|"implemented by"| FabricConfig\n    CustomConfig -.->|"implemented by"| NativeConfig\n    CustomConfig -.->|"implemented by"| NoopConfig\n    CustomConfig -.->|"implemented by"| TestConfig\n    CustomConfig -.->|"implemented by"| ARTConfig\n```\n\n**Diagram: Host Config Architecture**\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:1-287](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-150](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-82]()\n\n### Essential Host Config Methods\n\nThe host config interface consists of over 100 methods, organized into several categories:\n\n| Category | Required | Example Methods | Purpose |\n|----------|----------|----------------|---------|\n| **Metadata** | Yes | `rendererVersion`, `rendererPackageName`, `isPrimaryRenderer` | Identify the renderer |\n| **Instance Creation** | Yes | `createInstance`, `createTextInstance`, `appendInitialChild` | Build host trees during render |\n| **Context Management** | Yes | `getRootHostContext`, `getChildHostContext` | Track rendering context (e.g., namespace) |\n| **Finalization** | Yes | `finalizeInitialChildren`, `shouldSetTextContent` | Complete initial setup |\n| **Commit Preparation** | Yes | `prepareForCommit`, `resetAfterCommit` | Bracket commit phase |\n| **Public Instance** | Yes | `getPublicInstance` | Expose instances through refs |\n| **Scheduling** | Yes | `scheduleTimeout`, `cancelTimeout`, `now` | Time-based operations |\n| **Priority Management** | Yes | `setCurrentUpdatePriority`, `getCurrentUpdatePriority`, `resolveUpdatePriority` | Manage event priorities |\n| **Mutation** | Optional | `appendChild`, `removeChild`, `commitUpdate`, `commitTextUpdate` | Mutate existing trees |\n| **Persistence** | Optional | `cloneInstance`, `replaceContainerChildren` | Replace trees immutably |\n| **Hydration** | Optional | `canHydrateInstance`, `hydrateInstance`, `getNextHydratableSibling` | Match server-rendered markup |\n| **Resources** | Optional | `supportsResources`, `acquireResource`, `releaseResource` | Manage hoistable resources |\n| **Singletons** | Optional | `supportsSingletons`, `acquireSingletonInstance` | Manage singleton elements |\n| **View Transitions** | Optional | `startViewTransition`, `measureInstance` | Animate state transitions |\n| **Suspense Commit** | Optional | `maySuspendCommit`, `waitForCommitToBeReady` | Delay commits for loading |\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:52-287]()\n\n### Host Config Method Signatures\n\n```mermaid\ngraph LR\n    subgraph "Render Phase"\n        CreateInstance["createInstance()<br/>type, props, rootContainer,<br/>hostContext, handle"]\n        CreateText["createTextInstance()<br/>text, rootContainer,<br/>hostContext, handle"]\n        AppendInitial["appendInitialChild()<br/>parent, child"]\n        Finalize["finalizeInitialChildren()<br/>instance, type, props"]\n    end\n    \n    subgraph "Commit Phase - Mutation"\n        AppendChild["appendChild()<br/>parent, child"]\n        RemoveChild["removeChild()<br/>parent, child"]\n        CommitUpdate["commitUpdate()<br/>instance, type,<br/>oldProps, newProps"]\n        CommitText["commitTextUpdate()<br/>textInstance,<br/>oldText, newText"]\n    end\n    \n    subgraph "Commit Phase - Persistence"\n        CloneInstance["cloneInstance()<br/>instance, type,<br/>oldProps, newProps,<br/>keepChildren, newChildren"]\n        ReplaceChildren["replaceContainerChildren()<br/>container, newChildren"]\n    end\n    \n    CreateInstance --> AppendInitial\n    CreateText --> AppendInitial\n    AppendInitial --> Finalize\n    Finalize -.->|"mutation"| AppendChild\n    Finalize -.->|"persistence"| CloneInstance\n```\n\n**Diagram: Key Host Config Method Flow**\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:61-189]()\n\n## Mutation vs Persistence Modes\n\nReact\'s reconciler supports two modes for applying updates, chosen at compile time through the host config:\n\n### Mutation Mode\n\n**Mode Identifier**: `supportsMutation = true`, `supportsPersistence = false`\n\nIn mutation mode, the reconciler directly modifies existing host instances. This is more memory-efficient but requires the host platform to support in-place updates.\n\n**Required Methods**:\n- `appendChild(parentInstance, child)` - Add child to parent\n- `removeChild(parentInstance, child)` - Remove child from parent\n- `insertBefore(parentInstance, child, beforeChild)` - Insert at position\n- `commitUpdate(instance, type, oldProps, newProps)` - Update instance properties\n- `commitTextUpdate(textInstance, oldText, newText)` - Update text content\n- `resetTextContent(instance)` - Clear text content\n- `hideInstance(instance)` / `unhideInstance(instance, props)` - Toggle visibility\n\n**Example Implementation (DOM)**:\n\n```mermaid\ngraph TB\n    Reconciler["Reconciler detects update"]\n    CommitUpdate["commitUpdate() called"]\n    UpdateProps["updateProperties()<br/>diff oldProps vs newProps"]\n    UpdateDOM["Apply changes to DOM node"]\n    UpdateFiberProps["updateFiberProps()<br/>cache on DOM node"]\n    \n    Reconciler --> CommitUpdate\n    CommitUpdate --> UpdateProps\n    UpdateProps --> UpdateDOM\n    CommitUpdate --> UpdateFiberProps\n```\n\n**Diagram: DOM Mutation Mode Flow**\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:940-953](), [packages/react-dom-bindings/src/client/ReactDOMComponent.js:78-82]()\n\n### Persistence Mode\n\n**Mode Identifier**: `supportsMutation = false`, `supportsPersistence = true`\n\nIn persistence mode, the reconciler creates new clones of instances that need updates, building a new tree structure. This enables features like time-travel debugging and structural sharing.\n\n**Required Methods**:\n- `cloneInstance(instance, type, oldProps, newProps, keepChildren, newChildren)` - Clone with updates\n- `createContainerChildSet()` - Create new child collection\n- `appendChildToContainerChildSet(childSet, child)` - Add to collection\n- `finalizeContainerChildren(container, newChildren)` - Prepare for replacement\n- `replaceContainerChildren(container, newChildren)` - Atomic swap\n- `cloneHiddenInstance(instance, type, props)` - Clone as hidden\n- `cloneHiddenTextInstance(instance, text)` - Clone text as hidden\n\n**Example Implementation (React Native Fabric)**:\n\n```mermaid\ngraph TB\n    Reconciler["Reconciler detects update"]\n    CloneInstance["cloneInstance() called"]\n    DiffProps["diffAttributePayloads()<br/>compute property changes"]\n    CloneNode["cloneNodeWithNewProps()<br/>native clone operation"]\n    ShareCanonical["Share canonical object<br/>with original instance"]\n    \n    Reconciler --> CloneInstance\n    CloneInstance --> DiffProps\n    DiffProps --> CloneNode\n    CloneInstance --> ShareCanonical\n```\n\n**Diagram: Fabric Persistence Mode Flow**\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:451-504]()\n\n### Mode Comparison\n\n| Aspect | Mutation Mode | Persistence Mode |\n|--------|---------------|------------------|\n| **Memory** | Lower (reuses instances) | Higher (creates clones) |\n| **Complexity** | Higher (manage mutations) | Lower (immutable trees) |\n| **Debugging** | Harder (state changes) | Easier (tree snapshots) |\n| **Platform Fit** | DOM, legacy systems | React Native Fabric, immutable backends |\n| **Update Mechanism** | In-place modification | Clone and replace |\n| **Instance Lifetime** | Long-lived | Short-lived per update |\n\nSources: [packages/react-reconciler/src/ReactFiberConfigWithNoPersistence.js:1-62](), [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js:1-62]()\n\n## Fork Resolution System\n\nReact uses a build-time fork system to select the appropriate host config implementation without runtime overhead. The reconciler imports from `react-reconciler/src/ReactFiberConfig` which is resolved to different files based on the target renderer.\n\n### Fork Resolution Mechanism\n\n```mermaid\ngraph TB\n    Source["reconciler imports<br/>\'./ReactFiberConfig\'"]\n    BuildSystem["Rollup Build System<br/>(scripts/rollup/build.js)"]\n    ForksConfig["forks.js configuration"]\n    \n    subgraph "Fork Targets"\n        DOMFork["ReactFiberConfigDOM.js"]\n        FabricFork["ReactFiberConfigFabric.js"]\n        NativeFork["ReactFiberConfigNative.js"]\n        CustomFork["ReactFiberConfig.custom.js"]\n    end\n    \n    Source --> BuildSystem\n    BuildSystem --> ForksConfig\n    ForksConfig -.->|"react-dom bundle"| DOMFork\n    ForksConfig -.->|"react-native-renderer<br/>(fabric)"| FabricFork\n    ForksConfig -.->|"react-native-renderer<br/>(legacy)"| NativeFork\n    ForksConfig -.->|"react-reconciler npm"| CustomFork\n```\n\n**Diagram: Build-Time Fork Resolution**\n\nThe fork configuration in `scripts/rollup/forks.js` maps bundle types to specific host config files:\n\n```\n\'react-reconciler/src/ReactFiberConfig\': {\n  \'react-dom\': \'react-dom-bindings/src/client/ReactFiberConfigDOM\',\n  \'react-native-renderer\': \'react-native-renderer/src/ReactFiberConfigNative\',\n  \'react-native-renderer/fabric\': \'react-native-renderer/src/ReactFiberConfigFabric\',\n  \'react-test-renderer\': \'react-test-renderer/src/ReactFiberConfigTestHost\',\n  \'react-art\': \'react-art/src/ReactFiberConfigART\',\n  \'react-reconciler\': \'react-reconciler/src/forks/ReactFiberConfig.custom\'\n}\n```\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:10-24](), build system configuration (inferred from imports)\n\n### Custom Renderer Pattern\n\nThe `react-reconciler` npm package enables third-party renderers by exporting a factory function. The custom host config uses a global `$$$config` variable that gets injected at build time:\n\n```mermaid\ngraph LR\n    ThirdParty["Third-party Renderer"]\n    ReconcilerFactory["reconciler(hostConfig)"]\n    GlobalConfig["$$$config variable<br/>(injected by wrapper)"]\n    CustomConfig["ReactFiberConfig.custom.js<br/>re-exports from $$$config"]\n    ReconcilerCore["Reconciler Core Logic"]\n    \n    ThirdParty -->|"calls with config"| ReconcilerFactory\n    ReconcilerFactory -->|"wraps and injects"| GlobalConfig\n    GlobalConfig --> CustomConfig\n    CustomConfig --> ReconcilerCore\n```\n\n**Diagram: Third-Party Renderer Integration**\n\nThe custom config file exports all methods from the injected `$$$config` object:\n\n```javascript\ndeclare const $$$config: any;\nexport const getPublicInstance = $$$config.getPublicInstance;\nexport const getRootHostContext = $$$config.getRootHostContext;\nexport const createInstance = $$$config.createInstance;\n// ... 100+ more exports\n```\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:26-287]()\n\n## Platform Implementations\n\n### React DOM (Mutation Mode)\n\nThe DOM host config is the most feature-complete implementation, supporting hydration, resources, singletons, view transitions, and suspense commits.\n\n**Key Characteristics**:\n- Mutation mode: directly modifies DOM nodes\n- Namespace context: tracks SVG, MathML, HTML contexts\n- Event system integration: delegates to `ReactDOMEventListener`\n- Resource management: hoists `<link>`, `<script>`, `<style>` to document head\n- Hydration: matches server-rendered markup\n\n**Instance Types**:\n\n| Type | Definition | Usage |\n|------|------------|-------|\n| `Instance` | `Element` | DOM element nodes |\n| `TextInstance` | `Text` | DOM text nodes |\n| `Container` | `Element \\| Document \\| DocumentFragment` | Root container |\n| `SuspenseInstance` | `Comment` (with `_reactRetry`) | Suspense boundaries in SSR |\n| `ActivityInstance` | `Comment` | Activity boundaries in SSR |\n| `HydratableInstance` | Union of above | Any hydratable node |\n\n**Context Management**:\n\n```mermaid\ngraph TB\n    RootContext["getRootHostContext()<br/>Detect document/fragment/<br/>element namespace"]\n    ChildContext["getChildHostContext()<br/>parentContext, type"]\n    \n    subgraph "Namespace Detection"\n        None["HostContextNamespaceNone<br/>(HTML)"]\n        SVG["HostContextNamespaceSvg"]\n        Math["HostContextNamespaceMath"]\n    end\n    \n    RootContext --> None\n    RootContext --> SVG\n    RootContext --> Math\n    \n    ChildContext -.->|"svg tag"| SVG\n    ChildContext -.->|"math tag"| Math\n    ChildContext -.->|"foreignObject in SVG"| None\n    ChildContext -.->|"inherits parent"| None\n```\n\n**Diagram: DOM Context Tracking**\n\n**Instance Creation**:\n\nThe `createInstance` method creates DOM elements with proper namespace handling:\n\n```\n1. Extract host context (namespace)\n2. Get owner document from root container\n3. Create element with appropriate createElementNS or createElement\n4. Special handling for \'script\' (create via innerHTML to prevent execution)\n5. Special handling for \'select\' (apply size/multiple before children)\n6. Cache fiber node on DOM node via precacheFiberNode()\n7. Cache props on DOM node via updateFiberProps()\n8. Return DOM element\n```\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:303-609](), [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js:47-59]()\n\n### React Native Fabric (Persistence Mode)\n\nFabric is React Native\'s modern rendering architecture, using persistence mode to enable structural sharing and better integration with native rendering.\n\n**Key Characteristics**:\n- Persistence mode: creates clones instead of mutating\n- Shadow nodes: lightweight native representations\n- Canonical object sharing: multiple clones share state\n- Public instance laziness: created on first ref access\n\n**Instance Structure**:\n\n```typescript\ntype Instance = {\n  node: Node,  // Shadow node reference (native)\n  canonical: {\n    nativeTag: number,\n    viewConfig: ViewConfig,\n    currentProps: Props,\n    internalInstanceHandle: Fiber,\n    publicInstance: PublicInstance | null,  // Lazily created\n    publicRootInstance?: PublicRootInstance | null\n  }\n}\n```\n\n**Clone Strategy**:\n\n```mermaid\ngraph TB\n    CloneCall["cloneInstance() called"]\n    DiffProps["diffAttributePayloads()<br/>compute changes"]\n    CheckChildren["Check keepChildren flag"]\n    \n    subgraph "Clone Operations"\n        ClonePropsOnly["cloneNodeWithNewProps()<br/>(keep children)"]\n        CloneChildren["cloneNodeWithNewChildren()<br/>(replace children)"]\n        CloneBoth["cloneNodeWithNewChildrenAndProps()<br/>(both changed)"]\n    end\n    \n    ShareCanonical["Share canonical object<br/>across all clones"]\n    \n    CloneCall --> DiffProps\n    DiffProps --> CheckChildren\n    CheckChildren -->|"keepChildren=true<br/>props changed"| ClonePropsOnly\n    CheckChildren -->|"keepChildren=false<br/>no props changed"| CloneChildren\n    CheckChildren -->|"keepChildren=false<br/>props changed"| CloneBoth\n    \n    ClonePropsOnly --> ShareCanonical\n    CloneChildren --> ShareCanonical\n    CloneBoth --> ShareCanonical\n```\n\n**Diagram: Fabric Clone Strategy**\n\nThe `canonical` object is shared across all clones of an instance, providing a stable identity for:\n- Public instance exposure through refs\n- Event handler lookup\n- Current props access for event dispatching\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:95-113](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:451-504]()\n\n### React Native Legacy (Mutation Mode)\n\nThe legacy React Native renderer uses mutation mode with the UIManager bridge API.\n\n**Key Characteristics**:\n- Mutation mode: calls UIManager to modify native views\n- Instance tracking: `ReactNativeFiberHostComponent` wrapper\n- Children management: tracks `_children` array on instance\n- Bridge batching: accumulates changes before native calls\n\n**Instance Management**:\n\n```mermaid\ngraph TB\n    CreateInstance["createInstance()"]\n    AllocateTag["allocateTag()<br/>unique view ID"]\n    GetConfig["getViewConfigForType()<br/>from registry"]\n    CreatePayload["create()<br/>attribute payload"]\n    UIManagerCreate["UIManager.createView()<br/>tag, viewName, rootTag, props"]\n    WrapInstance["new ReactNativeFiberHostComponent()"]\n    \n    CreateInstance --> AllocateTag\n    CreateInstance --> GetConfig\n    CreateInstance --> CreatePayload\n    CreateInstance --> UIManagerCreate\n    CreateInstance --> WrapInstance\n```\n\n**Diagram: Legacy RN Instance Creation**\n\n**Mutation Operations**:\n\nAll mutations go through `UIManager.manageChildren()` which batches multiple operations:\n- `moveFromIndices` / `moveToIndices` - Reorder children\n- `addChildReactTags` / `addAtIndices` - Insert new children\n- `removeAtIndices` - Remove children\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigNative.js:130-169](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:379-411]()\n\n### Test Renderers (Noop and Test)\n\nReact provides test renderers for unit testing without real host platforms.\n\n**Noop Renderer** (`react-noop-renderer`):\n- Used by React\'s internal tests\n- Simple JS object instances: `{type, props, children, hidden, id}`\n- Supports both mutation and persistence modes\n- Configurable behavior (e.g., errors, suspense)\n\n**Test Renderer** (`react-test-renderer`):\n- Public testing API\n- Mutation mode only\n- Creates mockable instances\n- Simple tree inspection: `root.toJSON()`\n\n**Noop Instance Structure**:\n\n```javascript\ntype Instance = {\n  id: number,           // Hidden from enumeration\n  type: string,\n  children: Array<Instance | TextInstance>,\n  parent: number,       // Hidden from enumeration\n  text: string | null,  // Hidden from enumeration\n  prop: any,            // User-defined prop\n  hidden: boolean,\n  context: HostContext  // Hidden from enumeration\n}\n```\n\nThe noop renderer uses `Object.defineProperty()` to hide implementation details from test assertions, making test output cleaner.\n\nSources: [packages/react-noop-renderer/src/createReactNoop.js:399-453](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:158-174]()\n\n### ART Renderer (Canvas/SVG)\n\nThe ART renderer targets the ART drawing library for canvas and SVG rendering.\n\n**Key Characteristics**:\n- Mutation mode\n- Transform-based positioning\n- Pooled transform object (reused across calls)\n- Event listener management\n\n**Transform Application**:\n\n```mermaid\ngraph LR\n    Props["props: x, y, rotation,<br/>scaleX, scaleY, transform"]\n    PooledTransform["pooledTransform<br/>(reused Transform object)"]\n    Compose["Compose transformations:<br/>1. move(x, y)<br/>2. rotate()<br/>3. scale()<br/>4. apply custom transform"]\n    CheckDirty["Compare with instance<br/>current transform"]\n    Apply["instance.transformTo()<br/>if changed"]\n    \n    Props --> PooledTransform\n    PooledTransform --> Compose\n    Compose --> CheckDirty\n    CheckDirty -->|"changed"| Apply\n```\n\n**Diagram: ART Transform Management**\n\nThe pooled transform pattern avoids allocating a new transform object for every update, reducing GC pressure during animations.\n\nSources: [packages/react-art/src/ReactFiberConfigART.js:140-184]()\n\n## Key Host Config Methods\n\n### Instance Lifecycle\n\n**createInstance(type, props, rootContainer, hostContext, internalInstanceHandle)**\n\nCreates a new host instance during the render phase. This is the primary factory method for host components.\n\n**Parameters**:\n- `type`: Component type string (e.g., "div", "View")\n- `props`: Component props object\n- `rootContainer`: The root container being rendered into\n- `hostContext`: Context from parent (e.g., namespace, text context)\n- `internalInstanceHandle`: Fiber reference for this instance\n\n**Returns**: Platform-specific instance (Element, native node, JS object, etc.)\n\n**Timing**: Called during `completeWork` in the render phase when a host component is first mounted.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:485-609](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:176-220]()\n\n**appendInitialChild(parentInstance, child)**\n\nAttaches a child instance to its parent during initial tree construction. This builds the tree bottom-up before commit.\n\n**Note**: Only called for newly created instances. Updates use different methods depending on mutation/persistence mode.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:640-646](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:167-172]()\n\n**finalizeInitialChildren(instance, type, props, hostContext)**\n\nCalled after all children have been appended to a newly created instance, allowing any final initialization.\n\n**Returns**: Boolean indicating whether `commitMount` should be called during commit phase (e.g., for autofocus).\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:648-666](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:250-257]()\n\n### Context Management\n\n**getRootHostContext(rootContainer)**\n\nInitializes the host context for the root of the tree. This determines the initial rendering context.\n\n**DOM Example**: Detects whether root is SVG, MathML, or HTML based on namespace.\n\n**React Native Example**: Returns `{isInAParentText: false}`.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:303-356](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:259-267]()\n\n**getChildHostContext(parentHostContext, type)**\n\nComputes child context based on parent context and the current component type. This propagates context down the tree.\n\n**DOM Example**: Entering `<svg>` switches to SVG namespace, `<foreignObject>` switches back to HTML.\n\n**React Native Example**: Entering text component types sets `isInAParentText: true`.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:392-407](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:269-291]()\n\n### Commit Phase Operations\n\n**prepareForCommit(containerInfo)** / **resetAfterCommit(containerInfo)**\n\nThese methods bracket the entire commit phase, allowing renderers to prepare and cleanup.\n\n**DOM Example**: \n- `prepareForCommit`: Disables event system, saves selection state, returns focused instance\n- `resetAfterCommit`: Re-enables event system, restores selection\n\n**React Native Example**: Both are no-ops (native rendering is synchronous).\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:413-451]()\n\n### Mutation Mode Methods\n\n**appendChild(parentInstance, child)** / **removeChild(parentInstance, child)**\n\nAdd or remove a child from a parent instance. Only defined in mutation mode.\n\n**DOM**: Uses `moveBefore()` if available (future API), otherwise `appendChild()`/`removeChild()`.\n\n**React Native Legacy**: Calls `UIManager.manageChildren()` to batch native changes.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:973-983](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:379-411]()\n\n**commitUpdate(instance, type, oldProps, newProps, internalInstanceHandle)**\n\nUpdates an existing instance\'s properties. Only defined in mutation mode.\n\n**DOM**: Calls `updateProperties()` which diffs props and applies changes to DOM.\n\n**React Native Legacy**: Diffs props and calls `UIManager.updateView()`.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:940-953](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:445-468]()\n\n### Persistence Mode Methods\n\n**cloneInstance(instance, type, oldProps, newProps, keepChildren, newChildSet)**\n\nCreates a clone of an instance with updated properties. Only defined in persistence mode.\n\n**Fabric**: Calls native clone operations (`cloneNodeWithNewProps`, `cloneNodeWithNewChildren`, etc.) and shares the `canonical` object.\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:451-504]()\n\n**replaceContainerChildren(container, newChildren)**\n\nAtomically replaces the root container\'s children with a new child set. Only defined in persistence mode.\n\n**Fabric**: Calls `completeRoot()` to finalize the native tree.\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:556-561]()\n\n### Priority and Scheduling\n\n**setCurrentUpdatePriority(priority)** / **getCurrentUpdatePriority()** / **resolveUpdatePriority()**\n\nManage the priority of the current update. These methods bridge React\'s event priorities with platform-specific priority systems.\n\n**DOM**: Uses React\'s priority constants directly.\n\n**React Native Fabric**: Maps between React priorities and Fabric\'s native priority system:\n- `FabricDiscretePriority`  `DiscreteEventPriority`\n- `FabricContinuousPriority`  `ContinuousEventPriority`\n- `FabricIdlePriority`  `IdleEventPriority`\n- `FabricDefaultPriority`  `DefaultEventPriority`\n\nSources: [packages/react-dom-bindings/src/client/ReactDOMUpdatePriority.js:42-45](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:386-419]()\n\n### Suspense Commit Support\n\n**maySuspendCommit(type, props)** / **preloadInstance(instance, type, props)**\n\nThese optional methods enable the reconciler to delay commits while resources load, preventing layout thrashing.\n\n**maySuspendCommit**: Returns true if this type+props combination might need to load before committing.\n\n**preloadInstance**: Initiates loading and returns true if already loaded, false if still loading.\n\n**DOM Example**: Implements for `<img>` with `loading="lazy"` and `<link>` resources.\n\n**startSuspendingCommit()** / **suspendInstance()** / **waitForCommitToBeReady()**\n\nCreate suspended state, track instances blocking commit, and provide a callback-based API for resuming when ready.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1213-1264](), [packages/react-noop-renderer/src/createReactNoop.js:618-679]()\n\n### View Transition Support\n\n**startViewTransition()** / **startGestureTransition()**\n\nOptional methods for animating state changes using the View Transition API or gesture-driven transitions.\n\n**Parameters include**:\n- Callbacks for mutation, layout, and passive phases\n- Transition types for CSS class selection  \n- Timeline objects for gesture control\n- Error and profiling callbacks\n\n**DOM**: Integrates with native `document.startViewTransition()` API.\n\n**Other platforms**: Typically no-op or call callbacks without animation.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1383-1520]()\n\n## Default Implementations\n\nReact provides default implementations for optional features that throw errors or return no-ops:\n\n- **ReactFiberConfigWithNoMutation.js**: Exports that throw for mutation methods\n- **ReactFiberConfigWithNoPersistence.js**: Exports that throw for persistence methods\n- **ReactFiberConfigWithNoHydration.js**: Exports that return false/null for hydration\n- **ReactFiberConfigWithNoResources.js**: Exports that throw for resource management\n- **ReactFiberConfigWithNoSingletons.js**: Exports that throw for singleton management\n- **ReactFiberConfigWithNoTestSelectors.js**: Exports that throw for test selectors\n- **ReactFiberConfigWithNoMicrotasks.js**: Exports that disable microtask scheduling\n- **ReactFiberConfigWithNoScopes.js**: Exports for disabled scope API\n\nRenderers import these default modules and then override only the features they support:\n\n```javascript\nexport * from \'react-reconciler/src/ReactFiberConfigWithNoMutation\';\nexport * from \'react-reconciler/src/ReactFiberConfigWithNoHydration\';\n// ... etc\n\n// Then override specific methods:\nexport const supportsPersistence = true;\nexport function cloneInstance(...) { /* implementation */ }\n```\n\nSources: [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js:1-62](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:160-165]()\n\n---\n\n# Page: Profiling and Performance Tracking\n\n# Profiling and Performance Tracking\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThe profiling system provides instrumentation for measuring React component rendering performance through four key mechanisms:\n\n1. **Profiler Component** - Public `<Profiler>` API for programmatic performance monitoring\n2. **Performance Measurement** - `actualDuration` and `baseDuration` fields tracking render times\n3. **Component Effects Tracking** - Measurement of effect execution times within Profiler boundaries\n4. **Browser DevTools Integration** - `performance.measure()` and `console.timeStamp()` integration for visual profiling\n\nThis system enables both runtime performance callbacks via the Profiler component and offline analysis through browser performance timelines and React DevTools.\n\nFor information about the DevTools profiling interface, see page 7.1. For lane-based scheduling that determines update priorities, see page 4.4.\n\n---\n\n## System Architecture\n\nThe profiling system operates across multiple phases of the React reconciliation and commit lifecycle:\n\n```mermaid\ngraph TB\n    subgraph "Public API"\n        ProfilerComponent["<Profiler> Component<br/>with onRender callback"]\n    end\n    \n    subgraph "Fiber Fields"\n        ActualDuration["actualDuration<br/>Time spent rendering"]\n        ActualStartTime["actualStartTime<br/>When render began"]\n        SelfBaseDuration["selfBaseDuration<br/>Component time only"]\n        TreeBaseDuration["treeBaseDuration<br/>Including children"]\n    end\n    \n    subgraph "Timing Infrastructure"\n        StartProfilerTimer["startProfilerTimer()<br/>Begin timing"]\n        StopProfilerTimer["stopProfilerTimerIfRunning()<br/>End timing"]\n        RecordRenderTime["recordRenderTime()<br/>Track render duration"]\n        RecordCommitTime["recordCommitTime()<br/>Track commit duration"]\n    end\n    \n    subgraph "Render Phase Instrumentation"\n        MarkRenderStarted["markComponentRenderStarted()<br/>BeginWork hooks"]\n        MarkRenderStopped["markComponentRenderStopped()<br/>After component render"]\n        TransferDuration["transferActualDuration()<br/>Bubble up times"]\n    end\n    \n    subgraph "Commit Phase Instrumentation"\n        CommitProfilerUpdate["commitProfilerUpdate()<br/>Layout effects"]\n        PushEffectDurations["pushNestedEffectDurations()<br/>Track effect times"]\n        PopEffectDurations["popNestedEffectDurations()<br/>Bubble effect times"]\n    end\n    \n    subgraph "Performance Track"\n        LogComponentRender["logComponentRender()<br/>Browser timeline"]\n        LogComponentMount["logComponentMount()"]\n        LogComponentEffect["logComponentEffect()"]\n        ConsoleTimeStamp["console.timeStamp()"]\n        PerformanceMeasure["performance.measure()"]\n    end\n    \n    ProfilerComponent --> ActualDuration\n    ProfilerComponent --> TreeBaseDuration\n    \n    StartProfilerTimer --> ActualStartTime\n    StopProfilerTimer --> ActualDuration\n    \n    MarkRenderStarted --> StartProfilerTimer\n    MarkRenderStopped --> StopProfilerTimer\n    TransferDuration --> TreeBaseDuration\n    \n    CommitProfilerUpdate --> PushEffectDurations\n    CommitProfilerUpdate --> PopEffectDurations\n    \n    LogComponentRender --> ConsoleTimeStamp\n    LogComponentRender --> PerformanceMeasure\n    LogComponentMount --> ConsoleTimeStamp\n    LogComponentEffect --> PerformanceMeasure\n    \n    RecordRenderTime --> LogComponentRender\n    RecordCommitTime --> CommitProfilerUpdate\n```\n\n**Sources:** [packages/react-reconciler/src/ReactProfilerTimer.js:1-700](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:1-600]()\n\n---\n\n## Profiler Component API\n\nThe public `<Profiler>` component allows measuring rendering costs programmatically:\n\n```mermaid\ngraph LR\n    subgraph "Component Tree"\n        App["App Component"]\n        ProfilerNode["<Profiler id=\'navigation\'<br/>onRender=callback>"]\n        Children["Navigation children"]\n    end\n    \n    subgraph "Callback Invocation"\n        OnRenderCallback["onRender callback"]\n        CallbackArgs["Arguments:<br/>id, phase, actualDuration,<br/>baseDuration, startTime,<br/>commitTime"]\n    end\n    \n    subgraph "Profiler Fiber"\n        ProfilerFiber["Profiler Fiber<br/>tag: Profiler"]\n        StateNode["stateNode:<br/>{id, onRender, effectDuration}"]\n    end\n    \n    App --> ProfilerNode\n    ProfilerNode --> Children\n    ProfilerNode --> ProfilerFiber\n    ProfilerFiber --> StateNode\n    ProfilerFiber --> OnRenderCallback\n    OnRenderCallback --> CallbackArgs\n```\n\n### Callback Signature\n\nThe `onRender` callback receives six arguments as defined in `commitProfilerUpdate`:\n\n| Parameter | Type | Description |\n|-----------|------|-------------|\n| `id` | string | Unique identifier for the Profiler |\n| `phase` | "mount" \\| "update" \\| "nested-update" | Render phase type |\n| `actualDuration` | number | Time spent rendering this update (ms) |\n| `baseDuration` | number | Total render time without memoization (ms) |\n| `startTime` | number | When React began rendering (ms from page load) |\n| `commitTime` | number | When React committed the update (ms from page load) |\n\nThe callback is invoked during the layout effects phase via `commitProfilerUpdate`. When `enableProfilerCommitHooks` is enabled, the callback is called synchronously after layout effects but before passive effects.\n\n**Example from tests:**\n```javascript\n// Test verifying callback parameters\n<Profiler id="test" onRender={callback}>\n  <AdvanceTime />\n</Profiler>\n\n// callback receives:\n// id: \'test\'\n// phase: \'mount\'\n// actualDuration: 10  // time spent in this render\n// baseDuration: 10    // time without memo optimizations\n// startTime: 5        // when render started\n// commitTime: 15      // when commit finished\n```\n\n**Sources:** [packages/react/src/__tests__/ReactProfiler-test.internal.js:287-360](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:350-380](), [packages/react-reconciler/src/ReactFiberCommitWork.js:699-734]()\n\n---\n\n## Internal Timing Infrastructure\n\n### Fiber Timing Fields\n\nEach fiber maintains four timing-related fields when `enableProfilerTimer` is enabled. These fields are initialized in the `FiberNode` constructor:\n\n```mermaid\ngraph TB\n    FiberNode["Fiber Node<br/>(FiberNode constructor)"]\n    \n    subgraph "Performance Measurement Fields"\n        ActualDuration["actualDuration: number<br/>Accumulated render time<br/>for this render pass<br/>(starts at -0)"]\n        ActualStartTime["actualStartTime: number<br/>When this fiber began<br/>rendering, or -1 if not started<br/>(initialized to -1.1)"]\n        SelfBaseDuration["selfBaseDuration: number<br/>Most recent render time<br/>excluding children<br/>(starts at -0)"]\n        TreeBaseDuration["treeBaseDuration: number<br/>Total time for subtree<br/>without memoization<br/>(starts at -0)"]\n    end\n    \n    FiberNode --> ActualDuration\n    FiberNode --> ActualStartTime\n    FiberNode --> SelfBaseDuration\n    FiberNode --> TreeBaseDuration\n    \n    style FiberNode fill:#f9f9f9\n```\n\n**Field Semantics:**\n\n- **`actualDuration`**: Accumulates the time spent rendering during the current work-in-progress pass. Updated by `stopProfilerTimerIfRunningAndRecordDuration`.\n- **`actualStartTime`**: Set by `startProfilerTimer` when rendering begins. Value of -1 indicates the fiber hasn\'t started rendering in this pass.\n- **`selfBaseDuration`**: Time for this component alone, excluding children. Calculated during `completeWork`.\n- **`treeBaseDuration`**: Estimated total time including all children if nothing was memoized. Bubbles up via `transferActualDuration`.\n\nThese fields use double values (initialized to -0 and -1.1) to avoid V8 performance cliffs when Object.preventExtensions is applied in DEV mode.\n\n**Sources:** [packages/react-reconciler/src/ReactFiber.js:179-197](), [packages/react-reconciler/src/ReactFiber.js:281-286](), [packages/react-reconciler/src/ReactProfilerTimer.js:324-400]()\n\n### Timer Control Functions\n\nThe profiling system provides functions to start and stop timers during component rendering:\n\n| Function | Location | Purpose |\n|----------|----------|---------|\n| `startProfilerTimer(fiber)` | ReactProfilerTimer.js | Begin timing a fiber\'s render |\n| `stopProfilerTimerIfRunningAndRecordDuration(fiber)` | ReactProfilerTimer.js | Complete timing and record duration |\n| `stopProfilerTimerIfRunningAndRecordIncompleteDuration(fiber)` | ReactProfilerTimer.js | Record partial duration if interrupted |\n| `recordRenderTime(endTime)` | ReactProfilerTimer.js | Mark render phase completion |\n| `recordCommitTime(endTime)` | ReactProfilerTimer.js | Mark commit phase completion |\n\n**Sources:** [packages/react-reconciler/src/ReactProfilerTimer.js:324-400]()\n\n---\n\n## Render Phase Instrumentation\n\nDuring the render phase, React instruments component rendering at key points:\n\n```mermaid\ngraph TD\n    BeginWork["beginWork(fiber)"]\n    PrepareToReadContext["prepareToReadContext()"]\n    MarkStarted["markComponentRenderStarted(fiber)<br/>if enableSchedulingProfiler"]\n    \n    RenderComponent["renderWithHooks() or<br/>callComponentInDEV()"]\n    \n    MarkStopped["markComponentRenderStopped()<br/>if enableSchedulingProfiler"]\n    StopTimer["stopProfilerTimerIfRunning(fiber)<br/>if enableProfilerTimer"]\n    \n    CompleteWork["completeWork(fiber)"]\n    TransferDuration["transferActualDuration(fiber)<br/>Bubble to parent Profiler"]\n    \n    BeginWork --> PrepareToReadContext\n    PrepareToReadContext --> MarkStarted\n    MarkStarted --> RenderComponent\n    RenderComponent --> MarkStopped\n    MarkStopped --> StopTimer\n    StopTimer --> CompleteWork\n    CompleteWork --> TransferDuration\n```\n\n### Component Render Timing\n\nFor function components, the instrumentation occurs in `updateFunctionComponent`:\n\n[packages/react-reconciler/src/ReactFiberBeginWork.js:438-454]()\n\nFor class components, timing wraps lifecycle methods:\n\n[packages/react-reconciler/src/ReactFiberClassComponent.js:56-63]()\n\n### Duration Accumulation\n\nAs the reconciler completes work on child fibers, their `actualDuration` values bubble up to ancestor Profiler components via `transferActualDuration`:\n\n[packages/react-reconciler/src/ReactProfilerTimer.js:680-700]()\n\n**Sources:** [packages/react-reconciler/src/ReactFiberBeginWork.js:438-454](), [packages/react-reconciler/src/ReactProfilerTimer.js:680-700]()\n\n---\n\n## Component Effects Tracking\n\nThe commit phase tracks the execution time of effects (layout and passive) within Profiler boundaries. This is crucial for understanding not just render costs but also effect costs.\n\n### Effect Duration Measurement Flow\n\n```mermaid\ngraph TD\n    subgraph "commitLayoutEffectOnFiber"\n        Start["Enter commitLayoutEffectOnFiber(fiber)"]\n        PushEffectStart["pushComponentEffectStart()<br/>Record start time in componentEffectStartTime"]\n        PushEffectDuration["pushComponentEffectDuration()<br/>Save previous duration"]\n        \n        CheckProfiler{"Is fiber a<br/>Profiler tag?"}\n        \n        PushNested["pushNestedEffectDurations()<br/>Save prevProfilerEffectDuration<br/>Reset profilerEffectDuration = 0"]\n        \n        ExecuteEffects["Execute layout effects<br/>(recursively for children)"]\n        \n        PopNested["popNestedEffectDurations(prev)<br/>Calculate nested duration<br/>Add to profilerEffectDuration"]\n        \n        InvokeCallback["commitProfilerUpdate()<br/>Call onRender with effectDuration"]\n        \n        PopEffectStart["popComponentEffectStart()"]\n        PopEffectDuration["popComponentEffectDuration()<br/>Add elapsed time to componentEffectDuration"]\n    end\n    \n    Start --> PushEffectStart\n    PushEffectStart --> PushEffectDuration\n    PushEffectDuration --> CheckProfiler\n    CheckProfiler -->|Yes| PushNested\n    CheckProfiler -->|No| ExecuteEffects\n    PushNested --> ExecuteEffects\n    ExecuteEffects --> PopNested\n    PopNested --> InvokeCallback\n    ExecuteEffects --> PopEffectStart\n    PopEffectStart --> PopEffectDuration\n    \n    style CheckProfiler fill:#f9f9f9\n    style InvokeCallback fill:#f9f9f9\n```\n\n### Effect Timing Variables\n\nThe profiler maintains several module-level variables for effect timing:\n\n```javascript\n// From ReactProfilerTimer.js\nexport let profilerEffectDuration: number = -0;\nexport let componentEffectStartTime: number = -1.1;\nexport let componentEffectEndTime: number = -1.1;\nexport let componentEffectDuration: number = -0;\n```\n\nThese track:\n- **`profilerEffectDuration`**: Total effect time within current Profiler boundary\n- **`componentEffectStartTime`**: When effect execution started for current component\n- **`componentEffectDuration`**: Accumulated effect time for current component\n\n### Stack-Based Duration Tracking\n\nThe system uses a stack to handle nested Profilers correctly:\n\n```javascript\n// pushNestedEffectDurations saves current duration and resets\nconst prevProfilerEffectDuration = profilerEffectDuration;\nprofilerEffectDuration = 0;\n\n// After children execute effects...\n\n// popNestedEffectDurations calculates and bubbles up\nconst nestedDuration = profilerEffectDuration;\nprofilerEffectDuration = prevDuration + nestedDuration;\n```\n\nThis ensures each Profiler accurately measures only the effects in its subtree, including nested Profilers.\n\n### Profiler Callback with Effect Duration\n\nWhen `commitProfilerUpdate` is called for a Profiler fiber with `enableProfilerCommitHooks` enabled:\n\n[packages/react-reconciler/src/ReactFiberCommitEffects.js:350-380]()\n\nThe callback receives `effectDuration` calculated from `profilerEffectDuration`, which includes:\n- Time executing layout effects in the Profiler\'s subtree\n- Time from nested Profiler components\n- Effect cleanup and setup time\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:699-734](), [packages/react-reconciler/src/ReactProfilerTimer.js:61-68](), [packages/react-reconciler/src/ReactProfilerTimer.js:123-141]()\n\n---\n\n## Browser DevTools Performance API Integration\n\nWhen `enableComponentPerformanceTrack` is enabled, React integrates with browser DevTools using the Performance API. This creates visual profiling data in Chrome/Edge DevTools Performance panel and Firefox Performance tools.\n\n### Browser API Integration Points\n\n```mermaid\ngraph TB\n    subgraph "React Profiling Events"\n        RenderComplete["Render phase completes<br/>recordRenderTime()"]\n        ComponentRender["Component finishes rendering<br/>stopProfilerTimer()"]\n        EffectExecute["Effects execute<br/>commitLayoutEffects()"]\n        ComponentMount["Component mounts<br/>commitHostMount()"]\n        ComponentUnmount["Component unmounts<br/>safelyCallComponentWillUnmount()"]\n    end\n    \n    subgraph "ReactFiberPerformanceTrack.js Functions"\n        LogRender["logComponentRender(fiber, start, end)<br/>Main render tracking"]\n        LogMount["logComponentMount(fiber, start, end)<br/>Mount event marker"]\n        LogUnmount["logComponentUnmount(fiber, start, end)<br/>Unmount event marker"]\n        LogEffect["logComponentEffect(fiber, start, end)<br/>Effect execution span"]\n    end\n    \n    subgraph "Browser Performance APIs"\n        ConsoleTimeStamp["console.timeStamp(name, start, end,<br/>track, group, color)<br/>Creates timeline marker"]\n        PerformanceMeasure["performance.measure(name, options)<br/>Creates performance span"]\n        PerformanceClear["performance.clearMeasures(name)<br/>Cleanup after logging"]\n    end\n    \n    subgraph "Performance Panel Result"\n        ComponentsTrack["\'Components \' track<br/>Render spans with metadata"]\n        LanesTrack["\'Scheduler \' group<br/>Blocking/Gesture/Transition/etc"]\n        Markers["Timeline markers<br/>Mount/Unmount events"]\n    end\n    \n    ComponentRender --> LogRender\n    ComponentMount --> LogMount\n    ComponentUnmount --> LogUnmount\n    EffectExecute --> LogEffect\n    \n    LogRender --> ConsoleTimeStamp\n    LogRender --> PerformanceMeasure\n    LogMount --> ConsoleTimeStamp\n    LogEffect --> PerformanceMeasure\n    \n    PerformanceMeasure --> PerformanceClear\n    \n    ConsoleTimeStamp --> ComponentsTrack\n    PerformanceMeasure --> ComponentsTrack\n    ConsoleTimeStamp --> Markers\n    \n    RenderComplete --> LanesTrack\n    \n    style ConsoleTimeStamp fill:#f9f9f9\n    style PerformanceMeasure fill:#f9f9f9\n```\n\n### Performance Measure Options\n\nReact uses the extended `performance.measure()` API with DevTools-specific metadata:\n\n```javascript\n// From logComponentRender in ReactFiberPerformanceTrack.js\nconst reusableComponentOptions = {\n  start: startTime,\n  end: endTime,\n  detail: {\n    devtools: {\n      dataType: \'track-entry\',\n      color: \'primary\', // or \'primary-light\', \'primary-dark\', \'error\'\n      track: \'Components \',\n      tooltipText: componentName,\n      properties: [\n        // Array of property changes, warnings, etc.\n      ]\n    }\n  }\n};\n\nperformance.measure(measureName, reusableComponentOptions);\n```\n\nThe `detail.devtools` object is recognized by Chrome DevTools to:\n- Place entries in named tracks ("Components ")\n- Apply color coding based on render duration\n- Add tooltips with component names\n- Attach structured metadata (props changes, warnings)\n\n### Track Organization\n\nPerformance entries are organized into distinct tracks visible in the Performance panel:\n\n| Track/Group | Created By | Entries |\n|-------------|------------|---------|\n| Components  | `logComponentRender()` | Individual component render spans |\n| Scheduler  | `markAllLanesInOrder()` | Lane group initialization markers |\n| Blocking (sub-track) | Lane tracking | Blocking lane renders |\n| Gesture (sub-track) | Lane tracking | Gesture transition renders |\n| Transition (sub-track) | Lane tracking | Transition renders |\n| Suspense (sub-track) | Lane tracking | Retry lane renders |\n| Idle (sub-track) | Lane tracking | Idle priority renders |\n\n### Metadata in Performance Entries\n\nEach component render entry includes rich metadata via the `properties` array:\n\n```javascript\n// Property metadata structure\nproperties: [\n  [\'Props Changed\', changedPropNames.join(\', \')],\n  [\'Deep Equal Props\', deepEqualProps ? \'true\' : \'false\'],\n  [\'Cascading Update\', didCascade ? \'true\' : \'false\'],\n  // ... additional entries\n]\n```\n\nThis metadata appears in the DevTools UI when selecting a performance entry, helping developers identify:\n- Which props changed to trigger the render\n- Whether deeply equal objects caused unnecessary renders\n- If the component updated during another component\'s render\n\n### Console Task Integration\n\nIn development mode with `console.createTask()` support, React links performance entries to the component\'s debug task:\n\n[packages/react-reconciler/src/ReactFiberPerformanceTrack.js:125-137]()\n\nThis allows DevTools to group related async operations and show the component stack that initiated them.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:42-51](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:112-139](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:221-330]()\n\n---\n\n## Update Type Tracking\n\nThe profiling system distinguishes between different types of updates:\n\n```mermaid\ngraph LR\n    subgraph "Update Types"\n        RegularUpdate["REGULAR_UPDATE (0)<br/>Normal setState/dispatch"]\n        SpawnedUpdate["SPAWNED_UPDATE (1)<br/>Update during render"]\n        PingedUpdate["PINGED_UPDATE (2)<br/>Retry after Suspense"]\n    end\n    \n    subgraph "Update Timers"\n        BlockingTimers["Blocking update timers:<br/>blockingUpdateTime,<br/>blockingUpdateTask,<br/>blockingUpdateMethodName"]\n        GestureTimers["Gesture update timers:<br/>gestureUpdateTime,<br/>gestureUpdateTask,<br/>gestureUpdateMethodName"]\n        TransitionTimers["Transition update timers:<br/>transitionUpdateTime,<br/>transitionUpdateTask,<br/>transitionUpdateMethodName"]\n    end\n    \n    subgraph "Event Tracking"\n        EventTime["Event timestamp"]\n        EventType["Event type (click, input, etc)"]\n        EventRepeatTime["Repeat event detection"]\n        SuspendedTime["Time suspended waiting"]\n    end\n    \n    RegularUpdate --> BlockingTimers\n    RegularUpdate --> GestureTimers\n    RegularUpdate --> TransitionTimers\n    \n    BlockingTimers --> EventTime\n    GestureTimers --> EventTime\n    TransitionTimers --> EventTime\n    \n    EventTime --> EventType\n    EventType --> EventRepeatTime\n    EventRepeatTime --> SuspendedTime\n```\n\n### Timer Lifecycle\n\nFor each lane group, the system maintains separate timers:\n\n**Blocking Lane Updates:**\n[packages/react-reconciler/src/ReactProfilerTimer.js:69-78]()\n\n**Gesture Lane Updates (when enabled):**\n[packages/react-reconciler/src/ReactProfilerTimer.js:80-89]()\n\n**Transition Lane Updates:**\n[packages/react-reconciler/src/ReactProfilerTimer.js:92-101]()\n\nThese timers are started when updates are scheduled and are clamped to the render/commit boundaries.\n\n**Sources:** [packages/react-reconciler/src/ReactProfilerTimer.js:52-101](), [packages/react-reconciler/src/ReactProfilerTimer.js:276-343]()\n\n---\n\n## React DevTools Backend Integration\n\nThe profiling system provides data to React DevTools through the DevTools hook, which is injected globally. This allows the standalone DevTools UI to display profiling data collected by the reconciler.\n\n### DevTools Hook Communication\n\n```mermaid\ngraph TB\n    subgraph "Reconciler Commit Phases"\n        CommitRoot["commitRoot(root, ...) in<br/>ReactFiberWorkLoop.js"]\n        LayoutPhase["Layout effects phase<br/>commitLayoutEffects()"]\n        ProfilerCallback["Profiler onRender callbacks<br/>commitProfilerUpdate()"]\n        PassivePhase["Passive effects phase<br/>commitPassiveMountEffects()"]\n    end\n    \n    subgraph "Profiling Data Collection"\n        FiberTree["Fiber tree with<br/>actualDuration, treeBaseDuration"]\n        RootEffectDuration["root.effectDuration<br/>(accumulated during layout)"]\n        UpdateTracker["Update tracking metadata<br/>(_updatedFibers in DEV)"]\n    end\n    \n    subgraph "DevTools Hook Functions"\n        OnCommitRoot["onCommitRootDevTools(root, lanes)<br/>from ReactFiberDevToolsHook.js"]\n        OnPostCommitRoot["onPostCommitRootDevTools()<br/>(after passive effects)"]\n        MarkCommitStarted["markCommitStarted(lanes)<br/>(scheduling profiler)"]\n        MarkCommitStopped["markCommitStopped()<br/>(scheduling profiler)"]\n    end\n    \n    subgraph "DevTools UI"\n        ProfilerPanel["Profiler Panel<br/>(in React DevTools extension)"]\n        FlameGraph["Flame Graph view"]\n        RankedChart["Ranked Chart view"]\n        Timeline["Timeline view"]\n    end\n    \n    CommitRoot --> LayoutPhase\n    LayoutPhase --> ProfilerCallback\n    CommitRoot --> PassivePhase\n    \n    LayoutPhase --> RootEffectDuration\n    ProfilerCallback --> FiberTree\n    \n    CommitRoot --> MarkCommitStarted\n    MarkCommitStarted --> OnCommitRoot\n    OnCommitRoot --> FiberTree\n    OnCommitRoot --> RootEffectDuration\n    \n    PassivePhase --> OnPostCommitRoot\n    \n    OnCommitRoot --> ProfilerPanel\n    ProfilerPanel --> FlameGraph\n    ProfilerPanel --> RankedChart\n    ProfilerPanel --> Timeline\n    \n    style OnCommitRoot fill:#f9f9f9\n    style ProfilerPanel fill:#f9f9f9\n```\n\n### Commit Root Notification\n\nAfter each commit completes, React notifies DevTools via `onCommitRootDevTools`:\n\n[packages/react-reconciler/src/ReactFiberDevToolsHook.js:353-369]()\n\nThis hook is called with:\n- The `FiberRoot` containing the committed fiber tree\n- The `lanes` that were committed\n- Timing information from `commitStartTime` and `commitEndTime`\n\n### Effect Duration on FiberRoot\n\nThe `effectDuration` field on FiberRoot accumulates the total time spent in layout effects:\n\n[packages/react-reconciler/src/ReactFiberCommitWork.js:650-654]()\n\nThis value is calculated using `popNestedEffectDurations` and includes:\n- Time in all layout effect setup and cleanup functions\n- Nested Profiler effect durations\n- Class component lifecycle methods (componentDidMount, componentDidUpdate)\n\n### Debug Information in DEV\n\nWhen `enableUpdaterTracking` is enabled in development mode, transitions track which fibers were updated:\n\n```javascript\n// From ReactFiberWorkLoop.js - requestUpdateLane\nif (__DEV__) {\n  if (!transition._updatedFibers) {\n    transition._updatedFibers = new Set();\n  }\n  transition._updatedFibers.add(fiber);\n}\n```\n\nThis allows DevTools to show which components were affected by a particular transition, helping developers understand the scope of updates.\n\n### Console Task Tracking\n\nIn development mode, each fiber can have an associated `_debugTask` created with `console.createTask()`:\n\n[packages/react-reconciler/src/ReactFiber.js:199-210]()\n\nThis task is used to wrap performance measurements and other async operations, creating a causal chain that DevTools can visualize. The task shows which user interaction or async operation caused a particular component to render.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberDevToolsHook.js:353-369](), [packages/react-reconciler/src/ReactFiberCommitWork.js:650-654](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:792-836](), [packages/react-reconciler/src/ReactFiber.js:199-210]()\n\n---\n\n## Feature Flags\n\nThe profiling system respects several feature flags:\n\n| Flag | File | Purpose |\n|------|------|---------|\n| `enableProfilerTimer` | ReactFeatureFlags | Enable all timing infrastructure |\n| `enableProfilerCommitHooks` | ReactFeatureFlags | Enable Profiler onRender callbacks |\n| `enableProfilerNestedUpdatePhase` | ReactFeatureFlags | Track nested update phase separately |\n| `enableSchedulingProfiler` | ReactFeatureFlags | Enable DevTools scheduling profiler |\n| `enableComponentPerformanceTrack` | ReactFeatureFlags | Enable browser performance timeline |\n\nWhen `enableProfilerTimer` is false, all timing fields are omitted from fibers to reduce memory overhead.\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:1-100](), [packages/react-reconciler/src/ReactFiber.js:179-197]()\n\n---\n\n## Performance Considerations\n\n### Memory Overhead\n\nProfiling adds several fields to each fiber:\n- 4 double-precision numbers (32 bytes on 64-bit systems)\n- Additional tracking state for update types and timers\n\nThis overhead is eliminated in production builds when profiling is disabled.\n\n### Timing Precision\n\nThe system uses `Scheduler.unstable_now()` which delegates to `performance.now()` when available, providing microsecond precision on most platforms:\n\n[packages/react-reconciler/src/ReactProfilerTimer.js:43]()\n\n### Deep Equality Detection\n\nThe performance track system includes warnings for deeply equal props that might benefit from memoization:\n\n[packages/react-reconciler/src/ReactFiberPerformanceTrack.js:216-219](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:269-291]()\n\nThis detection is expensive and only runs in development mode.\n\n**Sources:** [packages/react-reconciler/src/ReactProfilerTimer.js:40-50](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:269-291]()\n\n---\n\n# Page: Server-Side Rendering\n\n# Server-Side Rendering\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightClient.js](packages/react-client/src/ReactFlightClient.js)\n- [packages/react-client/src/ReactFlightReplyClient.js](packages/react-client/src/ReactFlightReplyClient.js)\n- [packages/react-client/src/ReactFlightTemporaryReferences.js](packages/react-client/src/ReactFlightTemporaryReferences.js)\n- [packages/react-client/src/__tests__/ReactFlight-test.js](packages/react-client/src/__tests__/ReactFlight-test.js)\n- [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js](packages/react-dom-bindings/src/client/ReactDOMComponentTree.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js)\n- [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js](packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js](packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFloat-test.js](packages/react-dom/src/__tests__/ReactDOMFloat-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js](packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js](packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js)\n- [packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js](packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js)\n- [packages/react-dom/src/__tests__/ReactRenderDocument-test.js](packages/react-dom/src/__tests__/ReactRenderDocument-test.js)\n- [packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js](packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js](packages/react-dom/src/server/ReactDOMFizzServerBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBun.js](packages/react-dom/src/server/ReactDOMFizzServerBun.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerEdge.js](packages/react-dom/src/server/ReactDOMFizzServerEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerNode.js](packages/react-dom/src/server/ReactDOMFizzServerNode.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js](packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticEdge.js](packages/react-dom/src/server/ReactDOMFizzStaticEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticNode.js](packages/react-dom/src/server/ReactDOMFizzStaticNode.js)\n- [packages/react-markup/src/ReactFizzConfigMarkup.js](packages/react-markup/src/ReactFizzConfigMarkup.js)\n- [packages/react-noop-renderer/src/ReactNoopServer.js](packages/react-noop-renderer/src/ReactNoopServer.js)\n- [packages/react-reconciler/src/ReactFiberHydrationContext.js](packages/react-reconciler/src/ReactFiberHydrationContext.js)\n- [packages/react-server-dom-esm/src/ReactFlightESMReferences.js](packages/react-server-dom-esm/src/ReactFlightESMReferences.js)\n- [packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js](packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js)\n- [packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js](packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js)\n- [packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js](packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js)\n- [packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js](packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js)\n- [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js](packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js)\n- [packages/react-server/src/ReactFizzServer.js](packages/react-server/src/ReactFizzServer.js)\n- [packages/react-server/src/ReactFlightReplyServer.js](packages/react-server/src/ReactFlightReplyServer.js)\n- [packages/react-server/src/ReactFlightServer.js](packages/react-server/src/ReactFlightServer.js)\n- [packages/react-server/src/ReactFlightServerTemporaryReferences.js](packages/react-server/src/ReactFlightServerTemporaryReferences.js)\n- [packages/react-server/src/forks/ReactFizzConfig.custom.js](packages/react-server/src/forks/ReactFizzConfig.custom.js)\n- [scripts/error-codes/codes.json](scripts/error-codes/codes.json)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document provides an overview of React\'s server-side rendering capabilities, covering both **HTML streaming (Fizz)** and **Server Components (Flight)**. These two complementary systems enable React applications to render on the server and transmit the results to clients for hydration or consumption.\n\nFor detailed implementation of HTML streaming with Suspense boundaries, see [React Fizz (Streaming SSR)](#5.1). For Server Components serialization and the RSC protocol, see [React Server Components (Flight)](#5.2). For build system integration, see [Build Integration for Server Components](#5.3). For server actions and bidirectional communication, see [Server Actions and Bidirectional Communication](#5.4).\n\nThis page focuses on the high-level architecture, the relationship between Fizz and Flight, and the core request/response model shared by both systems.\n\n## The Two SSR Systems\n\nReact provides two distinct server-side rendering systems that serve different purposes:\n\n| System | Purpose | Output Format | Primary Use Case |\n|--------|---------|---------------|------------------|\n| **Fizz** | HTML Streaming SSR | HTML + JavaScript instructions | Traditional SSR with progressive hydration |\n| **Flight** | Server Components Serialization | Binary/JSON protocol (RSC wire format) | Server Components tree transmission |\n\n**Fizz** (`ReactFizzServer`) renders React components to HTML, streaming the output progressively with support for Suspense boundaries. It generates hydration instructions embedded in `<script>` tags to enable client-side React to attach to the server-rendered HTML.\n\n**Flight** (`ReactFlightServer`) serializes Server Component trees into a compact streaming protocol. It handles module references (Client Components) and streams chunks representing the component tree structure, allowing clients to reconstruct the React element tree without executing Server Component code.\n\nThese systems can be used independently or together. In React Server Components applications, Flight renders the Server Component tree, which may reference Client Components. When rendering to HTML, Fizz consumes the Flight stream and renders Client Components to HTML.\n\nSources: [packages/react-server/src/ReactFizzServer.js:1-100](), [packages/react-server/src/ReactFlightServer.js:1-100]()\n\n## Architecture Overview\n\n```mermaid\ngraph TB\n    subgraph "Server Environment"\n        SC["Server Components<br/>(React Server)"]\n        FlightServer["ReactFlightServer<br/>packages/react-server/src/ReactFlightServer.js"]\n        FizzServer["ReactFizzServer<br/>packages/react-server/src/ReactFizzServer.js"]\n    end\n    \n    subgraph "Network Layer"\n        FlightStream["Flight Stream<br/>RSC Protocol Chunks"]\n        HTMLStream["HTML Stream<br/>+ Hydration Instructions"]\n    end\n    \n    subgraph "Client Environment"\n        FlightClient["ReactFlightClient<br/>packages/react-client/src/ReactFlightClient.js"]\n        Hydration["ReactFiberHydrationContext<br/>Client-side Hydration"]\n        ClientComponents["Client Components<br/>(Browser React)"]\n    end\n    \n    SC -->|"serialize"| FlightServer\n    FlightServer -->|"stream chunks"| FlightStream\n    FlightStream -->|"deserialize"| FlightClient\n    FlightClient -->|"React elements"| ClientComponents\n    \n    SC -->|"render to HTML"| FizzServer\n    FizzServer -->|"stream HTML"| HTMLStream\n    HTMLStream -->|"hydrateRoot()"| Hydration\n    Hydration -->|"attach events"| ClientComponents\n    \n    FlightStream -.->|"integrated mode"| FizzServer\n```\n\n**Diagram: Server-Side Rendering Architecture**\n\nIn an integrated Server Components application, the flow works as follows:\n\n1. Server Components execute in the React Server environment\n2. Flight serializes the Server Component tree, including references to Client Components\n3. Fizz can consume the Flight stream and render Client Components to HTML\n4. The client receives both the HTML (for immediate display) and Flight chunks (for interactivity)\n5. Client-side React hydrates the HTML and processes Flight chunks to reconstruct the component tree\n\nSources: [packages/react-server/src/ReactFlightServer.js:1-200](), [packages/react-server/src/ReactFizzServer.js:1-200](), [packages/react-client/src/ReactFlightClient.js:1-200]()\n\n## Request and Response Model\n\nBoth Fizz and Flight use a request/response architecture with a task-based rendering model:\n\n```mermaid\ngraph LR\n    subgraph "Request Creation"\n        Model["ReactClientValue<br/>or ReactNodeList"]\n        CreateReq["createRequest()<br/>or createPrerenderRequest()"]\n        Req["Request Object"]\n    end\n    \n    subgraph "Request State"\n        Status["status: OPENING | OPEN<br/>| ABORTING | CLOSING | CLOSED"]\n        Tasks["pingedTasks: Array&lt;Task&gt;<br/>abortableTasks: Set&lt;Task&gt;"]\n        Chunks["completedChunks:<br/>Regular | Import | Hint | Error"]\n    end\n    \n    subgraph "Rendering Loop"\n        PerformWork["performWork(request)"]\n        RenderTask["renderTask(task)"]\n        EmitChunks["emitChunk() / writeChunk()"]\n    end\n    \n    subgraph "Output Destination"\n        Dest["Destination<br/>(Stream, WritableStream, etc)"]\n        FlushChunks["flushCompletedChunks()"]\n    end\n    \n    Model --> CreateReq\n    CreateReq --> Req\n    Req --> Status\n    Req --> Tasks\n    Req --> Chunks\n    \n    Tasks --> PerformWork\n    PerformWork --> RenderTask\n    RenderTask --> Chunks\n    Chunks --> FlushChunks\n    FlushChunks --> Dest\n```\n\n**Diagram: Request/Response Processing Model**\n\n### Request Types\n\nBoth systems define a `Request` type that maintains rendering state:\n\n**Fizz Request** [packages/react-server/src/ReactFizzServer.js:367-408]():\n- Manages HTML generation and Suspense boundaries\n- Tracks segments, boundaries, and preamble state\n- Coordinates progressive streaming of HTML chunks\n\n**Flight Request** [packages/react-server/src/ReactFlightServer.js:571-617]():\n- Manages serialization of Server Component trees\n- Tracks module references and serialized values\n- Coordinates streaming of protocol chunks\n\n### Request Lifecycle\n\n```mermaid\nstateDiagram-v2\n    [*] --> OPENING: createRequest()\n    OPENING --> OPEN: startWork()\n    OPEN --> OPEN: performWork()\n    OPEN --> ABORTING: abort()\n    OPEN --> CLOSING: all tasks complete\n    ABORTING --> CLOSED: cleanup\n    CLOSING --> CLOSED: flushCompleted()\n    CLOSED --> [*]\n```\n\n**Diagram: Request Status Lifecycle**\n\nSources: [packages/react-server/src/ReactFizzServer.js:360-554](), [packages/react-server/src/ReactFlightServer.js:527-841]()\n\n## Task-Based Rendering\n\nBoth systems use a task queue to manage rendering work:\n\n### Task Structure\n\n**Fizz Tasks** [packages/react-server/src/ReactFizzServer.js:279-331]():\n```\nRenderTask {\n  node: ReactNodeList          // Content to render\n  blockedSegment: Segment      // Output target\n  blockedBoundary: Root | SuspenseBoundary\n  keyPath: Root | KeyNode      // For tracking postponed content\n  formatContext: FormatContext // HTML/SVG/MathML context\n  thenableState: ThenableState // Suspense tracking\n}\n\nReplayTask {\n  replay: ReplaySet           // Resume from postponed state\n  node: ReactNodeList\n  blockedBoundary: Root | SuspenseBoundary\n  // Similar fields for context\n}\n```\n\n**Flight Tasks** [packages/react-server/src/ReactFlightServer.js:533-549]():\n```\nTask {\n  id: number\n  status: PENDING | COMPLETED | ABORTED | ERRORED | RENDERING\n  model: ReactClientValue      // Value to serialize\n  ping: () => void            // Resume after suspending\n  keyPath: ReactKey           // Parent component keys\n  formatContext: FormatContext\n  thenableState: ThenableState\n}\n```\n\n### Work Loop\n\nBoth systems process tasks in a similar pattern:\n\n1. **Dequeue**: Pop tasks from `request.pingedTasks`\n2. **Render**: Execute task rendering logic (`renderTask`)\n3. **Suspend**: On Suspense, create new task and await Promise\n4. **Complete**: Emit chunks/segments when tasks finish\n5. **Flush**: Write completed output to destination\n\nSources: [packages/react-server/src/ReactFizzServer.js:791-802](), [packages/react-server/src/ReactFlightServer.js:2420-2500]()\n\n## Streaming Output Formats\n\n### Fizz HTML Format\n\nFizz outputs HTML with embedded JavaScript instructions:\n\n```\n<!DOCTYPE html><html><head>...</head><body>\n<div>Server-rendered content</div>\n<!--$?--><template id="B:0"></template>\n<div>Fallback for suspended content...</div>\n<!--/$-->\n\n<script>\n$RC=function(b,c,e){/* completeBoundary runtime */};\n</script>\n<script>\n$RC("B:0","S:1")\n</script>\n```\n\nInstructions include:\n- `$RC`: Complete boundary (reveal suspended content)\n- `$RX`: Client render boundary (error fallback)\n- `$RS`: Complete segment\n- Form state markers for progressive enhancement\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:1-300]()\n\n### Flight Protocol Format\n\nFlight outputs newline-delimited chunks with a typed protocol:\n\n```\n0:{"id":"./ClientComponent.js#","chunks":["client123"],"name":"default"}\n1:I["module1","ClientComponent",123]\n2:{"type":"div","props":{"children":"Hello"}}\n3:@2\n```\n\nChunk types:\n- **Model row** (`id:json`): JSON-encoded value\n- **Module row** (`id:I[...]`): Client module reference\n- **Error row** (`id:E{...}`): Serialized error\n- **Reference** (`@id`): Pointer to another chunk\n- **Promise row** (`id:@...`): Async value placeholder\n- **Debug info** (`id:D{...}`): DEV-only metadata\n\nSources: [packages/react-server/src/ReactFlightServer.js:2700-3200](), [packages/react-client/src/ReactFlightClient.js:149-164]()\n\n## Request Creation APIs\n\n### Fizz APIs\n\n| Function | Purpose | Environment |\n|----------|---------|-------------|\n| `renderToPipeableStream()` | Node.js streams | server.node |\n| `renderToReadableStream()` | Web Streams API | server.browser, server.edge |\n| `renderToStaticMarkup()` | Non-interactive HTML | server.* |\n| `renderToString()` | Synchronous render | server.* |\n\n**Prerendering:**\n- `createPrerenderRequest()` [packages/react-server/src/ReactFizzServer.js:623-655](): Creates request that tracks postponed holes for resume\n- `resumeRequest()` [packages/react-server/src/ReactFizzServer.js:657-749](): Resumes from `PostponedState`\n\nSources: [packages/react-dom/src/server/ReactDOMFizzServerNode.js:1-300](), [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js:1-200]()\n\n### Flight APIs\n\n| Function | Purpose | Environment |\n|----------|---------|-------------|\n| `renderToReadableStream()` | Render to Web Stream | server.browser, server.edge, server.node |\n| `decodeReply()` | Decode form data/request body | server.* |\n| `decodeAction()` | Decode server action reference | server.* |\n\n**Prerendering:**\n- `createPrerenderRequest()` [packages/react-server/src/ReactFlightServer.js:811-841](): Creates request with `onAllReady` and `onFatalError` callbacks\n- Prerender can be resumed or converted to static output\n\nSources: [packages/react-server/src/ReactFlightServer.js:781-841]()\n\n## Integration Points\n\n### Fizz + Flight Integration\n\nWhen rendering Server Components to HTML:\n\n```mermaid\ngraph TB\n    subgraph "Server Render"\n        ServerComp["Server Component Tree"]\n        FlightRender["Flight: renderToReadableStream()"]\n        FlightStream["Flight Stream<br/>(RSC Protocol)"]\n    end\n    \n    subgraph "HTML Generation"\n        FizzConsume["Fizz consumes Flight stream"]\n        ClientCompRender["Render Client Components"]\n        HTMLOutput["HTML + Inline Flight Data"]\n    end\n    \n    subgraph "Client Hydration"\n        ParseHTML["Parse HTML"]\n        ReadFlight["Read inline Flight data"]\n        Reconstruct["Reconstruct component tree"]\n        Hydrate["hydrateRoot()"]\n    end\n    \n    ServerComp --> FlightRender\n    FlightRender --> FlightStream\n    FlightStream --> FizzConsume\n    FizzConsume --> ClientCompRender\n    ClientCompRender --> HTMLOutput\n    \n    HTMLOutput --> ParseHTML\n    HTMLOutput --> ReadFlight\n    ParseHTML --> Hydrate\n    ReadFlight --> Reconstruct\n    Reconstruct --> Hydrate\n```\n\n**Diagram: Integrated SSR with Server Components**\n\nThe Flight stream can be:\n1. **Embedded**: Serialized into `<script>` tags in HTML for immediate consumption\n2. **Separate**: Sent as a parallel stream for progressive enhancement\n3. **Preloaded**: Generated during build and embedded in HTML\n\nSources: [packages/react-server/src/ReactFizzServer.js:1-100](), [packages/react-server/src/ReactFlightServer.js:1-100]()\n\n### Host Configuration\n\nBoth systems use host configs for platform adaptation:\n\n**Fizz Host Config** [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js]():\n- HTML generation (`pushStartInstance`, `pushEndInstance`)\n- Resource management (scripts, stylesheets, preloads)\n- Streaming format (inline scripts vs external runtime)\n\n**Flight Host Config** [packages/react-server/src/ReactFlightServerConfig.js]():\n- Module reference resolution (`resolveClientReferenceMetadata`)\n- Bundler integration (`getClientReferenceKey`)\n- Request storage (`supportsRequestStorage`, `requestStorage`)\n\n## Error Handling and Suspense\n\nBoth systems handle errors and Suspense similarly:\n\n### Suspense Boundaries\n\n**Fizz** [packages/react-server/src/ReactFizzServer.js:804-849]():\n- Creates `SuspenseBoundary` with fallback content\n- Tracks pending tasks within boundary\n- Streams fallback immediately, content when ready\n- Emits completion instruction to reveal content\n\n**Flight** [packages/react-server/src/ReactFlightServer.js:1034-1136]():\n- Serializes Thenable as Promise reference\n- Creates task for resolved value\n- Client reconstructs async boundary\n\n### Error Recovery\n\nBoth systems:\n1. Catch errors during rendering\n2. Call `onError` callback with error info\n3. Emit error chunks/boundaries\n4. Allow client-side error boundaries to handle\n\nSources: [packages/react-server/src/ReactFizzServer.js:2100-2300](), [packages/react-server/src/ReactFlightServer.js:2600-2800]()\n\n## Performance Considerations\n\n### Progressive Streaming\n\n**Fizz** progressively flushes:\n- Shell (initial content) as soon as possible\n- Suspense boundaries when they resolve\n- Resources (scripts, styles) with proper priorities\n\n**Flight** streams:\n- Chunks as components complete\n- Lazy module references\n- Async boundaries incrementally\n\n### Chunking Strategy\n\n**Fizz** uses `progressiveChunkSize` [packages/react-server/src/ReactFizzServer.js:437]():\n- Default: 12,800 bytes (~500ms on 3G)\n- Controls when to flush buffered HTML\n\n**Flight** streams eagerly:\n- Emits chunks immediately when tasks complete\n- No configurable buffering (streams are already buffered)\n\nSources: [packages/react-server/src/ReactFizzServer.js:422-472](), [packages/react-server/src/ReactFlightServer.js:2420-2500]()\n\n## Feature Flags\n\nKey feature flags affecting SSR:\n\n| Flag | Impact |\n|------|--------|\n| `enableHalt` | Allows prerendering to halt on dynamic content |\n| `enablePostpone` | Enables postpone() API for incremental rendering |\n| `enableFizzExternalRuntime` | Uses external runtime script vs inline |\n| `enableAsyncDebugInfo` | Includes async stack traces in DEV |\n| `enableComponentPerformanceTrack` | Tracks component render timing |\n\nSources: [packages/shared/ReactFeatureFlags.js](), [packages/react-server/src/ReactFizzServer.js:177-187](), [packages/react-server/src/ReactFlightServer.js:14-20]()\n\n## Summary\n\nReact\'s server-side rendering encompasses two complementary systems:\n\n- **Fizz** handles HTML streaming with Suspense, progressive hydration, and resource management\n- **Flight** serializes Server Component trees for efficient client consumption\n\nBoth share a task-based rendering model with progressive streaming, Suspense support, and error recovery. They can operate independently or in an integrated mode where Flight output is consumed by Fizz to generate HTML with embedded RSC data.\n\nFor implementation details, see the child pages: [React Fizz (Streaming SSR)](#5.1) for HTML generation, [React Server Components (Flight)](#5.2) for the RSC protocol, [Build Integration for Server Components](#5.3) for bundler integration, and [Server Actions and Bidirectional Communication](#5.4) for client-to-server RPC.\n\n---\n\n# Page: React Fizz (Streaming SSR)\n\n# React Fizz (Streaming SSR)\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js](packages/react-dom-bindings/src/client/ReactDOMComponentTree.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js)\n- [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js](packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js](packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFloat-test.js](packages/react-dom/src/__tests__/ReactDOMFloat-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js](packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js](packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js)\n- [packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js](packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js)\n- [packages/react-dom/src/__tests__/ReactRenderDocument-test.js](packages/react-dom/src/__tests__/ReactRenderDocument-test.js)\n- [packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js](packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js](packages/react-dom/src/server/ReactDOMFizzServerBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBun.js](packages/react-dom/src/server/ReactDOMFizzServerBun.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerEdge.js](packages/react-dom/src/server/ReactDOMFizzServerEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerNode.js](packages/react-dom/src/server/ReactDOMFizzServerNode.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js](packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticEdge.js](packages/react-dom/src/server/ReactDOMFizzStaticEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticNode.js](packages/react-dom/src/server/ReactDOMFizzStaticNode.js)\n- [packages/react-markup/src/ReactFizzConfigMarkup.js](packages/react-markup/src/ReactFizzConfigMarkup.js)\n- [packages/react-noop-renderer/src/ReactNoopServer.js](packages/react-noop-renderer/src/ReactNoopServer.js)\n- [packages/react-reconciler/src/ReactFiberHydrationContext.js](packages/react-reconciler/src/ReactFiberHydrationContext.js)\n- [packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js](packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js)\n- [packages/react-server/src/ReactFizzServer.js](packages/react-server/src/ReactFizzServer.js)\n- [packages/react-server/src/forks/ReactFizzConfig.custom.js](packages/react-server/src/forks/ReactFizzConfig.custom.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nReact Fizz is the streaming server-side rendering (SSR) system that generates HTML progressively, sending content to the client as it becomes ready. This document covers the core Fizz rendering engine, its request/task/segment model, resource management, and platform-specific implementations for Node.js, Web streams, and static generation.\n\nFor information about React Server Components (RSC) and the Flight protocol, see [React Server Components (Flight)](#5.2). For client-side hydration, see [Hydration System](#6.3).\n\n## High-Level Architecture\n\nReact Fizz operates as a streaming HTML renderer that processes React elements and outputs HTML chunks incrementally. The system is platform-agnostic at its core, with platform-specific adapters for different streaming targets.\n\n**Fizz Architecture Overview**\n\n```mermaid\ngraph TB\n    subgraph "Entry Points"\n        NodeEntry["renderToPipeableStream<br/>(Node.js)"]\n        BrowserEntry["renderToReadableStream<br/>(Web Streams)"]\n        StaticEntry["prerender<br/>(Static Generation)"]\n    end\n    \n    subgraph "Core Engine (ReactFizzServer)"\n        CreateRequest["createRequest()<br/>createPrerenderRequest()<br/>resumeRequest()"]\n        StartWork["startWork()<br/>Process pingedTasks"]\n        PerformWork["performWork()<br/>Main work loop"]\n        RenderTask["renderNode()<br/>Component rendering"]\n    end\n    \n    subgraph "State Management"\n        Request["Request<br/>allPendingTasks<br/>pingedTasks<br/>completedBoundaries"]\n        Task["Task<br/>RenderTask | ReplayTask<br/>node, segment, boundary"]\n        Segment["Segment<br/>chunks, children<br/>status, boundary"]\n        Boundary["SuspenseBoundary<br/>pendingTasks<br/>completedSegments<br/>contentState/fallbackState"]\n    end\n    \n    subgraph "Output Management"\n        RenderState["RenderState<br/>hoistableChunks<br/>bootstrapChunks<br/>styles, scripts"]\n        ResumableState["ResumableState<br/>resumable resources<br/>idPrefix, nextFormID"]\n        FlushFunctions["writeCompletedRoot()<br/>writeCompletedBoundary()<br/>writeCompletedSegment()"]\n    end\n    \n    subgraph "Platform Streaming"\n        Destination["Destination<br/>(Writable | Controller)"]\n        StreamConfig["ReactServerStreamConfig<br/>writeChunk()<br/>scheduleWork()"]\n    end\n    \n    NodeEntry --> CreateRequest\n    BrowserEntry --> CreateRequest\n    StaticEntry --> CreateRequest\n    \n    CreateRequest --> Request\n    CreateRequest --> StartWork\n    StartWork --> PerformWork\n    PerformWork --> RenderTask\n    \n    RenderTask --> Task\n    Task --> Segment\n    Task --> Boundary\n    \n    Request --> RenderState\n    Request --> ResumableState\n    \n    PerformWork --> FlushFunctions\n    FlushFunctions --> StreamConfig\n    StreamConfig --> Destination\n    \n    Boundary --> RenderState\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:1-4000](), [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:1-500](), [packages/react-dom/src/server/ReactDOMFizzServerNode.js:1-300]()\n\n## Core Data Structures\n\n### Request\n\nThe `Request` is the top-level rendering context that tracks the entire SSR operation.\n\n**Request Structure**\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `destination` | `Destination \\| null` | Output stream target |\n| `resumableState` | `ResumableState` | Serializable state for resuming |\n| `renderState` | `RenderState` | Per-request working state |\n| `allPendingTasks` | `number` | Total tasks to complete |\n| `pendingRootTasks` | `number` | Tasks blocking shell completion |\n| `pingedTasks` | `Array<Task>` | High-priority tasks ready to work |\n| `completedBoundaries` | `Array<SuspenseBoundary>` | Boundaries ready to flush |\n| `clientRenderedBoundaries` | `Array<SuspenseBoundary>` | Errored boundaries |\n| `partialBoundaries` | `Array<SuspenseBoundary>` | Boundaries with partial content |\n| `abortableTasks` | `Set<Task>` | Tasks that can be aborted |\n| `trackedPostpones` | `PostponedHoles \\| null` | For prerendering resume |\n\nSources: [packages/react-server/src/ReactFizzServer.js:359-400]()\n\n### Task Types\n\nTasks represent units of work in the rendering pipeline. There are two types:\n\n**RenderTask vs ReplayTask**\n\n```mermaid\ngraph LR\n    subgraph "RenderTask"\n        RT_replay["replay: null"]\n        RT_node["node: ReactNodeList"]\n        RT_segment["blockedSegment: Segment"]\n        RT_boundary["blockedBoundary: Root|SuspenseBoundary"]\n        RT_render["Writes to segment.chunks"]\n    end\n    \n    subgraph "ReplayTask"\n        RPT_replay["replay: ReplaySet"]\n        RPT_node["node: ReactNodeList"]\n        RPT_segment["blockedSegment: null"]\n        RPT_boundary["blockedBoundary: Root|SuspenseBoundary"]\n        RPT_render["Validates against replay nodes"]\n    end\n    \n    RT_node --> RT_render\n    RT_segment --> RT_render\n    \n    RPT_replay --> RPT_render\n    RPT_node --> RPT_render\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:272-324]()\n\n### Segment\n\nA `Segment` represents a chunk of HTML output with its rendering status.\n\n**Segment Lifecycle**\n\n```mermaid\nstateDiagram-v2\n    [*] --> PENDING: createPendingSegment()\n    PENDING --> RENDERING: Start rendering\n    RENDERING --> COMPLETED: finishedTask()\n    RENDERING --> ERRORED: Error occurred\n    RENDERING --> POSTPONED: postponed()\n    RENDERING --> ABORTED: abortTask()\n    COMPLETED --> FLUSHED: flushSegment()\n    PENDING --> ABORTED: abortTask()\n```\n\n| Status | Value | Description |\n|--------|-------|-------------|\n| `PENDING` | 0 | Waiting to render |\n| `COMPLETED` | 1 | Rendered successfully |\n| `FLUSHED` | 2 | Written to destination |\n| `ABORTED` | 3 | Rendering canceled |\n| `ERRORED` | 4 | Error during rendering |\n| `POSTPONED` | 5 | Postponed for later |\n| `RENDERING` | 6 | Currently rendering |\n\nSources: [packages/react-server/src/ReactFizzServer.js:326-351]()\n\n### SuspenseBoundary\n\nA `SuspenseBoundary` manages Suspense boundaries, tracking pending work and managing fallback rendering.\n\n**SuspenseBoundary Fields**\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `status` | `0 \\| 1 \\| 4 \\| 5` | PENDING, COMPLETED, CLIENT_RENDERED, POSTPONED |\n| `rootSegmentID` | `number` | ID for boundary\'s root segment |\n| `pendingTasks` | `number` | Tasks blocking completion |\n| `completedSegments` | `Array<Segment>` | Ready but not flushed |\n| `byteSize` | `number` | Total size for inlining decisions |\n| `defer` | `boolean` | Never inline deferred boundaries |\n| `contentState` | `HoistableState` | Resources for content |\n| `fallbackState` | `HoistableState` | Resources for fallback |\n| `fallbackAbortableTasks` | `Set<Task>` | Cancel if content completes |\n| `errorDigest` | `?string` | Error hash if errored |\n\nSources: [packages/react-server/src/ReactFizzServer.js:248-270]()\n\n## Rendering Pipeline\n\nThe rendering pipeline flows from request creation through task processing to HTML output.\n\n**Complete Rendering Flow**\n\n```mermaid\ngraph TB\n    subgraph "1. Initialization"\n        Create["createRequest(children, options)"]\n        RootSegment["createPendingSegment()<br/>Root segment"]\n        RootTask["createRenderTask()<br/>Initial task"]\n        PushTask["pingedTasks.push(rootTask)"]\n    end\n    \n    subgraph "2. Work Loop"\n        StartWork["startWork(request)"]\n        PerformWork["performWork(request)"]\n        ProcessTask["processTask(task)"]\n        RenderNode["renderNode(request, task, node)"]\n    end\n    \n    subgraph "3. Component Rendering"\n        CheckType["Check node type<br/>(Element, Suspense, etc.)"]\n        RenderElement["renderElement(task, type, props)"]\n        RenderSuspense["renderSuspenseBoundary(task, props)"]\n        RenderText["pushTextInstance(target, text)"]\n    end\n    \n    subgraph "4. Segment Completion"\n        FinishTask["finishedTask(request, boundary, segment)"]\n        CompleteSegment["segment.status = COMPLETED"]\n        DecrementPending["boundary.pendingTasks--"]\n        CheckBoundary["pendingTasks === 0?"]\n    end\n    \n    subgraph "5. Boundary Completion"\n        CompleteBoundary["boundary.status = COMPLETED"]\n        QueueBoundary["completedBoundaries.push(boundary)"]\n        FlushBoundary["flushCompletedBoundary()"]\n    end\n    \n    subgraph "6. Output"\n        WriteInstructions["writeCompletedBoundaryInstruction()"]\n        WriteSegments["writeCompletedSegmentInstruction()"]\n        FlushDestination["flushBuffered(destination)"]\n    end\n    \n    Create --> RootSegment\n    RootSegment --> RootTask\n    RootTask --> PushTask\n    PushTask --> StartWork\n    \n    StartWork --> PerformWork\n    PerformWork --> ProcessTask\n    ProcessTask --> RenderNode\n    \n    RenderNode --> CheckType\n    CheckType --> RenderElement\n    CheckType --> RenderSuspense\n    CheckType --> RenderText\n    \n    RenderElement --> FinishTask\n    FinishTask --> CompleteSegment\n    CompleteSegment --> DecrementPending\n    DecrementPending --> CheckBoundary\n    \n    CheckBoundary -->|Yes| CompleteBoundary\n    CompleteBoundary --> QueueBoundary\n    QueueBoundary --> FlushBoundary\n    \n    FlushBoundary --> WriteInstructions\n    WriteInstructions --> WriteSegments\n    WriteSegments --> FlushDestination\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:548-800](), [packages/react-server/src/ReactFizzServer.js:1600-2000]()\n\n## Task Scheduling and Execution\n\n### Task Creation\n\nTasks are created when starting rendering or when Suspense boundaries need to render their content or fallback.\n\n**Task Creation Functions**\n\n```mermaid\ngraph LR\n    subgraph "Task Factories"\n        CreateRenderTask["createRenderTask()<br/>Regular rendering"]\n        CreateReplayTask["createReplayTask()<br/>Resume rendering"]\n    end\n    \n    subgraph "Task Properties"\n        Node["node: ReactNodeList<br/>What to render"]\n        Segment["blockedSegment: Segment<br/>Where to write (render only)"]\n        Boundary["blockedBoundary: Root|SuspenseBoundary<br/>Parent boundary"]\n        Context["context: ContextSnapshot<br/>treeContext, legacyContext"]\n        FormatContext["formatContext: FormatContext<br/>HTML/SVG/MathML context"]\n        KeyPath["keyPath: Root|KeyNode<br/>Component key path"]\n    end\n    \n    subgraph "Task Lifecycle"\n        AddToAbortSet["abortSet.add(task)"]\n        IncrementPending["allPendingTasks++<br/>boundary.pendingTasks++"]\n        PingTask["pingTask(request, task)<br/>Schedule work"]\n    end\n    \n    CreateRenderTask --> Node\n    CreateRenderTask --> Segment\n    CreateReplayTask --> Node\n    \n    Node --> AddToAbortSet\n    Segment --> IncrementPending\n    Boundary --> IncrementPending\n    IncrementPending --> PingTask\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:843-953]()\n\n### performWork Loop\n\nThe `performWork` function is the main work loop that processes tasks and flushes output.\n\n**performWork Execution**\n\n```mermaid\ngraph TB\n    Entry["performWork(request)"]\n    \n    subgraph "Task Processing"\n        CheckStatus["request.status === OPEN?"]\n        PopTask["task = pingedTasks.pop()"]\n        HasTask["task !== undefined?"]\n        \n        SetCurrentRequest["currentRequest = request"]\n        RenderWithResumeId["renderNodeWithResumeId(request, task)"]\n        \n        RerenderTask["Try rerender task<br/>if it suspended"]\n        ClearCurrentRequest["currentRequest = null"]\n    end\n    \n    subgraph "Flushing Boundaries"\n        FlushClientRendered["flushClientRenderedBoundaries()<br/>Error boundaries"]\n        FlushCompleted["flushCompletedBoundaries()<br/>Ready boundaries"]\n        FlushPartial["flushPartialBoundaries()<br/>Partial boundaries"]\n    end\n    \n    subgraph "Completion"\n        AllComplete["allPendingTasks === 0?"]\n        CloseRequest["request.status = CLOSED<br/>close(destination)"]\n        FlushHeaders["flushHeaders()<br/>Send Link headers"]\n    end\n    \n    Entry --> CheckStatus\n    CheckStatus -->|Yes| PopTask\n    PopTask --> HasTask\n    HasTask -->|Yes| SetCurrentRequest\n    SetCurrentRequest --> RenderWithResumeId\n    RenderWithResumeId --> RerenderTask\n    RerenderTask --> ClearCurrentRequest\n    ClearCurrentRequest --> PopTask\n    \n    HasTask -->|No| FlushClientRendered\n    FlushClientRendered --> FlushCompleted\n    FlushCompleted --> FlushPartial\n    FlushPartial --> AllComplete\n    \n    AllComplete -->|Yes| CloseRequest\n    CloseRequest --> FlushHeaders\n    \n    CheckStatus -->|No| FlushHeaders\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:2800-3000]()\n\n### renderNode Dispatch\n\nThe `renderNode` function dispatches to specialized rendering logic based on node type.\n\n**Node Type Dispatch**\n\n| Node Type | Symbol | Rendering Function |\n|-----------|--------|-------------------|\n| React Element | `REACT_ELEMENT_TYPE` | `renderElement(request, task, type, props, ref)` |\n| Lazy Component | `REACT_LAZY_TYPE` | `renderLazyComponent(request, task, lazyComponent)` |\n| Suspense | `REACT_SUSPENSE_TYPE` | `renderSuspenseBoundary(request, task, props)` |\n| SuspenseList | `REACT_SUSPENSE_LIST_TYPE` | `renderSuspenseList(request, task, props)` |\n| Fragment | `REACT_FRAGMENT_TYPE` | `renderNodeFragment(request, task, children)` |\n| Provider | `REACT_CONTEXT_TYPE` | `pushProvider(context, value)` |\n| Forward Ref | `REACT_FORWARD_REF_TYPE` | `renderForwardRef(request, task, render, props, ref)` |\n| Memo | `REACT_MEMO_TYPE` | `renderMemo(request, task, type, props)` |\n| Portal | `REACT_PORTAL_TYPE` | Error - not supported |\n| String/Number | primitive | `pushTextInstance(segment, text)` |\n| Array | `isArray(node)` | `renderChildrenArray(request, task, children)` |\n| Async Iterable | `node[ASYNC_ITERATOR]` | `renderAsyncIterable(request, task, iterable)` |\n\nSources: [packages/react-server/src/ReactFizzServer.js:1800-2400]()\n\n## Suspense Boundary Management\n\nSuspense boundaries enable streaming and progressive rendering by allowing parts of the tree to suspend while other parts complete.\n\n**Suspense Boundary Rendering Flow**\n\n```mermaid\ngraph TB\n    subgraph "Boundary Setup"\n        CreateBoundary["createSuspenseBoundary(request, row, fallbackTasks, defer)"]\n        ContentSegment["Create content segment<br/>segment.boundary = boundary"]\n        FallbackSegment["Create fallback segment"]\n        \n        ContentTask["createRenderTask(content)<br/>boundary.pendingTasks++"]\n        FallbackTask["createRenderTask(fallback)<br/>fallbackAbortableTasks.add()"]\n    end\n    \n    subgraph "Content Rendering"\n        RenderContent["Render content children"]\n        ContentSuspends["Content suspends?"]\n        ContentComplete["Content completes<br/>boundary.pendingTasks--"]\n    end\n    \n    subgraph "Boundary States"\n        Pending["PENDING<br/>Still waiting"]\n        Completed["COMPLETED<br/>Content ready<br/>cancelFallbackTasks()"]\n        ClientRendered["CLIENT_RENDERED<br/>Error occurred"]\n    end\n    \n    subgraph "Output Decision"\n        CheckEligible["isEligibleForOutlining()<br/>byteSize > 500"]\n        Inline["Inline content<br/>Write directly"]\n        Outline["Outline boundary<br/>Write template + script"]\n    end\n    \n    CreateBoundary --> ContentSegment\n    CreateBoundary --> FallbackSegment\n    ContentSegment --> ContentTask\n    FallbackSegment --> FallbackTask\n    \n    ContentTask --> RenderContent\n    RenderContent --> ContentSuspends\n    ContentSuspends -->|Yes| Pending\n    ContentSuspends -->|No| ContentComplete\n    \n    ContentComplete --> Completed\n    Completed --> CheckEligible\n    \n    CheckEligible -->|Small| Inline\n    CheckEligible -->|Large| Outline\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:796-841](), [packages/react-server/src/ReactFizzServer.js:2500-2700]()\n\n### Boundary Completion and Flushing\n\nWhen a boundary completes, it moves through queues before being flushed to the output.\n\n**Boundary Flush Process**\n\n```mermaid\ngraph LR\n    subgraph "Completion"\n        DecPending["boundary.pendingTasks--"]\n        CheckZero["pendingTasks === 0?"]\n        SetCompleted["boundary.status = COMPLETED"]\n    end\n    \n    subgraph "Queueing"\n        QueueCompleted["completedBoundaries.push(boundary)"]\n        CheckShell["Shell completed?"]\n        QueuePartial["partialBoundaries.push(boundary)"]\n    end\n    \n    subgraph "Flushing"\n        FlushCompleted["flushCompletedBoundary(request, destination, boundary)"]\n        WriteStart["writeStartCompletedSuspenseBoundary()"]\n        WriteSegments["Write all completedSegments"]\n        WriteEnd["writeEndCompletedSuspenseBoundary()"]\n        WriteInstruction["writeCompletedBoundaryInstruction(boundaryID, contentSegmentID)"]\n    end\n    \n    DecPending --> CheckZero\n    CheckZero -->|Yes| SetCompleted\n    SetCompleted --> CheckShell\n    CheckShell -->|Complete| QueueCompleted\n    CheckShell -->|Not complete| QueuePartial\n    \n    QueueCompleted --> FlushCompleted\n    FlushCompleted --> WriteStart\n    WriteStart --> WriteSegments\n    WriteSegments --> WriteEnd\n    WriteEnd --> WriteInstruction\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:3200-3500]()\n\n## Resource Management\n\nReact Fizz manages resources (scripts, stylesheets, preloads) through the `RenderState` and `ResumableState` structures to optimize loading and prevent duplicates.\n\n**Resource State Architecture**\n\n```mermaid\ngraph TB\n    subgraph "ResumableState (Serializable)"\n        DNS["dnsResources: {[key]: Exists}<br/>DNS prefetches"]\n        Connect["connectResources:<br/>default/anonymous/credentials<br/>{[key]: Exists}"]\n        Style["styleResources: {[key]: Exists|Preloaded}"]\n        Script["scriptResources: {[key]: Exists|Preloaded}"]\n        ModuleScript["moduleScriptResources: {[key]: Exists|Preloaded}"]\n        Image["imageResources: {[key]: Preloaded}"]\n    end\n    \n    subgraph "RenderState (Per-Request)"\n        Preconnects["preconnects: Set<Resource><br/>Flush early"]\n        FontPreloads["fontPreloads: Set<Resource><br/>Flush early"]\n        HighImagePreloads["highImagePreloads: Set<Resource><br/>Flush early"]\n        Styles["styles: Map<string, StyleQueue><br/>Stylesheets + dependencies"]\n        Scripts["scripts: Set<Resource><br/>Script tags"]\n        BulkPreloads["bulkPreloads: Set<Resource><br/>Regular preloads"]\n    end\n    \n    subgraph "HoistableState (Per-Boundary)"\n        BoundaryStyles["styles: Set<string><br/>Required stylesheets"]\n        BoundaryScripts["scripts: Set<string><br/>Required scripts"]\n    end\n    \n    subgraph "Headers"\n        HeadersObj["headers: {<br/>preconnects: string,<br/>fontPreloads: string,<br/>highImagePreloads: string,<br/>remainingCapacity: number<br/>}"]\n        OnHeaders["onHeaders(headers: HeadersDescriptor)"]\n    end\n    \n    DNS --> Preconnects\n    Connect --> Preconnects\n    Style --> Styles\n    Script --> Scripts\n    Image --> HighImagePreloads\n    \n    Styles --> BoundaryStyles\n    Scripts --> BoundaryScripts\n    \n    Preconnects --> HeadersObj\n    FontPreloads --> HeadersObj\n    HighImagePreloads --> HeadersObj\n    HeadersObj --> OnHeaders\n```\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:260-310](), [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:148-234]()\n\n### Resource Deduplication\n\nResources are tracked in `ResumableState` to prevent duplicate output across boundaries and resume scenarios.\n\n**Resource Tracking Types**\n\n| Type | Tracked By | Values |\n|------|-----------|--------|\n| DNS Prefetch | `href` | `EXISTS` (null) |\n| Preconnect | `href` + `crossOrigin` | `EXISTS` (null) |\n| Stylesheet | `href` | `EXISTS` \\| `[crossOrigin, integrity]` |\n| Script | `src` | `EXISTS` \\| `[crossOrigin, integrity]` |\n| Module | `src` | `EXISTS` \\| `[crossOrigin, integrity]` |\n| Image Preload | `href` + `imageSrcSet` + `imageSizes` | `[]` (empty array) |\n| Font Preload | `href` | `[]` (empty array) |\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:236-258]()\n\n### Resource Flushing Order\n\nResources are flushed in a specific order to optimize page load performance.\n\n**Resource Flush Sequence**\n\n```mermaid\ngraph TB\n    Start["Start Flushing"]\n    \n    subgraph "Shell Phase"\n        Charset["1. charsetChunks<br/><meta charset>"]\n        Viewport["2. viewportChunks<br/><meta viewport>"]\n        EarlyPreconnects["3. preconnects (Set)<br/><link rel=preconnect>"]\n        EarlyFontPreloads["4. fontPreloads (Set)<br/><link rel=preload as=font>"]\n        EarlyImagePreloads["5. highImagePreloads (Set)<br/><link rel=preload as=image fetchpriority=high>"]\n        Hoistables["6. hoistableChunks<br/>Other <link>/<meta> tags"]\n    end\n    \n    subgraph "Boundary Phase"\n        BoundaryStyles["7. Boundary styles<br/>writeHoistablesForBoundary()"]\n        BoundaryScripts["8. Boundary scripts<br/>Required dependencies"]\n    end\n    \n    subgraph "Late Resources"\n        BulkPreloads["9. bulkPreloads<br/>Regular priority preloads"]\n        BootstrapScripts["10. bootstrapScripts<br/>Application initialization"]\n    end\n    \n    Start --> Charset\n    Charset --> Viewport\n    Viewport --> EarlyPreconnects\n    EarlyPreconnects --> EarlyFontPreloads\n    EarlyFontPreloads --> EarlyImagePreloads\n    EarlyImagePreloads --> Hoistables\n    Hoistables --> BoundaryStyles\n    BoundaryStyles --> BoundaryScripts\n    BoundaryScripts --> BulkPreloads\n    BulkPreloads --> BootstrapScripts\n```\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:3800-4200]()\n\n## Platform-Specific Implementations\n\nReact Fizz has multiple entry points for different JavaScript environments, each adapting the core engine to platform-specific streaming APIs.\n\n**Platform Entry Points**\n\n```mermaid\ngraph TB\n    subgraph "Node.js"\n        NodeEntry["ReactDOMFizzServerNode.js<br/>renderToPipeableStream()"]\n        NodeStream["Node Writable Stream"]\n        NodeDestination["Destination = Writable"]\n    end\n    \n    subgraph "Web Browsers / Workers"\n        BrowserEntry["ReactDOMFizzServerBrowser.js<br/>renderToReadableStream()"]\n        WebStream["ReadableStream (Web Streams API)"]\n        WebDestination["Destination = ReadableStreamController"]\n    end\n    \n    subgraph "Edge Runtime"\n        EdgeEntry["ReactDOMFizzServerEdge.js<br/>renderToReadableStream()"]\n        EdgeStream["ReadableStream"]\n    end\n    \n    subgraph "Bun Runtime"\n        BunEntry["ReactDOMFizzServerBun.js<br/>renderToReadableStream()"]\n        BunStream["ReadableStream"]\n    end\n    \n    subgraph "Static Generation"\n        StaticNode["ReactDOMFizzStaticNode.js<br/>prerender()"]\n        StaticBrowser["ReactDOMFizzStaticBrowser.js<br/>prerender()"]\n        StaticEdge["ReactDOMFizzStaticEdge.js<br/>prerender()"]\n        PrerenderRequest["createPrerenderRequest()<br/>trackedPostpones"]\n    end\n    \n    subgraph "Core Engine"\n        FizzServer["ReactFizzServer.js<br/>createRequest()<br/>performWork()"]\n        StreamConfig["ReactServerStreamConfig<br/>writeChunk()<br/>scheduleWork()"]\n    end\n    \n    NodeEntry --> NodeStream\n    NodeStream --> NodeDestination\n    NodeDestination --> FizzServer\n    \n    BrowserEntry --> WebStream\n    WebStream --> WebDestination\n    WebDestination --> FizzServer\n    \n    EdgeEntry --> EdgeStream\n    BunEntry --> BunStream\n    EdgeStream --> FizzServer\n    BunStream --> FizzServer\n    \n    StaticNode --> PrerenderRequest\n    StaticBrowser --> PrerenderRequest\n    StaticEdge --> PrerenderRequest\n    PrerenderRequest --> FizzServer\n    \n    FizzServer --> StreamConfig\n```\n\nSources: [packages/react-dom/src/server/ReactDOMFizzServerNode.js:1-300](), [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js:1-200](), [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js:1-200]()\n\n### Node.js: renderToPipeableStream\n\nThe Node.js implementation uses Node\'s `Writable` stream interface with backpressure support.\n\n**Node.js Streaming Flow**\n\n```mermaid\ngraph LR\n    subgraph "API"\n        Render["renderToPipeableStream(children, options)"]\n        PipeableStream["PipeableStream<br/>{pipe, abort}"]\n    end\n    \n    subgraph "Setup"\n        CreateReq["createRequestImpl()<br/>createResumableState()<br/>createRenderState()"]\n        StartWork["startWork(request)"]\n    end\n    \n    subgraph "Streaming"\n        Pipe["pipe(destination: Writable)"]\n        DrainHandler["\'drain\' event<br/>startFlowing()"]\n        ErrorHandler["\'error\' event<br/>abort()"]\n        CloseHandler["\'close\' event<br/>abort()"]\n    end\n    \n    subgraph "Callbacks"\n        OnShellReady["onShellReady()<br/>Initial HTML ready"]\n        OnAllReady["onAllReady()<br/>All content ready"]\n        OnShellError["onShellError(error)<br/>Shell failed"]\n    end\n    \n    Render --> CreateReq\n    CreateReq --> StartWork\n    StartWork --> PipeableStream\n    \n    PipeableStream --> Pipe\n    Pipe --> DrainHandler\n    Pipe --> ErrorHandler\n    Pipe --> CloseHandler\n    \n    StartWork --> OnShellReady\n    StartWork --> OnAllReady\n    StartWork --> OnShellError\n```\n\nSources: [packages/react-dom/src/server/ReactDOMFizzServerNode.js:131-166]()\n\n### Browser/Edge: renderToReadableStream\n\nThe browser implementation uses the Web Streams API\'s `ReadableStream` with a bytes source.\n\n**Web Streams Flow**\n\n```mermaid\ngraph LR\n    subgraph "API"\n        Render["renderToReadableStream(children, options)"]\n        Promise["Promise<ReactDOMServerReadableStream>"]\n        ReadableStream["ReadableStream & {allReady: Promise}"]\n    end\n    \n    subgraph "Controller"\n        BytesSource["ReadableStream({type: \'bytes\'})"]\n        Pull["pull(controller)<br/>startFlowing(request, controller)"]\n        Cancel["cancel(reason)<br/>abort(request, reason)"]\n    end\n    \n    subgraph "Promises"\n        ShellPromise["Shell promise<br/>resolve(stream)"]\n        AllReadyPromise["allReady promise<br/>resolve when done"]\n    end\n    \n    subgraph "Error Handling"\n        OnShellReady["onShellReady()<br/>resolve shell promise"]\n        OnShellError["onShellError(error)<br/>reject shell promise"]\n        OnFatalError["onFatalError(error)<br/>reject allReady"]\n    end\n    \n    Render --> BytesSource\n    BytesSource --> Pull\n    BytesSource --> Cancel\n    \n    Pull --> OnShellReady\n    OnShellReady --> ShellPromise\n    ShellPromise --> Promise\n    Promise --> ReadableStream\n    \n    ReadableStream --> AllReadyPromise\n    OnFatalError --> AllReadyPromise\n```\n\nSources: [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js:75-165]()\n\n## Prerendering and Resumability\n\nPrerendering generates static HTML while tracking postponed boundaries for later resumption.\n\n**Prerender Architecture**\n\n```mermaid\ngraph TB\n    subgraph "Prerender Request"\n        CreatePrerender["createPrerenderRequest(children)<br/>trackedPostpones = {<br/>  workingMap: Map<KeyNode, ReplayNode>,<br/>  rootNodes: Array<ReplayNode>,<br/>  rootSlots: ResumeSlots<br/>}"]\n    end\n    \n    subgraph "Tracking Postponed Holes"\n        ComponentKey["keyPath: Root|KeyNode<br/>Unique path in tree"]\n        ReplayNode["ReplayNode<br/>[name, key, children, slots]"]\n        ReplaySuspense["ReplaySuspenseBoundary<br/>[name, key, children, contentSlots, fallback, rootSegmentID]"]\n        WorkingMap["workingMap.set(keyPath, replayNode)"]\n    end\n    \n    subgraph "Completion"\n        PostponedState["getPostponedState(request)<br/>{<br/>  replayNodes,<br/>  replaySlots,<br/>  resumableState,<br/>  nextSegmentId,<br/>  ...formatContext<br/>}"]\n    end\n    \n    subgraph "Resume"\n        ResumeRequest["resumeRequest(children, postponedState)<br/>OR<br/>resumeAndPrerenderRequest(children, postponedState)"]\n        CreateReplayTasks["createReplayTask(replay: ReplaySet)<br/>Validates against tracked nodes"]\n        ReplayContinue["Continue from postponed holes"]\n    end\n    \n    CreatePrerender --> ComponentKey\n    ComponentKey --> ReplayNode\n    ReplayNode --> ReplaySuspense\n    ReplaySuspense --> WorkingMap\n    WorkingMap --> PostponedState\n    \n    PostponedState --> ResumeRequest\n    ResumeRequest --> CreateReplayTasks\n    CreateReplayTasks --> ReplayContinue\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:615-770]()\n\n### PostponedState Structure\n\nThe `PostponedState` captures everything needed to resume rendering from postponed boundaries.\n\n**PostponedState Fields**\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `replayNodes` | `Array<ReplayNode>` | Tree of tracked component keys |\n| `replaySlots` | `ResumeSlots` | Segment IDs to resume |\n| `resumableState` | `ResumableState` | Resource state to continue |\n| `nextSegmentId` | `number` | Next available segment ID |\n| `rootFormatContext` | `FormatContext` | HTML/SVG/MathML context |\n| `progressiveChunkSize` | `number` | Chunk size setting |\n\nSources: [packages/react-server/src/ReactFizzServer.js:3900-4000]()\n\n### ReplayTask Validation\n\nWhen resuming, `ReplayTask` instances validate that the component tree matches the tracked structure.\n\n**Replay Validation Flow**\n\n```mermaid\ngraph TB\n    RenderReplay["renderNode(request, task, node)<br/>task.replay !== null"]\n    \n    subgraph "Key Matching"\n        GetKey["getKeyPath(task)"]\n        FindReplayNode["Find matching ReplayNode<br/>in replay.nodes"]\n        KeyMatches["Keys match?"]\n    end\n    \n    subgraph "Suspense Handling"\n        IsSuspense["Is Suspense boundary?"]\n        ReplaySuspenseBoundary["Cast to ReplaySuspenseBoundary"]\n        ResumeChildren["Create ReplayTask for children"]\n        ResumeFallback["Track fallback if present"]\n    end\n    \n    subgraph "Error Cases"\n        NoMatch["No matching ReplayNode"]\n        AbortReplay["Abort replay<br/>Client render boundary"]\n    end\n    \n    RenderReplay --> GetKey\n    GetKey --> FindReplayNode\n    FindReplayNode --> KeyMatches\n    \n    KeyMatches -->|Yes| IsSuspense\n    KeyMatches -->|No| NoMatch\n    NoMatch --> AbortReplay\n    \n    IsSuspense -->|Yes| ReplaySuspenseBoundary\n    ReplaySuspenseBoundary --> ResumeChildren\n    ReplaySuspenseBoundary --> ResumeFallback\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:1900-2100]()\n\n## Streaming Format and Instructions\n\nReact Fizz can output HTML in two formats: inline scripts or data attributes with an external runtime.\n\n**Streaming Formats**\n\n| Format | Value | Configuration | Use Case |\n|--------|-------|---------------|----------|\n| `ScriptStreamingFormat` | 0 | Default | Inline instructions in `<script>` tags |\n| `DataStreamingFormat` | 1 | `unstable_externalRuntimeSrc` | Instructions via data attributes, separate runtime |\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:122-124]()\n\n### Instruction State Bits\n\nThe `InstructionState` tracks which instructions have been sent to avoid duplication.\n\n**InstructionState Flags**\n\n| Flag | Bit | Purpose |\n|------|-----|---------|\n| `SentCompleteSegmentFunction` | 0b000000001 | `completeSegment` function sent |\n| `SentCompleteBoundaryFunction` | 0b000000010 | `completeBoundary` function sent |\n| `SentClientRenderFunction` | 0b000000100 | `clientRenderBoundary` function sent |\n| `SentStyleInsertionFunction` | 0b000001000 | `completeBoundaryWithStyles` sent |\n| `SentFormReplayingRuntime` | 0b000010000 | Form replaying runtime sent |\n| `SentCompletedShellId` | 0b000100000 | Shell completion marker sent |\n| `SentMarkShellTime` | 0b001000000 | Shell timing marker sent |\n| `NeedUpgradeToViewTransitions` | 0b010000000 | View transitions needed |\n| `SentUpgradeToViewTransitions` | 0b100000000 | View transition upgrade sent |\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:127-136]()\n\n### Boundary Completion Instructions\n\nWhen a boundary completes, an inline script or data attribute instructs the client to reveal the content.\n\n**Boundary Instruction Output**\n\n```mermaid\ngraph LR\n    subgraph "Inline Script Format"\n        ScriptStart["<script>"]\n        FunctionCall["$RC(boundaryID, contentSegmentID)"]\n        ScriptEnd["</script>"]\n    end\n    \n    subgraph "Data Attribute Format"\n        Template["<template id=B:boundaryID"]\n        DataAttr["data-dgst=errorDigest"]\n        DataRender["data-msg=errorMessage"]\n        TemplateEnd["></template>"]\n    end\n    \n    subgraph "Client Processing"\n        Runtime["React runtime on client"]\n        RevealContent["Reveal completed content"]\n        RemoveFallback["Remove fallback"]\n    end\n    \n    ScriptStart --> FunctionCall\n    FunctionCall --> ScriptEnd\n    ScriptEnd --> Runtime\n    \n    Template --> DataAttr\n    DataAttr --> DataRender\n    DataRender --> TemplateEnd\n    TemplateEnd --> Runtime\n    \n    Runtime --> RevealContent\n    RevealContent --> RemoveFallback\n```\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:4500-4700]()\n\n## Error Handling and Recovery\n\nReact Fizz handles errors at different levels with different recovery strategies.\n\n**Error Handling Hierarchy**\n\n```mermaid\ngraph TB\n    subgraph "Error Types"\n        RootError["Root Error<br/>No error boundary"]\n        BoundaryError["Boundary Error<br/>Within Suspense"]\n        FallbackError["Fallback Error<br/>Within fallback"]\n    end\n    \n    subgraph "Root Error Handling"\n        RootAbort["Abort entire request"]\n        RejectPromise["Reject entry point promise"]\n        CloseWithError["closeWithError(destination, error)"]\n    end\n    \n    subgraph "Boundary Error Handling"\n        MarkClientRendered["boundary.status = CLIENT_RENDERED<br/>boundary.errorDigest = digest"]\n        QueueClientRender["clientRenderedBoundaries.push(boundary)"]\n        FlushClientRender["writeClientRenderBoundaryInstruction(boundaryID, digest, message)"]\n    end\n    \n    subgraph "Error Callbacks"\n        OnError["onError(error, errorInfo)<br/>Returns error digest"]\n        OnShellError["onShellError(error)<br/>Called for shell errors"]\n        OnFatalError["onFatalError(error)<br/>Called for unrecoverable errors"]\n    end\n    \n    RootError --> RootAbort\n    RootAbort --> OnShellError\n    RootAbort --> OnFatalError\n    RootAbort --> RejectPromise\n    RejectPromise --> CloseWithError\n    \n    BoundaryError --> MarkClientRendered\n    MarkClientRendered --> OnError\n    OnError --> QueueClientRender\n    QueueClientRender --> FlushClientRender\n    \n    FallbackError --> RootAbort\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:3600-3800]()\n\n### Error Information\n\nThe `onError` callback receives detailed error information for logging and monitoring.\n\n**ErrorInfo Structure**\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `componentStack` | `string` | Component stack trace |\n| `error` | `mixed` | The thrown error object |\n| `errorInfo.digest` | `?string` | Error hash for client matching |\n\nSources: [packages/react-server/src/ReactFizzServer.js:384-400]()\n\n## Performance Optimizations\n\n### Progressive Chunk Size\n\nThe `progressiveChunkSize` option controls how much HTML is buffered before flushing.\n\n**Default Chunk Size Calculation**\n\nThe default of 12,800 bytes is based on:\n- 3G network speed: ~500 kbits/second\n- Target: Send content every 500ms\n- 500ms  (500 kbits/s)  0.8 (realistic throughput)  0.5 (HTML overhead) / 2 = 12.5kb\n\nSources: [packages/react-server/src/ReactFizzServer.js:414-429]()\n\n### Boundary Inlining\n\nSmall boundaries can be inlined directly instead of being outlined with separate instructions.\n\n**Outlining Eligibility**\n\n```javascript\nfunction isEligibleForOutlining(request, boundary) {\n  return (\n    (boundary.byteSize > 500 ||\n      hasSuspenseyContent(boundary.contentState) ||\n      boundary.defer) &&\n    boundary.preamble === null\n  );\n}\n```\n\n- Boundaries < 500 bytes: Inlined\n- Boundaries  500 bytes: Outlined with instructions\n- Defer boundaries: Always outlined\n- Preamble boundaries: Never outlined (for render-blocking)\n\nSources: [packages/react-server/src/ReactFizzServer.js:466-482]()\n\n### Early Headers\n\nThe `onHeaders` callback allows sending `Link` headers before any HTML for early hints.\n\n**Header Capacity Management**\n\nResources are accumulated into Link headers until capacity is reached:\n- Default capacity: 2000 UTF-16 code units (~2KB)\n- Priority order: preconnects, font preloads, high-priority image preloads\n- Remaining resources flush in HTML `<link>` tags\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:367-489]()\n\n---\n\n# Page: React Server Components (Flight)\n\n# React Server Components (Flight)\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightClient.js](packages/react-client/src/ReactFlightClient.js)\n- [packages/react-client/src/ReactFlightReplyClient.js](packages/react-client/src/ReactFlightReplyClient.js)\n- [packages/react-client/src/ReactFlightTemporaryReferences.js](packages/react-client/src/ReactFlightTemporaryReferences.js)\n- [packages/react-client/src/__tests__/ReactFlight-test.js](packages/react-client/src/__tests__/ReactFlight-test.js)\n- [packages/react-server-dom-esm/src/ReactFlightESMReferences.js](packages/react-server-dom-esm/src/ReactFlightESMReferences.js)\n- [packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js](packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js)\n- [packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js](packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js)\n- [packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js](packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js)\n- [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js](packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js)\n- [packages/react-server/src/ReactFlightReplyServer.js](packages/react-server/src/ReactFlightReplyServer.js)\n- [packages/react-server/src/ReactFlightServer.js](packages/react-server/src/ReactFlightServer.js)\n- [packages/react-server/src/ReactFlightServerTemporaryReferences.js](packages/react-server/src/ReactFlightServerTemporaryReferences.js)\n- [scripts/error-codes/codes.json](scripts/error-codes/codes.json)\n\n</details>\n\n\n\nReact Server Components (Flight) is React\'s protocol and runtime system for executing React components on the server, serializing them into a streamable format, and reconstructing them on the client. This system enables server-side computation while maintaining React\'s component model and interactivity on the client.\n\nFor information about streaming server-side rendering with HTML output, see [React Fizz (Streaming SSR)](#5.1). For traditional server rendering patterns, see [Legacy Server Rendering](#5.3).\n\n## Architecture Overview\n\nReact Flight is the protocol and runtime for React Server Components (RSC). It serializes component trees on the server into a streaming wire format and reconstructs them on the client. The protocol enables server-side components to pass serialized data, client component references, and server function references to the client.\n\n### Server-to-Client Data Flow\n\n```mermaid\ngraph TB\n    SC["Server Component<br/>ReactElement"]\n    Request["Request<br/>(RequestInstance)"]\n    Task["Task<br/>(render unit)"]\n    Model["ReactClientValue<br/>(serializable model)"]\n    Chunks["Chunk Array<br/>(completedRegularChunks)"]\n    Stream["Destination<br/>(WritableStream)"]\n    \n    SC -->|"renderToPipeableStream()"| Request\n    Request -->|"createTask()"| Task\n    Task -->|"renderModelDestructive()"| Model\n    Model -->|"emitChunk()"| Chunks\n    Chunks -->|"flushBuffered()"| Stream\n    \n    subgraph "Client Side"\n        Response["Response<br/>(_chunks Map)"]\n        ReactPromise["ReactPromise<br/>(SomeChunk)"]\n        Element["React Element"]\n    end\n    \n    Stream -->|"processFullRow()"| Response\n    Response -->|"getChunk()"| ReactPromise\n    ReactPromise -->|"initializeModelChunk()"| Element\n```\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:651-777](), [packages/react-client/src/ReactFlightClient.js:245-331](), [packages/react-client/src/ReactFlightClient.js:1437-1580]()\n\n## Core Components\n\n### Flight Server (ReactFlightServer)\n\nThe Flight server executes React components and serializes their output into chunks. The `Request` object maintains serialization state and manages chunk emission.\n\n#### Request Structure\n\n```mermaid\ngraph TD\n    Request["Request"]\n    \n    Request --> status["status: OPENING|OPEN|ABORTING|CLOSING|CLOSED"]\n    Request --> destination["destination: Destination"]\n    Request --> bundlerConfig["bundlerConfig: ClientManifest"]\n    Request --> chunks["Chunk Arrays"]\n    Request --> writtenObjects["writtenObjects: WeakMap"]\n    Request --> cache["cache: Map<Function, mixed>"]\n    \n    chunks --> completedRegularChunks["completedRegularChunks"]\n    chunks --> completedErrorChunks["completedErrorChunks"]\n    chunks --> completedImportChunks["completedImportChunks"]\n    chunks --> completedHintChunks["completedHintChunks"]\n    \n    Task["Task"]\n    Task --> id["id: number"]\n    Task --> model["model: ReactClientValue"]\n    Task --> keyPath["keyPath: ReactKey"]\n    Task --> formatContext["formatContext: FormatContext"]\n```\n\n**Key Types and Functions:**\n\n| Symbol | Type | Purpose |\n|--------|------|---------|\n| `Request` | Object | Central state for a Flight render, tracks chunks and serialization |\n| `Task` | Object | Unit of work for rendering a component tree segment |\n| `ReactClientValue` | Type | Union of all serializable types (elements, primitives, references) |\n| `createRequest()` | Function | Initializes request with `bundlerConfig` and callbacks |\n| `createTask()` | Function | Creates a task with `id`, `model`, and `keyPath` |\n| `renderModelDestructive()` | Function | Main serialization dispatcher, mutates model to JSON-compatible form |\n| `emitChunk()` | Function | Writes chunk rows to destination stream |\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:569-615](), [packages/react-server/src/ReactFlightServer.js:533-549](), [packages/react-server/src/ReactFlightServer.js:1756-1858]()\n\n### Flight Client (ReactFlightClient)\n\nThe Flight client parses the streamed protocol and reconstructs React elements. It maintains a `Response` object with a `Map` of chunks that transition through states.\n\n#### Client Architecture\n\n```mermaid\ngraph TD\n    Response["Response"]\n    \n    Response --> _chunks["_chunks: Map<number, SomeChunk>"]\n    Response --> _bundlerConfig["_bundlerConfig: ServerConsumerModuleMap"]\n    Response --> _fromJSON["_fromJSON: (key, value) => any"]\n    Response --> _stringDecoder["_stringDecoder: StringDecoder"]\n    Response --> _closed["_closed: boolean"]\n    \n    SomeChunk["SomeChunk<T>"]\n    SomeChunk --> PendingChunk["PendingChunk<br/>status: \'pending\'"]\n    SomeChunk --> BlockedChunk["BlockedChunk<br/>status: \'blocked\'"]\n    SomeChunk --> ResolvedModelChunk["ResolvedModelChunk<br/>status: \'resolved_model\'"]\n    SomeChunk --> ResolvedModuleChunk["ResolvedModuleChunk<br/>status: \'resolved_module\'"]\n    SomeChunk --> InitializedChunk["InitializedChunk<br/>status: \'fulfilled\'"]\n    SomeChunk --> ErroredChunk["ErroredChunk<br/>status: \'rejected\'"]\n```\n\n**Key Functions:**\n\n| Function | Input | Output | Purpose |\n|----------|-------|--------|---------|\n| `createFromReadableStream()` | `stream: ReadableStream` | `Promise<T>` | Creates Response, starts stream parsing |\n| `processFullRow()` | `response: Response, row: string` | `void` | Parses row format: `id:tag data` |\n| `parseModelString()` | `response: Response, json: string` | `any` | Parses JSON with special prefixes (`$`, `@`, etc.) |\n| `getChunk()` | `response: Response, id: number` | `SomeChunk<T>` | Retrieves or creates chunk by ID |\n| `initializeModelChunk()` | `chunk: ResolvedModelChunk` | `void` | Converts JSON model to React element |\n| `readChunk()` | `chunk: SomeChunk<T>` | `T` | Synchronously reads initialized chunk or throws |\n\n**Row Parser State Machine:**\n\nThe client processes incoming bytes through a state machine defined by `RowParserState`:\n\n| State | Value | Parsing |\n|-------|-------|---------|\n| `ROW_ID` | `0` | Reading chunk ID (hexadecimal) |\n| `ROW_TAG` | `1` | Reading row type tag (single char) |\n| `ROW_LENGTH` | `2` | Reading length field for binary chunks |\n| `ROW_CHUNK_BY_NEWLINE` | `3` | Reading text chunk until `\\n` |\n| `ROW_CHUNK_BY_LENGTH` | `4` | Reading binary chunk by byte count |\n\n**Sources:** [packages/react-client/src/ReactFlightClient.js:345-383](), [packages/react-client/src/ReactFlightClient.js:146-152](), [packages/react-client/src/ReactFlightClient.js:162-235](), [packages/react-client/src/ReactFlightClient.js:1437-1580]()\n\n## Wire Protocol Format\n\n### Row-Based Streaming Protocol\n\nFlight streams data as newline-delimited rows. Each row has the format: `{id}:{tag}{data}\\n`\n\n**Row Format Components:**\n\n| Component | Format | Description |\n|-----------|--------|-------------|\n| `id` | Hex integer | Unique chunk identifier (e.g., `0`, `1a`, `2f`) |\n| `:` | Delimiter | Separates ID from tag |\n| `tag` | Single char | Row type indicator |\n| `data` | Variable | JSON string, binary length, or empty |\n| `\\n` | Terminator | Marks end of row (except binary chunks) |\n\n**Row Tags:**\n\n| Tag | Name | Data Format | Purpose |\n|-----|------|-------------|---------|\n| `J` | Model | JSON string | Serialized model/element |\n| `M` | Module (Client Reference) | JSON string | Client component reference |\n| `E` | Error | JSON error object | Error chunk |\n| `T` | Hint/Metadata | JSON string | Preload hints, metadata |\n| `@` | Promise | Promise ID | Async chunk reference |\n| `H` | Halt (DEV) | Empty | Indicates stopped resolution |\n| `R` | ReadableStream start | Empty | Stream initialization |\n| `r` | BYOB stream start | Empty | Binary stream initialization |\n| `C` | Stream close | Empty or final value | Stream completion |\n| `X` | Async iterator start | Empty | Iterator initialization |\n| `x` | Iterator instance | Empty | Single-shot iterator |\n\n**Example Row Sequences:**\n\n```\n0:J{"type":"div","props":{"children":"Hello"}}\n1:M{"id":"./ClientComponent.js","chunks":["chunk1"],"name":"default"}\n2:@3\n3:J"Resolved value"\n```\n\n**Sources:** [packages/react-client/src/ReactFlightClient.js:1437-1580](), [packages/react-server/src/ReactFlightServer.js:1860-1930]()\n\n### Value Serialization Encoding\n\nThe server encodes special values with prefix markers in JSON strings:\n\n```mermaid\ngraph TD\n    Value["Value to Serialize"]\n    \n    Value -->|"reference to chunk"| RefPrefix["$ + hex ID<br/>e.g., \'$5\'"]\n    Value -->|"Promise"| PromisePrefix["$@ + hex ID<br/>e.g., \'$@a\'"]\n    Value -->|"Server Reference"| ServerPrefix["$F + hex ID<br/>e.g., \'$F3\'"]\n    Value -->|"Client Reference"| ClientPrefix["$$id<br/>e.g., \'$$./Component.js#default\'"]\n    Value -->|"Symbol"| SymbolPrefix["$S + symbol key<br/>e.g., \'$Sreact.element\'"]\n    Value -->|"-0"| NegZero["$-0"]\n    Value -->|"Infinity"| Inf["$Infinity"]\n    Value -->|"-Infinity"| NegInf["$-Infinity"]\n    Value -->|"NaN"| NotANumber["$NaN"]\n    Value -->|"undefined"| Undef["$undefined"]\n    Value -->|"Date"| DatePrefix["$D + ISO string<br/>e.g., \'$D2023-01-01T00:00:00.000Z\'"]\n    Value -->|"BigInt"| BigIntPrefix["$n + decimal<br/>e.g., \'$n12345\'"]\n    Value -->|"Map"| MapPrefix["$Q + hex ID"]\n    Value -->|"Set"| SetPrefix["$W + hex ID"]\n    Value -->|"FormData"| FormDataPrefix["$K + hex ID"]\n    Value -->|"Blob/ArrayBuffer"| BlobPrefix["$B + hex ID"]\n    Value -->|"Iterator"| IteratorPrefix["$i + hex ID"]\n    Value -->|"Typed Array"| TypedArrayPrefix["$O + type + hex ID<br/>e.g., \'$OUint8Array1\'"]\n    Value -->|"Error"| ErrorPrefix["$E + serialized error"]\n    Value -->|"String starting with $"| Escaped["$$ + rest of string"]\n```\n\n**Key Encoding Functions:**\n\n| Function | Return | Purpose |\n|----------|--------|---------|\n| `serializeByValueID(id)` | `\'$\' + id.toString(16)` | References to other chunks |\n| `serializePromiseID(id)` | `\'$@\' + id.toString(16)` | Async chunk placeholders |\n| `serializeServerReferenceID(id)` | `\'$F\' + id.toString(16)` | Server function references |\n| `serializeClientReference(ref)` | `\'$$\' + ref.$$id` | Client component module path |\n| `serializeNumber(n)` | Special string or number | Handles `-0`, `Infinity`, `NaN` |\n| `serializeSymbol(sym)` | `\'$S\' + key` | Well-known React symbols |\n| `escapeStringValue(s)` | `\'$\' + s` if starts with `$` | Escapes `$` prefix in strings |\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:1860-1930](), [packages/react-server/src/ReactFlightServer.js:1932-2042](), [packages/react-client/src/ReactFlightClient.js:1583-1800]()\n\n### Chunk States and Transitions\n\nChunks transition through states as data arrives and is processed:\n\n```mermaid\nstateDiagram-v2\n    [*] --> PENDING: getChunk() creates\n    PENDING --> BLOCKED: waiting on dependencies\n    PENDING --> RESOLVED_MODEL: receiveModel() called\n    PENDING --> RESOLVED_MODULE: receiveModule() called\n    PENDING --> ERRORED: triggerErrorOnChunk()\n    \n    BLOCKED --> RESOLVED_MODEL: dependencies resolved\n    BLOCKED --> ERRORED: dependency failed\n    \n    RESOLVED_MODEL --> INITIALIZED: initializeModelChunk() success\n    RESOLVED_MODEL --> BLOCKED: circular dependencies found\n    RESOLVED_MODEL --> ERRORED: initializeModelChunk() throws\n    \n    RESOLVED_MODULE --> INITIALIZED: initializeModuleChunk() loads\n    \n    INITIALIZED --> [*]\n    ERRORED --> [*]\n```\n\n**State Transitions:**\n\n- **PENDING  RESOLVED_MODEL**: Server sends `J` (JSON model) row with matching ID\n- **PENDING  RESOLVED_MODULE**: Server sends `M` (module reference) row  \n- **RESOLVED_MODEL  INITIALIZED**: `initializeModelChunk()` parses JSON and resolves references\n- **RESOLVED_MODULE  INITIALIZED**: `initializeModuleChunk()` loads client module\n- **BLOCKED**: Created when chunk references another pending chunk\n- **ERRORED**: Server sends `E` row or initialization throws\n\n**Sources:** [packages/react-client/src/ReactFlightClient.js:154-243](), [packages/react-client/src/ReactFlightClient.js:767-908](), [packages/react-client/src/ReactFlightClient.js:1126-1206]()\n\n## Component and Function References\n\n### Client References (Client Components)\n\nClient references represent components that must execute on the client. They are serialized as module metadata that the client can load.\n\n**Server-Side Handling:**\n\n```mermaid\ngraph LR\n    ServerComp["Server Component"]\n    Import["import ClientComp from \'./Client.js\'"]\n    ClientRef["ClientReference<br/>{$$typeof: CLIENT_REFERENCE,<br/>$$id: \'./Client.js#default\'}"]\n    Serialize["serializeClientReference()"]\n    Row["Row: M tag<br/>{id, chunks, name}"]\n    \n    ServerComp --> Import\n    Import --> ClientRef\n    ClientRef --> Serialize\n    Serialize --> Row\n```\n\n**Client-Side Resolution:**\n\n```mermaid\ngraph LR\n    Row["M row received"]\n    CreateChunk["createResolvedModuleChunk()"]\n    ResolvedModule["ResolvedModuleChunk<br/>status: \'resolved_module\'"]\n    InitModule["initializeModuleChunk()"]\n    LoadModule["resolveClientReference()"]\n    PreloadModule["preloadModule()"]\n    RequireModule["requireModule()"]\n    ClientComp["Client Component Function"]\n    \n    Row --> CreateChunk\n    CreateChunk --> ResolvedModule\n    ResolvedModule --> InitModule\n    InitModule --> LoadModule\n    LoadModule --> PreloadModule\n    PreloadModule --> RequireModule\n    RequireModule --> ClientComp\n```\n\n**Key Functions:**\n\n| Side | Function | Purpose |\n|------|----------|---------|\n| Server | `isClientReference(value)` | Checks `$$typeof === CLIENT_REFERENCE` |\n| Server | `getClientReferenceKey(ref)` | Extracts module path from reference |\n| Server | `resolveClientReferenceMetadata(config, ref)` | Gets chunk info from `ClientManifest` |\n| Client | `resolveClientReference(metadata)` | Creates lazy wrapper for module |\n| Client | `preloadModule(metadata)` | Preloads chunks (async) |\n| Client | `requireModule(metadata)` | Synchronously imports module |\n\n**ClientManifest Structure:**\n\nThe server uses a `ClientManifest` (bundler-generated) to map references to chunk IDs:\n\n```typescript\n{\n  "./ClientComponent.js#default": {\n    id: "client-chunk-123",\n    chunks: ["chunk-abc.js", "chunk-def.js"],\n    name: "default"\n  }\n}\n```\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:1932-2042](), [packages/react-client/src/ReactFlightClient.js:1208-1274](), [packages/react-client/src/ReactFlightClient.js:882-908]()\n\n### Server References (Server Actions)\n\nServer references enable client-to-server RPC. The client can call these functions, and Flight serializes arguments, invokes the server function, and returns results.\n\n**Server-Side Creation:**\n\n```mermaid\ngraph TD\n    ServerFunc["async function myAction(data) { }"]\n    Register["registerServerReference(fn, id, name)"]\n    Proxy["Server Reference Proxy<br/>{$$typeof: SERVER_REFERENCE,<br/>$$id: \'module#myAction\',<br/>$$bound: null}"]\n    Serialize["serializeServerReference()"]\n    Row["Row: F tag<br/>id + bound args"]\n    \n    ServerFunc --> Register\n    Register --> Proxy\n    Proxy --> Serialize\n    Serialize --> Row\n```\n\n**Client-Side Invocation:**\n\n```mermaid\ngraph LR\n    ClientCall["clientRef(arg1, arg2)"]\n    CallServer["callServer(id, args)"]\n    EncodeReply["encodeReply([arg1, arg2])"]\n    FormData["FormData with serialized args"]\n    ServerInvoke["Server receives request"]\n    DecodeReply["decodeReply(body, serverMap)"]\n    Invoke["serverFunc(...args)"]\n    Result["Flight response with result"]\n    \n    ClientCall --> CallServer\n    CallServer --> EncodeReply\n    EncodeReply --> FormData\n    FormData --> ServerInvoke\n    ServerInvoke --> DecodeReply\n    DecodeReply --> Invoke\n    Invoke --> Result\n```\n\n**Key Functions:**\n\n| Side | Function | Purpose |\n|------|----------|---------|\n| Server | `registerServerReference(fn, id, name)` | Marks function as server reference |\n| Server | `getServerReferenceId(ref)` | Extracts module ID |\n| Server | `getServerReferenceBoundArguments(ref)` | Gets pre-bound arguments (from `.bind()`) |\n| Client | `createServerReference(id, callServer)` | Creates callable proxy |\n| Client | `callServer(id, args)` | User-provided RPC implementation |\n| Client | `encodeReply(value)` | Serializes arguments to FormData |\n| Server | `decodeReply(body, serverMap)` | Deserializes FormData to values |\n\n**Bound Server References:**\n\nServer references can be partially applied with `.bind()`:\n\n```javascript\n// Server\nexport async function deleteItem(userId, itemId) { ... }\n\n// Server component passes bound reference\nconst boundDelete = deleteItem.bind(null, currentUserId);\nreturn <Button action={boundDelete} />\n```\n\nThe bound arguments are serialized in the Flight stream, and the client proxy includes them when calling back.\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:2044-2143](), [packages/react-client/src/ReactFlightClient.js:1583-1650](), [packages/react-client/src/ReactFlightReplyClient.js:179-560](), [packages/react-server/src/ReactFlightReplyServer.js:400-650]()\n\n## Request Lifecycle\n\n### Server Render Flow\n\n```mermaid\ngraph TD\n    Entry["renderToPipeableStream(model, config)"]\n    CreateReq["createRequest(RENDER, model, bundlerConfig, ...)"]\n    Request["Request<br/>{status: OPENING, nextChunkId: 0}"]\n    RootTask["createTask(request, model, null, ...)"]\n    PingedTasks["pingedTasks array"]\n    \n    Entry --> CreateReq\n    CreateReq --> Request\n    Request --> RootTask\n    RootTask --> PingedTasks\n    \n    StartWork["startWork(request)"]\n    PerformWork["performWork(request)"]\n    RetryTask["retryTask(request, task)"]\n    RenderModel["renderModelDestructive(request, task, ...)"]\n    EmitChunk["emitChunk(request, task.id, model)"]\n    FlushChunks["flushCompletedChunks(request)"]\n    \n    PingedTasks --> StartWork\n    StartWork --> PerformWork\n    PerformWork --> RetryTask\n    RetryTask --> RenderModel\n    RenderModel --> EmitChunk\n    EmitChunk --> FlushChunks\n```\n\n**Processing Steps:**\n\n1. **Initialization**: `createRequest()` creates `Request` with `OPENING` status and root task\n2. **Work Loop**: `performWork()` processes `pingedTasks` array, rendering each task\n3. **Serialization**: `renderModelDestructive()` recursively serializes model, mutating it to JSON-compatible form\n4. **Chunk Emission**: `emitChunk()` generates row string and adds to `completedRegularChunks`\n5. **Flushing**: `flushCompletedChunks()` writes accumulated chunks to destination stream\n6. **Completion**: When all tasks done, status transitions to `CLOSED` and stream is closed\n\n**Key Task States:**\n\n| Task Status | Value | Description |\n|-------------|-------|-------------|\n| `PENDING` | `0` | Task created but not started |\n| `COMPLETED` | `1` | Task finished successfully |\n| `ABORTED` | `3` | Task aborted due to error/abort |\n| `ERRORED` | `4` | Task threw error during render |\n| `RENDERING` | `5` | Task currently executing |\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:779-807](), [packages/react-server/src/ReactFlightServer.js:1373-1445](), [packages/react-server/src/ReactFlightServer.js:1447-1533]()\n\n### Client Parsing Flow\n\n```mermaid\ngraph TD\n    CreateResp["createFromReadableStream(stream, options)"]\n    Response["Response<br/>{_chunks: new Map(), _closed: false}"]\n    ReadStream["Read stream chunks"]\n    ProcessBinary["processBinaryChunk(response, chunk)"]\n    ParseRow["Parse row: id:tag data"]\n    ProcessRow["processFullRow(response, row)"]\n    \n    CreateResp --> Response\n    Response --> ReadStream\n    ReadStream --> ProcessBinary\n    ProcessBinary --> ParseRow\n    ParseRow --> ProcessRow\n    \n    ResolveModel["resolveModel(response, id, model)"]\n    ResolveModule["resolveModule(response, id, metadata)"]\n    ResolveError["resolveError(response, id, error)"]\n    GetChunk["getChunk(response, id)"]\n    CreateChunk["createPendingChunk() or fetch from _chunks"]\n    UpdateChunk["Update chunk status and value"]\n    WakeListeners["Wake pending .then() listeners"]\n    \n    ProcessRow -->|"J tag"| ResolveModel\n    ProcessRow -->|"M tag"| ResolveModule\n    ProcessRow -->|"E tag"| ResolveError\n    \n    ResolveModel --> GetChunk\n    GetChunk --> CreateChunk\n    CreateChunk --> UpdateChunk\n    UpdateChunk --> WakeListeners\n```\n\n**Parsing States:**\n\nThe parser maintains state between stream chunks:\n\n| Parser State | Processing |\n|--------------|------------|\n| `ROW_ID` | Reading chunk ID in hex (e.g., `1a`) |\n| `ROW_TAG` | Reading single-char tag after `:` |\n| `ROW_LENGTH` | Reading length field for binary data |\n| `ROW_CHUNK_BY_NEWLINE` | Accumulating row until `\\n` |\n| `ROW_CHUNK_BY_LENGTH` | Reading exact byte count for binary |\n\n**Processing Steps:**\n\n1. **Stream Reading**: `processBinaryChunk()` processes incoming bytes\n2. **Row Parsing**: State machine extracts `id`, `tag`, and `data` from each row\n3. **Row Processing**: `processFullRow()` dispatches based on tag\n4. **Chunk Resolution**: Updates or creates chunk in `_chunks` Map\n5. **Listener Notification**: Wakes any promises/callbacks waiting on this chunk\n6. **Initialization**: When chunk read via `readChunk()`, calls `initializeModelChunk()` if needed\n\n**Sources:** [packages/react-client/src/ReactFlightClient.js:1437-1580](), [packages/react-client/src/ReactFlightClient.js:1626-1935](), [packages/react-client/src/ReactFlightClient.js:852-880]()\n\n## Configuration and Integration\n\n### Environment-Specific Configurations\n\nFlight supports multiple deployment environments through configuration modules:\n\n- `ReactFlightServerConfig` - Server-side environment configuration\n- `ReactFlightClientConfig` - Client-side environment configuration  \n- Webpack integration through `ReactFlightWebpackPlugin`\n- Turbopack integration for Next.js environments\n\n**Sources:** [packages/react-server-dom-webpack/src/ReactFlightWebpackPlugin.js:1-50](), [packages/react-server-dom-webpack/src/ReactFlightWebpackNodeLoader.js:1-30]()\n\n### Performance and Debugging\n\nFlight includes performance tracking and debugging capabilities:\n\n- Component render timing with `enableComponentPerformanceTrack`\n- Async operation tracking with `enableAsyncDebugInfo`  \n- Console log forwarding from server to client\n- Stack trace preservation across server-client boundary\n\n**Sources:** [packages/react-client/src/ReactFlightPerformanceTrack.js:75-140](), [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js:105-150]()\n\n---\n\n# Page: Build Integration for Server Components\n\n# Build Integration for Server Components\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightClient.js](packages/react-client/src/ReactFlightClient.js)\n- [packages/react-client/src/ReactFlightReplyClient.js](packages/react-client/src/ReactFlightReplyClient.js)\n- [packages/react-client/src/ReactFlightTemporaryReferences.js](packages/react-client/src/ReactFlightTemporaryReferences.js)\n- [packages/react-client/src/__tests__/ReactFlight-test.js](packages/react-client/src/__tests__/ReactFlight-test.js)\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/react-server-dom-esm/src/ReactFlightESMReferences.js](packages/react-server-dom-esm/src/ReactFlightESMReferences.js)\n- [packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js](packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js)\n- [packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js](packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js)\n- [packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js](packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js)\n- [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js](packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js)\n- [packages/react-server/src/ReactFlightReplyServer.js](packages/react-server/src/ReactFlightReplyServer.js)\n- [packages/react-server/src/ReactFlightServer.js](packages/react-server/src/ReactFlightServer.js)\n- [packages/react-server/src/ReactFlightServerTemporaryReferences.js](packages/react-server/src/ReactFlightServerTemporaryReferences.js)\n- [scripts/error-codes/codes.json](scripts/error-codes/codes.json)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document explains how bundlers integrate with React Server Components (RSC) through build-time plugins, manifest generation, and directive processing. It covers the Webpack plugin implementation, module reference systems, and how the build toolchain transforms code containing `\'use client\'` and `\'use server\'` directives into the appropriate module references and manifests.\n\nFor information about the runtime behavior of Flight serialization and deserialization, see [React Server Components (Flight)](#5.2). For server actions and client-to-server communication, see [Server Actions and Bidirectional Communication](#5.4).\n\n---\n\n## Build Integration Architecture\n\nThe build integration for React Server Components consists of several cooperating systems that run at build time to analyze modules, generate manifests, and transform code references.\n\n**Build Integration Flow**\n\n```mermaid\ngraph TB\n    subgraph "Source Code"\n        ServerComponents["Server Components<br/>(no directive)"]\n        ClientComponents["Client Components<br/>\'use client\'"]\n        ServerActions["Server Actions<br/>\'use server\'"]\n    end\n    \n    subgraph "Build Process"\n        WebpackPlugin["ReactFlightWebpackPlugin"]\n        NodeLoader["react-server-dom-webpack/node-loader"]\n        \n        WebpackPlugin -->|analyzes| DirectiveDetection["Directive Detection"]\n        WebpackPlugin -->|generates| ClientManifest["Client Manifest<br/>clientReferenceMap"]\n        WebpackPlugin -->|generates| ServerManifest["Server Manifest<br/>serverReferenceMap"]\n        \n        DirectiveDetection -->|\'use client\'| ClientModuleTransform["Client Module Transform"]\n        DirectiveDetection -->|\'use server\'| ServerModuleTransform["Server Module Transform"]\n    end\n    \n    subgraph "Output Artifacts"\n        ServerBundle["Server Bundle<br/>react-server condition"]\n        ClientBundle["Client Bundle<br/>default condition"]\n        \n        ClientManifest -->|consumed by| ServerBundle\n        ServerManifest -->|consumed by| ClientBundle\n    end\n    \n    subgraph "Runtime"\n        FlightServer["Flight Server<br/>ReactFlightServer.js"]\n        FlightClient["Flight Client<br/>ReactFlightClient.js"]\n        \n        FlightServer -->|serializes with| ClientManifest\n        FlightClient -->|deserializes with| ServerManifest\n    end\n    \n    ServerComponents --> WebpackPlugin\n    ClientComponents --> WebpackPlugin\n    ServerActions --> WebpackPlugin\n    \n    ServerBundle --> FlightServer\n    ClientBundle --> FlightClient\n```\n\nSources: [scripts/rollup/bundles.js:524-558](), [packages/react-server/src/ReactFlightServer.js:1-100](), [packages/react-client/src/ReactFlightClient.js:1-100]()\n\n---\n\n## Webpack Plugin Implementation\n\nThe `ReactFlightWebpackPlugin` is the primary build-time integration point. It analyzes modules for directives, transforms module references, and generates the client and server manifests.\n\n**Plugin Bundle Configuration**\n\n| Property | Value |\n|----------|-------|\n| Entry Point | `react-server-dom-webpack/plugin` |\n| Bundle Type | `NODE_ES2015` |\n| Module Type | `RENDERER_UTILS` |\n| Global Name | `ReactServerWebpackPlugin` |\n| Externals | `fs`, `path`, `url`, `neo-async` |\n\nThe plugin operates as a Webpack compilation plugin that hooks into the module graph construction process to identify client and server boundaries.\n\n**Module Analysis Process**\n\n```mermaid\ngraph LR\n    subgraph "Webpack Compilation"\n        ModuleGraph["Webpack Module Graph"]\n        \n        ModuleGraph -->|for each module| AnalyzeModule["Analyze Module"]\n        \n        AnalyzeModule -->|check| HasDirective{"Has \'use client\'<br/>or \'use server\'?"}\n        \n        HasDirective -->|yes| RegisterReference["Register Module Reference"]\n        HasDirective -->|no| CheckImports["Check Imports"]\n        \n        RegisterReference -->|\'use client\'| AddToClientManifest["Add to Client Manifest"]\n        RegisterReference -->|\'use server\'| AddToServerManifest["Add to Server Manifest"]\n        \n        CheckImports -->|imports client module| ProxyModule["Create Proxy Module"]\n    end\n    \n    subgraph "Reference Generation"\n        AddToClientManifest --> GenerateClientID["Generate Client ID<br/>module path + export name"]\n        AddToServerManifest --> GenerateServerID["Generate Server ID<br/>module path + export name"]\n        \n        GenerateClientID --> ClientMetadata["Client Reference Metadata<br/>{id, chunks, name}"]\n        GenerateServerID --> ServerMetadata["Server Reference Metadata<br/>{id, bound}"]\n    end\n```\n\nSources: [scripts/rollup/bundles.js:524-533]()\n\n---\n\n## Module Reference System\n\nReact Server Components use a module reference system to represent code that crosses the server/client boundary. These references are opaque identifiers that get resolved at runtime using the manifests.\n\n**Client Reference Structure**\n\nA client reference represents a module that should be loaded on the client. When server code imports a client component, it receives a reference instead of the actual module.\n\n```mermaid\ngraph TB\n    subgraph "Server-Side"\n        ServerCode["Server Component Code"]\n        ClientRefProxy["Client Reference Proxy<br/>$$typeof: \'react.client.reference\'"]\n        \n        ServerCode -->|imports| ClientRefProxy\n    end\n    \n    subgraph "Client Manifest Entry"\n        ManifestEntry["Client Manifest Entry"]\n        \n        ManifestEntry -->|contains| ModuleID["id: \'path/to/module.js#Component\'"]\n        ManifestEntry -->|contains| ChunkIDs["chunks: [\'client-chunk-123\']"]\n        ManifestEntry -->|contains| ExportName["name: \'Component\' or \'*\'"]\n    end\n    \n    subgraph "Serialization"\n        FlightProtocol["Flight Protocol Stream"]\n        \n        ClientRefProxy -->|serialized as| ModuleReference["M1:{id,chunks,name}"]\n        ModuleReference -->|written to| FlightProtocol\n    end\n    \n    subgraph "Client-Side"\n        FlightClient["Flight Client"]\n        ManifestLookup["Manifest Lookup"]\n        ModuleLoader["Module Loader"]\n        \n        FlightProtocol -->|read by| FlightClient\n        FlightClient -->|resolves with| ManifestLookup\n        ManifestLookup -->|loads| ModuleLoader\n        ModuleLoader -->|returns| ActualComponent["Actual Component Implementation"]\n    end\n    \n    ClientRefProxy -.manifest key.-> ManifestEntry\n```\n\nSources: [packages/react-client/src/ReactFlightClient.js:1-100](), [packages/react-server/src/ReactFlightServer.js:79-101]()\n\n**Server Reference Structure**\n\nA server reference represents a function that should execute on the server. When client code calls a server action, it sends a reference and arguments back to the server.\n\n```mermaid\ngraph TB\n    subgraph "Client-Side"\n        ClientCode["Client Component Code"]\n        ServerRefFunc["Server Reference Function<br/>$$typeof: \'react.server.reference\'"]\n        \n        ClientCode -->|calls| ServerRefFunc\n        ServerRefFunc -->|serializes| ServerRefCall["Call: {id, args}"]\n    end\n    \n    subgraph "Server Manifest Entry"\n        ServerManifestEntry["Server Manifest Entry"]\n        \n        ServerManifestEntry -->|contains| ServerModuleID["id: \'path/to/actions.js#saveData\'"]\n        ServerManifestEntry -->|contains| BoundArgs["bound: null or Array"]\n    end\n    \n    subgraph "Server-Side"\n        FlightReply["Flight Reply Processor"]\n        ManifestResolve["Manifest Resolution"]\n        ActualFunction["Actual Server Function"]\n        \n        ServerRefCall -->|sent to| FlightReply\n        FlightReply -->|resolves with| ManifestResolve\n        ManifestResolve -->|loads| ActualFunction\n        ActualFunction -->|executes| ReturnValue["Return Value"]\n    end\n    \n    ServerRefFunc -.manifest key.-> ServerManifestEntry\n```\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:52-80](), [packages/react-server/src/ReactFlightReplyServer.js:1-50]()\n\n---\n\n## Directive Processing\n\nThe build system processes two types of directives: `\'use client\'` and `\'use server\'`. These directives must appear at the top of the module, before any other code.\n\n**Directive Detection and Transformation**\n\n| Directive | Location | Meaning | Build Transformation |\n|-----------|----------|---------|---------------------|\n| `\'use client\'` | Top of file | Entire module runs on client | Replace with client reference proxy in server bundle |\n| `\'use server\'` | Top of file | Entire module exports server actions | Replace with server reference proxies in client bundle |\n| `\'use server\'` | Inside function | Single function is server action | Extract and create server reference |\n\n**Client Directive Processing Flow**\n\n```mermaid\ngraph TB\n    subgraph "Source Module"\n        ClientDirective["\'use client\'<br/>export function Button() {...}"]\n    end\n    \n    subgraph "Server Bundle Transform"\n        DetectDirective["Detect \'use client\' Directive"]\n        GenerateProxy["Generate Proxy Module"]\n        \n        DetectDirective --> GenerateProxy\n        GenerateProxy --> ProxyContent["Proxy exports client references<br/>for each export"]\n    end\n    \n    subgraph "Client Bundle Transform"\n        IncludeOriginal["Include Original Module"]\n        AddChunkInfo["Add to Chunk Manifest"]\n        \n        IncludeOriginal --> AddChunkInfo\n    end\n    \n    subgraph "Manifest Generation"\n        ClientManifestEntry["Client Manifest Entry<br/>{<br/>  id: \'Button.js\',<br/>  chunks: [\'chunk-123\'],<br/>  name: \'Button\'<br/>}"]\n    end\n    \n    ClientDirective -->|server bundle| DetectDirective\n    ClientDirective -->|client bundle| IncludeOriginal\n    \n    ProxyContent --> ClientManifestEntry\n    AddChunkInfo --> ClientManifestEntry\n```\n\nSources: [scripts/rollup/bundles.js:448-522]()\n\n**Server Directive Processing Flow**\n\n```mermaid\ngraph TB\n    subgraph "Source Module"\n        ServerDirective["\'use server\'<br/>export async function saveData() {...}"]\n    end\n    \n    subgraph "Client Bundle Transform"\n        DetectServerDirective["Detect \'use server\' Directive"]\n        GenerateServerProxy["Generate Server Reference Proxy"]\n        \n        DetectServerDirective --> GenerateServerProxy\n        GenerateServerProxy --> ProxyFunc["Proxy function calls server<br/>via callServer()"]\n    end\n    \n    subgraph "Server Bundle Transform"\n        KeepOriginal["Keep Original Implementation"]\n        RegisterAction["Register in Server Manifest"]\n        \n        KeepOriginal --> RegisterAction\n    end\n    \n    subgraph "Manifest Generation"\n        ServerManifestEntry["Server Manifest Entry<br/>{<br/>  id: \'actions.js#saveData\',<br/>  bound: null<br/>}"]\n    end\n    \n    ServerDirective -->|client bundle| DetectServerDirective\n    ServerDirective -->|server bundle| KeepOriginal\n    \n    ProxyFunc --> ServerManifestEntry\n    RegisterAction --> ServerManifestEntry\n```\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:1-100](), [packages/react-server/src/ReactFlightReplyServer.js:1-50]()\n\n---\n\n## Manifest Structures\n\nThe build process generates two manifest files that enable runtime module resolution across the server/client boundary.\n\n**Client Manifest Format**\n\nThe client manifest maps module IDs to chunk information, allowing the server to serialize client references that the client can resolve.\n\n```mermaid\ngraph TB\n    subgraph "Client Manifest Structure"\n        ClientManifest["clientReferenceManifest"]\n        \n        ClientManifest --> ModuleMap["Module Map<br/>{[moduleId]: ModuleExports}"]\n        \n        ModuleMap --> ModuleExports["Module Exports<br/>{[exportName]: ExportInfo}"]\n        \n        ModuleExports --> ExportInfo["Export Info"]\n        \n        ExportInfo --> ExportID["id: string<br/>\'path/to/module#export\'"]\n        ExportInfo --> ExportChunks["chunks: Array<string><br/>[\'chunk-abc\', \'chunk-def\']"]\n        ExportInfo --> ExportName["name: string<br/>\'ComponentName\' or \'*\'"]\n    end\n    \n    subgraph "Example Entry"\n        Example["ClientButton.js:<br/>{<br/>  \'Button\': {<br/>    id: \'./ClientButton.js#Button\',<br/>    chunks: [\'client-chunk-123\'],<br/>    name: \'Button\'<br/>  },<br/>  \'*\': {<br/>    id: \'./ClientButton.js#*\',<br/>    chunks: [\'client-chunk-123\'],<br/>    name: \'*\'<br/>  }<br/>}"]\n    end\n```\n\n**Client Manifest Runtime Usage**\n\n| Stage | Operation | Manifest Usage |\n|-------|-----------|----------------|\n| Server Render | Encounter client component | Look up module ID in manifest to get chunks |\n| Flight Serialization | Serialize client reference | Include `{id, chunks, name}` in stream |\n| Client Receive | Deserialize reference | Use chunks to preload/load module |\n| Client Render | Instantiate component | Import module and get export by name |\n\nSources: [packages/react-server/src/ReactFlightServer.js:79-101](), [packages/react-client/src/ReactFlightClient.js:44-64]()\n\n**Server Manifest Format**\n\nThe server manifest maps server action IDs to module locations, allowing the client to invoke server functions.\n\n```mermaid\ngraph TB\n    subgraph "Server Manifest Structure"\n        ServerManifest["serverReferenceManifest"]\n        \n        ServerManifest --> ActionMap["Action Map<br/>{[actionId]: ActionInfo}"]\n        \n        ActionMap --> ActionInfo["Action Info"]\n        \n        ActionInfo --> ActionID["id: string<br/>\'actions.js#saveData\'"]\n        ActionInfo --> BoundArgs["bound: null | Promise<Array>"]\n    end\n    \n    subgraph "Example Entry"\n        ServerExample["Server Actions:<br/>{<br/>  \'actions.js#saveData\': {<br/>    id: \'actions.js#saveData\',<br/>    bound: null<br/>  },<br/>  \'actions.js#deleteData\': {<br/>    id: \'actions.js#deleteData\',<br/>    bound: Promise.resolve([userId])<br/>  }<br/>}"]\n    end\n```\n\n**Server Manifest Runtime Usage**\n\n| Stage | Operation | Manifest Usage |\n|-------|-----------|----------------|\n| Client Render | Receive server reference | Store reference with `$$typeof` marker |\n| Client Invoke | Call server function | Serialize `{id, args}` with Flight Reply |\n| Server Receive | Deserialize call | Look up action ID in manifest |\n| Server Execute | Load and invoke | Require module and call export by name |\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:52-80](), [packages/react-server/src/ReactFlightReplyServer.js:1-50]()\n\n---\n\n## Module Loading Integration\n\nThe build integration includes module loaders that handle the `react-server` condition at runtime, ensuring the correct versions of modules are loaded in each environment.\n\n**Node.js Loader Configuration**\n\n| Property | Value |\n|----------|-------|\n| Entry Point | `react-server-dom-webpack/node-loader` |\n| Bundle Type | `ESM_PROD` |\n| Condition | `react-server` |\n| External | `acorn` (for AST parsing) |\n\nThe Node.js loader uses ESM loader hooks to intercept module resolution and ensure that modules with the `react-server` export condition are loaded in the server environment.\n\n**Module Resolution Flow**\n\n```mermaid\ngraph TB\n    subgraph "Import Statement"\n        ImportReact["import React from \'react\'"]\n    end\n    \n    subgraph "Node.js Loader Hooks"\n        ResolveHook["resolve() hook"]\n        LoadHook["load() hook"]\n        \n        ResolveHook -->|check conditions| ConditionCheck{"Has react-server<br/>export condition?"}\n        \n        ConditionCheck -->|yes| UseReactServer["Use react.react-server.js"]\n        ConditionCheck -->|no| UseDefault["Use index.js"]\n        \n        UseReactServer --> LoadHook\n        UseDefault --> LoadHook\n    end\n    \n    subgraph "Package Exports"\n        PackageJson["package.json exports field"]\n        \n        PackageJson --> ReactServerExport["\'react-server\': \'./react.react-server.js\'"]\n        PackageJson --> DefaultExport["\'default\': \'./index.js\'"]\n    end\n    \n    ImportReact --> ResolveHook\n    ReactServerExport -.used by.-> UseReactServer\n    DefaultExport -.used by.-> UseDefault\n```\n\nSources: [scripts/rollup/bundles.js:535-545](), [packages/react/package.json:24-42]()\n\n**CommonJS Module Registration**\n\nFor CommonJS environments, a registration module handles module loading:\n\n| Property | Value |\n|----------|-------|\n| Entry Point | `react-server-dom-webpack/src/ReactFlightWebpackNodeRegister` |\n| Name | `react-server-dom-webpack-node-register` |\n| Condition | `react-server` |\n| Externals | `url`, `module`, `react-server-dom-webpack/server` |\n\nThis module hooks into Node\'s `require()` system to apply the `react-server` condition for CommonJS modules.\n\nSources: [scripts/rollup/bundles.js:547-558]()\n\n---\n\n## Build Output Organization\n\nThe build system produces separate bundles for server and client environments, each consuming the appropriate manifest.\n\n**Bundle Type Matrix**\n\n| Bundle | Entry Points | Condition | Consumes Manifest | Target Environment |\n|--------|--------------|-----------|-------------------|--------------------|\n| Server | `react-server-dom-webpack/server.{node,browser,edge}` | `react-server` | Client Manifest | Node.js, Edge Runtime, Browser (SSR) |\n| Client | `react-server-dom-webpack/client.{node,browser,edge}` | default | Server Manifest | Node.js (for SSR), Browser |\n| Plugin | `react-server-dom-webpack/plugin` | N/A | Generates both | Build time only |\n| Loader | `react-server-dom-webpack/node-loader` | `react-server` | N/A | Node.js ESM runtime |\n\n**Server Bundle Configuration**\n\n```mermaid\ngraph LR\n    subgraph "Server Entry Points"\n        ServerBrowser["server.browser"]\n        ServerNode["server.node"]\n        ServerEdge["server.edge"]\n    end\n    \n    subgraph "Configuration"\n        Condition["condition: \'react-server\'"]\n        Externals["externals:<br/>react, react-dom,<br/>crypto, stream, util"]\n        GlobalName["global: \'ReactServerDOMServer\'"]\n    end\n    \n    subgraph "Consumes"\n        ClientManifest2["Client Manifest"]\n    end\n    \n    ServerBrowser --> Condition\n    ServerNode --> Condition\n    ServerEdge --> Condition\n    \n    Condition --> ClientManifest2\n    Externals --> ClientManifest2\n```\n\nSources: [scripts/rollup/bundles.js:448-489]()\n\n**Client Bundle Configuration**\n\n```mermaid\ngraph LR\n    subgraph "Client Entry Points"\n        ClientBrowser["client.browser"]\n        ClientNode["client.node"]\n        ClientEdge["client.edge"]\n    end\n    \n    subgraph "Configuration"\n        NoCondition["condition: default"]\n        ClientExternals["externals:<br/>react, react-dom,<br/>util, crypto"]\n        ClientGlobalName["global: \'ReactServerDOMClient\'"]\n    end\n    \n    subgraph "Consumes"\n        ServerManifest2["Server Manifest"]\n    end\n    \n    ClientBrowser --> NoCondition\n    ClientNode --> NoCondition\n    ClientEdge --> NoCondition\n    \n    NoCondition --> ServerManifest2\n    ClientExternals --> ServerManifest2\n```\n\nSources: [scripts/rollup/bundles.js:491-522]()\n\n---\n\n## Fork System Integration\n\nThe build system uses a fork mechanism to provide different implementations of shared modules based on the bundle type and environment.\n\n**React Shared Internals Forking**\n\n```mermaid\ngraph TB\n    subgraph "Import Statement"\n        ImportShared["import ReactSharedInternals"]\n    end\n    \n    subgraph "Fork Resolution"\n        ForkCheck{"Check bundle<br/>condition"}\n        \n        ForkCheck -->|react-server| ServerInternals["ReactSharedInternalsServer"]\n        ForkCheck -->|default| ClientInternals["ReactSharedInternalsClient"]\n    end\n    \n    subgraph "Implementation Files"\n        ServerImpl["packages/react-server/src/<br/>ReactSharedInternalsServer.js"]\n        ClientImpl["packages/react/src/<br/>ReactSharedInternalsClient.js"]\n    end\n    \n    ImportShared --> ForkCheck\n    ServerInternals --> ServerImpl\n    ClientInternals --> ClientImpl\n```\n\n**Fork Configuration Table**\n\n| Module | Condition | Fork Target | Purpose |\n|--------|-----------|-------------|---------|\n| `shared/ReactSharedInternals.js` | `react-server` | `ReactSharedInternalsServer.js` | Server-specific internals (Flight hooks) |\n| `shared/ReactSharedInternals.js` | default | `ReactSharedInternalsClient.js` | Client-specific internals (useState, etc.) |\n| `shared/ReactDOMSharedInternals.js` | `react-server` | N/A | Not available in react-server |\n| `shared/ReactDOMSharedInternals.js` | default | `ReactDOMSharedInternals.js` | DOM-specific internals |\n\nSources: [scripts/rollup/forks.js:52-131](), [scripts/rollup/build.js:354-403]()\n\n---\n\n## Integration with Other Bundlers\n\nWhile the primary implementation uses Webpack, the architecture supports other bundlers through similar plugin systems.\n\n**Turbopack Integration**\n\n| Bundle | Entry Point | Notes |\n|--------|-------------|-------|\n| Server | `react-server-dom-turbopack/server.{browser,node,edge}` | Similar to Webpack server |\n| Client | `react-server-dom-turbopack/client.{browser,node,edge}` | Similar to Webpack client |\n\nThe Turbopack integration follows the same manifest generation and module reference patterns, but uses Turbopack\'s native plugin system instead of Webpack\'s.\n\nSources: [scripts/rollup/bundles.js:560-672]()\n\n**Unbundled (Development) Integration**\n\nFor development and testing without a bundler:\n\n| Bundle | Entry Point | Purpose |\n|--------|-------------|---------|\n| Server | `react-server-dom-unbundled/server.node` | No bundling, direct module resolution |\n| Client | `react-server-dom-unbundled/client.node` | No bundling, direct module imports |\n\nThis configuration is used primarily in tests to validate the Flight protocol without bundler complexity.\n\nSources: Test files show usage of WebpackMock utilities that simulate manifest generation without actual bundling.\n\n---\n\n## Summary\n\nThe build integration for React Server Components operates through:\n\n1. **Plugin System**: `ReactFlightWebpackPlugin` analyzes modules and generates manifests\n2. **Module References**: Abstract representations of cross-boundary modules with `$$typeof` markers\n3. **Directive Processing**: Transform `\'use client\'` and `\'use server\'` directives into appropriate references\n4. **Manifest Generation**: Create client manifest (server  client) and server manifest (client  server)\n5. **Module Loading**: Use condition-based resolution with `react-server` export condition\n6. **Fork System**: Provide environment-specific implementations of shared modules\n\nThe architecture is bundler-agnostic, with implementations for Webpack, Turbopack, and unbundled environments all following the same manifest and reference patterns.\n\nSources: [scripts/rollup/bundles.js:448-672](), [scripts/rollup/forks.js:1-300](), [scripts/rollup/build.js:1-600]()\n\n---\n\n# Page: Server Actions and Bidirectional Communication\n\n# Server Actions and Bidirectional Communication\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightClient.js](packages/react-client/src/ReactFlightClient.js)\n- [packages/react-client/src/ReactFlightReplyClient.js](packages/react-client/src/ReactFlightReplyClient.js)\n- [packages/react-client/src/ReactFlightTemporaryReferences.js](packages/react-client/src/ReactFlightTemporaryReferences.js)\n- [packages/react-client/src/__tests__/ReactFlight-test.js](packages/react-client/src/__tests__/ReactFlight-test.js)\n- [packages/react-server-dom-esm/src/ReactFlightESMReferences.js](packages/react-server-dom-esm/src/ReactFlightESMReferences.js)\n- [packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js](packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js)\n- [packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js](packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js)\n- [packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js](packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js)\n- [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js](packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js)\n- [packages/react-server/src/ReactFlightReplyServer.js](packages/react-server/src/ReactFlightReplyServer.js)\n- [packages/react-server/src/ReactFlightServer.js](packages/react-server/src/ReactFlightServer.js)\n- [packages/react-server/src/ReactFlightServerTemporaryReferences.js](packages/react-server/src/ReactFlightServerTemporaryReferences.js)\n- [scripts/error-codes/codes.json](scripts/error-codes/codes.json)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis page documents React\'s server action system and bidirectional communication protocol. Server actions enable client code to invoke server-side functions, creating a communication channel from client to server. This complements the server-to-client RSC protocol documented in [React Server Components (Flight)](#5.2).\n\nKey topics covered:\n- **Server References**: Functions that can be serialized and invoked from the client\n- **Reply Encoding**: How client arguments are serialized and sent to the server\n- **Reply Decoding**: How the server deserializes client data\n- **Form Integration**: Using server actions as form actions for progressive enhancement\n- **Bound Arguments**: Pre-binding arguments to server functions\n\nFor server-to-client streaming, see [React Server Components (Flight)](#5.2). For build-time module resolution, see [Build Integration for Server Components](#5.3).\n\n---\n\n## Server Reference Architecture\n\nServer references are special function objects that can be serialized and sent to the client, then invoked to trigger server-side execution.\n\n### Server Reference Structure\n\n```mermaid\ngraph TB\n    subgraph "Server Reference Object"\n        SR["ServerReference&lt;T&gt;"]\n        SR --> typeof["$$typeof: SERVER_REFERENCE_TAG"]\n        SR --> id["$$id: string"]\n        SR --> bound["$$bound: null | Array&lt;ReactClientValue&gt;"]\n        SR --> location["$$location?: Error (DEV only)"]\n    end\n    \n    subgraph "Symbol Tags"\n        SERVER_TAG["SERVER_REFERENCE_TAG<br/>Symbol.for(\'react.server.reference\')"]\n        CLIENT_TAG["CLIENT_REFERENCE_TAG<br/>Symbol.for(\'react.client.reference\')"]\n    end\n    \n    typeof -.-> SERVER_TAG\n    \n    subgraph "Registration"\n        registerServerReference["registerServerReference()"]\n        isServerReference["isServerReference()"]\n    end\n    \n    registerServerReference --> SR\n    SR --> isServerReference\n    \n    style SR fill:#f9f9f9\n    style typeof fill:#e8f4f8\n    style id fill:#e8f4f8\n    style bound fill:#e8f4f8\n```\n\n**Server Reference Registration**\n\nServer references are created using `registerServerReference()`:\n\nSources: [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js:111-130]()\n\nThe registration process:\n1. Marks the function with `$$typeof: SERVER_REFERENCE_TAG`\n2. Assigns a unique `$$id` (module path + export name)\n3. Initializes `$$bound` to `null`\n4. Attaches custom `.bind()` implementation\n5. In DEV, adds `$$location` for debugging\n\n### Custom Bind Implementation\n\nServer references override `Function.prototype.bind` to support argument binding:\n\n```mermaid\ngraph LR\n    subgraph "Bind Process"\n        Original["serverAction"]\n        BindCall["serverAction.bind(null, arg1, arg2)"]\n        NewRef["New ServerReference"]\n    end\n    \n    Original --> BindCall\n    BindCall --> NewRef\n    \n    subgraph "New Reference Properties"\n        NewRef --> id2["$$id: same as original"]\n        NewRef --> bound2["$$bound: [arg1, arg2]"]\n        NewRef --> bind2["bind: custom implementation"]\n    end\n    \n    style BindCall fill:#fff4e1\n    style NewRef fill:#f9f9f9\n```\n\nSources: [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js:62-103]()\n\nWhen `.bind()` is called on a server reference:\n1. Uses native `Function.prototype.bind` to create new function\n2. Copies `$$typeof` and `$$id` from original\n3. Concatenates new args with `$$bound` from original\n4. Attaches custom `.bind()` to the new function\n\n**Important**: The first argument (thisArg) must be `null` or `undefined`. In DEV, a warning is logged if a non-null thisArg is provided.\n\n---\n\n## Reply Encoding Protocol\n\nThe reply encoding protocol serializes client-side JavaScript values into a format that can be transmitted to the server and reconstructed.\n\n### Encoding Architecture\n\n```mermaid\ngraph TB\n    subgraph "Client Side"\n        ClientValue["Client JavaScript Value"]\n        encodeReply["ReactServerDOMClient.encodeReply()"]\n        processReply["processReply()"]\n        resolveToJSON["resolveToJSON() recursion"]\n    end\n    \n    ClientValue --> encodeReply\n    encodeReply --> processReply\n    processReply --> resolveToJSON\n    \n    subgraph "Serialization Output"\n        StringOutput["JSON string"]\n        FormDataOutput["FormData (for streams/blobs)"]\n    end\n    \n    resolveToJSON --> StringOutput\n    resolveToJSON --> FormDataOutput\n    \n    subgraph "Special Encodings"\n        ServerRef["Server Reference  $h{id}"]\n        Promise["Promise  $@{id}"]\n        TypedArray["TypedArray  ${tag}{id}"]\n        Stream["ReadableStream  $R{id}"]\n        FormDataRef["FormData  $K{id}"]\n        Undefined["undefined  $undefined"]\n        BigInt["BigInt  $n{value}"]\n        Date["Date  $D{isoString}"]\n    end\n    \n    resolveToJSON -.-> ServerRef\n    resolveToJSON -.-> Promise\n    resolveToJSON -.-> TypedArray\n    resolveToJSON -.-> Stream\n    resolveToJSON -.-> FormDataRef\n    resolveToJSON -.-> Undefined\n    resolveToJSON -.-> BigInt\n    resolveToJSON -.-> Date\n    \n    style encodeReply fill:#e8f4f8\n    style processReply fill:#e8f4f8\n```\n\n**Encoding Entry Point**\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:183-465]()\n\nThe `processReply()` function coordinates encoding:\n1. Maintains a `writtenObjects` WeakMap to handle circular references\n2. Tracks `pendingParts` for async values\n3. Upgrades to FormData when binary data or streams are present\n4. Returns either a JSON string or FormData\n\n### Value Encoding Reference\n\n| Type | Encoding | Example |\n|------|----------|---------|\n| `undefined` | `"$undefined"` | `undefined  "$undefined"` |\n| `-0` | `"$-0"` | `-0  "$-0"` |\n| `Infinity` | `"$Infinity"` | `Infinity  "$Infinity"` |\n| `NaN` | `"$NaN"` | `NaN  "$NaN"` |\n| `BigInt` | `"$n" + value` | `123n  "$n123"` |\n| `Date` | `"$D" + isoString` | `new Date()  "$D2024-01-01..."` |\n| `Map` | `"$Q" + id` | Outlined as separate chunk |\n| `Set` | `"$W" + id` | Outlined as separate chunk |\n| `FormData` | `"$K" + id` | Outlined as separate chunk |\n| `Blob` | `"$B" + id` | Outlined as separate chunk |\n| `TypedArray` | `"$" + tag + id` | `Uint8Array  "$o{id}"` |\n| `Promise` | `"$@" + id` | Async resolution |\n| `ServerReference` | `"$h" + id` | Bound args outlined separately |\n| `Iterator` | `"$i" + id` | Single-shot iteration |\n| `AsyncIterable` | `"$x" + id` | Multi-shot async iteration |\n| `ReadableStream` | `"$R" + id` (text) or `"$r" + id` (binary) | Streaming chunks |\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:103-170]()\n\n### Server Reference Encoding\n\nWhen encoding a server reference with bound arguments:\n\n```mermaid\ngraph TB\n    ServerRef["Server Reference"]\n    CheckBound{"Has $$bound?"}\n    \n    ServerRef --> CheckBound\n    \n    CheckBound -->|No| Simple["Encode as $h{id}"]\n    CheckBound -->|Yes| Complex["Outline bound args"]\n    \n    Complex --> EncodeArgs["processReply() on $$bound array"]\n    EncodeArgs --> OutlineChunk["Create separate chunk for args"]\n    OutlineChunk --> Reference["Encode as $h{id} with args reference"]\n    \n    style ServerRef fill:#f9f9f9\n    style Complex fill:#fff4e1\n```\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:556-607]()\n\nProcess:\n1. Check if `$$bound` is non-null\n2. If bound, outline the arguments array as a separate reply chunk\n3. Encode reference as `{id: $$id, bound: chunkId}` structure\n4. If not bound, encode as simple string `"$h" + id`\n\n### Streaming Values\n\nFor streams and async iterables, the encoding creates streaming channels:\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:260-304](), [packages/react-client/src/ReactFlightReplyClient.js:306-381]()\n\n**ReadableStream Encoding:**\n1. Upgrade to FormData mode\n2. Allocate a stream ID\n3. Create a reader and start reading\n4. For each chunk, append serialized value to FormData with stream ID\n5. When done, append close signal `"C"`\n\n**AsyncIterable Encoding:**\n1. Similar to ReadableStream\n2. Distinguish between single-shot (iterator === iterable) and multi-shot\n3. Encode close instruction with optional final value\n\n---\n\n## Reply Decoding Protocol\n\nThe server reconstructs client values from the encoded reply format.\n\n### Decoding Architecture\n\n```mermaid\ngraph TB\n    subgraph "Server Side"\n        EncodedInput["FormData or string body"]\n        decodeReply["ReactServerDOMServer.decodeReply()"]\n        createResponse["createResponse()"]\n        processReplyChunk["processReplyChunk()"]\n    end\n    \n    EncodedInput --> decodeReply\n    decodeReply --> createResponse\n    createResponse --> processReplyChunk\n    \n    subgraph "Response State"\n        ChunksMap["_chunks: Map&lt;number, Chunk&gt;"]\n        FormDataStore["_formData: FormData"]\n        BundlerConfig["_bundlerConfig: ServerManifest"]\n        TempRefs["_temporaryReferences"]\n    end\n    \n    createResponse --> ChunksMap\n    createResponse --> FormDataStore\n    createResponse --> BundlerConfig\n    createResponse --> TempRefs\n    \n    subgraph "Chunk Processing"\n        ParseJSON["JSON.parse() with revivers"]\n        InitializeChunk["initializeModelChunk()"]\n        ResolveRefs["Resolve cross-references"]\n    end\n    \n    processReplyChunk --> ParseJSON\n    ParseJSON --> InitializeChunk\n    InitializeChunk --> ResolveRefs\n    \n    subgraph "Output"\n        ReconstructedValue["Reconstructed JavaScript Value"]\n    end\n    \n    ResolveRefs --> ReconstructedValue\n    \n    style decodeReply fill:#e8f4f8\n    style createResponse fill:#e8f4f8\n```\n\n**Decoding Entry Point**\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:1113-1183]()\n\nThe `decodeReply()` function:\n1. Creates a `Response` object to track state\n2. Parses FormData entries or JSON string\n3. For each chunk, calls `processReplyChunk()`\n4. Returns root chunk (ID 0) as a Promise\n5. Resolves when all referenced chunks are initialized\n\n### Chunk State Machine\n\nEach chunk in the reply goes through these states:\n\n```mermaid\nstateDiagram-v2\n    [*] --> PENDING: Create chunk\n    PENDING --> RESOLVED_MODEL: Receive data\n    RESOLVED_MODEL --> INITIALIZED: Parse JSON\n    RESOLVED_MODEL --> BLOCKED: Reference not ready\n    BLOCKED --> INITIALIZED: All refs ready\n    PENDING --> ERRORED: Parsing error\n    INITIALIZED --> [*]\n    ERRORED --> [*]\n```\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:53-107]()\n\nChunk types:\n- **PendingChunk**: Waiting for data\n- **BlockedChunk**: Data received but references unresolved\n- **ResolvedModelChunk**: JSON string ready to parse\n- **InitializedChunk**: Final value ready\n- **ErroredChunk**: Failed to decode\n\n### JSON Revival\n\nThe decoder uses custom JSON revivers to handle special encodings:\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:595-951]()\n\nThe `parseModelString()` function handles prefixed values:\n- `"$undefined"`  `undefined`\n- `"$-0"`  `-0`\n- `"$Infinity"`  `Infinity`\n- `"$NaN"`  `NaN`\n- `"$n{digits}"`  `BigInt`\n- `"$D{isoString}"`  `Date`\n- `"$Q{id}"`  Reference to Map chunk\n- `"$W{id}"`  Reference to Set chunk\n- `"$h{id}"`  Server reference with optional bound args\n- `"$@{id}"`  Promise reference\n- `"${tag}{id}"`  Typed array reference\n\n### Server Reference Resolution\n\nWhen decoding a server reference:\n\n```mermaid\ngraph TB\n    RefString["$h{id} string"]\n    Parse["Parse reference structure"]\n    \n    RefString --> Parse\n    \n    HasBound{"Has bound args?"}\n    Parse --> HasBound\n    \n    HasBound -->|No| ResolveModule["resolveServerReference(bundlerConfig, id)"]\n    HasBound -->|Yes| DecodeBound["Decode bound args chunk"]\n    \n    DecodeBound --> CreateBound["createBoundServerReference()"]\n    CreateBound --> BoundFunc["Function with bound args"]\n    \n    ResolveModule --> Module["Server module function"]\n    \n    style Parse fill:#e8f4f8\n    style CreateBound fill:#fff4e1\n```\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:716-778]()\n\nProcess:\n1. Parse `$$id` from the reference\n2. If `$$bound` exists, decode the bound arguments chunk\n3. Use `resolveServerReference()` to load the module\n4. If bound, call `createBoundServerReference()` from Reply Client\n5. Return executable function\n\n---\n\n## Form Actions and Progressive Enhancement\n\nServer actions integrate with HTML forms to enable progressive enhancement, where forms work even without JavaScript.\n\n### Form Action Encoding\n\n```mermaid\ngraph TB\n    subgraph "Server Rendering"\n        ServerAction["Server Action Function"]\n        RenderForm["<form action={serverAction}>"]\n    end\n    \n    ServerAction --> RenderForm\n    \n    subgraph "HTML Output"\n        FormTag["<form action=... enctype=...>"]\n        HiddenInputs["Hidden inputs with encoded action"]\n    end\n    \n    RenderForm --> FormTag\n    RenderForm --> HiddenInputs\n    \n    subgraph "Client Behavior"\n        JSDisabled["JS Disabled: Native form submit"]\n        JSEnabled["JS Enabled: Intercept with React"]\n    end\n    \n    FormTag --> JSDisabled\n    FormTag --> JSEnabled\n    \n    JSDisabled --> HTTPPost["POST to server action endpoint"]\n    JSEnabled --> CallAction["Call action with FormData"]\n    \n    style RenderForm fill:#e8f4f8\n    style JSEnabled fill:#d4f4dd\n```\n\n**Form Action Flow**\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:642-686]()\n\nThe `encodeFormAction()` callback is provided by integrations (webpack, etc.):\n1. Takes a server reference ID and bound arguments\n2. Returns a `ReactCustomFormAction` object\n3. Contains action URL and method for form submission\n4. React inserts hidden inputs to encode the action\n\n**Progressive Enhancement:**\n- **Without JS**: Form submits normally to server action endpoint\n- **With JS**: React intercepts submit, encodes FormData, calls action directly\n- Result: Forms work regardless of JS availability\n\n### Form Data Encoding\n\nWhen a form is submitted:\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:688-763]()\n\nThe `encodeFormData()` function:\n1. Walks the FormData entries\n2. Identifies which entries are files/blobs\n3. Creates a filtered FormData with only files\n4. Encodes non-file entries as JSON\n5. Appends the JSON structure to FormData\n6. Returns the combined FormData\n\nThis allows mixing structured data (objects, arrays) with file uploads in a single form submission.\n\n---\n\n## Bound Arguments\n\nServer actions support partial application through `.bind()`, enabling arguments to be pre-bound on the server before sending to the client.\n\n### Binding Flow\n\n```mermaid\nsequenceDiagram\n    participant Server as Server (RSC Render)\n    participant Client as Client\n    participant ServerExec as Server (Action Execution)\n    \n    Server->>Server: Define serverAction()\n    Server->>Server: boundAction = serverAction.bind(null, \'presetArg\')\n    Server->>Client: Serialize boundAction with $$bound\n    \n    Note over Client: Client receives:<br/>{$$id, $$bound: chunk ref}\n    \n    Client->>Client: User calls boundAction(\'userArg\')\n    Client->>Client: encodeReply([\'userArg\'])\n    Client->>ServerExec: POST with encoded args\n    \n    ServerExec->>ServerExec: decodeReply()  [\'userArg\']\n    ServerExec->>ServerExec: Decode $$bound  [\'presetArg\']\n    ServerExec->>ServerExec: Concat: [\'presetArg\', \'userArg\']\n    ServerExec->>ServerExec: Execute serverAction(\'presetArg\', \'userArg\')\n    ServerExec->>Client: Return result\n```\n\n**Bound Arguments Storage**\n\nSources: [packages/react-server/src/ReactFlightServer.js:2507-2566]()\n\nWhen serializing a server reference with `$$bound`:\n1. Server outlines the bound array as a separate chunk\n2. Serializes the reference as `{id, bound}` structure\n3. Client reconstructs with bound args attached\n4. On invocation, concatenates bound args with call args\n\n**Chaining Binds**\n\nMultiple `.bind()` calls accumulate arguments:\n\n```javascript\nconst action1 = serverAction.bind(null, \'a\');\n// action1.$$bound = [\'a\']\n\nconst action2 = action1.bind(null, \'b\');\n// action2.$$bound = [\'a\', \'b\']\n```\n\nSources: [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js:77-80]()\n\n---\n\n## Streaming and Async Values\n\nBoth encoding and decoding support streaming and asynchronous values, enabling progressive data transmission.\n\n### Streaming Reply Encoding\n\n```mermaid\ngraph TB\n    subgraph "Client Encoding Stream"\n        AsyncValue["Promise or AsyncIterable"]\n        StreamID["Allocate stream ID"]\n        InitialReply["Return $@{id} immediately"]\n    end\n    \n    AsyncValue --> StreamID\n    StreamID --> InitialReply\n    \n    subgraph "Async Resolution"\n        ResolveValue["Value resolves"]\n        EncodeResolved["Encode resolved value"]\n        AppendChunk["Append to FormData with stream ID"]\n    end\n    \n    InitialReply --> ResolveValue\n    ResolveValue --> EncodeResolved\n    EncodeResolved --> AppendChunk\n    \n    subgraph "Stream Completion"\n        CloseSignal["Append \'C\' close signal"]\n        ResolvePending["Resolve pending parts counter"]\n    end\n    \n    AppendChunk --> CloseSignal\n    CloseSignal --> ResolvePending\n    \n    style AsyncValue fill:#fff4e1\n    style InitialReply fill:#e8f4f8\n```\n\n**Promise Encoding**\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:466-554]()\n\nThe `serializePromise()` function:\n1. Returns immediately with `$@{id}` reference\n2. Attaches `.then()` handlers to the promise\n3. When resolved, encodes the value\n4. Appends encoded value to FormData with the stream ID\n5. When FormData is complete, resolves the `processReply()` promise\n\n### Async Iterable Encoding\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:306-381]()\n\nThe `serializeAsyncIterable()` function:\n1. Distinguishes single-shot (iterator === iterable) vs multi-shot\n2. Encodes as `$x{id}` or `$X{id}`\n3. For each iteration result, appends to FormData\n4. Encodes done values if non-undefined\n5. Closes stream with `"C"` signal\n\n### Streaming Reply Decoding\n\nOn the server, streamed values are reconstructed progressively:\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:352-469]()\n\n**Stream Chunk Processing:**\n1. Each FormData entry with a stream ID is a chunk\n2. The first entry creates the stream structure\n3. Subsequent entries enqueue values\n4. The `"C"` entry closes the stream\n\n**Async Iterable Reconstruction:**\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:411-469]()\n\nThe `createAsyncIterable()` function:\n1. Creates a controller with enqueue/close/error methods\n2. Returns an async iterable that yields queued values\n3. Distinguishes single-shot vs multi-shot based on prefix\n\n---\n\n## Execution Flow Diagram\n\nThis diagram shows a complete round-trip from server action definition to execution:\n\n```mermaid\nsequenceDiagram\n    participant ServerRender as Server (RSC Render)\n    participant FlightStream as Flight Stream\n    participant ClientRuntime as Client Runtime\n    participant UserCode as User Code\n    participant ReplyEncoding as Reply Encoding\n    participant ServerAction as Server (Action Exec)\n    participant ServerModule as Server Module\n    \n    ServerRender->>ServerRender: Define greet(name)\n    ServerRender->>ServerRender: registerServerReference(greet, id)\n    ServerRender->>FlightStream: Serialize {$$typeof, $$id, $$bound}\n    \n    FlightStream->>ClientRuntime: Stream server reference\n    ClientRuntime->>ClientRuntime: Reconstruct proxy function\n    ClientRuntime->>UserCode: Provide greet()\n    \n    Note over UserCode: User clicks button,<br/>calls greet(\'Alice\')\n    \n    UserCode->>ReplyEncoding: greet(\'Alice\')\n    ReplyEncoding->>ReplyEncoding: encodeReply([\'Alice\'])\n    ReplyEncoding->>ServerAction: POST body with encoded args\n    \n    ServerAction->>ServerAction: decodeReply(body)\n    ServerAction->>ServerAction: resolveServerReference(id)\n    ServerAction->>ServerModule: Load module\n    ServerModule->>ServerAction: Return greet function\n    ServerAction->>ServerAction: Execute greet(...decodedArgs)\n    ServerAction->>ClientRuntime: Return result\n    \n    ClientRuntime->>UserCode: Resolve promise with result\n```\n\n**Complete Workflow:**\n\n1. **Server Render Phase**: Define and register server actions\n2. **Flight Streaming**: Serialize references with IDs\n3. **Client Reconstruction**: Create callable proxy functions\n4. **User Invocation**: Call action from client code\n5. **Reply Encoding**: Serialize arguments as FormData/JSON\n6. **Server Reception**: Decode reply and resolve module\n7. **Execution**: Run actual server function\n8. **Result Return**: Stream response back to client\n\nSources: [packages/react-server/src/ReactFlightServer.js:2507-2566](), [packages/react-client/src/ReactFlightReplyClient.js:183-465](), [packages/react-server/src/ReactFlightReplyServer.js:1113-1183]()\n\n---\n\n## Key Implementation Files\n\n| Component | File Path | Key Functions |\n|-----------|-----------|---------------|\n| Server Reference Registration | [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js]() | `registerServerReference()`, `isServerReference()`, custom `bind()` |\n| Reply Encoding | [packages/react-client/src/ReactFlightReplyClient.js]() | `encodeReply()`, `processReply()`, `resolveToJSON()` |\n| Reply Decoding | [packages/react-server/src/ReactFlightReplyServer.js]() | `decodeReply()`, `processReplyChunk()`, `parseModelString()` |\n| Server Reference Execution | [packages/react-server/src/ReactFlightReplyServer.js:716-778]() | Server reference resolution and bound arg handling |\n| Form Action Encoding | [packages/react-client/src/ReactFlightReplyClient.js:642-763]() | `encodeFormAction()`, `encodeFormData()` |\n| Bound Server References | [packages/react-client/src/ReactFlightReplyClient.js:69-71]() | `createBoundServerReference()`, `registerBoundServerReference()` |\n\nSources: All files listed in the table above.\n\n---\n\n# Page: Platform Implementations\n\n# Platform Implementations\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis section documents React\'s **platform implementations**the concrete renderers that adapt React\'s reconciler to specific environments. React maintains official implementations for browser DOM ([React DOM Implementation](#6.1)) and React Native ([React Native Renderers](#6.2)), along with specialized features like client-side hydration ([Hydration System](#6.3)) and view transitions ([View Transitions and Gesture Scheduling](#6.4)).\n\nThe foundation enabling these diverse platforms is the **host configuration abstraction layer**an interface between the reconciler and platform-specific code. The host config provides platform-specific implementations of operations like creating instances, updating properties, and managing tree structure. This abstraction allows the same reconciler logic to render to browser DOM, React Native, canvas-based renderers, test environments, and custom targets.\n\nFor the reconciler\'s architecture and how it processes the Fiber tree, see [React Reconciler](#4).\n\n## Platform Overview\n\nReact\'s architecture separates the **reconciler** (platform-agnostic tree diffing and scheduling) from **renderers** (platform-specific instance management and DOM/native manipulation). The primary platforms are:\n\n**React DOM** ([ReactFiberConfigDOM](#6.1)): Renders to browser DOM. Supports mutation mode, hydration of server-rendered HTML, resource management (stylesheets, scripts), singleton components (document head), and view transitions.\n\n**React Native Fabric** ([ReactFiberConfigFabric](#6.2)): New React Native architecture using persistence mode with immutable shadow nodes. Communicates with `nativeFabricUIManager` for native UI operations.\n\n**React Native Legacy** ([ReactFiberConfigNative](#6.2)): Original React Native renderer using mutation mode. Communicates with `UIManager` for native view management.\n\n**Test Renderer** ([ReactFiberConfigTestHost](#6.2)): In-memory tree representation for snapshot testing without actual rendering.\n\n**Noop Renderer** (createReactNoop): Testing-only renderer supporting both mutation and persistence modes for validating reconciler behavior.\n\nEach platform implements the host configuration interface to provide its specific behavior while using the shared reconciler logic.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-153](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-82](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:1-58](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:1-26](), [packages/react-noop-renderer/src/createReactNoop.js:1-111]()\n\n## Host Configuration Architecture\n\nThe host configuration interface defines a contract between the reconciler and the platform. The reconciler calls host config methods during the render and commit phases to perform platform-specific operations. Each renderer (react-dom, react-native-renderer, react-test-renderer, etc.) provides its own implementation of this interface.\n\n```mermaid\ngraph TB\n    subgraph "React Core"\n        Reconciler["Reconciler<br/>(WorkLoop, BeginWork, CommitWork)"]\n    end\n    \n    subgraph "Host Config Interface"\n        HostConfigInterface["Host Configuration Interface<br/>createInstance, commitUpdate,<br/>appendChild, etc."]\n    end\n    \n    subgraph "Platform Implementations"\n        DOM["ReactFiberConfigDOM<br/>Browser DOM operations"]\n        Fabric["ReactFiberConfigFabric<br/>React Native Fabric<br/>(Persistence Mode)"]\n        NativeLegacy["ReactFiberConfigNative<br/>React Native Legacy<br/>(Mutation Mode)"]\n        TestRenderer["ReactFiberConfigTestHost<br/>Test environment"]\n        NoopRenderer["createReactNoop<br/>Testing reconciler"]\n        CustomRenderer["ReactFiberConfig.custom<br/>Third-party renderers"]\n    end\n    \n    subgraph "Native APIs"\n        BrowserAPIs["Browser DOM APIs<br/>document.createElement,<br/>appendChild, etc."]\n        FabricUIManager["nativeFabricUIManager<br/>createNode, cloneNode,<br/>completeRoot"]\n        LegacyUIManager["UIManager<br/>createView, updateView,<br/>manageChildren"]\n        MemoryTree["In-Memory Tree<br/>(for testing)"]\n    end\n    \n    Reconciler -->|"calls"| HostConfigInterface\n    \n    HostConfigInterface -->|"implemented by"| DOM\n    HostConfigInterface -->|"implemented by"| Fabric\n    HostConfigInterface -->|"implemented by"| NativeLegacy\n    HostConfigInterface -->|"implemented by"| TestRenderer\n    HostConfigInterface -->|"implemented by"| NoopRenderer\n    HostConfigInterface -->|"implemented by"| CustomRenderer\n    \n    DOM --> BrowserAPIs\n    Fabric --> FabricUIManager\n    NativeLegacy --> LegacyUIManager\n    TestRenderer --> MemoryTree\n    NoopRenderer --> MemoryTree\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-292](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-160](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:1-115](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:1-59](), [packages/react-noop-renderer/src/createReactNoop.js:1-111]()\n\n## Core Host Configuration Methods\n\nThe host configuration interface consists of several categories of methods that the reconciler invokes at different stages of the rendering process.\n\n```mermaid\ngraph LR\n    subgraph "Instance Management"\n        createInstance["createInstance<br/>(type, props, rootContainer, hostContext)"]\n        createTextInstance["createTextInstance<br/>(text, rootContainer, hostContext)"]\n        createHoistableInstance["createHoistableInstance<br/>(type, props, rootContainer)<br/>(DOM only)"]\n    end\n    \n    subgraph "Context Management"\n        getRootHostContext["getRootHostContext<br/>(rootContainer)"]\n        getChildHostContext["getChildHostContext<br/>(parentContext, type)"]\n    end\n    \n    subgraph "Initial Render"\n        appendInitialChild["appendInitialChild<br/>(parent, child)"]\n        finalizeInitialChildren["finalizeInitialChildren<br/>(instance, type, props)"]\n    end\n    \n    subgraph "Commit Phase"\n        commitMount["commitMount<br/>(instance, type, props)"]\n        commitUpdate["commitUpdate<br/>(instance, type, oldProps, newProps)"]\n        commitTextUpdate["commitTextUpdate<br/>(textInstance, oldText, newText)"]\n    end\n    \n    subgraph "Tree Manipulation - Mutation"\n        appendChild["appendChild<br/>(parent, child)"]\n        insertBefore["insertBefore<br/>(parent, child, beforeChild)"]\n        removeChild["removeChild<br/>(parent, child)"]\n    end\n    \n    subgraph "Tree Manipulation - Persistence"\n        cloneInstance["cloneInstance<br/>(instance, type, oldProps, newProps)"]\n        createContainerChildSet["createContainerChildSet"]\n        replaceContainerChildren["replaceContainerChildren<br/>(container, newChildren)"]\n    end\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:484-608](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:176-220](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:130-169](), [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:56-188]()\n\n## Platform Type Definitions\n\nEach platform implementation defines its own types for instances, containers, and other platform-specific data structures:\n\n| Type | ReactFiberConfigDOM | ReactFiberConfigFabric | ReactFiberConfigNative | ReactFiberConfigTestHost |\n|------|---------------------|------------------------|------------------------|--------------------------|\n| **Type** | `string` (element tag name) | `string` (view type) | `string` (view type) | `string` |\n| **Instance** | `Element` (DOM element) | `{node: Node, canonical: {...}}` (shadow node) | `ReactNativeFiberHostComponent` | `{type, props, children, tag: \'INSTANCE\'}` |\n| **TextInstance** | `Text` (DOM text node) | `{node: Node}` (text shadow node) | `number` (text tag) | `{text, tag: \'TEXT\'}` |\n| **Container** | `Element \\| Document \\| DocumentFragment` | `{containerTag: number, publicInstance}` | `{containerTag: number, publicInstance}` | `{children: [], createNodeMock, tag: \'CONTAINER\'}` |\n| **HostContext** | `HostContextNamespace` (0=None, 1=SVG, 2=Math) | `{isInAParentText: boolean}` | `{isInAParentText: boolean}` | `Object` (NO_CONTEXT) |\n| **UpdatePayload** | `Array<mixed>` (property updates) | `Object` (attribute payload) | `Object` (unused) | `Object` |\n| **Mode** | Mutation | Persistence | Mutation | Mutation |\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:153-250](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:93-139](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:59-73](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:26-58]()\n\n## Mutation vs Persistence Modes\n\nHost configurations can operate in two different modes depending on the platform\'s capabilities:\n\n```mermaid\ngraph TB\n    subgraph "Mutation Mode (DOM, React Native Legacy, Test Renderer)"\n        MutationFlag["supportsMutation = true<br/>supportsPersistence = false"]\n        \n        MutationRender["Render Phase:<br/>Create instances and build tree"]\n        MutationCommit["Commit Phase:<br/>Mutate existing instances in-place"]\n        \n        MutationOps["Operations:<br/> appendChild<br/> insertBefore<br/> removeChild<br/> commitUpdate (mutate props)<br/> commitTextUpdate"]\n        \n        MutationFlag --> MutationRender\n        MutationRender --> MutationCommit\n        MutationCommit --> MutationOps\n    end\n    \n    subgraph "Persistence Mode (React Native Fabric)"\n        PersistenceFlag["supportsMutation = false<br/>supportsPersistence = true"]\n        \n        PersistenceRender["Render Phase:<br/>Clone and build new tree"]\n        PersistenceCommit["Commit Phase:<br/>Replace entire tree atomically"]\n        \n        PersistenceOps["Operations:<br/> cloneInstance<br/> createContainerChildSet<br/> appendChildToContainerChildSet<br/> replaceContainerChildren<br/> No in-place mutations"]\n        \n        PersistenceFlag --> PersistenceRender\n        PersistenceRender --> PersistenceCommit\n        PersistenceCommit --> PersistenceOps\n    end\n```\n\n**Mutation Mode** (DOM, React Native Legacy): Instances can be mutated in place. The reconciler creates instances once and then updates them by calling methods like `commitUpdate`, `appendChild`, `removeChild`. This is more memory efficient but requires careful synchronization.\n\n**Persistence Mode** (React Native Fabric): Instances are immutable. The reconciler clones instances to create modified versions, builds a complete new tree, and replaces the old tree atomically. This provides better concurrency characteristics and aligns with React Native\'s new architecture.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:811](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:449](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:377](), [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js:22]()\n\n## Platform-Specific Instance Creation\n\nEach platform implements `createInstance` differently based on its underlying rendering API. DOM creates actual browser elements with namespace handling for SVG/MathML, while React Native allocates tags and communicates with native UI managers. For detailed implementation specifics, see [React DOM Implementation](#6.1) and [React Native Renderers](#6.2).\n\n**DOM**: Calls `document.createElement()` or `document.createElementNS()` based on namespace context, then sets initial properties and caches the fiber node reference.\n\n**React Native Fabric**: Allocates a unique tag, gets the view configuration, creates an attribute payload, and calls `nativeFabricUIManager.createNode()` to create an immutable shadow node.\n\n**React Native Legacy**: Allocates a tag, creates an update payload, calls `UIManager.createView()`, and wraps the result in a `ReactNativeFiberHostComponent` instance.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:484-608](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:176-220](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:130-169]()\n\n## Host Context Management\n\nHost context flows down the tree during rendering and provides namespace/environment information needed for instance creation. Different platforms use it for different purposes:\n\n**DOM**: Tracks namespace (None, SVG, Math) to create elements with the correct namespace. SVG and MathML elements require `createElementNS`.\n\n```\ngetRootHostContext: Determine initial namespace from root element\ngetChildHostContext: Update namespace when entering/leaving <svg>, <math>, or <foreignObject>\n```\n\n**React Native**: Tracks whether rendering is occurring within a Text component, which affects validation (text strings must be inside `<Text>`).\n\n```\ngetRootHostContext: Returns {isInAParentText: false}\ngetChildHostContext: Updates isInAParentText based on component type (RCTText, AndroidTextInput, etc.)\n```\n\n**Test/Noop Renderers**: Returns a constant `NO_CONTEXT` object since no special context is needed.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:302-406](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:259-291](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:264-287]()\n\n## Priority and Event Management\n\nHost configurations provide methods for managing update priorities and tracking events:\n\n| Method | Purpose | DOM Implementation | React Native Implementation |\n|--------|---------|-------------------|----------------------------|\n| `setCurrentUpdatePriority` | Set the current update priority | Stores in module variable | Stores in module variable |\n| `getCurrentUpdatePriority` | Get the current update priority | Returns stored priority | Returns stored priority |\n| `resolveUpdatePriority` | Resolve priority for a batch of work | Returns current or defers to event priority | Returns current or default priority |\n| `trackSchedulerEvent` | Track the current browser event | Stores `window.event` | No-op |\n| `resolveEventType` | Get the current event type | Returns `window.event.type` | Returns null |\n| `resolveEventTimeStamp` | Get the current event timestamp | Returns `window.event.timeStamp` | Returns -1.1 |\n| `shouldAttemptEagerTransition` | Check if should render transitions synchronously | Checks if `popstate` event | Returns false |\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:709-747](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:386-433](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:343-371]()\n\n## Commit Lifecycle Methods\n\nThe reconciler invokes these methods during the commit phase to finalize changes:\n\n**`prepareForCommit(containerInfo)`**: Called before mutations begin. Returns an object that will be passed to `resetAfterCommit`. DOM uses this to disable events and capture selection state. React Native returns null (no-op).\n\n**`resetAfterCommit(containerInfo)`**: Called after mutations complete. DOM restores event handling and selection. React Native is a no-op.\n\n**`commitMount(instance, type, props, internalInstanceHandle)`**: Called for instances that returned `true` from `finalizeInitialChildren`. Used to implement effects that should happen after the instance is in the tree (e.g., auto-focus, triggering image load events).\n\n**`commitUpdate(instance, type, oldProps, newProps, internalInstanceHandle)`**: Called to update an existing instance with new props. DOM calls `updateProperties` to diff and apply property changes. React Native calls `UIManager.updateView` with diffed payload.\n\n**`commitTextUpdate(textInstance, oldText, newText)`**: Called to update a text node. DOM sets `nodeValue`, React Native calls `UIManager.updateView`.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:412-450](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:813-872](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:917-942](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:317-467]()\n\n## Hydration Support\n\nReact DOM implements client-side **hydration** to attach React to server-rendered HTML. The host config provides methods for traversing and validating existing DOM nodes during initial render:\n\n**`hydrateInstance(instance, type, props, hostContext)`**: Validates and updates a DOM element to match React props. Returns an update payload if properties differ.\n\n**`hydrateTextInstance(textInstance, text, internalInstanceHandle)`**: Validates text node content matches expected text. Returns `true` if text differs (triggering a warning in DEV).\n\n**`getNextHydratableSibling(instance)`**: Returns the next DOM sibling that can be hydrated.\n\n**`getFirstHydratableChild(parentInstance)`**: Returns the first hydratable child of a DOM node.\n\n**`hydrateRootInstance(container)`**: Clears comment nodes and prepares the root container for hydration.\n\n**`shouldDeleteUnhydratedTailInstances()`**: Returns `true` to delete remaining DOM nodes after hydration completes.\n\nThe hydration process handles mismatches, supports Suspense boundaries, and enables selective hydration for improved time-to-interactive. For complete details, see [Hydration System](#6.3).\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1281-1590]()\n\n## View Transitions and Gesture Scheduling\n\nReact DOM includes experimental support for the View Transition API to enable smooth animated transitions between UI states. The host config provides methods for managing view transition instances and gesture-driven animations:\n\n**`startViewTransition(root, updater, options)`**: Initiates a view transition with callback for custom animation timelines.\n\n**`cloneMutableInstance(instance, keepChildren)`**: Clones DOM elements to create animation pairs for view transitions.\n\n**View Transition Instance Management**: Methods for applying/restoring transition names, measuring instance geometry, and tracking viewport visibility.\n\n**Gesture Scheduling**: Integration with gesture recognizers to drive view transitions based on user input (swipes, drags).\n\nThe system coordinates with `ReactFiberCommitViewTransitions` to identify animated elements, clone instances for animation pairs, measure geometry changes, and execute transition animations. For complete details, see [View Transitions and Gesture Scheduling](#6.4).\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:613-638](), [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js:1-50](), [packages/react-reconciler/src/ReactFiberApplyGesture.js:1-100]()\n\n## Testing and Third-Party Renderers\n\n### Test Renderer\n\nThe test renderer creates an in-memory tree representation without rendering to any actual surface. Instances are plain objects with `tag: \'INSTANCE\'` or `tag: \'TEXT\'`. This is used for snapshot testing and asserting on React\'s output without a DOM.\n\n**Sources:** [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:158-174](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:216-227]()\n\n### Noop Renderer\n\nThe noop renderer is similar to the test renderer but provides both mutation and persistence mode implementations. It\'s primarily used for testing the reconciler itself and validating reconciler behavior without platform-specific complications.\n\n**Sources:** [packages/react-noop-renderer/src/createReactNoop.js:111-452]()\n\n### Custom Renderers (Third-Party)\n\nThe `react-reconciler` package allows third parties to create custom renderers by passing a host config object to the reconciler factory function. The `ReactFiberConfig.custom.js` file serves as a shim that forwards all host config methods from a `$$$config` variable (passed as an argument to the reconciler bundle).\n\n```mermaid\ngraph LR\n    CustomRenderer["Custom Renderer Package"]\n    HostConfigObject["Host Config Object<br/>{createInstance, commitUpdate, ...}"]\n    ReconcilerFactory["ReactFiberReconciler(config)"]\n    ReconcilerInstance["Reconciler Instance<br/>{createContainer, updateContainer, ...}"]\n    \n    CustomRenderer --> HostConfigObject\n    HostConfigObject --> ReconcilerFactory\n    ReconcilerFactory --> ReconcilerInstance\n    \n    ReconcilerInstance -->|"calls during render/commit"| HostConfigObject\n```\n\n**Sources:** [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:1-285](), [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js:41-121]()\n\n## Optional Features and Capabilities\n\nHost configurations can opt into or out of various capabilities by implementing specific methods or setting flags:\n\n| Feature | Flag/Methods | DOM | Fabric | Native Legacy | Test |\n|---------|-------------|-----|--------|---------------|------|\n| **Mutation** | `supportsMutation` |  |  |  |  |\n| **Persistence** | `supportsPersistence` |  |  |  |  |\n| **Hydration** | `supportsHydration` |  |  |  |  |\n| **Microtasks** | `supportsMicrotasks` |  |  |  |  |\n| **Resources** | `supportsResources` |  |  |  |  |\n| **Singletons** | `supportsSingletons` |  |  |  |  |\n| **Test Selectors** | `supportsTestSelectors` |  |  |  |  |\n| **Fragment Instances** | `createFragmentInstance` |  |  | No-op | No-op |\n| **View Transitions** | `startViewTransition` | Planned | No-op | No-op | No-op |\n\nMost platforms import default implementations for unsupported features from modules like `ReactFiberConfigWithNoHydration`, `ReactFiberConfigWithNoResources`, etc., which provide no-op implementations or throw errors.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:292](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:160-165](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:115-121](), [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js:22-60]()\n\n## Summary\n\nThe host configuration abstraction is the foundation of React\'s platform independence. By defining a clear interface between the reconciler and platform-specific code, React can:\n\n- Render to vastly different targets (DOM, native mobile, canvas, terminals, etc.)\n- Support different rendering paradigms (mutation vs persistence)\n- Optimize for platform-specific capabilities (hydration, resources, singletons)\n- Enable third-party renderers without forking the reconciler\n\nEach platform implementation makes trade-offs based on its constraintsDOM uses mutation for efficiency and hydration support, Fabric uses persistence for better concurrency, test renderers prioritize simplicity and determinism. The host config interface accommodates all these approaches while keeping the reconciler\'s core logic platform-agnostic.\n\n---\n\n# Page: React DOM Implementation\n\n# React DOM Implementation\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes the React DOM host configuration implementation (`ReactFiberConfigDOM`), which serves as the bridge between React\'s reconciler and the browser\'s DOM APIs. This implementation defines how React creates, updates, and manages DOM elements during rendering and commits.\n\nFor information about the host configuration abstraction itself, see [Host Configuration Abstraction](#4.6). For hydration-specific functionality, see [Hydration System](#6.3). For view transition coordination, see [View Transitions and Gesture Scheduling](#6.4).\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-150]()\n\n## Architecture Overview\n\nThe DOM host configuration implements the interface expected by the React reconciler, translating reconciler operations into browser DOM manipulations. It operates in mutation mode, directly modifying the DOM tree as changes occur.\n\n```mermaid\ngraph TB\n    subgraph "React Reconciler"\n        Reconciler["React Reconciler<br/>Work Loop & Commit"]\n        HostConfigInterface["Host Config Interface<br/>createInstance, commitUpdate, etc."]\n    end\n    \n    subgraph "ReactFiberConfigDOM"\n        InstanceCreation["Instance Creation<br/>createInstance()<br/>createTextInstance()"]\n        PropertyMgmt["Property Management<br/>setInitialProperties()<br/>updateProperties()"]\n        MutationOps["Mutation Operations<br/>appendChild()<br/>insertBefore()<br/>commitUpdate()"]\n        EventIntegration["Event Integration<br/>listenToAllSupportedEvents()"]\n        ResourceMgmt["Resource Management<br/>createHoistableInstance()"]\n        HostContext["Host Context<br/>Namespace Tracking"]\n    end\n    \n    subgraph "Browser APIs"\n        DOM["DOM APIs<br/>createElement, appendChild, etc."]\n        EventSystem["Browser Event System"]\n    end\n    \n    Reconciler --> HostConfigInterface\n    HostConfigInterface --> InstanceCreation\n    HostConfigInterface --> PropertyMgmt\n    HostConfigInterface --> MutationOps\n    HostConfigInterface --> ResourceMgmt\n    HostConfigInterface --> HostContext\n    \n    InstanceCreation --> DOM\n    PropertyMgmt --> DOM\n    MutationOps --> DOM\n    EventIntegration --> EventSystem\n    ResourceMgmt --> DOM\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-292]()\n\n## Type System\n\nReactFiberConfigDOM defines the core types that represent DOM constructs within the reconciler.\n\n### Core Types\n\n| Type | Definition | Description |\n|------|------------|-------------|\n| `Type` | `string` | Element type (e.g., \'div\', \'span\') |\n| `Props` | `object` | React props object with DOM-specific properties |\n| `Container` | `Element \\| Document \\| DocumentFragment` | Root container element with `_reactRootContainer` field |\n| `Instance` | `Element` | A DOM element instance |\n| `TextInstance` | `Text` | A DOM text node |\n| `HostContext` | `HostContextDev \\| HostContextProd` | Namespace context (SVG, MathML, or HTML) |\n| `UpdatePayload` | `Array<mixed>` | Array of alternating property keys and values |\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:153-248]()\n\n### Instance Types Diagram\n\n```mermaid\ngraph LR\n    Container["Container<br/>(Element/Document/DocumentFragment)"]\n    Instance["Instance<br/>(Element)"]\n    TextInstance["TextInstance<br/>(Text)"]\n    HydratableInstance["HydratableInstance<br/>(Instance | TextInstance | SuspenseInstance | ActivityInstance)"]\n    \n    Container -->|"contains"| Instance\n    Container -->|"contains"| TextInstance\n    Instance -->|"children"| Instance\n    Instance -->|"children"| TextInstance\n    Instance -.->|"is a"| HydratableInstance\n    TextInstance -.->|"is a"| HydratableInstance\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:211-237]()\n\n## Host Context Management\n\nThe host context tracks the current namespace (HTML, SVG, MathML) to ensure elements are created with the correct namespace URI. This is critical for proper rendering of SVG and MathML elements within HTML documents.\n\n### Namespace Constants\n\n```mermaid\ngraph TD\n    HostContextNamespace["HostContextNamespace<br/>opaque type: 0 | 1 | 2"]\n    \n    HostContextNamespace --> None["HostContextNamespaceNone = 0<br/>(HTML namespace)"]\n    HostContextNamespace --> Svg["HostContextNamespaceSvg = 1<br/>(SVG namespace)"]\n    HostContextNamespace --> Math["HostContextNamespaceMath = 2<br/>(MathML namespace)"]\n```\n\n### Context Flow\n\nThe reconciler calls `getRootHostContext` when entering a root container, then `getChildHostContext` for each child element to determine the appropriate namespace.\n\n```mermaid\ngraph TB\n    GetRoot["getRootHostContext(rootContainer)"]\n    CheckNodeType{"rootContainer<br/>nodeType"}\n    DocumentNode["DOCUMENT_NODE or<br/>DOCUMENT_FRAGMENT_NODE"]\n    ElementNode["ELEMENT_NODE"]\n    \n    GetRoot --> CheckNodeType\n    CheckNodeType -->|"9 or 11"| DocumentNode\n    CheckNodeType -->|"1"| ElementNode\n    \n    DocumentNode --> CheckDocElement{"documentElement<br/>namespaceURI"}\n    CheckDocElement -->|"svg"| ReturnSvg["Return HostContextNamespaceSvg"]\n    CheckDocElement -->|"math"| ReturnMath["Return HostContextNamespaceMath"]\n    CheckDocElement -->|"other"| ReturnNone["Return HostContextNamespaceNone"]\n    \n    ElementNode --> GetOwnContext["getOwnHostContext(namespaceURI)"]\n    GetOwnContext --> GetChildContext["getChildHostContextProd(context, type)"]\n```\n\nKey functions:\n- `getRootHostContext(rootContainerInstance)` [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:302-355]()\n- `getChildHostContext(parentHostContext, type)` [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:391-406]()\n- `getChildHostContextProd(parentNamespace, type)` [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:368-389]()\n\n### Namespace Transitions\n\nSpecial handling exists for namespace transitions:\n- Entering `<svg>` from HTML switches to SVG namespace\n- Entering `<math>` from HTML switches to MathML namespace  \n- `<foreignObject>` within SVG returns to HTML namespace\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:284-406]()\n\n## Instance Creation\n\nDOM instances are created during the reconciler\'s render phase and finalized during the commit phase.\n\n### Regular Instance Creation\n\n```mermaid\ngraph TB\n    CreateInstance["createInstance(type, props, rootContainer, hostContext, fiber)"]\n    \n    CreateInstance --> CheckContext{"hostContext<br/>namespace"}\n    \n    CheckContext -->|"Svg"| CreateSvg["ownerDocument.createElementNS<br/>(SVG_NAMESPACE, type)"]\n    CheckContext -->|"Math"| CreateMath["ownerDocument.createElementNS<br/>(MATH_NAMESPACE, type)"]\n    CheckContext -->|"None"| CheckSpecial{"Special element?"}\n    \n    CheckSpecial -->|"\'script\'"| CreateScript["Create via innerHTML<br/>to prevent execution"]\n    CheckSpecial -->|"\'select\'"| CreateSelect["createElement(\'select\')<br/>+ handle multiple/size"]\n    CheckSpecial -->|"other"| CreateNormal["createElement(type)"]\n    \n    CreateSvg --> Cache["precacheFiberNode(fiber, element)"]\n    CreateMath --> Cache\n    CreateScript --> Cache\n    CreateSelect --> Cache\n    CreateNormal --> Cache\n    \n    Cache --> UpdateProps["updateFiberProps(element, props)"]\n    UpdateProps --> Return["Return element"]\n```\n\nThe `createInstance` function:\n1. Determines the owner document from the root container\n2. Creates the element with the appropriate namespace\n3. Caches the fiber-to-DOM mapping via `precacheFiberNode`\n4. Stores props on the DOM node via `updateFiberProps`\n5. Does NOT call `setInitialProperties` (that happens in `finalizeInitialChildren`)\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:484-608]()\n\n### Hoistable Instance Creation\n\nHoistable instances are special DOM elements (like `<link>`, `<style>`, `<script>`) that can be "hoisted" to the document head for resource management.\n\n```mermaid\ngraph LR\n    CreateHoistable["createHoistableInstance(type, props, rootContainer, fiber)"]\n    CreateHoistable --> CreateElem["createElement(type)"]\n    CreateElem --> PrecacheAndProps["precacheFiberNode + updateFiberProps"]\n    PrecacheAndProps --> SetInitial["setInitialProperties(element, type, props)"]\n    SetInitial --> Mark["markNodeAsHoistable(element)"]\n    Mark --> Return["Return element"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:452-468]()\n\n### Text Instance Creation\n\nText nodes are simpler:\n\n```mermaid\ngraph LR\n    CreateText["createTextInstance(text, rootContainer, hostContext, fiber)"]\n    CreateText --> Validate["validateTextNesting<br/>(DEV only)"]\n    Validate --> CreateNode["ownerDocument.createTextNode(text)"]\n    CreateNode --> Precache["precacheFiberNode(fiber, textNode)"]\n    Precache --> Return["Return textNode"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:679-701]()\n\n## Property Management\n\nProperties (React props) are translated into DOM attributes and properties through dedicated helper modules.\n\n### Property Application Flow\n\n```mermaid\ngraph TB\n    Mount["Mount (New Element)"]\n    Update["Update (Existing Element)"]\n    \n    Mount --> AppendChild["appendInitialChild(parent, child)"]\n    AppendChild --> Finalize["finalizeInitialChildren(element, type, props)"]\n    Finalize --> SetInitial["setInitialProperties(element, type, props)"]\n    \n    Update --> CommitUpdate["commitUpdate(element, type, oldProps, newProps)"]\n    CommitUpdate --> UpdateProps["updateProperties(element, type, oldProps, newProps)"]\n    UpdateProps --> UpdateFiberProps["updateFiberProps(element, newProps)"]\n```\n\nKey functions from `ReactDOMComponent`:\n- `setInitialProperties(domElement, tag, props)` - Applied during finalization [packages/react-dom-bindings/src/client/ReactDOMComponent.js]()\n- `updateProperties(domElement, tag, lastProps, nextProps)` - Applied during commit update [packages/react-dom-bindings/src/client/ReactDOMComponent.js]()\n\nSpecial property handling includes:\n- `dangerouslySetInnerHTML` - Sets innerHTML\n- `children` (when string/number) - Sets textContent  \n- `style` - Object converted to CSS string\n- `autoFocus` - Handled in `commitMount`\n- Event handlers - Registered with event system\n- `value`, `checked`, `selected` - Special form control properties\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:78-86](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:917-930]()\n\n## Mutation Operations\n\nReactFiberConfigDOM operates in mutation mode (`supportsMutation = true`), directly modifying the DOM tree. All mutation operations support the `moveBefore` API when available.\n\n### Core Mutation Methods\n\n| Method | Purpose | When Called |\n|--------|---------|-------------|\n| `appendChild(parent, child)` | Append child to end | Repositioning during updates |\n| `appendChildToContainer(container, child)` | Append to root container | Mounting root content |\n| `insertBefore(parent, child, before)` | Insert child before sibling | Reordering, insertion |\n| `insertInContainerBefore(container, child, before)` | Insert into root before sibling | Root-level insertions |\n| `removeChild(parent, child)` | Remove child from parent | Deletions |\n| `removeChildFromContainer(container, child)` | Remove from root | Root-level deletions |\n\n### moveBefore Feature Detection\n\nReact detects and uses the `moveBefore` DOM API when available for more efficient repositioning:\n\n```mermaid\ngraph TB\n    AppendChild["appendChild(parentInstance, child)"]\n    \n    CheckMoveBefore{"supportsMoveBefore &&<br/>child.parentNode !== null"}\n    \n    AppendChild --> CheckMoveBefore\n    CheckMoveBefore -->|"true"| UseMoveBefore["parentInstance.moveBefore(child, null)"]\n    CheckMoveBefore -->|"false"| UseAppend["parentInstance.appendChild(child)"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:944-960]()\n\n### Commit Operations\n\n```mermaid\ngraph TB\n    CommitMount["commitMount(element, type, props, fiber)"]\n    CommitUpdate["commitUpdate(element, type, oldProps, newProps, fiber)"]\n    CommitTextUpdate["commitTextUpdate(textInstance, oldText, newText)"]\n    \n    CommitMount --> CheckAutoFocus{"type matches form element<br/>& autoFocus?"}\n    CheckAutoFocus -->|"yes"| Focus["element.focus()"]\n    CheckAutoFocus -->|"img + src"| ReassignSrc["Reassign src/srcSet<br/>to trigger load event"]\n    \n    CommitUpdate --> UpdateProperties["updateProperties(element, type, oldProps, newProps)"]\n    UpdateProperties --> UpdateFiberProps["updateFiberProps(element, newProps)"]\n    \n    CommitTextUpdate --> SetNodeValue["textInstance.nodeValue = newText"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:813-872](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:917-942]()\n\n## Event System Integration\n\nReactFiberConfigDOM integrates with React\'s synthetic event system through several key functions.\n\n### Event Setup\n\n```mermaid\ngraph LR\n    PrepareForCommit["prepareForCommit(container)"]\n    PrepareForCommit --> DisableEvents["ReactBrowserEventEmitterSetEnabled(false)"]\n    DisableEvents --> SaveSelection["getSelectionInformation(container)"]\n    \n    ResetAfterCommit["resetAfterCommit(container)"]\n    ResetAfterCommit --> RestoreSelection["restoreSelection(selectionInfo, container)"]\n    RestoreSelection --> EnableEvents["ReactBrowserEventEmitterSetEnabled(true)"]\n    \n    PreparePortal["preparePortalMount(portalInstance)"]\n    PreparePortal --> ListenAll["listenToAllSupportedEvents(portalInstance)"]\n```\n\nThe event system is temporarily disabled during commits to prevent unwanted event dispatching while the DOM is being mutated.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:412-450](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:767-769]()\n\n### Priority and Event Tracking\n\n```mermaid\ngraph TB\n    TrackEvent["trackSchedulerEvent()"]\n    TrackEvent --> SaveEvent["schedulerEvent = window.event"]\n    \n    ResolveType["resolveEventType()"]\n    ResolveType --> CheckEvent{"event && event !== schedulerEvent?"}\n    CheckEvent -->|"yes"| ReturnType["Return event.type"]\n    CheckEvent -->|"no"| ReturnNull["Return null"]\n    \n    ResolveTimestamp["resolveEventTimeStamp()"]\n    ResolveTimestamp --> CheckEvent2{"event && event !== schedulerEvent?"}\n    CheckEvent2 -->|"yes"| ReturnTS["Return event.timeStamp"]\n    CheckEvent2 -->|"no"| ReturnDefault["Return -1.1"]\n```\n\nThese functions help the reconciler determine the priority and nature of the current event for scheduling purposes.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:734-747]()\n\n### Eager Transitions\n\n```mermaid\ngraph TB\n    ShouldAttempt["shouldAttemptEagerTransition()"]\n    CheckEventType{"event.type === \'popstate\'"}\n    \n    ShouldAttempt --> CheckEventType\n    CheckEventType -->|"no"| ReturnFalse["Return false"]\n    CheckEventType -->|"yes"| CheckCached{"event === currentPopstateTransitionEvent?"}\n    CheckCached -->|"yes"| ReturnFalse2["Return false<br/>(already attempted)"]\n    CheckCached -->|"no"| CacheAndReturn["currentPopstateTransitionEvent = event<br/>Return true"]\n```\n\nThis optimization attempts to render popstate transitions synchronously to avoid flicker during browser history navigation.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:709-732]()\n\n## Resource Management\n\nReactFiberConfigDOM implements special handling for "hoistable" resources - elements like stylesheets and scripts that should be singleton instances in the document head.\n\n### Hoistable Elements\n\nResources are marked as hoistable through the `markNodeAsHoistable` function, which sets an internal flag on the DOM node:\n\n```mermaid\ngraph LR\n    CreateHoistable["createHoistableInstance()"]\n    CreateHoistable --> CreateElement["createElement(type)"]\n    CreateElement --> SetProps["setInitialProperties()"]\n    SetProps --> MarkHoistable["markNodeAsHoistable(element)"]\n    \n    CheckHoistable["isMarkedHoistable(element)"]\n    CheckHoistable --> ReadFlag["Check internal flag"]\n    \n    GetResources["getResourcesFromRoot(root)"]\n    GetResources --> ReturnSet["Return Set of hoistable instances"]\n```\n\nThe hoisting mechanism ensures that:\n- Multiple identical `<link>` or `<script>` elements are deduplicated\n- Resources are moved to the document `<head>`\n- Resources persist across re-renders if they remain in the tree\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js:56-59](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:452-468]()\n\n### Resource Validation\n\nFor stylesheet links, React validates props to ensure correct resource semantics:\n\n```mermaid\ngraph TB\n    ValidateLink["validateLinkPropsForStyleResource(props)"]\n    \n    ValidateLink --> CheckRel{"props.rel === \'stylesheet\'?"}\n    CheckRel -->|"no"| Error1["Warn: link must have rel=\'stylesheet\'"]\n    \n    CheckRel -->|"yes"| CheckHref{"props.href present?"}\n    CheckHref -->|"no"| Error2["Warn: stylesheet link must have href"]\n    \n    CheckHref -->|"yes"| CheckOnLoad{"props.onLoad or props.onError?"}\n    CheckOnLoad -->|"yes"| Error3["Warn: stylesheet links in head<br/>cannot have onLoad/onError"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js:138]()\n\n## Special Element Handling\n\nSeveral element types require special treatment beyond standard property application.\n\n### Script Elements\n\nScript tags must be created in a way that prevents execution:\n\n```mermaid\ngraph LR\n    CreateScript["Creating \'script\' element"]\n    CreateDiv["Create temporary div"]\n    SetInnerHTML["div.innerHTML = \'<script></script>\'"]\n    ExtractScript["Extract script element"]\n    RemoveFromDiv["div.removeChild(firstChild)"]\n    Return["Return non-executing script element"]\n    \n    CreateScript --> CreateDiv --> SetInnerHTML --> ExtractScript --> RemoveFromDiv --> Return\n```\n\nThis ensures scripts don\'t execute during render, only during commit if explicitly mounted.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:523-542]()\n\n### Select Elements\n\nSelect elements handle `multiple` and `size` props specially:\n\n```mermaid\ngraph TB\n    CreateSelect["Creating \'select\' element"]\n    \n    CheckMultiple{"props.multiple?"}\n    CreateSelect --> CheckMultiple\n    \n    CheckMultiple -->|"true"| SetMultiple["element.multiple = true"]\n    CheckMultiple -->|"false"| CheckSize{"props.size?"}\n    \n    CheckSize -->|"yes"| SetSize["element.size = props.size<br/>(enables multi-select mode)"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:544-562]()\n\n### Form Controls (Input, Textarea, Select)\n\nForm controls have specialized prop handling:\n- `finalizeInitialChildren` returns `true` for inputs, selects, textareas to schedule `commitMount`\n- `commitMount` handles `autoFocus` by calling `element.focus()`\n- Dedicated modules handle controlled vs uncontrolled state: `ReactDOMInput`, `ReactDOMTextarea`, `ReactDOMSelect`\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:625-643](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:813-872]()\n\n### Image Elements\n\nImages receive special handling in `commitMount` to ensure `onLoad` events fire correctly:\n\n```mermaid\ngraph TB\n    CommitMountImg["commitMount for \'img\'"]\n    \n    CheckSrc{"props.src present?"}\n    CommitMountImg --> CheckSrc\n    \n    CheckSrc -->|"yes"| CheckObjectSrc{"src is object<br/>(Blob/MediaStream)?"}\n    CheckObjectSrc -->|"yes"| SetSrcObject["setSrcObject(element, type, src)"]\n    CheckObjectSrc -->|"no"| ReassignSrc["element.src = src<br/>(triggers new load)"]\n    \n    CheckSrc -->|"no"| CheckSrcSet{"props.srcSet present?"}\n    CheckSrcSet -->|"yes"| ReassignSrcSet["element.srcset = srcSet"]\n```\n\nThe reassignment ensures that even if the image has already loaded, the `onLoad` handler will be called again.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:838-869]()\n\n## Hydration Support\n\nReactFiberConfigDOM provides hydration functions to match server-rendered HTML with React\'s virtual DOM during client-side hydration. This is a large topic covered in detail in [Hydration System](#6.3).\n\nKey hydration functions exported:\n- `hydrateProperties(domElement, tag, props)` - Matches and validates props\n- `hydrateText(textInstance, text)` - Validates text content\n- `diffHydratedProperties(domElement, tag, props)` - Produces update payload for mismatches\n- `diffHydratedText(textInstance, text)` - Checks for text mismatches\n\nHydration also handles special cases:\n- Dehydrated Suspense boundaries (marked with comment nodes)\n- Form state markers for preserving form data across SSR\n- Input/textarea/select state synchronization via `hydrateInput`, `hydrateTextarea`, `hydrateSelect`\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:81-89](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:874-915]()\n\n## View Transitions and Scheduling\n\nReactFiberConfigDOM includes stubs and partial implementations for view transitions, which enable animated transitions between states. Full details are in [View Transitions and Gesture Scheduling](#6.4).\n\n### View Transition Lifecycle\n\nThe host config provides functions called by the reconciler during view transitions:\n\n| Function | Purpose |\n|----------|---------|\n| `measureInstance(instance)` | Capture instance measurements before transition |\n| `cloneRootViewTransitionContainer(root)` | Clone the root for "old" state capture |\n| `startViewTransition(...)` | Begin coordinating the transition animation |\n| `applyViewTransitionName(instance, name, className)` | Apply CSS view-transition-name |\n| `stopViewTransition(transition)` | End the transition |\n\n### Gesture Scheduling\n\nGesture timeline integration (for scrubbing through transitions) is also stubbed:\n\n```mermaid\ngraph LR\n    StartGesture["startGestureTransition(container, timeline, ...)"]\n    StartGesture --> MutationCB["mutationCallback()"]\n    MutationCB --> AnimateCB["animateCallback()"]\n    AnimateCB --> Return["Return null<br/>(no actual animation)"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1094-1358]()\n\n## Component Tree Mapping\n\nReactFiberConfigDOM maintains a mapping between DOM nodes and React fibers to support:\n- Event dispatching (finding the React instance for a DOM node)\n- React DevTools (inspecting the component tree)\n- Public instance access (refs)\n\n### Mapping Functions\n\n```mermaid\ngraph TB\n    subgraph "Fiber to DOM"\n        PrecacheFiber["precacheFiberNode(fiber, domNode)"]\n        PrecacheFiber --> StoreOnNode["domNode[internalInstanceKey] = fiber"]\n    end\n    \n    subgraph "DOM to Fiber"\n        GetInstance["getInstanceFromNode(domNode)"]\n        GetInstance --> ReadKey["return domNode[internalInstanceKey]"]\n    end\n    \n    subgraph "Props Storage"\n        UpdateFiberProps["updateFiberProps(domNode, props)"]\n        UpdateFiberProps --> StoreProps["domNode[internalPropsKey] = props"]\n        \n        GetFiberProps["getFiberCurrentPropsFromNode(domNode)"]\n        GetFiberProps --> ReadProps["return domNode[internalPropsKey]"]\n    end\n```\n\nThese mappings are established during instance creation and used throughout the lifecycle for event handling and introspection.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js:47-60]()\n\n## Summary\n\nReactFiberConfigDOM serves as the critical bridge between React\'s platform-agnostic reconciler and the browser DOM. It:\n\n- **Creates DOM instances** with proper namespacing (HTML, SVG, MathML)\n- **Manages properties** by translating React props to DOM attributes/properties\n- **Performs mutations** efficiently using native DOM APIs (with `moveBefore` optimization)\n- **Integrates events** by coordinating with React\'s synthetic event system\n- **Handles resources** through hoisting mechanisms for stylesheets and scripts\n- **Supports hydration** by matching server-rendered HTML with the React tree\n- **Enables view transitions** for animated state changes (experimental)\n\nThe implementation is mutation-based (unlike React Native\'s persistence mode) and optimized for the browser environment, with special handling for form controls, scripts, images, and other HTML-specific elements.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-1500]()\n\n---\n\n# Page: React Native Renderers\n\n# React Native Renderers\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React Native\'s renderer implementations, which enable React to target native mobile platforms (iOS and Android). React Native provides two distinct renderers: **Fabric** (the new architecture using persistence mode) and **Legacy/Paper** (the old architecture using mutation mode). Both implement the host config interface defined by the reconciler to bridge React\'s virtual representation with platform-specific native UI components.\n\nFor information about the general host configuration abstraction, see [Host Configuration Abstraction](#4.6). For React DOM\'s implementation, see [React DOM Implementation](#6.1).\n\n---\n\n## Host Config Interface\n\nReact Native renderers implement the same host config interface as other renderers, providing platform-specific implementations of instance creation, updates, and tree manipulation. The reconciler calls these methods to perform platform operations without knowing the underlying implementation details.\n\n### Core Type Definitions\n\nBoth renderers define these fundamental types:\n\n| Type | Fabric | Legacy |\n|------|--------|--------|\n| `Type` | `string` (component type) | `string` (component type) |\n| `Instance` | Object with `node` and `canonical` | `ReactNativeFiberHostComponent` |\n| `TextInstance` | Object with `node` | `number` (native tag) |\n| `Container` | `{containerTag, publicInstance}` | `{containerTag, publicInstance}` |\n| `Props` | `Object` | `Object` |\n| `HostContext` | `{isInAParentText: boolean}` | `{isInAParentText: boolean}` |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:93-134](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:59-73]()\n\n---\n\n## Fabric Renderer (New Architecture)\n\n### Architecture Overview\n\n```mermaid\ngraph TB\n    Reconciler["React Reconciler"]\n    FabricConfig["ReactFiberConfigFabric"]\n    FabricUIManager["nativeFabricUIManager"]\n    ShadowTree["C++ Shadow Tree"]\n    NativeUI["Native UI Components"]\n    \n    Reconciler -->|"Host config calls"| FabricConfig\n    FabricConfig -->|"createNode()<br/>cloneNode()<br/>appendChild()"| FabricUIManager\n    FabricUIManager -->|"Synchronous updates"| ShadowTree\n    ShadowTree -->|"commitRoot()"| NativeUI\n    \n    subgraph "JavaScript Layer"\n        Reconciler\n        FabricConfig\n    end\n    \n    subgraph "Native Bridge"\n        FabricUIManager\n    end\n    \n    subgraph "Native Layer"\n        ShadowTree\n        NativeUI\n    end\n```\n\nFabric Renderer Architecture\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:31-60]()\n\n### Instance Structure\n\nFabric uses a **canonical instance pattern** where all clones of an instance share a common data structure:\n\n```mermaid\ngraph LR\n    Instance1["Instance (clone 1)"]\n    Instance2["Instance (clone 2)"]\n    Instance3["Instance (clone 3)"]\n    Canonical["Canonical Object"]\n    Node1["Shadow Node 1"]\n    Node2["Shadow Node 2"]\n    Node3["Shadow Node 3"]\n    \n    Instance1 -->|"node"| Node1\n    Instance2 -->|"node"| Node2\n    Instance3 -->|"node"| Node3\n    \n    Instance1 -->|"canonical"| Canonical\n    Instance2 -->|"canonical"| Canonical\n    Instance3 -->|"canonical"| Canonical\n    \n    Canonical -->|"nativeTag"| Tag["Unique Tag"]\n    Canonical -->|"viewConfig"| ViewConfig["View Configuration"]\n    Canonical -->|"currentProps"| Props["Current Props"]\n    Canonical -->|"internalInstanceHandle"| Fiber["Fiber Reference"]\n    Canonical -->|"publicInstance"| Public["Public Instance (lazy)"]\n```\n\nFabric Instance Canonical Pattern\n\nThe canonical object contains:\n- `nativeTag`: Unique identifier (even numbers starting from 2)\n- `viewConfig`: Native component configuration from registry\n- `currentProps`: Current props for event handling\n- `internalInstanceHandle`: Reference to the Fiber\n- `publicInstance`: Lazily created public instance for refs\n- `publicRootInstance`: Root instance (nulled after public instance creation)\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:95-113]()\n\n### Tag Allocation\n\nFabric tags follow a specific pattern:\n- Start at `2` and increment by `2` for each new instance\n- `tag % 10 === 1` means it\'s a root tag\n- `tag % 2 === 0` means it\'s a Fabric tag\n- This ensures Fabric tags never overlap with Legacy tags\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:86-89]()\n\n### Persistence Mode Operations\n\nFabric uses **persistence mode** (`supportsPersistence = true`), meaning it creates new shadow node instances rather than mutating existing ones:\n\n| Operation | Implementation |\n|-----------|----------------|\n| `createInstance` | `createNode(tag, viewName, rootTag, props, handle)` |\n| `cloneInstance` | `cloneNodeWithNewProps()` or `cloneNodeWithNewChildren()` |\n| `appendInitialChild` | `appendChildNode(parent.node, child.node)` |\n| `createContainerChildSet` | Returns `[]` (array mode) |\n| `appendChildToContainerChildSet` | `childSet.push(child.node)` |\n| `finalizeContainerChildren` | No-op (children replaced in next step) |\n| `replaceContainerChildren` | `completeRoot(containerTag, newChildren)` |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:449-561]()\n\n### Native UI Manager Integration\n\nFabric communicates with the native layer through `nativeFabricUIManager`:\n\n```mermaid\ngraph TB\n    createNode["createNode(tag, viewName, rootTag, props, handle)"]\n    cloneNode["cloneNodeWithNewProps(node, props)"]\n    appendChild["appendChildNode(parent, child)"]\n    completeRoot["completeRoot(containerTag, children)"]\n    registerEventHandler["registerEventHandler(dispatchEvent)"]\n    \n    createNode -->|"Returns"| ShadowNode["Shadow Node"]\n    cloneNode -->|"Returns"| ClonedNode["Cloned Shadow Node"]\n    appendChild -->|"Mutates"| ParentNode["Parent Shadow Tree"]\n    completeRoot -->|"Commits"| NativeUI["Native UI Tree"]\n    registerEventHandler -->|"Sets"| EventBridge["Event Bridge"]\n```\n\nFabric UI Manager API\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:45-60]()\n\n---\n\n## Legacy Renderer (Old Architecture/Paper)\n\n### Architecture Overview\n\n```mermaid\ngraph TB\n    Reconciler["React Reconciler"]\n    LegacyConfig["ReactFiberConfigNative"]\n    UIManager["UIManager"]\n    NativeBridge["Native Bridge (async)"]\n    NativeUI["Native UI Components"]\n    \n    Reconciler -->|"Host config calls"| LegacyConfig\n    LegacyConfig -->|"createView()<br/>updateView()<br/>manageChildren()"| UIManager\n    UIManager -->|"JSON over bridge"| NativeBridge\n    NativeBridge -->|"Async updates"| NativeUI\n    \n    subgraph "JavaScript Layer"\n        Reconciler\n        LegacyConfig\n        UIManager\n    end\n    \n    subgraph "Native Layer"\n        NativeBridge\n        NativeUI\n    end\n```\n\nLegacy Renderer Architecture\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:14-20]()\n\n### Instance Structure\n\nLegacy renderer uses `ReactNativeFiberHostComponent` as instances, which are simpler objects with:\n- `_nativeTag`: The native view tag\n- `_children`: Array of child instances\n- `viewConfig`: View configuration\n- Internal methods for event handling\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:29](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:157-169]()\n\n### Tag Allocation\n\nLegacy tags use a different allocation strategy:\n- Start at `3` and increment by `2`\n- Skip tags where `tag % 10 === 1` (reserved for root tags)\n- Skip tags where `tag % 2 === 0` (reserved for Fabric tags)\n\n```javascript\nfunction allocateTag() {\n  let tag = nextReactTag;\n  if (tag % 10 === 1) {\n    tag += 2;\n  }\n  nextReactTag = tag + 2;\n  return tag;\n}\n```\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:94-102]()\n\n### Mutation Mode Operations\n\nLegacy uses **mutation mode** (`supportsMutation = true`), directly mutating the native view hierarchy:\n\n| Operation | Implementation |\n|-----------|----------------|\n| `createInstance` | `UIManager.createView(tag, viewName, rootTag, props)` |\n| `commitUpdate` | `UIManager.updateView(tag, viewName, updatePayload)` |\n| `appendChild` | `UIManager.manageChildren(parent, moveFrom, moveTo, add, addAt, remove)` |\n| `insertBefore` | `UIManager.manageChildren()` with calculated indices |\n| `removeChild` | `UIManager.manageChildren()` with removeAtIndices |\n| `commitTextUpdate` | `UIManager.updateView(tag, \'RCTRawText\', {text})` |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:377-541]()\n\n### UIManager Integration\n\nThe Legacy renderer uses the `UIManager` module to communicate with native:\n\n```mermaid\ngraph LR\n    createView["UIManager.createView(tag, viewName, rootTag, props)"]\n    updateView["UIManager.updateView(tag, viewName, props)"]\n    manageChildren["UIManager.manageChildren(parent, moveFrom, moveTo, add, addAt, remove)"]\n    setChildren["UIManager.setChildren(parent, children)"]\n    \n    createView -->|"Async"| NativeQueue["Native Command Queue"]\n    updateView -->|"Async"| NativeQueue\n    manageChildren -->|"Async"| NativeQueue\n    setChildren -->|"Async"| NativeQueue\n    \n    NativeQueue -->|"Batched"| NativeUI["Native UI Thread"]\n```\n\nLegacy UIManager API\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:150-155](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:392-410]()\n\n---\n\n## Key Differences Between Fabric and Legacy\n\n### Comparison Table\n\n| Aspect | Fabric | Legacy |\n|--------|--------|--------|\n| **Mode** | Persistence | Mutation |\n| **Instance Type** | `{node, canonical}` | `ReactNativeFiberHostComponent` |\n| **Text Instance** | `{node, publicInstance?}` | `number` (tag only) |\n| **Tag Pattern** | Even numbers (2, 4, 6...) | Odd numbers (3, 5, 7...) skipping multiples of 10 |\n| **Native API** | `nativeFabricUIManager` (synchronous) | `UIManager` (asynchronous) |\n| **Cloning** | `cloneNodeWithNewProps/Children()` | Not supported |\n| **Child Updates** | Replace entire child set | `manageChildren()` with indices |\n| **Event Registration** | `registerEventHandler(dispatchEvent)` | Implicit via `UIManager` |\n| **Public Instance** | Lazily created via `createPublicInstance` | Instance itself (or Fabric compat) |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:449](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:377]()\n\n### Architectural Comparison Diagram\n\n```mermaid\ngraph TB\n    subgraph "Fabric (New)"\n        FabricReact["React Tree"]\n        FabricClone["Clone Operations<br/>(persistence)"]\n        FabricShadow["Shadow Tree<br/>(synchronous)"]\n        FabricCommit["completeRoot()"]\n        FabricNative["Native UI"]\n        \n        FabricReact --> FabricClone\n        FabricClone --> FabricShadow\n        FabricShadow --> FabricCommit\n        FabricCommit --> FabricNative\n    end\n    \n    subgraph "Legacy (Old)"\n        LegacyReact["React Tree"]\n        LegacyMutate["Mutation Operations"]\n        LegacyQueue["Command Queue<br/>(asynchronous)"]\n        LegacyNative["Native UI"]\n        \n        LegacyReact --> LegacyMutate\n        LegacyMutate --> LegacyQueue\n        LegacyQueue --> LegacyNative\n    end\n```\n\nFabric vs Legacy Architecture\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-8](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:1-8]()\n\n---\n\n## Instance Management and Public Instances\n\n### Public Instance Creation\n\nBoth renderers expose instances to user code via refs, but they handle this differently:\n\n**Fabric:**\n- Public instances are created lazily via `createPublicInstance(tag, viewConfig, handle, rootInstance)`\n- Stored in the `canonical.publicInstance` field\n- All clones share the same public instance through the canonical object\n- `getPublicInstance()` creates on first access\n\n**Legacy:**\n- The instance itself serves as the public instance\n- Simpler model without lazy initialization\n- Compatibility layer exists for Fabric instances in mixed environments\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:293-325](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:289-315]()\n\n### Host Context Management\n\nBoth renderers track whether the current tree position is inside a text component:\n\n```mermaid\ngraph TD\n    Root["Root Context<br/>{isInAParentText: false}"]\n    View["<View><br/>isInAParentText: false"]\n    Text["<Text><br/>isInAParentText: true"]\n    TextInput["<TextInput><br/>isInAParentText: true"]\n    String["Text String<br/>(must be in text)"]\n    \n    Root --> View\n    View --> Text\n    Text --> String\n    View --> TextInput\n    \n    Text -.->|"Sets true"| String\n    TextInput -.->|"Sets true"| String\n```\n\nHost Context Propagation\n\nThe context prevents raw text strings from appearing outside text components. In DEV mode, this triggers a warning.\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:259-291](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:264-287]()\n\n---\n\n## Fragment Refs Support\n\nFabric includes support for fragment instance handles, enabling refs to fragments. The `FragmentInstance` class implements DOM-like APIs for native components:\n\n### FragmentInstance Implementation\n\n```mermaid\nclassDiagram\n    class FragmentInstance {\n        -Fiber _fragmentFiber\n        -Set~IntersectionObserver~ _observers\n        +observeUsing(observer)\n        +unobserveUsing(observer)\n        +compareDocumentPosition(otherNode)\n        +getRootNode(options)\n        +getClientRects()\n    }\n    \n    class IntersectionObserver {\n        +observe(target)\n        +unobserve(target)\n    }\n    \n    FragmentInstance --> IntersectionObserver : manages\n    FragmentInstance --> Fiber : references\n```\n\nFragmentInstance Class Structure\n\n### Key Methods\n\n| Method | Purpose | Implementation |\n|--------|---------|----------------|\n| `observeUsing()` | Attach IntersectionObserver | Traverses fragment, calls `observer.observe()` on each child |\n| `unobserveUsing()` | Detach IntersectionObserver | Traverses fragment, calls `observer.unobserve()` on each child |\n| `compareDocumentPosition()` | Compare positions | Uses first/last child positions with special empty fragment handling |\n| `getRootNode()` | Get root container | Delegates to parent host fiber\'s `getRootNode()` |\n| `getClientRects()` | Get bounding rects | Collects `getBoundingClientRect()` from all children |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:646-799]()\n\n### Fragment Traversal\n\nFragment instances use `traverseFragmentInstance()` from the reconciler to walk the fragment\'s children:\n\n```mermaid\ngraph TB\n    FragmentFiber["Fragment Fiber"]\n    Child1["Host Component 1"]\n    Child2["Host Component 2"]\n    Child3["Nested Fragment"]\n    Child3a["Host Component 3a"]\n    Child3b["Host Component 3b"]\n    \n    FragmentFiber --> Child1\n    FragmentFiber --> Child2\n    FragmentFiber --> Child3\n    Child3 --> Child3a\n    Child3 --> Child3b\n    \n    Traverse["traverseFragmentInstance(fiber, callback, data)"]\n    Traverse -.->|"Visits"| Child1\n    Traverse -.->|"Visits"| Child2\n    Traverse -.->|"Recursively visits"| Child3a\n    Traverse -.->|"Recursively visits"| Child3b\n```\n\nFragment Traversal Pattern\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:27-29](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:672-678]()\n\n---\n\n## Props and Attribute Handling\n\n### Attribute Payload Creation\n\nBoth renderers use the React Native view configuration registry to validate and transform props:\n\n```mermaid\ngraph LR\n    Props["Component Props"]\n    ViewConfig["View Config<br/>(from registry)"]\n    ValidAttributes["validAttributes"]\n    \n    Props --> CreatePayload["createAttributePayload()"]\n    ViewConfig --> CreatePayload\n    ValidAttributes --> CreatePayload\n    \n    CreatePayload --> Payload["Native Attribute Payload"]\n    \n    Payload --> FabricCreate["Fabric: createNode()"]\n    Payload --> LegacyCreate["Legacy: UIManager.createView()"]\n```\n\nAttribute Payload Flow\n\n**Fabric:**\n```javascript\nconst updatePayload = createAttributePayload(\n  props,\n  viewConfig.validAttributes,\n);\nconst node = createNode(tag, viewConfig.uiViewClassName, rootTag, updatePayload, handle);\n```\n\n**Legacy:**\n```javascript\nconst updatePayload = create(props, viewConfig.validAttributes);\nUIManager.createView(tag, viewConfig.uiViewClassName, rootTag, updatePayload);\n```\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:196-207](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:148-155]()\n\n### Update Payload Diffing\n\nWhen props change, both renderers compute a diff to minimize native updates:\n\n**Fabric:**\n```javascript\nconst updatePayload = diffAttributePayloads(\n  oldProps,\n  newProps,\n  viewConfig.validAttributes,\n);\n// Updates canonical.currentProps for events\ninstance.canonical.currentProps = newProps;\n```\n\n**Legacy:**\n```javascript\nconst updatePayload = diff(oldProps, newProps, viewConfig.validAttributes);\nif (updatePayload != null) {\n  UIManager.updateView(tag, viewConfig.uiViewClassName, updatePayload);\n}\n```\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:460-468](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:452-467]()\n\n---\n\n## Event Priority Integration\n\nBoth renderers integrate with the React event priority system to map native events to React priorities:\n\n### Priority Resolution\n\n```mermaid\ngraph TD\n    GetPriority["resolveUpdatePriority()"]\n    CurrentPriority["currentUpdatePriority<br/>(from setState, etc)"]\n    FabricPriority["fabricGetCurrentEventPriority()<br/>(from native)"]\n    \n    GetPriority --> CheckCurrent{{"currentUpdatePriority<br/>!== NoEventPriority?"}}\n    CheckCurrent -->|Yes| CurrentPriority\n    CheckCurrent -->|No| FabricPriority\n    \n    FabricPriority --> MapPriority["Map to React Priority"]\n    MapPriority --> Discrete["DiscreteEventPriority<br/>(clicks, inputs)"]\n    MapPriority --> Continuous["ContinuousEventPriority<br/>(scrolls, drags)"]\n    MapPriority --> Idle["IdleEventPriority"]\n    MapPriority --> Default["DefaultEventPriority"]\n```\n\nEvent Priority Resolution (Fabric)\n\n**Fabric Priority Mapping:**\n| Fabric Priority | React Priority |\n|----------------|----------------|\n| `FabricDiscretePriority` | `DiscreteEventPriority` |\n| `FabricContinuousPriority` | `ContinuousEventPriority` |\n| `FabricIdlePriority` | `IdleEventPriority` |\n| `FabricDefaultPriority` | `DefaultEventPriority` |\n\n**Legacy:** Always returns `DefaultEventPriority` (no native priority integration).\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:395-419](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:352-357]()\n\n---\n\n## Summary\n\nReact Native provides two renderer implementations that bridge React\'s platform-agnostic reconciler to native mobile UI:\n\n1. **Fabric** (new architecture): Uses persistence mode with synchronous shadow tree operations, enabling better performance and simpler concurrency support\n2. **Legacy/Paper** (old architecture): Uses mutation mode with asynchronous command batching via the bridge\n\nBoth implement the same host config interface but with fundamentally different operational models. Fabric\'s persistence approach aligns better with React\'s concurrent rendering model, while Legacy maintains backward compatibility with existing React Native applications.\n\nThe key architectural components are:\n- **Tag allocation** strategies ensuring Fabric and Legacy tags don\'t conflict\n- **Instance management** patterns (canonical sharing vs direct instances)\n- **Native bridge integration** (synchronous vs asynchronous)\n- **Public instance creation** for refs\n- **Fragment refs support** (Fabric only)\n- **Attribute payload** creation and diffing\n- **Event priority** mapping (enhanced in Fabric)\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-838](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:1-751]()\n\n---\n\n# Page: Hydration System\n\n# Hydration System\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js](packages/react-dom-bindings/src/client/ReactDOMComponentTree.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js)\n- [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js](packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js](packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFloat-test.js](packages/react-dom/src/__tests__/ReactDOMFloat-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js](packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js](packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js)\n- [packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js](packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js)\n- [packages/react-dom/src/__tests__/ReactRenderDocument-test.js](packages/react-dom/src/__tests__/ReactRenderDocument-test.js)\n- [packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js](packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js](packages/react-dom/src/server/ReactDOMFizzServerBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBun.js](packages/react-dom/src/server/ReactDOMFizzServerBun.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerEdge.js](packages/react-dom/src/server/ReactDOMFizzServerEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerNode.js](packages/react-dom/src/server/ReactDOMFizzServerNode.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js](packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticEdge.js](packages/react-dom/src/server/ReactDOMFizzStaticEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticNode.js](packages/react-dom/src/server/ReactDOMFizzStaticNode.js)\n- [packages/react-markup/src/ReactFizzConfigMarkup.js](packages/react-markup/src/ReactFizzConfigMarkup.js)\n- [packages/react-noop-renderer/src/ReactNoopServer.js](packages/react-noop-renderer/src/ReactNoopServer.js)\n- [packages/react-reconciler/src/ReactFiberHydrationContext.js](packages/react-reconciler/src/ReactFiberHydrationContext.js)\n- [packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js](packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js)\n- [packages/react-server/src/ReactFizzServer.js](packages/react-server/src/ReactFizzServer.js)\n- [packages/react-server/src/forks/ReactFizzConfig.custom.js](packages/react-server/src/forks/ReactFizzConfig.custom.js)\n\n</details>\n\n\n\nThis document describes React\'s hydration system, which attaches React to server-rendered HTML, transforming static markup into an interactive application. Hydration reuses existing DOM nodes rather than creating new ones, validating that the server and client render the same content.\n\nFor server-side rendering fundamentals, see [React Fizz (Streaming SSR)](#5.1). For broader React DOM rendering concepts, see [React DOM](#4.1). For the underlying reconciliation mechanics, see [Fiber Architecture and Work Loop](#3.1).\n</thinking>\n\n## Hydration Overview\n\nHydration is the process of attaching React\'s event listeners and internal state to server-rendered HTML. Instead of creating new DOM nodes, React walks the existing DOM tree, attaching Fiber nodes to existing elements and validating that the client render matches the server render.\n\n```mermaid\ngraph TD\n    SSR["Server-Rendered HTML<br/>(ReactDOMFizzServer)"]\n    Container["DOM Container"]\n    HydrateRoot["ReactDOMClient.hydrateRoot()"]\n    HydrationContext["ReactFiberHydrationContext"]\n    FiberTree["Fiber Tree"]\n    AttachedDOM["Attached DOM with Event Listeners"]\n    \n    SSR --> Container\n    Container --> HydrateRoot\n    HydrateRoot --> HydrationContext\n    HydrationContext --> FiberTree\n    FiberTree --> AttachedDOM\n```\n\n**Hydration Flow**\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-1500](), [packages/react-reconciler/src/ReactFiberHydrationContext.js:1-100]()\n\n## Hydration Context State\n\nReact maintains hydration state in `ReactFiberHydrationContext`, tracking the current position in the DOM tree and whether hydration is in progress.\n\n| State Variable | Type | Purpose |\n|---------------|------|---------|\n| `hydrationParentFiber` | `Fiber | null` | Current fiber being hydrated |\n| `nextHydratableInstance` | `HydratableInstance | null` | Next DOM node to hydrate |\n| `isHydrating` | `boolean` | Whether currently hydrating |\n| `didSuspendOrErrorDEV` | `boolean` | Suppress warnings after errors |\n| `hydrationDiffRootDEV` | `HydrationDiffNode | null` | Tracked diffs for error reporting |\n| `hydrationErrors` | `Array<CapturedValue> | null` | Collected hydration errors |\n\n```mermaid\ngraph TD\n    BeginWork["beginWork()"]\n    TryToClaimNextHydratableInstance["tryToClaimNextHydratableInstance()"]\n    NextHydratableInstance["nextHydratableInstance"]\n    CanHydrate["canHydrateInstance()"]\n    PopHydrationState["popHydrationState()"]\n    \n    BeginWork --> TryToClaimNextHydratableInstance\n    TryToClaimNextHydratableInstance --> NextHydratableInstance\n    NextHydratableInstance --> CanHydrate\n    CanHydrate -->|"match"| AttachFiber["Attach Fiber to DOM node"]\n    CanHydrate -->|"mismatch"| RecordMismatch["deleteHydratableInstance()"]\n    BeginWork --> PopHydrationState\n```\n\n**Hydration State Management**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:78-95](), [packages/react-reconciler/src/ReactFiberHydrationContext.js:135-200]()\n\n## Hydration Process\n\nDuring hydration, React walks the Fiber tree and the DOM tree in parallel, attempting to match each Fiber to an existing DOM node.\n\n### Host Component Hydration\n\nFor host components (DOM elements), React validates the tag name and props, attaching the existing DOM node to the Fiber.\n\n```mermaid\nsequenceDiagram\n    participant Reconciler\n    participant HydrationContext\n    participant HostConfig\n    participant DOM\n    \n    Reconciler->>HydrationContext: tryToClaimNextHydratableInstance()\n    HydrationContext->>DOM: Get nextHydratableInstance\n    HydrationContext->>HostConfig: canHydrateInstance(type, instance)\n    HostConfig-->>HydrationContext: true/false\n    alt Can Hydrate\n        HydrationContext->>HostConfig: hydrateInstance(instance, type, props)\n        HostConfig->>DOM: Validate props\n        HostConfig-->>HydrationContext: updatePayload | null\n        HydrationContext->>Reconciler: Attach instance to fiber\n    else Cannot Hydrate\n        HydrationContext->>HydrationContext: deleteHydratableInstance()\n        HydrationContext->>Reconciler: Create new instance\n    end\n```\n\n**Host Component Hydration Sequence**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:400-500](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1200-1350]()\n\n### Text Node Hydration\n\nText nodes are compared directly. If the text content differs, React logs a warning but uses the existing node.\n\n```mermaid\ngraph TD\n    TryHydrateText["tryToClaimNextHydratableInstance()<br/>(text)"]\n    CanHydrateText["canHydrateTextInstance()"]\n    HydrateText["hydrateTextInstance()"]\n    DiffText["diffHydratedTextForDevWarnings()"]\n    \n    TryHydrateText --> CanHydrateText\n    CanHydrateText -->|"is text node"| HydrateText\n    CanHydrateText -->|"wrong type"| DeleteAndCreate["Delete + Create new"]\n    HydrateText --> DiffText\n    DiffText -->|"DEV only"| LogWarning["Log mismatch warning"]\n```\n\n**Text Node Hydration**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:500-550](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1350-1400]()\n\n## Mismatch Detection and Recovery\n\nWhen React detects a mismatch between server-rendered HTML and client render, it attempts recovery by deleting the mismatched server node and creating the correct client node.\n\n### Mismatch Types\n\n| Mismatch Type | Detection Method | Recovery Strategy |\n|--------------|------------------|-------------------|\n| Tag name mismatch | `canHydrateInstance()` returns false | Delete server node, insert client node |\n| Text mismatch | `diffHydratedText()` compares strings | Use server text, log warning |\n| Missing children | No DOM node for Fiber child | Insert client-rendered child |\n| Extra DOM nodes | DOM nodes without Fiber | Delete extra nodes |\n| Prop mismatch | `diffHydratedProperties()` | Apply client props, log warning |\n\n```mermaid\ngraph TD\n    BeginHydration["Begin Hydration"]\n    TryClaim["tryToClaimNextHydratableInstance()"]\n    Validate["Validate node type and props"]\n    \n    Match["Match Found"]\n    Mismatch["Mismatch Detected"]\n    \n    DeleteServer["deleteHydratableInstance()"]\n    InsertClient["insertNonHydratedInstance()"]\n    LogError["queueHydrationError()"]\n    \n    BeginHydration --> TryClaim\n    TryClaim --> Validate\n    Validate --> Match\n    Validate --> Mismatch\n    \n    Mismatch --> DeleteServer\n    Mismatch --> InsertClient\n    Mismatch --> LogError\n    \n    Match --> ContinueHydration["Continue Hydration"]\n```\n\n**Mismatch Recovery Flow**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:300-400](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1400-1500]()\n\n### Hydration Diff Tracking (DEV)\n\nIn development, React builds a tree of hydration differences to provide detailed error messages with component stacks.\n\n```mermaid\ngraph TD\n    DetectMismatch["Detect Mismatch"]\n    BuildDiffNode["buildHydrationDiffNode()"]\n    RecordDiff["Record in hydrationDiffRootDEV"]\n    ThrowError["throwOnHydrationMismatch()"]\n    DescribeDiff["describeDiff()"]\n    ErrorWithStack["Error with Component Stack"]\n    \n    DetectMismatch --> BuildDiffNode\n    BuildDiffNode --> RecordDiff\n    RecordDiff --> ThrowError\n    ThrowError --> DescribeDiff\n    DescribeDiff --> ErrorWithStack\n```\n\n**Hydration Diff Reporting**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:96-135](), [packages/react-reconciler/src/ReactFiberHydrationDiffs.js:1-200]()\n\n## Dehydrated Suspense Boundaries\n\nWhen React Fizz server renders a Suspense boundary that suspended, it emits special HTML comment markers to indicate dehydrated content. These markers allow the client to skip hydrating the fallback and wait for the real content.\n\n### Suspense Boundary Markers\n\nReact uses specific comment node data to mark Suspense boundaries in SSR output:\n\n| Marker | Data Attribute | Purpose |\n|--------|---------------|---------|\n| Pending Start | `$?` | Suspense that hasn\'t resolved yet |\n| Fallback Start | `$!` | Suspense showing fallback |\n| Complete Start | `$` | Completed Suspense |\n| End | `/$` | End of Suspense boundary |\n\n```mermaid\ngraph TD\n    ServerRender["Server Render<br/>(ReactFizzServer)"]\n    SuspensePending["Component Suspends"]\n    EmitMarker["Emit <!--$?--> marker"]\n    StreamFallback["Stream fallback HTML"]\n    \n    ClientHydrate["Client Hydration"]\n    FindMarker["Find dehydrated boundary"]\n    SkipFallback["Skip hydrating fallback"]\n    WaitForContent["Wait for streamed content"]\n    HydrateContent["Hydrate real content"]\n    \n    ServerRender --> SuspensePending\n    SuspensePending --> EmitMarker\n    EmitMarker --> StreamFallback\n    \n    ClientHydrate --> FindMarker\n    FindMarker --> SkipFallback\n    SkipFallback --> WaitForContent\n    WaitForContent --> HydrateContent\n```\n\n**Dehydrated Suspense Boundary Flow**\n\nSources: [packages/react-server/src/ReactFizzServer.js:262-274](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:262-274]()\n\n### Suspense Instance Recognition\n\nThe client recognizes dehydrated Suspense boundaries by checking comment node data attributes.\n\n```mermaid\ngraph TD\n    GetNextSibling["getNextHydratableSibling()"]\n    CheckComment["Check if Comment node"]\n    CheckData["Check node.data"]\n    \n    SuspenseStart["SUSPENSE_*_DATA"]\n    ActivityStart["ACTIVITY_*_DATA"]\n    RegularComment["Regular comment"]\n    \n    GetNextSibling --> CheckComment\n    CheckComment --> CheckData\n    CheckData --> SuspenseStart\n    CheckData --> ActivityStart\n    CheckData --> RegularComment\n    \n    SuspenseStart --> CreateDehydratedFragment["createFiberFromDehydratedFragment()"]\n    ActivityStart --> HandleActivity["Handle Activity boundary"]\n    RegularComment --> SkipNode["Skip to next sibling"]\n```\n\n**Suspense Instance Recognition**\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1120-1180](), [packages/react-reconciler/src/ReactFiberHydrationContext.js:550-650]()\n\n### Hydrating Dehydrated Boundaries\n\nWhen React encounters a dehydrated Suspense boundary, it creates a `DehydratedFragment` fiber and skips the initial content, waiting for the server stream to complete.\n\n```mermaid\nsequenceDiagram\n    participant Reconciler\n    participant HydrationContext\n    participant FiberTree\n    participant SuspenseComponent\n    \n    Reconciler->>HydrationContext: tryToClaimNextHydratableInstance()\n    HydrationContext->>HydrationContext: Check for suspense marker\n    HydrationContext->>FiberTree: createFiberFromDehydratedFragment()\n    FiberTree->>SuspenseComponent: Mount with dehydrated state\n    SuspenseComponent->>SuspenseComponent: Register _reactRetry callback\n    \n    Note over SuspenseComponent: Wait for server completion\n    \n    SuspenseComponent->>SuspenseComponent: Receive completion signal\n    SuspenseComponent->>HydrationContext: Hydrate real content\n    HydrationContext->>FiberTree: Replace dehydrated fiber\n```\n\n**Dehydrated Fragment Hydration**\n\nSources: [packages/react-reconciler/src/ReactFiber.js:800-850](), [packages/react-reconciler/src/ReactFiberHydrationContext.js:700-800]()\n\n## Selective Hydration\n\nSelective hydration allows React to prioritize hydrating Suspense boundaries based on user interactions, improving perceived performance.\n\n### Priority-Based Hydration\n\nWhen a user interacts with a dehydrated boundary, React immediately schedules that boundary for hydration at a higher priority.\n\n| Interaction Type | Priority | Scheduling |\n|-----------------|----------|-----------|\n| Click, focus, submit | Discrete | Sync hydration |\n| Hover, scroll | Continuous | High priority |\n| No interaction | Default | Normal priority |\n\n```mermaid\ngraph TD\n    UserClick["User clicks dehydrated area"]\n    FindTarget["findInstanceBlockingEvent()"]\n    CheckHydrated["Check if target hydrated"]\n    \n    IsDehydrated["Target is dehydrated"]\n    ScheduleHydration["attemptDiscreteHydration()"]\n    QueueEvent["queueDiscreteEvent()"]\n    \n    CompleteHydration["Hydration completes"]\n    ReplayEvent["replayUnblockedEvents()"]\n    DispatchToHandler["Dispatch to event handler"]\n    \n    UserClick --> FindTarget\n    FindTarget --> CheckHydrated\n    CheckHydrated --> IsDehydrated\n    IsDehydrated --> ScheduleHydration\n    IsDehydrated --> QueueEvent\n    ScheduleHydration --> CompleteHydration\n    CompleteHydration --> ReplayEvent\n    ReplayEvent --> DispatchToHandler\n```\n\n**Selective Hydration with Event Replay**\n\nSources: [packages/react-dom-bindings/src/events/ReactDOMEventReplaying.js:1-300](), [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js:146-200]()\n\n### Event Queueing and Replay\n\nEvents targeting dehydrated content are queued until hydration completes, then replayed to ensure they\'re handled correctly.\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant EventSystem\n    participant HydrationContext\n    participant QueuedEvent\n    participant EventHandler\n    \n    User->>EventSystem: Click on dehydrated area\n    EventSystem->>HydrationContext: attemptDiscreteHydration()\n    EventSystem->>QueuedEvent: queueDiscreteEvent()\n    \n    Note over HydrationContext: Hydrate boundary at high priority\n    \n    HydrationContext->>HydrationContext: Complete hydration\n    HydrationContext->>QueuedEvent: replayUnblockedEvents()\n    QueuedEvent->>EventHandler: Dispatch original event\n    EventHandler->>User: Handle interaction\n```\n\n**Event Replay Flow**\n\nSources: [packages/react-dom-bindings/src/events/ReactDOMEventReplaying.js:150-250](), [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js:728-850]()\n\n### Multiple Boundary Prioritization\n\nWhen multiple Suspense boundaries are dehydrated, React hydrates the one the user interacted with first, deferring others.\n\n```mermaid\ngraph TD\n    MultipleBoundaries["Multiple Dehydrated Boundaries"]\n    \n    BoundaryA["Boundary A<br/>(dehydrated)"]\n    BoundaryB["Boundary B<br/>(dehydrated)"]\n    BoundaryC["Boundary C<br/>(dehydrated)"]\n    \n    UserInteraction["User clicks Boundary B"]\n    \n    PrioritizeB["Prioritize Boundary B"]\n    HydrateB["Hydrate B first"]\n    HydrateRest["Hydrate A & C later"]\n    \n    MultipleBoundaries --> BoundaryA\n    MultipleBoundaries --> BoundaryB\n    MultipleBoundaries --> BoundaryC\n    \n    UserInteraction --> PrioritizeB\n    PrioritizeB --> HydrateB\n    HydrateB --> HydrateRest\n```\n\n**Multi-Boundary Prioritization**\n\nSources: [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js:300-400]()\n\n## Error Handling and Recovery\n\nReact\'s hydration system includes comprehensive error handling to recover from mismatches and provide useful diagnostics.\n\n### Recoverable Errors\n\nHydration mismatches are treated as recoverable errors. React logs the error via `onRecoverableError` callback but continues rendering.\n\n| Error Type | Recovery Strategy | User Impact |\n|-----------|------------------|-------------|\n| Tag mismatch | Client render subtree | Flicker during replacement |\n| Text mismatch | Use server text | Dev warning only |\n| Missing attribute | Apply client attribute | Attribute updates |\n| Extra DOM nodes | Delete extra nodes | Removed from DOM |\n\n```mermaid\ngraph TD\n    DetectError["Detect Hydration Mismatch"]\n    CaptureError["createCapturedValueAtFiber()"]\n    QueueError["queueHydrationError()"]\n    \n    ClientRenderBoundary["Find nearest Suspense boundary"]\n    UnmountServer["Unmount server subtree"]\n    MountClient["Mount client tree"]\n    \n    CallRecoverable["onRecoverableError()"]\n    LogWarning["Log warning in DEV"]\n    \n    DetectError --> CaptureError\n    CaptureError --> QueueError\n    QueueError --> ClientRenderBoundary\n    ClientRenderBoundary --> UnmountServer\n    UnmountServer --> MountClient\n    MountClient --> CallRecoverable\n    MountClient --> LogWarning\n```\n\n**Error Recovery Process**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:850-950](), [packages/react-reconciler/src/ReactCapturedValue.js:1-50]()\n\n### HydrationMismatchException\n\nIn DEV, React throws `HydrationMismatchException` with detailed component stacks and diff information.\n\n```mermaid\ngraph TD\n    BuildDiff["buildHydrationDiffNode()"]\n    CollectAncestors["Collect ancestor path"]\n    ThrowException["throwOnHydrationMismatch()"]\n    \n    ServerProps["Record server props"]\n    ClientProps["Record client props"]\n    DescribeDiff["describeDiff()"]\n    \n    FormatError["Format error message"]\n    ComponentStack["Generate component stack"]\n    ThrowError["Throw HydrationMismatchException"]\n    \n    BuildDiff --> CollectAncestors\n    BuildDiff --> ServerProps\n    BuildDiff --> ClientProps\n    ThrowException --> DescribeDiff\n    DescribeDiff --> FormatError\n    FormatError --> ComponentStack\n    ComponentStack --> ThrowError\n```\n\n**HydrationMismatchException Generation**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:950-1050](), [packages/react-reconciler/src/ReactFiberHydrationDiffs.js:50-150]()\n\n## Integration Points\n\nThe DOM event system and selective hydration work together to provide seamless interactivity in server-rendered applications:\n\n1. **Event Detection**: The event system identifies user interactions that should trigger hydration\n2. **Priority Assignment**: Different event types receive different hydration priorities\n3. **Boundary Targeting**: Events target specific Suspense boundaries for hydration\n4. **Event Queueing**: Original events are queued during hydration\n5. **Replay Execution**: Events are replayed after hydration completes\n\nThis integration ensures that server-rendered applications feel responsive while optimizing initial load performance through strategic hydration.\n\nSources: [packages/react-dom/src/__tests__/ReactDOMServerSelectiveHydration-test.internal.js:1-2200](), [packages/react-dom/src/events/__tests__/DOMPluginEventSystem-test.internal.js:1-2000]()\n\n---\n\n# Page: View Transitions and Gesture Scheduling\n\n# View Transitions and Gesture Scheduling\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React\'s view transition and gesture scheduling systems, which coordinate smooth animations and gesture-driven updates with React\'s rendering lifecycle. View transitions integrate with the browser\'s View Transition API to animate between UI states, while gesture scheduling manages gesture-driven animations (such as scroll-linked or drag-based animations) by scheduling renders at specific points along a gesture timeline.\n\nFor information about the general reconciler architecture and commit phase, see [React Reconciler](#4). For lane-based scheduling and priorities, see [Lane-Based Scheduling and Priorities](#4.4).\n\n---\n\n## Overview\n\nReact\'s view transition and gesture scheduling systems provide host configuration APIs that allow renderers to:\n\n1. **Coordinate view transitions** - Apply view-transition-name CSS properties, measure DOM changes, and manage the lifecycle of browser view transitions\n2. **Schedule gesture-driven renders** - Queue gestures, track their progress along timelines, and render at specific animation offsets\n3. **Detect visual changes** - Measure instance dimensions and positions to determine what changed during updates\n4. **Manage transition lifecycle** - Start, stop, and cancel transitions in coordination with React\'s commit phases\n\nThese systems are primarily implemented for the DOM renderer, with stub implementations in React Native and test renderers.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js]()\n\n---\n\n## Host Configuration Interface\n\n### Core Types and Data Structures\n\n**Type Hierarchy and Relationships**\n\n```mermaid\ngraph TB\n    subgraph "View Transition Types"\n        VTI["ViewTransitionInstance<br/>{name, group, imagePair, old, new}"]\n        VTS["ViewTransitionState<br/>{autoName, paired, clones, ref}"]\n        RVT["RunningViewTransition<br/>Platform-specific handle"]\n        IM["InstanceMeasurement<br/>Position & size data"]\n    end\n    \n    subgraph "Gesture Types"\n        GT["GestureTimeline<br/>Timeline provider"]\n        SG["ScheduledGesture<br/>{provider, count, rangeStart,<br/>rangeEnd, types, running, commit}"]\n    end\n    \n    subgraph "Host Config Methods"\n        SVTN["applyViewTransitionName()"]\n        RVTN["restoreViewTransitionName()"]\n        CMI["cloneMutableInstance()"]\n        MI["measureInstance()"]\n        MCI["measureClonedInstance()"]\n        SVT["startViewTransition()"]\n        SGT["startGestureTransition()"]\n        GGO["getCurrentGestureOffset()"]\n    end\n    \n    VTS --> VTI\n    VTI --> SVTN\n    RVT --> SVT\n    RVT --> SGT\n    IM --> MI\n    IM --> MCI\n    GT --> SGT\n    GT --> GGO\n    SG --> SGT\n    VTS --> CMI\n```\n\n**ViewTransitionState Structure**\n\nThe `ViewTransitionState` is attached to ViewTransition fiber nodes and tracks transition lifecycle:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `autoName` | `null \\| string` | Auto-generated view-transition-name (when name prop is \'auto\') |\n| `paired` | `null \\| ViewTransitionState` | Paired instance during enter/exit transitions |\n| `clones` | `null \\| Array<Instance>` | Cloned host instances during gesture apply phase |\n| `ref` | `null \\| ViewTransitionInstance` | Current ref instance exposed to user code |\n\n**ViewTransitionInstance Structure**\n\nThe `ViewTransitionInstance` represents a view transition element with animatable pseudo-elements:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `name` | `string` | The view-transition-name identifying this element |\n| `group` | `mixin$Animatable` | The ::view-transition-group pseudo-element |\n| `imagePair` | `mixin$Animatable` | The ::view-transition-image-pair pseudo-element |\n| `old` | `mixin$Animatable` | The ::view-transition-old pseudo-element |\n| `new` | `mixin$Animatable` | The ::view-transition-new pseudo-element |\n\n**ScheduledGesture Structure**\n\nGestures are queued and tracked in a linked list per `FiberRoot.pendingGestures`:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `provider` | `GestureTimeline` | The timeline provider (e.g., ScrollTimeline) |\n| `count` | `number` | Reference count for active starts |\n| `rangeStart` | `number` | Start percentage (0-100) of current state |\n| `rangeEnd` | `number` | End percentage (0-100) of destination state |\n| `types` | `null \\| TransitionTypes` | Transition type annotations from addTransitionType |\n| `running` | `null \\| RunningViewTransition` | Active transition handle |\n| `commit` | `null \\| (() => void)` | Deferred commit callback |\n| `committing` | `boolean` | Whether gesture should commit on release |\n| `revertLane` | `Lane` | Lane used to schedule revert render |\n| `prev` | `null \\| ScheduledGesture` | Previous gesture in linked list |\n| `next` | `null \\| ScheduledGesture` | Next gesture in linked list |\n\nSources: [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js:19-24](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:253-259](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js:31-43]()\n\n---\n\n## View Transition Lifecycle\n\n### ViewTransition Component and State Management\n\n**ViewTransition Name Resolution**\n\nThe `getViewTransitionName` function in `ReactFiberViewTransitionComponent.js` resolves the transition name:\n\n1. If `props.name` is explicitly set (and not \'auto\'), use that name\n2. Otherwise, if `instance.autoName` exists, use the cached auto-generated name\n3. Otherwise, generate a unique name: `\'_\' + identifierPrefix + \'t_\' + globalClientId + \'_\'`\n\nThe `getViewTransitionClassName` function resolves CSS classes based on:\n- `props.default` - Default class for all transitions\n- `props.enter` / `props.exit` / `props.share` - Event-specific classes\n- Active transition types from `getPendingTransitionTypes()`\n\n**Class Name Selection by Type**\n\n```mermaid\ngraph LR\n    subgraph "Props"\n        D["props.default"]\n        E["props.enter / exit / share"]\n    end\n    \n    subgraph "Runtime"\n        TT["getPendingTransitionTypes()"]\n        ATT["Active types array"]\n    end\n    \n    subgraph "Resolution"\n        GCBT["getClassNameByType()"]\n        Result["Resolved className"]\n    end\n    \n    D --> GCBT\n    E --> GCBT\n    TT --> ATT\n    ATT --> GCBT\n    GCBT --> Result\n    \n    Result --> Apply["applyViewTransitionName(instance, name, className)"]\n```\n\nSources: [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js:28-92]()\n\n### Applying and Managing View Transition Names\n\n**View Transition Name Application Sequence**\n\n```mermaid\nsequenceDiagram\n    participant R as Reconciler\n    participant CV as ReactFiberCommitViewTransitions\n    participant H as Host Config\n    participant D as DOM Element\n    participant V as View Transition API\n    \n    Note over R,CV: Before Mutation Phase\n    R->>CV: commitAppearingPairViewTransitions()\n    CV->>CV: Find paired enter/exit transitions\n    CV->>H: applyViewTransitionName(instance, name, className)\n    H->>D: element.style.viewTransitionName = name\n    H->>D: element.style.viewTransitionClass = className\n    \n    Note over R,V: Mutation Phase\n    R->>H: startViewTransition(container, types, callbacks...)\n    H->>V: document.startViewTransition(() => mutationCallback())\n    V-->>H: transition handle\n    H->>R: mutationCallback()\n    H->>R: layoutCallback()\n    H->>R: spawnedWorkCallback()\n    \n    Note over V,H: Animation Phase\n    V->>V: Capture old state pseudo-elements\n    V->>V: Apply DOM mutations\n    V->>V: Capture new state pseudo-elements\n    V->>V: Animate between states\n    \n    Note over R,H: After Animation\n    V->>H: Animation completes\n    H->>R: finishedAnimation() (profiling)\n    \n    Note over R,D: Cleanup Phase\n    R->>H: restoreViewTransitionName(instance, props)\n    H->>D: Restore original view-transition-name\n```\n\n**Key Host Config Methods:**\n\n- **`applyViewTransitionName(instance, name, className)`** - Sets `view-transition-name` and optional `view-transition-class` CSS properties\n- **`restoreViewTransitionName(instance, props)`** - Restores the view-transition-name from props after transition completes\n- **`cancelViewTransitionName(instance, name, props)`** - Removes view-transition-name from an element\n- **`cancelRootViewTransitionName(rootContainer)`** - Cancels view transition name on the root container\n- **`restoreRootViewTransitionName(rootContainer)`** - Restores root container\'s view transition name\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1212-1297](), [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js:232-285](), [packages/react-noop-renderer/src/createReactNoop.js:799-826]()\n\n### Starting and Stopping View Transitions\n\n**startViewTransition Host Config Method**\n\nThe `startViewTransition` method coordinates a view transition with React\'s commit phases:\n\n```javascript\nstartViewTransition(\n  rootContainer: Container,\n  transitionTypes: null | TransitionTypes,\n  mutationCallback: () => void,\n  layoutCallback: () => void,\n  afterMutationCallback: () => void,\n  spawnedWorkCallback: () => void,\n  passiveCallback: () => mixed,\n  errorCallback: mixed => void,\n  blockedCallback: string => void,  // Profiling-only\n  finishedAnimation: () => void      // Profiling-only\n): null | RunningViewTransition\n```\n\n**DOM Implementation**\n\nThe DOM renderer in `ReactFiberConfigDOM.js` wraps the native View Transition API:\n\n1. Calls `document.startViewTransition(() => { mutationCallback(); })` to start the transition\n2. Attaches `.finished` promise handler to call `finishedAnimation()` for profiling\n3. Returns the transition object which has `.skipTransition()` method\n4. If animation detection enabled, uses `suspendOnActiveViewTransition()` to wait for animation\n\n**Callback Execution Order:**\n\n1. **`mutationCallback()`** - Executed inside `document.startViewTransition()` to apply DOM changes\n2. **`layoutCallback()`** - Called immediately after mutation to execute layout effects\n3. **`afterMutationCallback()`** - Called after mutations complete (skipped in some paths)\n4. **`spawnedWorkCallback()`** - Called to signal that spawned work needs scheduling\n5. **`passiveCallback()`** - Called during passive effects phase (skipped in some paths)\n6. **`finishedAnimation()`** - Called when animation completes (profiling builds only)\n\n**Stopping Transitions**\n\nThe `stopViewTransition(transition)` method cancels an active transition:\n- In DOM: Calls `transition.skipTransition()` to abort the animation\n- In test renderers: No-op since no actual animation occurs\n\n**Transition Lifecycle Tracking**\n\n```mermaid\ngraph TB\n    subgraph "Start Transition"\n        SVT["startViewTransition()"]\n        DVT["document.startViewTransition()"]\n        MutCB["mutationCallback()"]\n        LayoutCB["layoutCallback()"]\n    end\n    \n    subgraph "Running State"\n        RVT["RunningViewTransition handle"]\n        FP["transition.finished Promise"]\n    end\n    \n    subgraph "Completion"\n        FA["finishedAnimation()"]\n        Cleanup["Restore view transition names"]\n    end\n    \n    SVT --> DVT\n    DVT --> MutCB\n    MutCB --> LayoutCB\n    DVT --> RVT\n    RVT --> FP\n    FP --> FA\n    FA --> Cleanup\n    \n    RVT --> |"stopViewTransition()"| Skip["transition.skipTransition()"]\n    Skip --> Cleanup\n```\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1299-1412](), [packages/react-noop-renderer/src/createReactNoop.js:854-896](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:668-690]()\n\n---\n\n## Apply Gesture Phase\n\n### Instance Cloning for Gestures\n\nDuring gesture transitions, React clones the tree to create a snapshot that can be animated while the live tree renders the destination state. The cloning process is managed by `ReactFiberApplyGesture.js`.\n\n**Cloning Architecture**\n\n```mermaid\ngraph TB\n    subgraph "Original Tree"\n        OF["Original Fiber Tree"]\n        OHI["Original Host Instances"]\n    end\n    \n    subgraph "Cloning Process"\n        CMI["cloneMutableInstance(instance, keepChildren)"]\n        CMTI["cloneMutableTextInstance(textInstance)"]\n        Clone["Clone Tree Construction"]\n    end\n    \n    subgraph "Cloned Tree"\n        CF["Cloned Fiber References"]\n        CHI["Cloned Host Instances"]\n        VTS["ViewTransitionState.clones"]\n    end\n    \n    OF --> CMI\n    OHI --> CMI\n    CMI --> Clone\n    CMTI --> Clone\n    Clone --> CHI\n    Clone --> VTS\n    CF --> CHI\n```\n\n**Visit Phases**\n\nThe apply gesture algorithm uses different visit phases to determine cloning behavior:\n\n| Phase | Value | Description |\n|-------|-------|-------------|\n| `CLONE_UPDATE` | 0 | Mutations or layout changes in this subtree |\n| `CLONE_EXIT` | 1 | Inside reappearing offscreen before next ViewTransition/HostComponent |\n| `CLONE_UNHIDE` | 2 | Inside reappearing offscreen before next HostComponent |\n| `CLONE_APPEARING_PAIR` | 3 | Finding paired appearing transitions |\n| `CLONE_UNCHANGED` | 4 | No changes but walking to clone tree |\n| `INSERT_EXIT` | 5 | Inside newly mounted tree before next ViewTransition/HostComponent |\n| `INSERT_APPEND` | 6 | Inside newly mounted tree before next HostComponent |\n| `INSERT_APPEARING_PAIR` | 7 | Inside newly mounted tree finding pairs |\n\n**Cloning and Mutation Tracking**\n\n```mermaid\nsequenceDiagram\n    participant WL as Work Loop\n    participant AG as ReactFiberApplyGesture\n    participant MT as ReactFiberMutationTracking\n    participant HC as Host Config\n    \n    Note over WL,AG: Apply Gesture Phase\n    WL->>AG: applyGestureToRoot(root, gesture)\n    AG->>MT: pushMutationContext(viewTransitionMutationContext)\n    AG->>AG: Walk fiber tree with visitPhase\n    \n    loop For each ViewTransition boundary\n        AG->>AG: Detect if mutations/layout changes\n        AG->>HC: cloneMutableInstance(instance, keepChildren)\n        HC-->>AG: Cloned instance\n        AG->>AG: Store in ViewTransitionState.clones\n        AG->>HC: applyViewTransitionName(clone, name, className)\n    end\n    \n    AG->>MT: popMutationContext()\n    AG->>MT: Apply tracked mutations to clones\n    AG->>HC: Insert cloned tree into DOM\n```\n\n**Instance Cloning Methods:**\n\n- **`cloneMutableInstance(instance, keepChildren)`** - Clones a host instance, optionally keeping children\n- **`cloneMutableTextInstance(textInstance)`** - Clones a text instance\n- **`cloneRootViewTransitionContainer(rootContainer)`** - Clones the root container for transitions\n\nSources: [packages/react-reconciler/src/ReactFiberApplyGesture.js:104-316](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:613-638]()\n\n### Measurement System\n\n**Instance Measurement and Change Detection**\n\nReact measures instance positions and sizes to determine what changed during a transition:\n\n```mermaid\ngraph TB\n    subgraph "Measurement Phase"\n        MI["measureInstance(instance)"]\n        MCI["measureClonedInstance(clone)"]\n        IM["InstanceMeasurement<br/>{position, size, viewport}"]\n    end\n    \n    subgraph "Change Detection"\n        WIV["wasInstanceInViewport(measurement)"]\n        HIC["hasInstanceChanged(oldMeasurement, newMeasurement)"]\n        HIAP["hasInstanceAffectedParent(oldMeasurement, newMeasurement)"]\n    end\n    \n    subgraph "Decision Logic"\n        Decision["Should animate?"]\n        Apply["Apply view transition name"]\n        Skip["Skip transition"]\n    end\n    \n    MI --> IM\n    MCI --> IM\n    IM --> WIV\n    IM --> HIC\n    IM --> HIAP\n    \n    WIV --> Decision\n    HIC --> Decision\n    HIAP --> Decision\n    \n    Decision --> |"Yes"| Apply\n    Decision --> |"No"| Skip\n```\n\n**Measurement API Methods:**\n\n| Method | Purpose | Implementation |\n|--------|---------|----------------|\n| `measureInstance(instance)` | Captures position and size before changes | DOM: Uses `getBoundingClientRect()` |\n| `measureClonedInstance(instance)` | Measures a cloned instance | DOM: Uses `getBoundingClientRect()` on clone |\n| `wasInstanceInViewport(measurement)` | Checks if instance was in viewport | DOM: Compares bounds to window dimensions |\n| `hasInstanceChanged(oldMeasurement, newMeasurement)` | Detects position/size changes | DOM: Compares measurement values |\n| `hasInstanceAffectedParent(oldMeasurement, newMeasurement)` | Checks if parent layout affected | DOM: Compares parent-relative positions |\n\n**Root Container Cloning:**\n\nFor view transitions involving the root, React clones the entire container:\n\n- **`cloneRootViewTransitionContainer(rootContainer)`** - Creates a snapshot clone of the root\n- **`removeRootViewTransitionClone(rootContainer, clone)`** - Removes the cloned snapshot after transition\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1508-1584](), [packages/react-noop-renderer/src/createReactNoop.js:828-852](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:639-666]()\n\n---\n\n## Gesture Scheduling System\n\n### Gesture Queue and Lifecycle\n\n**FiberRoot Gesture State Management**\n\n```mermaid\ngraph TB\n    subgraph "FiberRoot State"\n        PG["root.pendingGestures<br/>(ScheduledGesture linked list)"]\n        SG["root.stoppingGestures<br/>(Gestures to stop)"]\n        PL["root.pendingLanes"]\n        GL["GestureLane bit"]\n    end\n    \n    subgraph "Scheduling Operations"\n        SchG["scheduleGesture(root, provider)"]\n        StSG["startScheduledGesture(root, timeline, options, types)"]\n        CanG["cancelScheduledGesture(root, gesture)"]\n        DelG["deleteScheduledGesture(root, gesture)"]\n        StopG["stopCompletedGestures(root)"]\n    end\n    \n    subgraph "Work Loop Integration"\n        ERS["ensureRootIsScheduled(root)"]\n        RGL["renderOnGestureLane()"]\n        AGR["applyGestureToRoot()"]\n    end\n    \n    SchG --> PG\n    StSG --> PG\n    CanG --> SG\n    DelG --> PG\n    StopG --> SG\n    \n    PG --> GL\n    GL --> PL\n    PL --> ERS\n    ERS --> RGL\n    RGL --> AGR\n```\n\n### Scheduling Gestures\n\n**scheduleGesture Function Flow**\n\nThe `scheduleGesture(root, provider)` function in `ReactFiberGestureScheduler.js` adds a gesture to the pending queue:\n\n1. Searches `root.pendingGestures` linked list for matching `provider`\n2. If found, returns existing `ScheduledGesture`\n3. If not found, creates new `ScheduledGesture` with initial state:\n   - `count: 0` (not yet started)\n   - `rangeStart: 0, rangeEnd: 100` (uninitialized)\n   - `types: null` (no transition types yet)\n   - `running: null` (no active transition)\n4. Appends to linked list\n5. Calls `ensureRootIsScheduled(root)` to schedule render work\n\n**startScheduledGesture Activation**\n\nThe `startScheduledGesture(root, gestureTimeline, gestureOptions, transitionTypes)` function activates a gesture:\n\n1. Calculates `rangeStart` from `gestureOptions.rangeStart` or `getCurrentGestureOffset(gestureTimeline)`\n2. Calculates `rangeEnd` from `gestureOptions.rangeEnd` or heuristic based on current offset:\n   - If `rangeStart < 50`, default `rangeEnd = 100`\n   - If `rangeStart >= 50`, default `rangeEnd = 0`\n3. Finds matching gesture in `root.pendingGestures`\n4. Increments `gesture.count` (reference counting)\n5. Updates `gesture.rangeStart`, `gesture.rangeEnd`\n6. Merges `transitionTypes` into `gesture.types` array (deduplicates)\n7. Returns the `ScheduledGesture` for tracking\n\n**Gesture Lifecycle Sequence**\n\n```mermaid\nsequenceDiagram\n    participant Hook as startGestureTransition hook\n    participant GS as ReactFiberGestureScheduler\n    participant FR as FiberRoot\n    participant WL as Work Loop\n    participant AG as ReactFiberApplyGesture\n    \n    Note over Hook,GS: Schedule Phase\n    Hook->>GS: scheduleGesture(root, provider)\n    GS->>FR: Search pendingGestures\n    alt Gesture exists\n        FR-->>GS: Return existing ScheduledGesture\n    else New gesture\n        GS->>FR: Create & append ScheduledGesture\n        GS->>GS: ensureRootIsScheduled(root)\n    end\n    GS-->>Hook: Return ScheduledGesture\n    \n    Note over Hook,GS: Start Phase\n    Hook->>GS: startScheduledGesture(root, timeline, options, types)\n    GS->>GS: Calculate rangeStart/rangeEnd\n    GS->>FR: gesture.count++, update ranges & types\n    GS-->>Hook: Return ScheduledGesture\n    \n    Note over FR,AG: Render Phase\n    FR->>WL: Render on GestureLane\n    WL->>AG: applyGestureToRoot(root, gesture)\n    AG->>AG: Clone tree, apply mutations\n    AG->>FR: gesture.running = startGestureTransition(...)\n    \n    Note over Hook,GS: Cancel Phase\n    Hook->>GS: cancelScheduledGesture(root, gesture)\n    GS->>FR: gesture.count--\n    alt count === 0\n        GS->>GS: Delete gesture from list\n        alt Has runningTransition & pending lanes\n            GS->>FR: Move to root.stoppingGestures\n        else Has runningTransition & no pending work\n            GS->>GS: stopViewTransition(runningTransition)\n        end\n    end\n    \n    Note over FR,WL: Post-Commit\n    WL->>GS: stopCompletedGestures(root)\n    GS->>GS: Stop all deferred transitions\n```\n\nSources: [packages/react-reconciler/src/ReactFiberGestureScheduler.js:48-130]()\n\n### Canceling and Stopping Gestures\n\n**cancelScheduledGesture Implementation**\n\nThe `cancelScheduledGesture(root, gesture)` function handles gesture cleanup with reference counting:\n\n1. If `gesture.revertLane !== NoLane`, entangles it with any new transition lanes to ensure they commit together\n2. Decrements `gesture.count`\n3. If `count === 0`:\n   - Determines whether to commit or revert based on final offset:\n     - If `rangeStart < rangeEnd`: commit if `finalOffset > midpoint`\n     - If `rangeStart > rangeEnd`: commit if `finalOffset < midpoint`\n   - If committing and has `gesture.running`:\n     - Sets `gesture.committing = true`\n     - Schedules render on `GestureLane` to commit\n   - Otherwise, calls `deleteScheduledGesture(root, gesture)` to remove\n\n**deleteScheduledGesture Linked List Management**\n\nThe `deleteScheduledGesture(root, gesture)` function removes gesture from queue:\n\n1. Updates linked list pointers:\n   - `gesture.prev.next = gesture.next`\n   - `gesture.next.prev = gesture.prev`\n2. If removing head, updates `root.pendingGestures = gesture.next`\n3. If queue becomes empty (`root.pendingGestures === null`):\n   - Clears `GestureLane` from `root.pendingLanes` via `markRootFinished(root, GestureLane)`\n4. If `gesture.running` exists:\n   - If blocking/transition lanes pending: moves to `root.stoppingGestures`\n   - Otherwise: immediately calls `stopViewTransition(gesture.running)`\n\n**stopCompletedGestures Deferred Cleanup**\n\nThe `stopCompletedGestures(root)` function is called after commit:\n\n1. Checks if `root.stoppingGestures` is non-null\n2. Iterates through linked list of deferred gestures\n3. Calls `stopViewTransition(gesture.running)` for each\n4. Clears `root.stoppingGestures = null`\n\n**Commit Handling**\n\nIf `gesture.committing === true` during render:\n1. Applies mutations to commit the destination state\n2. After commit, triggers revert transition if new gesture scheduled\n3. Otherwise, completes normally without revert\n\nSources: [packages/react-reconciler/src/ReactFiberGestureScheduler.js:132-198]()\n\n---\n\n## Gesture Timeline Integration\n\n### Starting Gesture Transitions\n\nThe `startGestureTransition` method initiates a gesture-driven view transition:\n\n```javascript\nstartGestureTransition(\n  rootContainer: Container,\n  timeline: GestureTimeline,\n  rangeStart: number,\n  rangeEnd: number,\n  transitionTypes: null | TransitionTypes,\n  mutationCallback: () => void,\n  animateCallback: () => void,\n  errorCallback: mixed => void,\n  finishedAnimation: () => void\n): null | RunningViewTransition\n```\n\n**Execution Flow:**\n\n1. Calls `mutationCallback()` to apply DOM mutations\n2. Calls `animateCallback()` to set up animations along the timeline\n3. Optionally calls `finishedAnimation()` for profiling\n4. Returns handle to cancel the gesture transition\n\n**`getCurrentGestureOffset(provider)`** - Queries current position along the gesture timeline (0-100 percentage).\n\nSources: [packages/react-noop-renderer/src/createReactNoop.js:874-897](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:694-730]()\n\n---\n\n## Platform-Specific Implementations\n\n### DOM Renderer Implementation\n\nThe DOM renderer in `ReactFiberConfigDOM.js` provides full view transition support:\n\n**View Transition Name Management**\n\n```javascript\n// Apply view transition name and class\nfunction applyViewTransitionName(instance, name, className) {\n  const style = instance.style;\n  if (typeof style.viewTransitionName === \'string\') {\n    style.viewTransitionName = name;\n    if (className != null) {\n      style.viewTransitionClass = className;\n    }\n  }\n}\n\n// Restore from props\nfunction restoreViewTransitionName(instance, props) {\n  const style = instance.style;\n  if (typeof style.viewTransitionName === \'string\') {\n    const propName = props.style?.viewTransitionName ?? \n                     props.style?.[\'view-transition-name\'];\n    style.viewTransitionName = propName ?? \'\';\n    // Also restore viewTransitionClass...\n  }\n}\n```\n\n**Native View Transition API Integration**\n\nThe `startViewTransition` implementation wraps the browser API:\n\n```javascript\nfunction startViewTransition(\n  rootContainer,\n  transitionTypes,\n  mutationCallback,\n  layoutCallback,\n  afterMutationCallback,\n  spawnedWorkCallback,\n  passiveCallback,\n  errorCallback,\n  blockedCallback,\n  finishedAnimation\n) {\n  const transition = document.startViewTransition(() => {\n    mutationCallback();\n  });\n  \n  layoutCallback();\n  afterMutationCallback();\n  spawnedWorkCallback();\n  \n  transition.finished.then(() => {\n    finishedAnimation();\n  });\n  \n  return transition;\n}\n```\n\n**Measurement Implementation**\n\n- **`measureInstance(instance)`** - Uses `instance.getBoundingClientRect()` to capture position/size\n- **`wasInstanceInViewport(measurement)`** - Compares bounds to `window.innerWidth` and `window.innerHeight`\n- **`hasInstanceChanged(oldMeasurement, newMeasurement)`** - Compares rect properties\n- **`hasInstanceAffectedParent(oldMeasurement, newMeasurement)`** - Checks parent-relative position changes\n\n**Event-Driven Scheduling**\n\n- **`shouldAttemptEagerTransition()`** - Returns `true` during popstate events to render transitions synchronously\n- **`trackSchedulerEvent()`** - Captures `window.event` in `schedulerEvent` variable\n- **`resolveEventType()`** - Returns `window.event.type` if it differs from `schedulerEvent`\n- **`resolveEventTimeStamp()`** - Returns `window.event.timeStamp` for timing\n\n**Instance Cloning**\n\n```javascript\nfunction cloneMutableInstance(instance, keepChildren) {\n  return instance.cloneNode(keepChildren);\n}\n\nfunction cloneMutableTextInstance(textInstance) {\n  return textInstance.cloneNode(false);\n}\n```\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:613-638](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1212-1297](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1299-1412](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:733-770]()\n\n### React Native Implementations\n\n**Fabric Renderer (New Architecture)**\n\nReact Native\'s Fabric renderer in `ReactFiberConfigFabric.js` provides stub implementations:\n\n```javascript\n// View transition names - not yet implemented\nexport function applyViewTransitionName(instance, name, className) {\n  // Not yet implemented\n}\n\n// Start view transition - executes callbacks but no animation\nexport function startViewTransition(...callbacks) {\n  mutationCallback();\n  layoutCallback();\n  // Skip afterMutationCallback - not needed\n  spawnedWorkCallback();\n  // Skip passiveCallback - spawned work will schedule\n  return null;\n}\n\n// Start gesture transition - executes callbacks but no animation\nexport function startGestureTransition(...callbacks) {\n  mutationCallback();\n  animateCallback();\n  if (enableProfilerTimer) {\n    finishedAnimation();\n  }\n  return null;\n}\n\n// Gesture offset - throws error\nexport function getCurrentGestureOffset(provider) {\n  throw new Error(\'startGestureTransition is not yet supported in React Native.\');\n}\n```\n\n**Legacy Renderer (Old Architecture)**\n\nThe legacy renderer in `ReactFiberConfigNative.js` has identical stub implementations. Both renderers execute the callbacks to ensure React\'s commit phases complete correctly, but no actual animations occur since React Native doesn\'t have a native view transition API.\n\n**Measurement Methods**\n\nAll measurement methods return null or dummy values:\n- `measureInstance(instance)` returns `null`\n- `measureClonedInstance(instance)` returns `null`\n- `wasInstanceInViewport(measurement)` returns `true`\n- `hasInstanceChanged(old, new)` returns `false`\n- `hasInstanceAffectedParent(old, new)` returns `false`\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:593-730](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:593-730]()\n\n### Test Renderer Implementation\n\n**react-test-renderer**\n\nThe test renderer in `ReactFiberConfigTestHost.js` provides no-op implementations that allow tests to execute:\n\n```javascript\nexport function startViewTransition(...callbacks) {\n  mutationCallback();\n  layoutCallback();\n  // Skip afterMutationCallback\n  spawnedWorkCallback();\n  // Skip passiveCallback\n  return null;\n}\n\nexport function startGestureTransition(...callbacks) {\n  mutationCallback();\n  animateCallback();\n  if (enableProfilerTimer) {\n    finishedAnimation();\n  }\n  return null;\n}\n\nexport function cloneMutableInstance(instance, keepChildren) {\n  return {\n    type: instance.type,\n    props: instance.props,\n    isHidden: instance.isHidden,\n    children: keepChildren ? instance.children : [],\n    internalInstanceHandle: null,\n    rootContainerInstance: instance.rootContainerInstance,\n    tag: \'INSTANCE\',\n  };\n}\n```\n\n**react-noop-renderer**\n\nThe noop renderer used in React\'s internal tests has more sophisticated implementations for testing purposes:\n- Tracks call counts via `hostCloneCounter`\n- Maintains instance relationships\n- Validates clone operations\n\nSources: [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:176-458](), [packages/react-noop-renderer/src/createReactNoop.js:243-288](), [packages/react-noop-renderer/src/createReactNoop.js:799-897]()\n\n---\n\n## Integration with Reconciler\n\n### Gesture Lane Scheduling\n\nGestures use a dedicated lane (`GestureLane`) defined in `ReactFiberLane.js`:\n\n**Lane Assignment Flow**\n\n```mermaid\ngraph TB\n    subgraph "Component Layer"\n        Hook["startGestureTransition() hook"]\n        Action["User gesture action"]\n    end\n    \n    subgraph "Scheduling Layer"\n        SG["scheduleGesture(root, provider)"]\n        SSG["startScheduledGesture(root, timeline, options)"]\n        ERS["ensureRootIsScheduled(root)"]\n    end\n    \n    subgraph "Lane Management"\n        PL["root.pendingLanes"]\n        GL["GestureLane bit"]\n        MRE["markRootEntangled()"]\n    end\n    \n    subgraph "Work Loop"\n        RGL["performWorkOnRoot(GestureLane)"]\n        AGR["applyGestureToRoot()"]\n        Commit["Commit phase"]\n    end\n    \n    Action --> Hook\n    Hook --> SG\n    SG --> GL\n    GL --> PL\n    SG --> ERS\n    Hook --> SSG\n    SSG --> MRE\n    \n    ERS --> RGL\n    RGL --> AGR\n    AGR --> Commit\n    \n    Commit --> SCG["stopCompletedGestures()"]\n```\n\n**Lane Lifecycle:**\n\n1. `scheduleGesture()` adds gesture to `root.pendingGestures` and implicitly adds `GestureLane` to `root.pendingLanes`\n2. `ensureRootIsScheduled(root)` schedules work on `GestureLane`\n3. During render, `applyGestureToRoot()` processes the gesture\n4. `deleteScheduledGesture()` clears `GestureLane` via `markRootFinished(root, GestureLane)` when queue empties\n5. If gesture has blocking/transition work, lane stays set until commit completes\n\n**Entanglement:**\n\nWhen canceling a gesture with `revertLane !== NoLane`, the revert lane is entangled with new transition lanes via `markRootEntangled()` to ensure they commit together.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:108](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js:17-22](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js:138-141]()\n\n### Commit Phase Integration\n\n**View Transition Commit Sequence**\n\n```mermaid\nsequenceDiagram\n    participant WL as Work Loop\n    participant CV as ReactFiberCommitViewTransitions\n    participant HC as Host Config\n    participant AG as ReactFiberApplyGesture\n    participant GS as ReactFiberGestureScheduler\n    \n    Note over WL,CV: Before Mutation Phase\n    WL->>CV: Track appearing view transitions\n    WL->>CV: commitAppearingPairViewTransitions()\n    CV->>HC: applyViewTransitionName() for pairs\n    \n    Note over WL,HC: Mutation Phase\n    WL->>HC: startViewTransition(callbacks...)\n    HC->>HC: document.startViewTransition(() => mutationCallback())\n    HC->>WL: Execute mutation effects\n    \n    Note over WL,HC: Layout Phase\n    HC->>WL: layoutCallback()\n    WL->>WL: Execute layout effects\n    \n    Note over WL,HC: After Mutation\n    HC->>WL: spawnedWorkCallback()\n    WL->>WL: Schedule spawned work\n    \n    Note over WL,HC: Passive Phase\n    HC->>WL: passiveCallback()\n    WL->>WL: Execute passive effects\n    \n    Note over WL,GS: Cleanup Phase\n    WL->>GS: stopCompletedGestures(root)\n    GS->>HC: stopViewTransition() for deferred gestures\n    GS->>GS: Clear root.stoppingGestures\n```\n\n**Phase Responsibilities:**\n\n| Phase | Responsibilities |\n|-------|------------------|\n| **Before Mutation** | Track appearing ViewTransitions, find pairs, measure instances |\n| **Mutation** | Start view transition, apply DOM mutations in mutationCallback |\n| **Layout** | Execute layout effects, measure after layout |\n| **After Mutation** | Coordinate spawned work, insert cloned trees for gestures |\n| **Passive** | Execute passive effects, schedule any remaining work |\n| **Post-Commit** | Stop deferred gesture transitions, clean up stoppingGestures |\n\n**Gesture Apply Phase:**\n\nFor gesture transitions, `applyGestureToRoot()` is called during the render phase (not commit):\n1. Clones the fiber tree to create a snapshot\n2. Applies mutations to clones\n3. Inserts cloned tree into DOM\n4. Starts `startGestureTransition()` with timeline\n5. Stores handle in `gesture.running`\n\nSources: [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js:232-285](), [packages/react-reconciler/src/ReactFiberApplyGesture.js:317-800](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js:185-198]()\n\n---\n\n## Summary\n\nReact\'s view transition and gesture scheduling systems provide:\n\n| Component | Purpose | Key Types | Key Methods |\n|-----------|---------|-----------|-------------|\n| **View Transitions** | Browser API integration | `ViewTransitionInstance`, `RunningViewTransition` | `startViewTransition`, `applyViewTransitionName`, measurement methods |\n| **Gesture Scheduling** | Timeline-driven animations | `ScheduledGesture`, `GestureTimeline` | `scheduleGesture`, `startScheduledGesture`, `cancelScheduledGesture` |\n| **Measurement** | Change detection | `InstanceMeasurement` | `measureInstance`, `hasInstanceChanged`, `wasInstanceInViewport` |\n| **Host Config** | Platform abstraction | Platform-specific handles | All methods implemented per-platform |\n\nThe DOM renderer provides full support for these features, while React Native and test renderers provide stub implementations that maintain API compatibility without actual animations.\n\nSources: [packages/react-reconciler/src/ReactFiberGestureScheduler.js](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](), [packages/react-noop-renderer/src/createReactNoop.js]()\n\n---\n\n# Page: Developer Tools and Debugging\n\n# Developer Tools and Debugging\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [fixtures/devtools/standalone/index.html](fixtures/devtools/standalone/index.html)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-devtools-core/README.md](packages/react-devtools-core/README.md)\n- [packages/react-devtools-core/src/backend.js](packages/react-devtools-core/src/backend.js)\n- [packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js](packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js)\n- [packages/react-devtools-extensions/src/contentScripts/installHook.js](packages/react-devtools-extensions/src/contentScripts/installHook.js)\n- [packages/react-devtools-extensions/src/contentScripts/messages.js](packages/react-devtools-extensions/src/contentScripts/messages.js)\n- [packages/react-devtools-inline/src/backend.js](packages/react-devtools-inline/src/backend.js)\n- [packages/react-devtools-shared/src/__tests__/componentStacks-test.js](packages/react-devtools-shared/src/__tests__/componentStacks-test.js)\n- [packages/react-devtools-shared/src/__tests__/console-test.js](packages/react-devtools-shared/src/__tests__/console-test.js)\n- [packages/react-devtools-shared/src/__tests__/inspectedElement-test.js](packages/react-devtools-shared/src/__tests__/inspectedElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js](packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/setupTests.js](packages/react-devtools-shared/src/__tests__/setupTests.js)\n- [packages/react-devtools-shared/src/__tests__/store-test.js](packages/react-devtools-shared/src/__tests__/store-test.js)\n- [packages/react-devtools-shared/src/attachRenderer.js](packages/react-devtools-shared/src/attachRenderer.js)\n- [packages/react-devtools-shared/src/backend/agent.js](packages/react-devtools-shared/src/backend/agent.js)\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js](packages/react-devtools-shared/src/backend/fiber/renderer.js)\n- [packages/react-devtools-shared/src/backend/legacy/renderer.js](packages/react-devtools-shared/src/backend/legacy/renderer.js)\n- [packages/react-devtools-shared/src/backend/types.js](packages/react-devtools-shared/src/backend/types.js)\n- [packages/react-devtools-shared/src/backend/views/Highlighter/index.js](packages/react-devtools-shared/src/backend/views/Highlighter/index.js)\n- [packages/react-devtools-shared/src/backendAPI.js](packages/react-devtools-shared/src/backendAPI.js)\n- [packages/react-devtools-shared/src/bridge.js](packages/react-devtools-shared/src/bridge.js)\n- [packages/react-devtools-shared/src/devtools/store.js](packages/react-devtools-shared/src/devtools/store.js)\n- [packages/react-devtools-shared/src/devtools/utils.js](packages/react-devtools-shared/src/devtools/utils.js)\n- [packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js](packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js)\n- [packages/react-devtools-shared/src/devtools/views/utils.js](packages/react-devtools-shared/src/devtools/views/utils.js)\n- [packages/react-devtools-shared/src/frontend/types.js](packages/react-devtools-shared/src/frontend/types.js)\n- [packages/react-devtools-shared/src/hook.js](packages/react-devtools-shared/src/hook.js)\n- [packages/react-devtools-shared/src/hydration.js](packages/react-devtools-shared/src/hydration.js)\n- [packages/react-devtools-shared/src/utils.js](packages/react-devtools-shared/src/utils.js)\n- [packages/react-devtools-shell/src/app/ElementTypes/index.js](packages/react-devtools-shell/src/app/ElementTypes/index.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js](packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js](packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js](packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/react/src/ReactForwardRef.js](packages/react/src/ReactForwardRef.js)\n- [packages/react/src/ReactMemo.js](packages/react/src/ReactMemo.js)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\nThe React repository provides comprehensive developer tooling that operates across the development lifecycle:\n\n| Tool | Phase | Purpose |\n|------|-------|---------|\n| **eslint-plugin-react-hooks** | Edit/Build Time | Statically validates Rules of Hooks and dependency arrays |\n| **React DevTools** | Runtime | Inspects component trees, profiles performance, debugs state |\n| **Console Patching** | Runtime | Appends component stacks to console messages |\n| **Performance Tracks** | Runtime | Emits User Timing marks for Performance panel |\n\nReact DevTools consists of a backend that attaches to React renderers via `__REACT_DEVTOOLS_GLOBAL_HOOK__`, a frontend that displays component trees and profiling data, and a versioned bridge protocol for communication. The ESLint plugin uses AST analysis to enforce Hook usage patterns. Console patching infrastructure enhances error messages with component stacks.\n\n**Sources:**\n- [packages/react-devtools-shared/src/hook.js:58-86]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1006-1102]()\n- [packages/eslint-plugin-react-hooks/src/RulesOfHooks.ts:1-50]()\n\n## React DevTools\n\nReact DevTools provides runtime inspection and profiling of React applications. The system consists of:\n\n- **Backend**: Attaches to React renderers via `__REACT_DEVTOOLS_GLOBAL_HOOK__.inject()`, wraps Fiber nodes in `DevToolsInstance` objects with stable IDs\n- **Frontend**: Displays component trees, state/props, and profiling data through the `Store` class\n- **Bridge**: Versioned protocol (version 2) for communication, serializes tree mutations as compact integer arrays\n\nDevTools Tooling Ecosystem\n\n```mermaid\ngraph TB\n    subgraph Packages["DevTools Packages"]\n        hook["react-devtools-shared/src/hook.js<br/>__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        backend["react-devtools-shared/src/backend/<br/>agent.js, renderer.js"]\n        frontend["react-devtools-shared/src/devtools/<br/>store.js, views/"]\n        bridge["react-devtools-shared/src/bridge.js<br/>FrontendBridge, BackendBridge"]\n    end\n    \n    subgraph Distributions["Distribution Models"]\n        standalone["react-devtools<br/>Electron + WebSocket"]\n        extension["react-devtools-extensions<br/>Chrome/Firefox/Edge"]\n        inline["react-devtools-inline<br/>Embeddable UI"]\n    end\n    \n    subgraph ReactApp["React Application"]\n        renderer["ReactDOM/ReactNative<br/>renderer.inject()"]\n        fibers["Fiber tree"]\n    end\n    \n    hook --> renderer\n    renderer --> backend\n    backend --> bridge\n    bridge --> frontend\n    \n    backend --> standalone\n    backend --> extension\n    backend --> inline\n    \n    renderer --> fibers\n    backend -.->|"wraps"| fibers\n    \n    style hook fill:#f9f9f9\n    style backend fill:#f9f9f9\n    style bridge fill:#f9f9f9\n```\n\nKey capabilities:\n- **Component Tree**: `Store` maintains `_idToElement`, `_ownersMap`, `_roots` to track component hierarchy\n- **State Inspection**: `inspectHooksOfFiber()` extracts hook values, `cleanForBridge()` serializes complex data\n- **Performance Profiling**: `injectProfilingHooks()` collects `fiberActualDurations`, effect timings\n- **Suspense Debugging**: `_idToSuspense` tracks suspension state, visualizes boundaries spatially\n\nDevTools supports three deployment models: standalone Electron app, browser extensions, and inline embeddable UI. See page 7.1 for detailed architecture and page 7.2 for distribution details.\n\n**Sources:**\n- [packages/react-devtools-shared/src/hook.js:58-86]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:183-292]()\n- [packages/react-devtools-shared/src/devtools/store.js:143-348]()\n- [packages/react-devtools-shared/src/bridge.js:47-73]()\n- [packages/react-devtools/package.json:1-32]()\n\n## Console Integration and Debugging Utilities\n\nBeyond the DevTools UI, React provides several runtime debugging utilities that enhance the browser console experience.\n\n### Console Patching\n\nConsole Patching Implementation (hook.js)\n\n```mermaid\ngraph TB\n    subgraph HookSetup["Global Hook Setup (hook.js:58-110)"]\n        installHook["installHook()"]\n        GlobalHook["window.__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        settings["settings: DevToolsHookSettings"]\n    end\n    \n    subgraph Patching["Console Method Patching (hook.js:110-267)"]\n        targetMethod["console.error/warn/log"]\n        savedMethod["Save original method"]\n        overrideMethod["Override with patched version"]\n        checkSettings["if settings.appendComponentStack"]\n        formatArgs["formatConsoleArguments()"]\n    end\n    \n    subgraph StackGen["Component Stack Generation"]\n        getCurrentFiber["renderer.getCurrentFiber()"]\n        getStack["getStackByFiberInDevAndProd()<br/>or getOwnerStackByFiberInDev()"]\n        appendStack["Append to console args"]\n        callOriginal["Call original console method"]\n    end\n    \n    installHook --> GlobalHook\n    GlobalHook --> settings\n    targetMethod --> savedMethod\n    savedMethod --> overrideMethod\n    overrideMethod --> checkSettings\n    checkSettings -->|"true"| formatArgs\n    formatArgs --> getCurrentFiber\n    getCurrentFiber --> getStack\n    getStack --> appendStack\n    appendStack --> callOriginal\n    checkSettings -->|"false"| callOriginal\n```\n\nThe hook patches console methods in [hook.js:110-267](). Key implementation details:\n\n- **Settings**: `DevToolsHookSettings` controls behavior\n  - `appendComponentStack` - Whether to append stacks (default: true in dev)\n  - `breakOnConsoleErrors` - Debugger breakpoint on errors\n- **Stack Extraction**: Calls `renderer.getCurrentFiber()` to get active Fiber, then `getStackByFiberInDevAndProd()` or `getOwnerStackByFiberInDev()` [renderer.js:133-138]()\n- **Formatting**: `formatConsoleArguments()` inserts ANSI/CSS styling for dimmed component stacks\n\n### Component Stacks\n\nReact 19.1+ supports **Owner Stacks** which show logical component ownership rather than the render tree hierarchy:\n\n- `captureOwnerStack()` - Public API to capture owner stack at any point [CHANGELOG.md:98]()\n- `supportsOwnerStacks()` - Backend check for owner stack support [DevToolsFiberComponentStack.js:136-137]()\n- `getOwnerStackByFiberInDev()` - Extracts owner chain from Fiber [DevToolsFiberComponentStack.js:135-138]()\n- `formatOwnerStack()` - Formats owner stack for display [DevToolsOwnerStack.js]()\n\nOwner stacks differ from traditional component stacks:\n- Show which component created an element (owner), not which component rendered it (parent)\n- Useful for HOCs and render props where ownership  parent-child relationship\n- Work across server-client boundaries in Server Components\n\n### Performance Tracks\n\nReact 19.2+ emits User Timing API marks that appear in the Performance panel [CHANGELOG.md:12]():\n\n- Profiling hooks injected via `injectProfilingHooks()` [renderer.js:1106-1119]()\n- Marks created for:\n  - Component render start/end\n  - Commit phase start/end  \n  - Passive effects start/end\n- `supportsPerformanceTracks` capability flag [store.js:86]()\n\n**Sources:**\n- [packages/react-devtools-shared/src/hook.js:110-267]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:133-138]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1106-1119]()\n- [packages/react-devtools-shared/src/devtools/store.js:86]()\n- [CHANGELOG.md:12]()\n- [CHANGELOG.md:86]()\n\n## ESLint Plugin for React Hooks\n\nThe `eslint-plugin-react-hooks` package enforces Hook usage patterns through static AST analysis. It provides two rules:\n\n| Rule | Severity | Purpose |\n|------|----------|---------|\n| `rules-of-hooks` | error | Ensures Hooks are only called at top level, not in loops/conditions |\n| `exhaustive-deps` | warn | Validates dependency arrays for `useEffect`, `useMemo`, `useCallback` |\n\nESLint Plugin Analysis Flow\n\n```mermaid\ngraph TB\n    subgraph RulesOfHooks["rules-of-hooks"]\n        visitCall["Visit CallExpression"]\n        matchHook["Match /^use[A-Z]/ pattern"]\n        getCodePath["ESLint CodePathSegment"]\n        checkContext["isInsideLoop()<br/>isInsideConditional()"]\n        reportViolation["Report: Hook in loop/condition"]\n    end\n    \n    subgraph ExhaustiveDeps["exhaustive-deps"]\n        visitEffect["Visit useEffect/useMemo/useCallback"]\n        extractDeps["Extract dependency array"]\n        analyzeScope["Analyze callback scope"]\n        collectRefs["collectReferencesInScope()"]\n        checkStable["Filter stable values:<br/>setState, dispatch, ref.current"]\n        diffDeps["Compare vs declared deps"]\n        suggestFix["Suggest missing/extra deps"]\n    end\n    \n    visitCall --> matchHook\n    matchHook --> getCodePath\n    getCodePath --> checkContext\n    checkContext -->|"invalid"| reportViolation\n    \n    visitEffect --> extractDeps\n    visitEffect --> analyzeScope\n    analyzeScope --> collectRefs\n    collectRefs --> checkStable\n    extractDeps --> diffDeps\n    checkStable --> diffDeps\n    diffDeps --> suggestFix\n    \n    style visitCall fill:#f9f9f9\n    style visitEffect fill:#f9f9f9\n```\n\nThe plugin uses ESLint\'s `CodePath` API to track control flow and detects violations through visitor pattern on `CallExpression` nodes. `rules-of-hooks` validates calling context, while `exhaustive-deps` analyzes closure scope to identify missing dependencies.\n\nConfiguration example:\n```javascript\nimport reactHooks from \'eslint-plugin-react-hooks\';\nexport default [reactHooks.configs.flat.recommended];\n```\n\nOptions include `additionalHooks` for custom hook patterns and `enableDangerousAutofixThreshold` for automatic fixes. See page 7.3 for detailed implementation.\n\n**Sources:**\n- [packages/eslint-plugin-react-hooks/src/RulesOfHooks.ts:1-50]()\n- [packages/eslint-plugin-react-hooks/src/ExhaustiveDeps.ts:1-100]()\n- [packages/eslint-plugin-react-hooks/README.md:1-150]()\n\n## Build and Distribution\n\n### Package Structure\n\nThe DevTools codebase is organized into several npm packages:\n\n| Package | Purpose | Main Exports |\n|---------|---------|--------------|\n| `react-devtools` | Standalone Electron app | Binary: `bin.js` |\n| `react-devtools-core` | Backend + WebSocket server | `backend.js`, `standalone.js` |\n| `react-devtools-inline` | Embeddable UI | `backend.js`, `frontend.js` |\n| `react-devtools-extensions` | Browser extensions | Not published to npm |\n| `react-devtools-shared` | Shared utilities | Internal only |\n| `eslint-plugin-react-hooks` | ESLint rules | Plugin export |\n\n**Sources:**\n- [packages/react-devtools/package.json:1-32]()\n- [packages/react-devtools-core/package.json:1-38]()\n- [packages/react-devtools-inline/package.json:1-52]()\n\n### Build Process\n\nDevTools Build System (Webpack)\n\n```mermaid\ngraph TB\n    subgraph Sources["Source Packages"]\n        shared["react-devtools-shared/src/"]\n        backend["backend/"]\n        frontend["devtools/"]\n        core["react-devtools-core/src/"]\n        inline["react-devtools-inline/src/"]\n    end\n    \n    subgraph WebpackConfigs["Webpack Configurations"]\n        backendWebpack["webpack.backend.js"]\n        standaloneWebpack["webpack.standalone.js"]\n        extensionWebpack["chrome/webpack.config.js<br/>firefox/webpack.config.js"]\n    end\n    \n    subgraph Artifacts["Build Artifacts"]\n        coreBackend["react-devtools-core/dist/backend.js"]\n        coreStandalone["react-devtools-core/dist/standalone.js"]\n        inlineBackend["react-devtools-inline/dist/backend.js"]\n        inlineFrontend["react-devtools-inline/dist/frontend.js"]\n        extensionBundle["extensions/chrome/build/react_devtools_backend.js"]\n    end\n    \n    shared --> backendWebpack\n    backend --> backendWebpack\n    shared --> standaloneWebpack\n    frontend --> standaloneWebpack\n    \n    backendWebpack --> coreBackend\n    standaloneWebpack --> coreStandalone\n    backendWebpack --> inlineBackend\n    standaloneWebpack --> inlineFrontend\n    extensionWebpack --> extensionBundle\n```\n\n**Build Environment Variables**:\n\n| Variable | Values | Effect |\n|----------|--------|--------|\n| `NODE_ENV` | `development`, `production` | Affects `__DEV__` checks, minification |\n| `FEATURE_FLAG_TARGET` | `core`, `backend-fb` | Enables Meta-internal features |\n| Source Maps | Generated for inline/extension builds | `devtool: \'source-map\'` in webpack config |\n\n**Bundle Targets**:\n- **backend.js**: Runs in application context, exports `initialize()` [backend/index.js]()\n- **frontend.js**: UI bundle with React DevTools components\n- **standalone.js**: Combined frontend with WebSocket client\n\nThe build system uses Webpack DefinePlugin to inline environment-specific constants, and BabelPlugin for JSX transformation.\n\n**Sources:**\n- [packages/react-devtools-core/package.json:17-25]()\n- [packages/react-devtools-inline/package.json:19-21]()\n\n### Version Compatibility\n\nDevTools maintains backward and forward compatibility through:\n\n1. **Bridge Protocol Versioning**: Current version is 2 [bridge.js:66-69]()\n2. **Unsupported Renderer Detection**: Shows warnings for too-old React versions\n3. **NPM Version Ranges**: Protocol includes `minNpmVersion` and `maxNpmVersion` [bridge.js:32-34]()\n\nWhen versions mismatch:\n- Newer backend  older frontend: Backend sends `minNpmVersion`, frontend shows upgrade prompt\n- Older backend  newer frontend: Frontend uses embedded version map to show downgrade instructions\n\n**Sources:**\n- [packages/react-devtools-shared/src/bridge.js:47-73]()\n- [packages/react-devtools-shared/src/devtools/store.js:169-220]()\n\n---\n\n# Page: React DevTools Architecture\n\n# React DevTools Architecture\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [fixtures/devtools/standalone/index.html](fixtures/devtools/standalone/index.html)\n- [packages/react-devtools-core/README.md](packages/react-devtools-core/README.md)\n- [packages/react-devtools-core/src/backend.js](packages/react-devtools-core/src/backend.js)\n- [packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js](packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js)\n- [packages/react-devtools-extensions/src/contentScripts/installHook.js](packages/react-devtools-extensions/src/contentScripts/installHook.js)\n- [packages/react-devtools-extensions/src/contentScripts/messages.js](packages/react-devtools-extensions/src/contentScripts/messages.js)\n- [packages/react-devtools-inline/src/backend.js](packages/react-devtools-inline/src/backend.js)\n- [packages/react-devtools-shared/src/__tests__/componentStacks-test.js](packages/react-devtools-shared/src/__tests__/componentStacks-test.js)\n- [packages/react-devtools-shared/src/__tests__/console-test.js](packages/react-devtools-shared/src/__tests__/console-test.js)\n- [packages/react-devtools-shared/src/__tests__/inspectedElement-test.js](packages/react-devtools-shared/src/__tests__/inspectedElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js](packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/setupTests.js](packages/react-devtools-shared/src/__tests__/setupTests.js)\n- [packages/react-devtools-shared/src/__tests__/store-test.js](packages/react-devtools-shared/src/__tests__/store-test.js)\n- [packages/react-devtools-shared/src/attachRenderer.js](packages/react-devtools-shared/src/attachRenderer.js)\n- [packages/react-devtools-shared/src/backend/agent.js](packages/react-devtools-shared/src/backend/agent.js)\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js](packages/react-devtools-shared/src/backend/fiber/renderer.js)\n- [packages/react-devtools-shared/src/backend/legacy/renderer.js](packages/react-devtools-shared/src/backend/legacy/renderer.js)\n- [packages/react-devtools-shared/src/backend/types.js](packages/react-devtools-shared/src/backend/types.js)\n- [packages/react-devtools-shared/src/backend/views/Highlighter/index.js](packages/react-devtools-shared/src/backend/views/Highlighter/index.js)\n- [packages/react-devtools-shared/src/backendAPI.js](packages/react-devtools-shared/src/backendAPI.js)\n- [packages/react-devtools-shared/src/bridge.js](packages/react-devtools-shared/src/bridge.js)\n- [packages/react-devtools-shared/src/devtools/store.js](packages/react-devtools-shared/src/devtools/store.js)\n- [packages/react-devtools-shared/src/devtools/utils.js](packages/react-devtools-shared/src/devtools/utils.js)\n- [packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js](packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js)\n- [packages/react-devtools-shared/src/devtools/views/utils.js](packages/react-devtools-shared/src/devtools/views/utils.js)\n- [packages/react-devtools-shared/src/frontend/types.js](packages/react-devtools-shared/src/frontend/types.js)\n- [packages/react-devtools-shared/src/hook.js](packages/react-devtools-shared/src/hook.js)\n- [packages/react-devtools-shared/src/hydration.js](packages/react-devtools-shared/src/hydration.js)\n- [packages/react-devtools-shared/src/utils.js](packages/react-devtools-shared/src/utils.js)\n- [packages/react-devtools-shell/src/app/ElementTypes/index.js](packages/react-devtools-shell/src/app/ElementTypes/index.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js](packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js](packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js](packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js)\n- [packages/react/src/ReactForwardRef.js](packages/react/src/ReactForwardRef.js)\n- [packages/react/src/ReactMemo.js](packages/react/src/ReactMemo.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes the architecture of React DevTools, the debugging and profiling tooling for React applications. It covers the three-tier architecture (Backend, Bridge, Frontend), the instrumentation mechanism, the bridge protocol for cross-context communication, and the various distribution channels (browser extensions, standalone app, inline embedding).\n\nFor information about the ESLint plugin for React hooks, see [7.2](#7.2). For details about React\'s internal reconciler and Fiber architecture that DevTools instruments, see [4.1](#4.1).\n\n---\n\n## High-Level Architecture\n\nReact DevTools uses a **three-tier architecture** that separates concerns between application instrumentation, communication, and user interface:\n\n```mermaid\ngraph TB\n    subgraph "Application Context"\n        App["React Application"]\n        Hook["__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        Renderer["React Renderer<br/>(react-dom, react-native)"]\n        Backend["DevTools Backend<br/>FiberRenderer/LegacyRenderer"]\n        Agent["Agent<br/>Command Dispatcher"]\n    end\n    \n    subgraph "Communication Layer"\n        Bridge["Bridge Protocol<br/>EventEmitter + Wall"]\n    end\n    \n    subgraph "DevTools UI Context"\n        Store["Store<br/>Tree State Manager<br/>_idToElement Map"]\n        ProfilerStore["ProfilerStore<br/>Profiling Data"]\n        ComponentsPanel["Components Panel"]\n        ProfilerPanel["Profiler Panel"]\n    end\n    \n    App --> Renderer\n    Renderer -->|"inject()"| Hook\n    Hook -->|"attach()"| Backend\n    Backend --> Agent\n    Agent <-->|"send/listen"| Bridge\n    Bridge <-->|"operations"| Store\n    Store --> ComponentsPanel\n    ProfilerStore --> ProfilerPanel\n    Store --> ProfilerStore\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1007-1014]()\n- [packages/react-devtools-shared/src/backend/agent.js:263-276]()\n- [packages/react-devtools-shared/src/devtools/store.js:143-169]()\n- [packages/react-devtools-shared/src/hook.js:58-68]()\n\nThe architecture separates concerns:\n- **Backend** runs in the same JavaScript context as the React application, instrumenting the reconciler\n- **Bridge** provides version-agnostic message passing between backend and frontend\n- **Frontend** runs in a separate context (extension panel, standalone window, or embedded iframe) and provides the UI\n\n---\n\n## Backend Architecture\n\n### Global Hook Injection\n\nThe DevTools backend uses a global hook installed on `window.__REACT_DEVTOOLS_GLOBAL_HOOK__` to intercept React renderer initialization. This hook is a de facto public API that React renderers detect and call during initialization.\n\n**DevToolsHook Object Structure:**\n\n```mermaid\ngraph TB\n    Hook["__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n    \n    subgraph "Core Properties"\n        renderers["renderers: Map<RendererID, ReactRenderer>"]\n        rendererInterfaces["rendererInterfaces: Map<RendererID, RendererInterface>"]\n        backends["backends: Map<string, DevToolsBackend>"]\n        listeners["listeners: {[event]: Array<Handler>}"]\n    end\n    \n    subgraph "React Callbacks"\n        inject["inject(renderer): number | null"]\n        onCommitFiberRoot["onCommitFiberRoot(rendererID, root, priority?)"]\n        onCommitFiberUnmount["onCommitFiberUnmount(rendererID, fiber)"]\n    end\n    \n    subgraph "DevTools Callbacks"\n        emit["emit(event, data)"]\n        on["on(event, handler)"]\n        sub["sub(event, handler)"]\n    end\n    \n    subgraph "Settings"\n        settings["settings: DevToolsHookSettings"]\n    end\n    \n    Hook --> renderers\n    Hook --> rendererInterfaces\n    Hook --> backends\n    Hook --> listeners\n    Hook --> inject\n    Hook --> onCommitFiberRoot\n    Hook --> onCommitFiberUnmount\n    Hook --> emit\n    Hook --> on\n    Hook --> sub\n    Hook --> settings\n```\n\n**Hook Installation Flow:**\n\n```mermaid\nsequenceDiagram\n    participant PageLoad as "Page Load"\n    participant installHook as "installHook()"\n    participant Hook as "__REACT_DEVTOOLS_GLOBAL_HOOK__"\n    participant Renderer as "React Renderer"\n    participant Backend as "Backend attach()"\n    \n    PageLoad->>installHook: Execute\n    installHook->>Hook: Create hook object\n    installHook->>Hook: Set listeners, backends, renderers Maps\n    installHook->>Hook: Define inject(), onCommitFiberRoot(), etc.\n    \n    Note over Renderer: React loads and initializes\n    \n    Renderer->>Hook: Check for __REACT_DEVTOOLS_GLOBAL_HOOK__\n    Renderer->>Hook: call inject(renderer)\n    Hook->>Hook: Assign rendererID = ++UID\n    Hook->>Hook: renderers.set(rendererID, renderer)\n    Hook->>Hook: emit("renderer", {id, renderer})\n    Hook->>Backend: Listener receives "renderer" event\n    Backend->>Backend: Call attach(hook, rendererID, renderer)\n    Backend->>Hook: rendererInterfaces.set(rendererID, interface)\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/hook.js:59-230]()\n- [packages/react-devtools-shared/src/backend/types.js:552-593]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1004-1028]()\n\nThe hook is installed early, before React loads, by:\n- **Browser extensions**: injected via content script executing `installHook.js`\n- **Standalone app**: served from local HTTP server on `http://localhost:8097`\n- **Inline embedding**: bundled in the page via `activate(window)`\n\n**Sources:**\n- [packages/react-devtools-extensions/src/contentScripts/installHook.js:1-85]()\n- [packages/react-devtools-core/src/backend.js:63-150]()\n- [packages/react-devtools-inline/src/backend.js:1-100]()\n\n### Backend Renderer Interface\n\nThe backend provides a `RendererInterface` that handles all interactions with a specific React renderer:\n\n| Method | Purpose |\n|--------|---------|\n| `flushInitialOperations()` | Send initial tree state to frontend |\n| `findHostInstancesForElementID()` | Map DevTools element ID to DOM/host instances |\n| `inspectElement()` | Retrieve detailed props/state/hooks for an element |\n| `overrideProps()` / `overrideHookState()` | Live-edit component data |\n| `getProfilingData()` | Collect profiling measurements |\n| `setTraceUpdatesEnabled()` | Enable/disable render highlighting |\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/types.js:412-455]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1007-1425]()\n\n### Fiber Tree Instrumentation\n\nThe backend instruments React\'s Fiber reconciler by creating a parallel data structure that mirrors the component tree. For each Fiber, the backend creates either a `FiberInstance`, `VirtualInstance`, or `FilteredFiberInstance`:\n\n```mermaid\ngraph TB\n    subgraph "React Reconciler"\n        FiberTree["Fiber Tree<br/>(React Internal)"]\n        FiberNode1["Fiber Node"]\n        FiberNode2["Fiber Node"]\n    end\n    \n    subgraph "DevTools Backend"\n        DevToolsTree["DevTools Instance Tree"]\n        FiberInstance["FiberInstance<br/>{kind: 0, id, data: Fiber}"]\n        VirtualInstance["VirtualInstance<br/>{kind: 1, id, data: ReactComponentInfo}"]\n        FilteredInstance["FilteredFiberInstance<br/>{kind: 2, data: Fiber}"]\n    end\n    \n    subgraph "Maps"\n        idToElement["idToDevToolsInstanceMap<br/>Map<id, DevToolsInstance>"]\n        rootToFiber["rootToFiberInstanceMap<br/>Map<FiberRoot, FiberInstance>"]\n        publicToElement["publicInstanceToDevToolsInstanceMap<br/>Map<HostInstance, DevToolsInstance>"]\n    end\n    \n    FiberNode1 -.->|"instruments"| FiberInstance\n    FiberNode2 -.->|"instruments"| VirtualInstance\n    FiberInstance --> DevToolsTree\n    VirtualInstance --> DevToolsTree\n    FilteredInstance -.->|"filtered but tracked"| DevToolsTree\n    \n    DevToolsTree --> idToElement\n    DevToolsTree --> rootToFiber\n    DevToolsTree --> publicToElement\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:185-293]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:864-888]()\n\nInstance types:\n- **FiberInstance** (`kind: 0`): Represents a stateful Fiber pair (current/work-in-progress) for client components\n- **VirtualInstance** (`kind: 1`): Represents server components or optimized-away components that don\'t create Fibers\n- **FilteredFiberInstance** (`kind: 2`): Hidden by component filters but tracked to find host instances\n\n### Tree Operations Protocol\n\nThe backend sends tree mutations to the frontend as compact numeric arrays called **operations**. Each operation is prefixed with an operation code:\n\n| Operation Code | Constant | Purpose |\n|----------------|----------|---------|\n| `1` | `TREE_OPERATION_ADD` | Add new element to tree |\n| `2` | `TREE_OPERATION_REMOVE` | Remove element(s) from tree |\n| `3` | `TREE_OPERATION_REORDER_CHILDREN` | Reorder children of an element |\n| `4` | `TREE_OPERATION_UPDATE_TREE_BASE_DURATION` | Update profiling duration |\n| `5` | `TREE_OPERATION_UPDATE_ERRORS_OR_WARNINGS` | Update error/warning counts |\n| `7` | `TREE_OPERATION_SET_SUBTREE_MODE` | Update StrictMode status |\n| `8` | `SUSPENSE_TREE_OPERATION_ADD` | Add Suspense boundary |\n| `12` | `SUSPENSE_TREE_OPERATION_SUSPENDERS` | Update Suspense state |\n\n**Sources:**\n- [packages/react-devtools-shared/src/constants.js:20-32]()\n- [packages/react-devtools-shared/src/utils.js:224-464]()\n\nOperations include a string table to avoid repetition:\n\n```\n[rendererID, rootID, stringTableSize, ...encodedStrings, ...operations]\n```\n\nThis compact format minimizes serialization overhead when sending tree updates across the bridge.\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1426-1600]()\n\n---\n\n## Bridge Protocol\n\n### Protocol Versioning\n\nThe bridge uses a versioned protocol to handle compatibility between different DevTools versions. The protocol version is negotiated on connection:\n\n```mermaid\nsequenceDiagram\n    participant Backend\n    participant Bridge\n    participant Frontend\n    \n    Backend->>Bridge: emit("bridgeProtocol", {version: 2})\n    Bridge->>Frontend: "bridgeProtocol" event\n    Frontend->>Frontend: Check compatibility\n    alt Versions compatible\n        Frontend->>Backend: Continue normal operation\n    else Backend newer\n        Frontend->>Frontend: Display upgrade prompt\n    else Frontend newer\n        Frontend->>Frontend: Display downgrade prompt\n    end\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/bridge.js:36-73]()\n- [packages/react-devtools-shared/src/devtools/store.js:273-320]()\n\nThe `BRIDGE_PROTOCOL` array defines version history with NPM version ranges:\n\n```javascript\n// Protocol version 2 added StrictMode support\n{\n  version: 2,\n  minNpmVersion: \'4.22.0\',\n  maxNpmVersion: null,\n}\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/bridge.js:47-70]()\n\n### Message Passing\n\nThe bridge is built on two abstractions:\n- **EventEmitter**: For typed event handling with `addListener()` / `emit()`\n- **Wall**: For low-level message transport with `send()` / `listen()`\n\n```mermaid\ngraph LR\n    subgraph "Backend Context"\n        BackendCode["Backend Code"]\n        BackendBridge["BackendBridge<br/>extends EventEmitter"]\n        BackendWall["Wall Implementation"]\n    end\n    \n    subgraph "Frontend Context"\n        FrontendWall["Wall Implementation"]\n        FrontendBridge["FrontendBridge<br/>extends EventEmitter"]\n        FrontendCode["Frontend Code"]\n    end\n    \n    BackendCode -->|"emit(\'operations\', data)"| BackendBridge\n    BackendBridge -->|"wall.send()"| BackendWall\n    BackendWall -.->|"postMessage/WebSocket/etc"| FrontendWall\n    FrontendWall -->|"wall.listen()"| FrontendBridge\n    FrontendBridge -->|"emit(\'operations\')"| FrontendCode\n    \n    FrontendCode -->|"emit(\'inspectElement\', params)"| FrontendBridge\n    FrontendBridge -->|"wall.send()"| FrontendWall\n    FrontendWall -.->|"postMessage/WebSocket/etc"| BackendWall\n    BackendWall -->|"wall.listen()"| BackendBridge\n    BackendBridge -->|"emit(\'inspectElement\')"| BackendCode\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/bridge.js:1-10]()\n- [packages/react-devtools-shared/src/backend/agent.js:307-356]()\n\n### Transport Implementations\n\nThe Wall abstraction enables different transport mechanisms for different environments:\n\n| Environment | Wall Implementation | Transport Mechanism |\n|-------------|---------------------|---------------------|\n| Browser Extension | `chrome.runtime.connect()` | Chrome extension messaging |\n| Standalone App | WebSocket | TCP socket over localhost |\n| Inline Embedding | `window.postMessage()` | Same-page iframe messaging |\n| React Native | WebSocket or Metro | RN debugging protocol |\n\n**Sources:**\n- [packages/react-devtools-extensions/chrome/manifest.json:1-65]()\n- [packages/react-devtools-core/package.json:1-38]()\n- [packages/react-devtools-inline/package.json:1-52]()\n\n---\n\n## Frontend Architecture\n\n### Store\n\nThe `Store` class is the single source of truth for the component tree state on the frontend. It processes operations from the backend and maintains several maps:\n\n```mermaid\ngraph TB\n    Store["Store"]\n    \n    subgraph "Core State"\n        idToElement["_idToElement<br/>Map<id, Element>"]\n        roots["_roots<br/>Array<rootID>"]\n        ownersMap["_ownersMap<br/>Map<id, Set<id>>"]\n        errorsAndWarnings["_errorsAndWarnings<br/>Map<id, {errorCount, warningCount}>"]\n    end\n    \n    subgraph "Suspense State"\n        idToSuspense["_idToSuspense<br/>Map<id, SuspenseNode>"]\n        rtree["_rtree<br/>RBush spatial index"]\n    end\n    \n    subgraph "Metadata"\n        rootIDToRendererID["_rootIDToRendererID<br/>Map<rootID, rendererID>"]\n        rootIDToCapabilities["_rootIDToCapabilities<br/>Map<rootID, Capabilities>"]\n    end\n    \n    Store --> idToElement\n    Store --> roots\n    Store --> ownersMap\n    Store --> errorsAndWarnings\n    Store --> idToSuspense\n    Store --> rtree\n    Store --> rootIDToRendererID\n    Store --> rootIDToCapabilities\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/store.js:143-272]()\n- [packages/react-devtools-shared/src/devtools/store.js:197-236]()\n\nThe Store processes operations in `onBridgeOperations()`:\n\n1. Parse string table from operations array\n2. Iterate through operations\n3. For each operation type (ADD, REMOVE, etc.), update internal maps\n4. Emit `mutated` event to trigger UI updates\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/store.js:1139-1784]()\n\n### Component State Serialization\n\nElement inspection uses a request-response pattern with **dehydration** and **hydration** to handle complex nested objects efficiently.\n\n**Serialization Pipeline:**\n\n```mermaid\ngraph TB\n    subgraph "Backend Serialization"\n        Fiber["Fiber Node"]\n        inspectElementRaw["inspectElementRaw(fiber)"]\n        getPropsForFiber["Get fiber.memoizedProps"]\n        getStateForFiber["Get fiber.memoizedState"]\n        getHooksForFiber["inspectHooksOfFiber()"]\n        dehydrate["dehydrate(data, path, cleaned)"]\n    end\n    \n    subgraph "Dehydrated Data Structure"\n        DehydratedData["{data: Array, cleaned: Array, unserializable: Array}"]\n        meta["Dehydrated objects: {inspectable, type, preview_short, preview_long}"]\n    end\n    \n    subgraph "Frontend Hydration"\n        InspectedElement["InspectedElement"]\n        hydrate["hydrate(data, cleaned, unserializable)"]\n        AddMetaSymbols["Add meta[Symbol] properties"]\n    end\n    \n    Fiber --> inspectElementRaw\n    inspectElementRaw --> getPropsForFiber\n    inspectElementRaw --> getStateForFiber\n    inspectElementRaw --> getHooksForFiber\n    getPropsForFiber --> dehydrate\n    getStateForFiber --> dehydrate\n    getHooksForFiber --> dehydrate\n    dehydrate --> DehydratedData\n    DehydratedData --> meta\n    \n    DehydratedData --> InspectedElement\n    InspectedElement --> hydrate\n    hydrate --> AddMetaSymbols\n```\n\n**Dehydration Process:**\n\nThe `dehydrate()` function recursively traverses objects and replaces complex values with `Dehydrated` metadata:\n\n| Value Type | Dehydration Strategy |\n|------------|---------------------|\n| Primitives (string, number, boolean) | Pass through unchanged |\n| Shallow objects (depth < 2) | Recursively dehydrate properties |\n| Deep objects (depth >= 2) | Replace with `{inspectable: true, type, preview_short, preview_long}` |\n| Arrays | Dehydrate each element |\n| React Elements | Replace with `{type: "react_element", preview}` |\n| Functions | Replace with `{type: "function", name}` |\n| Symbols | Replace with `{type: "symbol", name}` |\n| Unserializable (BigInt, ArrayBuffer) | Mark in `unserializable` array |\n\n**Sources:**\n- [packages/react-devtools-shared/src/hydration.js:200-350]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:2900-3100]()\n\n**Inspection Request-Response Flow:**\n\n```mermaid\nsequenceDiagram\n    participant UI as "UI Component"\n    participant Context as "InspectedElementContext"\n    participant Bridge\n    participant Agent\n    participant Backend as "fiber/renderer.js"\n    \n    UI->>Context: Read inspectedElement\n    Context->>Context: fetchElement(id, path)\n    Context->>Bridge: send("inspectElement", {id, path: null, requestID, rendererID})\n    Bridge->>Agent: emit("inspectElement", params)\n    Agent->>Backend: inspectElement(requestID, id, inspectedPaths, forceFullData)\n    \n    Backend->>Backend: Find DevToolsInstance by id\n    Backend->>Backend: inspectElementRaw(instance)\n    Backend->>Backend: Get props from fiber.memoizedProps\n    Backend->>Backend: Get state from fiber.memoizedState\n    Backend->>Backend: Call inspectHooksOfFiber(fiber, currentDispatcherRef)\n    Backend->>Backend: dehydrate(props, [], cleaned, unserializable)\n    Backend->>Backend: dehydrate(state, [], cleaned, unserializable)\n    Backend->>Backend: dehydrate(hooks, [], cleaned, unserializable)\n    \n    Backend->>Agent: Return InspectedElementPayload\n    Agent->>Bridge: send("inspectedElement", payload)\n    Bridge->>Context: emit("inspectedElement")\n    Context->>Context: hydrate(payload.value)\n    Context->>UI: Update inspected element\n    \n    Note over UI: User clicks to expand nested object\n    \n    UI->>Context: inspectPaths(["props", "user", "address"])\n    Context->>Bridge: send("inspectElement", {id, path: ["props","user","address"]})\n    Backend->>Backend: getInObject(fiber.memoizedProps, path)\n    Backend->>Backend: dehydrate(value at path)\n    Backend->>Agent: Return {type: "hydrated-path", path, value}\n    Agent->>Bridge: send("inspectedElement")\n    Context->>Context: fillInPath(data, path, value)\n```\n\n**Hooks Inspection:**\n\nThe backend uses `react-debug-tools` to inspect hooks:\n\n```javascript\n// In inspectElementRaw()\nimport {inspectHooksOfFiber} from \'react-debug-tools\';\n\nconst hooks = inspectHooksOfFiber(\n  fiber,\n  currentDispatcherRef, // ReactSharedInternals.H\n);\n```\n\nThis returns a `HooksTree` structure representing the hook call stack:\n\n```typescript\ntype HooksNode = {\n  id: number,\n  isStateEditable: boolean,\n  name: string,\n  value: mixed,\n  subHooks: Array<HooksNode>,\n  hookSource?: {\n    lineNumber: number,\n    columnNumber: number,\n    functionName: string,\n    fileName: string,\n  },\n};\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:2700-2900]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:98]()\n- [packages/react-debug-tools/src/ReactDebugHooks.js:1-500]()\n- [packages/react-devtools-shared/src/hydration.js:1-500]()\n- [packages/react-devtools-shared/src/backendAPI.js:50-200]()\n\n### UI Components\n\nThe frontend UI is organized into major panels:\n\n| Panel | Component | Purpose |\n|-------|-----------|---------|\n| Components | `Components.js` | Tree view + element inspector |\n| Profiler | `Profiler.js` | Commit timeline + flame graph |\n| Settings | `Settings/` | DevTools configuration |\n| Suspense | `SuspenseTab/` | Suspense boundary visualization (experimental) |\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/views/Components/]()\n- [packages/react-devtools-shared/src/devtools/views/Profiler/]()\n\nThe Components panel uses React Context for state management:\n\n```mermaid\ngraph TB\n    TreeContext["TreeContext<br/>(selected element, expansion state)"]\n    StoreContext["StoreContext<br/>(Store instance)"]\n    BridgeContext["BridgeContext<br/>(Bridge instance)"]\n    InspectedElementContext["InspectedElementContext<br/>(inspection cache)"]\n    \n    TreeContext --> Tree["Tree.js<br/>(virtualized tree)"]\n    StoreContext --> Tree\n    BridgeContext --> Tree\n    \n    TreeContext --> Inspector["InspectedElement.js<br/>(props/state/hooks)"]\n    InspectedElementContext --> Inspector\n    BridgeContext --> Inspector\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/views/Components/TreeContext.js]()\n- [packages/react-devtools-shared/src/devtools/views/Components/InspectedElementContext.js]()\n- [packages/react-devtools-shared/src/devtools/views/context.js]()\n\n### Profiling Hooks Integration\n\nThe DevTools backend injects profiling hooks into the React reconciler to collect performance data during renders.\n\n**Profiling Hooks Architecture:**\n\n```mermaid\ngraph TB\n    subgraph "DevTools Backend"\n        createProfilingHooks["createProfilingHooks()"]\n        ProfilingHooks["DevToolsProfilingHooks object"]\n    end\n    \n    subgraph "Profiling Hooks Methods"\n        markRenderScheduled["markRenderScheduled(lane)"]\n        markRenderStarted["markRenderStarted(lanes)"]\n        markComponentRenderStarted["markComponentRenderStarted(fiber)"]\n        markComponentRenderStopped["markComponentRenderStopped()"]\n        markCommitStarted["markCommitStarted(lanes)"]\n        markLayoutEffectsStarted["markLayoutEffectsStarted(lanes)"]\n        markPassiveEffectsStarted["markPassiveEffectsStarted(lanes)"]\n    end\n    \n    subgraph "React Reconciler"\n        Scheduler["Scheduler scheduleCallback()"]\n        WorkLoop["performConcurrentWorkOnRoot()"]\n        beginWork["beginWork(fiber)"]\n        completeWork["completeWork(fiber)"]\n        commitRoot["commitRoot()"]\n    end\n    \n    subgraph "Collected Data"\n        CommitData["CommitDataBackend: {duration, fiberActualDurations, fiberSelfDurations}"]\n        ProfilingData["ProfilingDataBackend: {dataForRoots, timelineData}"]\n    end\n    \n    createProfilingHooks --> ProfilingHooks\n    ProfilingHooks --> markRenderScheduled\n    ProfilingHooks --> markRenderStarted\n    ProfilingHooks --> markComponentRenderStarted\n    \n    Scheduler -->|calls| markRenderScheduled\n    WorkLoop -->|calls| markRenderStarted\n    beginWork -->|calls| markComponentRenderStarted\n    completeWork -->|calls| markComponentRenderStopped\n    commitRoot -->|calls| markCommitStarted\n    commitRoot -->|calls| markLayoutEffectsStarted\n    commitRoot -->|calls| markPassiveEffectsStarted\n    \n    markCommitStarted --> CommitData\n    CommitData --> ProfilingData\n```\n\n**Profiling Session Lifecycle:**\n\n```mermaid\nsequenceDiagram\n    participant Frontend\n    participant Bridge\n    participant Agent\n    participant Backend as "fiber/renderer.js"\n    participant Reconciler as "React Reconciler"\n    \n    Frontend->>Bridge: send("startProfiling", {recordChangeDescriptions, recordTimeline})\n    Bridge->>Agent: emit("startProfiling")\n    Agent->>Backend: startProfiling(recordChangeDescriptions, recordTimeline)\n    Backend->>Backend: Set isProfiling = true\n    Backend->>Backend: Clear profilingData, recordChangeDescriptions flag\n    Backend->>Reconciler: injectProfilingHooks(profilingHooks)\n    \n    Note over Reconciler: App renders and commits...\n    \n    Reconciler->>Backend: markRenderScheduled(lane)\n    Backend->>Backend: Track scheduled update\n    Reconciler->>Backend: markRenderStarted(lanes)\n    Backend->>Backend: currentCommitProfilingMetadata = {startTime}\n    Reconciler->>Backend: markComponentRenderStarted(fiber)\n    Backend->>Backend: Track fiber render start time\n    Reconciler->>Backend: markComponentRenderStopped()\n    Backend->>Backend: Calculate fiber actual duration\n    Reconciler->>Backend: markCommitStarted(lanes)\n    Backend->>Backend: Record commit start\n    Reconciler->>Backend: markCommitStopped()\n    Backend->>Backend: Build CommitDataBackend\n    Backend->>Backend: profilingData.dataForRoots[rootID].commitData.push(data)\n    \n    Note over Reconciler: Multiple commits may occur...\n    \n    Frontend->>Bridge: send("stopProfiling")\n    Bridge->>Agent: emit("stopProfiling")\n    Agent->>Backend: stopProfiling()\n    Backend->>Backend: Set isProfiling = false\n    Frontend->>Bridge: send("getProfilingData", {rendererID})\n    Bridge->>Agent: emit("getProfilingData")\n    Agent->>Backend: getProfilingData()\n    Backend->>Backend: Serialize profilingData\n    Backend->>Agent: Return ProfilingDataBackend\n    Agent->>Bridge: send("profilingData", data)\n    Bridge->>Frontend: emit("profilingData")\n```\n\n**Collected Profiling Metrics:**\n\n| Metric | Source | Purpose |\n|--------|--------|---------|\n| `fiberActualDurations` | `markComponentRenderStarted/Stopped()` | Time spent rendering each fiber |\n| `fiberSelfDurations` | Calculated from actual - children | Time excluding child renders |\n| `effectDuration` | `markLayoutEffectsStarted/Stopped()` | Time in useLayoutEffect/useEffect |\n| `passiveEffectDuration` | `markPassiveEffectsStarted/Stopped()` | Time in passive effects only |\n| `priorityLevel` | From scheduler priority | Render priority (UserBlocking, Normal, etc.) |\n| `changeDescriptions` | `recordProfilingDurations()` | Which props/state changed |\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/profilingHooks.js:1-500]()\n- [packages/react-devtools-shared/src/backend/types.js:500-538]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1105-1300]()\n- [packages/react-devtools-shared/src/devtools/ProfilerStore.js:1-200]()\n\n---\n\n## Distribution Channels\n\nReact DevTools is distributed through multiple channels, each with a different architecture:\n\n### Browser Extensions\n\nBrowser extensions use Manifest V3 with a service worker backend:\n\n```mermaid\ngraph TB\n    subgraph "Extension Components"\n        Background["background.js<br/>Service Worker"]\n        ContentScript["prepareInjection.js<br/>Content Script"]\n        DevToolsPage["main.html<br/>DevTools Page"]\n        Panel["panel.html<br/>DevTools Panel"]\n    end\n    \n    subgraph "Injection"\n        Hook["installHook.js<br/>Injected to page"]\n        Backend["backend.js<br/>Injected to page"]\n    end\n    \n    subgraph "Page Context"\n        App["React Application"]\n    end\n    \n    ContentScript -->|"injectScript()"| Hook\n    Hook --> App\n    Background -->|"chrome.scripting.executeScript"| Backend\n    Backend --> App\n    \n    DevToolsPage -->|"chrome.devtools.panels.create"| Panel\n    Panel <-->|"chrome.runtime.connect"| Background\n    Background <-->|"chrome.tabs.sendMessage"| Backend\n```\n\n**Sources:**\n- [packages/react-devtools-extensions/chrome/manifest.json:40-64]()\n- [packages/react-devtools-extensions/firefox/manifest.json:45-69]()\n\nExtension-specific features:\n- Icon changes color based on React build type (dev/prod)\n- Popup warns if React is not detected\n- Integration with browser Elements panel for DOM node selection\n\n**Sources:**\n- [packages/react-devtools-extensions/chrome/manifest.json:14-22]()\n\n### Standalone Application\n\nThe standalone app is an Electron application that starts a local WebSocket server:\n\n```mermaid\ngraph LR\n    subgraph "Electron App"\n        Main["Main Process<br/>bin.js"]\n        Renderer["Renderer Process<br/>app.html"]\n    end\n    \n    subgraph "Local Server"\n        HTTPServer["HTTP Server<br/>(serves hook script)"]\n        WSServer["WebSocket Server<br/>(bridge transport)"]\n    end\n    \n    subgraph "Browser/App"\n        Page["User\'s Application"]\n        BackendScript["<script> from localhost"]\n    end\n    \n    Main --> HTTPServer\n    Main --> WSServer\n    Main --> Renderer\n    \n    Page -->|"GET http://localhost:8097"| HTTPServer\n    HTTPServer -->|"installHook + backend"| BackendScript\n    BackendScript <-->|"WebSocket"| WSServer\n    WSServer <-->|"IPC"| Renderer\n```\n\n**Sources:**\n- [packages/react-devtools/package.json:11-23]()\n- [packages/react-devtools-core/package.json:1-38]()\n\nThe user adds a script tag to their page:\n\n```html\n<script src="http://localhost:8097"></script>\n```\n\nThis loads the hook and backend, which connect back via WebSocket.\n\n**Sources:**\n- [packages/react-devtools-core/]()\n\n### Inline Embedding\n\nThe inline package allows embedding DevTools directly in a web page:\n\n```javascript\nimport {initialize} from \'react-devtools-inline/frontend\';\nimport {activate} from \'react-devtools-inline/backend\';\n\n// In application context\nactivate(window);\n\n// In DevTools UI context\nconst DevTools = initialize(window);\n```\n\nThis is used for demos, playgrounds, and React Native debugging.\n\n**Sources:**\n- [packages/react-devtools-inline/package.json:12-17]()\n\n### React Native Integration\n\nReact Native embeds the DevTools backend and connects via Metro bundler\'s WebSocket connection or custom RN debugging bridge.\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/views/Highlighter/index.js:1-20]()\n\n---\n\n## Data Flow Examples\n\n### Component Tree Update\n\nWhen a component updates, the following flow occurs:\n\n```mermaid\nsequenceDiagram\n    participant React as "React Reconciler"\n    participant Backend as "Backend Renderer"\n    participant Agent\n    participant Bridge\n    participant Store\n    participant UI\n    \n    React->>Backend: commitMutationEffects()\n    Backend->>Backend: updateFiberRecursively()\n    Backend->>Backend: recordMount(fiber) or recordUnmount(fiber)\n    Backend->>Backend: Build operations array\n    Backend->>Agent: flushPendingEvents()\n    Agent->>Bridge: send("operations", operations)\n    Bridge->>Store: emit("operations", operations)\n    Store->>Store: onBridgeOperations()\n    Store->>Store: Update _idToElement, _roots, etc.\n    Store->>Store: emit("mutated", changes)\n    UI->>UI: Re-render tree view\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1426-1600]()\n- [packages/react-devtools-shared/src/backend/agent.js:567-700]()\n- [packages/react-devtools-shared/src/devtools/store.js:1139-1784]()\n\n### Element Inspection Data Flow\n\nWhen a user inspects an element, the full flow spans from the UI click to backend serialization:\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant Tree as "Tree.js"\n    participant TreeContext\n    participant InspectedElementContext\n    participant Bridge\n    participant Agent\n    participant RendererInterface as "fiber/renderer.js"\n    \n    User->>Tree: Click element in tree\n    Tree->>TreeContext: selectElementByID(id)\n    TreeContext->>TreeContext: Set selectedElementID state\n    InspectedElementContext->>InspectedElementContext: useEffect detects selectedElementID change\n    InspectedElementContext->>InspectedElementContext: fetchElement(id, null)\n    InspectedElementContext->>Bridge: send("inspectElement", {id, path: null, requestID, rendererID, forceFullData})\n    Bridge->>Agent: emit("inspectElement", params)\n    Agent->>Agent: Look up rendererInterface by rendererID\n    Agent->>RendererInterface: inspectElement(requestID, id, inspectedPaths, forceFullData)\n    \n    RendererInterface->>RendererInterface: idToDevToolsInstanceMap.get(id)\n    RendererInterface->>RendererInterface: inspectElementRaw(instance, path, forceFullData)\n    RendererInterface->>RendererInterface: Extract fiber.memoizedProps\n    RendererInterface->>RendererInterface: Extract fiber.memoizedState\n    RendererInterface->>RendererInterface: inspectHooksOfFiber(fiber, currentDispatcherRef)\n    RendererInterface->>RendererInterface: dehydrate(props, state, hooks)\n    RendererInterface->>RendererInterface: Build InspectedElement payload\n    RendererInterface->>Agent: Return {type: "full-data", value: InspectedElement}\n    \n    Agent->>Bridge: send("inspectedElement", payload)\n    Bridge->>InspectedElementContext: emit("inspectedElement", payload)\n    InspectedElementContext->>InspectedElementContext: hydrate(payload.value)\n    InspectedElementContext->>Tree: Render updated inspector panel\n    Tree->>User: Display props, state, hooks\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/views/Components/Tree.js:1-500]()\n- [packages/react-devtools-shared/src/devtools/views/Components/TreeContext.js:1-300]()\n- [packages/react-devtools-shared/src/devtools/views/Components/InspectedElementContext.js:1-400]()\n- [packages/react-devtools-shared/src/backend/agent.js:320-330]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:2700-3200]()\n- [packages/react-devtools-shared/src/backendAPI.js:50-200]()\n\n---\n\n## Key Design Decisions\n\n### Why Three-Tier Architecture?\n\nThe separation of backend, bridge, and frontend enables:\n- **Security isolation**: DevTools UI runs in a different context with different privileges\n- **Version independence**: Protocol versioning allows newer backends with older frontends\n- **Multiple transport layers**: Same code works across extensions, standalone, inline, and React Native\n\n### Why Operations Arrays?\n\nCompact numeric arrays minimize serialization overhead:\n- Strings are deduplicated via string table\n- Tree changes encoded as integers\n- No JSON parsing overhead\n- Works well with `postMessage()` structured clone algorithm\n\n**Sources:**\n- [packages/react-devtools-shared/src/utils.js:224-464]()\n\n### Why Dehydration?\n\nLazy loading of nested data:\n- Initial inspection sends shallow representation\n- Deeply nested objects represented as `{inspectable: true}`\n- User expansion triggers path-specific fetch\n- Reduces initial payload size for large component trees\n\n**Sources:**\n- [packages/react-devtools-shared/src/hydration.js:65-250]()\n\n### Why WeakMap for Fiber Tracking?\n\nUsing WeakMaps for `internalInstanceToIDMap` prevents memory leaks:\n- Fibers can be garbage collected without explicit cleanup\n- DevTools doesn\'t hold strong references to unmounted components\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:864-873]()\n\n---\n\n# Page: DevTools Distribution and Integration\n\n# DevTools Distribution and Integration\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [fixtures/devtools/standalone/index.html](fixtures/devtools/standalone/index.html)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-devtools-core/README.md](packages/react-devtools-core/README.md)\n- [packages/react-devtools-core/src/backend.js](packages/react-devtools-core/src/backend.js)\n- [packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js](packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js)\n- [packages/react-devtools-extensions/src/contentScripts/installHook.js](packages/react-devtools-extensions/src/contentScripts/installHook.js)\n- [packages/react-devtools-extensions/src/contentScripts/messages.js](packages/react-devtools-extensions/src/contentScripts/messages.js)\n- [packages/react-devtools-inline/src/backend.js](packages/react-devtools-inline/src/backend.js)\n- [packages/react-devtools-shared/src/__tests__/componentStacks-test.js](packages/react-devtools-shared/src/__tests__/componentStacks-test.js)\n- [packages/react-devtools-shared/src/__tests__/console-test.js](packages/react-devtools-shared/src/__tests__/console-test.js)\n- [packages/react-devtools-shared/src/__tests__/inspectedElement-test.js](packages/react-devtools-shared/src/__tests__/inspectedElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js](packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/setupTests.js](packages/react-devtools-shared/src/__tests__/setupTests.js)\n- [packages/react-devtools-shared/src/__tests__/store-test.js](packages/react-devtools-shared/src/__tests__/store-test.js)\n- [packages/react-devtools-shared/src/attachRenderer.js](packages/react-devtools-shared/src/attachRenderer.js)\n- [packages/react-devtools-shared/src/backend/agent.js](packages/react-devtools-shared/src/backend/agent.js)\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js](packages/react-devtools-shared/src/backend/fiber/renderer.js)\n- [packages/react-devtools-shared/src/backend/legacy/renderer.js](packages/react-devtools-shared/src/backend/legacy/renderer.js)\n- [packages/react-devtools-shared/src/backend/types.js](packages/react-devtools-shared/src/backend/types.js)\n- [packages/react-devtools-shared/src/backend/views/Highlighter/index.js](packages/react-devtools-shared/src/backend/views/Highlighter/index.js)\n- [packages/react-devtools-shared/src/backendAPI.js](packages/react-devtools-shared/src/backendAPI.js)\n- [packages/react-devtools-shared/src/bridge.js](packages/react-devtools-shared/src/bridge.js)\n- [packages/react-devtools-shared/src/devtools/store.js](packages/react-devtools-shared/src/devtools/store.js)\n- [packages/react-devtools-shared/src/devtools/utils.js](packages/react-devtools-shared/src/devtools/utils.js)\n- [packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js](packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js)\n- [packages/react-devtools-shared/src/devtools/views/utils.js](packages/react-devtools-shared/src/devtools/views/utils.js)\n- [packages/react-devtools-shared/src/frontend/types.js](packages/react-devtools-shared/src/frontend/types.js)\n- [packages/react-devtools-shared/src/hook.js](packages/react-devtools-shared/src/hook.js)\n- [packages/react-devtools-shared/src/hydration.js](packages/react-devtools-shared/src/hydration.js)\n- [packages/react-devtools-shared/src/utils.js](packages/react-devtools-shared/src/utils.js)\n- [packages/react-devtools-shell/src/app/ElementTypes/index.js](packages/react-devtools-shell/src/app/ElementTypes/index.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js](packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js](packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js](packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/react/src/ReactForwardRef.js](packages/react/src/ReactForwardRef.js)\n- [packages/react/src/ReactMemo.js](packages/react/src/ReactMemo.js)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes how React DevTools is packaged and distributed across different platforms, and how each distribution integrates with React applications. DevTools exists in multiple formsbrowser extensions, a standalone Electron application, and an embeddable inline libraryall sharing a common backend but using different integration strategies.\n\nFor information about the DevTools architecture and communication protocol between frontend and backend, see [React DevTools Architecture](#7.1).\n\n## Distribution Packages Overview\n\nReact DevTools is published as four distinct npm packages, each serving different use cases:\n\n| Package | Purpose | Primary Use Case |\n|---------|---------|------------------|\n| `react-devtools` | Standalone Electron app | Debugging React Native apps |\n| `react-devtools-core` | Backend and standalone server | Custom integrations, React Native |\n| `react-devtools-inline` | Embeddable frontend + backend | Integrated developer tools in web apps |\n| `react-devtools-extensions` | Browser extensions | Debugging web apps in Chrome, Firefox, Edge |\n\nEach package shares the `react-devtools-shared` codebase but bundles it differently for its target environment.\n\n**Diagram: Distribution Package Architecture**\n\n```mermaid\ngraph TB\n    Shared["react-devtools-shared<br/>(Core functionality)"]\n    \n    subgraph "Distribution Packages"\n        Standalone["react-devtools<br/>Electron app<br/>bin.js, app.js"]\n        Core["react-devtools-core<br/>Backend + Server<br/>backend.js, standalone.js"]\n        Inline["react-devtools-inline<br/>Embeddable<br/>backend.js, frontend.js"]\n        Extensions["react-devtools-extensions<br/>Browser Extensions<br/>Chrome, Firefox, Edge"]\n    end\n    \n    Shared -->|"bundles into"| Standalone\n    Shared -->|"bundles into"| Core\n    Shared -->|"bundles into"| Inline\n    Shared -->|"bundles into"| Extensions\n    \n    subgraph "Build Process"\n        Webpack["Webpack Configurations<br/>webpack.backend.js<br/>webpack.standalone.js<br/>webpack.config.js"]\n    end\n    \n    Webpack -->|"builds"| Standalone\n    Webpack -->|"builds"| Core\n    Webpack -->|"builds"| Inline\n    Webpack -->|"builds"| Extensions\n    \n    subgraph "Target Environments"\n        RN["React Native Apps"]\n        Web["Web Applications"]\n        Browser["Browser DevTools Panel"]\n    end\n    \n    Standalone -->|"connects to"| RN\n    Core -->|"integrates with"| RN\n    Inline -->|"embeds in"| Web\n    Extensions -->|"runs in"| Browser\n```\n\nSources: [packages/react-devtools/package.json:1-32](), [packages/react-devtools-core/package.json:1-38](), [packages/react-devtools-inline/package.json:1-52]()\n\n## Bridge Protocol and Version Compatibility\n\nAll DevTools distributions communicate using a versioned bridge protocol defined in `BRIDGE_PROTOCOL`. This enables graceful handling of version mismatches between frontend and backend.\n\n**Protocol Version Management**\n\nThe bridge protocol uses semantic versioning to track breaking changes:\n\n```mermaid\ngraph LR\n    Frontend["Frontend<br/>(DevTools UI)"]\n    Backend["Backend<br/>(Injected in app)"]\n    Bridge["Bridge Protocol<br/>currentBridgeProtocol"]\n    \n    Frontend -->|"sends/receives messages"| Bridge\n    Backend -->|"sends/receives messages"| Bridge\n    \n    subgraph "Version Checking"\n        V0["Version 0<br/>< 4.11.0"]\n        V1["Version 1<br/>4.13.0 - 4.21.0"]\n        V2["Version 2<br/>4.22.0+<br/>(current)"]\n    end\n    \n    Bridge -->|"version history"| V0\n    Bridge -->|"version history"| V1\n    Bridge -->|"version history"| V2\n    \n    subgraph "Compatibility Checks"\n        UpgradePrompt["Upgrade Prompt<br/>(newer backend)"]\n        DowngradePrompt["Downgrade Prompt<br/>(newer frontend)"]\n    end\n    \n    Frontend -->|"if mismatch"| UpgradePrompt\n    Frontend -->|"if mismatch"| DowngradePrompt\n```\n\nThe protocol version is checked during initialization. Each version includes:\n- `version`: Protocol version number\n- `minNpmVersion`: Minimum compatible npm package version\n- `maxNpmVersion`: Maximum compatible npm package version\n\nWhen incompatibility is detected, the Store sets `_unsupportedBridgeProtocolDetected` and the UI displays an appropriate message.\n\nSources: [packages/react-devtools-shared/src/bridge.js:26-73](), [packages/react-devtools-shared/src/devtools/store.js:254-256]()\n\n## Browser Extensions\n\nBrowser extensions for Chrome, Firefox, and Edge follow Manifest V3 specifications and share most code while adapting to browser-specific APIs.\n\n**Extension Architecture**\n\n```mermaid\ngraph TB\n    subgraph "Extension Components"\n        Background["Background Service Worker<br/>build/background.js"]\n        ContentScript["Content Script<br/>build/prepareInjection.js<br/>(runs at document_start)"]\n        DevToolsPage["DevTools Page<br/>main.html"]\n        Panel["DevTools Panel<br/>panel.html"]\n        Popup["Action Popup<br/>popups/disabled.html"]\n    end\n    \n    subgraph "Injection Process"\n        Hook["Global Hook Script<br/>installHook()"]\n        Backend["Backend Renderer<br/>renderer.js"]\n    end\n    \n    subgraph "Target Page"\n        ReactApp["React Application<br/>window.__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n    end\n    \n    ContentScript -->|"injects"| Hook\n    Hook -->|"installed on"| ReactApp\n    Backend -->|"connects to"| ReactApp\n    \n    Background -->|"manages"| ContentScript\n    DevToolsPage -->|"creates"| Panel\n    Panel -->|"loads"| Backend\n    \n    Panel <-->|"Bridge messages"| Backend\n```\n\n**Manifest Structure**\n\nEach browser has a slightly different manifest configuration:\n\n| Property | Chrome/Edge | Firefox | Purpose |\n|----------|-------------|---------|---------|\n| `manifest_version` | 3 | 3 | Manifest V3 for all browsers |\n| `background` | `service_worker` | `scripts` | Background script execution model |\n| `permissions` | tabs, storage, scripting | tabs, storage, scripting, clipboardWrite | Required permissions |\n| `optional_permissions` | clipboardWrite | - | User-granted permissions |\n| `browser_specific_settings` | - | gecko.id, strict_min_version | Firefox-specific metadata |\n\n**Content Script Injection**\n\nThe extension injects `prepareInjection.js` at `document_start` to ensure the global hook is available before React loads:\n\n1. Content script runs immediately when page loads\n2. Injects the global hook into the page context\n3. The hook intercepts React renderer registrations\n4. When DevTools panel opens, backend connects to hook\n\nSources: [packages/react-devtools-extensions/chrome/manifest.json:1-65](), [packages/react-devtools-extensions/firefox/manifest.json:1-70](), [packages/react-devtools-extensions/edge/manifest.json:1-65]()\n\n## Standalone Electron Application\n\nThe `react-devtools` package provides a standalone Electron application for debugging React Native applications.\n\n**Package Structure**\n\n```mermaid\ngraph TB\n    subgraph "react-devtools Package"\n        Bin["bin.js<br/>(CLI entry point)"]\n        App["app.js<br/>(Main process)"]\n        AppHTML["app.html<br/>(Renderer process)"]\n        Preload["preload.js<br/>(Preload script)"]\n    end\n    \n    subgraph "Dependencies"\n        Electron["electron ^23.1.2"]\n        Core["react-devtools-core"]\n        InternalIP["internal-ip<br/>(Network detection)"]\n        UpdateNotifier["update-notifier<br/>(Version checks)"]\n    end\n    \n    Bin -->|"spawns"| Electron\n    Electron -->|"loads"| App\n    App -->|"creates window with"| AppHTML\n    App -->|"configures"| Preload\n    \n    Core -->|"provides backend"| App\n    InternalIP -->|"detects IP for"| App\n    UpdateNotifier -->|"checks version"| Bin\n    \n    subgraph "Connection Modes"\n        WebSocket["WebSocket Server<br/>(Default port 8097)"]\n        ReactNative["React Native App<br/>connects via ws://"]\n    end\n    \n    Core -->|"starts"| WebSocket\n    ReactNative -->|"connects to"| WebSocket\n```\n\n**Startup Flow**\n\nWhen running `react-devtools` from the command line:\n\n1. `bin.js` checks for updates via `update-notifier`\n2. Spawns Electron with `app.js` as entry point\n3. `app.js` starts a WebSocket server using `react-devtools-core`\n4. Creates Electron window loading `app.html`\n5. React Native app connects to WebSocket server\n6. Frontend and backend communicate over WebSocket bridge\n\n**Command-Line Options**\n\nThe standalone app supports these options:\n- `--port`: WebSocket server port (default: 8097)\n- `--host`: Host to bind to (default: localhost)\n- `--https`: Use HTTPS for secure connections\n- `--react-devtools-port`: Alternative port specification\n\nSources: [packages/react-devtools/package.json:1-32](), [packages/react-devtools-core/package.json:1-38]()\n\n## Inline Embeddable Library\n\nThe `react-devtools-inline` package enables embedding DevTools directly into web applications, useful for development environments and internal tools.\n\n**Package Exports**\n\n```mermaid\ngraph LR\n    subgraph "react-devtools-inline Exports"\n        Backend["backend.js<br/>(Backend bundle)"]\n        Frontend["frontend.js<br/>(Frontend UI bundle)"]\n        HookNames["hookNames.js<br/>(Hook name resolution)"]\n    end\n    \n    subgraph "Build Artifacts"\n        BackendBundle["dist/backend.js<br/>(Webpack bundle)"]\n        FrontendBundle["dist/frontend.js<br/>(Webpack bundle)"]\n    end\n    \n    Backend -->|"exports from"| BackendBundle\n    Frontend -->|"exports from"| FrontendBundle\n    \n    subgraph "Usage Pattern"\n        InitBackend["initialize(contentWindow,<br/>{ bridge, store })"]\n        CreateFrontend["createRoot(container).render(<br/>DevTools bridge={bridge} store={store} />)"]\n    end\n    \n    Backend -->|"provides"| InitBackend\n    Frontend -->|"provides"| CreateFrontend\n    \n    subgraph "Communication"\n        Wall["Wall<br/>(Message passing abstraction)"]\n        BridgeInline["FrontendBridge + BackendBridge"]\n    end\n    \n    InitBackend -->|"uses"| Wall\n    CreateFrontend -->|"uses"| Wall\n    Wall -->|"implements"| BridgeInline\n```\n\n**Integration Example**\n\nTo embed DevTools inline:\n\n```javascript\n// Backend initialization (in target iframe/window)\nimport {initialize as initBackend} from \'react-devtools-inline/backend\';\n\n// Frontend rendering (in host page)\nimport {initialize as initFrontend} from \'react-devtools-inline/frontend\';\nimport {createRoot} from \'react-dom/client\';\n\n// Create bridges\nconst wall = {\n  listen(listener) { /* handle messages */ },\n  send(event, payload) { /* send messages */ }\n};\n\n// Initialize backend in target window\ninitBackend(targetWindow, { wall });\n\n// Render frontend\nconst {bridge, store} = initFrontend(wall);\nconst container = document.getElementById(\'devtools\');\ncreateRoot(container).render(<DevTools bridge={bridge} store={store} />);\n```\n\nThe inline library bundles all shared code into self-contained artifacts that can be loaded independently.\n\nSources: [packages/react-devtools-inline/package.json:1-52]()\n\n## Core Library for Custom Integrations\n\nThe `react-devtools-core` package provides the backend and a standalone server for custom DevTools integrations, primarily used by React Native.\n\n**Package Exports and Build Targets**\n\n```mermaid\ngraph TB\n    subgraph "react-devtools-core"\n        MainExport["main: ./dist/backend.js"]\n        BackendJS["backend.js"]\n        StandaloneJS["standalone.js"]\n    end\n    \n    subgraph "Build Scripts"\n        BuildBackend["build:backend<br/>webpack.backend.js"]\n        BuildBackendFB["build:backend:fb<br/>FEATURE_FLAG_TARGET=core/backend-fb"]\n        BuildStandalone["build:standalone<br/>webpack.standalone.js"]\n        BuildStandaloneFB["build:standalone:fb<br/>FEATURE_FLAG_TARGET=core/standalone-fb"]\n    end\n    \n    BuildBackend -->|"produces"| BackendJS\n    BuildBackendFB -->|"produces"| BackendJS\n    BuildStandalone -->|"produces"| StandaloneJS\n    BuildStandaloneFB -->|"produces"| StandaloneJS\n    \n    subgraph "Feature Flag Targeting"\n        CoreBackend["Core Backend<br/>(OSS)"]\n        CoreBackendFB["Core Backend FB<br/>(Internal)"]\n        CoreStandalone["Core Standalone<br/>(OSS)"]\n        CoreStandaloneFB["Core Standalone FB<br/>(Internal)"]\n    end\n    \n    BuildBackend -->|"targets"| CoreBackend\n    BuildBackendFB -->|"targets"| CoreBackendFB\n    BuildStandalone -->|"targets"| CoreStandalone\n    BuildStandaloneFB -->|"targets"| CoreStandaloneFB\n    \n    subgraph "Dependencies"\n        WS["ws ^7<br/>(WebSocket)"]\n        ShellQuote["shell-quote ^1.6.1<br/>(Command parsing)"]\n    end\n    \n    StandaloneJS -->|"uses"| WS\n    StandaloneJS -->|"uses"| ShellQuote\n```\n\n**Integration Modes**\n\nThe core library supports two integration modes:\n\n1. **Backend-only**: Import `backend.js` to inject the backend into a custom environment\n2. **Standalone server**: Import `standalone.js` to start a WebSocket server for remote connections\n\n**WebSocket Server API**\n\nThe standalone server exposes these methods:\n\n```javascript\nimport {initialize} from \'react-devtools-core/standalone\';\n\nconst server = await initialize({\n  port: 8097,\n  host: \'localhost\',\n  httpsOptions: null, // Optional TLS config\n  onDisconnect: () => { /* cleanup */ },\n  onError: (error) => { /* error handling */ }\n});\n\n// Server provides:\n// - server.close() - Stop the server\n// - server.port - Actual port (useful for port 0)\n```\n\nReact Native integrates by connecting to this WebSocket server during development.\n\nSources: [packages/react-devtools-core/package.json:1-38]()\n\n## Backend Injection Mechanisms\n\nThe DevTools backend must be injected into the target application before React loads. Different distributions use different injection strategies.\n\n**Injection Strategies by Distribution**\n\n```mermaid\ngraph TB\n    subgraph "Browser Extensions"\n        ExtContentScript["Content Script<br/>document_start"]\n        ExtInject["Script Injection<br/>(inline script tag)"]\n        ExtHook["Global Hook Installation<br/>window.__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        \n        ExtContentScript -->|"injects"| ExtInject\n        ExtInject -->|"installs"| ExtHook\n    end\n    \n    subgraph "Standalone/Core"\n        WSServer["WebSocket Server"]\n        RNClient["React Native Client<br/>setupDevtools()"]\n        RNHook["Native Hook<br/>(RN DevTools integration)"]\n        \n        WSServer -->|"awaits connection"| RNClient\n        RNClient -->|"installs"| RNHook\n    end\n    \n    subgraph "Inline"\n        InlineInit["initialize(window)"]\n        InlineHook["Direct Hook Install<br/>(same context)"]\n        \n        InlineInit -->|"installs"| InlineHook\n    end\n    \n    subgraph "React Application"\n        ReactRenderer["React Renderer<br/>reconcilerVersion"]\n        RendererDetection["Renderer Detection<br/>hook.renderers.set(id, renderer)"]\n        BackendBridge["BackendBridge<br/>operations, events"]\n        \n        ExtHook -->|"detects"| ReactRenderer\n        RNHook -->|"detects"| ReactRenderer\n        InlineHook -->|"detects"| ReactRenderer\n        \n        ReactRenderer -->|"registers with"| RendererDetection\n        RendererDetection -->|"creates"| BackendBridge\n    end\n```\n\n**Global Hook Interface**\n\nAll injection mechanisms install a global hook with this interface:\n\n```javascript\nwindow.__REACT_DEVTOOLS_GLOBAL_HOOK__ = {\n  renderers: Map<RendererID, ReactRenderer>,\n  supportsFiber: true,\n  inject(renderer) { /* called by React */ },\n  onCommitFiberRoot(rendererID, root, priorityLevel) { /* fiber commits */ },\n  onCommitFiberUnmount(rendererID, fiber) { /* fiber unmounts */ },\n  // Backend connection\n  backends: Map<RendererID, RendererInterface>,\n  // Settings from DevTools\n  settings: DevToolsHookSettings\n}\n```\n\nThe hook must be installed synchronously before React loads to intercept renderer registration.\n\n**Backend Initialization Sequence**\n\n```mermaid\nsequenceDiagram\n    participant Hook as Global Hook\n    participant React as React Renderer\n    participant Backend as DevTools Backend\n    participant Agent as Agent\n    participant Bridge as Bridge\n    \n    Note over Hook: 1. Hook installed<br/>(before React loads)\n    \n    React->>Hook: inject(renderer)\n    Hook->>Hook: renderers.set(id, renderer)\n    \n    Note over Backend: 2. Backend connects<br/>(when DevTools opens)\n    \n    Backend->>Hook: Check hook.renderers\n    Backend->>Agent: Create Agent(bridge)\n    \n    loop For each renderer\n        Backend->>Backend: attach(renderer, rendererID)\n        Backend->>Agent: Add RendererInterface\n    end\n    \n    Agent->>Bridge: Send \'operations\' messages\n    Bridge->>Agent: Receive commands\n    \n    Note over React,Backend: 3. Ongoing communication\n    \n    React->>Hook: onCommitFiberRoot(id, root)\n    Hook->>Backend: Forward to backend\n    Backend->>Agent: Process commit\n    Agent->>Bridge: Send tree operations\n```\n\nThe backend uses `Agent` to coordinate multiple `RendererInterface` instances (one per React renderer) and communicate with the frontend via the `Bridge`.\n\nSources: [packages/react-devtools-shared/src/backend/fiber/renderer.js:1007-1014](), [packages/react-devtools-shared/src/backend/agent.js:1-694]()\n\n## Settings and Configuration\n\nDevTools settings can be configured in two places:\n\n1. **Hook Settings**: Injected before React loads via `window.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings`\n2. **Frontend Settings**: Stored in localStorage and synchronized via bridge\n\n**Settings Flow**\n\n```mermaid\ngraph TB\n    subgraph "Settings Sources"\n        HookSettings["Hook Settings<br/>window.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings"]\n        LocalStorage["localStorage<br/>React::DevTools::*"]\n        EnvVars["Environment Variables<br/>process.env.EDITOR_URL"]\n    end\n    \n    subgraph "Backend"\n        BackendInit["Backend Initialization<br/>reads hook.settings"]\n        BackendAgent["Agent<br/>_hookSettings"]\n    end\n    \n    subgraph "Frontend"\n        Store["Store<br/>componentFilters,<br/>collapseNodesByDefault"]\n        SettingsContext["SettingsContext<br/>UI preferences"]\n    end\n    \n    HookSettings -->|"read at init"| BackendInit\n    BackendInit -->|"stores in"| BackendAgent\n    BackendAgent -->|"sends \'hookSettings\'"| Store\n    \n    LocalStorage -->|"loads into"| Store\n    LocalStorage -->|"loads into"| SettingsContext\n    EnvVars -->|"default values"| SettingsContext\n    \n    Store -->|"persists to"| LocalStorage\n    SettingsContext -->|"persists to"| LocalStorage\n```\n\n**Configurable Settings**\n\nKey settings and their storage locations:\n\n| Setting | Storage | Default | Purpose |\n|---------|---------|---------|---------|\n| `componentFilters` | localStorage | `[{type: ElementType, isEnabled: true}]` | Component tree filtering |\n| `collapseNodesByDefault` | localStorage | `true` | Auto-collapse tree nodes |\n| `recordChangeDescriptions` | localStorage | `false` | Profile change descriptions |\n| `EDITOR_URL` | process.env | `\'vscode://file/{path}:{line}:{column}\'` | Open in editor URL pattern |\n| `appendComponentStack` | hook.settings | varies | Append stacks to console |\n| `breakOnConsoleErrors` | hook.settings | varies | Break on console.error |\n| `showInlineWarningsAndErrors` | hook.settings | varies | Display inline errors |\n| `hideConsoleLogsInStrictMode` | hook.settings | varies | Dim duplicate logs |\n\nSettings can be provided at backend initialization time:\n\n```javascript\nimport {installHook} from \'react-devtools-core/backend\';\n\ninstallHook(window, {\n  appendComponentStack: true,\n  breakOnConsoleErrors: false,\n  showInlineWarningsAndErrors: true,\n  hideConsoleLogsInStrictMode: true\n});\n```\n\nSources: [packages/react-devtools-shared/src/backend/types.js:519-534](), [packages/react-devtools-shared/src/devtools/store.js:273-320](), [packages/react-devtools-shared/src/devtools/views/Settings/SettingsContext.js:1-196]()\n\n## Distribution File Sizes and Dependencies\n\nEach distribution has different size constraints and dependency requirements:\n\n**Package Dependencies**\n\n| Package | Runtime Dependencies | Dev Dependencies | Key External Deps |\n|---------|---------------------|------------------|-------------------|\n| `react-devtools` | electron, react-devtools-core, internal-ip | - | Large (Electron app) |\n| `react-devtools-core` | ws, shell-quote | webpack, workerize-loader | Minimal |\n| `react-devtools-inline` | @jridgewell/sourcemap-codec, source-map-js | webpack, babel, playwright | Medium |\n| `react-devtools-extensions` | - | webpack, babel | None (bundled) |\n\n**Build Artifact Sizes** (approximate):\n\n- Browser extensions: ~1-2 MB bundled\n- Standalone app: ~100 MB (includes Electron)\n- Core backend: ~500 KB bundled\n- Inline library: ~1 MB (frontend + backend)\n\nExtensions must minimize bundle size as Chrome Web Store has size limits. The build process uses Closure Compiler for production builds to aggressively minify and tree-shake.\n\nSources: [packages/react-devtools/package.json:24-30](), [packages/react-devtools-core/package.json:27-37](), [packages/react-devtools-inline/package.json:24-51]()\n\n---\n\n# Page: ESLint Plugin for React Hooks\n\n# ESLint Plugin for React Hooks\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\nThe ESLint plugin for React Hooks (`eslint-plugin-react-hooks`) is a static analysis tool that enforces the Rules of Hooksthe constraints that govern how React Hooks must be called to ensure correct behavior. The plugin provides two primary rules: `rules-of-hooks` validates that Hooks are only called at the top level of React function components or custom Hooks, and `exhaustive-deps` ensures that effect dependencies are correctly declared.\n\nFor information about the Hooks system implementation itself, see [React Hooks System](#4.3). For DevTools integration with Hooks inspection, see [React DevTools Architecture](#7.1).\n\n---\n\n## Purpose and Scope\n\nThe plugin statically analyzes JavaScript and TypeScript code to detect violations of Hook calling conventions before runtime. It prevents common mistakes such as conditional Hook calls, Hook calls inside loops, or missing effect dependencies that would cause bugs or inconsistent behavior. The plugin integrates directly into the ESLint workflow and supports modern JavaScript syntax including JSX, TypeScript, and Flow.\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:1-68]()\n\n---\n\n## Package Structure and Distribution\n\n```mermaid\ngraph TB\n    subgraph "Package Distribution"\n        PackageJSON["eslint-plugin-react-hooks<br/>package.json"]\n        IndexJS["index.js<br/>Main entry point"]\n        IndexDTS["index.d.ts<br/>TypeScript definitions"]\n        CJSDir["cjs/<br/>Compiled CommonJS"]\n    end\n    \n    subgraph "Source Code (TypeScript)"\n        SrcDir["src/<br/>TypeScript source"]\n        RulesOfHooks["RulesOfHooks.ts<br/>Top-level call validation"]\n        ExhaustiveDeps["ExhaustiveDeps.ts<br/>Dependency validation"]\n    end\n    \n    subgraph "Build Process"\n        TSCompile["TypeScript Compiler"]\n        TSConfig["tsconfig.json"]\n    end\n    \n    subgraph "Dependencies"\n        BabelCore["@babel/core<br/>Parser infrastructure"]\n        BabelParser["@babel/parser<br/>JavaScript parsing"]\n        HermesParser["hermes-parser<br/>Alternative parser"]\n        Zod["zod<br/>Schema validation"]\n    end\n    \n    SrcDir --> TSCompile\n    TSConfig --> TSCompile\n    TSCompile --> CJSDir\n    CJSDir --> IndexJS\n    \n    RulesOfHooks -.part of.-> SrcDir\n    ExhaustiveDeps -.part of.-> SrcDir\n    \n    IndexJS --> PackageJSON\n    IndexDTS --> PackageJSON\n    \n    BabelCore -.required by.-> IndexJS\n    BabelParser -.required by.-> IndexJS\n    HermesParser -.required by.-> IndexJS\n    Zod -.required by.-> IndexJS\n```\n\n**Distribution Format**\n\nThe plugin is distributed as an npm package with the following structure:\n\n| File/Directory | Purpose |\n|----------------|---------|\n| `index.js` | Main entry point that exports the plugin configuration |\n| `index.d.ts` | TypeScript type definitions for IDE integration |\n| `cjs/` | Compiled CommonJS modules from TypeScript source |\n| `package.json` | Package metadata with peer dependency on ESLint 3.x-9.x |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:1-68]()\n\n---\n\n## Integration with React Repository\n\nThe React repository uses the plugin in two distinct ways:\n\n```mermaid\ngraph TB\n    subgraph "React Repository ESLint Setup"\n        RootESLint[".eslintrc.js<br/>Root configuration"]\n        \n        subgraph "Plugin Usage"\n            PublishedPlugin["eslint-plugin-react-hooks-published<br/>npm:eslint-plugin-react-hooks@^5.2.0"]\n            InternalPlugin["eslint-plugin-react-internal<br/>link:./scripts/eslint-rules"]\n        end\n        \n        subgraph "Applied To"\n            DevToolsCode["react-devtools*/**/*.js<br/>DevTools packages"]\n            PluginSource["packages/eslint-plugin-react-hooks/src/**/*<br/>Plugin\'s own TypeScript code"]\n        end\n    end\n    \n    subgraph "Rule Application"\n        RulesOfHooksRule["rules-of-hooks: ERROR<br/>Enforces Hook calling rules"]\n        TSESLintRules["@typescript-eslint rules<br/>For plugin source code"]\n    end\n    \n    RootESLint --> PublishedPlugin\n    RootESLint --> InternalPlugin\n    \n    PublishedPlugin --> DevToolsCode\n    RulesOfHooksRule --> DevToolsCode\n    \n    PluginSource --> TSESLintRules\n```\n\n**Configuration Override for DevTools**\n\nThe plugin is explicitly enabled for DevTools code to catch Hook violations:\n\n```javascript\n// .eslintrc.js lines 522-528\n{\n  files: [\'packages/react-devtools-*/**/*.js\'],\n  excludedFiles: \'**/__tests__/**/*.js\',\n  plugins: [\'eslint-plugin-react-hooks-published\'],\n  rules: {\n    \'react-hooks-published/rules-of-hooks\': ERROR,\n  },\n}\n```\n\n**Configuration Override for Plugin Source**\n\nThe plugin\'s own TypeScript source code has specialized linting configuration:\n\n```javascript\n// .eslintrc.js lines 530-548\n{\n  files: [\'packages/eslint-plugin-react-hooks/src/**/*\'],\n  extends: [\'plugin:@typescript-eslint/recommended\'],\n  parser: \'@typescript-eslint/parser\',\n  plugins: [\'@typescript-eslint\', \'eslint-plugin\'],\n  rules: {\n    \'@typescript-eslint/no-explicit-any\': OFF,\n    \'@typescript-eslint/no-non-null-assertion\': OFF,\n    \'@typescript-eslint/array-type\': [ERROR, {default: \'generic\'}],\n    \'es/no-optional-chaining\': OFF,\n    \'eslint-plugin/prefer-object-rule\': ERROR,\n    \'eslint-plugin/require-meta-fixable\': [ERROR, {catchNoFixerButFixableProperty: true}],\n    \'eslint-plugin/require-meta-has-suggestions\': ERROR,\n  },\n}\n```\n\n**Sources:** [.eslintrc.js:522-548](), [package.json:74-75]()\n\n---\n\n## Core Rules\n\nThe plugin exports two primary ESLint rules:\n\n### rules-of-hooks\n\nValidates that Hooks follow the calling conventions required for correct operation:\n\n| Validation | Description |\n|------------|-------------|\n| **Top-level only** | Hooks must not be called inside loops, conditions, or nested functions |\n| **React functions only** | Hooks must be called from React function components or custom Hooks |\n| **Consistent order** | The order of Hook calls must remain constant across renders |\n\n### exhaustive-deps\n\nEnsures that effect Hooks declare all dependencies correctly:\n\n| Validation | Description |\n|------------|-------------|\n| **Complete dependency list** | All reactive values used inside effects must be in the dependency array |\n| **No unnecessary dependencies** | Warns about dependencies that don\'t need to be in the array |\n| **Stable references** | Detects when dependencies change on every render |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:1-68]()\n\n---\n\n## Parser Support and AST Analysis\n\nThe plugin supports multiple JavaScript parsers to handle different syntax variants:\n\n```mermaid\ngraph LR\n    subgraph "Input Code"\n        JSX["JSX<br/>React components"]\n        TS["TypeScript<br/>Type annotations"]\n        Flow["Flow<br/>Type annotations"]\n        HermesCode["Hermes<br/>React Native syntax"]\n    end\n    \n    subgraph "Parser Selection"\n        BabelParser["@babel/parser<br/>Default JavaScript/JSX/TS"]\n        HermesParser["hermes-parser<br/>React Native specific"]\n        ESLintParser["ESLint configured parser<br/>From ESLint config"]\n    end\n    \n    subgraph "AST Processing"\n        ASTNodes["AST Node Types<br/>CallExpression, Identifier, etc."]\n        Visitors["ESLint Rule Visitors<br/>Traverse and analyze"]\n    end\n    \n    subgraph "Rule Logic"\n        CallSiteAnalysis["Hook Call Site Detection<br/>Find use* calls"]\n        ScopeAnalysis["Scope Analysis<br/>Determine function context"]\n        DependencyTracking["Dependency Tracking<br/>Track reactive values"]\n    end\n    \n    JSX --> BabelParser\n    TS --> BabelParser\n    Flow --> BabelParser\n    HermesCode --> HermesParser\n    \n    BabelParser --> ASTNodes\n    HermesParser --> ASTNodes\n    ESLintParser --> ASTNodes\n    \n    ASTNodes --> Visitors\n    Visitors --> CallSiteAnalysis\n    Visitors --> ScopeAnalysis\n    Visitors --> DependencyTracking\n```\n\n**Parser Dependencies**\n\n| Package | Version | Purpose |\n|---------|---------|---------|\n| `@babel/core` | ^7.24.4 | Core transformation infrastructure |\n| `@babel/parser` | ^7.24.4 | JavaScript/JSX/TypeScript parsing |\n| `hermes-parser` | ^0.25.1 | React Native and Flow syntax support |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:41-46]()\n\n---\n\n## Schema Validation with Zod\n\nThe plugin uses Zod for validating rule options and configurations:\n\n```mermaid\ngraph TB\n    subgraph "Rule Configuration Input"\n        UserConfig["User-provided ESLint config<br/>{rules: {...}}"]\n        RuleOptions["Rule-specific options<br/>Arrays or objects"]\n    end\n    \n    subgraph "Zod Schema Validation"\n        ZodSchema["Zod Schema Definitions<br/>Type-safe validation"]\n        ValidationError["zod-validation-error<br/>User-friendly error messages"]\n    end\n    \n    subgraph "Validated Output"\n        TypedOptions["Typed Rule Options<br/>Safe to use in rule logic"]\n        ErrorMessages["Validation Error Messages<br/>Displayed to user"]\n    end\n    \n    UserConfig --> RuleOptions\n    RuleOptions --> ZodSchema\n    ZodSchema --> TypedOptions\n    ZodSchema --> ValidationError\n    ValidationError --> ErrorMessages\n```\n\n**Validation Benefits**\n\n- **Type Safety**: Rule options are validated against schemas before use\n- **Clear Error Messages**: `zod-validation-error` converts Zod errors to readable ESLint diagnostics\n- **Runtime Guarantees**: Invalid configurations are caught early with helpful feedback\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:45-46]()\n\n---\n\n## Testing Infrastructure\n\n```mermaid\ngraph TB\n    subgraph "Test Organization"\n        TestDir["__tests__/<br/>Test files"]\n        RulesTests["RulesOfHooks.test.ts<br/>Hook calling rule tests"]\n        DepsTests["ExhaustiveDeps.test.ts<br/>Dependency rule tests"]\n    end\n    \n    subgraph "Test Framework"\n        Jest["Jest ^29.5.0<br/>Test runner"]\n        BabelCompiler["@babel/preset-typescript<br/>Compile tests"]\n    end\n    \n    subgraph "Test Utilities"\n        ESLintTester["ESLint RuleTester<br/>Rule testing API"]\n        ParserVariants["Multiple Parser Tests<br/>Babel, TypeScript ESLint, etc."]\n    end\n    \n    subgraph "Test Coverage"\n        ValidCases["Valid Code Examples<br/>Should not trigger errors"]\n        InvalidCases["Invalid Code Examples<br/>Should report violations"]\n        EdgeCases["Edge Cases<br/>Complex scenarios"]\n    end\n    \n    TestDir --> RulesTests\n    TestDir --> DepsTests\n    \n    RulesTests --> Jest\n    DepsTests --> Jest\n    \n    Jest --> BabelCompiler\n    Jest --> ESLintTester\n    \n    ESLintTester --> ParserVariants\n    ParserVariants --> ValidCases\n    ParserVariants --> InvalidCases\n    ParserVariants --> EdgeCases\n```\n\n**Test Execution**\n\nThe plugin\'s test suite is run with:\n\n```bash\n# packages/eslint-plugin-react-hooks/package.json lines 23-26\n"scripts": {\n  "build:compiler": "cd ../../compiler && yarn workspace babel-plugin-react-compiler build",\n  "test": "yarn build:compiler && jest",\n  "typecheck": "tsc --noEmit"\n}\n```\n\n**Parser Compatibility Testing**\n\nThe test suite validates behavior across multiple ESLint parser configurations:\n\n| Parser | Package | Use Case |\n|--------|---------|----------|\n| `babel-eslint` | ^10.0.3 | Legacy Babel parser |\n| `@typescript-eslint/parser` v2-v5 | Multiple versions | TypeScript files across ESLint versions |\n| `eslint` v7-v9 | Multiple versions | Compatibility with different ESLint versions |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:23-26,48-66]()\n\n---\n\n## Build and Compilation Process\n\n```mermaid\ngraph LR\n    subgraph "Source Files"\n        TSSource["src/**/*.ts<br/>TypeScript source"]\n        TSConfig["tsconfig.json<br/>TypeScript config"]\n    end\n    \n    subgraph "Compilation"\n        TypeScript["tsc<br/>TypeScript compiler"]\n        StrictConfig["@tsconfig/strictest<br/>Strict type checking"]\n    end\n    \n    subgraph "Output"\n        CJSOutput["cjs/<br/>CommonJS modules"]\n        DTS["*.d.ts<br/>Type definitions"]\n    end\n    \n    subgraph "Package Artifacts"\n        IndexJS["index.js<br/>Exports rules"]\n        IndexDTS["index.d.ts<br/>Type definitions"]\n    end\n    \n    TSSource --> TypeScript\n    TSConfig --> TypeScript\n    StrictConfig -.configures.-> TypeScript\n    \n    TypeScript --> CJSOutput\n    TypeScript --> DTS\n    \n    CJSOutput --> IndexJS\n    DTS --> IndexDTS\n```\n\n**TypeScript Configuration**\n\nThe plugin uses strict TypeScript settings for type safety:\n\n```typescript\n// Configured via @tsconfig/strictest\n{\n  "extends": "@tsconfig/strictest",\n  // Strict null checks, no implicit any, etc.\n}\n```\n\n**Compilation Command**\n\n```bash\n# TypeScript check without emitting\n"typecheck": "tsc --noEmit"\n```\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:26,52]()\n\n---\n\n## Version Compatibility and Peer Dependencies\n\n| Component | Version Range | Notes |\n|-----------|---------------|-------|\n| **Node.js** | >=18 | Minimum required version |\n| **ESLint** | ^3.0.0 \\|\\| ^4.0.0 \\|\\| ^5.0.0 \\|\\| ^6.0.0 \\|\\| ^7.0.0 \\|\\| ^8.0.0-0 \\|\\| ^9.0.0 | Supports all modern ESLint versions |\n| **Zod** | ^3.25.0 \\|\\| ^4.0.0 | Schema validation library |\n| **React** (indirect) | Any version with Hooks (16.8+) | Plugin works with any React version that supports Hooks |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:34-46]()\n\n---\n\n## Integration with Build System\n\nThe plugin is integrated into the React repository\'s build and validation workflow:\n\n```mermaid\ngraph TB\n    subgraph "Developer Workflow"\n        CodeChange["Developer modifies code"]\n        GitCommit["Git commit"]\n    end\n    \n    subgraph "Lint Stage"\n        ESLintRun["yarn lint<br/>node ./scripts/tasks/eslint.js"]\n        PluginExecution["ESLint runs react-hooks plugin"]\n    end\n    \n    subgraph "Build Stage"\n        BuildAll["yarn build<br/>node ./scripts/rollup/build-all-release-channels.js"]\n        BuildValidation["yarn lint-build<br/>node ./scripts/rollup/validate/index.js"]\n    end\n    \n    subgraph "Test Stage"\n        TestRun["yarn test<br/>node ./scripts/jest/jest-cli.js"]\n        PluginTests["yarn test in eslint-plugin-react-hooks"]\n    end\n    \n    CodeChange --> GitCommit\n    GitCommit --> ESLintRun\n    ESLintRun --> PluginExecution\n    \n    PluginExecution --> BuildAll\n    BuildAll --> BuildValidation\n    \n    BuildValidation --> TestRun\n    TestRun --> PluginTests\n```\n\n**Lint Command**\n\nThe repository\'s lint script applies ESLint (including the Hooks plugin) to all source files:\n\n```bash\n# package.json line 134\n"lint": "node ./scripts/tasks/eslint.js"\n```\n\n**Sources:** [package.json:134-135](), [.eslintrc.js:522-548]()\n\n---\n\n## Rule Enforcement in Different Environments\n\nThe plugin\'s rules are selectively applied based on the code environment:\n\n| Environment | Rule Application | Configuration |\n|-------------|------------------|---------------|\n| **DevTools packages** | `rules-of-hooks` enforced | [.eslintrc.js:522-528]() |\n| **Core React packages** | Not explicitly enabled in config | Developers expected to know Hook rules |\n| **Test files** | Excluded from `react-devtools-*` enforcement | `excludedFiles: \'**/__tests__/**/*.js\'` |\n| **Plugin source code** | TypeScript ESLint rules only | [.eslintrc.js:530-548]() |\n\n**Rationale for Selective Application**\n\n- DevTools uses Hooks extensively and benefits from automated checking\n- Core React packages are authored by developers intimately familiar with Hook rules\n- Test files may intentionally violate Hook rules to test error handling\n\n**Sources:** [.eslintrc.js:522-548]()\n\n---\n\n## Relationship to React Compiler\n\nThe plugin\'s test infrastructure coordinates with the React Compiler (Babel plugin):\n\n```bash\n# packages/eslint-plugin-react-hooks/package.json lines 24-25\n"build:compiler": "cd ../../compiler && yarn workspace babel-plugin-react-compiler build",\n"test": "yarn build:compiler && jest"\n```\n\n**Compiler Integration**\n\nThe React Compiler automatically memoizes components and values, potentially affecting how dependency arrays should be specified. The ESLint plugin\'s tests ensure compatibility with compiler-transformed code.\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:24-25]()\n\n---\n\n## Development and Contribution Workflow\n\n```mermaid\ngraph TB\n    subgraph "Local Development"\n        CloneRepo["Clone facebook/react"]\n        InstallDeps["yarn install"]\n        NavigatePlugin["cd packages/eslint-plugin-react-hooks"]\n    end\n    \n    subgraph "Making Changes"\n        EditSource["Edit src/*.ts files"]\n        RunTests["yarn test"]\n        TypeCheck["yarn typecheck"]\n    end\n    \n    subgraph "Integration Testing"\n        LinkPlugin["Test in consuming project"]\n        YarnLink["yarn link eslint-plugin-react-hooks"]\n    end\n    \n    subgraph "Pull Request"\n        CommitChanges["Commit changes"]\n        CIValidation["CI runs full test suite"]\n        ReviewMerge["Code review and merge"]\n    end\n    \n    CloneRepo --> InstallDeps\n    InstallDeps --> NavigatePlugin\n    NavigatePlugin --> EditSource\n    \n    EditSource --> RunTests\n    EditSource --> TypeCheck\n    \n    RunTests --> LinkPlugin\n    TypeCheck --> LinkPlugin\n    \n    LinkPlugin --> YarnLink\n    YarnLink --> CommitChanges\n    \n    CommitChanges --> CIValidation\n    CIValidation --> ReviewMerge\n```\n\n**Local Development Commands**\n\n```bash\n# Run the plugin\'s test suite\ncd packages/eslint-plugin-react-hooks\nyarn test\n\n# Type check without building\nyarn typecheck\n\n# Test against consuming application\nyarn link\ncd /path/to/your/app\nyarn link eslint-plugin-react-hooks\n```\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:23-26]()\n\n---\n\n## Key Files and Their Roles\n\n| File Path | Purpose |\n|-----------|---------|\n| `packages/eslint-plugin-react-hooks/package.json` | Package metadata, dependencies, and scripts |\n| `packages/eslint-plugin-react-hooks/index.js` | Main entry point exporting rules |\n| `packages/eslint-plugin-react-hooks/index.d.ts` | TypeScript type definitions |\n| `packages/eslint-plugin-react-hooks/src/RulesOfHooks.ts` | Implementation of `rules-of-hooks` rule |\n| `packages/eslint-plugin-react-hooks/src/ExhaustiveDeps.ts` | Implementation of `exhaustive-deps` rule |\n| `packages/eslint-plugin-react-hooks/tsconfig.json` | TypeScript compiler configuration |\n| `.eslintrc.js` (root) | Configures plugin usage in React repository |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:1-68](), [.eslintrc.js:522-548]()', annotations=None, meta=None)], structured_content={'result': '# Page: Overview\n\n# Overview\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThe React repository at https://github.com/facebook/react is a monorepo containing the implementation of React, a JavaScript library for building user interfaces. This repository includes:\n\n- The core `react` package providing the public API (hooks, components, JSX runtime)\n- Multiple renderer implementations for different platforms (DOM, Native, test environments)\n- The `react-reconciler` package implementing the Fiber architecture\n- Server-side rendering systems (Fizz for HTML streaming, Flight for Server Components)\n- The `scheduler` package for cooperative task scheduling\n- Build tooling, feature flags, and development tools\n\nThis document provides a high-level overview of the repository structure and major systems. For detailed information about specific subsystems, see:\n- Feature flag management: [Feature Flags System](#2)\n- Build and packaging: [Build System and Package Distribution](#3)\n- Core reconciliation algorithm: [React Reconciler](#4)\n- Server rendering: [Server-Side Rendering](#5)\n- Platform implementations: [Platform Implementations](#6)\n- Developer tools: [Developer Tools and Debugging](#7)\n\n---\n\n## Repository Structure\n\nThe React repository uses a **Yarn workspaces** monorepo structure with 13 packages under the `packages/` directory. The root [package.json:3-5]() defines the workspace configuration.\n\n```mermaid\ngraph TB\n    subgraph "Monorepo Root"\n        Root[react repository]\n        PackageJSON["package.json<br/>Workspace configuration"]\n        Scripts["scripts/<br/>Build & tooling"]\n    end\n    \n    subgraph "packages/ Directory"\n        React["react<br/>Core API"]\n        ReactDOM["react-dom<br/>DOM renderer"]\n        Reconciler["react-reconciler<br/>Fiber algorithm"]\n        Scheduler["scheduler<br/>Task scheduling"]\n        ReactNative["react-native-renderer<br/>Native platform"]\n        ReactArt["react-art<br/>Canvas/SVG renderer"]\n        TestRenderer["react-test-renderer<br/>Testing utilities"]\n        NoopRenderer["react-noop-renderer<br/>Test infrastructure"]\n        ReactIs["react-is<br/>Type checks"]\n        DevTools["react-devtools-*<br/>Debugging tools"]\n        ESLintPlugin["eslint-plugin-react-hooks<br/>Linting rules"]\n        JestReact["jest-react<br/>Test matchers"]\n        ServerPackages["react-server-dom-*<br/>Server Components"]\n    end\n    \n    Root --> PackageJSON\n    Root --> Scripts\n    Root --> React\n    Root --> ReactDOM\n    Root --> Reconciler\n    Root --> Scheduler\n    Root --> ReactNative\n    Root --> ReactArt\n    Root --> TestRenderer\n    Root --> NoopRenderer\n    Root --> ReactIs\n    Root --> DevTools\n    Root --> ESLintPlugin\n    Root --> JestReact\n    Root --> ServerPackages\n```\n\n**Sources:** [package.json:1-5](), [packages/react/package.json:1-7](), [packages/react-dom/package.json:1-10](), [packages/react-reconciler/package.json:1-10]()\n\n---\n\n## Package Categories and Dependencies\n\nThe repository\'s packages are organized by functional category:\n\n| Category | Packages | Purpose |\n|----------|----------|---------|\n| **Core API** | `react` | Public-facing React API, hooks (`useState`, `useEffect`), JSX runtime |\n| **Reconciler** | `react-reconciler` | Fiber reconciliation algorithm, work loop, scheduling |\n| **DOM Renderer** | `react-dom` | Browser DOM manipulation, event system, hydration |\n| **Native Renderer** | `react-native-renderer` | React Native platform integration |\n| **Scheduler** | `scheduler` | Cooperative task scheduling with priority queues |\n| **Server Rendering** | `react-dom` (server exports), `react-server-dom-*` | Fizz (streaming HTML), Flight (Server Components) |\n| **Test Infrastructure** | `react-test-renderer`, `react-noop-renderer`, `jest-react` | Testing utilities and test environments |\n| **Developer Tools** | `react-devtools-*`, `react-debug-tools` | Browser extensions, component inspection |\n| **Utilities** | `react-is`, `react-art` | Type checking, Canvas/SVG rendering |\n| **Linting** | `eslint-plugin-react-hooks` | Rules of Hooks enforcement |\n\n```mermaid\ngraph LR\n    subgraph "Public API Layer"\n        ReactPkg["react<br/>v19.3.0"]\n    end\n    \n    subgraph "Renderer Layer"\n        ReactDOM["react-dom<br/>Client & Server"]\n        ReactNative["react-native-renderer"]\n        ReactArt["react-art"]\n        TestRenderer["react-test-renderer"]\n    end\n    \n    subgraph "Core Engine"\n        Reconciler["react-reconciler<br/>v0.34.0<br/>Fiber algorithm"]\n        Scheduler["scheduler<br/>v0.28.0<br/>Priority queues"]\n    end\n    \n    ReactPkg -->|peer dependency| ReactDOM\n    ReactPkg -->|peer dependency| ReactNative\n    ReactPkg -->|peer dependency| ReactArt\n    ReactPkg -->|peer dependency| TestRenderer\n    \n    ReactDOM --> Reconciler\n    ReactNative --> Reconciler\n    ReactArt --> Reconciler\n    TestRenderer --> Reconciler\n    \n    Reconciler --> Scheduler\n    ReactDOM -->|dependency| Scheduler\n    ReactNative -->|dependency| Scheduler\n    ReactArt -->|dependency| Scheduler\n    TestRenderer -->|dependency| Scheduler\n```\n\n**Sources:** [packages/react/package.json:1-52](), [packages/react-dom/package.json:19-21](), [packages/react-reconciler/package.json:28-33](), [packages/scheduler/package.json:1-27]()\n\n---\n\n## Major System Components\n\nThe React codebase is organized around several interconnected systems:\n\n### Feature Flags System\n\nThe **Feature Flags** system (`ReactFeatureFlags.js` and environment-specific forks) controls which features are enabled in different deployment targets (Facebook web, React Native FB, React Native OSS, test environments). This is the highest-importance system (importance score: 820.92) as it affects all other packages.\n\nSee [Feature Flags System](#2) for detailed documentation.\n\n### Build System\n\nThe **Build System** uses **Rollup** to generate bundles across multiple module formats (CommonJS, ESM) and environments (Node.js, browser, Bun, React Native). The build is configured through:\n- `scripts/rollup/build-all-release-channels.js` - Main build orchestrator\n- `scripts/rollup/bundles.js` - Bundle definitions (importance: 365.86)\n- `scripts/rollup/forks.js` - Module replacement configuration\n- `scripts/shared/inlinedHostConfigs.js` - Renderer configurations (importance: 317.91)\n\nSee [Build System and Package Distribution](#3) for detailed documentation.\n\n### Fiber Reconciler\n\nThe **Fiber Reconciler** (`react-reconciler` package) implements React\'s core rendering algorithm. It manages:\n- Virtual DOM diffing and updates\n- Work loop with interruptible rendering\n- Lane-based priority scheduling\n- Suspense and error boundaries\n- Host configuration abstraction for platform independence\n\nSee [React Reconciler](#4) for detailed documentation.\n\n### Server Rendering\n\nReact provides two server-side rendering systems:\n- **Fizz** (`ReactFizzServer`) - Streaming HTML with Suspense support\n- **Flight** (`ReactFlightServer`) - Server Components with RSC protocol\n\nSee [Server-Side Rendering](#5) for detailed documentation.\n\n### Developer Tools\n\nThe **React DevTools** system provides component inspection, profiling, and debugging capabilities through browser extensions and standalone applications. The DevTools backend hooks into React renderers via `__REACT_DEVTOOLS_GLOBAL_HOOK__`.\n\nSee [Developer Tools and Debugging](#7) for detailed documentation.\n\n**Sources:** [scripts/rollup/build-all-release-channels.js](), [scripts/shared/inlinedHostConfigs.js](), [packages/react-reconciler/package.json:1-34]()\n\n---\n\n## Code Organization and File Structure\n\nThe repository follows a consistent structure across packages:\n\n```mermaid\ngraph TB\n    subgraph "Package Structure"\n        PkgRoot["packages/package-name/"]\n        PkgJSON["package.json<br/>Metadata, exports"]\n        SrcDir["src/<br/>Source code"]\n        NPMDir["npm/<br/>Wrapper files"]\n        CJSDir["cjs/<br/>Build output (gitignored)"]\n    end\n    \n    subgraph "Source Organization"\n        MainFiles["Entry points<br/>index.js, client.js, server.js"]\n        ImplFiles["Implementation files<br/>React*.js"]\n        ForksDir["forks/<br/>Environment-specific variants"]\n        TestsDir["__tests__/<br/>Jest test files"]\n    end\n    \n    subgraph "Build Artifacts"\n        DevBuild["*-dev.js<br/>Development builds"]\n        ProdBuild["*-prod.js<br/>Production builds"]\n        ProfileBuild["*-profiling.js<br/>Profiling builds"]\n    end\n    \n    PkgRoot --> PkgJSON\n    PkgRoot --> SrcDir\n    PkgRoot --> NPMDir\n    PkgRoot --> CJSDir\n    \n    SrcDir --> MainFiles\n    SrcDir --> ImplFiles\n    SrcDir --> ForksDir\n    SrcDir --> TestsDir\n    \n    CJSDir --> DevBuild\n    CJSDir --> ProdBuild\n    CJSDir --> ProfileBuild\n```\n\n**Key conventions:**\n\n1. **Entry points** follow naming conventions:\n   - `index.js` - Main entry point\n   - `client.js` - Client-side only code\n   - `server.js`, `server.node.js`, `server.browser.js` - Server rendering variants\n   - `*.react-server.js` - Server Components environment\n\n2. **Fork files** enable environment-specific implementations:\n   - `ReactFeatureFlags.www.js` - Facebook web\n   - `ReactFeatureFlags.native-fb.js` - React Native FB\n   - `ReactFeatureFlags.native-oss.js` - React Native OSS\n   - `ReactFiberConfig.dom.js`, `ReactFiberConfig.native.js` - Host configs\n\n3. **Shared code** lives in `packages/shared/`:\n   - `ReactVersion.js` - Current version string\n   - `ReactSymbols.js` - Internal symbols\n   - Various utility modules\n\n**Sources:** [packages/react-dom/package.json:51-126](), [packages/react/package.json:11-42](), [packages/shared/ReactVersion.js:1-16]()\n\n---\n\n## Development Tools and Configuration\n\n### ESLint Configuration\n\nThe repository uses a comprehensive ESLint configuration with custom rules:\n\n```mermaid\ngraph TB\n    subgraph "ESLint Setup"\n        MainConfig[".eslintrc.js<br/>Root configuration"]\n        CustomRules["scripts/eslint-rules/<br/>react-internal rules"]\n        Plugin["eslint-plugin-react-hooks<br/>Published package"]\n    end\n    \n    subgraph "Environment-Specific Configs"\n        CJSConfig["scripts/rollup/validate/<br/>eslintrc.cjs.js"]\n        ESMConfig["scripts/rollup/validate/<br/>eslintrc.esm.js"]\n        FBConfig["scripts/rollup/validate/<br/>eslintrc.fb.js"]\n        RNConfig["scripts/rollup/validate/<br/>eslintrc.rn.js"]\n    end\n    \n    MainConfig --> CustomRules\n    MainConfig --> Plugin\n    \n    MainConfig -.->|validates| CJSConfig\n    MainConfig -.->|validates| ESMConfig\n    MainConfig -.->|validates| FBConfig\n    MainConfig -.->|validates| RNConfig\n```\n\n**Custom rules include:**\n- `react-internal/prod-error-codes` - Enforces error code extraction\n- `react-internal/warning-args` - Validates warning message literals\n- `react-internal/safe-string-coercion` - Type-safe string conversion\n- `react-internal/no-production-logging` - Removes console calls in production\n- `no-for-of-loops` - Prevents Symbol polyfill requirement\n\n**Sources:** [.eslintrc.js:1-658](), [scripts/rollup/validate/eslintrc.cjs.js:1-112](), [packages/eslint-plugin-react-hooks/package.json:1-68]()\n\n### Flow Type Checking\n\nThe repository uses **Flow** for type checking with environment-specific configurations generated by `scripts/flow/createFlowConfigs.js`. This script creates separate `.flowconfig` files for each renderer to handle module resolution with forked implementations.\n\n```mermaid\ngraph LR\n    Template["scripts/flow/config/<br/>flowconfig template"]\n    Generator["createFlowConfigs.js<br/>Config generation"]\n    \n    Template --> Generator\n    \n    Generator --> DOMConfig["scripts/flow/dom/<br/>.flowconfig"]\n    Generator --> NativeConfig["scripts/flow/native/<br/>.flowconfig"]\n    Generator --> CustomConfig["scripts/flow/custom/<br/>.flowconfig"]\n    \n    Generator -.->|uses| HostConfigs["inlinedHostConfigs.js<br/>Renderer definitions"]\n```\n\n**Sources:** [scripts/flow/createFlowConfigs.js:1-153](), [scripts/flow/config/flowconfig:1-45](), [scripts/flow/environment.js:1-636]()\n\n### Testing Infrastructure\n\nThe repository uses **Jest** for testing with custom matchers and utilities:\n\n- `jest-react` package provides custom matchers for React-specific assertions\n- `react-test-renderer` enables snapshot testing without a DOM\n- `react-noop-renderer` provides a test-only renderer for reconciler testing\n- `internal-test-utils` contains shared test helpers\n\nTest files follow the pattern `**/__tests__/**/*.js` and are excluded from production builds.\n\n**Sources:** [package.json:121-123](), [packages/jest-react/package.json:1-32](), [packages/react-test-renderer/package.json:1-35](), [packages/react-noop-renderer/package.json:1-32]()\n\n---\n\n## Build Constants and Globals\n\nReact uses several global constants that are replaced at build time:\n\n| Constant | Purpose | Set By |\n|----------|---------|--------|\n| `__DEV__` | Development mode flag | Rollup replace plugin |\n| `__PROFILE__` | Profiling build flag | Build configuration |\n| `__EXPERIMENTAL__` | Experimental features flag | Release channel |\n| `__VARIANT__` | A/B test variant (www only) | Dynamic loading |\n| `__TEST__` | Test environment flag | Jest configuration |\n\nThese constants enable **dead code elimination** during production builds, significantly reducing bundle size.\n\n```mermaid\ngraph TB\n    subgraph "Source Code"\n        Code["Source with<br/>if (__DEV__) { ... }"]\n    end\n    \n    subgraph "Build Process"\n        RollupReplace["@rollup/plugin-replace<br/>Constant substitution"]\n        ClosureCompiler["Google Closure Compiler<br/>Dead code elimination"]\n    end\n    \n    subgraph "Output"\n        DevBundle["*-dev.js<br/>__DEV__ = true"]\n        ProdBundle["*-prod.js<br/>__DEV__ = false<br/>Dev code removed"]\n    end\n    \n    Code --> RollupReplace\n    RollupReplace --> DevBundle\n    RollupReplace --> ClosureCompiler\n    ClosureCompiler --> ProdBundle\n```\n\n**Sources:** [scripts/flow/environment.js:12-14](), [scripts/rollup/validate/eslintrc.cjs.js:43-60](), [.eslintrc.js:639-648]()\n\n---\n\n## Package Export Strategy\n\nReact packages use **conditional exports** in `package.json` to provide different entry points for different environments:\n\n```mermaid\ngraph TB\n    subgraph "Import Resolution"\n        UserImport["import { ... } from \'react-dom\'"]\n    end\n    \n    subgraph "Conditional Exports"\n        ReactServer["react-server condition<br/>react-dom.react-server.js"]\n        NodeEnv["node condition<br/>server.node.js"]\n        BrowserEnv["browser condition<br/>server.browser.js"]\n        WorkerdEnv["workerd condition<br/>server.edge.js"]\n        DefaultEnv["default<br/>index.js"]\n    end\n    \n    UserImport --> ReactServer\n    UserImport --> NodeEnv\n    UserImport --> BrowserEnv\n    UserImport --> WorkerdEnv\n    UserImport --> DefaultEnv\n```\n\nThe `exports` field in [packages/react-dom/package.json:51-126]() demonstrates this pattern:\n- `react-server` condition provides Server Components-compatible exports\n- `node`, `browser`, `workerd`, `deno`, `bun` conditions select runtime-specific code\n- `default` provides the fallback for other environments\n\n**Sources:** [packages/react-dom/package.json:51-126](), [packages/react/package.json:24-42]()\n\n---\n\n## Version and Release Management\n\nThe repository maintains version information in multiple locations:\n\n1. **Source of truth:** [packages/shared/ReactVersion.js:15]() exports the current version string (`\'19.3.0\'`)\n2. **Package manifests:** Each `package.json` declares its version\n3. **Dependency versions:** Peer and regular dependencies specify version ranges\n\nThe versioning strategy follows semantic versioning:\n- `react` and `react-dom` share the same major.minor.patch version\n- `react-reconciler` uses a separate version (`0.34.0`)\n- `scheduler` has an independent version (`0.28.0`)\n\n**Sources:** [packages/shared/ReactVersion.js:1-16](), [packages/react/package.json:7](), [packages/react-dom/package.json:3](), [packages/react-reconciler/package.json:4](), [packages/scheduler/package.json:3]()\n\n---\n\n# Page: Repository Structure and Packages\n\n# Repository Structure and Packages\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes the organizational structure of the React monorepo, detailing how packages are arranged within the Yarn workspaces, their interdependencies, and their specific purposes. It covers core library packages, platform-specific renderers, server-side rendering packages, and development tooling packages.\n\nFor information about the build system that processes these packages, see [Build System and Package Distribution](#3). For details on feature flag configuration that affects package behavior across environments, see [Feature Flags System](#2).\n\n---\n\n## Monorepo Workspace Structure\n\nThe React repository is organized as a Yarn monorepo using workspaces. The root [`package.json:3-4`]() declares a single workspace pattern:\n\n```json\n"workspaces": [\n  "packages/*"\n]\n```\n\nAll publishable and internal packages reside under the `packages/` directory. The workspace configuration allows packages to reference each other using symbolic links during development, while maintaining separate `package.json` files for individual publishing.\n\n### Workspace Configuration Diagram\n\n```mermaid\ngraph TB\n    Root["Root package.json<br/>Workspace manager<br/>Shared devDependencies"]\n    PackagesDir["packages/ directory<br/>13 workspace members"]\n    \n    React["react/<br/>Core library API"]\n    ReactDOM["react-dom/<br/>DOM renderer"]\n    ReactReconciler["react-reconciler/<br/>Fiber reconciler"]\n    Scheduler["scheduler/<br/>Cooperative scheduler"]\n    ReactNative["react-native-renderer/<br/>Native renderer"]\n    ReactArt["react-art/<br/>Canvas/SVG renderer"]\n    ReactTestRenderer["react-test-renderer/<br/>Test snapshot renderer"]\n    ReactNoop["react-noop-renderer/<br/>Test reconciler"]\n    EslintPlugin["eslint-plugin-react-hooks/<br/>Hooks linting rules"]\n    ReactIs["react-is/<br/>Type checking utilities"]\n    JestReact["jest-react/<br/>Test matchers"]\n    Shared["shared/<br/>Internal utilities"]\n    \n    Root --> PackagesDir\n    PackagesDir --> React\n    PackagesDir --> ReactDOM\n    PackagesDir --> ReactReconciler\n    PackagesDir --> Scheduler\n    PackagesDir --> ReactNative\n    PackagesDir --> ReactArt\n    PackagesDir --> ReactTestRenderer\n    PackagesDir --> ReactNoop\n    PackagesDir --> EslintPlugin\n    PackagesDir --> ReactIs\n    PackagesDir --> JestReact\n    PackagesDir --> Shared\n```\n\n**Sources:** [`package.json:1-164`](), [`packages/react/package.json`](), [`packages/react-dom/package.json`]()\n\n---\n\n## Core Library Packages\n\n### react\n\nThe `react` package provides the foundational API for building user interfaces, including:\n- Component base classes and hooks API\n- JSX transformation runtime (`jsx-runtime.js`, `jsx-dev-runtime.js`)\n- React Server Components support (`react.react-server.js`)\n- Compiler runtime support (`compiler-runtime.js`)\n\n**Package Configuration:**\n\n| Property | Value |\n|----------|-------|\n| Main Entry | `index.js` |\n| Version | `19.3.0` |\n| Peer Dependencies | None (provides base API) |\n\nThe package exports multiple entry points via the `exports` field in [`packages/react/package.json:24-42`]():\n- `.` - Main React API with conditional `react-server` export\n- `./jsx-runtime` - JSX transformation runtime\n- `./jsx-dev-runtime` - Development JSX runtime with debugging\n- `./compiler-runtime` - React Compiler support functions\n\n**Sources:** [`packages/react/package.json:1-52`](), [`packages/shared/ReactVersion.js:15`]()\n\n### react-dom\n\nThe `react-dom` package implements the DOM renderer with extensive platform-specific entry points:\n\n**Client-Side Rendering:**\n- `client.js` - Modern client entry using `createRoot`\n- `index.js` - Legacy and compatibility entry\n\n**Server-Side Rendering:**\n- `server.node.js` - Node.js streaming SSR\n- `server.browser.js` - Browser-compatible SSR\n- `server.edge.js` - Edge runtime SSR\n- `server.bun.js` - Bun runtime SSR\n- `static.node.js` - Static pre-rendering for Node.js\n- `static.browser.js` - Static pre-rendering for browsers\n- `static.edge.js` - Static pre-rendering for edge runtimes\n\n**Testing Utilities:**\n- `test-utils.js` - DOM testing helpers\n- `unstable_testing.js` - Experimental testing APIs\n\nThe package uses conditional exports to select the appropriate implementation based on runtime environment. From [`packages/react-dom/package.json:51-125`](), the exports use conditions like `react-server`, `workerd`, `bun`, `deno`, `worker`, `node`, `edge-light`, and `browser`.\n\n**Dependencies:**\n\n| Dependency | Type | Version |\n|------------|------|---------|\n| `scheduler` | Dependency | `^0.28.0` |\n| `react` | Peer Dependency | `^19.3.0` |\n\n**Sources:** [`packages/react-dom/package.json:1-127`]()\n\n### react-reconciler\n\nThe `react-reconciler` package exposes the Fiber reconciler as a standalone API for building custom renderers. It implements the core reconciliation algorithm that all React renderers use.\n\n**Entry Points:**\n- `index.js` - Main reconciler API\n- `constants.js` - Fiber-related constants\n- `reflection.js` - Reconciler reflection utilities\n\nThis package is used internally by `react-dom`, `react-native-renderer`, `react-test-renderer`, and `react-art`. It provides a host config interface that renderers must implement to integrate with the reconciler.\n\n**Dependencies:**\n\n| Dependency | Type | Version |\n|------------|------|---------|\n| `scheduler` | Dependency | `^0.28.0` |\n| `react` | Peer Dependency | `^19.3.0` |\n\n**Sources:** [`packages/react-reconciler/package.json:1-34`]()\n\n### scheduler\n\nThe `scheduler` package provides cooperative scheduling primitives used by the reconciler to prioritize and time-slice work:\n\n**Entry Points:**\n- `index.js` - Main scheduler API\n- `index.native.js` - React Native-specific implementation\n- `unstable_mock.js` - Deterministic mock for testing\n- `unstable_post_task.js` - Browser Scheduler API integration\n\nThe scheduler manages priority queues and uses `MessageChannel` or other APIs to yield control back to the browser between units of work.\n\n**Sources:** [`packages/scheduler/package.json:1-27`]()\n\n---\n\n## Package Dependency Graph\n\n```mermaid\ngraph TB\n    subgraph "Public Packages"\n        React["react<br/>Core API + Hooks"]\n        ReactDOM["react-dom<br/>DOM Renderer"]\n        ReactArt["react-art<br/>Canvas/SVG Renderer"]\n        ReactNative["react-native-renderer<br/>Native Renderer"]\n        ReactTestRenderer["react-test-renderer<br/>Test Renderer"]\n    end\n    \n    subgraph "Internal Packages"\n        ReactReconciler["react-reconciler<br/>Fiber Reconciler"]\n        Scheduler["scheduler<br/>Cooperative Scheduler"]\n        Shared["shared<br/>Internal Utilities"]\n        ReactNoop["react-noop-renderer<br/>Test Infrastructure"]\n    end\n    \n    subgraph "Development Tools"\n        EslintPlugin["eslint-plugin-react-hooks<br/>Linting Rules"]\n        JestReact["jest-react<br/>Test Matchers"]\n        ReactIs["react-is<br/>Type Checking"]\n    end\n    \n    ReactDOM --> ReactReconciler\n    ReactArt --> ReactReconciler\n    ReactNative --> ReactReconciler\n    ReactTestRenderer --> ReactReconciler\n    ReactNoop --> ReactReconciler\n    \n    ReactReconciler --> Scheduler\n    ReactDOM --> Scheduler\n    ReactArt --> Scheduler\n    ReactNative --> Scheduler\n    ReactTestRenderer --> Scheduler\n    \n    ReactDOM -.peer.-> React\n    ReactArt -.peer.-> React\n    ReactNative -.peer.-> React\n    ReactTestRenderer -.peer.-> React\n    ReactReconciler -.peer.-> React\n    \n    EslintPlugin -.dev.-> React\n    JestReact -.peer.-> React\n    JestReact -.peer.-> ReactTestRenderer\n    \n    ReactDOM --> Shared\n    ReactReconciler --> Shared\n    Scheduler --> Shared\n```\n\n**Sources:** [`packages/react-dom/package.json:19-21`](), [`packages/react-reconciler/package.json:28-33`](), [`packages/react-test-renderer/package.json:21-26`]()\n\n---\n\n## Renderer Packages\n\n### react-native-renderer\n\nAn internal package (not published to npm) that implements the React renderer for React Native environments. It supports both the legacy and Fabric architectures.\n\n**Configuration:**\n\n| Property | Value |\n|----------|-------|\n| Version | `16.0.0` (internal) |\n| Private | `true` |\n| Dependencies | `scheduler: ^0.28.0` |\n| Peer Dependencies | `react: ^18.0.0` |\n\nThis package has platform-specific behavior controlled by global variables:\n- `nativeFabricUIManager` - Fabric UI manager interface\n- `RN$enableMicrotasksInReact` - Microtask scheduling flag\n\n**Sources:** [`packages/react-native-renderer/package.json:1-16`](), [`.eslintrc.js:462-467`]()\n\n### react-art\n\nThe `react-art` package provides a renderer for vector graphics using the ART library, supporting Canvas, SVG, and VML (for IE8) outputs.\n\n**Public Exports:**\n- `index.js` - Main ART renderer\n- `Circle.js` - Circle shape component\n- `Rectangle.js` - Rectangle shape component\n- `Wedge.js` - Wedge/arc shape component\n\n**Dependencies:**\n\n| Dependency | Type | Version |\n|------------|------|---------|\n| `art` | Dependency | `^0.10.1` |\n| `create-react-class` | Dependency | `^15.6.2` |\n| `scheduler` | Dependency | `^0.28.0` |\n| `react` | Peer Dependency | `^19.3.0` |\n\n**Sources:** [`packages/react-art/package.json:1-41`]()\n\n### react-test-renderer\n\nA specialized renderer for snapshot testing that renders React components to pure JavaScript objects without requiring a DOM.\n\n**Entry Points:**\n- `index.js` - Main test renderer\n- `shallow.js` - Shallow rendering utilities\n\n**Dependencies:**\n\n| Dependency | Type | Version |\n|------------|------|---------|\n| `react-is` | Dependency | `^19.3.0` |\n| `scheduler` | Dependency | `^0.28.0` |\n| `react` | Peer Dependency | `^19.3.0` |\n\n**Sources:** [`packages/react-test-renderer/package.json:1-35`]()\n\n### react-noop-renderer\n\nAn internal test package providing mock implementations for testing the Fiber reconciler, Fizz server renderer, and Flight protocol without a real host environment.\n\n**Entry Points:**\n- `index.js` - Client-side noop renderer\n- `persistent.js` - Persistent mode noop renderer\n- `server.js` - Noop server renderer\n- `flight-client.js` - Flight client implementation\n- `flight-server.js` - Flight server implementation\n- `flight-modules.js` - Flight module system\n\nThis package is marked as `private: true` and depends on internal packages:\n- `react-reconciler`\n- `react-client`\n- `react-server`\n\n**Sources:** [`packages/react-noop-renderer/package.json:1-32`]()\n\n---\n\n## Development Tooling Packages\n\n### eslint-plugin-react-hooks\n\nAn ESLint plugin that enforces the Rules of Hooks and provides linting for React Hooks usage patterns.\n\n**Key Features:**\n- Enforces hook call ordering and conditional usage restrictions\n- Validates exhaustive dependencies for effect hooks\n- TypeScript type definitions included (`index.d.ts`)\n\n**Build Process:**\nThe plugin includes a build step that compiles the React Compiler:\n```json\n"scripts": {\n  "build:compiler": "cd ../../compiler && yarn workspace babel-plugin-react-compiler build",\n  "test": "yarn build:compiler && jest"\n}\n```\n\n**Dependencies:**\n\n| Dependency | Purpose |\n|------------|---------|\n| `@babel/core` | AST parsing and traversal |\n| `@babel/parser` | JavaScript/TypeScript parsing |\n| `hermes-parser` | Alternative parser for Flow |\n| `zod` | Configuration schema validation |\n\n**Peer Dependencies:**\n- ESLint versions 3.x through 9.x\n\n**Sources:** [`packages/eslint-plugin-react-hooks/package.json:1-68`]()\n\n### react-is\n\nA utility package for checking React element types and determining what kind of element a value represents.\n\n**Package Configuration:**\n\n| Property | Value |\n|----------|-------|\n| Version | `19.3.0` |\n| Side Effects | `false` (tree-shakeable) |\n| Main Entry | `index.js` |\n\nThis package is used internally by `react-test-renderer` and other tools to identify element types without depending on the full React package.\n\n**Sources:** [`packages/react-is/package.json:1-26`]()\n\n### jest-react\n\nProvides Jest matchers and utilities specifically designed for testing React components.\n\n**Peer Dependencies:**\n\n| Dependency | Supported Versions |\n|------------|-------------------|\n| `jest` | 23.x - 29.x |\n| `react` | `^19.0.0` |\n| `react-test-renderer` | `^19.0.0` |\n\n**Sources:** [`packages/jest-react/package.json:1-32`]()\n\n---\n\n## Package Organization by Purpose\n\n```mermaid\ngraph LR\n    subgraph "User-Facing APIs"\n        React["react<br/>Component API, Hooks"]\n        ReactDOM["react-dom<br/>Browser Rendering"]\n    end\n    \n    subgraph "Renderer Implementations"\n        RN["react-native-renderer<br/>iOS/Android UI"]\n        Art["react-art<br/>Vector Graphics"]\n        Test["react-test-renderer<br/>Snapshot Testing"]\n    end\n    \n    subgraph "Core Infrastructure"\n        Reconciler["react-reconciler<br/>Diff Algorithm"]\n        Sched["scheduler<br/>Priority Scheduling"]\n    end\n    \n    subgraph "Developer Experience"\n        Eslint["eslint-plugin-react-hooks<br/>Code Quality"]\n        JestReact["jest-react<br/>Test Utilities"]\n        ReactIs["react-is<br/>Type Checking"]\n    end\n    \n    subgraph "Internal Testing"\n        Noop["react-noop-renderer<br/>Mock Environment"]\n    end\n    \n    React --> |"used by"| ReactDOM\n    React --> |"used by"| RN\n    React --> |"used by"| Art\n    React --> |"used by"| Test\n    \n    Reconciler --> |"powers"| ReactDOM\n    Reconciler --> |"powers"| RN\n    Reconciler --> |"powers"| Art\n    Reconciler --> |"powers"| Test\n    Reconciler --> |"tested by"| Noop\n    \n    Sched --> |"schedules"| Reconciler\n    \n    Eslint -.-> |"validates"| React\n    ReactIs --> |"supports"| Test\n    JestReact -.-> |"tests"| Test\n```\n\n**Sources:** [`package.json:1-164`](), [`packages/react/package.json`](), [`packages/react-reconciler/package.json`]()\n\n---\n\n## Build System Configuration\n\n### Shared Development Dependencies\n\nThe root [`package.json:6-120`]() declares all development dependencies used across packages:\n\n**Build Tools:**\n- `rollup: ^3.29.5` - Module bundler\n- `@rollup/plugin-babel: ^6.0.3` - Babel integration\n- `@rollup/plugin-commonjs: ^24.0.1` - CommonJS module support\n- `@rollup/plugin-typescript: ^12.1.2` - TypeScript support\n- `google-closure-compiler: ^20230206.0.0` - Advanced optimization\n\n**Transpilation:**\n- `@babel/core: ^7.11.1` - Babel compiler core\n- `flow-bin: ^0.279.0` - Flow type checker\n- `typescript: ^5.4.3` - TypeScript compiler\n\n**Testing:**\n- `jest: ^29.4.2` - Test framework\n- `jest-environment-jsdom: ^29.4.2` - DOM environment\n- `@types/eslint: ^9.6.1` - TypeScript definitions\n\n**Linting:**\n- `eslint: ^7.7.0` - Linter\n- `prettier: ^3.3.3` - Code formatter\n\n**Sources:** [`package.json:6-120`]()\n\n### Build Scripts\n\nThe root package defines several build scripts in [`package.json:124-157`]():\n\n| Script | Purpose |\n|--------|---------|\n| `build` | Build all packages for all release channels |\n| `build-for-devtools` | Build experimental packages for DevTools |\n| `build-for-flight-dev` | Build Server Components packages for development |\n| `lint` | Run ESLint on all packages |\n| `test` | Run Jest tests |\n| `test-stable` | Run tests against stable release channel |\n| `test-www` | Run tests for Facebook www environment |\n\n**Sources:** [`package.json:124-157`]()\n\n---\n\n## Flow Type Configuration\n\nThe repository uses Flow for type checking with multiple configurations for different renderer environments. The script [`scripts/flow/createFlowConfigs.js:1-153`]() generates environment-specific `.flowconfig` files.\n\n### Flow Configuration Generation\n\n```mermaid\ngraph TB\n    ConfigTemplate["config/flowconfig<br/>Template with placeholders"]\n    CreateScript["createFlowConfigs.js<br/>Configuration generator"]\n    InlinedConfigs["inlinedHostConfigs<br/>Renderer definitions"]\n    \n    DOMConfig["flow/dom/.flowconfig<br/>DOM renderer config"]\n    NativeConfig["flow/native/.flowconfig<br/>Native renderer config"]\n    ArtConfig["flow/art/.flowconfig<br/>ART renderer config"]\n    \n    ForkDiscovery["Fork Discovery<br/>Scans packages/*/forks/"]\n    ModuleMappings["Module Mappings<br/>Maps forked files to renderers"]\n    IgnorePaths["Ignore Paths<br/>Excludes other renderer paths"]\n    \n    ConfigTemplate --> CreateScript\n    InlinedConfigs --> CreateScript\n    ForkDiscovery --> CreateScript\n    \n    CreateScript --> ModuleMappings\n    CreateScript --> IgnorePaths\n    \n    ModuleMappings --> DOMConfig\n    IgnorePaths --> DOMConfig\n    \n    ModuleMappings --> NativeConfig\n    IgnorePaths --> NativeConfig\n    \n    ModuleMappings --> ArtConfig\n    IgnorePaths --> ArtConfig\n```\n\nThe configuration generation process:\n1. Reads the template from [`scripts/flow/config/flowconfig:1-45`]()\n2. Discovers all forked files in `packages/*/forks/` directories\n3. Maps forked implementations to specific renderers (e.g., `ReactFiberConfig.dom.js`)\n4. Generates ignore patterns for other renderers\' code paths\n5. Writes separate `.flowconfig` files for each renderer\n\n**Key Forked Files:**\n- `ReactFiberConfig` - Reconciler host config\n- `ReactServerStreamConfig` - Server streaming config\n- `ReactFizzConfig` - HTML streaming config\n- `ReactFlightServerConfig` - Server Components config\n- `ReactFlightClientConfig` - Server Components client config\n\n**Sources:** [`scripts/flow/createFlowConfigs.js:1-153`](), [`scripts/flow/config/flowconfig:1-45`]()\n\n---\n\n## ESLint Configuration by Environment\n\nThe repository uses different ESLint configurations for different output targets, defined in [`scripts/rollup/validate/`]():\n\n### ESLint Configuration Matrix\n\n| Configuration | Parser | ECMAVersion | Source Type | Purpose |\n|---------------|--------|-------------|-------------|---------|\n| `eslintrc.cjs.js` | `espree` | 2020 | `script` | CommonJS builds |\n| `eslintrc.cjs2015.js` | `espree` | 2015 | `script` | ES2015 CommonJS builds |\n| `eslintrc.esm.js` | `espree` | 2020 | `module` | ES Module builds |\n| `eslintrc.fb.js` | `espree` | 5 | `script` | Facebook internal builds |\n| `eslintrc.rn.js` | `espree` | 5 | `script` | React Native builds |\n\nEach configuration declares environment-specific globals. For example, [`scripts/rollup/validate/eslintrc.fb.js:8-70`]() includes:\n- ES6+ globals: `Map`, `Set`, `Symbol`, `Proxy`, `WeakRef`\n- Typed arrays: `Int8Array`, `Uint8Array`, etc.\n- Platform-specific: `__DEV__`, `trustedTypes`, `AsyncLocalStorage`\n\n**Sources:** [`scripts/rollup/validate/eslintrc.cjs.js:1-112`](), [`scripts/rollup/validate/eslintrc.fb.js:1-96`](), [`scripts/rollup/validate/eslintrc.rn.js:1-98`]()\n\n---\n\n## Package Manager Configuration\n\nThe repository uses Yarn 1.x as specified in [`package.json:163`]():\n\n```json\n"packageManager": "yarn@1.22.22"\n```\n\n### Yarn Resolutions\n\nThe repository overrides specific transitive dependencies via resolutions in [`package.json:159-162`]():\n\n```json\n"resolutions": {\n  "react-is": "npm:react-is",\n  "jsdom": "22.1.0"\n}\n```\n\nThis ensures consistent versions of `react-is` across all packages and pins `jsdom` to a specific version for test stability.\n\n**Sources:** [`package.json:159-164`]()\n\n---\n\n## Summary of Key Packages\n\n| Package | Type | Purpose | Exported |\n|---------|------|---------|----------|\n| `react` | Core | Public component API and hooks | Yes |\n| `react-dom` | Renderer | DOM rendering with SSR support | Yes |\n| `react-reconciler` | Infrastructure | Fiber reconciler for custom renderers | Yes |\n| `scheduler` | Infrastructure | Cooperative scheduling primitives | Yes |\n| `react-native-renderer` | Renderer | React Native platform renderer | No (internal) |\n| `react-art` | Renderer | Canvas/SVG vector graphics | Yes |\n| `react-test-renderer` | Testing | Snapshot testing without DOM | Yes |\n| `react-noop-renderer` | Testing | Mock renderer for internal tests | No (internal) |\n| `eslint-plugin-react-hooks` | Tooling | Hooks linting rules | Yes |\n| `react-is` | Utility | Element type checking | Yes |\n| `jest-react` | Testing | Jest matchers for React | Yes |\n| `shared` | Infrastructure | Internal shared utilities | No (internal) |\n\n**Sources:** All package.json files referenced throughout this document\n\n---\n\n# Page: Feature Flags System\n\n# Feature Flags System\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/shared/ReactFeatureFlags.js](packages/shared/ReactFeatureFlags.js)\n- [packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js](packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js)\n- [packages/shared/forks/ReactFeatureFlags.native-fb.js](packages/shared/forks/ReactFeatureFlags.native-fb.js)\n- [packages/shared/forks/ReactFeatureFlags.native-oss.js](packages/shared/forks/ReactFeatureFlags.native-oss.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.js](packages/shared/forks/ReactFeatureFlags.test-renderer.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js](packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.www.js](packages/shared/forks/ReactFeatureFlags.test-renderer.www.js)\n- [packages/shared/forks/ReactFeatureFlags.www-dynamic.js](packages/shared/forks/ReactFeatureFlags.www-dynamic.js)\n- [packages/shared/forks/ReactFeatureFlags.www.js](packages/shared/forks/ReactFeatureFlags.www.js)\n- [scripts/flow/xplat.js](scripts/flow/xplat.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThe Feature Flags System is React\'s comprehensive mechanism for controlling experimental features, platform-specific behavior, and gradual feature rollouts across different environments and release channels. It enables the same codebase to be compiled with different behaviors for Facebook\'s internal infrastructure (www), React Native Facebook internal (native-fb), React Native open source (native-oss), and test renderers, while also supporting A/B testing and runtime-controllable flags in production environments.\n\nThis document covers the flag definition structure, forking mechanism, dynamic flag integration, build-time macros, and flag lifecycle management. For information about how the build system processes these flags, see [Build System and Package Distribution](#3). For information about how flags affect reconciler behavior, see [React Reconciler](#4).\n\n## System Architecture\n\nThe feature flag system is structured as a base definition file with environment-specific forks that override default values. The system supports both static flags (determined at build time) and dynamic flags (controllable at runtime via gatekeepers or feature management systems).\n\n```mermaid\ngraph TB\n    subgraph "Base Definitions"\n        BaseFlags["ReactFeatureFlags.js<br/>Canonical flag definitions"]\n    end\n    \n    subgraph "Static Forks"\n        WWWFork["ReactFeatureFlags.www.js<br/>Facebook internal"]\n        NativeFBFork["ReactFeatureFlags.native-fb.js<br/>React Native FB"]\n        NativeOSSFork["ReactFeatureFlags.native-oss.js<br/>React Native OSS"]\n        TestRendererFork["ReactFeatureFlags.test-renderer.js<br/>Test renderer"]\n        TestRendererWWWFork["ReactFeatureFlags.test-renderer.www.js<br/>Test renderer www"]\n        TestRendererNativeFBFork["ReactFeatureFlags.test-renderer.native-fb.js<br/>Test renderer native-fb"]\n    end\n    \n    subgraph "Dynamic Forks"\n        WWWDynamic["ReactFeatureFlags.www-dynamic.js<br/>Gatekeeper integration"]\n        NativeFBDynamic["ReactFeatureFlags.native-fb-dynamic.js<br/>Native feature flags"]\n    end\n    \n    subgraph "Build-Time Macros"\n        ExperimentalMacro["__EXPERIMENTAL__<br/>Experimental channel"]\n        ProfileMacro["__PROFILE__<br/>Profiling builds"]\n        VariantMacro["__VARIANT__<br/>A/B testing"]\n    end\n    \n    subgraph "Runtime Integration"\n        Gatekeeper["Gatekeeper System<br/>Facebook infrastructure"]\n        ReactNativeFlags["ReactNativeInternalFeatureFlags<br/>Native module"]\n    end\n    \n    BaseFlags --> WWWFork\n    BaseFlags --> NativeFBFork\n    BaseFlags --> NativeOSSFork\n    BaseFlags --> TestRendererFork\n    BaseFlags --> TestRendererWWWFork\n    BaseFlags --> TestRendererNativeFBFork\n    \n    WWWFork --> WWWDynamic\n    NativeFBFork --> NativeFBDynamic\n    \n    WWWDynamic --> Gatekeeper\n    NativeFBDynamic --> ReactNativeFlags\n    \n    ExperimentalMacro --> WWWFork\n    ExperimentalMacro --> NativeFBFork\n    ExperimentalMacro --> BaseFlags\n    ProfileMacro --> WWWFork\n    ProfileMacro --> NativeFBFork\n    ProfileMacro --> BaseFlags\n    VariantMacro --> WWWDynamic\n    VariantMacro --> NativeFBDynamic\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:1-259](), [packages/shared/forks/ReactFeatureFlags.www.js:1-121](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:1-92](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:1-91]()\n\n## Base Feature Flag Definitions\n\nThe base feature flag definitions reside in `ReactFeatureFlags.js` and serve as the canonical source of all flags with their default values for open source builds. This file organizes flags into explicit lifecycle categories that document their intended purpose and stability.\n\n### Flag Organization Structure\n\n```mermaid\ngraph LR\n    BaseFlags["ReactFeatureFlags.js"]\n    \n    BaseFlags --> LandOrRemoveZero["Land or remove (zero effort)<br/>Lines 10-16"]\n    BaseFlags --> Killswitch["Killswitch<br/>Lines 18-26"]\n    BaseFlags --> LandOrRemoveModerate["Land or remove (moderate effort)<br/>Lines 28-36"]\n    BaseFlags --> SlatedForRemoval["Slated for removal (significant effort)<br/>Lines 38-62"]\n    BaseFlags --> OngoingExperiments["Ongoing experiments<br/>Lines 64-152"]\n    BaseFlags --> ReadyForMajor["Ready for next major<br/>Lines 154-196"]\n    BaseFlags --> ChoppingBlock["Chopping Block<br/>Lines 198-223"]\n    BaseFlags --> DebuggingDevTools["Debugging and DevTools<br/>Lines 225-259"]\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:10-259]()\n\n### Key Flag Categories\n\n| Category | Purpose | Example Flags | Lines |\n|----------|---------|---------------|-------|\n| **Killswitch** | Emergency disable switches for production issues | `enableHydrationLaneScheduling` | [25]() |\n| **Land or remove (moderate)** | Flags requiring migration effort | `disableSchedulerTimeoutInWorkLoop` | [35]() |\n| **Slated for removal** | Deprecated features awaiting migration | `enableSuspenseCallback`, `enableScopeAPI`, `enableCreateEventHandleAPI` | [52, 55, 58]() |\n| **Ongoing experiments** | Active feature development | `enableLegacyCache`, `enableTaint`, `enableViewTransition` | [77, 81, 85]() |\n| **Ready for next major** | Features planned for next major release | `disableLegacyContext`, `disableLegacyMode`, `renameElementSymbol` | [177, 195, 167]() |\n| **Debugging and DevTools** | Profiling and development tools | `enableProfilerTimer`, `enableComponentPerformanceTrack` | [229, 235]() |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:10-259]()\n\n### Common Flag Patterns\n\nThe base file defines several patterns of flags:\n\n**Boolean Feature Toggles:**\n```\nexport const enableHalt: boolean = true;\nexport const enableViewTransition: boolean = true;\nexport const enableGestureTransition = __EXPERIMENTAL__;\n```\n\n**Expiration Timeouts:**\n```\nexport const retryLaneExpirationMs = 5000;\nexport const syncLaneExpirationMs = 250;\nexport const transitionLaneExpirationMs = 5000;\n```\n\n**Limits and Thresholds:**\n```\nexport const ownerStackLimit = 1e4;\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:83-141, 167-172, 258]()\n\n## Fork Mechanism\n\nThe fork mechanism allows different builds to use different implementations of the feature flags module. During the build process, Rollup\'s module resolution is configured to substitute the appropriate fork based on the target bundle type.\n\n### Fork Resolution Process\n\n```mermaid\ngraph TB\n    BuildProcess["Rollup Build Process"]\n    \n    BuildProcess --> BundleType{"Bundle Type"}\n    \n    BundleType -->|"FB_WWW"| WWW["packages/shared/forks/<br/>ReactFeatureFlags.www.js"]\n    BundleType -->|"RN_FB"| NativeFB["packages/shared/forks/<br/>ReactFeatureFlags.native-fb.js"]\n    BundleType -->|"RN_OSS"| NativeOSS["packages/shared/forks/<br/>ReactFeatureFlags.native-oss.js"]\n    BundleType -->|"TEST_RENDERER"| TestRenderer["packages/shared/forks/<br/>ReactFeatureFlags.test-renderer.js"]\n    BundleType -->|"TEST_RENDERER_WWW"| TestRendererWWW["packages/shared/forks/<br/>ReactFeatureFlags.test-renderer.www.js"]\n    BundleType -->|"TEST_RENDERER_NATIVE_FB"| TestRendererNativeFB["packages/shared/forks/<br/>ReactFeatureFlags.test-renderer.native-fb.js"]\n    BundleType -->|"Default"| Base["packages/shared/<br/>ReactFeatureFlags.js"]\n    \n    WWW --> Import1["Import in reconciler/renderers"]\n    NativeFB --> Import1\n    NativeOSS --> Import1\n    TestRenderer --> Import1\n    TestRendererWWW --> Import1\n    TestRendererNativeFB --> Import1\n    Base --> Import1\n```\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:1-121](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:1-92](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:1-91]()\n\n### Fork Type Verification\n\nEach fork file includes Flow type verification at the end to ensure it exports the same interface as the base file:\n\n```\n((((null: any): ExportsType): FeatureFlagsType): ExportsType);\n```\n\nThis type assertion ensures that:\n1. The fork exports all flags defined in the base\n2. The fork doesn\'t export extra flags not in the base\n3. Type signatures match exactly\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:120](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:91](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:90]()\n\n### Platform-Specific Flag Values\n\nDifferent forks set different default values based on platform capabilities and requirements:\n\n| Flag | Base | www | native-fb | native-oss |\n|------|------|-----|-----------|------------|\n| `enableLegacyFBSupport` | false | true | false | false |\n| `disableLegacyMode` | true | true | false | false |\n| `enableMoveBefore` | false | false | true | true |\n| `enableSuspenseCallback` | false | true | true | false |\n| `enableScopeAPI` | false | true | false | false |\n| `enableViewTransition` | true | true | false | true |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:61, 195, 184, 52, 55, 85](), [packages/shared/forks/ReactFeatureFlags.www.js:55, 101, 53, 87, 85](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:51, 39, 46, 62, 60](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:37, 24, 31, 50, 47, 65]()\n\n## Dynamic Feature Flags\n\nDynamic feature flags enable runtime control of features in internal Meta builds through gatekeeper systems. These flags are re-exported from platform-specific feature flag modules and their values can change without redeploying code.\n\n### www Dynamic Flags\n\nThe `ReactFeatureFlags.www.js` fork imports dynamic flags from a runtime module:\n\n```mermaid\ngraph LR\n    WWWFork["ReactFeatureFlags.www.js"]\n    DynamicModule["ReactFeatureFlags.www-dynamic.js"]\n    GatekeeperSystem["Gatekeeper System<br/>Meta infrastructure"]\n    RuntimeValue["Runtime Flag Values"]\n    \n    DynamicModule -->|"require(\'ReactFeatureFlags\')"| GatekeeperSystem\n    GatekeeperSystem --> RuntimeValue\n    RuntimeValue --> WWWFork\n    WWWFork -->|"Destructure and re-export"| Exports["Exported Flags"]\n    \n    WWWFork -->|"Lines 17-39"| ExportedDynamic["alwaysThrottleRetries<br/>disableLegacyContextForFunctionComponents<br/>enableObjectFiber<br/>enableRetryLaneExpiration<br/>enableTransitionTracing<br/>enableViewTransition<br/>enableComponentPerformanceTrack<br/>..."]\n```\n\nThe www fork destructures and re-exports specific flags from the dynamic module:\n\n```\nexport const {\n  alwaysThrottleRetries,\n  disableLegacyContextForFunctionComponents,\n  disableSchedulerTimeoutInWorkLoop,\n  enableHiddenSubtreeInsertionEffectCleanup,\n  enableInfiniteRenderLoopDetection,\n  enableNoCloningMemoCache,\n  enableObjectFiber,\n  enableRetryLaneExpiration,\n  enableTransitionTracing,\n  ...\n} = dynamicFeatureFlags;\n```\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:15-39]()\n\n### Native Facebook Dynamic Flags\n\nThe native-fb fork imports dynamic flags from the `ReactNativeInternalFeatureFlags` native module:\n\n```\nimport * as dynamicFlagsUntyped from \'ReactNativeInternalFeatureFlags\';\nconst dynamicFlags: DynamicExportsType = (dynamicFlagsUntyped: any);\n\nexport const {\n  alwaysThrottleRetries,\n  enableHiddenSubtreeInsertionEffectCleanup,\n  enableObjectFiber,\n  enableEagerAlternateStateNodeCleanup,\n  passChildrenWhenCloningPersistedNodes,\n  renameElementSymbol,\n  enableFragmentRefs,\n  enableFragmentRefsScrollIntoView,\n  enableFragmentRefsInstanceHandles,\n} = dynamicFlags;\n```\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.native-fb.js:16-31](), [scripts/flow/xplat.js:10-12]()\n\n### __VARIANT__ Testing Pattern\n\nDynamic flag definition files use the `__VARIANT__` macro to enable A/B testing during development. The build system runs tests twice: once with `__VARIANT__ = true` and once with `__VARIANT__ = false`:\n\n```\nexport const alwaysThrottleRetries: boolean = __VARIANT__;\nexport const disableLegacyContextForFunctionComponents: boolean = __VARIANT__;\nexport const enableObjectFiber: boolean = __VARIANT__;\nexport const enableRetryLaneExpiration: boolean = __VARIANT__;\n```\n\nThis allows testing both code paths for flags that will be dynamically controlled in production.\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www-dynamic.js:13-42](), [packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js:10-30]()\n\n## Build-Time Macros\n\nBuild-time macros are special identifiers that are replaced with boolean values during the build process. These enable conditional compilation based on build configuration.\n\n### Macro Types and Usage\n\n```mermaid\ngraph TB\n    SourceCode["Source Code with Macros"]\n    \n    SourceCode --> Experimental["__EXPERIMENTAL__"]\n    SourceCode --> Profile["__PROFILE__"]\n    SourceCode --> Variant["__VARIANT__"]\n    \n    Experimental -->|"Experimental builds"| ExpTrue["true"]\n    Experimental -->|"Stable builds"| ExpFalse["false"]\n    \n    Profile -->|"Profiling builds"| ProfTrue["true"]\n    Profile -->|"Production builds"| ProfFalse["false"]\n    \n    Variant -->|"Test run 1"| VarTrue["true"]\n    Variant -->|"Test run 2"| VarFalse["false"]\n    \n    ExpTrue --> ClosureCompiler["Closure Compiler<br/>Dead code elimination"]\n    ExpFalse --> ClosureCompiler\n    ProfTrue --> ClosureCompiler\n    ProfFalse --> ClosureCompiler\n    VarTrue --> ClosureCompiler\n    VarFalse --> ClosureCompiler\n    \n    ClosureCompiler --> OptimizedBundle["Optimized Bundle<br/>Unused paths removed"]\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:77-126, 229-256](), [packages/shared/forks/ReactFeatureFlags.www.js:41-69]()\n\n### __EXPERIMENTAL__ Macro\n\nUsed to enable features only in experimental release channels:\n\n```\nexport const enableLegacyCache = __EXPERIMENTAL__;\nexport const enableAsyncIterableChildren = __EXPERIMENTAL__;\nexport const enableTaint = __EXPERIMENTAL__;\nexport const enableGestureTransition = __EXPERIMENTAL__;\n```\n\nIn the www fork, `__EXPERIMENTAL__` is also used for the new modern build variant:\n\n```\nexport const disableLegacyContext = __EXPERIMENTAL__;\nexport const disableTextareaChildren = __EXPERIMENTAL__;\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:77, 79, 81, 87](), [packages/shared/forks/ReactFeatureFlags.www.js:69, 91]()\n\n### __PROFILE__ Macro\n\nUsed to enable profiling and performance measurement features:\n\n```\nexport const enableProfilerTimer = __PROFILE__;\nexport const enableProfilerCommitHooks = __PROFILE__;\nexport const enableProfilerNestedUpdatePhase = __PROFILE__;\nexport const enableUpdaterTracking = __PROFILE__;\nexport const enableSchedulingProfiler: boolean = \n  !enableComponentPerformanceTrack && __PROFILE__;\n```\n\nThis enables React DevTools profiling capabilities without impacting production bundle size.\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:229, 248, 251, 256, 244-245](), [packages/shared/forks/ReactFeatureFlags.www.js:44-47, 66-67]()\n\n### __VARIANT__ Macro\n\nUsed in dynamic flag definition files to simulate gatekeepers during testing:\n\n```\nexport const alwaysThrottleRetries: boolean = __VARIANT__;\nexport const enableObjectFiber: boolean = __VARIANT__;\nexport const enableRetryLaneExpiration: boolean = __VARIANT__;\nexport const enableTransitionTracing: boolean = __VARIANT__;\n```\n\nThe test infrastructure runs tests multiple times with different `__VARIANT__` values to ensure both code paths work correctly.\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www-dynamic.js:16-24](), [packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js:20-29]()\n\n## Feature Flag Lifecycle\n\nFlags move through different lifecycle stages as features are developed, stabilized, and eventually removed. The base file explicitly documents these stages through code comments and organization.\n\n### Lifecycle Stage Flow\n\n```mermaid\nstateDiagram-v2\n    [*] --> OngoingExperiment: New feature flag\n    OngoingExperiment --> ReadyForMajor: Feature stabilized\n    OngoingExperiment --> SlatedForRemoval: Feature rejected\n    ReadyForMajor --> LandOrRemove: Released in major\n    SlatedForRemoval --> LandOrRemove: Migration complete\n    LandOrRemove --> [*]: Flag removed\n    \n    OngoingExperiment --> Killswitch: Production issue\n    Killswitch --> OngoingExperiment: Issue resolved\n    Killswitch --> SlatedForRemoval: Feature abandoned\n    \n    note right of OngoingExperiment: Lines 64-152<br/>Active development\n    note right of ReadyForMajor: Lines 154-196<br/>Next major release\n    note right of SlatedForRemoval: Lines 38-62<br/>Awaiting cleanup\n    note right of Killswitch: Lines 18-26<br/>Emergency disable\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:10-259]()\n\n### Stage Definitions\n\n**Ongoing Experiments (Lines 64-152):**\nFeatures under active development that may change or be reverted. Examples:\n- `enableYieldingBeforePassive`: Yield to browser event loop before passive effects\n- `enableThrottledScheduling`: Intentionally yield less to block high framerate animations\n- `enableViewTransition`: View transition API integration\n- `enableSuspenseyImages`: Enhanced image loading with Suspense\n\n**Ready for Next Major (Lines 154-196):**\nFeatures that are stable and will be enabled by default in the next major release:\n- `disableLegacyContext`: Remove legacy context API\n- `disableLegacyMode`: Remove legacy rendering mode\n- `renameElementSymbol`: Update internal element representation\n- `enableReactTestRendererWarning`: Warn about test renderer usage\n\n**Slated for Removal (Lines 38-62):**\nDeprecated features that didn\'t ship but can\'t be deleted until internal migrations complete:\n- `enableSuspenseCallback`: Legacy Suspense callback API\n- `enableScopeAPI`: Experimental Scope support\n- `enableCreateEventHandleAPI`: Experimental event handle API\n- `enableLegacyFBSupport`: Legacy Primer support on Facebook internal\n\n**Killswitch (Lines 18-26):**\nFlags that exist to quickly disable features if they cause production issues:\n- `enableHydrationLaneScheduling`: Can be disabled if hydration scheduling causes issues\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:64-152, 154-196, 38-62, 18-26]()\n\n## Integration with Build System\n\nThe feature flag system integrates deeply with the build pipeline through module forking and macro replacement. The build system selects the appropriate fork based on the bundle configuration.\n\n### Build-Time Flag Resolution\n\n```mermaid\ngraph TB\n    BundleConfig["scripts/rollup/bundles.js<br/>Bundle configuration"]\n    ForksConfig["scripts/rollup/forks.js<br/>Fork mappings"]\n    RollupPlugin["Rollup Plugin<br/>Module resolution"]\n    \n    BundleConfig --> BundleType["Bundle Type<br/>FB_WWW, RN_OSS, etc."]\n    ForksConfig --> ForkMapping["Fork Mapping<br/>shared/ReactFeatureFlags  shared/forks/ReactFeatureFlags.www"]\n    \n    BundleType --> RollupPlugin\n    ForkMapping --> RollupPlugin\n    \n    RollupPlugin --> ResolvedModule["Resolved Module<br/>packages/shared/forks/ReactFeatureFlags.www.js"]\n    \n    ResolvedModule --> BabelTransform["Babel Transform<br/>Macro replacement"]\n    \n    BabelTransform --> ExperimentalTrue["__EXPERIMENTAL__  true"]\n    BabelTransform --> ExperimentalFalse["__EXPERIMENTAL__  false"]\n    BabelTransform --> ProfileTrue["__PROFILE__  true"]\n    BabelTransform --> ProfileFalse["__PROFILE__  false"]\n    \n    ExperimentalTrue --> ClosureCompiler["Closure Compiler<br/>Dead code elimination"]\n    ExperimentalFalse --> ClosureCompiler\n    ProfileTrue --> ClosureCompiler\n    ProfileFalse --> ClosureCompiler\n    \n    ClosureCompiler --> FinalBundle["Final Bundle<br/>Optimized code"]\n```\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:1-121](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:1-92]()\n\n### Fork Selection Examples\n\nDifferent bundle types resolve to different forks:\n\n| Bundle Type | Fork Path | Purpose |\n|-------------|-----------|---------|\n| `FB_WWW` | `shared/forks/ReactFeatureFlags.www.js` | Facebook internal web |\n| `RN_FB` | `shared/forks/ReactFeatureFlags.native-fb.js` | React Native Facebook internal |\n| `RN_OSS` | `shared/forks/ReactFeatureFlags.native-oss.js` | React Native open source |\n| `NODE_DEV`, `NODE_PROD` | `shared/ReactFeatureFlags.js` | Node.js builds (base) |\n| `UMD_DEV`, `UMD_PROD` | `shared/ReactFeatureFlags.js` | Browser UMD builds (base) |\n\nFor test renderer builds, additional specialized forks are used:\n\n| Bundle Type | Fork Path |\n|-------------|-----------|\n| Test renderer (www) | `shared/forks/ReactFeatureFlags.test-renderer.www.js` |\n| Test renderer (native-fb) | `shared/forks/ReactFeatureFlags.test-renderer.native-fb.js` |\n| Test renderer (default) | `shared/forks/ReactFeatureFlags.test-renderer.js` |\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:1](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:1](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:1](), [packages/shared/forks/ReactFeatureFlags.test-renderer.www.js:1](), [packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js:1](), [packages/shared/forks/ReactFeatureFlags.test-renderer.js:1]()\n\n## Flag Consumption in Runtime Code\n\nRuntime code imports feature flags from `shared/ReactFeatureFlags` and the build system resolves this to the appropriate fork:\n\n```\nimport {\n  enableProfilerTimer,\n  enableSuspenseCallback,\n  enableTransitionTracing,\n  enableLegacyHidden,\n} from \'shared/ReactFeatureFlags\';\n```\n\nThe reconciler, renderers, and other systems check these flags to conditionally enable features:\n\n```javascript\nif (enableTransitionTracing) {\n  // Transition tracing logic\n}\n\nif (enableProfilerTimer) {\n  // Profiling timer logic\n}\n```\n\nAfter Babel macro replacement and Closure Compiler dead code elimination, only the active code path remains in the final bundle.\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:1-259]()\n\n## Special Flag Categories\n\n### Profiling Flags\n\nProfiling flags are controlled by the `__PROFILE__` macro and enable performance measurement features:\n\n| Flag | Purpose | Lines |\n|------|---------|-------|\n| `enableProfilerTimer` | Gather timing metrics for Profiler subtrees | [229]() |\n| `enableComponentPerformanceTrack` | Add performance.measure() marks for Chrome | [235]() |\n| `enableSchedulingProfiler` | User timing marks for experimental timeline | [244-245]() |\n| `enableProfilerCommitHooks` | Record commit phase durations | [248]() |\n| `enableProfilerNestedUpdatePhase` | Differentiate update vs cascading-update | [251]() |\n| `enableUpdaterTracking` | Track which Fibers schedule render work | [256]() |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:229, 235, 244-245, 248, 251, 256]()\n\n### Expiration and Timeout Flags\n\nThese flags control timing behaviors in the scheduler and reconciler:\n\n| Flag | Default Value | Purpose | Lines |\n|------|---------------|---------|-------|\n| `enableRetryLaneExpiration` | false | Enable expiration time for retry lanes | [137]() |\n| `retryLaneExpirationMs` | 5000 | Retry lane expiration timeout | [138]() |\n| `syncLaneExpirationMs` | 250 | Sync lane expiration timeout | [139]() |\n| `transitionLaneExpirationMs` | 5000 | Transition lane expiration timeout | [140]() |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:137-140]()\n\n### Legacy API Deprecation Flags\n\nFlags controlling the removal of legacy APIs:\n\n| Flag | Status | Purpose | Lines |\n|------|--------|---------|-------|\n| `disableLegacyContext` | Ready for major | Remove static contextTypes API | [177]() |\n| `disableLegacyContextForFunctionComponents` | Ready for major | Remove legacy context from function components only | [181]() |\n| `disableLegacyMode` | Ready for major | Remove legacy rendering mode | [195]() |\n| `enableLegacyHidden` | Slated for removal | Legacy hidden subtree API (FB-only) | [111]() |\n| `enableLegacyFBSupport` | Slated for removal | Legacy Primer support | [61]() |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:177, 181, 195, 111, 61]()\n\n## Flag Naming Conventions\n\nThe codebase follows consistent naming conventions for feature flags:\n\n**Enable/Disable Prefix:**\n- `enable*`: Positive feature flags (e.g., `enableViewTransition`, `enableTaint`)\n- `disable*`: Negative feature flags for deprecations (e.g., `disableLegacyContext`, `disableClientCache`)\n\n**Lifecycle Indicators:**\n- Flags in "Slated for removal" section typically start with `enable` but are set to `false`\n- Flags in "Ready for next major" that deprecate features use `disable` prefix\n- Killswitch flags are typically feature enables that can be toggled to `false` for emergency rollback\n\n**Timing/Configuration Suffixes:**\n- `*Ms`: Millisecond timeouts (e.g., `retryLaneExpirationMs`)\n- `*Limit`: Numeric limits (e.g., `ownerStackLimit`)\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:1-259]()\n\n## Summary Table: All Feature Flags\n\n| Flag Name | Base | www | native-fb | native-oss | test-renderer | Category |\n|-----------|------|-----|-----------|------------|---------------|----------|\n| `enableHydrationLaneScheduling` | true | true | true | true | true | Killswitch |\n| `disableSchedulerTimeoutInWorkLoop` | false | dynamic | false | false | false | Land/remove (moderate) |\n| `enableSuspenseCallback` | false | true | true | false | false | Slated for removal |\n| `enableScopeAPI` | false | true | false | false | false | Slated for removal |\n| `enableCreateEventHandleAPI` | false | true | false | false | false | Slated for removal |\n| `enableLegacyFBSupport` | false | true | false | false | false | Slated for removal |\n| `enableYieldingBeforePassive` | false | false | false | false | true | Ongoing |\n| `enableThrottledScheduling` | false | false | false | false | false | Ongoing |\n| `enableLegacyCache` | __EXPERIMENTAL__ | true | false | false | __EXPERIMENTAL__ | Ongoing |\n| `enableTaint` | __EXPERIMENTAL__ | false | true | true | true | Ongoing |\n| `enableHalt` | true | true | true | true | true | Ongoing |\n| `enableViewTransition` | true | dynamic | false | true | false | Ongoing |\n| `disableLegacyContext` | true | __EXPERIMENTAL__ | false | true | true | Ready for major |\n| `disableLegacyMode` | true | true | false | false | true | Ready for major |\n| `renameElementSymbol` | true | dynamic | dynamic | true | false | Ready for major |\n\n**Sources:** All ReactFeatureFlags files listed above\n\n---\n\n# Page: Build System and Package Distribution\n\n# Build System and Package Distribution\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React\'s build system architecture, which compiles source code into distributable packages for multiple environments and platforms. The system uses Rollup as its core bundler, applies environment-specific transformations, and generates dozens of bundle variants from a shared codebase.\n\nFor information about feature flags that control which code is included in each build, see [Feature Flags System](#2). For details on how the built artifacts integrate with CI/CD, see [CI/CD and Artifact Management](#3.3).\n\n---\n\n## Build Pipeline Overview\n\nReact\'s build system transforms source files through a multi-stage pipeline, generating bundles for different environments (Node.js, browsers, React Native, Facebook internal) with different optimizations (development, production, profiling).\n\n### Build Orchestration Flow\n\n```mermaid\ngraph TB\n    CLI["yarn build<br/>(package.json:126)"]\n    BuildScript["scripts/rollup/build-all-release-channels.js"]\n    BuildCore["scripts/rollup/build.js"]\n    \n    CLI --> BuildScript\n    BuildScript --> BuildCore\n    \n    subgraph "Bundle Configuration"\n        BundlesJS["bundles.js<br/>Bundle definitions"]\n        ForksJS["forks.js<br/>Module replacements"]\n        HostConfigs["inlinedHostConfigs.js<br/>Platform mappings"]\n    end\n    \n    BuildCore --> BundlesJS\n    BuildCore --> ForksJS\n    BuildCore --> HostConfigs\n    \n    subgraph "Plugin Pipeline"\n        FlowRemoval["Flow Type Removal<br/>or TypeScript"]\n        Babel["Babel Transform<br/>getBabelConfig()"]\n        Replace["Replace Plugin<br/>__DEV__, __EXPERIMENTAL__"]\n        Closure["Closure Compiler<br/>SIMPLE mode"]\n        Prettier["Prettier<br/>Code formatting"]\n    end\n    \n    BuildCore --> FlowRemoval\n    FlowRemoval --> Babel\n    Babel --> Replace\n    Replace --> Closure\n    Closure --> Prettier\n    \n    subgraph "Output Generation"\n        Wrappers["wrappers.js<br/>Add headers & guards"]\n        OutputPath["packaging.js<br/>Determine output paths"]\n        Files["Build artifacts<br/>build/node_modules/"]\n    end\n    \n    Prettier --> Wrappers\n    Wrappers --> OutputPath\n    OutputPath --> Files\n```\n\n**Sources:** [scripts/rollup/build.js:1-700](), [package.json:126](), [scripts/rollup/bundles.js:1-100](), [scripts/rollup/forks.js:1-485](), [scripts/rollup/packaging.js:1-292](), [scripts/rollup/wrappers.js:1-300]()\n\n---\n\n## Bundle Type System\n\nThe build system generates multiple bundle types from the same source code. Each bundle type represents a combination of environment, module format, and optimization level.\n\n### Bundle Type Definitions\n\n| Bundle Type | Module Format | Environment | Description |\n|------------|---------------|-------------|-------------|\n| `NODE_DEV` | CommonJS | Node.js | Development build with full error messages |\n| `NODE_PROD` | CommonJS | Node.js | Production build with minified errors |\n| `NODE_PROFILING` | CommonJS | Node.js | Production with profiling instrumentation |\n| `NODE_ES2015` | CommonJS | Node.js | ES2015+ syntax preserved |\n| `ESM_DEV` | ES Modules | Browser/Node | Development ES modules |\n| `ESM_PROD` | ES Modules | Browser/Node | Production ES modules |\n| `BUN_DEV` | CommonJS | Bun runtime | Development for Bun |\n| `BUN_PROD` | CommonJS | Bun runtime | Production for Bun |\n| `FB_WWW_DEV` | CommonJS | Facebook web | Facebook development build |\n| `FB_WWW_PROD` | CommonJS | Facebook web | Facebook production build |\n| `FB_WWW_PROFILING` | CommonJS | Facebook web | Facebook profiling build |\n| `RN_OSS_DEV` | CommonJS | React Native OSS | RN open source development |\n| `RN_OSS_PROD` | CommonJS | React Native OSS | RN open source production |\n| `RN_OSS_PROFILING` | CommonJS | React Native OSS | RN open source profiling |\n| `RN_FB_DEV` | CommonJS | React Native FB | RN internal development |\n| `RN_FB_PROD` | CommonJS | React Native FB | RN internal production |\n| `RN_FB_PROFILING` | CommonJS | React Native FB | RN internal profiling |\n| `BROWSER_SCRIPT` | IIFE | Browser | Standalone browser script |\n| `CJS_DTS` | CommonJS | TypeScript | Type definitions for CJS |\n| `ESM_DTS` | ES Modules | TypeScript | Type definitions for ESM |\n\n**Sources:** [scripts/rollup/bundles.js:10-54](), [scripts/rollup/build.js:50-71]()\n\n### Bundle Configuration Structure\n\n```mermaid\ngraph LR\n    Bundle["Bundle Object"]\n    \n    Bundle --> Entry["entry<br/>\'react\' or \'react-dom\'"]\n    Bundle --> BundleTypes["bundleTypes[]<br/>NODE_DEV, NODE_PROD, etc."]\n    Bundle --> ModuleType["moduleType<br/>ISOMORPHIC, RENDERER, etc."]\n    Bundle --> Global["global<br/>\'React\' or \'ReactDOM\'"]\n    Bundle --> Externals["externals[]<br/>Dependencies"]\n    Bundle --> MinifyFlag["minifyWithProdErrorCodes<br/>boolean"]\n    Bundle --> WrapFlag["wrapWithModuleBoundaries<br/>boolean"]\n    Bundle --> Condition["condition<br/>\'react-server\' or undefined"]\n    \n    ModuleType --> ISOMORPHIC["ISOMORPHIC<br/>Core React package"]\n    ModuleType --> RENDERER["RENDERER<br/>ReactDOM, ReactNative"]\n    ModuleType --> RECONCILER["RECONCILER<br/>react-reconciler"]\n    ModuleType --> RENDERER_UTILS["RENDERER_UTILS<br/>TestUtils, plugins"]\n```\n\n**Sources:** [scripts/rollup/bundles.js:56-68](), [scripts/rollup/bundles.js:69-885]()\n\n---\n\n## Module Forking Mechanism\n\nThe forking system allows different modules to be substituted based on the target environment. This enables shipping different implementations of the same interface to different platforms without runtime checks.\n\n### Fork Resolution Process\n\n```mermaid\ngraph TB\n    ImportStmt["Import Statement<br/>import X from \'shared/ReactFeatureFlags\'"]\n    \n    ForksConfig["forks.js<br/>Fork definitions"]\n    ImportStmt --> ForksConfig\n    \n    ForksConfig --> BundleCheck{"Check bundleType"}\n    \n    BundleCheck -->|"FB_WWW_*"| WWWFork["ReactFeatureFlags.www.js"]\n    BundleCheck -->|"RN_FB_*"| NativeFBFork["ReactFeatureFlags.native-fb.js"]\n    BundleCheck -->|"RN_OSS_*"| NativeOSSFork["ReactFeatureFlags.native-oss.js"]\n    BundleCheck -->|"Other"| Default["ReactFeatureFlags.js"]\n    \n    WWWFork --> Plugin["useForks plugin<br/>Replaces module path"]\n    NativeFBFork --> Plugin\n    NativeOSSFork --> Plugin\n    Default --> Plugin\n    \n    Plugin --> RollupBundle["Final bundle with<br/>correct module"]\n```\n\n### Key Forked Modules\n\n| Source Module | Purpose | Fork Variants |\n|--------------|---------|---------------|\n| `ReactFeatureFlags.js` | Feature flag definitions | `www.js`, `native-fb.js`, `native-oss.js`, `test-renderer.js` |\n| `ReactSharedInternals.js` | Shared state object | `ReactSharedInternalsClient.js`, `ReactSharedInternalsServer.js` |\n| `ReactFiberConfig.js` | Renderer host config | Platform-specific implementations (dom, native, etc.) |\n| `ReactFlightServerConfig.js` | Flight server config | `dom`, `webpack`, `turbopack`, `parcel`, etc. |\n| `ReactFlightClientConfig.js` | Flight client config | Platform-specific client implementations |\n| `EventListener.js` | Event attachment | `EventListener-www.js` for Facebook |\n\n**Sources:** [scripts/rollup/forks.js:52-482](), [scripts/rollup/build.js:398](), [scripts/rollup/modules.js:64-81]()\n\n### Fork Function Signature\n\nEach entry in `forks.js` is a function that receives context and returns the replacement path:\n\n```\n(bundleType, entry, dependencies, moduleType, bundle) => string | Error | null\n```\n\n- Returns `null` if no fork is needed\n- Returns a file path string to replace the module\n- Returns an Error object for modules that should error if imported\n\n**Sources:** [scripts/rollup/forks.js:52-89](), [scripts/rollup/modules.js:64-81]()\n\n---\n\n## Host Configuration System\n\nHost configs define platform-specific behavior for renderers. The `inlinedHostConfigs.js` file maps entry points to platform implementations.\n\n### Host Config Structure\n\n```mermaid\ngraph TB\n    Entry["Entry Point<br/>react-dom"]\n    \n    HostConfig["inlinedHostConfigs.js<br/>Configuration array"]\n    Entry --> HostConfig\n    \n    HostConfig --> ShortName["shortName<br/>\'dom-browser\', \'dom-node\', etc."]\n    HostConfig --> EntryPoints["entryPoints[]<br/>Associated entry points"]\n    HostConfig --> Paths["paths[]<br/>Included source paths"]\n    HostConfig --> Flags["Feature flags<br/>isServerSupported, isFlightSupported"]\n    \n    ShortName --> FiberConfig["ReactFiberConfig.{shortName}.js"]\n    ShortName --> FizzConfig["ReactFizzConfig.{shortName}.js"]\n    ShortName --> FlightServerConfig["ReactFlightServerConfig.{shortName}.js"]\n    ShortName --> FlightClientConfig["ReactFlightClientConfig.{shortName}.js"]\n    \n    FiberConfig --> FindFork["findNearestExistingForkFile()<br/>Segment matching"]\n    FizzConfig --> FindFork\n    FlightServerConfig --> FindFork\n    FlightClientConfig --> FindFork\n    \n    FindFork --> Segments["Try segments:<br/>\'dom-browser\'<br/>\'dom\'<br/>until match found"]\n```\n\n### Host Config Examples\n\n| Short Name | Entry Points | Server Support | Flight Support |\n|-----------|--------------|----------------|----------------|\n| `dom-browser` | `react-dom`, `react-dom/client` | Yes | Yes |\n| `dom-node` | `react-dom/server.node` | Yes | Yes |\n| `dom-edge` | `react-dom/server.edge` | Yes | Yes |\n| `dom-bun` | `react-dom/server.bun` | Yes | Yes |\n| `native-fb` | `react-native-renderer` | No | No |\n| `native-oss` | `react-native-renderer` | No | No |\n\n**Sources:** [scripts/shared/inlinedHostConfigs.js:9-500](), [scripts/rollup/forks.js:242-436]()\n\n### Segmented Fork Resolution\n\nThe `findNearestExistingForkFile` function implements a fallback mechanism:\n\n```mermaid\ngraph LR\n    Start["Host config:<br/>\'dom-browser\'"]\n    \n    Start --> Try1["Try: ReactFiberConfig.dom-browser.js"]\n    Try1 -->|exists| Use1["Use this file"]\n    Try1 -->|not found| Try2["Try: ReactFiberConfig.dom.js"]\n    Try2 -->|exists| Use2["Use this file"]\n    Try2 -->|not found| Error["Throw error:<br/>No fork found"]\n```\n\n**Sources:** [scripts/rollup/forks.js:29-43]()\n\n---\n\n## Plugin Pipeline\n\nThe build system applies a series of Rollup plugins to transform source code. The order is critical for correctness.\n\n### Plugin Execution Sequence\n\n```mermaid\ngraph TB\n    Source["Source Files<br/>.js, .ts files"]\n    \n    Source --> Dynamic["dynamicImports()<br/>Keep dynamic imports external"]\n    \n    Dynamic --> TypeCheck{"Has tsconfig?"}\n    TypeCheck -->|Yes| TS["typescript plugin<br/>Compile TypeScript"]\n    TypeCheck -->|No| Flow["flowRemoveTypes<br/>Strip Flow annotations"]\n    \n    TS --> CommonJS["commonjs plugin<br/>Handle CJS modules"]\n    Flow --> CommonJS\n    \n    CommonJS --> Forks["useForks()<br/>Module replacement"]\n    Forks --> Forbid["forbidFBJSImports()<br/>Prevent fbjs imports"]\n    Forbid --> Resolve["resolve plugin<br/>Node resolution"]\n    \n    Resolve --> Strip["stripBanner()<br/>Remove license headers"]\n    Strip --> BabelPlugin["babel()<br/>ES6+ transformation"]\n    \n    BabelPlugin --> StrictRemove["Remove \'use strict\'<br/>String replacement"]\n    StrictRemove --> ReplacePlugin["replace()<br/>__DEV__, __EXPERIMENTAL__"]\n    \n    ReplacePlugin --> External["externalRuntime()<br/>Fizz runtime transform"]\n    External --> TopLevel["Top-level definitions<br/>Wrappers"]\n    \n    TopLevel --> ClosureCheck{"Needs Closure?"}\n    ClosureCheck -->|Yes| ClosurePlugin["closure()<br/>SIMPLE compilation"]\n    ClosureCheck -->|No| Skip["Skip"]\n    \n    ClosurePlugin --> PrettierPlugin["prettier()<br/>Reformat code"]\n    Skip --> PrettierPlugin\n    \n    PrettierPlugin --> License["License header<br/>Wrappers"]\n    License --> Sizes["sizes()<br/>Record bundle size"]\n    \n    Sizes --> Output["Final Bundle"]\n```\n\n**Sources:** [scripts/rollup/build.js:354-546]()\n\n### Babel Configuration\n\nThe Babel plugin applies different transformations based on bundle type and development mode:\n\n```mermaid\ngraph LR\n    GetBabelConfig["getBabelConfig()"]\n    \n    GetBabelConfig --> Base["Base plugins:<br/>class-properties<br/>object-rest-spread<br/>template-literals<br/>transform-spread<br/>etc."]\n    \n    Base --> DevCheck{"isDevelopment?"}\n    DevCheck -->|Yes| ES5["Add ES5 plugins:<br/>arrow-functions<br/>block-scoping<br/>shorthand-properties<br/>etc."]\n    DevCheck -->|No| Skip["Skip ES5<br/>(Closure handles)"]\n    \n    ES5 --> ErrorCheck{"minifyWithProdErrorCodes?"}\n    Skip --> ErrorCheck\n    ErrorCheck -->|Yes & Prod| Errors["transform-error-messages<br/>Replace with codes"]\n    ErrorCheck -->|No| NoErrors["Keep full messages"]\n```\n\n**Sources:** [scripts/rollup/build.js:143-172](), [scripts/rollup/build.js:111-141]()\n\n---\n\n## Package Output Structure\n\nBuilt artifacts are organized into a specific directory structure for npm distribution and internal use.\n\n### Output Directory Layout\n\n```mermaid\ngraph TB\n    Build["build/"]\n    \n    Build --> NodeModules["node_modules/"]\n    Build --> Facebook["facebook-www/"]\n    Build --> ReactNative["react-native/"]\n    \n    NodeModules --> ReactPkg["react/"]\n    NodeModules --> ReactDOMPkg["react-dom/"]\n    NodeModules --> OtherPkgs["Other packages..."]\n    \n    ReactPkg --> ReactCJS["cjs/<br/>CommonJS builds"]\n    ReactPkg --> ReactFiles["index.js<br/>jsx-runtime.js<br/>compiler-runtime.js"]\n    \n    ReactDOMPkg --> DOMCJS["cjs/<br/>CommonJS builds"]\n    ReactDOMPkg --> DOMESM["esm/<br/>ESM builds (if any)"]\n    ReactDOMPkg --> DOMFiles["index.js<br/>client.js<br/>server.node.js<br/>server.browser.js"]\n    \n    Facebook --> Shims["shims/<br/>Facebook-specific"]\n    Facebook --> WWWFiles["React-www.js<br/>ReactDOM-www.js"]\n    \n    ReactNative --> Implementations["implementations/<br/>RN renderer files"]\n    ReactNative --> RNShims["shims/<br/>RN-specific"]\n```\n\n**Sources:** [scripts/rollup/packaging.js:48-114]()\n\n### Path Determination Logic\n\nThe `getBundleOutputPath` function maps bundle configuration to output paths:\n\n| Bundle Type | Package Name | Output Path Pattern |\n|------------|--------------|-------------------|\n| `NODE_DEV`, `NODE_PROD`, `NODE_PROFILING` | Any | `build/node_modules/{pkg}/cjs/{filename}` |\n| `ESM_DEV`, `ESM_PROD` | Any | `build/node_modules/{pkg}/esm/{filename}` |\n| `FB_WWW_*` | Any | `build/facebook-www/{filename}` |\n| `RN_OSS_*` | `react-native-renderer` | `build/react-native/implementations/{filename}` |\n| `RN_FB_*` | `react-native-renderer` | `build/react-native/implementations/{filename}.fb.js` |\n| `RN_FB_*` | Other | `build/facebook-react-native/{pkg}/cjs/{filename}` |\n| `BROWSER_SCRIPT` | Any | `build/node_modules/{pkg}/{bundle.outputPath}` |\n\n**Sources:** [scripts/rollup/packaging.js:48-115]()\n\n---\n\n## Npm Package Preparation\n\nAfter building, packages must be prepared for npm publication. This involves copying metadata files, filtering entry points, and creating tarballs.\n\n### Package Preparation Flow\n\n```mermaid\ngraph TB\n    PrepareNpm["prepareNpmPackages()"]\n    \n    PrepareNpm --> Scan["Scan build/node_modules/<br/>for packages"]\n    \n    Scan --> ForEach["For each package:"]\n    \n    ForEach --> Copy["Copy files:<br/>LICENSE<br/>package.json<br/>README.md<br/>npm/ contents"]\n    \n    Copy --> Filter["filterOutEntrypoints()<br/>Remove unbundled entry points"]\n    \n    Filter --> ReadPkg["Read package.json"]\n    ReadPkg --> CheckFiles["Check files[] array"]\n    \n    CheckFiles --> CheckBundle{"Entry point<br/>has bundle?"}\n    CheckBundle -->|Yes| Keep["Keep in files[]"]\n    CheckBundle -->|No| Remove["Remove from files[]<br/>Delete file<br/>Remove from exports{}"]\n    \n    Remove --> UpdatePkg["Write updated package.json"]\n    Keep --> UpdatePkg\n    \n    UpdatePkg --> Pack["npm pack<br/>Create .tgz"]\n    Pack --> Extract["Extract tarball<br/>Strip \'package/\' prefix"]\n    Extract --> Cleanup["Delete .tgz"]\n```\n\n**Sources:** [scripts/rollup/packaging.js:253-284](), [scripts/rollup/packaging.js:171-251]()\n\n### Entry Point Filtering\n\nThe `filterOutEntrypoints` function uses a map to determine which entry points should exist:\n\n```mermaid\ngraph LR\n    EntryMap["entryPointsToHasBundle<br/>Map<entry, boolean>"]\n    \n    EntryMap --> BuildMap["Built during bundle<br/>iteration"]\n    \n    BuildMap --> Check["For each file<br/>in package.json:"]\n    \n    Check --> EntryName["Convert filename<br/>to entry name"]\n    EntryName --> Lookup["Look up in map"]\n    \n    Lookup --> HasBundle{"Has bundle in<br/>this channel?"}\n    HasBundle -->|true| Keep["Keep file"]\n    HasBundle -->|false| RemoveFile["Remove from package"]\n    HasBundle -->|undefined| ExtraFile["Extra file<br/>(keep)"]\n    \n    RemoveFile --> UpdateExports["Update exports field"]\n    RemoveFile --> UpdateBrowser["Update browser field"]\n```\n\n**Sources:** [scripts/rollup/packaging.js:158-251]()\n\n---\n\n## Code Wrapping and Headers\n\nDifferent bundle types require different code wrappers, headers, and guards. The `wrappers.js` module handles this transformation.\n\n### Wrapper Application\n\n```mermaid\ngraph TB\n    Source["Rollup output"]\n    \n    Source --> TopLevel["wrapWithTopLevelDefinitions()<br/>Bundle-type specific wrapper"]\n    \n    TopLevel --> DevGuard{"Is development<br/>bundle?"}\n    \n    DevGuard -->|NODE_DEV| NodeDev["Wrap in:<br/>if (process.env.NODE_ENV !== \'production\')"]\n    DevGuard -->|FB_WWW_DEV| WWWDev["Wrap in:<br/>if (__DEV__)"]\n    DevGuard -->|RN_*_DEV| RNDev["Wrap in:<br/>if (__DEV__)"]\n    DevGuard -->|Production| NoProd["No guard needed"]\n    \n    NodeDev --> DevTools["wrapWithRegisterInternalModule()<br/>DevTools registration"]\n    WWWDev --> DevTools\n    RNDev --> DevTools\n    NoProd --> ProdCheck{"wrapWithModule<br/>Boundaries?"}\n    \n    DevTools --> ProdCheck\n    ProdCheck -->|Yes| ModuleBoundary["Add __REACT_DEVTOOLS_GLOBAL_HOOK__<br/>registration calls"]\n    ProdCheck -->|No| Skip["Skip"]\n    \n    ModuleBoundary --> License["wrapWithLicenseHeader()<br/>Add copyright header"]\n    Skip --> License\n    \n    License --> Final["Final bundle code"]\n```\n\n**Sources:** [scripts/rollup/wrappers.js:32-50](), [scripts/rollup/wrappers.js:58-169](), [scripts/rollup/build.js:446-520]()\n\n### License Header Format\n\nAll bundles include a standard MIT license header:\n\n```\n/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n```\n\n**Sources:** [scripts/rollup/wrappers.js:53-56]()\n\n---\n\n## Bundle Type-Specific Behaviors\n\nDifferent bundle types have unique compilation and optimization requirements.\n\n### Development vs Production Differences\n\n| Aspect | Development | Production |\n|--------|------------|------------|\n| `__DEV__` constant | `true` | `false` |\n| Error messages | Full text | Error codes (minified) |\n| Babel plugins | Full ES5 transform | Minimal (Closure handles) |\n| Closure Compiler | Not used | SIMPLE mode |\n| Guard wrappers | `if (process.env.NODE_ENV !== "production")` | None |\n| Source maps | Not generated | Not generated |\n\n**Sources:** [scripts/rollup/build.js:253-280](), [scripts/rollup/build.js:432-442](), [scripts/rollup/build.js:469-500]()\n\n### Profiling Bundles\n\nProfiling bundles are production builds with the `__PROFILE__` flag set to `true`. They include:\n\n- All production optimizations\n- Additional performance tracking code\n- Profiler hooks enabled\n\n**Sources:** [scripts/rollup/build.js:283-310](), [scripts/rollup/build.js:432-442]()\n\n### Facebook Internal Bundles\n\nFacebook bundles (`FB_WWW_*` and `RN_FB_*`) have special characteristics:\n\n- Use different feature flag forks (`ReactFeatureFlags.www.js`, `ReactFeatureFlags.native-fb.js`)\n- Support dynamic flags via `__VARIANT__` or external gatekeeper systems\n- May use Facebook-specific event listener wrappers\n- Output to separate directories (`facebook-www/`, `facebook-react-native/`)\n\n**Sources:** [scripts/rollup/bundles.js:19-21](), [scripts/rollup/forks.js:180-188](), [scripts/rollup/packaging.js:64-94]()\n\n---\n\n## Build Commands and Workflow\n\nThe monorepo provides several build commands for different use cases.\n\n### Primary Build Commands\n\n| Command | Description | Implementation |\n|---------|-------------|----------------|\n| `yarn build` | Build all release channels | [package.json:126]()  `build-all-release-channels.js` |\n| `yarn build --type=NODE` | Build only Node bundles | [scripts/rollup/build.js:94-98]() |\n| `yarn build react/index,react-dom/index` | Build specific entry points | [scripts/rollup/build.js:100-104]() |\n| `yarn build --watch` | Watch mode for development | [scripts/rollup/build.js:106]() |\n\n**Sources:** [package.json:124-157](), [scripts/rollup/build.js:94-106]()\n\n### Specialized Build Targets\n\n```mermaid\ngraph LR\n    BuildCommands["Build Commands"]\n    \n    BuildCommands --> DevTools["build-for-devtools<br/>Subset for DevTools testing"]\n    BuildCommands --> Flight["build-for-flight-dev<br/>Server Components dev"]\n    BuildCommands --> VT["build-for-vt-dev<br/>View Transitions dev"]\n    \n    DevTools --> Subset1["react, react-dom,<br/>react-is, scheduler,<br/>react-test-renderer"]\n    Flight --> Subset2["react, react-dom,<br/>react-server-dom-*"]\n    VT --> Subset3["react, react-dom,<br/>server bundles"]\n```\n\n**Sources:** [package.json:127-131]()\n\n---\n\n## Module Resolution and Dependencies\n\nThe build system needs to resolve modules and determine dependencies for bundling.\n\n### Dependency Resolution\n\n```mermaid\ngraph TB\n    Entry["Bundle entry point"]\n    \n    Entry --> GetDeps["getDependencies()<br/>modules.js"]\n    \n    GetDeps --> LoadPkg["Load package.json<br/>for entry point"]\n    \n    LoadPkg --> Extract["Extract:<br/>dependencies{}<br/>peerDependencies{}"]\n    \n    Extract --> Merge["Merge into<br/>single array"]\n    \n    Merge --> Externals["Mark as external<br/>in Rollup config"]\n    \n    Externals --> Bundle["Bundle generation<br/>(external deps excluded)"]\n```\n\n**Sources:** [scripts/rollup/modules.js:50-61](), [scripts/rollup/build.js:653-654]()\n\n### Global Variable Mapping\n\nFor bundles that expose globals (UMD-style), the system maps package names to global variables:\n\n| Package Name | Global Variable |\n|-------------|-----------------|\n| `react` | `React` |\n| `react-dom` | `ReactDOM` |\n| `react-dom/server` | `ReactDOMServer` |\n| `scheduler` | `Scheduler` |\n| `scheduler/unstable_mock` | `SchedulerMock` |\n\n**Sources:** [scripts/rollup/modules.js:31-38](), [scripts/rollup/build.js:650]()\n\n---\n\n## Build Validation\n\nAfter building, the system validates the output to catch build pipeline bugs.\n\n### Validation Process\n\n```mermaid\ngraph TB\n    Validate["yarn lint-build"]\n    \n    Validate --> Scan["Scan build/ directory<br/>for .js files"]\n    \n    Scan --> Categorize{"Determine<br/>bundle type"}\n    \n    Categorize --> CJS["CJS bundles<br/>eslintrc.cjs.js"]\n    Categorize --> CJS2015["CJS ES2015 bundles<br/>eslintrc.cjs2015.js"]\n    Categorize --> ESM["ESM bundles<br/>eslintrc.esm.js"]\n    Categorize --> FB["FB bundles<br/>eslintrc.fb.js"]\n    Categorize --> RN["RN bundles<br/>eslintrc.rn.js"]\n    \n    CJS --> ESLint["Run ESLint<br/>with config"]\n    CJS2015 --> ESLint\n    ESM --> ESLint\n    FB --> ESLint\n    RN --> ESLint\n    \n    ESLint --> Check["Check for:<br/>- Undefined globals<br/>- Invalid syntax<br/>- Closure artifacts"]\n    \n    Check --> Report["Report errors"]\n```\n\n**Sources:** [scripts/rollup/validate/index.js:1-100](), [package.json:135]()\n\n### Validation Rules\n\nEach bundle type has specific global variables and syntax requirements:\n\n- **CJS**: ES2020 features, Node.js globals (`process`, `Buffer`)\n- **CJS ES2015**: ES2015+ features, Node.js globals\n- **ESM**: ES2020 features, module syntax\n- **FB**: ES5 syntax, `__DEV__` global\n- **RN**: ES5 syntax, React Native globals (`nativeFabricUIManager`)\n\n**Sources:** [scripts/rollup/validate/eslintrc.cjs.js:1-111](), [scripts/rollup/validate/eslintrc.fb.js:1-100](), [scripts/rollup/validate/eslintrc.rn.js:1-96]()\n\n---\n\n## Environment-Specific Entry Points\n\nReact packages use conditional exports and entry point suffixes to select the correct implementation.\n\n### Entry Point Fork Resolution\n\n```mermaid\ngraph TB\n    Entry["Bundle entry:<br/>react-dom"]\n    \n    Entry --> Resolve["require.resolve()<br/>Get full path"]\n    \n    Resolve --> Fork["resolveEntryFork()"]\n    \n    Fork --> IsFB{"Is Facebook<br/>bundle?"}\n    \n    IsFB -->|Yes| TryModern["Try: .modern.fb.js<br/>(if experimental)"]\n    IsFB -->|No| TryChannel["Try: .experimental.js<br/>or .stable.js"]\n    \n    TryModern --> ExistsModern{"File exists?"}\n    ExistsModern -->|Yes| UseModern["Use modern FB fork"]\n    ExistsModern -->|No| TryClassic["Try: .classic.fb.js<br/>or .fb.js"]\n    \n    TryClassic --> UseClassic["Use if exists<br/>else try channel fork"]\n    \n    TryChannel --> UseChannel["Use channel fork<br/>or fallback to .js"]\n    \n    UseModern --> DevCheck{"Is development?"}\n    UseClassic --> DevCheck\n    UseChannel --> DevCheck\n    \n    DevCheck -->|Yes| TryDev["Try: .development.js"]\n    DevCheck -->|No| UseProd["Use production file"]\n    \n    TryDev --> FinalEntry["Resolved entry path"]\n    UseProd --> FinalEntry\n```\n\n**Sources:** [scripts/rollup/build.js:585-633]()\n\n### Conditional Exports in package.json\n\nReact packages use Node.js conditional exports to select implementations:\n\n```json\n{\n  "exports": {\n    ".": {\n      "react-server": "./react.react-server.js",\n      "default": "./index.js"\n    },\n    "./server": {\n      "react-server": "./server.react-server.js",\n      "workerd": "./server.edge.js",\n      "bun": "./server.bun.js",\n      "node": "./server.node.js",\n      "browser": "./server.browser.js",\n      "default": "./server.node.js"\n    }\n  }\n}\n```\n\n**Sources:** [packages/react-dom/package.json:51-125](), [packages/react/package.json:24-43]()\n\n---\n\n## Summary\n\nReact\'s build system is a sophisticated multi-stage pipeline that:\n\n1. **Reads configuration** from `bundles.js`, `forks.js`, and `inlinedHostConfigs.js`\n2. **Processes source files** through TypeScript/Flow removal, Babel, and Closure Compiler\n3. **Applies environment-specific forks** to swap modules based on target platform\n4. **Generates dozens of bundle variants** for different environments and optimization levels\n5. **Wraps code** with appropriate headers, guards, and DevTools registration\n6. **Organizes output** into platform-specific directory structures\n7. **Prepares npm packages** by filtering entry points and creating tarballs\n8. **Validates output** using ESLint to catch build pipeline errors\n\nThe system enables React to maintain a single codebase while shipping optimized, platform-specific implementations to Node.js, browsers, React Native, and Facebook\'s internal infrastructure.\n\n---\n\n# Page: Build Pipeline and Module Forking\n\n# Build Pipeline and Module Forking\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/react-reconciler/src/ReactFiberOffscreenComponent.js](packages/react-reconciler/src/ReactFiberOffscreenComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React\'s build system architecture, which transforms the monorepo\'s source code into distributable packages for different environments and platforms. The build pipeline uses Rollup to generate hundreds of bundle variants from shared source code, employing a sophisticated module forking mechanism to adapt behavior for specific deployment targets (Facebook internal, React Native, Node.js, browsers, etc.) without maintaining separate codebases.\n\nFor information about feature flags that control which features are enabled in each environment, see [Feature Flags System](#2). For details on release channels and versioning, see [Release Channels and Versioning](#3.2). For CI/CD and artifact preparation, see [CI/CD and Artifact Management](#3.3).\n\n---\n\n## Build System Architecture\n\nThe React build system is orchestrated by [scripts/rollup/build.js]() and centers around three core concepts:\n\n1. **Bundle Definitions** - Configurations specifying entry points, target environments, and module formats\n2. **Module Forking** - Environment-specific module replacement\n3. **Plugin Pipeline** - Sequential transformations applied to source code\n\n### Bundle Configuration System\n\nBundle definitions in [scripts/rollup/bundles.js:69-1244]() specify all possible build outputs. Each bundle configuration contains:\n\n| Property | Purpose |\n|----------|---------|\n| `bundleTypes` | Array of target bundle types (NODE_DEV, FB_WWW_PROD, etc.) |\n| `moduleType` | Classification (ISOMORPHIC, RENDERER, RECONCILER, RENDERER_UTILS) |\n| `entry` | Source entry point path |\n| `global` | Global variable name for UMD/IIFE bundles |\n| `externals` | External dependencies not to bundle |\n| `minifyWithProdErrorCodes` | Whether to replace error messages with codes in production |\n| `wrapWithModuleBoundaries` | Whether to wrap with module boundary markers |\n\n**Bundle Types by Environment**\n\n```mermaid\ngraph TB\n    subgraph "Module Formats"\n        CJS["CommonJS<br/>(NODE_DEV/PROD/PROFILING)"]\n        ESM["ES Modules<br/>(ESM_DEV/PROD)"]\n        IIFE["IIFE<br/>(BROWSER_SCRIPT)"]\n        ES2015["ES2015<br/>(NODE_ES2015)"]\n    end\n    \n    subgraph "Facebook Internal"\n        FBWWW["FB WWW<br/>(FB_WWW_DEV/PROD/PROFILING)"]\n        RNFB["RN Facebook<br/>(RN_FB_DEV/PROD/PROFILING)"]\n    end\n    \n    subgraph "Open Source"\n        BUN["Bun Runtime<br/>(BUN_DEV/PROD)"]\n        RNOSS["RN OSS<br/>(RN_OSS_DEV/PROD/PROFILING)"]\n    end\n    \n    subgraph "TypeScript"\n        CJSDTS["CJS Type Defs<br/>(CJS_DTS)"]\n        ESMDTS["ESM Type Defs<br/>(ESM_DTS)"]\n    end\n```\n\nSources: [scripts/rollup/bundles.js:10-54]()\n\n---\n\n## Module Forking Mechanism\n\nModule forking allows React to replace specific modules with environment-specific implementations at build time. The forking system is defined in [scripts/rollup/forks.js:52-482]().\n\n### Fork Resolution Process\n\n```mermaid\ngraph TB\n    ImportRequest["Import Request<br/>(\'./packages/shared/ReactFeatureFlags.js\')"]\n    \n    GetForks["getForks()<br/>[modules.js:64-81]"]\n    \n    LookupFork["Lookup in forks map<br/>[forks.js:52]"]\n    \n    EvalFunction["Evaluate fork function<br/>(bundleType, entry, deps, moduleType, bundle)"]\n    \n    Decision{Fork<br/>Applies?}\n    \n    ReturnFork["Return fork path<br/>e.g., ReactFeatureFlags.www.js"]\n    \n    ReturnNull["Return null<br/>(use original)"]\n    \n    ApplyFork["useForks plugin applies replacement<br/>[plugins/use-forks-plugin.js]"]\n    \n    ImportRequest --> GetForks\n    GetForks --> LookupFork\n    LookupFork --> EvalFunction\n    EvalFunction --> Decision\n    Decision -->|"Yes"| ReturnFork\n    Decision -->|"No"| ReturnNull\n    ReturnFork --> ApplyFork\n```\n\nSources: [scripts/rollup/forks.js:52-482](), [scripts/rollup/modules.js:64-81]()\n\n### Critical Forked Modules\n\n**ReactFeatureFlags.js**\n\nThe feature flags module has environment-specific forks:\n\n- `ReactFeatureFlags.www.js` - Facebook web builds\n- `ReactFeatureFlags.native-fb.js` - Facebook React Native builds\n- `ReactFeatureFlags.native-oss.js` - Open source React Native builds\n- `ReactFeatureFlags.test-renderer.js` - Test renderer builds\n\nFork logic: [scripts/rollup/forks.js:134-191]()\n\n**ReactFiberConfig.js (Host Configuration)**\n\nThis module provides the host environment abstraction for the reconciler. Different renderers have different implementations:\n\n```mermaid\ngraph LR\n    ReactFiberConfig["ReactFiberConfig.js<br/>(abstract interface)"]\n    \n    subgraph "Fork Resolution"\n        FindRenderer["Find renderer in<br/>inlinedHostConfigs"]\n        BuildPath["Build fork path<br/>ReactFiberConfig.{shortName}.js"]\n        TrySegments["Try segmented names<br/>dom-browser  dom"]\n    end\n    \n    subgraph "Implementations"\n        DOMBrowser["ReactFiberConfig.dom-browser.js<br/>(Browser DOM)"]\n        DOMNode["ReactFiberConfig.dom-node.js<br/>(Node.js SSR)"]\n        NativeFB["ReactFiberConfig.native-fb.js<br/>(RN Facebook)"]\n        NativeOSS["ReactFiberConfig.native-oss.js<br/>(RN OSS)"]\n        Test["ReactFiberConfig.test.js<br/>(Test renderer)"]\n    end\n    \n    ReactFiberConfig --> FindRenderer\n    FindRenderer --> BuildPath\n    BuildPath --> TrySegments\n    TrySegments --> DOMBrowser\n    TrySegments --> DOMNode\n    TrySegments --> NativeFB\n    TrySegments --> NativeOSS\n    TrySegments --> Test\n```\n\nFork logic: [scripts/rollup/forks.js:242-274]()\n\nThe `findNearestExistingForkFile` function [scripts/rollup/forks.js:29-43]() tries progressively shorter segment combinations:\n- `ReactFiberConfig.dom-browser.js`\n- `ReactFiberConfig.dom.js`\n- (fallback to error if none found)\n\n**ReactSharedInternals.js**\n\nForked to prevent circular dependencies when the `react` package imports shared internals:\n\n- Inside `react` package  uses `ReactSharedInternalsClient.js`\n- Inside `react-server` condition  uses `ReactSharedInternalsServer.js`\n- Other packages  uses default `ReactSharedInternals.js`\n\nFork logic: [scripts/rollup/forks.js:55-89]()\n\n**Server Configuration Modules**\n\nThree related config modules for server rendering:\n\n| Module | Purpose | Fork Examples |\n|--------|---------|---------------|\n| `ReactServerStreamConfig.js` | Stream handling | `ReactServerStreamConfig.dom-browser.js` |\n| `ReactFizzConfig.js` | HTML rendering (Fizz) | `ReactFizzConfig.dom-node.js` |\n| `ReactFlightServerConfig.js` | Server Components (Flight) | `ReactFlightServerConfig.dom-node-webpack.js` |\n\nFork logic: [scripts/rollup/forks.js:276-392]()\n\n---\n\n## Entry Point Forking\n\nBeyond module forking, the build system also forks entire entry points based on environment and release channel.\n\n### Entry Fork Resolution Algorithm\n\n```mermaid\ngraph TB\n    Start["resolveEntryFork()<br/>[build.js:585-633]"]\n    \n    IsFB{Is FB<br/>Bundle?}\n    \n    TryModernClassic["Try .modern.fb.js or .classic.fb.js<br/>(based on __EXPERIMENTAL__)"]\n    \n    TryGenericFB["Try .fb.js"]\n    \n    TryExperimentalStable["Try .experimental.js or .stable.js<br/>(based on __EXPERIMENTAL__)"]\n    \n    UsePlain["Use plain .js"]\n    \n    CheckDev{Is<br/>DEV?}\n    \n    TryDevVariant["Try .development.js variant<br/>at each step"]\n    \n    Return["Return resolved path"]\n    \n    Start --> IsFB\n    IsFB -->|Yes| TryModernClassic\n    TryModernClassic --> CheckDev\n    CheckDev -->|Yes| TryDevVariant\n    CheckDev -->|No| TryGenericFB\n    TryDevVariant --> TryGenericFB\n    TryGenericFB --> TryExperimentalStable\n    IsFB -->|No| TryExperimentalStable\n    TryExperimentalStable --> UsePlain\n    UsePlain --> Return\n```\n\nSources: [scripts/rollup/build.js:585-633]()\n\n**Example Entry Point Variants**\n\nFor `packages/react-dom/src/ReactDOMFB.js`:\n- `ReactDOMFB.modern.fb.js` - Facebook experimental builds\n- `ReactDOMFB.classic.fb.js` - Facebook stable builds  \n- `ReactDOMFB.js` - Base implementation\n\nFor `packages/react/index.js`:\n- `index.experimental.js` - OSS experimental builds\n- `index.stable.js` - OSS stable builds\n- `index.js` - Base implementation\n\n---\n\n## Plugin Pipeline\n\nThe Rollup plugin pipeline transforms source code through multiple stages. The pipeline is constructed in [scripts/rollup/build.js:354-546]().\n\n### Pipeline Stages\n\n```mermaid\ngraph TB\n    Source["Source Code<br/>(Flow/TypeScript)"]\n    \n    DynamicImports["dynamicImports()<br/>Externalize dynamic imports"]\n    \n    TypeRemoval["typescript() or flowRemoveTypes<br/>Strip type annotations"]\n    \n    CommonJS["commonjs()<br/>(TypeScript only)"]\n    \n    Forks["useForks()<br/>Apply module replacements"]\n    \n    ForbidFBJS["forbidFBJSImports()<br/>Block fbjs imports"]\n    \n    Resolve["resolve()<br/>Node module resolution"]\n    \n    StripBanner["stripBanner()<br/>Remove individual license headers"]\n    \n    Babel["babel()<br/>Transpile to ES2015 (+ ES5 in DEV)"]\n    \n    RemoveStrict["Remove \'use strict\'<br/>from individual modules"]\n    \n    Replace["replace()<br/>__DEV__, __PROFILE__, __EXPERIMENTAL__"]\n    \n    ExternalRuntime["externalRuntime()<br/>(for server-external-runtime)"]\n    \n    TopLevel["wrapWithTopLevelDefinitions()<br/>Module boundaries"]\n    \n    Closure["closure()<br/>Minification (SIMPLE mode)"]\n    \n    Prettier["prettier()<br/>Format output"]\n    \n    License["wrapWithLicenseHeader()<br/>Add license"]\n    \n    Sizes["sizes()<br/>Record bundle size"]\n    \n    Output["Output Bundle"]\n    \n    Source --> DynamicImports\n    DynamicImports --> TypeRemoval\n    TypeRemoval --> CommonJS\n    CommonJS --> Forks\n    Forks --> ForbidFBJS\n    ForbidFBJS --> Resolve\n    Resolve --> StripBanner\n    StripBanner --> Babel\n    Babel --> RemoveStrict\n    RemoveStrict --> Replace\n    Replace --> ExternalRuntime\n    ExternalRuntime --> TopLevel\n    TopLevel --> Closure\n    Closure --> Prettier\n    Prettier --> License\n    License --> Sizes\n    Sizes --> Output\n```\n\nSources: [scripts/rollup/build.js:380-539]()\n\n### Key Plugin Details\n\n**Babel Configuration** [scripts/rollup/build.js:143-172]()\n\nBase plugins (all builds):\n- `@babel/plugin-proposal-class-properties` (loose)\n- `@babel/plugin-proposal-object-rest-spread` (loose)\n- `@babel/plugin-transform-template-literals` (loose)\n- `@babel/plugin-transform-for-of`\n- `@babel/plugin-transform-spread` (loose)\n- `@babel/plugin-transform-parameters`\n- `@babel/plugin-transform-destructuring` (loose)\n- Custom `transform-object-assign`\n\nAdditional ES5 plugins (DEV builds only):\n- `@babel/plugin-transform-literals`\n- `@babel/plugin-transform-arrow-functions`\n- `@babel/plugin-transform-block-scoped-functions`\n- `@babel/plugin-transform-shorthand-properties`\n- `@babel/plugin-transform-computed-properties`\n- `@babel/plugin-transform-block-scoping`\n\n**Closure Compiler Configuration** [scripts/rollup/build.js:470-500]()\n\nSettings:\n- `compilation_level: \'SIMPLE\'` - Basic minification without aggressive optimizations\n- `language_in: \'ECMASCRIPT_2020\'`\n- `language_out: \'ECMASCRIPT5_STRICT\'` (except NODE_ES2015  ES2020, BROWSER_SCRIPT  ES5)\n- `renaming: false` - Preserve symbol names (let gzip handle compression)\n- `assume_function_wrapper: true` - Prevent global variable pollution\n\n**Constant Replacement** [scripts/rollup/build.js:432-442]()\n\nThe `replace()` plugin substitutes build-time constants:\n\n```javascript\n__DEV__  \'true\' (development) or \'false\' (production)\n__PROFILE__  \'true\' (profiling/dev) or \'false\' (production)\nprocess.env.NODE_ENV  "\'development\'" or "\'production\'"\n__EXPERIMENTAL__  true/false (based on RELEASE_CHANNEL)\n```\n\n---\n\n## Host Configuration System\n\nThe host configuration system allows React to target different platforms (DOM, React Native, custom renderers) through a common abstraction layer.\n\n### Host Config Registry\n\nHost configurations are registered in [scripts/shared/inlinedHostConfigs.js:9-357](). Each configuration specifies:\n\n| Property | Description |\n|----------|-------------|\n| `shortName` | Identifier for fork resolution (e.g., "dom-browser", "native-fb") |\n| `entryPoints` | Array of entry points that use this config |\n| `paths` | File paths that should use this config |\n| `isServerSupported` | Whether server rendering is supported |\n| `isFlightSupported` | Whether Server Components are supported |\n\n**Major Host Configurations**\n\n```mermaid\ngraph TB\n    subgraph "Browser Environments"\n        DOMBrowser["dom-browser<br/>ReactDOM in browsers<br/>entryPoints: react-dom, react-dom/client"]\n        DOMEdge["dom-edge<br/>Edge runtime<br/>entryPoints: react-dom-server.edge.js"]\n        DOMBun["dom-bun<br/>Bun runtime<br/>entryPoints: react-dom-server.bun.js"]\n    end\n    \n    subgraph "Server Environments"\n        DOMNode["dom-node<br/>Node.js SSR<br/>entryPoints: react-dom-server.node.js"]\n        DOMNodeWebpack["dom-node-webpack<br/>Webpack bundler<br/>entryPoints: react-server-dom-webpack"]\n        DOMNodeTurbopack["dom-node-turbopack<br/>Turbopack bundler<br/>entryPoints: react-server-dom-turbopack"]\n    end\n    \n    subgraph "React Native"\n        NativeFB["native-fb<br/>RN Facebook<br/>entryPoints: react-native-renderer"]\n        NativeOSS["native-oss<br/>RN OSS<br/>entryPoints: react-native-renderer"]\n    end\n    \n    subgraph "Other"\n        ART["art<br/>React ART<br/>entryPoints: react-art"]\n        Test["test<br/>Test renderer<br/>entryPoints: react-test-renderer"]\n        Custom["custom<br/>Custom renderers<br/>entryPoints: react-reconciler"]\n    end\n```\n\nSources: [scripts/shared/inlinedHostConfigs.js:9-357]()\n\n### Fork Path Resolution\n\nThe `findNearestExistingForkFile` function [scripts/rollup/forks.js:29-43]() resolves forks by trying progressively shorter path segments:\n\n```javascript\n// For shortName "dom-node-webpack" and base path \n// "ReactFiberConfig.", tries:\n// 1. ReactFiberConfig.dom-node-webpack.js\n// 2. ReactFiberConfig.dom-node.js  \n// 3. ReactFiberConfig.dom.js\n// Returns first that exists\n```\n\nThis allows sharing implementations across related configs (e.g., `dom-browser` and `dom-node` can share `dom` forks).\n\n---\n\n## Bundle Output Paths\n\nBundle outputs are organized by environment and package. Output path generation is in [scripts/rollup/packaging.js:48-115]().\n\n### Output Directory Structure\n\n```mermaid\ngraph TB\n    BuildRoot["build/"]\n    \n    NodeModules["node_modules/<br/>(OSS packages)"]\n    FBWWW["facebook-www/<br/>(FB internal)"]\n    ReactNative["react-native/<br/>(RN builds)"]\n    FBRN["facebook-react-native/<br/>(FB RN)"]\n    \n    subgraph "Package Structure"\n        PackageDir["&lt;package-name&gt;/"]\n        CJS["cjs/<br/>(CommonJS)"]\n        ESM["esm/<br/>(ES Modules)"]\n        Files["*.js (entry points)"]\n        Package["package.json"]\n    end\n    \n    BuildRoot --> NodeModules\n    BuildRoot --> FBWWW\n    BuildRoot --> ReactNative\n    BuildRoot --> FBRN\n    \n    NodeModules --> PackageDir\n    PackageDir --> CJS\n    PackageDir --> ESM\n    PackageDir --> Files\n    PackageDir --> Package\n```\n\nSources: [scripts/rollup/packaging.js:48-115]()\n\n**Path Generation by Bundle Type**\n\n| Bundle Type | Output Path Pattern |\n|-------------|-------------------|\n| NODE_DEV/PROD/PROFILING | `build/node_modules/<package>/cjs/<filename>` |\n| ESM_DEV/PROD | `build/node_modules/<package>/esm/<filename>` |\n| BUN_DEV/PROD | `build/node_modules/<package>/cjs/<filename>` |\n| FB_WWW_* | `build/facebook-www/<filename>` |\n| RN_OSS_* | `build/react-native/implementations/<filename>` |\n| RN_FB_* (react-native-renderer) | `build/react-native/implementations/<filename>.fb.js` |\n| RN_FB_* (other packages) | `build/facebook-react-native/<package>/cjs/<filename>` |\n| BROWSER_SCRIPT | `build/node_modules/<package>/<outputPath>` |\n\nCode: [scripts/rollup/packaging.js:48-115]()\n\n---\n\n## Code Wrappers\n\nDifferent bundle types require different code wrappers for module boundaries and conditional loading. Wrapper logic is in [scripts/rollup/wrappers.js]().\n\n### Top-Level Definition Wrappers\n\n**NODE_DEV Wrapper** [scripts/rollup/wrappers.js:86-95]()\n\n```javascript\n\'use strict\';\n\nif (process.env.NODE_ENV !== "production") {\n  (function() {\n    // ... bundle code ...\n  })();\n}\n```\n\n**FB_WWW_DEV Wrapper** [scripts/rollup/wrappers.js:107-116]()\n\n```javascript\n\'use strict\';\n\nif (__DEV__) {\n  (function() {\n    // ... bundle code ...\n  })();\n}\n```\n\n**RN_OSS_DEV Wrapper** [scripts/rollup/wrappers.js:128-137]()\n\n```javascript\n\'use strict\';\n\nif (__DEV__) {\n  (function() {\n    // ... bundle code ...\n  })();\n}\n```\n\nSources: [scripts/rollup/wrappers.js:58-169]()\n\n### Reconciler Wrappers\n\nThe reconciler (react-reconciler package) uses a special factory function wrapper that accepts a host config:\n\n**NODE_DEV Reconciler** [scripts/rollup/wrappers.js:172-186]()\n\n```javascript\n\'use strict\';\n\nif (process.env.NODE_ENV !== "production") {\n  module.exports = function $$$reconciler($$$config) {\n    var exports = {};\n    // ... bundle code ...\n    return exports;\n  };\n  module.exports.default = module.exports;\n  Object.defineProperty(module.exports, "__esModule", { value: true });\n}\n```\n\nThis allows custom renderers to provide their own host config at runtime.\n\nSources: [scripts/rollup/wrappers.js:171-263]()\n\n### License Headers\n\nLicense headers vary by bundle type. Example for OSS builds [scripts/rollup/wrappers.js:326-336]():\n\n```javascript\n/**\n * @license React\n * <filename>\n *\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n```\n\nFacebook builds include Flow/lint directives [scripts/rollup/wrappers.js:362-374]():\n\n```javascript\n/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n * ...\n * @noflow\n * @nolint\n * @preventMunge\n * @preserve-invariant-messages\n */\n```\n\nSources: [scripts/rollup/wrappers.js:265-492]()\n\n---\n\n## Build Orchestration\n\nThe main build script [scripts/rollup/build.js]() orchestrates the entire build process.\n\n### Build Execution Flow\n\n```mermaid\ngraph TB\n    Start["buildEverything()<br/>[build.js:828]"]\n    \n    Clean["asyncRimRaf(\'build/\')<br/>Clean output directory"]\n    \n    EnumerateBundles["Enumerate all bundles<br/>[bundles.js:69-1244]"]\n    \n    FilterBundles["Filter by CLI args<br/>(--type, names)"]\n    \n    CISplit["Split across CI nodes<br/>(CI_TOTAL, CI_INDEX)"]\n    \n    ForEachBundle["For each bundle"]\n    \n    Prebuild{Has<br/>prebuild?}\n    \n    RunPrebuild["runShellCommand(bundle.prebuild)"]\n    \n    CreateBundle["createBundle(bundle, bundleType)<br/>[build.js:635-751]"]\n    \n    ResolveEntry["resolveEntryFork()<br/>Pick entry point variant"]\n    \n    GetForks["getForks()<br/>Get module replacements"]\n    \n    ConfigureRollup["Configure Rollup<br/>(input, plugins, externals)"]\n    \n    RunRollup["rollup.rollup(config)"]\n    \n    WriteOutput["result.write(outputPath)"]\n    \n    CopyShims["copyAllShims()<br/>Copy www & RN shims"]\n    \n    PrepareNPM["prepareNpmPackages()<br/>npm pack & extract"]\n    \n    Sync{Sync to<br/>FB repos?}\n    \n    SyncFB["Sync to fbsource/www"]\n    \n    PrintStats["Print build statistics"]\n    \n    Start --> Clean\n    Clean --> EnumerateBundles\n    EnumerateBundles --> FilterBundles\n    FilterBundles --> CISplit\n    CISplit --> ForEachBundle\n    ForEachBundle --> Prebuild\n    Prebuild -->|Yes| RunPrebuild\n    Prebuild -->|No| CreateBundle\n    RunPrebuild --> CreateBundle\n    CreateBundle --> ResolveEntry\n    ResolveEntry --> GetForks\n    GetForks --> ConfigureRollup\n    ConfigureRollup --> RunRollup\n    RunRollup --> WriteOutput\n    WriteOutput --> ForEachBundle\n    ForEachBundle -->|More| ForEachBundle\n    ForEachBundle -->|Done| CopyShims\n    CopyShims --> PrepareNPM\n    PrepareNPM --> Sync\n    Sync -->|Yes| SyncFB\n    Sync -->|No| PrintStats\n    SyncFB --> PrintStats\n```\n\nSources: [scripts/rollup/build.js:828-896]()\n\n### Bundle Filtering\n\nThe build supports filtering via command-line arguments:\n\n**By Bundle Type** (`--type` flag)\n\n```bash\n# Build only Facebook www bundles\nyarn build --type=fb_www\n\n# Build multiple types\nyarn build --type=node_dev,node_prod\n```\n\nCode: [scripts/rollup/build.js:94-98]()\n\n**By Bundle Name** (positional arguments)\n\n```bash\n# Build only react-dom\nyarn build react-dom\n\n# Build multiple packages\nyarn build react react-dom\n```\n\nCode: [scripts/rollup/build.js:100-104](), [scripts/rollup/build.js:548-583]()\n\n**Skip Logic** [scripts/rollup/build.js:548-583]()\n\nA bundle is skipped if:\n1. Its `bundleTypes` array doesn\'t include the target bundle type\n2. User specified `--type` flags and none match\n3. User specified names and the bundle\'s entry doesn\'t match\n\n### Package Preparation\n\nAfter building, packages are prepared for npm publishing [scripts/rollup/packaging.js:253-284]():\n\n1. Copy metadata files (LICENSE, package.json, README.md)\n2. Copy npm/ directory contents (wrapper files)\n3. Filter out non-built entry points from package.json\n4. Run `npm pack` to create tarball\n5. Extract tarball to final location\n6. Delete tarball\n\nThe filtering step [scripts/rollup/packaging.js:171-251]() removes entry points that weren\'t built in the current release channel from `package.json` files field and exports map.\n\nSources: [scripts/rollup/packaging.js:253-284](), [scripts/rollup/packaging.js:171-251]()\n\n---\n\n## External Dependencies\n\nThe build system tracks external dependencies and their import side effects.\n\n### Import Side Effects Registry\n\n[scripts/rollup/modules.js:10-28]() declares whether externals have side effects during import:\n\n```javascript\nconst importSideEffects = Object.freeze({\n  fs: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  \'fs/promises\': HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  path: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  stream: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  \'prop-types/checkPropTypes\': HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  scheduler: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  react: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  \'react-dom\': HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  // ...\n});\n```\n\nThis allows tree-shaking unused DEV-only imports in production builds. The `pureExternalModules` list is passed to Rollup\'s treeshake configuration [scripts/rollup/build.js:656-666]().\n\n### Known Globals\n\nFor UMD/IIFE bundles, external dependencies are mapped to global variables [scripts/rollup/modules.js:31-38]():\n\n```javascript\nconst knownGlobals = Object.freeze({\n  react: \'React\',\n  \'react-dom\': \'ReactDOM\',\n  \'react-dom/server\': \'ReactDOMServer\',\n  scheduler: \'Scheduler\',\n  \'scheduler/unstable_mock\': \'SchedulerMock\',\n  ReactNativeInternalFeatureFlags: \'ReactNativeInternalFeatureFlags\',\n});\n```\n\nSources: [scripts/rollup/modules.js:10-38](), [scripts/rollup/build.js:656-666]()\n\n---\n\n## Special Cases and Edge Cases\n\n### Facebook-Specific Entry Point Aliasing\n\nIn Facebook builds, multiple public entry points may alias to a single internal entry point. For example, `react-dom` and `react-dom/client` both resolve to `ReactDOMFB.js` [scripts/jest/setupHostConfigs.js:18-56]().\n\n### DevTools Integration\n\nCertain bundles wrap code with DevTools hooks for profiling [scripts/rollup/wrappers.js:32-51]():\n\n```javascript\nif (\n  typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== \'undefined\' &&\n  typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart === \'function\'\n) {\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error());\n}\n// ... bundle code ...\nif (\n  typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== \'undefined\' &&\n  typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop === \'function\'\n) {\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error());\n}\n```\n\nThis is controlled by `wrapWithModuleBoundaries` in bundle configs.\n\n### Reconciler Factory Pattern\n\nThe `react-reconciler` package exports a factory function rather than direct exports [scripts/rollup/wrappers.js:171-263](), allowing custom renderers to provide their own host config:\n\n```javascript\nconst Reconciler = require(\'react-reconciler\');\nconst reconciler = Reconciler({\n  // custom host config\n  createInstance() { /*...*/ },\n  appendInitialChild() { /*...*/ },\n  // ...\n});\n```\n\n### .new and .old File System\n\nThe React codebase uses a `.new.js` / `.old.js` suffix pattern for staged changes (not explicitly shown in build code but mentioned in documentation). The build system doesn\'t special-case these - they\'re selected via the entry point or fork resolution mechanisms.\n\nSources: [scripts/rollup/wrappers.js:32-51](), [scripts/rollup/wrappers.js:171-263](), [scripts/jest/setupHostConfigs.js:18-56]()\n\n---\n\n# Page: Release Channels and Versioning\n\n# Release Channels and Versioning\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/shared/ReactFeatureFlags.js](packages/shared/ReactFeatureFlags.js)\n- [packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js](packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js)\n- [packages/shared/forks/ReactFeatureFlags.native-fb.js](packages/shared/forks/ReactFeatureFlags.native-fb.js)\n- [packages/shared/forks/ReactFeatureFlags.native-oss.js](packages/shared/forks/ReactFeatureFlags.native-oss.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.js](packages/shared/forks/ReactFeatureFlags.test-renderer.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js](packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.www.js](packages/shared/forks/ReactFeatureFlags.test-renderer.www.js)\n- [packages/shared/forks/ReactFeatureFlags.www-dynamic.js](packages/shared/forks/ReactFeatureFlags.www-dynamic.js)\n- [packages/shared/forks/ReactFeatureFlags.www.js](packages/shared/forks/ReactFeatureFlags.www.js)\n- [scripts/flow/xplat.js](scripts/flow/xplat.js)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React\'s release channel system and versioning strategy, which enables the codebase to ship different feature sets to different environments from a single source tree. The release channel system determines which experimental features are included in builds, how entry points are resolved, and where build artifacts are placed.\n\nFor information about how feature flags control individual features within a release channel, see [Feature Flags System](#2). For details on the build pipeline that processes these channels, see [Build Pipeline and Module Forking](#3.1).\n\n---\n\n## Release Channel Fundamentals\n\nReact uses a release channel system to control which features are enabled at build time. The `RELEASE_CHANNEL` environment variable determines the channel, which propagates throughout the build system as the `__EXPERIMENTAL__` constant.\n\n### Channel Types\n\n| Channel | __EXPERIMENTAL__ Value | Purpose |\n|---------|----------------------|---------|\n| `experimental` | `true` | Includes all experimental features, used for canary releases and internal testing |\n| `stable` (default) | `true` (when unset) | Standard releases with stable features only |\n| Facebook-specific | varies | Internal Facebook builds may use custom channels |\n\nThe core logic appears in [scripts/rollup/bundles.js:3-8]() and [scripts/rollup/build.js:31-38]():\n\n```javascript\nconst RELEASE_CHANNEL = process.env.RELEASE_CHANNEL;\n\nconst __EXPERIMENTAL__ =\n  typeof RELEASE_CHANNEL === \'string\'\n    ? RELEASE_CHANNEL === \'experimental\'\n    : true;\n```\n\n**Key behavior**: When `RELEASE_CHANNEL` is undefined, `__EXPERIMENTAL__` defaults to `true`, making experimental the default during development.\n\n### Release Channel Flow\n\n```mermaid\ngraph TB\n    EnvVar["process.env.RELEASE_CHANNEL"]\n    CheckType{"typeof === \'string\'?"}\n    CheckValue{"value === \'experimental\'?"}\n    DefaultTrue["__EXPERIMENTAL__ = true"]\n    SetTrue["__EXPERIMENTAL__ = true"]\n    SetFalse["__EXPERIMENTAL__ = false"]\n    \n    EnvVar --> CheckType\n    CheckType -->|"Yes"| CheckValue\n    CheckType -->|"No (undefined)"| DefaultTrue\n    CheckValue -->|"Yes"| SetTrue\n    CheckValue -->|"No"| SetFalse\n    \n    DefaultTrue --> PropagateToPlugins["Propagate to Rollup plugins"]\n    SetTrue --> PropagateToPlugins\n    SetFalse --> PropagateToPlugins\n    \n    PropagateToPlugins --> ReplacePlugin["@rollup/plugin-replace"]\n    PropagateToPlugins --> EntryForkResolution["Entry Point Fork Resolution"]\n    PropagateToPlugins --> FeatureFlagSelection["Feature Flag Configuration"]\n    \n    ReplacePlugin --> CodeTransform["__EXPERIMENTAL__  true/false in source"]\n    EntryForkResolution --> FileSelection[".experimental.js vs .stable.js"]\n    FeatureFlagSelection --> FlagValues["Flag true/false values"]\n```\n\nSources: [scripts/rollup/bundles.js:3-8](), [scripts/rollup/build.js:31-38](), [scripts/rollup/build.js:432-442]()\n\n---\n\n## Bundle Types and Target Environments\n\nReact generates multiple bundle variants for different environments, runtimes, and optimization levels. These bundle types form a matrix with release channels to determine the final build artifacts.\n\n### Bundle Type Categories\n\nThe build system defines bundle types in [scripts/rollup/bundles.js:10-31]():\n\n**Node.js Bundles**\n- `NODE_ES2015` - ES2015+ syntax for modern Node\n- `NODE_DEV` - Development builds with guards\n- `NODE_PROD` - Minified production builds\n- `NODE_PROFILING` - Profiling-enabled builds\n\n**Browser Bundles**\n- `ESM_DEV` - ES modules for development\n- `ESM_PROD` - ES modules for production\n- `BROWSER_SCRIPT` - Standalone browser scripts\n\n**Facebook Internal**\n- `FB_WWW_DEV` - Facebook web development\n- `FB_WWW_PROD` - Facebook web production\n- `FB_WWW_PROFILING` - Facebook web with profiling\n\n**React Native**\n- `RN_OSS_DEV/PROD/PROFILING` - Open source React Native\n- `RN_FB_DEV/PROD/PROFILING` - Facebook\'s internal React Native\n\n**Bun Runtime**\n- `BUN_DEV` - Bun development builds\n- `BUN_PROD` - Bun production builds\n\n### Bundle Type Characteristics\n\n```mermaid\ngraph LR\n    BundleType["Bundle Type"]\n    \n    subgraph "Production vs Development"\n        ProdCheck["isProductionBundleType()"]\n        DevGuards["if (process.env.NODE_ENV !== \'production\')"]\n        DevCode["Development-only code"]\n    end\n    \n    subgraph "Profiling"\n        ProfCheck["isProfilingBundleType()"]\n        ProfFlag["__PROFILE__ = true"]\n        ProfFeatures["Profiling APIs enabled"]\n    end\n    \n    subgraph "Module Format"\n        FormatCheck["getFormat()"]\n        CJS["CommonJS (cjs)"]\n        ESM["ES Modules (es)"]\n        IIFE["IIFE (iife)"]\n    end\n    \n    subgraph "Environment Flags"\n        FlagsCheck["getBundleTypeFlags()"]\n        IsFBWWW["isFBWWWBundle"]\n        IsRN["isRNBundle"]\n        IsFBRN["isFBRNBundle"]\n    end\n    \n    BundleType --> ProdCheck\n    BundleType --> ProfCheck\n    BundleType --> FormatCheck\n    BundleType --> FlagsCheck\n    \n    ProdCheck --> DevGuards\n    DevGuards --> DevCode\n    \n    ProfCheck --> ProfFlag\n    ProfFlag --> ProfFeatures\n    \n    FormatCheck --> CJS\n    FormatCheck --> ESM\n    FormatCheck --> IIFE\n    \n    FlagsCheck --> IsFBWWW\n    FlagsCheck --> IsRN\n    FlagsCheck --> IsFBRN\n```\n\nThe classification logic is in [scripts/rollup/build.js:253-310]():\n\n```javascript\nfunction isProductionBundleType(bundleType) {\n  switch (bundleType) {\n    case NODE_DEV:\n    case FB_WWW_DEV:\n    case RN_OSS_DEV:\n      return false;\n    case NODE_PROD:\n    case FB_WWW_PROD:\n      return true;\n    // ...\n  }\n}\n```\n\nSources: [scripts/rollup/bundles.js:10-54](), [scripts/rollup/build.js:225-310](), [scripts/rollup/build.js:312-338]()\n\n---\n\n## Entry Point Fork Resolution\n\nReact uses file naming conventions to provide different implementations for different release channels and environments. The build system resolves these "forks" at build time.\n\n### Fork Resolution Priority\n\nEntry points are resolved with the following priority order, from most specific to least specific:\n\n1. `.modern.fb.js` / `.classic.fb.js` (Facebook builds)\n2. `.fb.js` (generic Facebook)\n3. `.experimental.js` / `.stable.js` (release channel)\n4. `.development.js` (development mode)\n5. `.js` (base file)\n\n### Entry Point Resolution Algorithm\n\n```mermaid\ngraph TB\n    ResolveEntry["resolveEntryFork(resolvedEntry, isFBBundle, isDev)"]\n    \n    CheckFB{"isFBBundle?"}\n    \n    subgraph "Facebook Fork Resolution"\n        TryModernFB["Try: entry.modern.fb.js"]\n        ExistsModernFB{"File exists?"}\n        TryModernFBDev["Try: entry.modern.fb.development.js"]\n        ExistsModernFBDev{"File exists?"}\n        \n        TryClassicFB["Try: entry.classic.fb.js"]\n        ExistsClassicFB{"File exists?"}\n        TryClassicFBDev["Try: entry.classic.fb.development.js"]\n        ExistsClassicFBDev{"File exists?"}\n        \n        TryGenericFB["Try: entry.fb.js"]\n        ExistsGenericFB{"File exists?"}\n        TryGenericFBDev["Try: entry.fb.development.js"]\n        ExistsGenericFBDev{"File exists?"}\n    end\n    \n    subgraph "Channel Fork Resolution"\n        TryExp["Try: entry.experimental.js"]\n        ExistsExp{"File exists?"}\n        TryExpDev["Try: entry.experimental.development.js"]\n        ExistsExpDev{"File exists?"}\n        \n        TryStable["Try: entry.stable.js"]\n        ExistsStable{"File exists?"}\n        TryStableDev["Try: entry.stable.development.js"]\n        ExistsStableDev{"File exists?"}\n    end\n    \n    TryPlainDev["Try: entry.development.js"]\n    ExistsPlainDev{"File exists?"}\n    \n    UsePlain["Use: entry.js"]\n    \n    ResolveEntry --> CheckFB\n    \n    CheckFB -->|"Yes && __EXPERIMENTAL__"| TryModernFBDev\n    CheckFB -->|"Yes && !__EXPERIMENTAL__"| TryClassicFBDev\n    CheckFB -->|"No"| TryExpDev\n    \n    TryModernFBDev --> ExistsModernFBDev\n    ExistsModernFBDev -->|"Yes && isDev"| Return1["Return modern.fb.development.js"]\n    ExistsModernFBDev -->|"No"| TryModernFB\n    \n    TryModernFB --> ExistsModernFB\n    ExistsModernFB -->|"Yes"| Return2["Return modern.fb.js"]\n    ExistsModernFB -->|"No"| TryGenericFBDev\n    \n    TryClassicFBDev --> ExistsClassicFBDev\n    ExistsClassicFBDev -->|"Yes && isDev"| Return3["Return classic.fb.development.js"]\n    ExistsClassicFBDev -->|"No"| TryClassicFB\n    \n    TryClassicFB --> ExistsClassicFB\n    ExistsClassicFB -->|"Yes"| Return4["Return classic.fb.js"]\n    ExistsClassicFB -->|"No"| TryGenericFBDev\n    \n    TryGenericFBDev --> ExistsGenericFBDev\n    ExistsGenericFBDev -->|"Yes && isDev"| Return5["Return fb.development.js"]\n    ExistsGenericFBDev -->|"No"| TryGenericFB\n    \n    TryGenericFB --> ExistsGenericFB\n    ExistsGenericFB -->|"Yes"| Return6["Return fb.js"]\n    ExistsGenericFB -->|"No"| TryExpDev\n    \n    TryExpDev --> ExistsExpDev\n    ExistsExpDev -->|"Yes && isDev && __EXPERIMENTAL__"| Return7["Return experimental.development.js"]\n    ExistsExpDev -->|"No"| TryExp\n    \n    TryExp --> ExistsExp\n    ExistsExp -->|"Yes && __EXPERIMENTAL__"| Return8["Return experimental.js"]\n    ExistsExp -->|"No"| TryStableDev\n    \n    TryStableDev --> ExistsStableDev\n    ExistsStableDev -->|"Yes && isDev && !__EXPERIMENTAL__"| Return9["Return stable.development.js"]\n    ExistsStableDev -->|"No"| TryStable\n    \n    TryStable --> ExistsStable\n    ExistsStable -->|"Yes && !__EXPERIMENTAL__"| Return10["Return stable.js"]\n    ExistsStable -->|"No"| TryPlainDev\n    \n    TryPlainDev --> ExistsPlainDev\n    ExistsPlainDev -->|"Yes && isDev"| Return11["Return development.js"]\n    ExistsPlainDev -->|"No"| UsePlain\n    \n    UsePlain --> Return12["Return entry.js"]\n```\n\nThe implementation is in [scripts/rollup/build.js:585-633]():\n\n```javascript\nfunction resolveEntryFork(resolvedEntry, isFBBundle, isDev) {\n  if (isFBBundle) {\n    const resolvedFBEntry = resolvedEntry.replace(\n      \'.js\',\n      __EXPERIMENTAL__ ? \'.modern.fb.js\' : \'.classic.fb.js\'\n    );\n    const devFBEntry = resolvedFBEntry.replace(\'.js\', \'.development.js\');\n    if (isDev && fs.existsSync(devFBEntry)) {\n      return devFBEntry;\n    }\n    if (fs.existsSync(resolvedFBEntry)) {\n      return resolvedFBEntry;\n    }\n    // Falls through to generic .fb.js, then to channel forks\n  }\n  \n  const resolvedForkedEntry = resolvedEntry.replace(\n    \'.js\',\n    __EXPERIMENTAL__ ? \'.experimental.js\' : \'.stable.js\'\n  );\n  // ...\n}\n```\n\nSources: [scripts/rollup/build.js:585-633](), [scripts/jest/setupHostConfigs.js:7-99]()\n\n---\n\n## Interaction with Feature Flags\n\nRelease channels directly influence which feature flag configurations are loaded. The fork resolution system (documented in [Feature Flags System](#2)) selects flag files based on both the bundle type and release channel.\n\n### Feature Flag Fork Selection\n\nThe feature flag forking logic in [scripts/rollup/forks.js:134-191]() demonstrates the relationship:\n\n```javascript\n\'./packages/shared/ReactFeatureFlags.js\': (bundleType, entry) => {\n  switch (entry) {\n    case \'react-native-renderer\':\n      switch (bundleType) {\n        case RN_FB_DEV:\n        case RN_FB_PROD:\n          return \'./packages/shared/forks/ReactFeatureFlags.native-fb.js\';\n        case RN_OSS_DEV:\n        case RN_OSS_PROD:\n          return \'./packages/shared/forks/ReactFeatureFlags.native-oss.js\';\n      }\n    default:\n      switch (bundleType) {\n        case FB_WWW_DEV:\n        case FB_WWW_PROD:\n          return \'./packages/shared/forks/ReactFeatureFlags.www.js\';\n      }\n  }\n  return null; // Use canonical flags\n}\n```\n\n### Channel-Dependent Flag Values\n\nCertain flags have their values controlled by `__EXPERIMENTAL__`:\n\n```mermaid\ngraph LR\n    subgraph "Canonical Flags"\n        CanonicalFile["ReactFeatureFlags.js"]\n        FlagDefinitions["Flag = __EXPERIMENTAL__"]\n    end\n    \n    subgraph "Environment Forks"\n        WWWFork["ReactFeatureFlags.www.js"]\n        NativeFBFork["ReactFeatureFlags.native-fb.js"]\n        NativeOSSFork["ReactFeatureFlags.native-oss.js"]\n        TestRendererFork["ReactFeatureFlags.test-renderer.js"]\n    end\n    \n    subgraph "Dynamic Flags"\n        WWWDynamic["ReactFeatureFlags.www-dynamic.js"]\n        NativeFBDynamic["ReactFeatureFlags.native-fb-dynamic.js"]\n        VariantFlag["Flag = __VARIANT__"]\n    end\n    \n    EXPERIMENTAL["__EXPERIMENTAL__ constant"]\n    \n    EXPERIMENTAL --> CanonicalFile\n    CanonicalFile --> FlagDefinitions\n    \n    FlagDefinitions -.overrides.-> WWWFork\n    FlagDefinitions -.overrides.-> NativeFBFork\n    FlagDefinitions -.overrides.-> NativeOSSFork\n    FlagDefinitions -.overrides.-> TestRendererFork\n    \n    WWWFork --> WWWDynamic\n    NativeFBFork --> NativeFBDynamic\n    \n    WWWDynamic --> VariantFlag\n    NativeFBDynamic --> VariantFlag\n```\n\nExamples from [packages/shared/ReactFeatureFlags.js:75-100]():\n\n```javascript\nexport const enableLegacyCache = __EXPERIMENTAL__;\nexport const enableAsyncIterableChildren = __EXPERIMENTAL__;\nexport const enableTaint = __EXPERIMENTAL__;\nexport const enableGestureTransition = __EXPERIMENTAL__;\nexport const enableFizzBlockingRender = __EXPERIMENTAL__;\n```\n\nSources: [scripts/rollup/forks.js:134-191](), [packages/shared/ReactFeatureFlags.js:75-100](), [packages/shared/forks/ReactFeatureFlags.www.js:1-119]()\n\n---\n\n## Build Output Organization\n\nBuild artifacts are organized by environment, with different directory structures for different deployment targets.\n\n### Output Path Resolution\n\nThe `getBundleOutputPath()` function in [scripts/rollup/packaging.js:48-115]() determines where each bundle is written:\n\n| Bundle Type | Output Path Pattern | Example |\n|-------------|-------------------|---------|\n| NODE_ES2015, NODE_DEV, NODE_PROD, NODE_PROFILING | `build/node_modules/{package}/cjs/{filename}` | `build/node_modules/react/cjs/react.development.js` |\n| ESM_DEV, ESM_PROD | `build/node_modules/{package}/esm/{filename}` | `build/node_modules/react/esm/react.development.js` |\n| BUN_DEV, BUN_PROD | `build/node_modules/{package}/cjs/{filename}` | `build/node_modules/react-dom/cjs/react-dom-server.bun.development.js` |\n| FB_WWW_* | `build/facebook-www/{filename}` | `build/facebook-www/React-prod.classic.js` |\n| RN_OSS_* | `build/react-native/implementations/{filename}` | `build/react-native/implementations/ReactFabric-prod.js` |\n| RN_FB_* (most packages) | `build/facebook-react-native/{package}/cjs/{filename}` | `build/facebook-react-native/react/cjs/react.production.js` |\n| RN_FB_* (renderer) | `build/react-native/implementations/{filename}.fb.js` | `build/react-native/implementations/ReactFabric-prod.fb.js` |\n| BROWSER_SCRIPT | `build/node_modules/{package}/{outputPath}` | `build/node_modules/react-dom/unstable_server-external-runtime.js` |\n\n### Build Directory Structure\n\n```mermaid\ngraph TB\n    BuildRoot["build/"]\n    \n    subgraph "npm Packages"\n        NodeModules["node_modules/"]\n        PackageDir["react/, react-dom/, etc."]\n        CJSDir["cjs/"]\n        ESMDir["esm/"]\n        CJSFiles["*.development.js<br/>*.production.js<br/>*.profiling.js"]\n        ESMFiles["*.development.js<br/>*.production.js"]\n    end\n    \n    subgraph "Facebook Web"\n        FBWWW["facebook-www/"]\n        WWWFiles["React-prod.classic.js<br/>React-dev.classic.js<br/>ReactDOM-prod.modern.js"]\n        WWWShims["shims/"]\n    end\n    \n    subgraph "React Native"\n        RN["react-native/"]\n        RNImplementations["implementations/"]\n        RNShims["shims/"]\n        RNFiles["ReactFabric-dev.js<br/>ReactFabric-prod.fb.js"]\n    end\n    \n    subgraph "Facebook React Native"\n        FBRN["facebook-react-native/"]\n        FBRNPackages["react/, react-dom/, etc."]\n        FBRNCJSDir["cjs/"]\n        FBRNCJSFiles["*.development.js<br/>*.production.js"]\n    end\n    \n    BuildRoot --> NodeModules\n    BuildRoot --> FBWWW\n    BuildRoot --> RN\n    BuildRoot --> FBRN\n    \n    NodeModules --> PackageDir\n    PackageDir --> CJSDir\n    PackageDir --> ESMDir\n    CJSDir --> CJSFiles\n    ESMDir --> ESMFiles\n    \n    FBWWW --> WWWFiles\n    FBWWW --> WWWShims\n    \n    RN --> RNImplementations\n    RN --> RNShims\n    RNImplementations --> RNFiles\n    \n    FBRN --> FBRNPackages\n    FBRNPackages --> FBRNCJSDir\n    FBRNCJSDir --> FBRNCJSFiles\n```\n\nSources: [scripts/rollup/packaging.js:48-115](), [scripts/rollup/packaging.js:117-137]()\n\n---\n\n## Package Preparation and Distribution\n\nAfter building, packages undergo preparation steps to make them ready for distribution. The process varies by target environment.\n\n### npm Package Preparation\n\nThe `prepareNpmPackages()` function in [scripts/rollup/packaging.js:253-284]() performs the following steps:\n\n1. **Copy package metadata**: LICENSE, package.json, README.md, npm/ directory\n2. **Filter entry points**: Remove entry points not built for the current channel using `filterOutEntrypoints()`\n3. **Pack and extract**: Use `npm pack` to create a tarball, then extract it\n\n### Entry Point Filtering\n\nThe `filterOutEntrypoints()` function in [scripts/rollup/packaging.js:171-251]() removes entry points from package.json that weren\'t built for the current release channel:\n\n```mermaid\ngraph TB\n    PackageJSON["Read package.json"]\n    FilesArray["files: []"]\n    ExportsField["exports: {}"]\n    BrowserField["browser: {}"]\n    \n    IterateFiles["For each file in files[]"]\n    DetermineEntry["Determine entry point name"]\n    CheckBundle{"Has bundle for<br/>this entry?"}\n    \n    KeepFile["Keep in files[]<br/>Keep in exports"]\n    RemoveFile["Remove from files[]<br/>Delete from exports<br/>unlink() from disk"]\n    \n    WriteJSON["Write updated package.json"]\n    \n    PackageJSON --> FilesArray\n    PackageJSON --> ExportsField\n    PackageJSON --> BrowserField\n    \n    FilesArray --> IterateFiles\n    IterateFiles --> DetermineEntry\n    DetermineEntry --> CheckBundle\n    \n    CheckBundle -->|"Yes"| KeepFile\n    CheckBundle -->|"No (wrong channel)"| RemoveFile\n    \n    KeepFile --> WriteJSON\n    RemoveFile --> WriteJSON\n```\n\nThe function uses the `entryPointsToHasBundle` map built in [scripts/rollup/packaging.js:158-169]():\n\n```javascript\nlet entryPointsToHasBundle = new Map();\nfor (const bundle of Bundles.bundles) {\n  const hasNonFBBundleTypes = bundle.bundleTypes.some(\n    type =>\n      type !== FB_WWW_DEV && type !== FB_WWW_PROD && type !== FB_WWW_PROFILING\n  );\n  entryPointsToHasBundle.set(bundle.entry, hasNonFBBundleTypes);\n}\n```\n\nThis ensures that if a bundle is only built for internal Facebook use, it won\'t appear in the public npm package.\n\n### Conditional Package Exports\n\nReact uses package.json `exports` field to provide different entry points based on environment. Entry points may include suffixes like `.react-server` or `.rsc` that inherit their bundle status from the base entry point:\n\n```javascript\nif (entry.endsWith(\'.react-server\')) {\n  hasBundle = entryPointsToHasBundle.get(\n    entry.slice(0, \'.react-server\'.length * -1)\n  );\n} else if (entry.endsWith(\'.rsc\')) {\n  hasBundle = entryPointsToHasBundle.get(\n    entry.slice(0, \'.rsc\'.length * -1)\n  );\n}\n```\n\nFrom [scripts/rollup/packaging.js:197-205]().\n\n### Server Entry Point Distribution\n\nReact provides multiple server rendering entry points with conditional loading based on `process.env.NODE_ENV`. These are demonstrated in npm wrapper files:\n\n**Node.js Server** - [packages/react-dom/npm/server.node.js:1-19]():\n```javascript\nvar l, s;\nif (process.env.NODE_ENV === \'production\') {\n  l = require(\'./cjs/react-dom-server-legacy.node.production.js\');\n  s = require(\'./cjs/react-dom-server.node.production.js\');\n} else {\n  l = require(\'./cjs/react-dom-server-legacy.node.development.js\');\n  s = require(\'./cjs/react-dom-server.node.development.js\');\n}\n\nexports.renderToString = l.renderToString;\nexports.renderToStaticMarkup = l.renderToStaticMarkup;\nexports.renderToPipeableStream = s.renderToPipeableStream;\n```\n\n**Browser Server** - [packages/react-dom/npm/server.browser.js:1-17]()\n\n**Bun Server** - [packages/react-dom/npm/server.bun.js:1-20]()\n\n**Edge Runtime** - [packages/react-dom/npm/server.edge.js:1-18]()\n\nEach runtime has slightly different API surfaces based on capabilities. For example, `renderToPipeableStream` is only available in Node.js and Bun, not in the browser.\n\nSources: [scripts/rollup/packaging.js:158-273](), [packages/react-dom/npm/server.node.js:1-19](), [packages/react-dom/npm/server.browser.js:1-17](), [packages/react-dom/npm/server.bun.js:1-20]()\n\n---\n\n## Release Channel Usage in Tests\n\nThe test infrastructure respects release channels through environment setup. The `setupHostConfigs.js` file in [scripts/jest/setupHostConfigs.js:7-99]() uses the same `resolveEntryFork()` logic to ensure tests load the correct entry points.\n\n### Test Environment Globals\n\nTests can set global flags to simulate different environments:\n\n- `global.__WWW__` - Simulates Facebook web environment\n- `global.__XPLAT__` - Simulates cross-platform (React Native) environment  \n- `global.__DEV__` - Simulates development vs production mode\n- `__EXPERIMENTAL__` - Set based on test configuration to simulate different channels\n\nThese globals interact with `resolveEntryFork()` to load the appropriate module variants:\n\n```javascript\nfunction mockReact() {\n  jest.mock(\'react\', () => {\n    const resolvedEntryPoint = resolveEntryFork(\n      require.resolve(\'react\'),\n      global.__WWW__ || global.__XPLAT__,\n      global.__DEV__\n    );\n    return jest.requireActual(resolvedEntryPoint);\n  });\n}\n```\n\nFrom [scripts/jest/setupHostConfigs.js:101-115]().\n\nSources: [scripts/jest/setupHostConfigs.js:7-115]()\n\n---\n\n# Page: CI/CD and Artifact Management\n\n# CI/CD and Artifact Management\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\nThis document describes the build artifact generation, packaging, and distribution system in the React repository. It covers the build pipeline that produces multiple bundle variants, npm package preparation, Facebook internal synchronization, and validation processes.\n\nFor information about the build system\'s bundle configuration and plugin pipeline, see [Build Pipeline and Module Forking](#3.1). For release channel management, see [Release Channels and Versioning](#3.2).\n\n---\n\n## Build Artifact Structure\n\nThe React build system generates artifacts in multiple formats and configurations, organized by deployment target and environment.\n\n### Bundle Types\n\nThe build system produces 13 distinct bundle types, each targeting specific runtime environments:\n\n| Bundle Type | Format | Environment | Purpose |\n|------------|--------|-------------|---------|\n| `NODE_ES2015` | CJS | Node.js | ES2015+ features, modern Node |\n| `NODE_DEV` | CJS | Node.js | Development with DEV checks |\n| `NODE_PROD` | CJS | Node.js | Production, minified |\n| `NODE_PROFILING` | CJS | Node.js | Production with profiling |\n| `BUN_DEV` | CJS | Bun runtime | Development for Bun |\n| `BUN_PROD` | CJS | Bun runtime | Production for Bun |\n| `ESM_DEV` | ESM | Browsers/Bundlers | ES Module development |\n| `ESM_PROD` | ESM | Browsers/Bundlers | ES Module production |\n| `FB_WWW_DEV` | CJS | Facebook web | Internal development |\n| `FB_WWW_PROD` | CJS | Facebook web | Internal production |\n| `FB_WWW_PROFILING` | CJS | Facebook web | Internal profiling |\n| `RN_OSS_DEV` | CJS | React Native OSS | RN open source dev |\n| `RN_OSS_PROD` | CJS | React Native OSS | RN open source prod |\n| `RN_OSS_PROFILING` | CJS | React Native OSS | RN open source profiling |\n| `RN_FB_DEV` | CJS | React Native FB | RN internal dev |\n| `RN_FB_PROD` | CJS | React Native FB | RN internal prod |\n| `RN_FB_PROFILING` | CJS | React Native FB | RN internal profiling |\n| `BROWSER_SCRIPT` | IIFE | Browser | Direct script inclusion |\n\n**Sources:** [scripts/rollup/bundles.js:10-31](), [scripts/rollup/build.js:50-71]()\n\n### Output Directory Structure\n\n```mermaid\ngraph TB\n    Build["build/"]\n    \n    NodeModules["node_modules/"]\n    FacebookWWW["facebook-www/"]\n    FacebookRN["facebook-react-native/"]\n    ReactNative["react-native/"]\n    \n    Build --> NodeModules\n    Build --> FacebookWWW\n    Build --> FacebookRN\n    Build --> ReactNative\n    \n    NodeModules --> ReactPkg["react/"]\n    NodeModules --> ReactDOMPkg["react-dom/"]\n    NodeModules --> SchedulerPkg["scheduler/"]\n    \n    ReactPkg --> ReactCJS["cjs/"]\n    ReactPkg --> ReactESM["esm/"]\n    ReactPkg --> ReactNPM["npm/"]\n    \n    ReactDOMPkg --> DOMcjs["cjs/"]\n    ReactDOMPkg --> DOMesm["esm/"]\n    \n    FacebookWWW --> WWWBundles["*.js (FB_WWW_* bundles)"]\n    FacebookWWW --> WWWShims["shims/"]\n    \n    ReactNative --> RNImplementations["implementations/"]\n    ReactNative --> RNShims["shims/"]\n    \n    FacebookRN --> FBRNReact["react/cjs/"]\n    FacebookRN --> FBRNReactDOM["react-dom/cjs/"]\n    FacebookRN --> FBRNScheduler["scheduler/cjs/"]\n```\n\n**Sources:** [scripts/rollup/packaging.js:48-114]()\n\n---\n\n## Build Pipeline\n\n### Build Orchestration\n\nThe build process is orchestrated by `build.js`, which coordinates bundle generation across all configurations:\n\n```mermaid\ngraph TB\n    Entry["Build Entry Point<br/>scripts/rollup/build.js"]\n    \n    ParseArgs["Parse CLI Arguments<br/>--type, bundle names, --watch"]\n    LoadBundles["Load Bundle Configs<br/>from bundles.js"]\n    FilterBundles["Filter by Requested<br/>Types and Names"]\n    \n    Entry --> ParseArgs\n    ParseArgs --> LoadBundles\n    LoadBundles --> FilterBundles\n    \n    subgraph "For Each Bundle"\n        ResolveEntry["Resolve Entry Fork<br/>resolveEntryFork()"]\n        GetPlugins["Build Plugin Pipeline<br/>getPlugins()"]\n        ConfigRollup["Configure Rollup<br/>input, external, treeshake"]\n        RunRollup["Execute Rollup Build"]\n        WrapOutput["Apply Wrappers<br/>license, module boundaries"]\n        RecordSize["Record Bundle Size<br/>to Stats"]\n    end\n    \n    FilterBundles --> ResolveEntry\n    ResolveEntry --> GetPlugins\n    GetPlugins --> ConfigRollup\n    ConfigRollup --> RunRollup\n    RunRollup --> WrapOutput\n    WrapOutput --> RecordSize\n    \n    RecordSize --> PackagePrep["Prepare NPM Packages<br/>prepareNpmPackages()"]\n    RecordSize --> CopyShims["Copy Shims<br/>copyAllShims()"]\n    RecordSize --> Sync["Sync to Facebook<br/>if --sync-* args"]\n```\n\n**Sources:** [scripts/rollup/build.js:635-785](), [scripts/rollup/build.js:94-108]()\n\n### Entry Point Resolution\n\nEntry points use a forking mechanism to select environment-specific implementations:\n\n```mermaid\ngraph LR\n    BaseEntry["base/entry.js"]\n    \n    FBModern[".modern.fb.js"]\n    FBClassic[".classic.fb.js"]\n    FBGeneric[".fb.js"]\n    Experimental[".experimental.js"]\n    Stable[".stable.js"]\n    DevVariant[".development.js"]\n    \n    BaseEntry -->|"FB_WWW + __EXPERIMENTAL__"| FBModern\n    BaseEntry -->|"FB_WWW + !__EXPERIMENTAL__"| FBClassic\n    BaseEntry -->|"FB_WWW (fallback)"| FBGeneric\n    BaseEntry -->|"!FB + __EXPERIMENTAL__"| Experimental\n    BaseEntry -->|"!FB + !__EXPERIMENTAL__"| Stable\n    \n    FBModern -.->|"isDev"| DevVariant\n    Experimental -.->|"isDev"| DevVariant\n```\n\n**Sources:** [scripts/rollup/build.js:585-633]()\n\n### Plugin Pipeline\n\nEach bundle type uses a customized Rollup plugin pipeline:\n\n```mermaid\ngraph TB\n    SourceCode["Source Code<br/>(Flow/TypeScript)"]\n    \n    subgraph "Preprocessing"\n        DynamicImports["dynamicImports()<br/>Keep dynamic imports external"]\n        TypeRemoval["Flow/TypeScript Removal<br/>flowRemoveTypes() or typescript()"]\n        CommonJS["commonjs()<br/>For TypeScript bundles only"]\n    end\n    \n    subgraph "Module Resolution"\n        Forks["useForks()<br/>Environment-specific modules"]\n        ForbidFB["forbidFBJSImports()<br/>Prevent fbjs imports"]\n        Resolve["resolve()<br/>Node module resolution"]\n    end\n    \n    subgraph "Transformation"\n        StripBanner["stripBanner()<br/>Remove license headers"]\n        Babel["babel()<br/>ES2015+  ES5"]\n        RemoveStrict["Remove \'use strict\'"]\n        Replace["replace()<br/>__DEV__, __PROFILE__, etc"]\n        External["externalRuntime()<br/>For server-external-runtime"]\n    end\n    \n    subgraph "Optimization"\n        TopLevel["wrapWithTopLevelDefinitions()<br/>Module boundaries"]\n        Closure["closure()<br/>Google Closure Compiler"]\n        Prettier["prettier()<br/>Format output"]\n    end\n    \n    subgraph "Finalization"\n        License["wrapWithLicenseHeader()"]\n        Sizes["sizes()<br/>Record bundle metrics"]\n    end\n    \n    SourceCode --> DynamicImports\n    DynamicImports --> TypeRemoval\n    TypeRemoval --> CommonJS\n    CommonJS --> Forks\n    Forks --> ForbidFB\n    ForbidFB --> Resolve\n    Resolve --> StripBanner\n    StripBanner --> Babel\n    Babel --> RemoveStrict\n    RemoveStrict --> Replace\n    Replace --> External\n    External --> TopLevel\n    TopLevel --> Closure\n    Closure --> Prettier\n    Prettier --> License\n    License --> Sizes\n```\n\n**Sources:** [scripts/rollup/build.js:354-546]()\n\n---\n\n## Package Preparation\n\n### NPM Package Generation Process\n\nAfter building, artifacts are prepared for npm distribution:\n\n```mermaid\ngraph TB\n    BuildComplete["Build Complete<br/>Artifacts in build/"]\n    \n    CopyFiles["Copy Package Files<br/>LICENSE, README.md, package.json"]\n    CopyNPM["Copy npm/ Directory<br/>Wrapper files"]\n    \n    FilterEntries["filterOutEntrypoints()<br/>Remove unbundled entries"]\n    ReadPkgJSON["Read package.json"]\n    CheckFiles["Check files[] array"]\n    \n    subgraph "Entry Point Filtering"\n        FindEntry["For each file in files[]"]\n        CheckBundle["Check entryPointsToHasBundle Map"]\n        HasBundle{Has Bundle?}\n        KeepFile["Keep in files[]"]\n        RemoveFile["Remove from files[]<br/>Delete file<br/>Update exports, browser"]\n    end\n    \n    NPMPack["npm pack build/node_modules/PKG"]\n    ExtractTar["Extract .tgz"]\n    StripPackage["Strip \'package/\' prefix"]\n    \n    BuildComplete --> CopyFiles\n    CopyFiles --> CopyNPM\n    CopyNPM --> FilterEntries\n    \n    FilterEntries --> ReadPkgJSON\n    ReadPkgJSON --> CheckFiles\n    CheckFiles --> FindEntry\n    FindEntry --> CheckBundle\n    CheckBundle --> HasBundle\n    HasBundle -->|Yes| KeepFile\n    HasBundle -->|No| RemoveFile\n    \n    RemoveFile --> NPMPack\n    KeepFile --> NPMPack\n    NPMPack --> ExtractTar\n    ExtractTar --> StripPackage\n```\n\n**Sources:** [scripts/rollup/packaging.js:253-273](), [scripts/rollup/packaging.js:171-251]()\n\n### Package Structure Example (react-dom)\n\nThe `react-dom` package demonstrates multi-environment entry points:\n\n| Entry Point | File | Condition | Bundle Type |\n|-------------|------|-----------|-------------|\n| `.` | `index.js` | default | NODE_DEV/PROD |\n| `.` | `react-dom.react-server.js` | react-server | SERVER |\n| `./client` | `client.js` | default | NODE_DEV/PROD |\n| `./client` | `client.react-server.js` | react-server | SERVER |\n| `./server` | `server.node.js` | node | NODE_DEV/PROD |\n| `./server` | `server.browser.js` | browser/worker | BROWSER |\n| `./server` | `server.edge.js` | edge-light/workerd | EDGE |\n| `./server` | `server.bun.js` | bun | BUN_DEV/PROD |\n| `./profiling` | `profiling.js` | default | NODE_PROFILING |\n| `./test-utils` | `test-utils.js` | default | NODE_DEV/PROD |\n\n**Sources:** [packages/react-dom/package.json:51-125]()\n\n### Bundle Output Path Mapping\n\nThe `getBundleOutputPath()` function maps bundles to their destination paths:\n\n```mermaid\ngraph TB\n    Bundle["Bundle Configuration"]\n    \n    NodeESM["NODE_ES2015/ESM_*<br/> build/node_modules/PKG/esm/"]\n    NodeCJS["NODE_DEV/PROD/PROFILING<br/> build/node_modules/PKG/cjs/"]\n    BunCJS["BUN_DEV/PROD<br/> build/node_modules/PKG/cjs/"]\n    \n    FBWWW["FB_WWW_*<br/> build/facebook-www/"]\n    \n    RNOSSImpl["RN_OSS_* (react-native-renderer)<br/> build/react-native/implementations/"]\n    RNFBImpl["RN_FB_* (react-native-renderer)<br/> build/react-native/implementations/*.fb.js"]\n    RNFBPkg["RN_FB_* (other packages)<br/> build/facebook-react-native/PKG/cjs/"]\n    \n    BrowserScript["BROWSER_SCRIPT<br/> build/node_modules/PKG/outputPath"]\n    \n    Bundle --> NodeESM\n    Bundle --> NodeCJS\n    Bundle --> BunCJS\n    Bundle --> FBWWW\n    Bundle --> RNOSSImpl\n    Bundle --> RNFBImpl\n    Bundle --> RNFBPkg\n    Bundle --> BrowserScript\n```\n\n**Sources:** [scripts/rollup/packaging.js:48-114]()\n\n---\n\n## Facebook Internal Synchronization\n\n### Sync Infrastructure\n\nThe `sync.js` module provides utilities to copy build artifacts to Facebook\'s internal repositories:\n\n```mermaid\ngraph TB\n    BuildArtifacts["Build Artifacts"]\n    \n    SyncFBSource["Sync to fbsource<br/>--sync-fbsource PATH"]\n    SyncWWW["Sync to www<br/>--sync-www PATH"]\n    \n    subgraph "fbsource Sync"\n        RNPath["xplat/js/react-native-github/<br/>Libraries/Renderer/"]\n        CopyRN["Copy RN_FB_* bundles"]\n    end\n    \n    subgraph "www Sync"\n        WWWPath["~/www/"]\n        CopyWWW["Copy FB_WWW_* bundles"]\n    end\n    \n    BuildArtifacts --> SyncFBSource\n    BuildArtifacts --> SyncWWW\n    \n    SyncFBSource --> RNPath\n    RNPath --> CopyRN\n    \n    SyncWWW --> WWWPath\n    WWWPath --> CopyWWW\n```\n\n**Sources:** [scripts/rollup/sync.js:1-47]()\n\n### Shim Files\n\nEnvironment-specific shims are copied to build outputs:\n\n- **Facebook WWW**: [scripts/rollup/shims/facebook-www]()  `build/facebook-www/shims/`\n- **React Native**: [scripts/rollup/shims/react-native]()  `build/react-native/shims/`\n- **RN Types**: [react-native-renderer/src/ReactNativeTypes.js]()  `build/react-native/shims/ReactNativeTypes.js`\n\n**Sources:** [scripts/rollup/packaging.js:117-137]()\n\n---\n\n## Build Validation\n\n### Artifact Linting System\n\nAfter the build completes, all artifacts are validated using ESLint with environment-specific configurations:\n\n```mermaid\ngraph TB\n    Validate["validate/index.js"]\n    \n    GlobFiles["Glob build/**/*.js"]\n    DetermineFormat["getFormat(filepath)"]\n    \n    FormatFB{Format?}\n    FormatRN[RN]\n    FormatCJS[CJS]\n    FormatCJS2015[CJS2015]\n    FormatESM[ESM]\n    \n    ConfigFB["eslintrc.fb.js"]\n    ConfigRN["eslintrc.rn.js"]\n    ConfigCJS["eslintrc.cjs.js"]\n    ConfigCJS2015["eslintrc.cjs2015.js"]\n    ConfigESM["eslintrc.esm.js"]\n    \n    RunESLint["ESLint.lintFiles()"]\n    CheckResults["Check for Errors"]\n    ReportErrors["Log Errors with Context"]\n    \n    Validate --> GlobFiles\n    GlobFiles --> DetermineFormat\n    DetermineFormat --> FormatFB\n    \n    FormatFB -->|fb| ConfigFB\n    FormatFB -->|rn| ConfigRN\n    FormatFB -->|cjs| ConfigCJS\n    FormatFB -->|cjs2015| ConfigCJS2015\n    FormatFB -->|esm| ConfigESM\n    \n    ConfigFB --> RunESLint\n    ConfigRN --> RunESLint\n    ConfigCJS --> RunESLint\n    ConfigCJS2015 --> RunESLint\n    ConfigESM --> RunESLint\n    \n    RunESLint --> CheckResults\n    CheckResults --> ReportErrors\n```\n\n**Sources:** [scripts/rollup/validate/index.js:11-100]()\n\n### Environment-Specific ESLint Rules\n\nEach build format has specific global variable and syntax constraints:\n\n| Format | Parser | ECMAScript | Unique Globals |\n|--------|--------|------------|----------------|\n| `fb` | ESLint (ES5) | ES5 | `__DEV__` |\n| `rn` | ESLint (ES5) | ES5 | `__DEV__`, `nativeFabricUIManager`, `RN$enableMicrotasksInReact` |\n| `cjs` | ESLint (ES2020) | ES2020 | Node.js globals (`process`, `Buffer`, `setImmediate`) |\n| `cjs2015` | ESLint (ES2020) | ES2020 | Same as CJS, plus ES2015+ features |\n| `esm` | ESLint (ES2020) | ES2020 | Same as CJS |\n\nAll formats validate:\n- No undefined variables (`no-undef`)\n- No shadowing restricted names (`no-shadow-restricted-names`)\n- No `JSCompiler_OptimizeArgumentsArray_*` identifiers (GCC optimization artifact)\n\n**Sources:** [scripts/rollup/validate/eslintrc.fb.js:1-112](), [scripts/rollup/validate/eslintrc.rn.js:1-97](), [scripts/rollup/validate/eslintrc.cjs.js:1-111](), [scripts/rollup/validate/eslintrc.cjs2015.js:1-111](), [scripts/rollup/validate/eslintrc.esm.js:1-112]()\n\n---\n\n## Build Script Integration\n\n### Primary Build Commands\n\nThe root `package.json` defines build workflows:\n\n```mermaid\ngraph LR\n    BuildCmd["yarn build"]\n    BuildReleaseChannels["build-all-release-channels.js"]\n    \n    BuildDevTools["yarn build-for-devtools"]\n    BuildFlight["yarn build-for-flight-dev"]\n    BuildVT["yarn build-for-vt-dev"]\n    \n    BuildCmd --> BuildReleaseChannels\n    BuildReleaseChannels --> BuildStable["Build stable channel"]\n    BuildReleaseChannels --> BuildExperimental["Build experimental channel"]\n    \n    BuildDevTools --> FilteredBuild1["react, react-dom, scheduler<br/>NODE_DEV/PROD, experimental"]\n    BuildFlight --> FilteredBuild2["RSC packages<br/>NODE_DEV, ESM_PROD, NODE_ES2015"]\n    BuildVT --> FilteredBuild3["View Transitions<br/>NODE_DEV, experimental"]\n```\n\nKey command arguments:\n- `--type=BUNDLE_TYPE`: Filter by bundle type (e.g., `NODE_DEV`, `FB_WWW_PROD`)\n- Bundle names: Filter by entry point (e.g., `react/index`, `react-dom/server`)\n- `--watch`: Enable watch mode for development\n- `--sync-fbsource PATH`: Sync to Facebook internal monorepo\n- `--sync-www PATH`: Sync to Facebook www repository\n\n**Sources:** [package.json:124-157]()\n\n### Release Channel Environment Variable\n\nThe `RELEASE_CHANNEL` environment variable controls which feature flag fork is used:\n\n- `RELEASE_CHANNEL=experimental`: Enables experimental features, uses `.experimental.js` forks\n- `RELEASE_CHANNEL=stable`: Uses stable feature flags, uses `.stable.js` forks\n- Undefined: Defaults to experimental\n\n**Sources:** [scripts/rollup/build.js:31-38](), [scripts/rollup/bundles.js:3-8]()\n\n---\n\n## Artifact Metadata\n\n### Bundle Size Tracking\n\nThe `sizes-plugin` records bundle sizes during build:\n\n```javascript\n// In getPlugins()\nsizes({\n  getSize: (size, gzip) => {\n    const currentSizes = Stats.currentBuildResults.bundleSizes;\n    const recordIndex = currentSizes.findIndex(\n      record =>\n        record.filename === filename && record.bundleType === bundleType\n    );\n    const index = recordIndex !== -1 ? recordIndex : currentSizes.length;\n    currentSizes[index] = {\n      filename,\n      bundleType,\n      packageName,\n      size,\n      gzip,\n    };\n  },\n})\n```\n\nThis data is stored in the `Stats` module and used for size regression analysis.\n\n**Sources:** [scripts/rollup/build.js:522-538]()\n\n### Version Management\n\nThe canonical version is maintained in `ReactVersion.js`:\n\n```javascript\nexport default \'19.3.0\';\n```\n\nThis version is:\n- Used at runtime for DevTools compatibility\n- Injected into package.json files during package preparation\n- Referenced by release scripts\n\n**Sources:** [packages/shared/ReactVersion.js:1-16](), [packages/react/package.json:7](), [packages/react-dom/package.json:3]()\n\n---\n\n## Code Wrapping and Headers\n\n### Module Boundary Wrappers\n\nThe `wrappers.js` module provides environment-specific code wrapping:\n\n**Development Bundles (NODE_DEV, FB_WWW_DEV, RN_OSS_DEV, RN_FB_DEV)**:\n```javascript\n\'use strict\';\n\nif (__DEV__) {  // or process.env.NODE_ENV !== "production"\n  (function() {\n    // Bundle code here\n  })();\n}\n```\n\n**Production Bundles**: No wrapping, direct execution\n\n**Reconciler Bundles with DevTools**:\n```javascript\n\'use strict\';\nif (typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== \'undefined\' &&\n    typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart === \'function\') {\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error());\n}\n// Bundle code\nif (typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== \'undefined\' &&\n    typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop === \'function\') {\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error());\n}\n```\n\n**Sources:** [scripts/rollup/wrappers.js:32-169]()\n\n### License Headers\n\nAll production artifacts include the MIT license header:\n\n```\n/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n```\n\n**Sources:** [scripts/rollup/wrappers.js:53-56]()\n\n---\n\n# Page: React Reconciler\n\n# React Reconciler\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-debug-tools/src/ReactDebugHooks.js](packages/react-debug-tools/src/ReactDebugHooks.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspection-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspection-test.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegration-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegration-test.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegrationDOM-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegrationDOM-test.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/CustomHooks.js](packages/react-devtools-shell/src/app/InspectableElements/CustomHooks.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberHooks.js](packages/react-reconciler/src/ReactFiberHooks.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRoot.js](packages/react-reconciler/src/ReactFiberRoot.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactInternalTypes.js](packages/react-reconciler/src/ReactInternalTypes.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactHooks-test.internal.js](packages/react-reconciler/src/__tests__/ReactHooks-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFizzHooks.js](packages/react-server/src/ReactFizzHooks.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightHooks.js](packages/react-server/src/ReactFlightHooks.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactHooks.js](packages/react/src/ReactHooks.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\nThe React Reconciler is the platform-agnostic core reconciliation algorithm that coordinates React updates. It implements the Fiber architecture, manages component lifecycles, schedules work, and delegates host-specific operations to pluggable renderers through the `ReactFiberConfig` interface.\n\n**Scope**: This page covers the reconciler\'s architecture, work loop execution, phase separation, and coordination mechanisms. For specific renderer implementations (DOM, Native), see [Rendering Targets](#4). For server-side rendering systems (Fizz, Flight), see [Server-Side Rendering](#5). For Hooks implementation details, see [React Hooks System](#3.2). For scheduling and priority details, see [Lane-Based Priority and Scheduling](#3.4).\n\n---\n\n## Reconciler Architecture Overview\n\n```mermaid\ngraph TB\n    subgraph "React Public API"\n        JSX["JSX / React.createElement"]\n        Hooks["useState/useEffect/..."]\n        Context["Context API"]\n    end\n    \n    subgraph "Reconciler Core (react-reconciler/src/)"\n        ReconcilerAPI["ReactFiberReconciler.js<br/>createContainer()<br/>updateContainer()"]\n        WorkLoop["ReactFiberWorkLoop.js<br/>performWorkOnRoot()<br/>renderRootSync/Concurrent()"]\n        BeginWork["ReactFiberBeginWork.js<br/>beginWork()<br/>updateFunctionComponent()"]\n        CompleteWork["ReactFiberCompleteWork.js<br/>completeWork()<br/>createInstance()"]\n        CommitWork["ReactFiberCommitWork.js<br/>commitMutationEffects()<br/>commitLayoutEffects()"]\n        Hooks2["ReactFiberHooks.js<br/>renderWithHooks()<br/>mountState()/updateState()"]\n    end\n    \n    subgraph "Fiber Data Structure"\n        FiberNode["Fiber (ReactInternalTypes.js)<br/>tag: WorkTag<br/>stateNode: any<br/>memoizedState: any<br/>updateQueue: UpdateQueue"]\n        FiberRoot["FiberRoot<br/>current: Fiber<br/>containerInfo: Container<br/>pendingLanes: Lanes"]\n    end\n    \n    subgraph "Host Configuration"\n        HostConfig["ReactFiberConfig.js<br/>createInstance()<br/>appendChild()<br/>commitUpdate()"]\n    end\n    \n    subgraph "Renderers"\n        DOM["ReactFiberConfigDOM"]\n        Native["ReactFiberConfigNative"]\n    end\n    \n    JSX --> ReconcilerAPI\n    Hooks --> Hooks2\n    Context --> BeginWork\n    \n    ReconcilerAPI --> WorkLoop\n    WorkLoop --> BeginWork\n    BeginWork --> CompleteWork\n    CompleteWork --> CommitWork\n    Hooks2 --> BeginWork\n    \n    BeginWork --> FiberNode\n    CompleteWork --> FiberNode\n    WorkLoop --> FiberRoot\n    \n    CompleteWork --> HostConfig\n    CommitWork --> HostConfig\n    \n    HostConfig --> DOM\n    HostConfig --> Native\n    \n    style WorkLoop fill:#f9f9f9\n    style HostConfig fill:#f9f9f9\n```\n\nThe reconciler operates through a two-phase render cycle: the **render phase** (interruptible) walks the Fiber tree calling `beginWork` and `completeWork`, and the **commit phase** (synchronous) applies changes to the host environment.\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1-1279](), [packages/react-reconciler/src/ReactFiberReconciler.js:1-354](), [packages/react-reconciler/src/ReactInternalTypes.js:88-207]()\n\n---\n\n## Fiber Data Structure\n\nThe **Fiber** is the fundamental unit of work in the reconciler. Each Fiber node represents a component instance and its associated work.\n\n```mermaid\ngraph LR\n    subgraph "Fiber Node Structure"\n        Fiber["Fiber<br/>ReactInternalTypes.js:88-207"]\n        \n        Identity["Identity Fields<br/>tag: WorkTag<br/>key: string | null<br/>elementType: any<br/>type: any<br/>stateNode: any"]\n        \n        Tree["Tree Structure<br/>return: Fiber | null<br/>child: Fiber | null<br/>sibling: Fiber | null<br/>index: number"]\n        \n        State["State & Props<br/>pendingProps: mixed<br/>memoizedProps: mixed<br/>memoizedState: any<br/>updateQueue: UpdateQueue"]\n        \n        Effects["Effects<br/>flags: Flags<br/>subtreeFlags: Flags<br/>deletions: Array<Fiber>"]\n        \n        Scheduling["Scheduling<br/>lanes: Lanes<br/>childLanes: Lanes<br/>alternate: Fiber | null"]\n    end\n    \n    Fiber --> Identity\n    Fiber --> Tree\n    Fiber --> State\n    Fiber --> Effects\n    Fiber --> Scheduling\n```\n\n| Field | Purpose |\n|-------|---------|\n| `tag` | WorkTag identifying component type (FunctionComponent, ClassComponent, HostComponent, etc.) |\n| `stateNode` | Reference to DOM node, class instance, or other host instance |\n| `memoizedState` | Output state from last render; for hooks, this is the linked list of Hook objects |\n| `updateQueue` | Queue of state updates and effects to process |\n| `flags` | Side-effect flags (Placement, Update, Deletion, Passive, etc.) |\n| `lanes` | Priority lanes representing pending work on this fiber |\n| `alternate` | Double-buffering: points to the current tree\'s corresponding fiber during updates |\n\n**Sources**: [packages/react-reconciler/src/ReactInternalTypes.js:88-207](), [packages/react-reconciler/src/ReactFiber.js:136-209]()\n\n---\n\n## Work Loop Execution Model\n\nThe work loop is the heart of the reconciler, managing the progression through render and commit phases.\n\n```mermaid\ngraph TB\n    Start["scheduleUpdateOnFiber()<br/>ReactFiberWorkLoop.js:916"]\n    \n    EnsureScheduled["ensureRootIsScheduled()<br/>Determine next work lanes"]\n    \n    PerformWork["performWorkOnRoot()<br/>ReactFiberWorkLoop.js:1066"]\n    \n    TimeSlice{"shouldTimeSlice?<br/>!forceSync &&<br/>!includesBlockingLane()"}\n    \n    RenderSync["renderRootSync()<br/>ReactFiberWorkLoop.js:1499"]\n    RenderConcurrent["renderRootConcurrent()<br/>ReactFiberWorkLoop.js:1416"]\n    \n    WorkLoopSync["workLoopSync()<br/>while (workInProgress !== null)<br/>  performUnitOfWork()"]\n    \n    WorkLoopConcurrent["workLoopConcurrent()<br/>while (workInProgress !== null<br/>  && !shouldYield())<br/>  performUnitOfWork()"]\n    \n    UnitOfWork["performUnitOfWork()<br/>ReactFiberWorkLoop.js:1794"]\n    \n    BeginPhase["beginWork()<br/>ReactFiberBeginWork.js"]\n    CompletePhase["completeUnitOfWork()<br/>completeWork()"]\n    \n    CommitRoot["commitRoot()<br/>ReactFiberWorkLoop.js:2386"]\n    \n    CommitBeforeMutation["commitBeforeMutationEffects()"]\n    CommitMutation["commitMutationEffects()"]\n    CommitLayout["commitLayoutEffects()"]\n    CommitPassive["flushPassiveEffects()"]\n    \n    Start --> EnsureScheduled\n    EnsureScheduled --> PerformWork\n    PerformWork --> TimeSlice\n    \n    TimeSlice -->|Yes| RenderConcurrent\n    TimeSlice -->|No| RenderSync\n    \n    RenderSync --> WorkLoopSync\n    RenderConcurrent --> WorkLoopConcurrent\n    \n    WorkLoopSync --> UnitOfWork\n    WorkLoopConcurrent --> UnitOfWork\n    \n    UnitOfWork --> BeginPhase\n    BeginPhase --> CompletePhase\n    \n    CompletePhase --> CommitRoot\n    \n    CommitRoot --> CommitBeforeMutation\n    CommitBeforeMutation --> CommitMutation\n    CommitMutation --> CommitLayout\n    CommitLayout --> CommitPassive\n```\n\n### Render Phase\n\nThe render phase walks the Fiber tree and determines what changes are needed. It consists of two sub-phases:\n\n**Begin Work** ([ReactFiberBeginWork.js:1400-2900]()):\n- Processes the component (calls render, hooks, etc.)\n- Reconciles children using `reconcileChildren`\n- Returns the next child fiber to process\n- Key functions: `updateFunctionComponent`, `updateClassComponent`, `updateHostComponent`\n\n**Complete Work** ([ReactFiberCompleteWork.js:600-1200]()):\n- Creates or updates host instances via `createInstance`, `finalizeInitialChildren`\n- Bubbles up side-effect flags from children\n- Returns to parent, then processes sibling\n\nThe render phase is **interruptible** in concurrent mode  `shouldYield()` allows pausing to handle higher-priority work.\n\n### Commit Phase\n\nThe commit phase applies the work from the render phase. It is **synchronous and uninterruptible**:\n\n1. **Before Mutation** ([ReactFiberCommitWork.js:343-591]()): `getSnapshotBeforeUpdate`, prepare for DOM mutations\n2. **Mutation** ([ReactFiberCommitWork.js:2400-3100]()): Apply DOM changes (insert, update, delete nodes)\n3. **Layout** ([ReactFiberCommitWork.js:593-870]()): `componentDidMount`, `useLayoutEffect`, ref attachment\n4. **Passive** ([ReactFiberCommitWork.js:2629-2800]()): `useEffect` (scheduled after paint)\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1066-1800](), [packages/react-reconciler/src/ReactFiberBeginWork.js:341-470](), [packages/react-reconciler/src/ReactFiberCommitWork.js:343-870]()\n\n---\n\n## Host Configuration Abstraction\n\nThe reconciler delegates all platform-specific operations through the `ReactFiberConfig` interface. This enables React to target multiple platforms without modifying core logic.\n\n```mermaid\ngraph TB\n    subgraph "Reconciler Operations"\n        CreateInst["createInstance() call<br/>in completeWork()"]\n        AppendChild["appendChild() call<br/>in commitMutationEffects()"]\n        CommitUpdate["commitUpdate() call<br/>in commitMutationEffects()"]\n    end\n    \n    subgraph "ReactFiberConfig Interface"\n        Config["ReactFiberConfig.js<br/>Platform-specific implementation"]\n        \n        Methods["Key Methods:<br/>createInstance(type, props)<br/>createTextInstance(text)<br/>appendChild(parent, child)<br/>insertBefore(parent, child, before)<br/>removeChild(parent, child)<br/>commitUpdate(instance, type, oldProps, newProps)<br/>finalizeInitialChildren(instance, type, props)<br/>prepareForCommit(container)<br/>resetAfterCommit(container)"]\n    end\n    \n    subgraph "Renderer Implementations"\n        DOMConfig["ReactFiberConfigDOM.js<br/>DOM-specific"]\n        FabricConfig["ReactFiberConfigFabric.js<br/>React Native Fabric"]\n        NoopConfig["ReactNoop.js<br/>Testing"]\n    end\n    \n    CreateInst --> Config\n    AppendChild --> Config\n    CommitUpdate --> Config\n    \n    Config --> Methods\n    \n    Methods --> DOMConfig\n    Methods --> FabricConfig\n    Methods --> NoopConfig\n```\n\n### Mutation vs Persistence\n\nRenderers implement one of two strategies:\n\n**Mutation Mode** (DOM, React Native Legacy):\n- `supportsMutation = true`\n- Modifies host instances in place\n- Methods: `appendChild`, `removeChild`, `commitUpdate`\n\n**Persistence Mode** (React Native Fabric):\n- `supportsPersistence = true`\n- Clones and replaces entire subtrees\n- Methods: `cloneInstance`, `createContainerChildSet`, `replaceContainerChildren`\n\n### Example: DOM Renderer Integration\n\n```\ncompleteWork()  createInstance()  document.createElement()\ncommitMutationEffects()  appendChild()  parentInstance.appendChild()\ncommitMutationEffects()  commitUpdate()  updateProperties()\n```\n\nThe reconciler calls high-level operations like `createInstance`; the DOM renderer translates these to `document.createElement()`, `node.appendChild()`, etc.\n\n**Sources**: [packages/react-reconciler/src/ReactFiberCompleteWork.js:105-129](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-50](), [packages/react-reconciler/src/ReactFiberCommitWork.js:154-186]()\n\n---\n\n## Reconciliation and Diffing\n\nWhen React updates a component, it reconciles the new children with the existing Fiber tree.\n\n```mermaid\ngraph TB\n    ReconcileChildren["reconcileChildren()<br/>ReactFiberBeginWork.js:341"]\n    \n    MountOrUpdate{"current === null?"}\n    \n    MountChildren["mountChildFibers()<br/>No side-effects tracking"]\n    ReconcileExisting["reconcileChildFibers()<br/>Track Placement, Deletion"]\n    \n    ChildReconciler["ChildReconciler<br/>ReactChildFiber.js"]\n    \n    SingleChild["reconcileSingleElement()<br/>Single child reconciliation"]\n    ArrayChildren["reconcileChildrenArray()<br/>List reconciliation with keys"]\n    \n    PlacementFlag["Mark Fiber with Placement flag"]\n    DeletionFlag["Add old Fiber to deletions array"]\n    UpdateFlag["Reuse existing Fiber, update props"]\n    \n    ReconcileChildren --> MountOrUpdate\n    MountOrUpdate -->|Mount| MountChildren\n    MountOrUpdate -->|Update| ReconcileExisting\n    \n    MountChildren --> ChildReconciler\n    ReconcileExisting --> ChildReconciler\n    \n    ChildReconciler --> SingleChild\n    ChildReconciler --> ArrayChildren\n    \n    SingleChild --> PlacementFlag\n    ArrayChildren --> PlacementFlag\n    ArrayChildren --> DeletionFlag\n    ArrayChildren --> UpdateFlag\n```\n\n### Array Reconciliation Algorithm\n\nWhen reconciling an array of children ([ReactChildFiber.js:800-1200]()):\n\n1. **First Pass**: Walk old and new children in parallel, matching by `key` (if provided) or `index`\n   - If `key` matches and `type` matches: reuse Fiber, update props\n   - If mismatch: break and proceed to repositioning\n\n2. **Deletions**: Remaining old children not matched are marked for deletion\n\n3. **Insertions**: Remaining new children create new Fibers with `Placement` flag\n\n4. **Key Map**: For complex reorderings, build a map of `key  Fiber` to efficiently find matches\n\nThe reconciler marks each Fiber with flags:\n- `Placement`: Needs to be inserted into DOM\n- `Update`: Props changed, needs DOM update\n- `Deletion`: Needs to be removed from DOM\n\n**Sources**: [packages/react-reconciler/src/ReactFiberBeginWork.js:341-404](), [packages/react-reconciler/src/ReactChildFiber.js:800-1200]()\n\n---\n\n## Global State and Work-in-Progress\n\nThe reconciler maintains global mutable state during rendering:\n\n```mermaid\ngraph LR\n    subgraph "Global State (ReactFiberWorkLoop.js)"\n        ExecutionContext["executionContext: ExecutionContext<br/>NoContext | RenderContext | CommitContext"]\n        WIPRoot["workInProgressRoot: FiberRoot | null"]\n        WIP["workInProgress: Fiber | null"]\n        WIPLanes["workInProgressRootRenderLanes: Lanes"]\n        WIPExitStatus["workInProgressRootExitStatus: RootExitStatus<br/>RootInProgress | RootCompleted | RootSuspended..."]\n    end\n    \n    subgraph "Current vs Work-in-Progress"\n        CurrentTree["current tree<br/>Visible on screen"]\n        WIPTree["workInProgress tree<br/>Being built"]\n        Alternate["Fibers linked via<br/>alternate pointer"]\n    end\n    \n    ExecutionContext -.-> WIPRoot\n    WIPRoot --> WIP\n    WIPRoot --> CurrentTree\n    CurrentTree --> Alternate\n    Alternate --> WIPTree\n```\n\n**Double Buffering**: React maintains two Fiber trees:\n- **Current tree**: The currently rendered tree, visible to the user\n- **Work-in-progress tree**: The tree being built during an update\n\nEach Fiber\'s `alternate` pointer links to its counterpart in the other tree. After commit, the work-in-progress tree becomes the current tree via pointer swap ([ReactFiberWorkLoop.js:2600-2650]()).\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:406-526](), [packages/react-reconciler/src/ReactFiber.js:360-480]()\n\n---\n\n## Render Exit Statuses\n\nThe render phase can exit in multiple states ([ReactFiberWorkLoop.js:413-420]()):\n\n| Status | Description |\n|--------|-------------|\n| `RootInProgress` | Render is still in progress |\n| `RootCompleted` | Render completed successfully |\n| `RootErrored` | Render hit an error |\n| `RootSuspended` | Render suspended waiting for data |\n| `RootSuspendedWithDelay` | Suspended with throttling delay |\n| `RootSuspendedAtTheShell` | Suspended during initial shell, show fallback immediately |\n| `RootFatalErrored` | Fatal error, cannot recover |\n\nThe status determines whether to commit immediately, retry, or show a Suspense fallback.\n\n---\n\n## Error Handling and Boundaries\n\nError handling propagates up the Fiber tree until an error boundary is found.\n\n```mermaid\ngraph TB\n    ThrowException["throwException()<br/>ReactFiberThrow.js"]\n    \n    FindBoundary["Find nearest Suspense or ErrorBoundary<br/>Walk up fiber.return chain"]\n    \n    Boundary{"Boundary type?"}\n    \n    ErrorBoundary["Error Boundary (ClassComponent)<br/>getDerivedStateFromError<br/>componentDidCatch"]\n    \n    SuspenseBoundary["Suspense Boundary<br/>Show fallback UI"]\n    \n    CreateUpdate["createClassErrorUpdate()<br/>Schedule re-render with error"]\n    \n    ShowFallback["Mark SuspenseComponent with<br/>DidCapture flag"]\n    \n    UnwindWork["unwindWork()<br/>ReactFiberUnwindWork.js<br/>Clean up context stacks"]\n    \n    ThrowException --> FindBoundary\n    FindBoundary --> Boundary\n    \n    Boundary -->|Error| ErrorBoundary\n    Boundary -->|Suspense| SuspenseBoundary\n    \n    ErrorBoundary --> CreateUpdate\n    SuspenseBoundary --> ShowFallback\n    \n    CreateUpdate --> UnwindWork\n    ShowFallback --> UnwindWork\n```\n\nWhen an error or promise is thrown:\n\n1. `throwException()` is called with the thrown value\n2. Walk up the tree to find an appropriate boundary\n3. For errors: call `getDerivedStateFromError` on error boundary, schedule re-render\n4. For Suspense: mark boundary with `DidCapture`, prepare to show fallback\n5. `unwindWork()` cleans up any context stacks, unwinds to the boundary\n6. Restart render from the boundary\n\n**Sources**: [packages/react-reconciler/src/ReactFiberThrow.js:400-600](), [packages/react-reconciler/src/ReactFiberUnwindWork.js:63-180](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1900-2100]()\n\n---\n\n## Concurrent Features and Interruption\n\nIn concurrent mode, the render phase can be interrupted to handle higher-priority updates.\n\n```mermaid\ngraph TB\n    WorkLoop["workLoopConcurrent()<br/>ReactFiberWorkLoop.js:1794"]\n    \n    CheckYield{"shouldYield()?<br/>Time slice expired?"}\n    \n    Continue["performUnitOfWork()<br/>Continue rendering"]\n    \n    Yield["Yield to browser<br/>Return from work loop"]\n    \n    Schedule["Schedule continuation<br/>Scheduler.scheduleCallback()"]\n    \n    HighPriorityInterrupt["High-priority update arrives<br/>prepareFreshStack()<br/>Discard WIP, restart"]\n    \n    WorkLoop --> CheckYield\n    CheckYield -->|No| Continue\n    Continue --> WorkLoop\n    \n    CheckYield -->|Yes| Yield\n    Yield --> Schedule\n    \n    Continue -.->|Update arrives| HighPriorityInterrupt\n    HighPriorityInterrupt --> WorkLoop\n```\n\n**Interruption points**:\n- Between units of work (fibers)\n- `shouldYield()` checks if time slice exhausted\n- New higher-priority updates can discard work-in-progress\n\n**Resumption**:\n- Work-in-progress state is preserved\n- Can resume from `workInProgress` fiber\n- Or restart from root for higher priority\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1776-1850](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1300-1400]()\n\n---\n\n## Component Types and Tags\n\nThe reconciler handles different component types via the `WorkTag` enum.\n\n```mermaid\ngraph TB\n    subgraph "Host Components"\n        HostRoot["HostRoot = 3<br/>Root of Fiber tree"]\n        HostComponent["HostComponent = 5<br/>DOM element (div, span)"]\n        HostText["HostText = 6<br/>Text node"]\n        HostPortal["HostPortal = 4<br/>ReactDOM.createPortal"]\n    end\n    \n    subgraph "React Components"\n        FunctionComponent["FunctionComponent = 0<br/>Function components"]\n        ClassComponent["ClassComponent = 1<br/>Class components"]\n        ForwardRef["ForwardRef = 11<br/>React.forwardRef"]\n        MemoComponent["MemoComponent = 14<br/>React.memo"]\n        SimpleMemoComponent["SimpleMemoComponent = 15<br/>Memo with simple comparison"]\n    end\n    \n    subgraph "Async Components"\n        SuspenseComponent["SuspenseComponent = 13<br/>React.Suspense"]\n        SuspenseListComponent["SuspenseListComponent = 23<br/>React.SuspenseList"]\n        OffscreenComponent["OffscreenComponent = 22<br/>Hidden content"]\n        ActivityComponent["ActivityComponent = 25<br/>React.Activity"]\n    end\n    \n    subgraph "Other"\n        Fragment["Fragment = 7<br/>React.Fragment"]\n        ContextProvider["ContextProvider = 10<br/>Context.Provider"]\n        ContextConsumer["ContextConsumer = 9<br/>Context.Consumer"]\n        Profiler["Profiler = 12<br/>React.Profiler"]\n    end\n```\n\nThe `tag` field on each Fiber determines which code path `beginWork` and `completeWork` take.\n\n**Example dispatching** ([ReactFiberBeginWork.js:3800-4100]()):\n```\nswitch (workInProgress.tag) {\n  case FunctionComponent:\n    return updateFunctionComponent(...)\n  case ClassComponent:\n    return updateClassComponent(...)\n  case HostComponent:\n    return updateHostComponent(...)\n  ...\n}\n```\n\n**Sources**: [packages/react-reconciler/src/ReactWorkTags.js:1-60](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3800-4100]()\n\n---\n\n## Context System\n\nReact Context is implemented at the reconciler level.\n\n```mermaid\ngraph TB\n    subgraph "Context Definition"\n        CreateContext["React.createContext(defaultValue)<br/>Returns Context object"]\n        ContextObject["Context = {<br/>  $$typeof: REACT_CONTEXT_TYPE<br/>  _currentValue: any<br/>  Provider: ReactProviderType<br/>  Consumer: ReactContext<br/>}"]\n    end\n    \n    subgraph "Provider in Tree"\n        ProviderFiber["Fiber with tag=ContextProvider<br/>type = Context<br/>pendingProps.value = newValue"]\n        \n        PushProvider["pushProvider()<br/>ReactFiberNewContext.js:200<br/>Push value onto stack"]\n    end\n    \n    subgraph "Consumer in Tree"\n        ConsumerFiber["Component using useContext()<br/>or Context.Consumer"]\n        \n        ReadContext["readContext(Context)<br/>ReactFiberNewContext.js:250<br/>Read from stack"]\n        \n        Dependencies["fiber.dependencies = {<br/>  lanes: Lanes<br/>  firstContext: ContextDependency<br/>}"]\n    end\n    \n    subgraph "Change Propagation"\n        ValueChange["Provider value changes"]\n        Propagate["propagateContextChange()<br/>ReactFiberNewContext.js:300<br/>Mark consumers with lanes"]\n    end\n    \n    CreateContext --> ContextObject\n    ContextObject --> ProviderFiber\n    ProviderFiber --> PushProvider\n    \n    PushProvider --> ConsumerFiber\n    ConsumerFiber --> ReadContext\n    ReadContext --> Dependencies\n    \n    ValueChange --> Propagate\n    Propagate --> ConsumerFiber\n```\n\n**Context mechanism**:\n1. **Stack-based**: Providers push values onto a stack as the tree is traversed\n2. **Dependencies**: Consuming components record a dependency in `fiber.dependencies`\n3. **Bailout prevention**: When context value changes, `propagateContextChange()` marks all consumers with update lanes, preventing bailout\n\n**Key functions**:\n- `pushProvider()` - Push new context value onto stack ([ReactFiberNewContext.js:200-250]())\n- `readContext()` - Read current context value and record dependency ([ReactFiberNewContext.js:250-350]())\n- `propagateContextChange()` - Mark consumers for update when value changes ([ReactFiberNewContext.js:400-550]())\n\n**Sources**: [packages/react-reconciler/src/ReactFiberNewContext.js:200-550](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3200-3350]()\n\n---\n\n## Scheduling Entry Points\n\nUpdates enter the reconciler through several paths:\n\n```mermaid\ngraph TB\n    subgraph "Public API Entry Points"\n        Root["root.render(element)<br/>ReactFiberReconciler.js:356"]\n        SetState["this.setState(update)<br/>classComponentUpdater"]\n        UseState["setStateFromHook<br/>from useState()"]\n        ForceUpdate["this.forceUpdate()"]\n    end\n    \n    subgraph "Update Creation"\n        CreateUpdate["createUpdate(lane)<br/>ReactFiberClassUpdateQueue.js:200"]\n        UpdatePayload["Update = {<br/>  lane: Lane<br/>  tag: UpdateState<br/>  payload: any<br/>  callback: Function | null<br/>  next: Update<br/>}"]\n    end\n    \n    subgraph "Enqueueing"\n        EnqueueUpdate["enqueueUpdate(fiber, update, lane)<br/>ReactFiberClassUpdateQueue.js:500"]\n        \n        ConcurrentUpdate["enqueueConcurrentHookUpdate()<br/>For hooks updates"]\n        \n        UpdateQueue["fiber.updateQueue<br/>Circular linked list"]\n    end\n    \n    subgraph "Scheduling"\n        ScheduleUpdate["scheduleUpdateOnFiber()<br/>ReactFiberWorkLoop.js:916"]\n        RequestLane["requestUpdateLane(fiber)<br/>Determine priority"]\n        MarkRootUpdated["markRootUpdated(root, lane)"]\n        EnsureScheduled["ensureRootIsScheduled(root)<br/>Schedule work with Scheduler"]\n    end\n    \n    Root --> CreateUpdate\n    SetState --> CreateUpdate\n    UseState --> ConcurrentUpdate\n    ForceUpdate --> CreateUpdate\n    \n    CreateUpdate --> UpdatePayload\n    UpdatePayload --> EnqueueUpdate\n    ConcurrentUpdate --> EnqueueUpdate\n    \n    EnqueueUpdate --> UpdateQueue\n    UpdateQueue --> ScheduleUpdate\n    \n    ScheduleUpdate --> RequestLane\n    ScheduleUpdate --> MarkRootUpdated\n    ScheduleUpdate --> EnsureScheduled\n```\n\n**Update lifecycle**:\n1. User calls `setState()` or `render()`\n2. Create an `Update` object with priority lane\n3. Enqueue update onto fiber\'s `updateQueue`\n4. Call `scheduleUpdateOnFiber()` with root and lane\n5. `ensureRootIsScheduled()` schedules work with Scheduler based on lanes\n\n**Sources**: [packages/react-reconciler/src/ReactFiberReconciler.js:356-461](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:916-1042](), [packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:165-243]()\n\n---\n\n## Batching and Synchronization\n\nThe reconciler batches updates to minimize renders.\n\n```mermaid\ngraph TB\n    subgraph "Batching Mechanisms"\n        ExecutionContext2["executionContext flag<br/>BatchedContext = 0b001<br/>RenderContext = 0b010<br/>CommitContext = 0b100"]\n        \n        BatchedUpdates["batchedUpdates(fn)<br/>Set BatchedContext<br/>Execute fn<br/>Clear BatchedContext"]\n        \n        FlushSync["flushSync(fn)<br/>Force synchronous render<br/>Execute fn<br/>flushSyncWork()"]\n    end\n    \n    subgraph "Update Accumulation"\n        Update1["setState() call 1"]\n        Update2["setState() call 2"]\n        Update3["setState() call 3"]\n        \n        Accumulated["All updates on same fiber<br/>merged into updateQueue"]\n    end\n    \n    subgraph "Rendering"\n        SingleRender["Single render pass<br/>processes all updates"]\n    end\n    \n    ExecutionContext2 --> BatchedUpdates\n    BatchedUpdates --> Update1\n    BatchedUpdates --> Update2\n    BatchedUpdates --> Update3\n    \n    Update1 --> Accumulated\n    Update2 --> Accumulated\n    Update3 --> Accumulated\n    \n    Accumulated --> SingleRender\n    \n    FlushSync -.->|Forces| SingleRender\n```\n\n**Automatic batching**: In React 18+, all updates are automatically batched within a single event, timeout, or promise callback. The `executionContext` prevents nested flush operations.\n\n**Manual control**:\n- `flushSync()` - Force synchronous rendering ([ReactFiberWorkLoop.js:1244-1278]())\n- `batchedUpdates()` - Explicit batching (mostly legacy) ([ReactFiberWorkLoop.js:2832-2850]())\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1244-1278](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:2832-2850]()\n\n---\n\n## Refs and Imperative Handles\n\nThe reconciler manages refs and provides imperative access to instances.\n\n```mermaid\ngraph TB\n    subgraph "Ref Types"\n        CallbackRef["Callback Ref<br/>ref={(node) => {...}}"]\n        ObjectRef["Object Ref<br/>ref={useRef()}"]\n        StringRef["String Ref (legacy)<br/>ref=\'myRef\'"]\n    end\n    \n    subgraph "Ref Attachment"\n        CommitLayoutPhase["Layout Effects Phase<br/>commitLayoutEffects()"]\n        \n        AttachRef["safelyAttachRef()<br/>ReactFiberCommitEffects.js:650"]\n        \n        SetRef["Set ref.current = instance<br/>or call ref(instance)"]\n    end\n    \n    subgraph "Ref Cleanup"\n        BeforeUpdate["Before mutation or unmount"]\n        \n        DetachRef["safelyDetachRef()<br/>ReactFiberCommitEffects.js:680"]\n        \n        ClearRef["Set ref.current = null<br/>or call ref(null)"]\n    end\n    \n    subgraph "Imperative Handle"\n        UseImperativeHandle["useImperativeHandle()<br/>Customize ref value"]\n        \n        ImperativeInstance["Custom instance object<br/>returned by callback"]\n    end\n    \n    CallbackRef --> CommitLayoutPhase\n    ObjectRef --> CommitLayoutPhase\n    StringRef --> CommitLayoutPhase\n    \n    CommitLayoutPhase --> AttachRef\n    AttachRef --> SetRef\n    \n    BeforeUpdate --> DetachRef\n    DetachRef --> ClearRef\n    \n    UseImperativeHandle --> ImperativeInstance\n    ImperativeInstance --> AttachRef\n```\n\n**Ref lifecycle**:\n1. **Detachment**: Before mutations, call `safelyDetachRef()` to clear old refs\n2. **Attachment**: In layout phase, call `safelyAttachRef()` to set new refs\n3. **Instance**: For host components, ref points to DOM node; for class components, to class instance; for function components with `useImperativeHandle`, to custom object\n\n**Sources**: [packages/react-reconciler/src/ReactFiberCommitEffects.js:650-720](), [packages/react-reconciler/src/ReactFiberHooks.js:2100-2200]()\n\n---\n\n## Profiler Integration\n\nThe reconciler integrates with React DevTools Profiler to track render times.\n\n```mermaid\ngraph TB\n    subgraph "Timing Collection"\n        ProfilerTimer["enableProfilerTimer<br/>feature flag"]\n        \n        ActualDuration["fiber.actualDuration<br/>Time spent in this render"]\n        \n        TreeBaseDuration["fiber.treeBaseDuration<br/>Total time for subtree"]\n        \n        RecordStart["startProfilerTimer()<br/>ReactProfilerTimer.js:200"]\n        \n        RecordStop["stopProfilerTimerIfRunning()<br/>ReactProfilerTimer.js:250"]\n    end\n    \n    subgraph "Profiler Component"\n        ProfilerTag["<Profiler id=\'x\' onRender={callback}>"]\n        \n        OnRenderCallback["onRender(id, phase, actualDuration,<br/>  baseDuration, startTime, commitTime)"]\n    end\n    \n    subgraph "DevTools Hook"\n        DevToolsHook["__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        \n        MarkRenderStarted["markRenderStarted(lane)"]\n        MarkRenderStopped["markRenderStopped()"]\n        OnCommitRoot["onCommitRoot(root)"]\n    end\n    \n    ProfilerTimer --> RecordStart\n    ProfilerTimer --> RecordStop\n    \n    RecordStart --> ActualDuration\n    RecordStop --> TreeBaseDuration\n    \n    ActualDuration --> ProfilerTag\n    TreeBaseDuration --> ProfilerTag\n    \n    ProfilerTag --> OnRenderCallback\n    \n    RecordStart --> MarkRenderStarted\n    RecordStop --> MarkRenderStopped\n    ActualDuration --> OnCommitRoot\n    \n    MarkRenderStarted --> DevToolsHook\n    MarkRenderStopped --> DevToolsHook\n    OnCommitRoot --> DevToolsHook\n```\n\n**Profiler mechanism**:\n- `actualDuration`: Time spent rendering this component in the current render\n- `treeBaseDuration`: Estimated time to re-render entire subtree (cached from previous render)\n- `startProfilerTimer()` / `stopProfilerTimerIfRunning()`: Record timing around component render\n- `<Profiler>` component invokes `onRender` callback with timing data after commit\n- DevTools hook receives notifications of render start/stop/commit\n\n**Sources**: [packages/react-reconciler/src/ReactProfilerTimer.js:150-350](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:720-780](), [packages/react-reconciler/src/ReactFiberDevToolsHook.js:200-350]()\n\n---\n\n## Concurrent Mode Rendering Patterns\n\n### Selective Hydration\n\nThe reconciler supports hydrating server-rendered content selectively based on user interactions.\n\n```mermaid\ngraph TB\n    HydrateRoot["hydrateRoot(container, element)"]\n    \n    Dehydrated["Dehydrated Suspense boundary<br/>Server-rendered fallback"]\n    \n    UserClick["User clicks inside boundary"]\n    \n    UpgradePriority["Upgrade hydration lane<br/>to higher priority"]\n    \n    HydrateBoundary["Hydrate clicked boundary first<br/>Before other boundaries"]\n    \n    ThrowException2["If data not ready:<br/>throw SelectiveHydrationException"]\n    \n    HydrateRoot --> Dehydrated\n    Dehydrated --> UserClick\n    UserClick --> UpgradePriority\n    UpgradePriority --> HydrateBoundary\n    HydrateBoundary --> ThrowException2\n```\n\nWhen a user interacts with a dehydrated boundary, React prioritizes hydrating that boundary to make it interactive quickly.\n\n**Sources**: [packages/react-reconciler/src/ReactFiberBeginWork.js:311-317](), [packages/react-reconciler/src/ReactFiberReconciler.js:489-520]()\n\n### Offscreen Rendering\n\n`OffscreenComponent` allows pre-rendering content that\'s not yet visible.\n\n```mermaid\ngraph TB\n    Offscreen["<Offscreen mode=\'hidden\'>"]\n    \n    Hidden["Content rendered but not visible<br/>style={{ visibility: \'hidden\' }}"]\n    \n    DeferredLane["Scheduled at OffscreenLane<br/>Low priority"]\n    \n    Visible["<Offscreen mode=\'visible\'>"]\n    \n    Reveal["Content becomes visible<br/>Re-render at higher priority"]\n    \n    Offscreen --> Hidden\n    Hidden --> DeferredLane\n    DeferredLane --> Visible\n    Visible --> Reveal\n```\n\nOffscreen components are rendered at low priority and kept in the DOM with `visibility: hidden`, then revealed instantly when needed.\n\n**Sources**: [packages/react-reconciler/src/ReactFiberBeginWork.js:613-871](), [packages/react-reconciler/src/ReactFiberOffscreenComponent.js:1-50]()\n\n---\n\n## Summary\n\nThe React Reconciler is the core reconciliation engine that:\n\n- **Manages Fiber trees**: Double-buffered trees with `current` and `workInProgress`\n- **Coordinates render phases**: Interruptible render phase, synchronous commit phase\n- **Abstracts platforms**: Delegates host operations through `ReactFiberConfig` interface\n- **Schedules work**: Priority-based scheduling using lanes and the Scheduler\n- **Handles updates**: Batches updates, processes update queues, reconciles children\n- **Supports features**: Hooks, Context, Suspense, Error Boundaries, Concurrent Rendering\n\nKey entry points:\n- `createContainer()` / `updateContainer()` - Initialize and update roots\n- `scheduleUpdateOnFiber()` - Schedule work on a fiber\n- `performWorkOnRoot()` - Execute render and commit phases\n- `beginWork()` / `completeWork()` - Walk the fiber tree\n- `commitMutationEffects()` / `commitLayoutEffects()` - Apply changes to host\n\nThe reconciler is platform-agnostic, enabling React to target DOM, Native, Canvas, and custom renderers while maintaining a single core algorithm.\n\n---\n\n# Page: Fiber Architecture and Data Structures\n\n# Fiber Architecture and Data Structures\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberOffscreenComponent.js](packages/react-reconciler/src/ReactFiberOffscreenComponent.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis page documents React\'s Fiber data structure, the FiberRoot container, the double-buffering technique using current and work-in-progress trees, and the tree traversal mechanisms using child/sibling/return pointers. These are the foundational data structures that enable React\'s incremental reconciliation.\n\nFor related topics, see:\n- Work loop execution and render/commit phases: [Work Loop and Rendering Phases](#4.2)\n- Hooks implementation: [React Hooks System](#4.3)\n- Priority scheduling: [Lane-Based Scheduling and Priorities](#4.4)\n- Error and Suspense handling: [Suspense and Error Boundaries](#4.5)\n- Host-specific operations: [Host Configuration Abstraction](#4.6)\n\n## FiberRoot: The Container\n\nThe `FiberRoot` is the container object that holds the entire fiber tree and coordinates rendering. It is created by `createFiberRoot` in [ReactFiberRoot.js:109-225]() when calling `createRoot()` or `createContainer()`.\n\n### FiberRoot Structure\n\nKey fields defined in [ReactInternalTypes.js:253-334]():\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `containerInfo` | `Container` | The host container (e.g., DOM node) |\n| `current` | `Fiber` | Pointer to the current HostRoot fiber |\n| `finishedWork` | `Fiber \\| null` | Work-in-progress root after render completes |\n| `pendingLanes` | `Lanes` | Lanes with pending work |\n| `suspendedLanes` | `Lanes` | Lanes suspended by promises |\n| `pingedLanes` | `Lanes` | Lanes that have been pinged to retry |\n| `expiredLanes` | `Lanes` | Lanes that have expired |\n| `callbackNode` | `mixed` | Scheduler callback node |\n| `callbackPriority` | `Lane` | Priority of scheduled callback |\n| `hydrationCallbacks` | `null \\| SuspenseHydrationCallbacks` | Hydration callbacks |\n| `context` | `Object \\| null` | Context object for legacy context |\n| `pendingContext` | `Object \\| null` | Pending context updates |\n\n**Diagram: FiberRoot and HostRoot Relationship**\n\n```mermaid\ngraph TB\n    ContainerDiv["containerInfo<br/>(DOM div)"]\n    FiberRoot["FiberRoot"]\n    CurrentHostRoot["current<br/>(HostRoot fiber)"]\n    WIPHostRoot["finishedWork<br/>(HostRoot fiber WIP)"]\n    \n    FiberRoot -->|"containerInfo"| ContainerDiv\n    FiberRoot -->|"current"| CurrentHostRoot\n    FiberRoot -->|"finishedWork"| WIPHostRoot\n    \n    CurrentHostRoot -->|"stateNode"| FiberRoot\n    WIPHostRoot -->|"stateNode"| FiberRoot\n    \n    CurrentHostRoot -.->|"alternate"| WIPHostRoot\n    WIPHostRoot -.->|"alternate"| CurrentHostRoot\n    \n    CurrentHostRoot -->|"child"| CurrentApp["App fiber (current)"]\n    WIPHostRoot -->|"child"| WIPApp["App fiber (WIP)"]\n```\n\nThe `HostRoot` fiber (tag = 3) is special:\n- Its `stateNode` points back to the `FiberRoot`\n- It has no React element (it\'s the root of the React tree)\n- Its `memoizedState` contains the initial element passed to `render()` [ReactInternalTypes.js:246-251]()\n\nSources: [ReactFiberRoot.js:109-225](), [ReactInternalTypes.js:253-334](), [ReactInternalTypes.js:246-251]()\n\n## The Fiber Data Structure\n\n### Fiber Node Definition\n\nA Fiber is React\'s internal unit of work, representing a component instance, DOM node, or other React element. It is a mutable JavaScript object containing all information needed for reconciliation, scheduling, and effects.\n\nThe `FiberNode` constructor is defined in [ReactFiber.js:138-211](). React provides two implementations:\n- Class-based: `createFiberImplClass` (default)\n- Object literal: `createFiberImplObject` (controlled by `enableObjectFiber` flag)\n\n### Fiber Fields by Category\n\n| Field Category | Key Fields | Purpose |\n|---------------|------------|---------|\n| **Instance Identity** | `tag`, `key`, `elementType`, `type` | Identify what this fiber represents |\n| **Instance State** | `stateNode` | Reference to component instance, DOM node, or other state |\n| **Tree Structure** | `return`, `child`, `sibling`, `index` | Form the fiber tree via pointers |\n| **Refs** | `ref`, `refCleanup` | Handle ref attachment and cleanup |\n| **Props** | `pendingProps`, `memoizedProps` | Props being processed and last rendered props |\n| **State** | `memoizedState`, `updateQueue` | Component state and pending updates |\n| **Context** | `dependencies` | Context subscriptions |\n| **Mode** | `mode` | Bitfield for ConcurrentMode, StrictMode, etc. |\n| **Effects** | `flags`, `subtreeFlags`, `deletions` | Side-effects to perform in commit phase |\n| **Scheduling** | `lanes`, `childLanes` | Work priority for this fiber and its subtree |\n| **Double Buffering** | `alternate` | Link to counterpart fiber in other tree |\n| **Profiling** | `actualDuration`, `selfBaseDuration`, etc. | Timing information (if enabled) |\n\n**Fiber Creation:**\n\nNew fibers are created by `createFiber` [ReactFiber.js:303-305]():\n```javascript\nconst createFiber = enableObjectFiber\n  ? createFiberImplObject\n  : createFiberImplClass;\n```\n\nSources: [ReactFiber.js:138-211](), [ReactFiber.js:226-305](), [ReactInternalTypes.js:89-205]()\n\n### Work Tags\n\nEach fiber\'s `tag` field identifies its type, defined in [ReactWorkTags.js:10-37]():\n\n| Tag Constant | Value | Represents |\n|--------------|-------|------------|\n| `FunctionComponent` | 0 | Function component |\n| `ClassComponent` | 1 | Class component |\n| `HostRoot` | 3 | Root of a fiber tree (container) |\n| `HostComponent` | 5 | Platform element (e.g., DOM `<div>`) |\n| `HostText` | 6 | Text node |\n| `HostPortal` | 4 | Portal to different container |\n| `Fragment` | 7 | `React.Fragment` |\n| `Mode` | 8 | StrictMode, ConcurrentMode, etc. |\n| `ContextProvider` | 10 | `Context.Provider` |\n| `ContextConsumer` | 9 | `Context.Consumer` |\n| `ForwardRef` | 11 | `React.forwardRef()` wrapper |\n| `Profiler` | 12 | `<Profiler>` component |\n| `SuspenseComponent` | 13 | `<Suspense>` boundary |\n| `MemoComponent` | 14 | `React.memo()` wrapper |\n| `SimpleMemoComponent` | 15 | Optimized memo for simple functions |\n| `LazyComponent` | 16 | `React.lazy()` wrapper |\n| `OffscreenComponent` | 22 | Hidden/deferred subtree |\n| `CacheComponent` | 24 | Cache boundary |\n| `TracingMarkerComponent` | 25 | Transition tracing marker |\n\nThe tag determines how the fiber is processed during reconciliation (in `beginWork`/`completeWork`) and what lifecycle methods or hooks it supports.\n\nSources: [ReactWorkTags.js:10-37](), [ReactFiber.js:146]()\n\n## Double Buffering: Current and Work-in-Progress Trees\n\nReact maintains two fiber trees using a technique called double buffering:\n- **Current tree**: Reflects what\'s currently rendered on screen\n- **Work-in-progress tree**: Being constructed during the render phase\n\n### The `alternate` Pointer\n\nEach fiber has an `alternate` field pointing to its counterpart in the other tree [ReactFiber.js:177]():\n\n```mermaid\ngraph LR\n    subgraph Current["Current Tree (on screen)"]\n        C_Root["HostRoot"]\n        C_App["App"]\n        C_Div["div"]\n        C_Text["\'Hello\'"]\n    end\n    \n    subgraph WorkInProgress["Work-in-Progress Tree (being built)"]\n        W_Root["HostRoot"]\n        W_App["App"]\n        W_Div["div"]\n        W_Text["\'Hello World\'"]\n    end\n    \n    C_Root <-.alternate.-> W_Root\n    C_App <-.alternate.-> W_App\n    C_Div <-.alternate.-> W_Div\n    C_Text <-.alternate.-> W_Text\n```\n\n**Diagram: Alternate Pointers Between Trees**\n\n### Creating Work-in-Progress Fibers\n\nThe `createWorkInProgress` function [ReactFiber.js:327-383]() manages fiber reuse:\n\n**On first update (alternate is null):**\n1. Creates new fiber with `createFiber()`\n2. Copies `elementType`, `type`, `stateNode` from current\n3. Sets up bidirectional `alternate` pointers\n4. Initializes with `pendingProps`\n\n**On subsequent updates (alternate exists):**\n1. Reuses existing alternate fiber\n2. Resets flags: `flags = NoFlags`, `subtreeFlags = NoFlags`\n3. Clears `deletions` array\n4. Updates `pendingProps` to new props\n5. Resets `lanes` and `childLanes`\n\n**Benefits of double buffering:**\n- Memory efficiency: reuses fiber objects across renders\n- Enables bailout optimizations by comparing to `current`\n- Allows interruption: work-in-progress can be discarded if superseded\n- Atomic updates: switch trees by updating single pointer (`FiberRoot.current`)\n\nSources: [ReactFiber.js:327-383](), [ReactFiber.js:177]()\n\n### Tree Swap on Commit\n\nAfter rendering completes successfully, the work-in-progress tree becomes current via a single pointer update in `commitRootImpl` [ReactFiberWorkLoop.js:2268-2826]():\n\n```javascript\nroot.current = finishedWork;\n```\n\nThe previous current tree becomes the new work-in-progress alternate for the next update.\n\nSources: [ReactFiberWorkLoop.js:2268-2826]()\n\n## Work Loop Architecture\n\n### Overview: `performWorkOnRoot`\n\nThe work loop orchestrates rendering and committing. The main entry point is `performWorkOnRoot` [ReactFiberWorkLoop.js:940-1089](), which:\n\n1. Prepares the work-in-progress root\n2. Executes the render phase (`renderRootSync` or `renderRootConcurrent`)\n3. If successful, executes the commit phase (`commitRoot`)\n4. Handles errors and suspensions\n5. Schedules any remaining work\n\n```mermaid\ngraph TB\n    ScheduleUpdate["scheduleUpdateOnFiber()<br/>(mark fiber with lane)"]\n    EnsureScheduled["ensureRootIsScheduled()<br/>(schedule work on root)"]\n    PerformWork["performWorkOnRoot()<br/>(process scheduled work)"]\n    \n    DetermineMode{"Sync or<br/>Concurrent?"}\n    RenderSync["renderRootSync()<br/>(uninterruptible)"]\n    RenderConcurrent["renderRootConcurrent()<br/>(can yield)"]\n    \n    WorkLoop["workLoopSync() or<br/>workLoopConcurrent()"]\n    PerformUnit["performUnitOfWork()"]\n    \n    CheckExitStatus{"Exit Status?"}\n    CommitRoot["commitRoot()<br/>(apply changes)"]\n    HandleError["Handle error/<br/>suspension"]\n    \n    ScheduleUpdate --> EnsureScheduled\n    EnsureScheduled --> PerformWork\n    PerformWork --> DetermineMode\n    \n    DetermineMode -->|"includes SyncLane"| RenderSync\n    DetermineMode -->|"concurrent lanes"| RenderConcurrent\n    \n    RenderSync --> WorkLoop\n    RenderConcurrent --> WorkLoop\n    WorkLoop --> PerformUnit\n    \n    PerformUnit --> CheckExitStatus\n    CheckExitStatus -->|"RootCompleted"| CommitRoot\n    CheckExitStatus -->|"RootErrored/<br/>RootSuspended"| HandleError\n```\n\n**Diagram: Work Loop Execution Flow**\n\nSources: [ReactFiberWorkLoop.js:940-1089](), [ReactFiberWorkLoop.js:1643-1846]()\n\n### Work Loop State Variables\n\nKey module-level state in [ReactFiberWorkLoop.js:423-496]():\n\n```javascript\nlet workInProgressRoot: FiberRoot | null = null;     // Root being rendered\nlet workInProgress: Fiber | null = null;             // Current fiber being processed\nlet workInProgressRootRenderLanes: Lanes = NoLanes; // Lanes being rendered\n\nlet workInProgressSuspendedReason: SuspendedReason = NotSuspended;\nlet workInProgressThrownValue: mixed = null;\n\nlet workInProgressRootExitStatus: RootExitStatus = RootInProgress;\n```\n\nThese variables track the current render\'s state globally within the reconciler.\n\nSources: [ReactFiberWorkLoop.js:423-496]()\n\n## The Render Phase\n\nThe render phase builds the work-in-progress tree by traversing fibers depth-first. This phase is **interruptible** in concurrent mode.\n\n### Work Loop Functions\n\nTwo variants exist [ReactFiberWorkLoop.js:1848-1856]():\n\n**Synchronous (uninterruptible):**\n```javascript\nfunction workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress);\n  }\n}\n```\n\n**Concurrent (interruptible):**\n```javascript\nfunction workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress);\n  }\n}\n```\n\nThe concurrent version checks `shouldYield()` from Scheduler to yield control back to the browser.\n\nSources: [ReactFiberWorkLoop.js:1848-1856]()\n\n### Unit of Work: `performUnitOfWork`\n\nEach iteration processes one fiber [ReactFiberWorkLoop.js:1858-1884]():\n\n```javascript\nfunction performUnitOfWork(unitOfWork: Fiber): void {\n  const current = unitOfWork.alternate;\n  \n  let next = beginWork(current, unitOfWork, renderLanes);\n  \n  unitOfWork.memoizedProps = unitOfWork.pendingProps;\n  \n  if (next === null) {\n    completeUnitOfWork(unitOfWork);\n  } else {\n    workInProgress = next;\n  }\n}\n```\n\n**Flow:**\n1. Call `beginWork` to process the fiber and generate children\n2. If `beginWork` returns a child, set it as next `workInProgress`\n3. If no child, call `completeUnitOfWork` to finish this fiber and move to sibling/parent\n\nSources: [ReactFiberWorkLoop.js:1858-1884]()\n\n### Begin Work: `beginWork`\n\nThe `beginWork` function [ReactFiberBeginWork.js:3649-4221]() is a large switch statement that processes each fiber type:\n\n```mermaid\ngraph TB\n    BeginWork["beginWork(current, workInProgress, lanes)"]\n    \n    CheckBailout{"Can bailout?<br/>(props unchanged &&<br/>no work in subtree)"}\n    BailoutPath["bailoutOnAlreadyFinishedWork()"]\n    \n    SwitchTag["Switch on workInProgress.tag"]\n    \n    FuncComp["updateFunctionComponent()<br/>(call renderWithHooks)"]\n    ClassComp["updateClassComponent()<br/>(process lifecycle, call render)"]\n    HostRoot["updateHostRoot()<br/>(process update queue)"]\n    HostComp["updateHostComponent()<br/>(no render, just reconcile)"]\n    HostText["updateHostText()<br/>(text has no children)"]\n    Suspense["updateSuspenseComponent()<br/>(check fallback/primary)"]\n    Fragment["updateFragment()<br/>(just reconcile children)"]\n    \n    ReconcileChildren["reconcileChildren()<br/>(diff algorithm)"]\n    ReturnChild["Return child<br/>(or null)"]\n    \n    BeginWork --> CheckBailout\n    CheckBailout -->|Yes| BailoutPath\n    CheckBailout -->|No| SwitchTag\n    \n    SwitchTag --> FuncComp\n    SwitchTag --> ClassComp\n    SwitchTag --> HostRoot\n    SwitchTag --> HostComp\n    SwitchTag --> HostText\n    SwitchTag --> Suspense\n    SwitchTag --> Fragment\n    \n    FuncComp --> ReconcileChildren\n    ClassComp --> ReconcileChildren\n    HostRoot --> ReconcileChildren\n    HostComp --> ReconcileChildren\n    Fragment --> ReconcileChildren\n    \n    ReconcileChildren --> ReturnChild\n    BailoutPath --> ReturnChild\n    Suspense --> ReturnChild\n    HostText --> ReturnChild\n```\n\n**Diagram: beginWork Processing Flow**\n\n#### Key Operations in `beginWork`:\n\n1. **Bailout optimization** [ReactFiberBeginWork.js:3798-3823](): If props haven\'t changed and there\'s no work scheduled in the subtree, skip processing\n\n2. **Component-specific updates**:\n   - `updateFunctionComponent` [ReactFiberBeginWork.js:1363-1434](): Calls `renderWithHooks` to execute the function\n   - `updateClassComponent` [ReactFiberBeginWork.js:1179-1298](): Processes lifecycle methods and calls `render()`\n   - `updateHostComponent` [ReactFiberBeginWork.js:1745-1791](): For DOM elements, just prepares for children reconciliation\n\n3. **Child reconciliation** [ReactFiberBeginWork.js:340-371](): Calls `reconcileChildren` which:\n   - Uses `mountChildFibers` for initial mount (no placement flags)\n   - Uses `reconcileChildFibers` for updates (tracks side-effects)\n   - Implements React\'s diffing algorithm in [ReactChildFiber.js]()\n\nSources: [ReactFiberBeginWork.js:3649-4221](), [ReactFiberBeginWork.js:340-371](), [ReactChildFiber.js]()\n\n### Complete Work: `completeWork`\n\nAfter all children are processed, `completeUnitOfWork` [ReactFiberWorkLoop.js:1886-1949]() calls `completeWork` [ReactFiberCompleteWork.js:652-1441]() to finalize the fiber.\n\n```mermaid\ngraph TB\n    CompleteWork["completeWork(current, workInProgress, lanes)"]\n    \n    SwitchTag["Switch on workInProgress.tag"]\n    \n    HostComp["HostComponent"]\n    HostText["HostText"]\n    HostRoot["HostRoot"]\n    Suspense["SuspenseComponent"]\n    ContextProv["ContextProvider"]\n    \n    CheckMount{"current === null?<br/>(initial mount)"}\n    \n    CreateInstance["createInstance()<br/>(create DOM node)"]\n    AppendChildren["appendAllChildren()<br/>(attach child DOM nodes)"]\n    FinalizeProps["finalizeInitialChildren()<br/>(set props, event listeners)"]\n    \n    UpdateCheck{"Props changed?"}\n    MarkUpdate["Mark fiber with Update flag"]\n    \n    BubbleProps["bubbleProperties()<br/>(aggregate flags/lanes from children)"]\n    ReturnNull["Return null<br/>(move to sibling/parent)"]\n    \n    CompleteWork --> SwitchTag\n    \n    SwitchTag --> HostComp\n    SwitchTag --> HostText\n    SwitchTag --> HostRoot\n    SwitchTag --> Suspense\n    SwitchTag --> ContextProv\n    \n    HostComp --> CheckMount\n    CheckMount -->|"Yes (mount)"| CreateInstance\n    CreateInstance --> AppendChildren\n    AppendChildren --> FinalizeProps\n    \n    CheckMount -->|"No (update)"| UpdateCheck\n    UpdateCheck -->|Yes| MarkUpdate\n    \n    FinalizeProps --> BubbleProps\n    MarkUpdate --> BubbleProps\n    HostText --> BubbleProps\n    HostRoot --> BubbleProps\n    Suspense --> BubbleProps\n    ContextProv --> BubbleProps\n    \n    BubbleProps --> ReturnNull\n```\n\n**Diagram: completeWork Processing Flow**\n\n#### Key Operations in `completeWork`:\n\nFor **HostComponent** (DOM elements) on mount [ReactFiberCompleteWork.js:652-1441]():\n1. `createInstance` - Creates the DOM node via host config\n2. `appendAllChildren` - Walks the fiber tree and attaches child DOM nodes\n3. `finalizeInitialChildren` - Sets initial props and event listeners\n4. Marks with Update flag if needed (e.g., autoFocus)\n\nFor **HostComponent** on update:\n1. Calls `updateHostComponent` [ReactFiberCompleteWork.js:455-540]()\n2. If old props !== new props, marks fiber with Update flag\n3. The actual prop update happens in commit phase\n\n**Property Bubbling** [ReactFiberCompleteWork.js:1443-1543]():\n- Aggregates all child `flags` into `subtreeFlags`\n- Aggregates all child `lanes` and `childLanes` into this fiber\'s `childLanes`\n- Enables efficient subtree skipping during traversal\n\nSources: [ReactFiberCompleteWork.js:652-1441](), [ReactFiberCompleteWork.js:242-346](), [ReactFiberCompleteWork.js:1443-1543]()\n\n### Traversal Pattern: Depth-First with Siblings\n\nThe work loop implements depth-first traversal with sibling processing [ReactFiberWorkLoop.js:1886-1949]():\n\n```\n1. Begin work on fiber A\n2. If A has child B, begin work on B (go deeper)\n3. If B has no child, complete work on B\n4. If B has sibling C, begin work on C\n5. If no sibling, complete parent A\n6. Continue until root is complete\n```\n\nThis ensures proper parentchildsibling ordering.\n\nSources: [ReactFiberWorkLoop.js:1886-1949]()\n\n## The Commit Phase\n\nOnce render phase completes successfully (`RootCompleted`), the commit phase applies all changes to the host environment. This phase is **uninterruptible** and **synchronous**.\n\n### Commit Phase Structure\n\nThe `commitRootImpl` function [ReactFiberWorkLoop.js:2268-2826]() orchestrates commit in three sub-phases plus passive effects:\n\n```mermaid\ngraph LR\n    Start["commitRootImpl(root, recoverableErrors, lanes)"]\n    \n    BeforeMut["Before Mutation Phase<br/>commitBeforeMutationEffects()"]\n    MutPhase["Mutation Phase<br/>commitMutationEffects()"]\n    SwapTrees["root.current = finishedWork<br/>(swap trees)"]\n    LayoutPhase["Layout Phase<br/>commitLayoutEffects()"]\n    \n    SchedulePassive["Schedule Passive Effects<br/>scheduleCallback(commitPassiveMountEffects)"]\n    \n    CleanupSync["Cleanup & schedule<br/>next work"]\n    \n    Start --> BeforeMut\n    BeforeMut --> MutPhase\n    MutPhase --> SwapTrees\n    SwapTrees --> LayoutPhase\n    LayoutPhase --> SchedulePassive\n    SchedulePassive --> CleanupSync\n```\n\n**Diagram: Commit Phase Sub-phases**\n\nSources: [ReactFiberWorkLoop.js:2268-2826]()\n\n### Before Mutation Phase\n\n`commitBeforeMutationEffects` [ReactFiberCommitWork.js:344-363]() traverses the tree and:\n\n1. Calls `getSnapshotBeforeUpdate` on class components [ReactFiberCommitWork.js:475-574]()\n2. Schedules useEffect hooks (doesn\'t run them yet)\n3. Handles view transition tracking (if enabled)\n4. Detects focus changes for `beforeActiveInstanceBlur`\n\n**Key point:** This phase reads from the DOM *before* any mutations, allowing components to capture information (e.g., scroll position).\n\nSources: [ReactFiberCommitWork.js:344-363](), [ReactFiberCommitWork.js:475-574]()\n\n### Mutation Phase\n\n`commitMutationEffects` [ReactFiberCommitWork.js:856-1097]() applies actual DOM changes:\n\n```mermaid\ngraph TB\n    MutationEffects["commitMutationEffects(root, finishedWork, lanes)"]\n    \n    RecursiveTraverse["Recursively traverse tree<br/>commitMutationEffectsOnFiber()"]\n    \n    CheckFlags["Check fiber.flags"]\n    \n    ContentReset["ContentReset:<br/>clearTextContent()"]\n    Ref["Ref:<br/>safelyDetachRef()"]\n    Visibility["Visibility:<br/>Hide/show instances"]\n    Placement["Placement:<br/>commitPlacement()"]\n    Update["Update:<br/>commitWork()"]\n    ChildDeletion["ChildDeletion:<br/>commitDeletionEffects()"]\n    \n    PlacementOps["Insert DOM node into parent<br/>via insertBefore/appendChild"]\n    UpdateOps["Update DOM properties<br/>updateProperties()"]\n    DeletionOps["Remove DOM node<br/>removeChild()"]\n    \n    MutationEffects --> RecursiveTraverse\n    RecursiveTraverse --> CheckFlags\n    \n    CheckFlags --> ContentReset\n    CheckFlags --> Ref\n    CheckFlags --> Visibility\n    CheckFlags --> Placement\n    CheckFlags --> Update\n    CheckFlags --> ChildDeletion\n    \n    Placement --> PlacementOps\n    Update --> UpdateOps\n    ChildDeletion --> DeletionOps\n```\n\n**Diagram: Mutation Phase Operations**\n\n**Key operations:**\n- **Placement** [ReactFiberCommitWork.js](): Inserts new or moved DOM nodes using `insertBefore` or `appendChild`\n- **Update** [ReactFiberCommitWork.js](): Updates properties on existing DOM nodes via `updateProperties`\n- **Deletion** [ReactFiberCommitWork.js](): Recursively unmounts components and removes DOM nodes\n- **Visibility** [ReactFiberCommitWork.js](): Hides/shows DOM nodes for Suspense/Offscreen\n\nSources: [ReactFiberCommitWork.js:856-1097](), [ReactFiberCommitHostEffects.js]()\n\n### Tree Swap\n\nBetween mutation and layout phases [ReactFiberWorkLoop.js:2268-2826]():\n\n```javascript\nroot.current = finishedWork;\n```\n\nThis swaps the work-in-progress tree to become the current tree. From this point forward, the newly committed tree represents what\'s on screen.\n\nSources: [ReactFiberWorkLoop.js:2268-2826]()\n\n### Layout Phase\n\n`commitLayoutEffects` [ReactFiberCommitWork.js:594-854]() runs immediately after DOM mutations, while browser is still processing layout:\n\n1. **Class components** [ReactFiberCommitWork.js:607-638](): \n   - Calls `componentDidMount` on mount\n   - Calls `componentDidUpdate` on update\n   - Invokes `setState` callbacks\n\n2. **Function components** [ReactFiberCommitWork.js:607-619]():\n   - Calls `useLayoutEffect` effect functions\n\n3. **Refs** [ReactFiberCommitWork.js:635-637]():\n   - Calls `safelyAttachRef` to set refs to current instances\n\n4. **Host components** [ReactFiberCommitWork.js:657-697]():\n   - Calls `commitMount` for initial mount side-effects (e.g., autoFocus)\n\n**Key point:** This phase can synchronously read layout from the DOM. `useLayoutEffect` runs here specifically to allow synchronous DOM measurements before paint.\n\nSources: [ReactFiberCommitWork.js:594-854](), [ReactFiberCommitEffects.js]()\n\n### Passive Effects Phase\n\n`commitPassiveEffects` [ReactFiberWorkLoop.js:2858-3025]() runs **asynchronously** after browser paint, scheduled via `scheduleCallback`:\n\n```javascript\nscheduleCallback(NormalSchedulerPriority, () => {\n  flushPassiveEffects();\n  return null;\n});\n```\n\n**Two passes:**\n\n1. **Unmount effects** [ReactFiberCommitWork.js:2446-2593]():\n   - Calls cleanup functions from previous `useEffect` hooks\n   - Invokes `componentWillUnmount` on unmounted class components\n\n2. **Mount effects** [ReactFiberCommitWork.js:2595-2774]():\n   - Calls effect functions from current `useEffect` hooks\n\n**Key characteristics:**\n- Runs after paint (non-blocking)\n- Lower priority than layout effects\n- Ideal for side-effects that don\'t need synchronous DOM access (data fetching, subscriptions)\n\nSources: [ReactFiberWorkLoop.js:2858-3025](), [ReactFiberCommitWork.js:2446-2774]()\n\n## Error Handling and Suspension\n\n### Unwinding on Errors/Suspensions\n\nWhen `beginWork` or other code throws during render, React unwinds the stack using `unwindWork` [ReactFiberUnwindWork.js:66-235]():\n\n1. Walks back up the tree via `return` pointers\n2. Pops context stacks to maintain consistency\n3. Looks for error boundaries (`ClassComponent` with `getDerivedStateFromError` or `componentDidCatch`)\n4. Looks for Suspense boundaries (`SuspenseComponent`)\n5. Marks boundary with `ShouldCapture` flag\n\n```javascript\n// Simplified unwinding logic\nfunction unwindWork(current, workInProgress, renderLanes) {\n  switch (workInProgress.tag) {\n    case ClassComponent:\n      if (flags & ShouldCapture) {\n        workInProgress.flags = (flags & ~ShouldCapture) | DidCapture;\n        return workInProgress; // Re-render this boundary\n      }\n      return null;\n    \n    case SuspenseComponent:\n      if (flags & ShouldCapture) {\n        workInProgress.flags = (flags & ~ShouldCapture) | DidCapture;\n        return workInProgress; // Show fallback\n      }\n      return null;\n    \n    // ... other cases pop context\n  }\n}\n```\n\nSources: [ReactFiberUnwindWork.js:66-235]()\n\n### Handling Thrown Values\n\n`throwException` [ReactFiberThrow.js]() processes different types of thrown values:\n\n**Promises (Suspense):**\n- Attaches ping listener to the promise\n- Finds nearest Suspense boundary\n- Marks boundary to show fallback\n\n**Errors:**\n- Finds nearest error boundary\n- Creates error update with `getDerivedStateFromError` or `componentDidCatch`\n- Schedules re-render of boundary\n\n**Special values:**\n- `SelectiveHydrationException`: Signals need to interrupt current render for hydration\n\nSources: [ReactFiberThrow.js]()\n\n### Suspended Work Tracking\n\nWhen work suspends [ReactFiberWorkLoop.js:1987-2134]():\n\n```javascript\nworkInProgressSuspendedReason = SuspendedOnData;\nworkInProgressThrownValue = thrownValue;\n```\n\nThe work loop checks this state and:\n- Attempts to unwind to a Suspense boundary\n- May continue rendering siblings to "pre-warm" them\n- Marks lanes for retry when promise resolves\n\nSources: [ReactFiberWorkLoop.js:1987-2134]()\n\n## Integration with Scheduler\n\n### Scheduling Root Work\n\n`ensureRootIsScheduled` [ReactFiberRootScheduler.js:185-403]() is called after updates are enqueued:\n\n1. Determines next lanes to process via `getNextLanes`\n2. Calculates Scheduler priority from lane priority via `lanesToEventPriority`\n3. Schedules callback:\n   - **Sync lanes**: Uses microtask or immediate callback\n   - **Concurrent lanes**: Uses `Scheduler_scheduleCallback` with appropriate priority\n\n```javascript\nconst schedulerPriorityLevel = lanesToEventPriority(nextLanes);\nconst newCallbackNode = scheduleCallback(\n  schedulerPriorityLevel,\n  performWorkOnRoot.bind(null, root)\n);\n```\n\nSources: [ReactFiberRootScheduler.js:185-403]()\n\n### Yielding to Browser\n\nIn concurrent mode, `workLoopConcurrent` [ReactFiberWorkLoop.js:1851-1856]() checks `shouldYield()` from Scheduler:\n\n```javascript\nfunction workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress);\n  }\n}\n```\n\nIf `shouldYield()` returns true:\n- Work loop exits\n- Current render state is preserved in module variables\n- Scheduler callback is re-scheduled\n- When callback runs again, rendering resumes from `workInProgress`\n\nThis enables:\n- Responding to higher-priority user input\n- Keeping frame rate high during complex renders\n- Time-slicing long operations\n\nSources: [ReactFiberWorkLoop.js:1851-1856](), [Scheduler.js]()\n\n### Priority Mapping\n\nLane priorities map to Scheduler priorities [ReactEventPriorities.js]():\n\n| React Lane | Scheduler Priority |\n|------------|-------------------|\n| `SyncLane` | `ImmediatePriority` |\n| `InputContinuousLane` | `UserBlockingPriority` |\n| `DefaultLane` | `NormalPriority` |\n| `TransitionLanes` | `NormalPriority` |\n| `RetryLanes` | `NormalPriority` |\n| `IdleLane` | `IdlePriority` |\n\nSources: [ReactEventPriorities.js](), [ReactFiberLane.js]()\n\n## Profiling and Performance Tracking\n\n### Profiler Timing\n\nWhen `enableProfilerTimer` is enabled, each fiber tracks timing information [ReactFiber.js:179-197]():\n\n```javascript\nfiber.actualDuration = -0;        // Time spent rendering this update\nfiber.actualStartTime = -1.1;     // When rendering started\nfiber.selfBaseDuration = -0;      // Base time excluding children\nfiber.treeBaseDuration = -0;      // Base time including children\n```\n\nThese are updated during:\n- `performUnitOfWork` starts the timer\n- `completeWork` stops and accumulates duration\n- Child durations are subtracted to compute self time\n\nThe `Profiler` component [ReactFiberBeginWork.js:1136-1177]() uses these to report render times via the `onRender` callback.\n\nSources: [ReactFiber.js:179-197](), [ReactProfilerTimer.js]()\n\n### Performance Track Logging\n\n`ReactFiberPerformanceTrack` [ReactFiberPerformanceTrack.js]() logs performance events to browser DevTools Performance panel:\n\n**Component tracks:**\n- `logComponentRender` logs individual component render times with color-coded severity\n- `logComponentMount/Unmount` logs lifecycle events\n- Tracks props changes and deep equality warnings\n\n**Lane tracks:**\n- Separate tracks for Blocking, Gesture, Transition, Suspense, Idle\n- Shows update propagation and priority changes\n- Visualizes which updates triggered renders\n\n**Event tracking:**\n- Correlates user events with resulting updates\n- Tracks cascading updates (updates triggered during render)\n- Measures time from event to commit\n\nSources: [ReactFiberPerformanceTrack.js:221-450]()\n\n## Summary\n\nThe Fiber architecture and work loop provide React\'s reconciliation mechanism with these key characteristics:\n\n**Fiber Structure:**\n- Mutable plain objects forming a linked tree\n- Double-buffered (current  work-in-progress)\n- Tracks props, state, effects, and scheduling information\n\n**Work Loop:**\n- Depth-first traversal via `performUnitOfWork`\n- **Render phase** (interruptible): `beginWork`  `completeWork`\n- **Commit phase** (uninterruptible): before-mutation  mutation  layout  passive\n\n**Key Capabilities:**\n- Incremental rendering with yielding to browser\n- Priority-based scheduling via lanes\n- Efficient bailout and memoization\n- Error boundaries and Suspense\n- Profiling and performance tracking\n\nThis architecture enables React to:\n- Keep UIs responsive during complex updates\n- Prioritize user interactions over background work\n- Gracefully handle async operations and errors\n- Provide detailed performance insights\n\nSources: [ReactFiberWorkLoop.js](), [ReactFiberBeginWork.js](), [ReactFiberCompleteWork.js](), [ReactFiberCommitWork.js](), [ReactFiber.js](), [ReactProfilerTimer.js](), [ReactFiberPerformanceTrack.js]()\n\n---\n\n# Page: Work Loop and Rendering Phases\n\n# Work Loop and Rendering Phases\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\nThis document describes the reconciler\'s work loop execution and the three phases of processing the Fiber tree: **begin work**, **complete work**, and **commit work**. The work loop is the core mechanism that processes fibers, determines what changed, and applies updates to the host environment.\n\nFor information about the Fiber data structure itself, see [Fiber Architecture and Data Structures](#4.1). For details on scheduling and priority management, see [Lane-Based Scheduling and Priorities](#4.4). For the commit phase effects system, see [React Hooks System](#4.3).\n\n## Overview\n\nThe work loop is implemented in [packages/react-reconciler/src/ReactFiberWorkLoop.js](). It orchestrates two distinct phases:\n\n| Phase | Purpose | Can be interrupted? |\n|-------|---------|-------------------|\n| **Render Phase** | Traverse the Fiber tree, compute changes, and mark effects | Yes (in concurrent mode) |\n| **Commit Phase** | Apply computed changes to the host environment | No (synchronous) |\n\nThe render phase processes fibers through two sub-phases: `beginWork` and `completeWork`. The commit phase executes through three sub-phases: `commitBeforeMutationEffects`, `commitMutationEffects`, and `commitLayoutEffects`.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1-3000]()\n\n## Work Loop Execution\n\n### Entry Points and Root Processing\n\nWork on a root begins through one of two main entry points:\n\n```\nperformSyncWorkOnRoot(root)      // Synchronous, uninterruptible\nperformConcurrentWorkOnRoot(root) // Concurrent, can yield\n```\n\nBoth functions follow this pattern:\n1. Prepare the work-in-progress root and lanes\n2. Enter the render phase (`renderRootSync` or `renderRootConcurrent`)\n3. If render completes successfully, enter commit phase (`commitRoot`)\n\n**Render Phase Entry:**\n\n```mermaid\ngraph TB\n    scheduleUpdateOnFiber["scheduleUpdateOnFiber(root, fiber, lane)"]\n    ensureRoot["ensureRootIsScheduled(root)"]\n    performSync["performSyncWorkOnRoot(root)"]\n    performConcurrent["performConcurrentWorkOnRoot(root)"]\n    \n    scheduleUpdateOnFiber --> ensureRoot\n    ensureRoot -->|"SyncLane"| performSync\n    ensureRoot -->|"other lanes"| performConcurrent\n    \n    performSync --> renderRootSync["renderRootSync(root, lanes)"]\n    performConcurrent --> renderRootConcurrent["renderRootConcurrent(root, lanes)"]\n    \n    renderRootSync --> prepareFresh["prepareFreshStack(root, lanes)<br/>Creates workInProgress tree"]\n    renderRootConcurrent --> prepareFresh\n    \n    prepareFresh --> setContext["executionContext |= RenderContext"]\n    setContext --> workLoopSync["workLoopSync()"]\n    setContext --> workLoopConcurrent["workLoopConcurrent()"]\n    \n    workLoopSync --> exitRender["exitStatus = RootCompleted/RootErrored/etc"]\n    workLoopConcurrent --> exitRender\n```\n\nThe `prepareFreshStack` function creates the work-in-progress tree by calling `createWorkInProgress(root.current, null)`, which either reuses the existing alternate fiber or creates a new one.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:966-1092](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1116-1300]()\n\n### The Work Loops\n\nThe actual work loop is remarkably simple:\n\n```javascript\n// Synchronous mode - never yields\nfunction workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress);\n  }\n}\n\n// Concurrent mode - yields when shouldYield() returns true\nfunction workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress);\n  }\n}\n```\n\nThe `workInProgress` variable points to the current Fiber being processed. `performUnitOfWork` processes one unit of work and advances to the next fiber.\n\nThe `shouldYield()` function is imported from the Scheduler package and checks if the current time slice has expired. In concurrent mode, React will pause work and return control to the browser if `shouldYield()` returns true, allowing the browser to handle higher-priority work like user input.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1801-1812](), [packages/react-reconciler/src/Scheduler.js:70-76]()\n\n### Work Loop State Variables\n\nThe work loop maintains several module-level variables that track the current state:\n\n| Variable | Type | Purpose |\n|----------|------|---------|\n| `workInProgressRoot` | `FiberRoot \\| null` | The root currently being worked on |\n| `workInProgress` | `Fiber \\| null` | The fiber currently being processed |\n| `workInProgressRootRenderLanes` | `Lanes` | The lanes being rendered |\n| `workInProgressSuspendedReason` | `SuspendedReason` | Why work is suspended (0-9: NotSuspended, SuspendedOnError, SuspendedOnData, etc.) |\n| `workInProgressRootExitStatus` | `RootExitStatus` | Final status: RootInProgress, RootCompleted, RootErrored, RootSuspended, etc. |\n| `workInProgressThrownValue` | `mixed` | The value that was thrown (promise, error, etc.) |\n| `executionContext` | `ExecutionContext` | Bitmask tracking current context: NoContext, RenderContext, CommitContext |\n\nThe `executionContext` variable tracks what phase React is currently executing:\n\n```javascript\nconst NoContext = 0b000;\nconst RenderContext = 0b010;  // Currently in render phase\nconst CommitContext = 0b100;  // Currently in commit phase\n```\n\nThis prevents re-entrant updates and helps detect improper usage patterns.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:418-458]()\n\n## Render Phase: Begin Work and Complete Work\n\nThe render phase processes the Fiber tree in a depth-first traversal, calling `beginWork` on the way down and `completeWork` on the way up.\n\n### performUnitOfWork Flow\n\n```mermaid\ngraph TB\n    start["performUnitOfWork(unitOfWork)"]\n    begin["next = beginWork(current, unitOfWork, lanes)"]\n    hasNext{"next !== null?"}\n    complete["completeUnitOfWork(unitOfWork)"]\n    advance["workInProgress = next"]\n    \n    start --> begin\n    begin --> hasNext\n    hasNext -->|"Yes (has child)"| advance\n    hasNext -->|"No (no child)"| complete\n    advance --> return["return to workLoop"]\n    complete --> return\n```\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1814-1848]()\n\n### Begin Work Phase\n\nThe `beginWork` function in [packages/react-reconciler/src/ReactFiberBeginWork.js]() is responsible for:\n\n1. Determining if the fiber\'s work can be skipped (bailout optimization)\n2. Creating or updating child fibers based on the fiber\'s tag\n3. Returning the first child fiber to process next\n\n**Begin Work Dispatch by Fiber Tag:**\n\n```mermaid\ngraph TB\n    beginWork["beginWork(current, workInProgress, renderLanes)"]\n    \n    checkBailout{"Can bailout?"}\n    bailout["bailoutOnAlreadyFinishedWork()"]\n    \n    beginWork --> checkBailout\n    checkBailout -->|"Yes"| bailout\n    \n    checkBailout -->|"No"| switch{"workInProgress.tag"}\n    \n    switch -->|"FunctionComponent"| updateFunction["updateFunctionComponent()"]\n    switch -->|"ClassComponent"| updateClass["updateClassComponent()"]\n    switch -->|"HostComponent"| updateHost["updateHostComponent()"]\n    switch -->|"HostRoot"| updateRoot["updateHostRoot()"]\n    switch -->|"SuspenseComponent"| updateSuspense["updateSuspenseComponent()"]\n    switch -->|"OffscreenComponent"| updateOffscreen["updateOffscreenComponent()"]\n    \n    updateFunction --> reconcile["reconcileChildren()"]\n    updateClass --> reconcile\n    updateHost --> reconcile\n    updateRoot --> reconcile\n    updateSuspense --> reconcile\n    updateOffscreen --> reconcile\n    \n    reconcile --> returnChild["return workInProgress.child"]\n```\n\n**Key Begin Work Functions:**\n\n| Function | Fiber Tag | Responsibility |\n|----------|-----------|----------------|\n| `updateFunctionComponent` | FunctionComponent, ForwardRef, SimpleMemoComponent | Calls `renderWithHooks` to execute function body and hooks |\n| `updateClassComponent` | ClassComponent | Processes lifecycle: `componentWillMount`, `getDerivedStateFromProps`, `render`, etc. |\n| `updateHostComponent` | HostComponent | Processes DOM elements (div, span, etc.), marks props updates |\n| `updateHostRoot` | HostRoot | Processes root container, applies context updates |\n| `updateSuspenseComponent` | SuspenseComponent | Manages fallback vs primary content based on suspension state |\n| `updateOffscreenComponent` | OffscreenComponent | Handles hidden subtrees and prerendering |\n| `reconcileChildren` | (all) | Core diffing algorithm - reconciles current children with new children |\n\nThe `bailoutOnAlreadyFinishedWork` function is called when a component can skip re-rendering. It checks if `workInProgress.lanes` and `renderLanes` have no overlap, and if so, clones the children without doing any work.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberBeginWork.js:3746-4016](), [packages/react-reconciler/src/ReactFiberBeginWork.js:340-371](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3569-3633]()\n\n### Complete Work Phase\n\nWhen `beginWork` returns `null` (no more children to process), `completeUnitOfWork` is called. This function:\n\n1. Calls `completeWork` on the current fiber\n2. Collects subtree flags by bubbling them up\n3. Moves to the next sibling or returns to the parent\n\n**Complete Unit of Work Flow:**\n\n```mermaid\ngraph TB\n    start["completeUnitOfWork(unitOfWork)"]\n    loop["Loop: completedWork = unitOfWork"]\n    complete["completeWork(current, completedWork, lanes)"]\n    hasFlags{"completedWork.flags & Incomplete?"}\n    unwind["unwindWork() - handle errors"]\n    \n    start --> loop\n    loop --> complete\n    complete --> hasFlags\n    \n    hasFlags -->|"Yes (error)"| unwind\n    hasFlags -->|"No (success)"| bubble["bubbleProperties(completedWork)<br/>Aggregate child flags"]\n    \n    bubble --> resetLanes["Reset completedWork.lanes = NoLanes"]\n    resetLanes --> hasSibling{"completedWork.sibling !== null?"}\n    \n    hasSibling -->|"Yes"| returnSibling["workInProgress = sibling<br/>Return to performUnitOfWork"]\n    hasSibling -->|"No"| moveParent["completedWork = completedWork.return"]\n    \n    moveParent --> atRoot{"completedWork === null?"}\n    atRoot -->|"Yes (at root)"| exit["workInProgress = null<br/>Render phase complete"]\n    atRoot -->|"No"| loop\n```\n\nDuring `completeUnitOfWork`, if the `Incomplete` flag is set, it indicates an error or suspension occurred. The function then calls `unwindWork` to clean up context stacks and find an error boundary or suspense boundary.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1850-1980]()\n\nThe `completeWork` function in [packages/react-reconciler/src/ReactFiberCompleteWork.js]() handles:\n\n- Creating host instances (DOM nodes) for new HostComponents\n- Updating props that changed\n- Marking Update flags when work is needed\n- Handling hydration for server-rendered content\n\n**Key Complete Work Responsibilities:**\n\n| Fiber Tag | Complete Work Action |\n|-----------|---------------------|\n| HostComponent | Create DOM node, append children, finalize props |\n| HostText | Create text node |\n| HostRoot | Finalize container if using persistence mode |\n| SuspenseComponent | Determine if showing fallback or primary content |\n| OffscreenComponent | Handle visibility transitions |\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1850-1980](), [packages/react-reconciler/src/ReactFiberCompleteWork.js:845-1400]()\n\n### Flags and Subtree Flags\n\nDuring the render phase, fibers are marked with **flags** indicating what effects need to be applied during commit. The `bubbleProperties` function propagates these flags up the tree:\n\n```javascript\nfunction bubbleProperties(completedWork) {\n  let subtreeFlags = NoFlags;\n  let child = completedWork.child;\n  \n  // Collect flags from all children\n  while (child !== null) {\n    subtreeFlags |= child.subtreeFlags;\n    subtreeFlags |= child.flags;\n    child = child.sibling;\n  }\n  \n  completedWork.subtreeFlags = subtreeFlags;\n}\n```\n\nThis allows ancestor fibers to know if any descendant has effects, enabling efficient traversal during commit.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCompleteWork.js:662-724]()\n\n## Commit Phase\n\nOnce the render phase completes successfully (`workInProgressRootExitStatus === RootCompleted`), the commit phase begins. The commit phase is **synchronous and uninterruptible** - it must complete once started.\n\n### Commit Root Entry\n\n```mermaid\ngraph TB\n    renderComplete["renderRoot completes successfully"]\n    finishConcurrent["finishQueueingConcurrentUpdates()"]\n    commitRoot["commitRoot(root, recoverableErrors, transitions)"]\n    \n    renderComplete --> finishConcurrent\n    finishConcurrent --> commitRoot\n    \n    commitRoot --> commitImpl["commitRootImpl(root, recoverableErrors, transitions, renderPriorityLevel)"]\n    \n    commitImpl --> beforeMutation["commitBeforeMutationEffects(root, finishedWork)"]\n    commitImpl --> mutation["commitMutationEffects(root, finishedWork, lanes)"]\n    commitImpl --> layout["commitLayoutEffects(finishedWork, root, lanes)"]\n```\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:2210-2350]()\n\n### Commit Sub-Phases\n\nThe commit phase executes in three sequential sub-phases:\n\n#### 1. Before Mutation Phase\n\n**Purpose:** Run effects that read the DOM before mutations occur\n\n**Key Function:** `commitBeforeMutationEffects(root, firstChild, committedLanes)`\n\nThis phase traverses the tree and for each fiber:\n\n| Fiber Tag | Action |\n|-----------|--------|\n| ClassComponent | Calls `instance.getSnapshotBeforeUpdate(prevProps, prevState)` |\n| HostRoot | Clears container if needed |\n| FunctionComponent | Updates ref.impl for `useImperativeHandle` |\n\nThe traversal pattern uses `nextEffect` pointer and processes:\n1. Deletions array on each fiber\n2. The fiber itself via `commitBeforeMutationEffectsOnFiber`\n3. Children recursively\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:343-362](), [packages/react-reconciler/src/ReactFiberCommitWork.js:474-569]()\n\n#### 2. Mutation Phase\n\n**Purpose:** Apply all DOM mutations (insertions, updates, deletions)\n\n**Key Function:** `commitMutationEffects(root, finishedWork, committedLanes)`\n\nThis is where the actual DOM changes occur:\n\n| Operation | Function | What It Does |\n|-----------|----------|--------------|\n| Insert/Move | `commitPlacement(finishedWork)` | Inserts fiber\'s host instance into parent using `insertBefore` or `appendChild` |\n| Update | `commitUpdate(instance, updatePayload, type, oldProps, newProps)` | Updates DOM properties using `updateProperties` |\n| Delete | `commitDeletion(root, deletion)` | Recursively unmounts subtree and removes from DOM |\n| Text Update | `commitTextUpdate(textInstance, oldText, newText)` | Updates text node\'s `nodeValue` |\n| Ref Update | `safelyDetachRef(fiber)` / `safelyAttachRef(fiber)` | Detaches old refs, attaches new ones |\n\n**Critical Moment:** After mutations complete, the tree switch occurs:\n\n```javascript\nroot.current = finishedWork;\n```\n\nThe work-in-progress tree becomes the current tree. From this point, the new tree is "live."\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:1817-1900](), [packages/react-reconciler/src/ReactFiberCommitHostEffects.js:250-485](), [packages/react-reconciler/src/ReactFiberCommitHostEffects.js:132-150]()\n\n#### 3. Layout Phase\n\n**Purpose:** Run effects that need to read the updated DOM layout\n\n**Key Function:** `commitLayoutEffects(finishedRoot, finishedWork, committedLanes)`\n\nThis phase runs synchronously after mutations and calls:\n\n| Fiber Tag | Lifecycle Methods Called |\n|-----------|-------------------------|\n| ClassComponent | `componentDidMount()` or `componentDidUpdate(prevProps, prevState, snapshot)` |\n| FunctionComponent | Layout effects from `useLayoutEffect(() => { ... })` |\n| HostRoot | Root-level callbacks if any |\n| Profiler | `onRender(id, phase, actualDuration, ...)` |\n\nThe layout effect execution order:\n1. Traverse tree depth-first\n2. Call `commitHookLayoutEffects(fiber, HookLayout | HookHasEffect)` for function components\n3. Call `commitClassLayoutLifecycles(fiber, current)` for class components\n4. Attach refs via `safelyAttachRef(fiber, fiber.return)`\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:590-800](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:1-150]()\n\n**Commit Phase Timeline:**\n\n```mermaid\ngraph LR\n    start["Commit Begins"]\n    before["Before Mutation<br/>getSnapshotBeforeUpdate"]\n    switch["Switch Trees<br/>root.current = finishedWork"]\n    mutation["Mutation<br/>Apply DOM changes"]\n    layout["Layout<br/>componentDidMount<br/>useLayoutEffect"]\n    passive["Passive Effects<br/>useEffect<br/>(scheduled async)"]\n    \n    start --> before\n    before --> mutation\n    mutation --> switch\n    switch --> layout\n    layout --> passive\n```\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:2510-2900]()\n\n### Passive Effects (useEffect)\n\nUnlike layout effects which run synchronously during commit, passive effects (from `useEffect`) are scheduled to run **after** the commit phase completes. They run in a separate task:\n\n**Passive Effect Scheduling Flow:**\n\n```mermaid\ngraph TB\n    beforeMut["Before Mutation Phase"]\n    detectPassive["Detect fibers with PassiveMask flag"]\n    scheduleCallback["scheduleCallback(NormalPriority, flushPassiveEffects)"]\n    \n    beforeMut --> detectPassive\n    detectPassive --> scheduleCallback\n    \n    layoutDone["Layout Phase Complete"]\n    layoutDone --> yieldToBrowser["Yield to browser"]\n    \n    yieldToBrowser --> passiveTask["Scheduler picks up passive effects task"]\n    passiveTask --> flushPassive["flushPassiveEffects()"]\n    \n    flushPassive --> unmount["commitPassiveUnmountEffects(root, finishedWork)<br/>Run cleanup functions"]\n    unmount --> mount["commitPassiveMountEffects(root, finishedWork)<br/>Run effect create functions"]\n```\n\n**Key Functions:**\n\n- `commitPassiveUnmountEffects`: Walks tree and calls `destroy()` functions from previous render\n- `commitPassiveMountEffects`: Walks tree and calls effect `create()` functions, storing returned cleanup\n- `commitHookPassiveUnmountEffects(fiber, HookPassive | HookHasEffect)`: Processes individual hook effects\n- `commitHookPassiveMountEffects(fiber, HookPassive | HookHasEffect)`: Runs effect callbacks\n\nThe separation allows the browser to paint before running effects, improving perceived performance.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:2300-2500](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:150-300]()\n\n## Error Handling and Suspension\n\n### Suspended Render\n\nIf during `beginWork` a component throws a promise (Suspense) or encounters an error, the work loop enters a suspended state:\n\n```mermaid\ngraph TB\n    beginWork["beginWork throws"]\n    caught["try/catch in performUnitOfWork or workLoopConcurrent"]\n    handleThrow["handleThrow(root, thrownValue)"]\n    \n    beginWork --> caught\n    caught --> handleThrow\n    \n    handleThrow --> classify{"Classify thrown value"}\n    \n    classify -->|"SuspenseException"| suspendedOnData["workInProgressSuspendedReason = SuspendedOnData"]\n    classify -->|"Error object"| suspendedOnError["workInProgressSuspendedReason = SuspendedOnError"]\n    classify -->|"SuspenseActionException"| suspendedOnAction["workInProgressSuspendedReason = SuspendedOnAction"]\n    classify -->|"Wakeable/Promise"| suspendedOnImmediate["workInProgressSuspendedReason = SuspendedOnImmediate"]\n    \n    suspendedOnData --> throwException["throwException(root, errorInfo, lane)"]\n    suspendedOnError --> throwException\n    suspendedOnAction --> throwException\n    suspendedOnImmediate --> throwException\n    \n    throwException --> getSuspense["getSuspenseHandler() - find nearest Suspense boundary"]\n    getSuspense --> markCapture["boundary.flags |= ShouldCapture"]\n    markCapture --> attachPing["Attach ping listener to promise"]\n    attachPing --> unwind["Begin unwinding: unwindUnitOfWork()"]\n```\n\n**Key Suspension Reasons (workInProgressSuspendedReason):**\n\n| Reason | Value | Triggered By |\n|--------|-------|--------------|\n| NotSuspended | 0 | Normal execution |\n| SuspendedOnError | 1 | Error thrown during render |\n| SuspendedOnData | 2 | Promise thrown from `use(promise)` or legacy Suspense |\n| SuspendedOnImmediate | 3 | Promise without fallback |\n| SuspendedOnAction | 9 | Server Action suspended |\n\nWhen a promise is thrown, React:\n1. Finds the nearest Suspense boundary via `getSuspenseHandler()`\n2. Marks it with `ShouldCapture` flag\n3. Attaches a ping listener that will schedule a retry when the promise resolves\n4. Unwinds the stack to the boundary\n5. Re-renders from the boundary, this time rendering the fallback\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1610-1800](), [packages/react-reconciler/src/ReactFiberThrow.js:200-600](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:441-451]()\n\n### Unwind Work\n\nWhen unwinding due to an error or suspension, `unwindWork` is called on each fiber to clean up:\n\n**Unwind Work By Fiber Tag:**\n\n| Fiber Tag | Cleanup Actions |\n|-----------|----------------|\n| ClassComponent | `popLegacyContext(workInProgress)` if context provider |\n| HostRoot | `popHostContainer`, `popTopLevelLegacyContextObject`, `popRootTransition`, `popCacheProvider` |\n| HostComponent | `popHostContext(workInProgress)` |\n| SuspenseComponent | `popSuspenseHandler(workInProgress)` |\n| OffscreenComponent | `popHiddenContext`, `popSuspenseHandler` |\n| CacheComponent | `popCacheProvider` |\n\nIf the fiber has the `ShouldCapture` flag, `unwindWork` converts it to `DidCapture` and returns the fiber, telling the work loop to re-render from this point (for error boundaries and Suspense boundaries).\n\nThe function `unwindInterruptedWork` is similar but used when work is interrupted (e.g., higher priority update arrives), and doesn\'t handle error capture.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberUnwindWork.js:66-200]()\n\n## Complete Work Loop Diagram\n\n```mermaid\ngraph TB\n    update["State update or initial render"]\n    schedule["scheduleUpdateOnFiber(root, fiber, lane)"]\n    ensureScheduled["ensureRootIsScheduled(root)"]\n    \n    update --> schedule\n    schedule --> ensureScheduled\n    \n    ensureScheduled --> performRoot["performSyncWorkOnRoot or<br/>performConcurrentWorkOnRoot"]\n    \n    performRoot --> prepareStack["prepareFreshStack(root, lanes)<br/>Create workInProgress tree"]\n    \n    prepareStack --> workLoop["workLoopSync() or<br/>workLoopConcurrent()"]\n    \n    workLoop --> performUnit["performUnitOfWork(workInProgress)"]\n    \n    performUnit --> beginPhase["beginWork(current, workInProgress, lanes)"]\n    \n    beginPhase --> hasChild{"Returns child?"}\n    \n    hasChild -->|"Yes"| nextFiber["workInProgress = child<br/>Continue loop"]\n    hasChild -->|"No"| completePhase["completeUnitOfWork(workInProgress)"]\n    \n    completePhase --> completeWork["completeWork(current, completedWork, lanes)"]\n    \n    completeWork --> hasSibling{"Has sibling?"}\n    \n    hasSibling -->|"Yes"| nextSibling["workInProgress = sibling<br/>Continue loop"]\n    hasSibling -->|"No"| parent["Move to parent"]\n    \n    parent --> atRoot{"At root?"}\n    atRoot -->|"No"| completeWork\n    atRoot -->|"Yes"| checkStatus{"Exit status?"}\n    \n    checkStatus -->|"RootCompleted"| commitPhase["Commit Phase"]\n    checkStatus -->|"RootSuspended"| scheduleRetry["Schedule retry"]\n    checkStatus -->|"RootErrored"| handleError["Handle error"]\n    \n    commitPhase --> beforeMutation["Before Mutation Sub-Phase"]\n    beforeMutation --> mutationPhase["Mutation Sub-Phase"]\n    mutationPhase --> switchCurrent["root.current = finishedWork"]\n    switchCurrent --> layoutPhase["Layout Sub-Phase"]\n    layoutPhase --> schedulePassive["Schedule Passive Effects"]\n    schedulePassive --> done["Commit Complete"]\n    \n    nextFiber --> performUnit\n    nextSibling --> performUnit\n```\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:400-3000](), [packages/react-reconciler/src/ReactFiberBeginWork.js:1-4000](), [packages/react-reconciler/src/ReactFiberCompleteWork.js:1-1400](), [packages/react-reconciler/src/ReactFiberCommitWork.js:1-3500]()\n\n---\n\n# Page: React Hooks System\n\n# React Hooks System\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-debug-tools/src/ReactDebugHooks.js](packages/react-debug-tools/src/ReactDebugHooks.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspection-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspection-test.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegration-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegration-test.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegrationDOM-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegrationDOM-test.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/CustomHooks.js](packages/react-devtools-shell/src/app/InspectableElements/CustomHooks.js)\n- [packages/react-reconciler/src/ReactFiberHooks.js](packages/react-reconciler/src/ReactFiberHooks.js)\n- [packages/react-reconciler/src/ReactFiberOffscreenComponent.js](packages/react-reconciler/src/ReactFiberOffscreenComponent.js)\n- [packages/react-reconciler/src/ReactFiberRoot.js](packages/react-reconciler/src/ReactFiberRoot.js)\n- [packages/react-reconciler/src/ReactInternalTypes.js](packages/react-reconciler/src/ReactInternalTypes.js)\n- [packages/react-reconciler/src/__tests__/ReactHooks-test.internal.js](packages/react-reconciler/src/__tests__/ReactHooks-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js)\n- [packages/react-server/src/ReactFizzHooks.js](packages/react-server/src/ReactFizzHooks.js)\n- [packages/react-server/src/ReactFlightHooks.js](packages/react-server/src/ReactFlightHooks.js)\n- [packages/react/src/ReactHooks.js](packages/react/src/ReactHooks.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes the React Hooks System implementation, including the dispatcher pattern, hook data structures, effect execution lifecycle, and debugging capabilities. Hooks enable function components to use state and lifecycle features without writing classes.\n\nFor information about the overall reconciliation process that invokes hooks, see [Fiber Architecture and Work Loop](#4.1). For server-side rendering specifics, see [React Fizz (Streaming SSR)](#5.1). For static analysis of hook usage, see [ESLint Plugin for React Hooks](#7.2).\n\n## Architecture Overview\n\nThe hooks system uses a **dispatcher pattern** to provide different implementations based on component lifecycle phase. During render, hooks resolve to mount, update, or rerender dispatchers. Hook state is stored as a linked list on `fiber.memoizedState`, while effects form a circular list on `fiber.updateQueue.lastEffect`.\n\n**Hooks System Architecture**\n\n```mermaid\ngraph TB\n    subgraph "Public API Layer"\n        ReactHooks["React.useState<br/>React.useEffect<br/>React.useCallback<br/>etc."]\n    end\n    \n    subgraph "Dispatcher Resolution"\n        resolveDispatcher["resolveDispatcher()<br/>ReactSharedInternals.H"]\n        MountDispatcher["HooksDispatcherOnMount"]\n        UpdateDispatcher["HooksDispatcherOnUpdate"]\n        RerenderDispatcher["HooksDispatcherOnRerender"]\n        ContextOnlyDispatcher["ContextOnlyDispatcher"]\n    end\n    \n    subgraph "Core Render Function"\n        renderWithHooks["renderWithHooks()<br/>Sets dispatcher, calls component"]\n        finishRenderingHooks["finishRenderingHooks()<br/>Resets state"]\n    end\n    \n    subgraph "Hook Implementation"\n        mountState["mountState()<br/>Initialize hook"]\n        updateState["updateState()<br/>Process updates"]\n        mountEffect["mountEffect()<br/>Create effect"]\n        updateEffect["updateEffect()<br/>Update effect"]\n    end\n    \n    subgraph "Data Structures"\n        HookList["Hook Linked List<br/>fiber.memoizedState"]\n        UpdateQueue["UpdateQueue<br/>pending updates"]\n        EffectList["Effect Circular List<br/>fiber.updateQueue.lastEffect"]\n    end\n    \n    subgraph "Commit Phase"\n        commitHookEffectListMount["commitHookEffectListMount()"]\n        commitHookEffectListUnmount["commitHookEffectListUnmount()"]\n        flushPassiveEffects["flushPassiveEffects()"]\n    end\n    \n    ReactHooks --> resolveDispatcher\n    resolveDispatcher --> MountDispatcher\n    resolveDispatcher --> UpdateDispatcher\n    resolveDispatcher --> RerenderDispatcher\n    resolveDispatcher --> ContextOnlyDispatcher\n    \n    MountDispatcher --> renderWithHooks\n    UpdateDispatcher --> renderWithHooks\n    RerenderDispatcher --> renderWithHooks\n    \n    renderWithHooks --> mountState\n    renderWithHooks --> updateState\n    renderWithHooks --> mountEffect\n    renderWithHooks --> updateEffect\n    renderWithHooks --> finishRenderingHooks\n    \n    mountState --> HookList\n    updateState --> HookList\n    updateState --> UpdateQueue\n    mountEffect --> EffectList\n    updateEffect --> EffectList\n    \n    EffectList --> commitHookEffectListMount\n    EffectList --> commitHookEffectListUnmount\n    EffectList --> flushPassiveEffects\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1-200](), [packages/react/src/ReactHooks.js:1-242]()\n\n## Public Hooks API\n\nThe public API is exposed through `packages/react/src/ReactHooks.js`. Each hook function calls `resolveDispatcher()` to obtain the current dispatcher from `ReactSharedInternals.H`, then delegates to the dispatcher implementation.\n\n**Available Hooks**\n\n| Hook | Purpose | Stateful |\n|------|---------|----------|\n| `useState` | Local component state | Yes |\n| `useReducer` | State with reducer logic | Yes |\n| `useEffect` | Side effects after paint | No |\n| `useLayoutEffect` | Side effects before paint | No |\n| `useInsertionEffect` | CSS-in-JS insertions | No |\n| `useContext` | Read context value | No |\n| `useRef` | Mutable reference | Yes |\n| `useMemo` | Memoized value | Yes |\n| `useCallback` | Memoized callback | Yes |\n| `useImperativeHandle` | Customize ref value | No |\n| `useDebugValue` | DevTools label | No |\n| `useId` | Stable unique ID | Yes |\n| `useTransition` | Non-blocking updates | Yes |\n| `useDeferredValue` | Defer value updates | Yes |\n| `useSyncExternalStore` | Subscribe to external store | Yes |\n| `useOptimistic` | Optimistic UI updates | Yes |\n| `useActionState` | Form action state | Yes |\n| `use` | Read Promise/Context | No |\n\n**Dispatcher Resolution Flow**\n\n```mermaid\ngraph LR\n    App["Component calls<br/>useState()"]\n    resolveDispatcher["resolveDispatcher()"]\n    SharedInternals["ReactSharedInternals.H"]\n    \n    CurrentDispatcher{{"Current<br/>Dispatcher?"}}\n    \n    Mount["HooksDispatcherOnMount"]\n    Update["HooksDispatcherOnUpdate"]\n    Rerender["HooksDispatcherOnRerender"]\n    ContextOnly["ContextOnlyDispatcher"]\n    \n    mountState["mountState()"]\n    updateState["updateState()"]\n    \n    App --> resolveDispatcher\n    resolveDispatcher --> SharedInternals\n    SharedInternals --> CurrentDispatcher\n    \n    CurrentDispatcher -->|"First render"| Mount\n    CurrentDispatcher -->|"Subsequent render"| Update\n    CurrentDispatcher -->|"Render phase update"| Rerender\n    CurrentDispatcher -->|"Outside render"| ContextOnly\n    \n    Mount --> mountState\n    Update --> updateState\n    Rerender --> updateState\n    ContextOnly -->|"Throws error"| Error["Invalid hook call"]\n```\n\nSources: [packages/react/src/ReactHooks.js:24-42](), [packages/react/src/ReactHooks.js:66-71]()\n\n## Dispatcher Pattern\n\nThe dispatcher is a dynamic vtable that changes based on component lifecycle phase. `renderWithHooks()` sets the appropriate dispatcher before calling the component function, ensuring hooks resolve to the correct implementation.\n\n**Dispatcher Implementations**\n\n| Dispatcher | When Used | Behavior |\n|------------|-----------|----------|\n| `HooksDispatcherOnMount` | First render (`current === null`) | Initializes hook state, creates linked list |\n| `HooksDispatcherOnUpdate` | Subsequent renders | Reuses existing hooks, processes updates |\n| `HooksDispatcherOnRerender` | Render phase updates | Handles setState during render |\n| `ContextOnlyDispatcher` | Outside component render | Throws "Invalid hook call" error |\n| `HooksDispatcherOnMountInDEV` | DEV first render | Validates hook order, dependencies |\n| `HooksDispatcherOnUpdateInDEV` | DEV subsequent render | Validates hook order changes |\n\n**renderWithHooks Execution Flow**\n\n```mermaid\ngraph TB\n    Start["renderWithHooks(current, workInProgress, Component)"]\n    \n    SetContext["Set module state:<br/>renderLanes = nextRenderLanes<br/>currentlyRenderingFiber = workInProgress"]\n    \n    ResetFiber["Reset fiber state:<br/>workInProgress.memoizedState = null<br/>workInProgress.updateQueue = null"]\n    \n    CheckCurrent{{"current === null ||<br/>current.memoizedState === null"}}\n    \n    SetMount["ReactSharedInternals.H =<br/>HooksDispatcherOnMount"]\n    SetUpdate["ReactSharedInternals.H =<br/>HooksDispatcherOnUpdate"]\n    \n    CallComponent["children = Component(props, secondArg)"]\n    \n    CheckRerender{{"didScheduleRenderPhaseUpdateDuringThisPass"}}\n    \n    RerenderLoop["renderWithHooksAgain():<br/>Loop while updates scheduled<br/>Use HooksDispatcherOnRerender"]\n    \n    StrictModeCheck{{"StrictMode enabled?"}}\n    \n    DoubleInvoke["Double invoke component<br/>for side effect detection"]\n    \n    Finish["finishRenderingHooks():<br/>Reset dispatcher to ContextOnlyDispatcher"]\n    \n    Return["Return children"]\n    \n    Start --> SetContext\n    SetContext --> ResetFiber\n    ResetFiber --> CheckCurrent\n    \n    CheckCurrent -->|"Yes (mount)"| SetMount\n    CheckCurrent -->|"No (update)"| SetUpdate\n    \n    SetMount --> CallComponent\n    SetUpdate --> CallComponent\n    \n    CallComponent --> CheckRerender\n    \n    CheckRerender -->|"Yes"| RerenderLoop\n    CheckRerender -->|"No"| StrictModeCheck\n    \n    RerenderLoop --> StrictModeCheck\n    \n    StrictModeCheck -->|"Yes"| DoubleInvoke\n    StrictModeCheck -->|"No"| Finish\n    \n    DoubleInvoke --> Finish\n    Finish --> Return\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:503-632](), [packages/react-reconciler/src/ReactFiberHooks.js:634-750]()\n\n## Hook Data Structures\n\n### Hook Linked List\n\nEach hook call appends a `Hook` object to a singly-linked list stored on `fiber.memoizedState`. The list order must remain constant across renders (enforced by DEV warnings).\n\n**Hook Object Structure**\n\n```mermaid\ngraph LR\n    Fiber["Fiber Node"]\n    \n    subgraph "fiber.memoizedState"\n        Hook1["Hook {<br/>memoizedState: any<br/>baseState: any<br/>baseQueue: Update | null<br/>queue: UpdateQueue | null<br/>next: Hook | null<br/>}"]\n        \n        Hook2["Hook {<br/>memoizedState: any<br/>...next<br/>}"]\n        \n        Hook3["Hook {<br/>memoizedState: any<br/>...next<br/>}"]\n    end\n    \n    Fiber --> Hook1\n    Hook1 -->|"next"| Hook2\n    Hook2 -->|"next"| Hook3\n    Hook3 -->|"next"| Null["null"]\n```\n\nThe `Hook` type definition:\n\n```typescript\ntype Hook = {\n  memoizedState: any,      // Current state value or effect list\n  baseState: any,          // State before pending updates\n  baseQueue: Update | null, // Updates skipped by priority\n  queue: any,              // UpdateQueue for useState/useReducer\n  next: Hook | null        // Next hook in list\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:195-201](), [packages/react-reconciler/src/ReactFiberHooks.js:980-999]()\n\n### UpdateQueue Structure\n\nState hooks (`useState`, `useReducer`) maintain an `UpdateQueue` to track pending updates. Updates form a circular linked list and are processed in order during render.\n\n**UpdateQueue and Update Structure**\n\n```mermaid\ngraph TB\n    Hook["Hook"]\n    \n    subgraph "hook.queue (UpdateQueue)"\n        Queue["UpdateQueue {<br/>pending: Update | null<br/>lanes: Lanes<br/>dispatch: Function<br/>lastRenderedReducer: Function<br/>lastRenderedState: any<br/>}"]\n    end\n    \n    subgraph "Circular Update List"\n        Update1["Update {<br/>lane: Lane<br/>action: any<br/>hasEagerState: boolean<br/>eagerState: any<br/>next: Update<br/>}"]\n        \n        Update2["Update {<br/>lane: Lane<br/>action: any<br/>...next<br/>}"]\n        \n        Update3["Update {<br/>lane: Lane<br/>action: any<br/>...next<br/>}"]\n    end\n    \n    Hook -->|"queue"| Queue\n    Queue -->|"pending"| Update3\n    Update3 -->|"next"| Update1\n    Update1 -->|"next"| Update2\n    Update2 -->|"next"| Update3\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:165-181](), [packages/react-reconciler/src/ReactFiberHooks.js:175-181]()\n\n### Effect Circular List\n\nEffects (`useEffect`, `useLayoutEffect`, `useInsertionEffect`) are stored in a circular linked list on `fiber.updateQueue.lastEffect`. Each `Effect` object contains the effect function, cleanup function, dependencies, and flags.\n\n**Effect Data Structure**\n\n```typescript\ntype Effect = {\n  tag: HookFlags,              // HookPassive | HookLayout | HookInsertion\n  inst: EffectInstance,        // { destroy: Function | void }\n  create: () => (() => void) | void,  // Effect function\n  deps: Array<mixed> | void | null,   // Dependency array\n  next: Effect                 // Next effect in circular list\n}\n\ntype FunctionComponentUpdateQueue = {\n  lastEffect: Effect | null,   // Tail of circular effect list\n  events: Array<any> | null,   // Event functions\n  stores: Array<any> | null,   // Store consistency checks\n  memoCache: MemoCache | null  // Compiler cache\n}\n```\n\nThe `lastEffect` pointer points to the **last** effect in the circular list, so `lastEffect.next` is the **first** effect.\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:217-227](), [packages/react-reconciler/src/ReactFiberHooks.js:247-252]()\n\n## Core Hook Implementations\n\n### State Hooks: useState and useReducer\n\n`useState` is implemented as a specialized `useReducer` with a basic state reducer. Both follow the mount/update pattern.\n\n**useState/useReducer Implementation Flow**\n\n```mermaid\ngraph TB\n    Call["useState(initialState)<br/>or useReducer(reducer, initialArg, init)"]\n    \n    CreateWIP["createWorkInProgressHook()"]\n    \n    CheckPhase{{"Mount or Update?"}}\n    \n    subgraph "Mount Phase"\n        InitState["Calculate initial state:<br/>- useState: call initializer if function<br/>- useReducer: call init(initialArg) if provided"]\n        CreateQueue["Create UpdateQueue:<br/>queue = {<br/>  pending: null,<br/>  lanes: NoLanes,<br/>  dispatch: null,<br/>  lastRenderedReducer: reducer,<br/>  lastRenderedState: initialState<br/>}"]\n        BindDispatch["dispatch = dispatchSetState.bind(null, fiber, queue)"]\n        StoreState["hook.memoizedState = initialState<br/>hook.queue = queue"]\n        ReturnMount["Return [initialState, dispatch]"]\n    end\n    \n    subgraph "Update Phase"\n        CloneHook["Clone hook from current:<br/>workInProgressHook = {<br/>  memoizedState: currentHook.memoizedState,<br/>  baseState: currentHook.baseState,<br/>  baseQueue: currentHook.baseQueue,<br/>  queue: currentHook.queue<br/>}"]\n        \n        CheckUpdates{{"queue.pending !== null?"}}\n        \n        ProcessQueue["Process update queue:<br/>- Apply baseQueue (skipped updates)<br/>- Apply pending updates<br/>- Calculate new state<br/>- Determine if state changed"]\n        \n        UpdateBaseState["Update baseState, baseQueue<br/>for next render"]\n        \n        ReturnUpdate["Return [newState, dispatch]"]\n    end\n    \n    Call --> CreateWIP\n    CreateWIP --> CheckPhase\n    \n    CheckPhase -->|"Mount"| InitState\n    InitState --> CreateQueue\n    CreateQueue --> BindDispatch\n    BindDispatch --> StoreState\n    StoreState --> ReturnMount\n    \n    CheckPhase -->|"Update"| CloneHook\n    CloneHook --> CheckUpdates\n    \n    CheckUpdates -->|"Yes"| ProcessQueue\n    CheckUpdates -->|"No"| ReturnUpdate\n    \n    ProcessQueue --> UpdateBaseState\n    UpdateBaseState --> ReturnUpdate\n```\n\n**Eager State Computation**\n\nWhen `setState` is called, React attempts to compute the new state eagerly (outside render) if the queue is empty. If the new state equals the current state (using `Object.is`), React can bail out of the render entirely.\n\n```mermaid\ngraph TB\n    SetState["setState(action)<br/>or dispatch(action)"]\n    \n    CheckContext{{"Is inside render?"}}\n    \n    RenderPhaseUpdate["Enqueue render phase update:<br/>Store in renderPhaseUpdates Map"]\n    \n    CreateUpdate["Create Update object:<br/>update = {<br/>  lane: requestUpdateLane(),<br/>  action: action,<br/>  hasEagerState: false,<br/>  eagerState: null,<br/>  next: null<br/>}"]\n    \n    EnqueueConcurrent["enqueueConcurrentHookUpdate(fiber, queue, update, lane)"]\n    \n    CheckEager{{"Queue is empty &<br/>alternate exists?"}}\n    \n    ComputeEager["Eager computation:<br/>eagerState = lastRenderedReducer(lastRenderedState, action)"]\n    \n    CheckSame{{"Object.is(eagerState, currentState)?"}}\n    \n    MarkEager["update.hasEagerState = true<br/>update.eagerState = eagerState"]\n    \n    BailOut["Bail out:<br/>Do not schedule update<br/>Return immediately"]\n    \n    ScheduleUpdate["scheduleUpdateOnFiber(fiber, lane)"]\n    \n    SetState --> CheckContext\n    \n    CheckContext -->|"Yes"| RenderPhaseUpdate\n    CheckContext -->|"No"| CreateUpdate\n    \n    CreateUpdate --> EnqueueConcurrent\n    EnqueueConcurrent --> CheckEager\n    \n    CheckEager -->|"Yes"| ComputeEager\n    CheckEager -->|"No"| ScheduleUpdate\n    \n    ComputeEager --> CheckSame\n    \n    CheckSame -->|"Yes"| MarkEager\n    CheckSame -->|"No"| ScheduleUpdate\n    \n    MarkEager --> BailOut\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1095-1253](), [packages/react-reconciler/src/ReactFiberHooks.js:2648-2861]()\n\n### Effect Hooks: useEffect, useLayoutEffect, useInsertionEffect\n\nEffect hooks create `Effect` objects and append them to the circular effect list. The `tag` field determines when the effect is executed:\n\n- `HookInsertion`: During commit before mutations (for CSS-in-JS)\n- `HookLayout`: During commit after mutations, before paint (sync)\n- `HookPassive`: After commit and paint (async via scheduler)\n\n**Effect Mount and Update**\n\n```mermaid\ngraph TB\n    CallEffect["useEffect(create, deps)"]\n    \n    CreateWIP["createWorkInProgressHook()"]\n    \n    CheckPhase{{"Mount or Update?"}}\n    \n    subgraph "Mount Phase"\n        CreateEffect["Create Effect object:<br/>effect = {<br/>  tag: HookPassive | HookHasEffect,<br/>  inst: { destroy: undefined },<br/>  create: create,<br/>  deps: deps,<br/>  next: null<br/>}"]\n        \n        AppendEffect["Append to circular list:<br/>fiber.updateQueue.lastEffect = effect"]\n        \n        MarkFlag["Mark fiber flag:<br/>fiber.flags |= PassiveEffect"]\n    end\n    \n    subgraph "Update Phase"\n        CheckDeps{{"areHookInputsEqual(nextDeps, prevDeps)?"}}\n        \n        CreateNoOpEffect["Create Effect without HookHasEffect:<br/>effect.tag = HookPassive<br/>(won\'t fire)"]\n        \n        CreateNewEffect["Create Effect with HookHasEffect:<br/>effect.tag = HookPassive | HookHasEffect<br/>(will fire)"]\n        \n        UpdateList["Update circular list"]\n    end\n    \n    CallEffect --> CreateWIP\n    CreateWIP --> CheckPhase\n    \n    CheckPhase -->|"Mount"| CreateEffect\n    CreateEffect --> AppendEffect\n    AppendEffect --> MarkFlag\n    \n    CheckPhase -->|"Update"| CheckDeps\n    \n    CheckDeps -->|"Deps unchanged"| CreateNoOpEffect\n    CheckDeps -->|"Deps changed"| CreateNewEffect\n    \n    CreateNoOpEffect --> UpdateList\n    CreateNewEffect --> UpdateList\n    UpdateList --> MarkFlag\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1956-2023](), [packages/react-reconciler/src/ReactFiberHooks.js:2025-2069]()\n\n### Ref Hook: useRef\n\n`useRef` is a simple hook that stores a mutable object with a `current` property. The ref object identity remains stable across renders.\n\n```mermaid\ngraph LR\n    Call["useRef(initialValue)"]\n    \n    CreateWIP["createWorkInProgressHook()"]\n    \n    CheckPhase{{"Mount or Update?"}}\n    \n    Mount["Mount:<br/>ref = { current: initialValue }<br/>hook.memoizedState = ref"]\n    \n    Update["Update:<br/>ref = hook.memoizedState"]\n    \n    Return["Return ref"]\n    \n    Call --> CreateWIP\n    CreateWIP --> CheckPhase\n    CheckPhase -->|"Mount"| Mount\n    CheckPhase -->|"Update"| Update\n    Mount --> Return\n    Update --> Return\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1764-1779]()\n\n### Memoization Hooks: useMemo and useCallback\n\n`useMemo` and `useCallback` cache computed values based on dependency arrays. During mount, they compute and store the value. During update, they check dependencies and either reuse or recompute.\n\n**useMemo Implementation**\n\n```mermaid\ngraph TB\n    Call["useMemo(create, deps)"]\n    \n    CreateWIP["createWorkInProgressHook()"]\n    \n    CheckPhase{{"Mount or Update?"}}\n    \n    subgraph "Mount Phase"\n        CallCreate["value = create()"]\n        StoreMount["hook.memoizedState = [value, deps]"]\n        ReturnMount["Return value"]\n    end\n    \n    subgraph "Update Phase"\n        GetPrev["prevState = hook.memoizedState<br/>[prevValue, prevDeps] = prevState"]\n        \n        CheckDeps{{"areHookInputsEqual(nextDeps, prevDeps)?"}}\n        \n        ReuseValue["Return prevValue"]\n        \n        RecomputeValue["value = create()<br/>hook.memoizedState = [value, nextDeps]"]\n        \n        ReturnNew["Return value"]\n    end\n    \n    Call --> CreateWIP\n    CreateWIP --> CheckPhase\n    \n    CheckPhase -->|"Mount"| CallCreate\n    CallCreate --> StoreMount\n    StoreMount --> ReturnMount\n    \n    CheckPhase -->|"Update"| GetPrev\n    GetPrev --> CheckDeps\n    \n    CheckDeps -->|"Yes"| ReuseValue\n    CheckDeps -->|"No"| RecomputeValue\n    \n    RecomputeValue --> ReturnNew\n```\n\n`useCallback(fn, deps)` is implemented as `useMemo(() => fn, deps)`.\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1890-1931](), [packages/react-reconciler/src/ReactFiberHooks.js:1933-1954]()\n\n## Effect Execution Lifecycle\n\nEffects are executed during the commit phase, but at different times based on their type. The fiber flags (`PassiveEffect`, `UpdateEffect`) indicate which effects need to be processed.\n\n**Effect Execution Timeline**\n\n```mermaid\ngraph TB\n    subgraph "Render Phase"\n        RenderComponent["renderWithHooks()<br/>Component executes"]\n        CollectEffects["Effects collected in<br/>fiber.updateQueue.lastEffect"]\n        MarkFlags["Set fiber.flags:<br/>PassiveEffect, UpdateEffect, etc."]\n    end\n    \n    subgraph "Commit Phase - Before Mutation"\n        BeforeMutation["commitBeforeMutationEffects()"]\n        Snapshots["No effect execution<br/>(getSnapshotBeforeUpdate)"]\n    end\n    \n    subgraph "Commit Phase - Mutation"\n        Mutation["commitMutationEffects()"]\n        InsertionUnmount["commitHookEffectListUnmount(HookInsertion):<br/>Run insertion effect cleanups"]\n    end\n    \n    subgraph "Commit Phase - Layout"\n        Layout["commitLayoutEffects()"]\n        \n        InsertionMount["commitHookEffectListMount(HookInsertion):<br/>Run insertion effects"]\n        \n        LayoutUnmount["commitHookEffectListUnmount(HookLayout):<br/>Run layout effect cleanups"]\n        \n        LayoutMount["commitHookEffectListMount(HookLayout):<br/>Run layout effects (useLayoutEffect)"]\n    end\n    \n    subgraph "After Paint - Async"\n        SchedulePassive["scheduleCallback(NormalPriority, flushPassiveEffects)"]\n        \n        FlushPassive["flushPassiveEffects()"]\n        \n        PassiveUnmount["commitHookPassiveUnmountEffects():<br/>Run passive effect cleanups"]\n        \n        PassiveMount["commitHookPassiveMountEffects():<br/>Run passive effects (useEffect)"]\n    end\n    \n    RenderComponent --> CollectEffects\n    CollectEffects --> MarkFlags\n    \n    MarkFlags --> BeforeMutation\n    BeforeMutation --> Snapshots\n    \n    Snapshots --> Mutation\n    Mutation --> InsertionUnmount\n    \n    InsertionUnmount --> Layout\n    Layout --> InsertionMount\n    InsertionMount --> LayoutUnmount\n    LayoutUnmount --> LayoutMount\n    \n    LayoutMount --> SchedulePassive\n    SchedulePassive --> FlushPassive\n    FlushPassive --> PassiveUnmount\n    PassiveUnmount --> PassiveMount\n```\n\n**Effect Tag Bits**\n\n| Tag | Constant | Meaning |\n|-----|----------|---------|\n| `HookHasEffect` | `0b001` | Effect should fire this render |\n| `HookInsertion` | `0b010` | Insertion effect (CSS-in-JS) |\n| `HookLayout` | `0b100` | Layout effect (sync after mutations) |\n| `HookPassive` | `0b1000` | Passive effect (async after paint) |\n\nEffects only execute if `effect.tag & HookHasEffect !== 0`. During mount, all effects have `HookHasEffect`. During update, only effects with changed dependencies have `HookHasEffect`.\n\nSources: [packages/react-reconciler/src/ReactHookEffectTags.js:1-21](), [packages/react-reconciler/src/ReactFiberHooks.js:1956-2023]()\n\n## Server-Side Hooks Implementation\n\nThe Fizz server renderer (`packages/react-server/src/ReactFizzHooks.js`) provides a separate hooks implementation optimized for synchronous server rendering. Key differences:\n\n- **No effects**: `useEffect`, `useLayoutEffect`, `useInsertionEffect` are no-ops\n- **Simpler state management**: No concurrent updates or lanes\n- **Synchronous execution**: No scheduling or yielding\n- **Render phase updates**: Handled via re-render loop with `renderPhaseUpdates` Map\n\n**Server Hook State Management**\n\n```mermaid\ngraph TB\n    PrepareHooks["prepareToUseHooks(request, task, componentIdentity)"]\n    \n    SetContext["Set module state:<br/>currentlyRenderingComponent = componentIdentity<br/>currentlyRenderingTask = task<br/>currentlyRenderingRequest = request"]\n    \n    CallComponent["Component(props, context)"]\n    \n    CreateWIPHook["createWorkInProgressHook():<br/>Create or reuse hook"]\n    \n    CheckRerender{{"didScheduleRenderPhaseUpdate?"}}\n    \n    RerenderLoop["Loop while updates scheduled:<br/>Apply renderPhaseUpdates<br/>Re-call Component()"]\n    \n    FinishHooks["finishHooks():<br/>Return children"]\n    \n    ResetState["resetHooksState():<br/>Clear module state"]\n    \n    PrepareHooks --> SetContext\n    SetContext --> CallComponent\n    \n    CallComponent --> CreateWIPHook\n    CreateWIPHook --> CheckRerender\n    \n    CheckRerender -->|"Yes"| RerenderLoop\n    RerenderLoop --> CheckRerender\n    \n    CheckRerender -->|"No"| FinishHooks\n    FinishHooks --> ResetState\n```\n\n**Server useActionState Hook**\n\n`useActionState` (formerly `useFormState`) is special on the server. It receives permalink information and action state from the request, enabling progressive enhancement of forms.\n\nSources: [packages/react-server/src/ReactFizzHooks.js:207-316](), [packages/react-server/src/ReactFizzHooks.js:665-831]()\n\n## Debug and DevTools Integration\n\n### ReactDebugHooks\n\nThe `react-debug-tools` package provides `inspectHooks()` and `inspectHooksOfFiber()` to extract hook information for DevTools. It uses a custom dispatcher that logs all hook calls.\n\n**Hook Inspection Architecture**\n\n```mermaid\ngraph TB\n    DevTools["React DevTools"]\n    \n    InspectAPI["ReactDebugTools.inspectHooksOfFiber(fiber)"]\n    \n    subgraph "Inspection Process"\n        SaveDispatcher["Save current dispatcher"]\n        \n        SetDebugDispatcher["Set ReactSharedInternals.H = DispatcherProxy"]\n        \n        SetupContext["Setup currentFiber, currentHook<br/>from fiber.memoizedState"]\n        \n        ReplayRender["Call Component(props)<br/>to replay render"]\n        \n        LogHooks["Dispatcher logs each hook call:<br/>hookLog.push({ primitive, value, stackError })"]\n        \n        RestoreDispatcher["Restore original dispatcher"]\n        \n        BuildTree["buildTree(rootStack, hookLog):<br/>Parse stack traces<br/>Construct hook tree with nesting"]\n    end\n    \n    ReturnTree["Return HooksTree:<br/>Array of HooksNode"]\n    \n    DevTools --> InspectAPI\n    InspectAPI --> SaveDispatcher\n    SaveDispatcher --> SetDebugDispatcher\n    SetDebugDispatcher --> SetupContext\n    SetupContext --> ReplayRender\n    ReplayRender --> LogHooks\n    LogHooks --> RestoreDispatcher\n    RestoreDispatcher --> BuildTree\n    BuildTree --> ReturnTree\n    ReturnTree --> DevTools\n```\n\n**HooksNode Structure**\n\n```typescript\ntype HooksNode = {\n  id: number | null,              // Hook index for state hooks\n  isStateEditable: boolean,       // Can DevTools edit this state?\n  name: string,                   // Hook name (e.g., "State", "Effect", "Custom")\n  value: mixed,                   // Hook value\n  subHooks: Array<HooksNode>,     // Nested custom hook calls\n  debugInfo: ReactDebugInfo | null, // Debug metadata\n  hookSource: HookSource | null   // Source location { fileName, lineNumber, etc. }\n}\n```\n\nThe debug dispatcher intercepts every hook call, extracts its value from the fiber\'s hook list, and records it in `hookLog`. Stack trace parsing determines which hooks are nested inside custom hooks.\n\nSources: [packages/react-debug-tools/src/ReactDebugHooks.js:1-300](), [packages/react-debug-tools/src/ReactDebugHooks.js:996-1098]()\n\n### DEV-Only Validation\n\nIn development builds, React enforces the Rules of Hooks through several mechanisms:\n\n**Hook Order Validation**\n\n```mermaid\ngraph TB\n    Render["Component renders"]\n    \n    CheckDev{{"__DEV__ mode?"}}\n    \n    SaveTypes["Save hook types:<br/>workInProgress._debugHookTypes = hookTypesDev"]\n    \n    MountHook["mountHookTypesDev():<br/>hookTypesDev.push(hookName)"]\n    \n    UpdateHook["updateHookTypesDev():<br/>Check hookTypesDev[index] === hookName"]\n    \n    Mismatch{{"Hook type mismatch?"}}\n    \n    WarnMismatch["console.error:<br/>\'React has detected a change in the order of Hooks\'<br/>Show table of previous vs current"]\n    \n    CheckDeps["checkDepsAreArrayDev(deps):<br/>Warn if deps is not array"]\n    \n    CheckDepLength["Check deps.length matches prevDeps.length"]\n    \n    Continue["Continue render"]\n    \n    Render --> CheckDev\n    \n    CheckDev -->|"Yes"| SaveTypes\n    CheckDev -->|"No"| Continue\n    \n    SaveTypes --> MountHook\n    SaveTypes --> UpdateHook\n    \n    UpdateHook --> Mismatch\n    \n    Mismatch -->|"Yes"| WarnMismatch\n    Mismatch -->|"No"| CheckDeps\n    \n    WarnMismatch --> Continue\n    CheckDeps --> CheckDepLength\n    CheckDepLength --> Continue\n```\n\n**Validated Conditions**\n\n| Rule | Check | Error Message |\n|------|-------|---------------|\n| Hook order | `hookTypesDev[index] === currentHookName` | "React has detected a change in the order of Hooks" |\n| Dependency array | `isArray(deps)` | "received a final argument that is not an array" |\n| Dependency length | `nextDeps.length === prevDeps.length` | "changed size between renders" |\n| Effect callback | `create != null` | "requires an effect callback" |\n| Invalid context | `currentlyRenderingFiber !== null` | "Invalid hook call" |\n| Async component | `Object.prototype.toString.call(Component) !== \'[object AsyncFunction]\'` | "is an async Client Component" |\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:309-394](), [packages/react-reconciler/src/ReactFiberHooks.js:334-347]()\n\n## Hook Lifecycle Summary\n\n**Complete Hook Execution Flow**\n\n```mermaid\ngraph TB\n    subgraph "Initial Mount"\n        Mount1["renderWithHooks() sets HooksDispatcherOnMount"]\n        Mount2["Component calls hooks"]\n        Mount3["mountWorkInProgressHook() creates Hook nodes"]\n        Mount4["Hooks stored in fiber.memoizedState linked list"]\n        Mount5["Effects stored in fiber.updateQueue.lastEffect"]\n        Mount6["Fiber marked with PassiveEffect, UpdateEffect flags"]\n    end\n    \n    subgraph "Update Render"\n        Update1["renderWithHooks() sets HooksDispatcherOnUpdate"]\n        Update2["Component calls hooks"]\n        Update3["updateWorkInProgressHook() clones from current"]\n        Update4["Process update queues"]\n        Update5["Compare dependencies for effects"]\n        Update6["Mark changed effects with HookHasEffect"]\n    end\n    \n    subgraph "Commit Effects"\n        Commit1["Commit phase begins"]\n        Commit2["commitMutationEffects(): Insertion effect cleanups"]\n        Commit3["commitLayoutEffects(): Insertion + Layout effects"]\n        Commit4["Layout effect cleanups, then mounts"]\n        Commit5["scheduleCallback for passive effects"]\n        Commit6["After paint: flushPassiveEffects()"]\n        Commit7["Passive effect cleanups, then mounts"]\n    end\n    \n    subgraph "setState Called"\n        SetState1["setState(action) during event"]\n        SetState2["Create Update object"]\n        SetState3["Eager state computation if possible"]\n        SetState4["enqueueConcurrentHookUpdate()"]\n        SetState5["scheduleUpdateOnFiber()"]\n        SetState6["Triggers new render"]\n    end\n    \n    Mount1 --> Mount2\n    Mount2 --> Mount3\n    Mount3 --> Mount4\n    Mount4 --> Mount5\n    Mount5 --> Mount6\n    \n    Mount6 --> Commit1\n    \n    Update1 --> Update2\n    Update2 --> Update3\n    Update3 --> Update4\n    Update4 --> Update5\n    Update5 --> Update6\n    \n    Update6 --> Commit1\n    \n    Commit1 --> Commit2\n    Commit2 --> Commit3\n    Commit3 --> Commit4\n    Commit4 --> Commit5\n    Commit5 --> Commit6\n    Commit6 --> Commit7\n    \n    SetState1 --> SetState2\n    SetState2 --> SetState3\n    SetState3 --> SetState4\n    SetState4 --> SetState5\n    SetState5 --> SetState6\n    SetState6 --> Update1\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:503-750](), [packages/react-reconciler/src/ReactFiberHooks.js:2648-2861]()\n\n## Key Implementation Files\n\n| File | Purpose |\n|------|---------|\n| [packages/react/src/ReactHooks.js]() | Public hooks API, dispatcher resolution |\n| [packages/react-reconciler/src/ReactFiberHooks.js]() | Core hooks implementation for client-side rendering |\n| [packages/react-reconciler/src/ReactInternalTypes.js:46-66]() | `HookType`, `Dispatcher`, `Hook` type definitions |\n| [packages/react-reconciler/src/ReactInternalTypes.js:398-459]() | `Dispatcher` interface with all hook methods |\n| [packages/react-server/src/ReactFizzHooks.js]() | Server-side hooks implementation for Fizz |\n| [packages/react-debug-tools/src/ReactDebugHooks.js]() | Hook inspection for DevTools |\n| [packages/react-reconciler/src/ReactHookEffectTags.js]() | Effect type flags and constants |\n| [packages/react-reconciler/src/ReactFiberCommitWork.js]() | Effect execution during commit phase |\n\n---\n\n# Page: Lane-Based Scheduling and Priorities\n\n# Lane-Based Scheduling and Priorities\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document explains React\'s lane-based scheduling system, which assigns priority levels to updates and determines the order in which work is processed. Lanes are React\'s internal mechanism for implementing concurrent rendering, allowing high-priority updates to interrupt lower-priority work.\n\nFor information about the reconciler work loop that executes scheduled work, see [4.2](#4.2). For hook state management within the scheduling system, see [4.3](#4.3). For Suspense-specific retry scheduling, see [4.5](#4.5).\n\n## Overview\n\nThe lane system represents priority levels as bit flags in a 32-bit integer, where each bit position corresponds to a specific priority level. This allows React to efficiently perform set operations (union, intersection, difference) on groups of lanes and quickly determine the highest priority work.\n\nUpdates are assigned lanes based on their origin (user input, transition, idle work) and context (render phase, commit phase). The reconciler then selects which lanes to work on, potentially preempting lower-priority work when higher-priority updates arrive.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:1-100]()\n\n## Lane Definitions and Priority Levels\n\nThe following table lists all lane types from highest to lowest priority:\n\n| Lane Name | Binary Representation | Use Case |\n|-----------|----------------------|----------|\n| `SyncHydrationLane` | `0b...0001` | Synchronous hydration during SSR |\n| `SyncLane` | `0b...0010` | Synchronous updates (e.g., `flushSync`) |\n| `InputContinuousHydrationLane` | `0b...0100` | Hydration for continuous input |\n| `InputContinuousLane` | `0b...1000` | Continuous user input (drag, scroll) |\n| `DefaultHydrationLane` | `0b...10000` | Default hydration priority |\n| `DefaultLane` | `0b...100000` | Default updates (most `setState` calls) |\n| `GestureLane` | `0b...1000000` | Gesture-driven transitions |\n| `TransitionHydrationLane` | `0b...10000000` | Hydration for transitions |\n| `TransitionLanes` (16 lanes) | `0b...1111111100000000` | Transition updates (`startTransition`) |\n| `RetryLanes` (5 lanes) | `0b...11111000000000000000000` | Suspense boundary retries |\n| `IdleHydrationLane` | `0b...100000000000000000000000` | Idle hydration work |\n| `IdleLane` | `0b...1000000000000000000000000` | Idle updates |\n| `OffscreenLane` | `0b...10000000000000000000000000` | Offscreen/prerendering work |\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:40-93]()\n\n## Lane Representation and Bitwise Operations\n\n### Lane Type Definitions\n\n```\ntype Lanes = number;  // Set of lanes (bitwise OR of Lane values)\ntype Lane = number;   // Single lane (power of 2)\n```\n\nLanes use bitwise operations for efficient set manipulation:\n\n```mermaid\ngraph TB\n    subgraph "Lane Operations"\n        A["mergeLanes(a, b)"]\n        B["removeLanes(set, subset)"]\n        C["intersectLanes(a, b)"]\n        D["isSubsetOfLanes(set, subset)"]\n        E["includesSomeLane(a, b)"]\n        F["getHighestPriorityLane(lanes)"]\n    end\n    \n    A -->|"a | b"| OR["Bitwise OR"]\n    B -->|"set & ~subset"| AND_NOT["Bitwise AND NOT"]\n    C -->|"a & b"| AND["Bitwise AND"]\n    D -->|"(set & subset) === subset"| CHECK1["Equality Check"]\n    E -->|"(a & b) !== NoLanes"| CHECK2["Non-zero Check"]\n    F -->|"lanes & -lanes"| ISOLATE["Isolate Rightmost Bit"]\n```\n\n**Diagram: Lane Bitwise Operations**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:145-223]()\n\n### Common Lane Groupings\n\n| Group Name | Lanes Included | Purpose |\n|------------|----------------|---------|\n| `SyncUpdateLanes` | `SyncLane \\| InputContinuousLane \\| DefaultLane` | Synchronous or near-synchronous updates |\n| `UpdateLanes` | All non-hydration, non-offscreen lanes | Normal update work |\n| `NonIdleWork` | All lanes except `IdleLane` and `OffscreenLane` | Work that shouldn\'t be idle |\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:55-56]()\n\n## Lane Assignment Process\n\n### Update Lane Request Flow\n\n```mermaid\ngraph TD\n    Update["Update Triggered"]\n    Update --> CheckContext{"Execution Context?"}\n    \n    CheckContext -->|"RenderContext"| RenderPhase["pickArbitraryLane(workInProgressRootRenderLanes)"]\n    CheckContext -->|"NoContext"| CheckTransition{"In Transition?"}\n    \n    CheckTransition -->|"Yes"| RequestTransition["requestTransitionLane(transition)"]\n    CheckTransition -->|"No"| EventPriority["eventPriorityToLane(resolveUpdatePriority())"]\n    \n    RequestTransition --> ClaimTransition["claimNextTransitionLane()"]\n    ClaimTransition --> AssignedLane["Transition Lane Assigned"]\n    \n    EventPriority --> MapEvent{"Event Priority"}\n    MapEvent -->|"DiscreteEventPriority"| Sync["SyncLane"]\n    MapEvent -->|"ContinuousEventPriority"| Continuous["InputContinuousLane"]\n    MapEvent -->|"DefaultEventPriority"| Default["DefaultLane"]\n    MapEvent -->|"IdleEventPriority"| Idle["IdleLane"]\n    \n    RenderPhase --> AssignedLane\n    Sync --> AssignedLane\n    Continuous --> AssignedLane\n    Default --> AssignedLane\n    Idle --> AssignedLane\n```\n\n**Diagram: Lane Assignment Decision Tree**\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:803-847](), [packages/react-reconciler/src/ReactFiberRootScheduler.js:206-271]()\n\n### Transition Lane Allocation\n\nTransition lanes are allocated cyclically from a pool of 16 lanes:\n\n```mermaid\ngraph LR\n    T["Transition Created"] --> Pool["Transition Lane Pool<br/>(16 lanes)"]\n    Pool --> Claim["claimNextTransitionLane()"]\n    Claim --> Next["nextTransitionLane<br/>(cycling index)"]\n    Next --> Assign["Assign TransitionLane1-16"]\n    Assign --> Increment["Increment nextTransitionLane"]\n    Increment --> Wrap{"Wrapped around?"}\n    Wrap -->|"Yes"| Reset["Reset to TransitionLane1"]\n    Wrap -->|"No"| Pool\n```\n\n**Diagram: Transition Lane Cycling**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:394-439]()\n\n### Retry Lane Allocation\n\nWhen Suspense boundaries suspend, they\'re assigned retry lanes from a pool of 5 lanes:\n\n```\nclaimNextRetryLane(): Lane\n   Checks current lane against retry lane mask\n   Returns next available retry lane\n   Wraps around after lane 5\n```\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:353-385]()\n\n## Lane Selection Algorithm\n\nThe `getNextLanes()` function determines which lanes React should work on next:\n\n```mermaid\ngraph TD\n    Start["getNextLanes(root, wipLanes)"]\n    Start --> CheckPending{"pendingLanes === NoLanes?"}\n    CheckPending -->|"Yes"| ReturnNone["return NoLanes"]\n    CheckPending -->|"No"| MarkExpired["markStarvedLanesAsExpired(root, currentTime)"]\n    \n    MarkExpired --> CheckNonIdle{"includesNonIdleWork(wipLanes)?"}\n    CheckNonIdle -->|"Yes"| NonIdlePath["nonIdlePendingLanes = pendingLanes & ~IdleLanes"]\n    CheckNonIdle -->|"No"| IdlePath["Work from all pendingLanes"]\n    \n    NonIdlePath --> CheckBlocking{"includesBlockingLane()?"}\n    IdlePath --> CheckBlocking\n    \n    CheckBlocking -->|"Yes"| BlockingLanes["return blocking lanes<br/>(SyncUpdateLanes)"]\n    CheckBlocking -->|"No"| CheckExpired{"includesExpiredLane()?"}\n    \n    CheckExpired -->|"Yes"| ExpiredLanes["return expired lanes"]\n    CheckExpired -->|"No"| CheckEntangled{"Check entangled lanes"}\n    \n    CheckEntangled --> FinalLanes["return highest priority lanes"]\n```\n\n**Diagram: Lane Selection Algorithm**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:544-697]()\n\n### Priority Checks\n\nThe selection algorithm uses several helper functions to categorize lanes:\n\n| Function | Purpose |\n|----------|---------|\n| `includesBlockingLane(lanes)` | Checks if lanes include sync or input-continuous work |\n| `includesExpiredLane(root, lanes)` | Checks if any lanes have expired |\n| `includesNonIdleWork(lanes)` | Checks if work is not idle priority |\n| `includesOnlyRetries(lanes)` | Checks if only retry lanes remain |\n| `includesTransitionLane(lanes)` | Checks if transition work is present |\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:225-304]()\n\n## Root Lane Management\n\nEach `FiberRoot` maintains several lane sets to track work state:\n\n```mermaid\ngraph TD\n    subgraph FiberRoot["FiberRoot Lane State"]\n        Pending["pendingLanes<br/>All pending work"]\n        Suspended["suspendedLanes<br/>Work blocked on Suspense"]\n        Pinged["pingedLanes<br/>Suspense resolved"]\n        Expired["expiredLanes<br/>Starved lanes"]\n        Finished["finishedLanes<br/>Just committed"]\n    end\n    \n    Update["New Update"] -->|"markRootUpdated()"| Pending\n    Suspend["Suspends"] -->|"markRootSuspended()"| Suspended\n    Resolve["Promise Resolves"] -->|"markRootPinged()"| Pinged\n    TimeOut["Time Passes"] -->|"markStarvedLanesAsExpired()"| Expired\n    Commit["Commit"] -->|"markRootFinished()"| Finished\n    \n    Pending -.->|"influences"| NextLanes["getNextLanes()"]\n    Suspended -.->|"influences"| NextLanes\n    Pinged -.->|"influences"| NextLanes\n    Expired -.->|"influences"| NextLanes\n```\n\n**Diagram: Root Lane State Management**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:845-1065]()\n\n### Lane State Transitions\n\n```mermaid\nstateDiagram-v2\n    [*] --> Pending: markRootUpdated()\n    Pending --> Rendering: performWorkOnRoot()\n    Rendering --> Suspended: Suspends\n    Rendering --> Committed: Completes\n    Suspended --> Pinged: markRootPinged()\n    Pinged --> Rendering: Retry\n    Suspended --> Expired: Timeout\n    Expired --> Rendering: Force retry\n    Committed --> [*]: markRootFinished()\n```\n\n**Diagram: Lane Lifecycle**\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1116-1400](), [packages/react-reconciler/src/ReactFiberLane.js:845-949]()\n\n## Lane Entanglement\n\nEntanglement forces certain lanes to render together, ensuring consistency:\n\n```mermaid\ngraph TD\n    subgraph "Entanglement Scenarios"\n        A["Update in Transition"]\n        B["Update to Suspense Boundary"]\n        C["Context Provider Update"]\n    end\n    \n    A --> Track["Track entangled lanes<br/>root.entangledLanes"]\n    B --> Track\n    C --> Track\n    \n    Track --> Get["getEntangledLanes(root, renderLanes)"]\n    Get --> Merge["mergeLanes(renderLanes, entangled)"]\n    Merge --> Render["Render all entangled work together"]\n```\n\n**Diagram: Lane Entanglement Process**\n\nWhen an update occurs during a transition that also affects non-transition work, both must complete together to maintain consistency.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:699-787](), [packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:534-553]()\n\n### Entanglement Example\n\n```\nScenario: User in transition, context updates\n  1. Transition lane: TransitionLane1\n  2. Context update schedules: DefaultLane\n  3. Entangle: TransitionLane1 | DefaultLane\n  4. Both lanes render together\n```\n\nSources: [packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:534-553]()\n\n## Expiration and Starvation Prevention\n\nReact prevents starvation by marking lanes as expired after they wait too long:\n\n```mermaid\ngraph LR\n    Check["markStarvedLanesAsExpired()"]\n    Check --> CurrentTime["now()"]\n    CurrentTime --> Compare{"For each pending lane"}\n    \n    Compare --> CheckTime{"expirationTime > 0<br/>&& expirationTime <= currentTime?"}\n    CheckTime -->|"Yes"| MarkExpired["expiredLanes |= lane"]\n    CheckTime -->|"No"| CheckExist{"expirationTime === NoTimestamp?"}\n    \n    CheckExist -->|"Yes"| SetExpire["Set expirationTime =<br/>currentTime + timeout"]\n    CheckExist -->|"No"| Continue["Continue to next lane"]\n    \n    MarkExpired --> Continue\n    SetExpire --> Continue\n```\n\n**Diagram: Expiration Marking Process**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:789-843]()\n\n### Timeout Values\n\n| Lane Type | Timeout (ms) | Constant |\n|-----------|--------------|----------|\n| Sync lanes | 250 | `syncLaneExpirationMs` |\n| Transition lanes | 5000 | `transitionLaneExpirationMs` |\n| Retry lanes | 5000 | `retryLaneExpirationMs` |\n\nSources: [packages/shared/ReactFeatureFlags.js]() (referenced in [packages/react-reconciler/src/ReactFiberLane.js:22-28]())\n\n## Transitions and Deferred Updates\n\n### Transition Lane Characteristics\n\nTransitions use a dedicated pool of 16 lanes with special properties:\n\n1. **Interruptible**: Can be interrupted by higher-priority updates\n2. **Deferrable**: Use `useDeferredValue` to defer derived values\n3. **Suspense-aware**: Show loading states for longer waits\n4. **Batched**: Multiple transitions can be in flight simultaneously\n\n```mermaid\ngraph TD\n    StartTransition["startTransition(callback)"]\n    StartTransition --> SetTransition["Set ReactSharedInternals.T = {transition object}"]\n    SetTransition --> Callback["Execute callback()"]\n    \n    Callback --> SetState["setState() called"]\n    SetState --> RequestLane["requestUpdateLane(fiber)"]\n    RequestLane --> CheckTransition{"ReactSharedInternals.T !== null?"}\n    CheckTransition -->|"Yes"| ClaimLane["claimNextTransitionLane()"]\n    CheckTransition -->|"No"| EventLane["eventPriorityToLane()"]\n    \n    ClaimLane --> TransitionWork["Schedule as TransitionLane"]\n    EventLane --> NormalWork["Schedule as normal lane"]\n```\n\n**Diagram: Transition Update Flow**\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:824-843](), [packages/react-reconciler/src/ReactFiberRootScheduler.js:206-271]()\n\n### Deferred Lane Allocation\n\nThe `requestDeferredLane()` function allocates lanes for `useDeferredValue`:\n\n```\nrequestDeferredLane(): Lane\n   Check if already allocated: workInProgressDeferredLane\n   If prerendering: return OffscreenLane\n   Otherwise: claimNextTransitionDeferredLane()\n   Mark Suspense boundary with DidDefer flag\n```\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:863-900]()\n\n## Concurrent Rendering and Preemption\n\nThe scheduler checks if work should yield based on lane priority:\n\n```mermaid\ngraph TD\n    Rendering["Rendering fiber tree"]\n    Rendering --> CheckYield{"shouldYield()?"}\n    \n    CheckYield -->|"No"| Continue["Continue rendering"]\n    CheckYield -->|"Yes"| CheckInterrupt{"Higher priority work?"}\n    \n    CheckInterrupt -->|"Yes"| Interrupt["Interrupt render<br/>Return to work loop"]\n    CheckInterrupt -->|"No"| YieldTime["Yield to browser<br/>Resume later"]\n    \n    Continue --> NextUnit["workLoopConcurrent()"]\n    Interrupt --> Schedule["ensureRootIsScheduled()"]\n    YieldTime --> Schedule\n    \n    Schedule --> NextRender["Restart with new lanes"]\n```\n\n**Diagram: Concurrent Rendering Preemption**\n\nWhen higher-priority lanes arrive during a concurrent render, React interrupts the current work and restarts with the higher priority lanes.\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:2210-2276]()\n\n## Event Priority to Lane Mapping\n\nEvents are classified by priority and mapped to lanes:\n\n```mermaid\ngraph LR\n    subgraph Events["Event Types"]\n        Discrete["Discrete<br/>(click, keypress)"]\n        Continuous["Continuous<br/>(drag, scroll)"]\n        Default["Default<br/>(network, timers)"]\n        Idle["Idle<br/>(analytics)"]\n    end\n    \n    subgraph Priorities["Event Priorities"]\n        DiscretePri["DiscreteEventPriority"]\n        ContinuousPri["ContinuousEventPriority"]\n        DefaultPri["DefaultEventPriority"]\n        IdlePri["IdleEventPriority"]\n    end\n    \n    subgraph Lanes["Lanes"]\n        SyncL["SyncLane"]\n        InputL["InputContinuousLane"]\n        DefaultL["DefaultLane"]\n        IdleL["IdleLane"]\n    end\n    \n    Discrete --> DiscretePri\n    Continuous --> ContinuousPri\n    Default --> DefaultPri\n    Idle --> IdlePri\n    \n    DiscretePri --> SyncL\n    ContinuousPri --> InputL\n    DefaultPri --> DefaultL\n    IdlePri --> IdleL\n```\n\n**Diagram: Event to Lane Priority Mapping**\n\nSources: [packages/react-reconciler/src/ReactEventPriorities.js:14-83](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:846]()\n\n## Lane Debugging and Introspection\n\nFor development and profiling, lanes can be converted to human-readable labels:\n\n| Function | Purpose |\n|----------|---------|\n| `getLabelForLane(lane)` | Returns string label like "Sync", "Transition", "Retry" |\n| `getGroupNameOfHighestPriorityLane(lanes)` | Returns priority group: "Blocking", "Transition", "Idle" |\n| `checkIfRootIsPrerendering(root)` | Checks if root is prerendering (OffscreenLane) |\n\nThese functions are used by React DevTools and performance tracking to display which priority level is being worked on.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:1287-1412]()\n\n## Implementation Details\n\n### Key Data Structures\n\n**FiberRoot Lane Fields:**\n```\ntype FiberRoot = {\n  pendingLanes: Lanes,              // All scheduled work\n  suspendedLanes: Lanes,            // Work blocked on Suspense\n  pingedLanes: Lanes,               // Suspense resolved, ready to retry\n  expiredLanes: Lanes,              // Expired (must complete)\n  finishedLanes: Lanes,             // Just committed\n  entangledLanes: Lanes,            // Must render together\n  entanglements: LaneMap<Lanes>,    // Per-lane entanglements\n  expirationTimes: LaneMap<number>, // Expiration timestamps\n  hiddenUpdates: LaneMap<Array<ConcurrentUpdate>>, // Offscreen updates\n  ...\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberRoot.js:87-173]()\n\n### Critical Functions Reference\n\n| Function | Location | Purpose |\n|----------|----------|---------|\n| `getNextLanes()` | [ReactFiberLane.js:544-697]() | Select next lanes to render |\n| `requestUpdateLane()` | [ReactFiberWorkLoop.js:803-847]() | Determine lane for update |\n| `markRootUpdated()` | [ReactFiberLane.js:845-877]() | Mark new work on root |\n| `markRootSuspended()` | [ReactFiberLane.js:879-917]() | Mark lanes as suspended |\n| `markRootPinged()` | [ReactFiberLane.js:919-949]() | Mark suspended lanes ready |\n| `markStarvedLanesAsExpired()` | [ReactFiberLane.js:789-843]() | Expire starved lanes |\n| `includesBlockingLane()` | [ReactFiberLane.js:244-246]() | Check for blocking work |\n| `claimNextTransitionLane()` | [ReactFiberRootScheduler.js:253-271]() | Allocate transition lane |\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:1-1412](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1-3095]()\n\n---\n\n# Page: Suspense and Error Boundaries\n\n# Suspense and Error Boundaries\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberOffscreenComponent.js](packages/react-reconciler/src/ReactFiberOffscreenComponent.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes how React handles asynchronous operations and errors during rendering through two key mechanisms: **Suspense boundaries** and **Error boundaries**. Suspense boundaries enable components to declaratively wait for asynchronous data by catching thrown promises and rendering fallback UI. Error boundaries catch JavaScript errors anywhere in their child component tree and display fallback UI instead of crashing the entire application.\n\nFor information about hydration of server-rendered Suspense boundaries, see [Hydration System](#6.3). For details on how Suspense integrates with Server Components and streaming SSR, see [React Fizz (Streaming SSR)](#5.1).\n\n---\n\n## Overview: Two Boundary Types\n\nReact provides two types of boundaries that interrupt normal rendering flow:\n\n| Boundary Type | Catches | Defined By | Triggers |\n|--------------|---------|------------|----------|\n| **Suspense Boundary** | Thrown promises (async operations) | `<Suspense>` component with `fallback` prop | Components throw promises during render |\n| **Error Boundary** | JavaScript errors | Class components with `componentDidCatch` or `getDerivedStateFromError` | Errors thrown during render, lifecycle methods, or event handlers |\n\nBoth boundaries share similar mechanics for capturing exceptions during render phase and unwinding the fiber tree, but differ in what they catch and how they recover.\n\nSources: [packages/react-reconciler/src/ReactFiberBeginWork.js:1-100](), [packages/react-reconciler/src/ReactFiberClassComponent.js:1-50]()\n\n---\n\n## Suspense Boundaries\n\n### Suspense Component Structure\n\nA Suspense boundary is created using the `<Suspense>` component which accepts `fallback` and `children` props:\n\n```javascript\n<Suspense fallback={<LoadingSpinner />}>\n  <AsyncComponent />\n</Suspense>\n```\n\nInternally, Suspense is represented by the `SuspenseComponent` work tag and maintains state via `SuspenseState`:\n\n```typescript\ntype SuspenseState = {\n  dehydrated: null | SuspenseInstance,  // Non-null if SSR dehydrated\n  retryLane: Lane,                       // Lane to retry rendering\n  treeContext: TreeContext | null,       // Tree context for hydration\n  ...\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberSuspenseComponent.js:24-36](), [packages/react-reconciler/src/ReactWorkTags.js:70]()\n\n### How Suspense Works\n\n```mermaid\ngraph TB\n    Render["Component Render<br/>(beginWork)"]\n    ThrowPromise["Throw Promise<br/>Component suspends"]\n    ThrowException["throwException()<br/>ReactFiberThrow"]\n    FindBoundary["Find Suspense Boundary<br/>Walk up fiber tree"]\n    SetFlags["Set ShouldCapture flag<br/>on boundary fiber"]\n    Unwind["unwindWork()<br/>Pop contexts"]\n    ReRender["Re-render boundary<br/>with fallback"]\n    ShowFallback["Display fallback UI"]\n    PromiseResolve["Promise resolves"]\n    Ping["Ping boundary<br/>scheduleUpdateOnFiber"]\n    RetryRender["Retry with RetryLane<br/>Render children again"]\n    ShowContent["Display content"]\n    \n    Render --> ThrowPromise\n    ThrowPromise --> ThrowException\n    ThrowException --> FindBoundary\n    FindBoundary --> SetFlags\n    SetFlags --> Unwind\n    Unwind --> ReRender\n    ReRender --> ShowFallback\n    ShowFallback --> PromiseResolve\n    PromiseResolve --> Ping\n    Ping --> RetryRender\n    RetryRender --> ShowContent\n```\n\n**Suspense Flow Steps:**\n\n1. **Component Throws Promise**: During render, a component reads async data and throws a promise if data isn\'t ready\n2. **Catch in Work Loop**: The work loop catches the thrown value in `handleThrow` ([packages/react-reconciler/src/ReactFiberWorkLoop.js:1800-1900]())\n3. **throwException**: Identifies what was thrown and finds the nearest Suspense boundary ([packages/react-reconciler/src/ReactFiberThrow.js:1-100]())\n4. **Mark Boundary**: Sets `ShouldCapture` flag on the Suspense boundary fiber ([packages/react-reconciler/src/ReactFiberBeginWork.js:3800-3900]())\n5. **Unwind Stack**: Unwinds the fiber tree via `unwindWork`, popping contexts and checking each fiber for `ShouldCapture` ([packages/react-reconciler/src/ReactFiberUnwindWork.js:156-183]())\n6. **Convert to DidCapture**: When unwinding reaches the Suspense boundary, converts `ShouldCapture` to `DidCapture` flag ([packages/react-reconciler/src/ReactFiberUnwindWork.js:170-180]())\n7. **Re-render with Fallback**: Re-renders the Suspense boundary which now shows fallback instead of children ([packages/react-reconciler/src/ReactFiberBeginWork.js:3800-4000]())\n8. **Attach Listener**: Attaches a ping listener to the thrown promise via `attachPingListener` ([packages/react-reconciler/src/ReactFiberThrow.js:400-500]())\n9. **Promise Resolves**: When the promise resolves, the ping callback triggers `retryDehydratedSuspenseBoundary` or schedules an update\n10. **Retry Render**: Re-renders at a retry lane, attempting to render children again ([packages/react-reconciler/src/ReactFiberWorkLoop.js:2000-2100]())\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1800-2000](), [packages/react-reconciler/src/ReactFiberThrow.js:1-500](), [packages/react-reconciler/src/ReactFiberUnwindWork.js:156-183]()\n\n### Suspense Context and Handler Stack\n\nReact maintains a `SuspenseContext` stack to track which Suspense boundaries are active during rendering:\n\n```mermaid\ngraph TB\n    subgraph "Suspense Context Stack"\n        Root["Root (no handler)"]\n        Outer["Outer Suspense Boundary<br/>pushPrimaryTreeSuspenseHandler"]\n        Inner["Inner Suspense Boundary<br/>pushPrimaryTreeSuspenseHandler"]\n    end\n    \n    GetHandler["getSuspenseHandler()<br/>Returns current boundary"]\n    Component["Component throws promise"]\n    FindBoundary["throwException finds handler<br/>via getSuspenseHandler()"]\n    \n    Root --> Outer\n    Outer --> Inner\n    Inner -.-> GetHandler\n    Component --> FindBoundary\n    FindBoundary -.-> GetHandler\n```\n\nKey functions for managing Suspense context:\n\n- `pushPrimaryTreeSuspenseHandler(workInProgress)` - Pushes a new Suspense boundary onto the stack ([packages/react-reconciler/src/ReactFiberSuspenseContext.js:100-150]())\n- `pushFallbackTreeSuspenseHandler(workInProgress)` - Pushes when rendering fallback tree\n- `popSuspenseHandler(workInProgress)` - Pops the handler when leaving a Suspense boundary\n- `getSuspenseHandler()` - Returns the current innermost Suspense boundary ([packages/react-reconciler/src/ReactFiberSuspenseContext.js:200-250]())\n\nSources: [packages/react-reconciler/src/ReactFiberSuspenseContext.js:1-300](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3700-3800]()\n\n### Retry Mechanism and Lanes\n\nWhen a promise resolves, React needs to retry rendering the suspended tree. This is managed via **retry lanes**:\n\n```mermaid\ngraph LR\n    Suspend["Component Suspends<br/>Shows fallback"]\n    AttachPing["Attach ping listener<br/>to promise"]\n    PromiseResolve["Promise resolves"]\n    PingCallback["pingCallback invoked"]\n    ClaimRetryLane["claimNextRetryLane()<br/>Assigns RetryLane"]\n    ScheduleUpdate["scheduleUpdateOnFiber<br/>with RetryLane"]\n    RenderRoot["performWorkOnRoot<br/>renders at RetryLane"]\n    AttemptRender["Attempt to render<br/>children again"]\n    \n    Suspend --> AttachPing\n    AttachPing --> PromiseResolve\n    PromiseResolve --> PingCallback\n    PingCallback --> ClaimRetryLane\n    ClaimRetryLane --> ScheduleUpdate\n    ScheduleUpdate --> RenderRoot\n    RenderRoot --> AttemptRender\n```\n\n**Key components:**\n\n- `RetryQueue`: Stored on `workInProgress.updateQueue` for Suspense boundaries, contains `Wakeable` (promises) being tracked ([packages/react-reconciler/src/ReactFiberSuspenseComponent.js:100-120]())\n- `claimNextRetryLane()`: Assigns a specific retry lane from the `RetryLanes` bitmask ([packages/react-reconciler/src/ReactFiberLane.js:850-900]())\n- `attachPingListener()`: Attaches callback to promise that will schedule an update when resolved ([packages/react-reconciler/src/ReactFiberThrow.js:400-500]())\n- `retryDehydratedSuspenseBoundary()`: Schedules a retry for dehydrated boundaries ([packages/react-reconciler/src/ReactFiberWorkLoop.js:1200-1300]())\n\nSources: [packages/react-reconciler/src/ReactFiberSuspenseComponent.js:100-150](), [packages/react-reconciler/src/ReactFiberLane.js:850-900](), [packages/react-reconciler/src/ReactFiberThrow.js:400-500]()\n\n### Suspended Reasons\n\nThe work loop tracks why rendering is suspended via `workInProgressSuspendedReason`:\n\n| Reason | Value | Description |\n|--------|-------|-------------|\n| `NotSuspended` | 0 | Not currently suspended |\n| `SuspendedOnError` | 1 | Suspended due to an error |\n| `SuspendedOnData` | 2 | Suspended waiting for data (promise) |\n| `SuspendedOnImmediate` | 3 | Suspended on immediate priority |\n| `SuspendedOnInstance` | 4 | Suspended on resource instance |\n| `SuspendedOnInstanceAndReadyToContinue` | 5 | Instance ready, can continue |\n| `SuspendedOnDeprecatedThrowPromise` | 6 | Legacy throw promise |\n| `SuspendedAndReadyToContinue` | 7 | Suspended but ready to continue |\n| `SuspendedOnHydration` | 8 | Suspended during hydration |\n| `SuspendedOnAction` | 9 | Suspended on async action |\n\nThese reasons determine how the work loop handles the suspension and whether to unwind immediately or continue.\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:431-441]()\n\n---\n\n## Error Boundaries\n\n### Defining Error Boundaries\n\nError boundaries are class components that implement one or both of these lifecycle methods:\n\n```javascript\nclass ErrorBoundary extends React.Component {\n  static getDerivedStateFromError(error) {\n    // Update state to show fallback UI\n    return { hasError: true };\n  }\n\n  componentDidCatch(error, errorInfo) {\n    // Log error to error reporting service\n    logErrorToService(error, errorInfo);\n  }\n\n  render() {\n    if (this.state.hasError) {\n      return <h1>Something went wrong.</h1>;\n    }\n    return this.props.children;\n  }\n}\n```\n\n**Key characteristics:**\n- Must be class components (function components cannot be error boundaries)\n- `getDerivedStateFromError`: Static method called during render phase to update state\n- `componentDidCatch`: Instance method called during commit phase for side effects\n- Only catches errors in child components, not in the boundary itself\n\nSources: [packages/react-reconciler/src/ReactFiberClassComponent.js:1-100]()\n\n### Error Capture Flow\n\n```mermaid\ngraph TB\n    Render["Component Render"]\n    ThrowError["Error thrown"]\n    Catch["Work loop catches error<br/>handleThrow()"]\n    ThrowException["throwException()<br/>Classify error"]\n    WalkTree["Walk up fiber tree<br/>Find error boundary"]\n    FindBoundary{"Class with error<br/>lifecycle methods?"}\n    CreateUpdate["createClassErrorUpdate()<br/>Create error update"]\n    SetFlags["Set ShouldCapture flag<br/>on boundary"]\n    Unwind["unwindWork()<br/>Unwind to boundary"]\n    ConvertFlag["Convert ShouldCapture<br/>to DidCapture"]\n    ApplyUpdate["Process update queue<br/>Call getDerivedStateFromError"]\n    ReRender["Re-render boundary<br/>Shows fallback UI"]\n    CommitPhase["Commit phase"]\n    CallDidCatch["Call componentDidCatch<br/>with error info"]\n    \n    Render --> ThrowError\n    ThrowError --> Catch\n    Catch --> ThrowException\n    ThrowException --> WalkTree\n    WalkTree --> FindBoundary\n    FindBoundary -->|Yes| CreateUpdate\n    FindBoundary -->|No| WalkTree\n    CreateUpdate --> SetFlags\n    SetFlags --> Unwind\n    Unwind --> ConvertFlag\n    ConvertFlag --> ApplyUpdate\n    ApplyUpdate --> ReRender\n    ReRender --> CommitPhase\n    CommitPhase --> CallDidCatch\n```\n\n**Error Boundary Flow:**\n\n1. **Error Occurs**: An error is thrown during render, lifecycle method, or event handler\n2. **Catch in Work Loop**: The work loop catches the error in `handleThrow` ([packages/react-reconciler/src/ReactFiberWorkLoop.js:1800-1900]())\n3. **throwException**: Examines the error and walks up the fiber tree to find an error boundary ([packages/react-reconciler/src/ReactFiberThrow.js:200-400]())\n4. **Identify Boundary**: Looks for class components with `getDerivedStateFromError` or `componentDidCatch` ([packages/react-reconciler/src/ReactFiberThrow.js:250-350]())\n5. **Create Error Update**: Calls `createClassErrorUpdate` to create an update on the boundary\'s queue ([packages/react-reconciler/src/ReactFiberThrow.js:300-350]())\n6. **Set ShouldCapture**: Marks the error boundary fiber with `ShouldCapture` flag\n7. **Unwind**: Unwinds the stack via `unwindWork`, checking each fiber for `ShouldCapture` ([packages/react-reconciler/src/ReactFiberUnwindWork.js:77-93]())\n8. **Convert to DidCapture**: When unwinding reaches the error boundary, converts `ShouldCapture` to `DidCapture` ([packages/react-reconciler/src/ReactFiberUnwindWork.js:83-91]())\n9. **Process Update**: During re-render, processes the error update and calls `getDerivedStateFromError` ([packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:200-300]())\n10. **Render Fallback**: Re-renders the boundary with updated state showing fallback UI\n11. **Commit Phase**: During commit, calls `componentDidCatch` with error and error info ([packages/react-reconciler/src/ReactFiberCommitWork.js:1000-1100]())\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1800-1900](), [packages/react-reconciler/src/ReactFiberThrow.js:200-400](), [packages/react-reconciler/src/ReactFiberUnwindWork.js:77-93]()\n\n### Error Boundary Detection\n\nError boundaries are identified by checking for specific static and instance methods:\n\n```mermaid\ngraph LR\n    Fiber["Class Component Fiber"]\n    CheckType["Check ctor.getDerivedStateFromError"]\n    CheckInstance["Check instance.componentDidCatch"]\n    IsErrorBoundary{"Has error<br/>lifecycle?"}\n    Capture["Can capture errors"]\n    Skip["Skip, not error boundary"]\n    \n    Fiber --> CheckType\n    CheckType --> IsErrorBoundary\n    CheckInstance --> IsErrorBoundary\n    IsErrorBoundary -->|Yes| Capture\n    IsErrorBoundary -->|No| Skip\n```\n\nCode logic in `throwException`:\n\n```javascript\n// Check if this is a class component error boundary\nif (\n  sourceFiber.tag === ClassComponent &&\n  (ctor.getDerivedStateFromError !== undefined ||\n   (instance !== null && \n    typeof instance.componentDidCatch === \'function\'))\n) {\n  // This is an error boundary\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberThrow.js:250-350]()\n\n---\n\n## Throwing and Capturing Mechanism\n\n### throwException Function\n\nThe `throwException` function in `ReactFiberThrow.js` is the central dispatcher that handles both promises (Suspense) and errors (Error Boundaries):\n\n```mermaid\ngraph TB\n    ThrowException["throwException(root, returnFiber, sourceFiber, value)"]\n    CheckValue{"Check value type"}\n    IsPromise["Is Wakeable/Promise?"]\n    IsError["Is Error?"]\n    IsSuspenseException["Is SuspenseException?"]\n    HandleSuspense["Handle Suspense<br/>Find Suspense boundary<br/>Attach ping listener"]\n    HandleError["Handle Error<br/>Find Error boundary<br/>Create error update"]\n    HandleSpecial["Handle SuspenseException<br/>Special suspension handling"]\n    SetFlags["Set ShouldCapture flags<br/>on boundaries"]\n    \n    ThrowException --> CheckValue\n    CheckValue --> IsPromise\n    CheckValue --> IsError\n    CheckValue --> IsSuspenseException\n    IsPromise --> HandleSuspense\n    IsError --> HandleError\n    IsSuspenseException --> HandleSpecial\n    HandleSuspense --> SetFlags\n    HandleError --> SetFlags\n    HandleSpecial --> SetFlags\n```\n\n**Key responsibilities:**\n\n1. **Type Detection**: Determines whether the thrown value is a promise, error, or special exception type\n2. **Boundary Search**: Walks up the fiber tree from `sourceFiber` to find appropriate boundary\n3. **Flag Setting**: Marks boundaries with `ShouldCapture` flag to trigger unwinding\n4. **Listener Attachment**: For promises, attaches ping listeners for retry when resolved\n5. **Update Creation**: For errors, creates updates on error boundary components\n\nSources: [packages/react-reconciler/src/ReactFiberThrow.js:1-600]()\n\n### Fiber Flags for Capture\n\nReact uses specific flags to coordinate the capture and unwinding process:\n\n| Flag | Value | Description |\n|------|-------|-------------|\n| `ShouldCapture` | Bit flag | Marks that a fiber should capture an error/suspense |\n| `DidCapture` | Bit flag | Marks that a fiber has captured and is showing fallback |\n| `ForceClientRender` | Bit flag | Forces client-side render (hydration failure) |\n\n**Flag transitions during unwinding:**\n\n```mermaid\nstateDiagram-v2\n    [*] --> NoFlags: Normal render\n    NoFlags --> ShouldCapture: Error/Suspense thrown\n    ShouldCapture --> DidCapture: Unwinding reaches boundary\n    DidCapture --> NoFlags: Retry/recovery\n    ShouldCapture --> NoFlags: Unwinding complete (no capture)\n```\n\nThe `unwindWork` function checks and transforms these flags:\n\n```javascript\nconst flags = workInProgress.flags;\nif (flags & ShouldCapture) {\n  workInProgress.flags = (flags & ~ShouldCapture) | DidCapture;\n  // Return this fiber to re-render with fallback\n  return workInProgress;\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberFlags.js:1-200](), [packages/react-reconciler/src/ReactFiberUnwindWork.js:66-200]()\n\n### Unwinding the Fiber Tree\n\nWhen an error or promise is caught, React must unwind the fiber tree to the nearest boundary. The `unwindWork` function handles this:\n\n```mermaid\ngraph TB\n    ThrowCaught["Exception caught in work loop"]\n    StartUnwind["Begin unwinding"]\n    CheckFiber["Process current fiber<br/>unwindWork()"]\n    PopContexts["Pop contexts<br/>(Host, Suspense, etc.)"]\n    CheckFlags{"Has ShouldCapture<br/>flag?"}\n    ConvertFlags["Convert to DidCapture<br/>Return fiber"]\n    MoveUp["Move to parent fiber<br/>workInProgress.return"]\n    ReachedRoot{"Reached root?"}\n    HandleRootError["Handle uncaught error<br/>at root level"]\n    ReRenderBoundary["Re-render boundary<br/>with fallback"]\n    \n    ThrowCaught --> StartUnwind\n    StartUnwind --> CheckFiber\n    CheckFiber --> PopContexts\n    PopContexts --> CheckFlags\n    CheckFlags -->|Yes| ConvertFlags\n    CheckFlags -->|No| MoveUp\n    ConvertFlags --> ReRenderBoundary\n    MoveUp --> ReachedRoot\n    ReachedRoot -->|No| CheckFiber\n    ReachedRoot -->|Yes| HandleRootError\n```\n\nKey operations during unwinding:\n\n1. **Pop Contexts**: Each fiber type pops its associated contexts (host context, suspense context, cache context, etc.)\n2. **Check Capture Flag**: Examines whether `ShouldCapture` flag is set\n3. **Transform Flag**: Converts `ShouldCapture` to `DidCapture` for boundaries that will handle the exception\n4. **Transfer Duration**: For profiling, transfers actual duration to parent if in profile mode\n5. **Return Fiber**: Returns the boundary fiber to re-render, or null to continue unwinding\n\nThe `unwindWork` function is called for each fiber type during unwinding:\n\n- **ClassComponent**: Pops legacy context if context provider ([packages/react-reconciler/src/ReactFiberUnwindWork.js:77-93]())\n- **HostRoot**: Pops all root-level contexts ([packages/react-reconciler/src/ReactFiberUnwindWork.js:95-118]())\n- **SuspenseComponent**: Pops suspense handler and checks for dehydrated boundaries ([packages/react-reconciler/src/ReactFiberUnwindWork.js:156-183]())\n- **SuspenseListComponent**: Pops suspense list context ([packages/react-reconciler/src/ReactFiberUnwindWork.js:184-194]())\n\nSources: [packages/react-reconciler/src/ReactFiberUnwindWork.js:66-250]()\n\n---\n\n## Integration with Work Loop\n\n### Handling Throws in performWorkOnRoot\n\nThe main work loop integrates error and suspense handling via `handleThrow`:\n\n```mermaid\ngraph TB\n    PerformWork["performWorkOnRoot(root, lanes)"]\n    PrepareFresh["prepareFreshStack(root, lanes)"]\n    WorkLoop["workLoopSync() or<br/>workLoopConcurrent()"]\n    BeginWork["beginWork(current, workInProgress, lanes)"]\n    ThrowOccurs["Exception thrown"]\n    CatchBlock["try/catch block"]\n    HandleThrow["handleThrow(root, thrownValue)"]\n    ClassifyError["Classify thrown value<br/>Error vs Promise vs Special"]\n    ThrowException["throwException(root, returnFiber,<br/>sourceFiber, thrownValue)"]\n    UnwindLoop["Start unwinding loop"]\n    CompleteUnitOfWork["completeUnitOfWork() or<br/>continue work loop"]\n    \n    PerformWork --> PrepareFresh\n    PrepareFresh --> WorkLoop\n    WorkLoop --> BeginWork\n    BeginWork --> ThrowOccurs\n    ThrowOccurs --> CatchBlock\n    CatchBlock --> HandleThrow\n    HandleThrow --> ClassifyError\n    ClassifyError --> ThrowException\n    ThrowException --> UnwindLoop\n    UnwindLoop --> CompleteUnitOfWork\n```\n\nThe work loop wraps rendering in try/catch:\n\n```javascript\ndo {\n  try {\n    workLoopSync(); // or workLoopConcurrent()\n    break;\n  } catch (thrownValue) {\n    handleThrow(root, thrownValue);\n  }\n} while (true);\n```\n\nThe `handleThrow` function:\n\n1. Sets `workInProgressSuspendedReason` based on thrown value type\n2. Stores `workInProgressThrownValue` for later processing\n3. Calls `throwException` to find and mark boundaries\n4. Initiates the unwinding process\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1700-2000]()\n\n### Retry and Ping Mechanism\n\nWhen a suspended boundary is ready to retry (promise resolved), React uses the ping mechanism:\n\n```mermaid\nsequenceDiagram\n    participant C as Component\n    participant P as Promise\n    participant L as Ping Listener\n    participant S as Scheduler\n    participant WL as Work Loop\n    participant B as Suspense Boundary\n    \n    C->>P: Throw promise\n    WL->>P: Attach ping listener\n    Note over P,L: attachPingListener(root, wakeable, lanes)\n    P->>P: Promise resolves\n    P->>L: Call ping callback\n    L->>S: scheduleUpdateOnFiber(root, fiber, lane)\n    S->>WL: Schedule work at RetryLane\n    WL->>B: Re-render boundary\n    B->>C: Retry rendering component\n    C->>C: Data available, render succeeds\n```\n\n**Ping callback implementation:**\n\n```javascript\nfunction attachPingListener(root, wakeable, lanes) {\n  let pingCache = root.pingCache;\n  let threadIDs;\n  if (pingCache === null) {\n    pingCache = root.pingCache = new PossiblyWeakMap();\n    threadIDs = new Set();\n    pingCache.set(wakeable, threadIDs);\n  } else {\n    threadIDs = pingCache.get(wakeable);\n    if (threadIDs === undefined) {\n      threadIDs = new Set();\n      pingCache.set(wakeable, threadIDs);\n    }\n  }\n  \n  if (!threadIDs.has(lanes)) {\n    threadIDs.add(lanes);\n    let ping = pingSuspendedRoot.bind(null, root, wakeable, lanes);\n    wakeable.then(ping, ping);\n  }\n}\n```\n\nThe `pingSuspendedRoot` callback schedules an update at the retry lane, triggering a re-render of the suspended tree.\n\nSources: [packages/react-reconciler/src/ReactFiberThrow.js:400-500](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1000-1100]()\n\n---\n\n## Dehydrated Suspense Boundaries\n\nDuring Server-Side Rendering (SSR), Suspense boundaries can be rendered in a "dehydrated" state where the server sends placeholder markers instead of waiting for all async data. The client then "hydrates" these boundaries by matching them with real DOM nodes.\n\n### Dehydrated State Structure\n\n```mermaid\ngraph TB\n    subgraph "Server-Rendered HTML"\n        Comment1["<!-- $? --> Start marker"]\n        Fallback["Fallback UI (initially hidden)"]\n        Comment2["<!-- /$? --> End marker"]\n    end\n    \n    subgraph "SuspenseState"\n        Dehydrated["dehydrated: SuspenseInstance"]\n        RetryLane["retryLane: Lane"]\n        TreeContext["treeContext: TreeContext"]\n    end\n    \n    Comment1 -.-> Dehydrated\n    Comment2 -.-> Dehydrated\n    Dehydrated --> RetryLane\n    Dehydrated --> TreeContext\n```\n\n**Key functions for dehydrated boundaries:**\n\n- `isSuspenseInstancePending(instance)`: Checks if dehydrated boundary is still waiting\n- `isSuspenseInstanceFallback(instance)`: Checks if showing fallback\n- `reenterHydrationStateFromDehydratedSuspenseInstance()`: Re-enters hydration mode for dehydrated content ([packages/react-reconciler/src/ReactFiberHydrationContext.js:400-500]())\n\nDuring hydration, when React encounters a dehydrated Suspense boundary:\n\n1. **Detect Marker**: Identifies the `<!-- $? -->` comment marker in the DOM\n2. **Store Instance**: Stores the `SuspenseInstance` in `SuspenseState.dehydrated`\n3. **Skip Children**: Skips hydrating children initially (they\'re not yet in the DOM)\n4. **Wait for Data**: Waits for server to stream the actual content\n5. **Hydrate on Arrival**: When content arrives, hydrates the real DOM nodes\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:1-500](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3900-4100]()\n\n---\n\n## Error Boundary Lifecycle Methods\n\n### getDerivedStateFromError\n\nStatic method called during the render phase to update state in response to an error:\n\n```javascript\nstatic getDerivedStateFromError(error: Error): PartialState {\n  return { hasError: true, error };\n}\n```\n\n**Characteristics:**\n- Called during render phase (can be called multiple times)\n- Must be pure and have no side effects\n- Returns state update or null\n- Called before `componentDidCatch`\n\n**Processing in update queue:**\n\nWhen an error is caught, React creates an error update with tag `CaptureUpdate`:\n\n```javascript\nfunction createClassErrorUpdate(fiber, errorInfo, lane) {\n  const update = createUpdate(lane);\n  update.tag = CaptureUpdate;\n  update.payload = {element: null};\n  \n  const error = errorInfo.value;\n  update.callback = function() {\n    // This will be called after getDerivedStateFromError\n    onUncaughtError(error);\n  };\n  return update;\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberThrow.js:100-200](), [packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:100-200]()\n\n### componentDidCatch\n\nInstance method called during the commit phase for side effects:\n\n```javascript\ncomponentDidCatch(error: Error, errorInfo: {componentStack: string}) {\n  // Side effects like logging\n  logErrorToMyService(error, errorInfo);\n}\n```\n\n**Characteristics:**\n- Called during commit phase (effects phase)\n- Can have side effects (logging, analytics, etc.)\n- Receives error and errorInfo with component stack\n- Called after render is committed\n- Not called if boundary is unmounting\n\n**Invocation during commit:**\n\n```javascript\nfunction commitClassLifecycles(finishedWork, current) {\n  const instance = finishedWork.stateNode;\n  if (finishedWork.flags & DidCapture) {\n    // Error was caught, call componentDidCatch\n    if (typeof instance.componentDidCatch === \'function\') {\n      const error = /* error from update queue */;\n      const errorInfo = createCapturedValueFromError(error);\n      instance.componentDidCatch(error, errorInfo);\n    }\n  }\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberCommitWork.js:800-1000](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:200-400]()\n\n---\n\n## Advanced: Multiple Nested Boundaries\n\nReact can have multiple nested Suspense boundaries and error boundaries, each catching exceptions at different levels:\n\n```mermaid\ngraph TB\n    Root["Root"]\n    ErrorBoundary["Error Boundary"]\n    OuterSuspense["Outer Suspense"]\n    InnerSuspense["Inner Suspense"]\n    Component["Component"]\n    \n    Root --> ErrorBoundary\n    ErrorBoundary --> OuterSuspense\n    OuterSuspense --> InnerSuspense\n    InnerSuspense --> Component\n    \n    Component -.->|Throws promise| InnerSuspense\n    Component -.->|Throws error| ErrorBoundary\n    InnerSuspense -.->|If suspends| OuterSuspense\n```\n\n**Boundary selection rules:**\n\n1. **Innermost First**: Always captures at the nearest boundary\n2. **Type Matters**: Suspense catches promises, Error Boundaries catch errors\n3. **Fallback Hiding**: Outer boundaries can hide inner boundaries\' fallback if outer also suspends\n4. **Throttling**: React throttles showing multiple fallbacks to avoid UI flickering ([packages/react-reconciler/src/ReactFiberWorkLoop.js:500-520]())\n\n### Suspense List Coordination\n\n`<SuspenseList>` coordinates the reveal order of multiple Suspense boundaries:\n\n```javascript\n<SuspenseList revealOrder="forwards">\n  <Suspense fallback={<Spinner />}>\n    <Item1 />\n  </Suspense>\n  <Suspense fallback={<Spinner />}>\n    <Item2 />\n  </Suspense>\n  <Suspense fallback={<Spinner />}>\n    <Item3 />\n  </Suspense>\n</SuspenseList>\n```\n\nThe `SuspenseListComponent` maintains `SuspenseListRenderState` to track which children are suspended and control reveal order.\n\nSources: [packages/react-reconciler/src/ReactFiberSuspenseComponent.js:150-250](), [packages/react-reconciler/src/ReactFiberBeginWork.js:4100-4300]()\n\n---\n\n## Performance Considerations\n\n### Fallback Throttling\n\nTo prevent UI flickering from rapid fallback showing/hiding, React implements throttling:\n\n```javascript\nconst FALLBACK_THROTTLE_MS = 300;\n```\n\nIf a Suspense boundary suspends, React waits 300ms before showing the fallback, hoping the promise will resolve quickly.\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:514]()\n\n### Retry Lane Priority\n\nRetry lanes are lower priority than user-blocking updates but higher than idle work:\n\n```javascript\nconst RetryLanes = 0b0000011110000000000000000000000;\n```\n\nThis ensures retries happen promptly but don\'t block urgent user interactions.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:93-99]()\n\n### Error Boundary Re-render Optimization\n\nAfter catching an error, React skips rendering the error boundary\'s children and goes straight to the fallback, avoiding wasted work.\n\nSources: [packages/react-reconciler/src/ReactFiberBeginWork.js:1200-1300]()\n\n---\n\n# Page: Host Configuration Abstraction\n\n# Host Configuration Abstraction\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n\n</details>\n\n\n\nThe Host Configuration abstraction is React\'s platform adaptation layer that enables the reconciler to target different rendering environments (DOM, React Native, canvas, terminal, etc.) through a consistent interface. Each renderer implements a host config that translates React\'s universal operations into platform-specific actions.\n\nFor information about the reconciler\'s work loop and rendering phases, see [4.2](#4.2). For platform-specific implementations like React DOM and hydration, see [6.1](#6.1) and [6.3](#6.3).\n\n## Host Config Interface\n\nThe host config defines a contract between the reconciler and the host platform. Renderers provide implementations by passing a configuration object to `react-reconciler` which acts as a factory function wrapping the reconciler code.\n\n### Core Configuration Structure\n\n```mermaid\ngraph TB\n    Reconciler["react-reconciler<br/>(ReactFiberWorkLoop)"]\n    CustomConfig["ReactFiberConfig.custom.js<br/>Interface Definition"]\n    \n    subgraph "Platform Implementations"\n        DOMConfig["ReactFiberConfigDOM.js<br/>DOM Renderer"]\n        FabricConfig["ReactFiberConfigFabric.js<br/>RN Fabric"]\n        NativeConfig["ReactFiberConfigNative.js<br/>RN Legacy"]\n        NoopConfig["createReactNoop.js<br/>Test Renderer"]\n        TestConfig["ReactFiberConfigTestHost.js<br/>Test Renderer"]\n        ARTConfig["ReactFiberConfigART.js<br/>ART Renderer"]\n    end\n    \n    Reconciler -->|"uses via $$$config"| CustomConfig\n    CustomConfig -.->|"implemented by"| DOMConfig\n    CustomConfig -.->|"implemented by"| FabricConfig\n    CustomConfig -.->|"implemented by"| NativeConfig\n    CustomConfig -.->|"implemented by"| NoopConfig\n    CustomConfig -.->|"implemented by"| TestConfig\n    CustomConfig -.->|"implemented by"| ARTConfig\n```\n\n**Diagram: Host Config Architecture**\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:1-287](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-150](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-82]()\n\n### Essential Host Config Methods\n\nThe host config interface consists of over 100 methods, organized into several categories:\n\n| Category | Required | Example Methods | Purpose |\n|----------|----------|----------------|---------|\n| **Metadata** | Yes | `rendererVersion`, `rendererPackageName`, `isPrimaryRenderer` | Identify the renderer |\n| **Instance Creation** | Yes | `createInstance`, `createTextInstance`, `appendInitialChild` | Build host trees during render |\n| **Context Management** | Yes | `getRootHostContext`, `getChildHostContext` | Track rendering context (e.g., namespace) |\n| **Finalization** | Yes | `finalizeInitialChildren`, `shouldSetTextContent` | Complete initial setup |\n| **Commit Preparation** | Yes | `prepareForCommit`, `resetAfterCommit` | Bracket commit phase |\n| **Public Instance** | Yes | `getPublicInstance` | Expose instances through refs |\n| **Scheduling** | Yes | `scheduleTimeout`, `cancelTimeout`, `now` | Time-based operations |\n| **Priority Management** | Yes | `setCurrentUpdatePriority`, `getCurrentUpdatePriority`, `resolveUpdatePriority` | Manage event priorities |\n| **Mutation** | Optional | `appendChild`, `removeChild`, `commitUpdate`, `commitTextUpdate` | Mutate existing trees |\n| **Persistence** | Optional | `cloneInstance`, `replaceContainerChildren` | Replace trees immutably |\n| **Hydration** | Optional | `canHydrateInstance`, `hydrateInstance`, `getNextHydratableSibling` | Match server-rendered markup |\n| **Resources** | Optional | `supportsResources`, `acquireResource`, `releaseResource` | Manage hoistable resources |\n| **Singletons** | Optional | `supportsSingletons`, `acquireSingletonInstance` | Manage singleton elements |\n| **View Transitions** | Optional | `startViewTransition`, `measureInstance` | Animate state transitions |\n| **Suspense Commit** | Optional | `maySuspendCommit`, `waitForCommitToBeReady` | Delay commits for loading |\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:52-287]()\n\n### Host Config Method Signatures\n\n```mermaid\ngraph LR\n    subgraph "Render Phase"\n        CreateInstance["createInstance()<br/>type, props, rootContainer,<br/>hostContext, handle"]\n        CreateText["createTextInstance()<br/>text, rootContainer,<br/>hostContext, handle"]\n        AppendInitial["appendInitialChild()<br/>parent, child"]\n        Finalize["finalizeInitialChildren()<br/>instance, type, props"]\n    end\n    \n    subgraph "Commit Phase - Mutation"\n        AppendChild["appendChild()<br/>parent, child"]\n        RemoveChild["removeChild()<br/>parent, child"]\n        CommitUpdate["commitUpdate()<br/>instance, type,<br/>oldProps, newProps"]\n        CommitText["commitTextUpdate()<br/>textInstance,<br/>oldText, newText"]\n    end\n    \n    subgraph "Commit Phase - Persistence"\n        CloneInstance["cloneInstance()<br/>instance, type,<br/>oldProps, newProps,<br/>keepChildren, newChildren"]\n        ReplaceChildren["replaceContainerChildren()<br/>container, newChildren"]\n    end\n    \n    CreateInstance --> AppendInitial\n    CreateText --> AppendInitial\n    AppendInitial --> Finalize\n    Finalize -.->|"mutation"| AppendChild\n    Finalize -.->|"persistence"| CloneInstance\n```\n\n**Diagram: Key Host Config Method Flow**\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:61-189]()\n\n## Mutation vs Persistence Modes\n\nReact\'s reconciler supports two modes for applying updates, chosen at compile time through the host config:\n\n### Mutation Mode\n\n**Mode Identifier**: `supportsMutation = true`, `supportsPersistence = false`\n\nIn mutation mode, the reconciler directly modifies existing host instances. This is more memory-efficient but requires the host platform to support in-place updates.\n\n**Required Methods**:\n- `appendChild(parentInstance, child)` - Add child to parent\n- `removeChild(parentInstance, child)` - Remove child from parent\n- `insertBefore(parentInstance, child, beforeChild)` - Insert at position\n- `commitUpdate(instance, type, oldProps, newProps)` - Update instance properties\n- `commitTextUpdate(textInstance, oldText, newText)` - Update text content\n- `resetTextContent(instance)` - Clear text content\n- `hideInstance(instance)` / `unhideInstance(instance, props)` - Toggle visibility\n\n**Example Implementation (DOM)**:\n\n```mermaid\ngraph TB\n    Reconciler["Reconciler detects update"]\n    CommitUpdate["commitUpdate() called"]\n    UpdateProps["updateProperties()<br/>diff oldProps vs newProps"]\n    UpdateDOM["Apply changes to DOM node"]\n    UpdateFiberProps["updateFiberProps()<br/>cache on DOM node"]\n    \n    Reconciler --> CommitUpdate\n    CommitUpdate --> UpdateProps\n    UpdateProps --> UpdateDOM\n    CommitUpdate --> UpdateFiberProps\n```\n\n**Diagram: DOM Mutation Mode Flow**\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:940-953](), [packages/react-dom-bindings/src/client/ReactDOMComponent.js:78-82]()\n\n### Persistence Mode\n\n**Mode Identifier**: `supportsMutation = false`, `supportsPersistence = true`\n\nIn persistence mode, the reconciler creates new clones of instances that need updates, building a new tree structure. This enables features like time-travel debugging and structural sharing.\n\n**Required Methods**:\n- `cloneInstance(instance, type, oldProps, newProps, keepChildren, newChildren)` - Clone with updates\n- `createContainerChildSet()` - Create new child collection\n- `appendChildToContainerChildSet(childSet, child)` - Add to collection\n- `finalizeContainerChildren(container, newChildren)` - Prepare for replacement\n- `replaceContainerChildren(container, newChildren)` - Atomic swap\n- `cloneHiddenInstance(instance, type, props)` - Clone as hidden\n- `cloneHiddenTextInstance(instance, text)` - Clone text as hidden\n\n**Example Implementation (React Native Fabric)**:\n\n```mermaid\ngraph TB\n    Reconciler["Reconciler detects update"]\n    CloneInstance["cloneInstance() called"]\n    DiffProps["diffAttributePayloads()<br/>compute property changes"]\n    CloneNode["cloneNodeWithNewProps()<br/>native clone operation"]\n    ShareCanonical["Share canonical object<br/>with original instance"]\n    \n    Reconciler --> CloneInstance\n    CloneInstance --> DiffProps\n    DiffProps --> CloneNode\n    CloneInstance --> ShareCanonical\n```\n\n**Diagram: Fabric Persistence Mode Flow**\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:451-504]()\n\n### Mode Comparison\n\n| Aspect | Mutation Mode | Persistence Mode |\n|--------|---------------|------------------|\n| **Memory** | Lower (reuses instances) | Higher (creates clones) |\n| **Complexity** | Higher (manage mutations) | Lower (immutable trees) |\n| **Debugging** | Harder (state changes) | Easier (tree snapshots) |\n| **Platform Fit** | DOM, legacy systems | React Native Fabric, immutable backends |\n| **Update Mechanism** | In-place modification | Clone and replace |\n| **Instance Lifetime** | Long-lived | Short-lived per update |\n\nSources: [packages/react-reconciler/src/ReactFiberConfigWithNoPersistence.js:1-62](), [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js:1-62]()\n\n## Fork Resolution System\n\nReact uses a build-time fork system to select the appropriate host config implementation without runtime overhead. The reconciler imports from `react-reconciler/src/ReactFiberConfig` which is resolved to different files based on the target renderer.\n\n### Fork Resolution Mechanism\n\n```mermaid\ngraph TB\n    Source["reconciler imports<br/>\'./ReactFiberConfig\'"]\n    BuildSystem["Rollup Build System<br/>(scripts/rollup/build.js)"]\n    ForksConfig["forks.js configuration"]\n    \n    subgraph "Fork Targets"\n        DOMFork["ReactFiberConfigDOM.js"]\n        FabricFork["ReactFiberConfigFabric.js"]\n        NativeFork["ReactFiberConfigNative.js"]\n        CustomFork["ReactFiberConfig.custom.js"]\n    end\n    \n    Source --> BuildSystem\n    BuildSystem --> ForksConfig\n    ForksConfig -.->|"react-dom bundle"| DOMFork\n    ForksConfig -.->|"react-native-renderer<br/>(fabric)"| FabricFork\n    ForksConfig -.->|"react-native-renderer<br/>(legacy)"| NativeFork\n    ForksConfig -.->|"react-reconciler npm"| CustomFork\n```\n\n**Diagram: Build-Time Fork Resolution**\n\nThe fork configuration in `scripts/rollup/forks.js` maps bundle types to specific host config files:\n\n```\n\'react-reconciler/src/ReactFiberConfig\': {\n  \'react-dom\': \'react-dom-bindings/src/client/ReactFiberConfigDOM\',\n  \'react-native-renderer\': \'react-native-renderer/src/ReactFiberConfigNative\',\n  \'react-native-renderer/fabric\': \'react-native-renderer/src/ReactFiberConfigFabric\',\n  \'react-test-renderer\': \'react-test-renderer/src/ReactFiberConfigTestHost\',\n  \'react-art\': \'react-art/src/ReactFiberConfigART\',\n  \'react-reconciler\': \'react-reconciler/src/forks/ReactFiberConfig.custom\'\n}\n```\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:10-24](), build system configuration (inferred from imports)\n\n### Custom Renderer Pattern\n\nThe `react-reconciler` npm package enables third-party renderers by exporting a factory function. The custom host config uses a global `$$$config` variable that gets injected at build time:\n\n```mermaid\ngraph LR\n    ThirdParty["Third-party Renderer"]\n    ReconcilerFactory["reconciler(hostConfig)"]\n    GlobalConfig["$$$config variable<br/>(injected by wrapper)"]\n    CustomConfig["ReactFiberConfig.custom.js<br/>re-exports from $$$config"]\n    ReconcilerCore["Reconciler Core Logic"]\n    \n    ThirdParty -->|"calls with config"| ReconcilerFactory\n    ReconcilerFactory -->|"wraps and injects"| GlobalConfig\n    GlobalConfig --> CustomConfig\n    CustomConfig --> ReconcilerCore\n```\n\n**Diagram: Third-Party Renderer Integration**\n\nThe custom config file exports all methods from the injected `$$$config` object:\n\n```javascript\ndeclare const $$$config: any;\nexport const getPublicInstance = $$$config.getPublicInstance;\nexport const getRootHostContext = $$$config.getRootHostContext;\nexport const createInstance = $$$config.createInstance;\n// ... 100+ more exports\n```\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:26-287]()\n\n## Platform Implementations\n\n### React DOM (Mutation Mode)\n\nThe DOM host config is the most feature-complete implementation, supporting hydration, resources, singletons, view transitions, and suspense commits.\n\n**Key Characteristics**:\n- Mutation mode: directly modifies DOM nodes\n- Namespace context: tracks SVG, MathML, HTML contexts\n- Event system integration: delegates to `ReactDOMEventListener`\n- Resource management: hoists `<link>`, `<script>`, `<style>` to document head\n- Hydration: matches server-rendered markup\n\n**Instance Types**:\n\n| Type | Definition | Usage |\n|------|------------|-------|\n| `Instance` | `Element` | DOM element nodes |\n| `TextInstance` | `Text` | DOM text nodes |\n| `Container` | `Element \\| Document \\| DocumentFragment` | Root container |\n| `SuspenseInstance` | `Comment` (with `_reactRetry`) | Suspense boundaries in SSR |\n| `ActivityInstance` | `Comment` | Activity boundaries in SSR |\n| `HydratableInstance` | Union of above | Any hydratable node |\n\n**Context Management**:\n\n```mermaid\ngraph TB\n    RootContext["getRootHostContext()<br/>Detect document/fragment/<br/>element namespace"]\n    ChildContext["getChildHostContext()<br/>parentContext, type"]\n    \n    subgraph "Namespace Detection"\n        None["HostContextNamespaceNone<br/>(HTML)"]\n        SVG["HostContextNamespaceSvg"]\n        Math["HostContextNamespaceMath"]\n    end\n    \n    RootContext --> None\n    RootContext --> SVG\n    RootContext --> Math\n    \n    ChildContext -.->|"svg tag"| SVG\n    ChildContext -.->|"math tag"| Math\n    ChildContext -.->|"foreignObject in SVG"| None\n    ChildContext -.->|"inherits parent"| None\n```\n\n**Diagram: DOM Context Tracking**\n\n**Instance Creation**:\n\nThe `createInstance` method creates DOM elements with proper namespace handling:\n\n```\n1. Extract host context (namespace)\n2. Get owner document from root container\n3. Create element with appropriate createElementNS or createElement\n4. Special handling for \'script\' (create via innerHTML to prevent execution)\n5. Special handling for \'select\' (apply size/multiple before children)\n6. Cache fiber node on DOM node via precacheFiberNode()\n7. Cache props on DOM node via updateFiberProps()\n8. Return DOM element\n```\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:303-609](), [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js:47-59]()\n\n### React Native Fabric (Persistence Mode)\n\nFabric is React Native\'s modern rendering architecture, using persistence mode to enable structural sharing and better integration with native rendering.\n\n**Key Characteristics**:\n- Persistence mode: creates clones instead of mutating\n- Shadow nodes: lightweight native representations\n- Canonical object sharing: multiple clones share state\n- Public instance laziness: created on first ref access\n\n**Instance Structure**:\n\n```typescript\ntype Instance = {\n  node: Node,  // Shadow node reference (native)\n  canonical: {\n    nativeTag: number,\n    viewConfig: ViewConfig,\n    currentProps: Props,\n    internalInstanceHandle: Fiber,\n    publicInstance: PublicInstance | null,  // Lazily created\n    publicRootInstance?: PublicRootInstance | null\n  }\n}\n```\n\n**Clone Strategy**:\n\n```mermaid\ngraph TB\n    CloneCall["cloneInstance() called"]\n    DiffProps["diffAttributePayloads()<br/>compute changes"]\n    CheckChildren["Check keepChildren flag"]\n    \n    subgraph "Clone Operations"\n        ClonePropsOnly["cloneNodeWithNewProps()<br/>(keep children)"]\n        CloneChildren["cloneNodeWithNewChildren()<br/>(replace children)"]\n        CloneBoth["cloneNodeWithNewChildrenAndProps()<br/>(both changed)"]\n    end\n    \n    ShareCanonical["Share canonical object<br/>across all clones"]\n    \n    CloneCall --> DiffProps\n    DiffProps --> CheckChildren\n    CheckChildren -->|"keepChildren=true<br/>props changed"| ClonePropsOnly\n    CheckChildren -->|"keepChildren=false<br/>no props changed"| CloneChildren\n    CheckChildren -->|"keepChildren=false<br/>props changed"| CloneBoth\n    \n    ClonePropsOnly --> ShareCanonical\n    CloneChildren --> ShareCanonical\n    CloneBoth --> ShareCanonical\n```\n\n**Diagram: Fabric Clone Strategy**\n\nThe `canonical` object is shared across all clones of an instance, providing a stable identity for:\n- Public instance exposure through refs\n- Event handler lookup\n- Current props access for event dispatching\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:95-113](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:451-504]()\n\n### React Native Legacy (Mutation Mode)\n\nThe legacy React Native renderer uses mutation mode with the UIManager bridge API.\n\n**Key Characteristics**:\n- Mutation mode: calls UIManager to modify native views\n- Instance tracking: `ReactNativeFiberHostComponent` wrapper\n- Children management: tracks `_children` array on instance\n- Bridge batching: accumulates changes before native calls\n\n**Instance Management**:\n\n```mermaid\ngraph TB\n    CreateInstance["createInstance()"]\n    AllocateTag["allocateTag()<br/>unique view ID"]\n    GetConfig["getViewConfigForType()<br/>from registry"]\n    CreatePayload["create()<br/>attribute payload"]\n    UIManagerCreate["UIManager.createView()<br/>tag, viewName, rootTag, props"]\n    WrapInstance["new ReactNativeFiberHostComponent()"]\n    \n    CreateInstance --> AllocateTag\n    CreateInstance --> GetConfig\n    CreateInstance --> CreatePayload\n    CreateInstance --> UIManagerCreate\n    CreateInstance --> WrapInstance\n```\n\n**Diagram: Legacy RN Instance Creation**\n\n**Mutation Operations**:\n\nAll mutations go through `UIManager.manageChildren()` which batches multiple operations:\n- `moveFromIndices` / `moveToIndices` - Reorder children\n- `addChildReactTags` / `addAtIndices` - Insert new children\n- `removeAtIndices` - Remove children\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigNative.js:130-169](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:379-411]()\n\n### Test Renderers (Noop and Test)\n\nReact provides test renderers for unit testing without real host platforms.\n\n**Noop Renderer** (`react-noop-renderer`):\n- Used by React\'s internal tests\n- Simple JS object instances: `{type, props, children, hidden, id}`\n- Supports both mutation and persistence modes\n- Configurable behavior (e.g., errors, suspense)\n\n**Test Renderer** (`react-test-renderer`):\n- Public testing API\n- Mutation mode only\n- Creates mockable instances\n- Simple tree inspection: `root.toJSON()`\n\n**Noop Instance Structure**:\n\n```javascript\ntype Instance = {\n  id: number,           // Hidden from enumeration\n  type: string,\n  children: Array<Instance | TextInstance>,\n  parent: number,       // Hidden from enumeration\n  text: string | null,  // Hidden from enumeration\n  prop: any,            // User-defined prop\n  hidden: boolean,\n  context: HostContext  // Hidden from enumeration\n}\n```\n\nThe noop renderer uses `Object.defineProperty()` to hide implementation details from test assertions, making test output cleaner.\n\nSources: [packages/react-noop-renderer/src/createReactNoop.js:399-453](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:158-174]()\n\n### ART Renderer (Canvas/SVG)\n\nThe ART renderer targets the ART drawing library for canvas and SVG rendering.\n\n**Key Characteristics**:\n- Mutation mode\n- Transform-based positioning\n- Pooled transform object (reused across calls)\n- Event listener management\n\n**Transform Application**:\n\n```mermaid\ngraph LR\n    Props["props: x, y, rotation,<br/>scaleX, scaleY, transform"]\n    PooledTransform["pooledTransform<br/>(reused Transform object)"]\n    Compose["Compose transformations:<br/>1. move(x, y)<br/>2. rotate()<br/>3. scale()<br/>4. apply custom transform"]\n    CheckDirty["Compare with instance<br/>current transform"]\n    Apply["instance.transformTo()<br/>if changed"]\n    \n    Props --> PooledTransform\n    PooledTransform --> Compose\n    Compose --> CheckDirty\n    CheckDirty -->|"changed"| Apply\n```\n\n**Diagram: ART Transform Management**\n\nThe pooled transform pattern avoids allocating a new transform object for every update, reducing GC pressure during animations.\n\nSources: [packages/react-art/src/ReactFiberConfigART.js:140-184]()\n\n## Key Host Config Methods\n\n### Instance Lifecycle\n\n**createInstance(type, props, rootContainer, hostContext, internalInstanceHandle)**\n\nCreates a new host instance during the render phase. This is the primary factory method for host components.\n\n**Parameters**:\n- `type`: Component type string (e.g., "div", "View")\n- `props`: Component props object\n- `rootContainer`: The root container being rendered into\n- `hostContext`: Context from parent (e.g., namespace, text context)\n- `internalInstanceHandle`: Fiber reference for this instance\n\n**Returns**: Platform-specific instance (Element, native node, JS object, etc.)\n\n**Timing**: Called during `completeWork` in the render phase when a host component is first mounted.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:485-609](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:176-220]()\n\n**appendInitialChild(parentInstance, child)**\n\nAttaches a child instance to its parent during initial tree construction. This builds the tree bottom-up before commit.\n\n**Note**: Only called for newly created instances. Updates use different methods depending on mutation/persistence mode.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:640-646](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:167-172]()\n\n**finalizeInitialChildren(instance, type, props, hostContext)**\n\nCalled after all children have been appended to a newly created instance, allowing any final initialization.\n\n**Returns**: Boolean indicating whether `commitMount` should be called during commit phase (e.g., for autofocus).\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:648-666](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:250-257]()\n\n### Context Management\n\n**getRootHostContext(rootContainer)**\n\nInitializes the host context for the root of the tree. This determines the initial rendering context.\n\n**DOM Example**: Detects whether root is SVG, MathML, or HTML based on namespace.\n\n**React Native Example**: Returns `{isInAParentText: false}`.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:303-356](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:259-267]()\n\n**getChildHostContext(parentHostContext, type)**\n\nComputes child context based on parent context and the current component type. This propagates context down the tree.\n\n**DOM Example**: Entering `<svg>` switches to SVG namespace, `<foreignObject>` switches back to HTML.\n\n**React Native Example**: Entering text component types sets `isInAParentText: true`.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:392-407](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:269-291]()\n\n### Commit Phase Operations\n\n**prepareForCommit(containerInfo)** / **resetAfterCommit(containerInfo)**\n\nThese methods bracket the entire commit phase, allowing renderers to prepare and cleanup.\n\n**DOM Example**: \n- `prepareForCommit`: Disables event system, saves selection state, returns focused instance\n- `resetAfterCommit`: Re-enables event system, restores selection\n\n**React Native Example**: Both are no-ops (native rendering is synchronous).\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:413-451]()\n\n### Mutation Mode Methods\n\n**appendChild(parentInstance, child)** / **removeChild(parentInstance, child)**\n\nAdd or remove a child from a parent instance. Only defined in mutation mode.\n\n**DOM**: Uses `moveBefore()` if available (future API), otherwise `appendChild()`/`removeChild()`.\n\n**React Native Legacy**: Calls `UIManager.manageChildren()` to batch native changes.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:973-983](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:379-411]()\n\n**commitUpdate(instance, type, oldProps, newProps, internalInstanceHandle)**\n\nUpdates an existing instance\'s properties. Only defined in mutation mode.\n\n**DOM**: Calls `updateProperties()` which diffs props and applies changes to DOM.\n\n**React Native Legacy**: Diffs props and calls `UIManager.updateView()`.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:940-953](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:445-468]()\n\n### Persistence Mode Methods\n\n**cloneInstance(instance, type, oldProps, newProps, keepChildren, newChildSet)**\n\nCreates a clone of an instance with updated properties. Only defined in persistence mode.\n\n**Fabric**: Calls native clone operations (`cloneNodeWithNewProps`, `cloneNodeWithNewChildren`, etc.) and shares the `canonical` object.\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:451-504]()\n\n**replaceContainerChildren(container, newChildren)**\n\nAtomically replaces the root container\'s children with a new child set. Only defined in persistence mode.\n\n**Fabric**: Calls `completeRoot()` to finalize the native tree.\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:556-561]()\n\n### Priority and Scheduling\n\n**setCurrentUpdatePriority(priority)** / **getCurrentUpdatePriority()** / **resolveUpdatePriority()**\n\nManage the priority of the current update. These methods bridge React\'s event priorities with platform-specific priority systems.\n\n**DOM**: Uses React\'s priority constants directly.\n\n**React Native Fabric**: Maps between React priorities and Fabric\'s native priority system:\n- `FabricDiscretePriority`  `DiscreteEventPriority`\n- `FabricContinuousPriority`  `ContinuousEventPriority`\n- `FabricIdlePriority`  `IdleEventPriority`\n- `FabricDefaultPriority`  `DefaultEventPriority`\n\nSources: [packages/react-dom-bindings/src/client/ReactDOMUpdatePriority.js:42-45](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:386-419]()\n\n### Suspense Commit Support\n\n**maySuspendCommit(type, props)** / **preloadInstance(instance, type, props)**\n\nThese optional methods enable the reconciler to delay commits while resources load, preventing layout thrashing.\n\n**maySuspendCommit**: Returns true if this type+props combination might need to load before committing.\n\n**preloadInstance**: Initiates loading and returns true if already loaded, false if still loading.\n\n**DOM Example**: Implements for `<img>` with `loading="lazy"` and `<link>` resources.\n\n**startSuspendingCommit()** / **suspendInstance()** / **waitForCommitToBeReady()**\n\nCreate suspended state, track instances blocking commit, and provide a callback-based API for resuming when ready.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1213-1264](), [packages/react-noop-renderer/src/createReactNoop.js:618-679]()\n\n### View Transition Support\n\n**startViewTransition()** / **startGestureTransition()**\n\nOptional methods for animating state changes using the View Transition API or gesture-driven transitions.\n\n**Parameters include**:\n- Callbacks for mutation, layout, and passive phases\n- Transition types for CSS class selection  \n- Timeline objects for gesture control\n- Error and profiling callbacks\n\n**DOM**: Integrates with native `document.startViewTransition()` API.\n\n**Other platforms**: Typically no-op or call callbacks without animation.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1383-1520]()\n\n## Default Implementations\n\nReact provides default implementations for optional features that throw errors or return no-ops:\n\n- **ReactFiberConfigWithNoMutation.js**: Exports that throw for mutation methods\n- **ReactFiberConfigWithNoPersistence.js**: Exports that throw for persistence methods\n- **ReactFiberConfigWithNoHydration.js**: Exports that return false/null for hydration\n- **ReactFiberConfigWithNoResources.js**: Exports that throw for resource management\n- **ReactFiberConfigWithNoSingletons.js**: Exports that throw for singleton management\n- **ReactFiberConfigWithNoTestSelectors.js**: Exports that throw for test selectors\n- **ReactFiberConfigWithNoMicrotasks.js**: Exports that disable microtask scheduling\n- **ReactFiberConfigWithNoScopes.js**: Exports for disabled scope API\n\nRenderers import these default modules and then override only the features they support:\n\n```javascript\nexport * from \'react-reconciler/src/ReactFiberConfigWithNoMutation\';\nexport * from \'react-reconciler/src/ReactFiberConfigWithNoHydration\';\n// ... etc\n\n// Then override specific methods:\nexport const supportsPersistence = true;\nexport function cloneInstance(...) { /* implementation */ }\n```\n\nSources: [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js:1-62](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:160-165]()\n\n---\n\n# Page: Profiling and Performance Tracking\n\n# Profiling and Performance Tracking\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThe profiling system provides instrumentation for measuring React component rendering performance through four key mechanisms:\n\n1. **Profiler Component** - Public `<Profiler>` API for programmatic performance monitoring\n2. **Performance Measurement** - `actualDuration` and `baseDuration` fields tracking render times\n3. **Component Effects Tracking** - Measurement of effect execution times within Profiler boundaries\n4. **Browser DevTools Integration** - `performance.measure()` and `console.timeStamp()` integration for visual profiling\n\nThis system enables both runtime performance callbacks via the Profiler component and offline analysis through browser performance timelines and React DevTools.\n\nFor information about the DevTools profiling interface, see page 7.1. For lane-based scheduling that determines update priorities, see page 4.4.\n\n---\n\n## System Architecture\n\nThe profiling system operates across multiple phases of the React reconciliation and commit lifecycle:\n\n```mermaid\ngraph TB\n    subgraph "Public API"\n        ProfilerComponent["<Profiler> Component<br/>with onRender callback"]\n    end\n    \n    subgraph "Fiber Fields"\n        ActualDuration["actualDuration<br/>Time spent rendering"]\n        ActualStartTime["actualStartTime<br/>When render began"]\n        SelfBaseDuration["selfBaseDuration<br/>Component time only"]\n        TreeBaseDuration["treeBaseDuration<br/>Including children"]\n    end\n    \n    subgraph "Timing Infrastructure"\n        StartProfilerTimer["startProfilerTimer()<br/>Begin timing"]\n        StopProfilerTimer["stopProfilerTimerIfRunning()<br/>End timing"]\n        RecordRenderTime["recordRenderTime()<br/>Track render duration"]\n        RecordCommitTime["recordCommitTime()<br/>Track commit duration"]\n    end\n    \n    subgraph "Render Phase Instrumentation"\n        MarkRenderStarted["markComponentRenderStarted()<br/>BeginWork hooks"]\n        MarkRenderStopped["markComponentRenderStopped()<br/>After component render"]\n        TransferDuration["transferActualDuration()<br/>Bubble up times"]\n    end\n    \n    subgraph "Commit Phase Instrumentation"\n        CommitProfilerUpdate["commitProfilerUpdate()<br/>Layout effects"]\n        PushEffectDurations["pushNestedEffectDurations()<br/>Track effect times"]\n        PopEffectDurations["popNestedEffectDurations()<br/>Bubble effect times"]\n    end\n    \n    subgraph "Performance Track"\n        LogComponentRender["logComponentRender()<br/>Browser timeline"]\n        LogComponentMount["logComponentMount()"]\n        LogComponentEffect["logComponentEffect()"]\n        ConsoleTimeStamp["console.timeStamp()"]\n        PerformanceMeasure["performance.measure()"]\n    end\n    \n    ProfilerComponent --> ActualDuration\n    ProfilerComponent --> TreeBaseDuration\n    \n    StartProfilerTimer --> ActualStartTime\n    StopProfilerTimer --> ActualDuration\n    \n    MarkRenderStarted --> StartProfilerTimer\n    MarkRenderStopped --> StopProfilerTimer\n    TransferDuration --> TreeBaseDuration\n    \n    CommitProfilerUpdate --> PushEffectDurations\n    CommitProfilerUpdate --> PopEffectDurations\n    \n    LogComponentRender --> ConsoleTimeStamp\n    LogComponentRender --> PerformanceMeasure\n    LogComponentMount --> ConsoleTimeStamp\n    LogComponentEffect --> PerformanceMeasure\n    \n    RecordRenderTime --> LogComponentRender\n    RecordCommitTime --> CommitProfilerUpdate\n```\n\n**Sources:** [packages/react-reconciler/src/ReactProfilerTimer.js:1-700](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:1-600]()\n\n---\n\n## Profiler Component API\n\nThe public `<Profiler>` component allows measuring rendering costs programmatically:\n\n```mermaid\ngraph LR\n    subgraph "Component Tree"\n        App["App Component"]\n        ProfilerNode["<Profiler id=\'navigation\'<br/>onRender=callback>"]\n        Children["Navigation children"]\n    end\n    \n    subgraph "Callback Invocation"\n        OnRenderCallback["onRender callback"]\n        CallbackArgs["Arguments:<br/>id, phase, actualDuration,<br/>baseDuration, startTime,<br/>commitTime"]\n    end\n    \n    subgraph "Profiler Fiber"\n        ProfilerFiber["Profiler Fiber<br/>tag: Profiler"]\n        StateNode["stateNode:<br/>{id, onRender, effectDuration}"]\n    end\n    \n    App --> ProfilerNode\n    ProfilerNode --> Children\n    ProfilerNode --> ProfilerFiber\n    ProfilerFiber --> StateNode\n    ProfilerFiber --> OnRenderCallback\n    OnRenderCallback --> CallbackArgs\n```\n\n### Callback Signature\n\nThe `onRender` callback receives six arguments as defined in `commitProfilerUpdate`:\n\n| Parameter | Type | Description |\n|-----------|------|-------------|\n| `id` | string | Unique identifier for the Profiler |\n| `phase` | "mount" \\| "update" \\| "nested-update" | Render phase type |\n| `actualDuration` | number | Time spent rendering this update (ms) |\n| `baseDuration` | number | Total render time without memoization (ms) |\n| `startTime` | number | When React began rendering (ms from page load) |\n| `commitTime` | number | When React committed the update (ms from page load) |\n\nThe callback is invoked during the layout effects phase via `commitProfilerUpdate`. When `enableProfilerCommitHooks` is enabled, the callback is called synchronously after layout effects but before passive effects.\n\n**Example from tests:**\n```javascript\n// Test verifying callback parameters\n<Profiler id="test" onRender={callback}>\n  <AdvanceTime />\n</Profiler>\n\n// callback receives:\n// id: \'test\'\n// phase: \'mount\'\n// actualDuration: 10  // time spent in this render\n// baseDuration: 10    // time without memo optimizations\n// startTime: 5        // when render started\n// commitTime: 15      // when commit finished\n```\n\n**Sources:** [packages/react/src/__tests__/ReactProfiler-test.internal.js:287-360](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:350-380](), [packages/react-reconciler/src/ReactFiberCommitWork.js:699-734]()\n\n---\n\n## Internal Timing Infrastructure\n\n### Fiber Timing Fields\n\nEach fiber maintains four timing-related fields when `enableProfilerTimer` is enabled. These fields are initialized in the `FiberNode` constructor:\n\n```mermaid\ngraph TB\n    FiberNode["Fiber Node<br/>(FiberNode constructor)"]\n    \n    subgraph "Performance Measurement Fields"\n        ActualDuration["actualDuration: number<br/>Accumulated render time<br/>for this render pass<br/>(starts at -0)"]\n        ActualStartTime["actualStartTime: number<br/>When this fiber began<br/>rendering, or -1 if not started<br/>(initialized to -1.1)"]\n        SelfBaseDuration["selfBaseDuration: number<br/>Most recent render time<br/>excluding children<br/>(starts at -0)"]\n        TreeBaseDuration["treeBaseDuration: number<br/>Total time for subtree<br/>without memoization<br/>(starts at -0)"]\n    end\n    \n    FiberNode --> ActualDuration\n    FiberNode --> ActualStartTime\n    FiberNode --> SelfBaseDuration\n    FiberNode --> TreeBaseDuration\n    \n    style FiberNode fill:#f9f9f9\n```\n\n**Field Semantics:**\n\n- **`actualDuration`**: Accumulates the time spent rendering during the current work-in-progress pass. Updated by `stopProfilerTimerIfRunningAndRecordDuration`.\n- **`actualStartTime`**: Set by `startProfilerTimer` when rendering begins. Value of -1 indicates the fiber hasn\'t started rendering in this pass.\n- **`selfBaseDuration`**: Time for this component alone, excluding children. Calculated during `completeWork`.\n- **`treeBaseDuration`**: Estimated total time including all children if nothing was memoized. Bubbles up via `transferActualDuration`.\n\nThese fields use double values (initialized to -0 and -1.1) to avoid V8 performance cliffs when Object.preventExtensions is applied in DEV mode.\n\n**Sources:** [packages/react-reconciler/src/ReactFiber.js:179-197](), [packages/react-reconciler/src/ReactFiber.js:281-286](), [packages/react-reconciler/src/ReactProfilerTimer.js:324-400]()\n\n### Timer Control Functions\n\nThe profiling system provides functions to start and stop timers during component rendering:\n\n| Function | Location | Purpose |\n|----------|----------|---------|\n| `startProfilerTimer(fiber)` | ReactProfilerTimer.js | Begin timing a fiber\'s render |\n| `stopProfilerTimerIfRunningAndRecordDuration(fiber)` | ReactProfilerTimer.js | Complete timing and record duration |\n| `stopProfilerTimerIfRunningAndRecordIncompleteDuration(fiber)` | ReactProfilerTimer.js | Record partial duration if interrupted |\n| `recordRenderTime(endTime)` | ReactProfilerTimer.js | Mark render phase completion |\n| `recordCommitTime(endTime)` | ReactProfilerTimer.js | Mark commit phase completion |\n\n**Sources:** [packages/react-reconciler/src/ReactProfilerTimer.js:324-400]()\n\n---\n\n## Render Phase Instrumentation\n\nDuring the render phase, React instruments component rendering at key points:\n\n```mermaid\ngraph TD\n    BeginWork["beginWork(fiber)"]\n    PrepareToReadContext["prepareToReadContext()"]\n    MarkStarted["markComponentRenderStarted(fiber)<br/>if enableSchedulingProfiler"]\n    \n    RenderComponent["renderWithHooks() or<br/>callComponentInDEV()"]\n    \n    MarkStopped["markComponentRenderStopped()<br/>if enableSchedulingProfiler"]\n    StopTimer["stopProfilerTimerIfRunning(fiber)<br/>if enableProfilerTimer"]\n    \n    CompleteWork["completeWork(fiber)"]\n    TransferDuration["transferActualDuration(fiber)<br/>Bubble to parent Profiler"]\n    \n    BeginWork --> PrepareToReadContext\n    PrepareToReadContext --> MarkStarted\n    MarkStarted --> RenderComponent\n    RenderComponent --> MarkStopped\n    MarkStopped --> StopTimer\n    StopTimer --> CompleteWork\n    CompleteWork --> TransferDuration\n```\n\n### Component Render Timing\n\nFor function components, the instrumentation occurs in `updateFunctionComponent`:\n\n[packages/react-reconciler/src/ReactFiberBeginWork.js:438-454]()\n\nFor class components, timing wraps lifecycle methods:\n\n[packages/react-reconciler/src/ReactFiberClassComponent.js:56-63]()\n\n### Duration Accumulation\n\nAs the reconciler completes work on child fibers, their `actualDuration` values bubble up to ancestor Profiler components via `transferActualDuration`:\n\n[packages/react-reconciler/src/ReactProfilerTimer.js:680-700]()\n\n**Sources:** [packages/react-reconciler/src/ReactFiberBeginWork.js:438-454](), [packages/react-reconciler/src/ReactProfilerTimer.js:680-700]()\n\n---\n\n## Component Effects Tracking\n\nThe commit phase tracks the execution time of effects (layout and passive) within Profiler boundaries. This is crucial for understanding not just render costs but also effect costs.\n\n### Effect Duration Measurement Flow\n\n```mermaid\ngraph TD\n    subgraph "commitLayoutEffectOnFiber"\n        Start["Enter commitLayoutEffectOnFiber(fiber)"]\n        PushEffectStart["pushComponentEffectStart()<br/>Record start time in componentEffectStartTime"]\n        PushEffectDuration["pushComponentEffectDuration()<br/>Save previous duration"]\n        \n        CheckProfiler{"Is fiber a<br/>Profiler tag?"}\n        \n        PushNested["pushNestedEffectDurations()<br/>Save prevProfilerEffectDuration<br/>Reset profilerEffectDuration = 0"]\n        \n        ExecuteEffects["Execute layout effects<br/>(recursively for children)"]\n        \n        PopNested["popNestedEffectDurations(prev)<br/>Calculate nested duration<br/>Add to profilerEffectDuration"]\n        \n        InvokeCallback["commitProfilerUpdate()<br/>Call onRender with effectDuration"]\n        \n        PopEffectStart["popComponentEffectStart()"]\n        PopEffectDuration["popComponentEffectDuration()<br/>Add elapsed time to componentEffectDuration"]\n    end\n    \n    Start --> PushEffectStart\n    PushEffectStart --> PushEffectDuration\n    PushEffectDuration --> CheckProfiler\n    CheckProfiler -->|Yes| PushNested\n    CheckProfiler -->|No| ExecuteEffects\n    PushNested --> ExecuteEffects\n    ExecuteEffects --> PopNested\n    PopNested --> InvokeCallback\n    ExecuteEffects --> PopEffectStart\n    PopEffectStart --> PopEffectDuration\n    \n    style CheckProfiler fill:#f9f9f9\n    style InvokeCallback fill:#f9f9f9\n```\n\n### Effect Timing Variables\n\nThe profiler maintains several module-level variables for effect timing:\n\n```javascript\n// From ReactProfilerTimer.js\nexport let profilerEffectDuration: number = -0;\nexport let componentEffectStartTime: number = -1.1;\nexport let componentEffectEndTime: number = -1.1;\nexport let componentEffectDuration: number = -0;\n```\n\nThese track:\n- **`profilerEffectDuration`**: Total effect time within current Profiler boundary\n- **`componentEffectStartTime`**: When effect execution started for current component\n- **`componentEffectDuration`**: Accumulated effect time for current component\n\n### Stack-Based Duration Tracking\n\nThe system uses a stack to handle nested Profilers correctly:\n\n```javascript\n// pushNestedEffectDurations saves current duration and resets\nconst prevProfilerEffectDuration = profilerEffectDuration;\nprofilerEffectDuration = 0;\n\n// After children execute effects...\n\n// popNestedEffectDurations calculates and bubbles up\nconst nestedDuration = profilerEffectDuration;\nprofilerEffectDuration = prevDuration + nestedDuration;\n```\n\nThis ensures each Profiler accurately measures only the effects in its subtree, including nested Profilers.\n\n### Profiler Callback with Effect Duration\n\nWhen `commitProfilerUpdate` is called for a Profiler fiber with `enableProfilerCommitHooks` enabled:\n\n[packages/react-reconciler/src/ReactFiberCommitEffects.js:350-380]()\n\nThe callback receives `effectDuration` calculated from `profilerEffectDuration`, which includes:\n- Time executing layout effects in the Profiler\'s subtree\n- Time from nested Profiler components\n- Effect cleanup and setup time\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:699-734](), [packages/react-reconciler/src/ReactProfilerTimer.js:61-68](), [packages/react-reconciler/src/ReactProfilerTimer.js:123-141]()\n\n---\n\n## Browser DevTools Performance API Integration\n\nWhen `enableComponentPerformanceTrack` is enabled, React integrates with browser DevTools using the Performance API. This creates visual profiling data in Chrome/Edge DevTools Performance panel and Firefox Performance tools.\n\n### Browser API Integration Points\n\n```mermaid\ngraph TB\n    subgraph "React Profiling Events"\n        RenderComplete["Render phase completes<br/>recordRenderTime()"]\n        ComponentRender["Component finishes rendering<br/>stopProfilerTimer()"]\n        EffectExecute["Effects execute<br/>commitLayoutEffects()"]\n        ComponentMount["Component mounts<br/>commitHostMount()"]\n        ComponentUnmount["Component unmounts<br/>safelyCallComponentWillUnmount()"]\n    end\n    \n    subgraph "ReactFiberPerformanceTrack.js Functions"\n        LogRender["logComponentRender(fiber, start, end)<br/>Main render tracking"]\n        LogMount["logComponentMount(fiber, start, end)<br/>Mount event marker"]\n        LogUnmount["logComponentUnmount(fiber, start, end)<br/>Unmount event marker"]\n        LogEffect["logComponentEffect(fiber, start, end)<br/>Effect execution span"]\n    end\n    \n    subgraph "Browser Performance APIs"\n        ConsoleTimeStamp["console.timeStamp(name, start, end,<br/>track, group, color)<br/>Creates timeline marker"]\n        PerformanceMeasure["performance.measure(name, options)<br/>Creates performance span"]\n        PerformanceClear["performance.clearMeasures(name)<br/>Cleanup after logging"]\n    end\n    \n    subgraph "Performance Panel Result"\n        ComponentsTrack["\'Components \' track<br/>Render spans with metadata"]\n        LanesTrack["\'Scheduler \' group<br/>Blocking/Gesture/Transition/etc"]\n        Markers["Timeline markers<br/>Mount/Unmount events"]\n    end\n    \n    ComponentRender --> LogRender\n    ComponentMount --> LogMount\n    ComponentUnmount --> LogUnmount\n    EffectExecute --> LogEffect\n    \n    LogRender --> ConsoleTimeStamp\n    LogRender --> PerformanceMeasure\n    LogMount --> ConsoleTimeStamp\n    LogEffect --> PerformanceMeasure\n    \n    PerformanceMeasure --> PerformanceClear\n    \n    ConsoleTimeStamp --> ComponentsTrack\n    PerformanceMeasure --> ComponentsTrack\n    ConsoleTimeStamp --> Markers\n    \n    RenderComplete --> LanesTrack\n    \n    style ConsoleTimeStamp fill:#f9f9f9\n    style PerformanceMeasure fill:#f9f9f9\n```\n\n### Performance Measure Options\n\nReact uses the extended `performance.measure()` API with DevTools-specific metadata:\n\n```javascript\n// From logComponentRender in ReactFiberPerformanceTrack.js\nconst reusableComponentOptions = {\n  start: startTime,\n  end: endTime,\n  detail: {\n    devtools: {\n      dataType: \'track-entry\',\n      color: \'primary\', // or \'primary-light\', \'primary-dark\', \'error\'\n      track: \'Components \',\n      tooltipText: componentName,\n      properties: [\n        // Array of property changes, warnings, etc.\n      ]\n    }\n  }\n};\n\nperformance.measure(measureName, reusableComponentOptions);\n```\n\nThe `detail.devtools` object is recognized by Chrome DevTools to:\n- Place entries in named tracks ("Components ")\n- Apply color coding based on render duration\n- Add tooltips with component names\n- Attach structured metadata (props changes, warnings)\n\n### Track Organization\n\nPerformance entries are organized into distinct tracks visible in the Performance panel:\n\n| Track/Group | Created By | Entries |\n|-------------|------------|---------|\n| Components  | `logComponentRender()` | Individual component render spans |\n| Scheduler  | `markAllLanesInOrder()` | Lane group initialization markers |\n| Blocking (sub-track) | Lane tracking | Blocking lane renders |\n| Gesture (sub-track) | Lane tracking | Gesture transition renders |\n| Transition (sub-track) | Lane tracking | Transition renders |\n| Suspense (sub-track) | Lane tracking | Retry lane renders |\n| Idle (sub-track) | Lane tracking | Idle priority renders |\n\n### Metadata in Performance Entries\n\nEach component render entry includes rich metadata via the `properties` array:\n\n```javascript\n// Property metadata structure\nproperties: [\n  [\'Props Changed\', changedPropNames.join(\', \')],\n  [\'Deep Equal Props\', deepEqualProps ? \'true\' : \'false\'],\n  [\'Cascading Update\', didCascade ? \'true\' : \'false\'],\n  // ... additional entries\n]\n```\n\nThis metadata appears in the DevTools UI when selecting a performance entry, helping developers identify:\n- Which props changed to trigger the render\n- Whether deeply equal objects caused unnecessary renders\n- If the component updated during another component\'s render\n\n### Console Task Integration\n\nIn development mode with `console.createTask()` support, React links performance entries to the component\'s debug task:\n\n[packages/react-reconciler/src/ReactFiberPerformanceTrack.js:125-137]()\n\nThis allows DevTools to group related async operations and show the component stack that initiated them.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:42-51](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:112-139](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:221-330]()\n\n---\n\n## Update Type Tracking\n\nThe profiling system distinguishes between different types of updates:\n\n```mermaid\ngraph LR\n    subgraph "Update Types"\n        RegularUpdate["REGULAR_UPDATE (0)<br/>Normal setState/dispatch"]\n        SpawnedUpdate["SPAWNED_UPDATE (1)<br/>Update during render"]\n        PingedUpdate["PINGED_UPDATE (2)<br/>Retry after Suspense"]\n    end\n    \n    subgraph "Update Timers"\n        BlockingTimers["Blocking update timers:<br/>blockingUpdateTime,<br/>blockingUpdateTask,<br/>blockingUpdateMethodName"]\n        GestureTimers["Gesture update timers:<br/>gestureUpdateTime,<br/>gestureUpdateTask,<br/>gestureUpdateMethodName"]\n        TransitionTimers["Transition update timers:<br/>transitionUpdateTime,<br/>transitionUpdateTask,<br/>transitionUpdateMethodName"]\n    end\n    \n    subgraph "Event Tracking"\n        EventTime["Event timestamp"]\n        EventType["Event type (click, input, etc)"]\n        EventRepeatTime["Repeat event detection"]\n        SuspendedTime["Time suspended waiting"]\n    end\n    \n    RegularUpdate --> BlockingTimers\n    RegularUpdate --> GestureTimers\n    RegularUpdate --> TransitionTimers\n    \n    BlockingTimers --> EventTime\n    GestureTimers --> EventTime\n    TransitionTimers --> EventTime\n    \n    EventTime --> EventType\n    EventType --> EventRepeatTime\n    EventRepeatTime --> SuspendedTime\n```\n\n### Timer Lifecycle\n\nFor each lane group, the system maintains separate timers:\n\n**Blocking Lane Updates:**\n[packages/react-reconciler/src/ReactProfilerTimer.js:69-78]()\n\n**Gesture Lane Updates (when enabled):**\n[packages/react-reconciler/src/ReactProfilerTimer.js:80-89]()\n\n**Transition Lane Updates:**\n[packages/react-reconciler/src/ReactProfilerTimer.js:92-101]()\n\nThese timers are started when updates are scheduled and are clamped to the render/commit boundaries.\n\n**Sources:** [packages/react-reconciler/src/ReactProfilerTimer.js:52-101](), [packages/react-reconciler/src/ReactProfilerTimer.js:276-343]()\n\n---\n\n## React DevTools Backend Integration\n\nThe profiling system provides data to React DevTools through the DevTools hook, which is injected globally. This allows the standalone DevTools UI to display profiling data collected by the reconciler.\n\n### DevTools Hook Communication\n\n```mermaid\ngraph TB\n    subgraph "Reconciler Commit Phases"\n        CommitRoot["commitRoot(root, ...) in<br/>ReactFiberWorkLoop.js"]\n        LayoutPhase["Layout effects phase<br/>commitLayoutEffects()"]\n        ProfilerCallback["Profiler onRender callbacks<br/>commitProfilerUpdate()"]\n        PassivePhase["Passive effects phase<br/>commitPassiveMountEffects()"]\n    end\n    \n    subgraph "Profiling Data Collection"\n        FiberTree["Fiber tree with<br/>actualDuration, treeBaseDuration"]\n        RootEffectDuration["root.effectDuration<br/>(accumulated during layout)"]\n        UpdateTracker["Update tracking metadata<br/>(_updatedFibers in DEV)"]\n    end\n    \n    subgraph "DevTools Hook Functions"\n        OnCommitRoot["onCommitRootDevTools(root, lanes)<br/>from ReactFiberDevToolsHook.js"]\n        OnPostCommitRoot["onPostCommitRootDevTools()<br/>(after passive effects)"]\n        MarkCommitStarted["markCommitStarted(lanes)<br/>(scheduling profiler)"]\n        MarkCommitStopped["markCommitStopped()<br/>(scheduling profiler)"]\n    end\n    \n    subgraph "DevTools UI"\n        ProfilerPanel["Profiler Panel<br/>(in React DevTools extension)"]\n        FlameGraph["Flame Graph view"]\n        RankedChart["Ranked Chart view"]\n        Timeline["Timeline view"]\n    end\n    \n    CommitRoot --> LayoutPhase\n    LayoutPhase --> ProfilerCallback\n    CommitRoot --> PassivePhase\n    \n    LayoutPhase --> RootEffectDuration\n    ProfilerCallback --> FiberTree\n    \n    CommitRoot --> MarkCommitStarted\n    MarkCommitStarted --> OnCommitRoot\n    OnCommitRoot --> FiberTree\n    OnCommitRoot --> RootEffectDuration\n    \n    PassivePhase --> OnPostCommitRoot\n    \n    OnCommitRoot --> ProfilerPanel\n    ProfilerPanel --> FlameGraph\n    ProfilerPanel --> RankedChart\n    ProfilerPanel --> Timeline\n    \n    style OnCommitRoot fill:#f9f9f9\n    style ProfilerPanel fill:#f9f9f9\n```\n\n### Commit Root Notification\n\nAfter each commit completes, React notifies DevTools via `onCommitRootDevTools`:\n\n[packages/react-reconciler/src/ReactFiberDevToolsHook.js:353-369]()\n\nThis hook is called with:\n- The `FiberRoot` containing the committed fiber tree\n- The `lanes` that were committed\n- Timing information from `commitStartTime` and `commitEndTime`\n\n### Effect Duration on FiberRoot\n\nThe `effectDuration` field on FiberRoot accumulates the total time spent in layout effects:\n\n[packages/react-reconciler/src/ReactFiberCommitWork.js:650-654]()\n\nThis value is calculated using `popNestedEffectDurations` and includes:\n- Time in all layout effect setup and cleanup functions\n- Nested Profiler effect durations\n- Class component lifecycle methods (componentDidMount, componentDidUpdate)\n\n### Debug Information in DEV\n\nWhen `enableUpdaterTracking` is enabled in development mode, transitions track which fibers were updated:\n\n```javascript\n// From ReactFiberWorkLoop.js - requestUpdateLane\nif (__DEV__) {\n  if (!transition._updatedFibers) {\n    transition._updatedFibers = new Set();\n  }\n  transition._updatedFibers.add(fiber);\n}\n```\n\nThis allows DevTools to show which components were affected by a particular transition, helping developers understand the scope of updates.\n\n### Console Task Tracking\n\nIn development mode, each fiber can have an associated `_debugTask` created with `console.createTask()`:\n\n[packages/react-reconciler/src/ReactFiber.js:199-210]()\n\nThis task is used to wrap performance measurements and other async operations, creating a causal chain that DevTools can visualize. The task shows which user interaction or async operation caused a particular component to render.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberDevToolsHook.js:353-369](), [packages/react-reconciler/src/ReactFiberCommitWork.js:650-654](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:792-836](), [packages/react-reconciler/src/ReactFiber.js:199-210]()\n\n---\n\n## Feature Flags\n\nThe profiling system respects several feature flags:\n\n| Flag | File | Purpose |\n|------|------|---------|\n| `enableProfilerTimer` | ReactFeatureFlags | Enable all timing infrastructure |\n| `enableProfilerCommitHooks` | ReactFeatureFlags | Enable Profiler onRender callbacks |\n| `enableProfilerNestedUpdatePhase` | ReactFeatureFlags | Track nested update phase separately |\n| `enableSchedulingProfiler` | ReactFeatureFlags | Enable DevTools scheduling profiler |\n| `enableComponentPerformanceTrack` | ReactFeatureFlags | Enable browser performance timeline |\n\nWhen `enableProfilerTimer` is false, all timing fields are omitted from fibers to reduce memory overhead.\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:1-100](), [packages/react-reconciler/src/ReactFiber.js:179-197]()\n\n---\n\n## Performance Considerations\n\n### Memory Overhead\n\nProfiling adds several fields to each fiber:\n- 4 double-precision numbers (32 bytes on 64-bit systems)\n- Additional tracking state for update types and timers\n\nThis overhead is eliminated in production builds when profiling is disabled.\n\n### Timing Precision\n\nThe system uses `Scheduler.unstable_now()` which delegates to `performance.now()` when available, providing microsecond precision on most platforms:\n\n[packages/react-reconciler/src/ReactProfilerTimer.js:43]()\n\n### Deep Equality Detection\n\nThe performance track system includes warnings for deeply equal props that might benefit from memoization:\n\n[packages/react-reconciler/src/ReactFiberPerformanceTrack.js:216-219](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:269-291]()\n\nThis detection is expensive and only runs in development mode.\n\n**Sources:** [packages/react-reconciler/src/ReactProfilerTimer.js:40-50](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:269-291]()\n\n---\n\n# Page: Server-Side Rendering\n\n# Server-Side Rendering\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightClient.js](packages/react-client/src/ReactFlightClient.js)\n- [packages/react-client/src/ReactFlightReplyClient.js](packages/react-client/src/ReactFlightReplyClient.js)\n- [packages/react-client/src/ReactFlightTemporaryReferences.js](packages/react-client/src/ReactFlightTemporaryReferences.js)\n- [packages/react-client/src/__tests__/ReactFlight-test.js](packages/react-client/src/__tests__/ReactFlight-test.js)\n- [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js](packages/react-dom-bindings/src/client/ReactDOMComponentTree.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js)\n- [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js](packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js](packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFloat-test.js](packages/react-dom/src/__tests__/ReactDOMFloat-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js](packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js](packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js)\n- [packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js](packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js)\n- [packages/react-dom/src/__tests__/ReactRenderDocument-test.js](packages/react-dom/src/__tests__/ReactRenderDocument-test.js)\n- [packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js](packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js](packages/react-dom/src/server/ReactDOMFizzServerBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBun.js](packages/react-dom/src/server/ReactDOMFizzServerBun.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerEdge.js](packages/react-dom/src/server/ReactDOMFizzServerEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerNode.js](packages/react-dom/src/server/ReactDOMFizzServerNode.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js](packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticEdge.js](packages/react-dom/src/server/ReactDOMFizzStaticEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticNode.js](packages/react-dom/src/server/ReactDOMFizzStaticNode.js)\n- [packages/react-markup/src/ReactFizzConfigMarkup.js](packages/react-markup/src/ReactFizzConfigMarkup.js)\n- [packages/react-noop-renderer/src/ReactNoopServer.js](packages/react-noop-renderer/src/ReactNoopServer.js)\n- [packages/react-reconciler/src/ReactFiberHydrationContext.js](packages/react-reconciler/src/ReactFiberHydrationContext.js)\n- [packages/react-server-dom-esm/src/ReactFlightESMReferences.js](packages/react-server-dom-esm/src/ReactFlightESMReferences.js)\n- [packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js](packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js)\n- [packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js](packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js)\n- [packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js](packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js)\n- [packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js](packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js)\n- [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js](packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js)\n- [packages/react-server/src/ReactFizzServer.js](packages/react-server/src/ReactFizzServer.js)\n- [packages/react-server/src/ReactFlightReplyServer.js](packages/react-server/src/ReactFlightReplyServer.js)\n- [packages/react-server/src/ReactFlightServer.js](packages/react-server/src/ReactFlightServer.js)\n- [packages/react-server/src/ReactFlightServerTemporaryReferences.js](packages/react-server/src/ReactFlightServerTemporaryReferences.js)\n- [packages/react-server/src/forks/ReactFizzConfig.custom.js](packages/react-server/src/forks/ReactFizzConfig.custom.js)\n- [scripts/error-codes/codes.json](scripts/error-codes/codes.json)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document provides an overview of React\'s server-side rendering capabilities, covering both **HTML streaming (Fizz)** and **Server Components (Flight)**. These two complementary systems enable React applications to render on the server and transmit the results to clients for hydration or consumption.\n\nFor detailed implementation of HTML streaming with Suspense boundaries, see [React Fizz (Streaming SSR)](#5.1). For Server Components serialization and the RSC protocol, see [React Server Components (Flight)](#5.2). For build system integration, see [Build Integration for Server Components](#5.3). For server actions and bidirectional communication, see [Server Actions and Bidirectional Communication](#5.4).\n\nThis page focuses on the high-level architecture, the relationship between Fizz and Flight, and the core request/response model shared by both systems.\n\n## The Two SSR Systems\n\nReact provides two distinct server-side rendering systems that serve different purposes:\n\n| System | Purpose | Output Format | Primary Use Case |\n|--------|---------|---------------|------------------|\n| **Fizz** | HTML Streaming SSR | HTML + JavaScript instructions | Traditional SSR with progressive hydration |\n| **Flight** | Server Components Serialization | Binary/JSON protocol (RSC wire format) | Server Components tree transmission |\n\n**Fizz** (`ReactFizzServer`) renders React components to HTML, streaming the output progressively with support for Suspense boundaries. It generates hydration instructions embedded in `<script>` tags to enable client-side React to attach to the server-rendered HTML.\n\n**Flight** (`ReactFlightServer`) serializes Server Component trees into a compact streaming protocol. It handles module references (Client Components) and streams chunks representing the component tree structure, allowing clients to reconstruct the React element tree without executing Server Component code.\n\nThese systems can be used independently or together. In React Server Components applications, Flight renders the Server Component tree, which may reference Client Components. When rendering to HTML, Fizz consumes the Flight stream and renders Client Components to HTML.\n\nSources: [packages/react-server/src/ReactFizzServer.js:1-100](), [packages/react-server/src/ReactFlightServer.js:1-100]()\n\n## Architecture Overview\n\n```mermaid\ngraph TB\n    subgraph "Server Environment"\n        SC["Server Components<br/>(React Server)"]\n        FlightServer["ReactFlightServer<br/>packages/react-server/src/ReactFlightServer.js"]\n        FizzServer["ReactFizzServer<br/>packages/react-server/src/ReactFizzServer.js"]\n    end\n    \n    subgraph "Network Layer"\n        FlightStream["Flight Stream<br/>RSC Protocol Chunks"]\n        HTMLStream["HTML Stream<br/>+ Hydration Instructions"]\n    end\n    \n    subgraph "Client Environment"\n        FlightClient["ReactFlightClient<br/>packages/react-client/src/ReactFlightClient.js"]\n        Hydration["ReactFiberHydrationContext<br/>Client-side Hydration"]\n        ClientComponents["Client Components<br/>(Browser React)"]\n    end\n    \n    SC -->|"serialize"| FlightServer\n    FlightServer -->|"stream chunks"| FlightStream\n    FlightStream -->|"deserialize"| FlightClient\n    FlightClient -->|"React elements"| ClientComponents\n    \n    SC -->|"render to HTML"| FizzServer\n    FizzServer -->|"stream HTML"| HTMLStream\n    HTMLStream -->|"hydrateRoot()"| Hydration\n    Hydration -->|"attach events"| ClientComponents\n    \n    FlightStream -.->|"integrated mode"| FizzServer\n```\n\n**Diagram: Server-Side Rendering Architecture**\n\nIn an integrated Server Components application, the flow works as follows:\n\n1. Server Components execute in the React Server environment\n2. Flight serializes the Server Component tree, including references to Client Components\n3. Fizz can consume the Flight stream and render Client Components to HTML\n4. The client receives both the HTML (for immediate display) and Flight chunks (for interactivity)\n5. Client-side React hydrates the HTML and processes Flight chunks to reconstruct the component tree\n\nSources: [packages/react-server/src/ReactFlightServer.js:1-200](), [packages/react-server/src/ReactFizzServer.js:1-200](), [packages/react-client/src/ReactFlightClient.js:1-200]()\n\n## Request and Response Model\n\nBoth Fizz and Flight use a request/response architecture with a task-based rendering model:\n\n```mermaid\ngraph LR\n    subgraph "Request Creation"\n        Model["ReactClientValue<br/>or ReactNodeList"]\n        CreateReq["createRequest()<br/>or createPrerenderRequest()"]\n        Req["Request Object"]\n    end\n    \n    subgraph "Request State"\n        Status["status: OPENING | OPEN<br/>| ABORTING | CLOSING | CLOSED"]\n        Tasks["pingedTasks: Array&lt;Task&gt;<br/>abortableTasks: Set&lt;Task&gt;"]\n        Chunks["completedChunks:<br/>Regular | Import | Hint | Error"]\n    end\n    \n    subgraph "Rendering Loop"\n        PerformWork["performWork(request)"]\n        RenderTask["renderTask(task)"]\n        EmitChunks["emitChunk() / writeChunk()"]\n    end\n    \n    subgraph "Output Destination"\n        Dest["Destination<br/>(Stream, WritableStream, etc)"]\n        FlushChunks["flushCompletedChunks()"]\n    end\n    \n    Model --> CreateReq\n    CreateReq --> Req\n    Req --> Status\n    Req --> Tasks\n    Req --> Chunks\n    \n    Tasks --> PerformWork\n    PerformWork --> RenderTask\n    RenderTask --> Chunks\n    Chunks --> FlushChunks\n    FlushChunks --> Dest\n```\n\n**Diagram: Request/Response Processing Model**\n\n### Request Types\n\nBoth systems define a `Request` type that maintains rendering state:\n\n**Fizz Request** [packages/react-server/src/ReactFizzServer.js:367-408]():\n- Manages HTML generation and Suspense boundaries\n- Tracks segments, boundaries, and preamble state\n- Coordinates progressive streaming of HTML chunks\n\n**Flight Request** [packages/react-server/src/ReactFlightServer.js:571-617]():\n- Manages serialization of Server Component trees\n- Tracks module references and serialized values\n- Coordinates streaming of protocol chunks\n\n### Request Lifecycle\n\n```mermaid\nstateDiagram-v2\n    [*] --> OPENING: createRequest()\n    OPENING --> OPEN: startWork()\n    OPEN --> OPEN: performWork()\n    OPEN --> ABORTING: abort()\n    OPEN --> CLOSING: all tasks complete\n    ABORTING --> CLOSED: cleanup\n    CLOSING --> CLOSED: flushCompleted()\n    CLOSED --> [*]\n```\n\n**Diagram: Request Status Lifecycle**\n\nSources: [packages/react-server/src/ReactFizzServer.js:360-554](), [packages/react-server/src/ReactFlightServer.js:527-841]()\n\n## Task-Based Rendering\n\nBoth systems use a task queue to manage rendering work:\n\n### Task Structure\n\n**Fizz Tasks** [packages/react-server/src/ReactFizzServer.js:279-331]():\n```\nRenderTask {\n  node: ReactNodeList          // Content to render\n  blockedSegment: Segment      // Output target\n  blockedBoundary: Root | SuspenseBoundary\n  keyPath: Root | KeyNode      // For tracking postponed content\n  formatContext: FormatContext // HTML/SVG/MathML context\n  thenableState: ThenableState // Suspense tracking\n}\n\nReplayTask {\n  replay: ReplaySet           // Resume from postponed state\n  node: ReactNodeList\n  blockedBoundary: Root | SuspenseBoundary\n  // Similar fields for context\n}\n```\n\n**Flight Tasks** [packages/react-server/src/ReactFlightServer.js:533-549]():\n```\nTask {\n  id: number\n  status: PENDING | COMPLETED | ABORTED | ERRORED | RENDERING\n  model: ReactClientValue      // Value to serialize\n  ping: () => void            // Resume after suspending\n  keyPath: ReactKey           // Parent component keys\n  formatContext: FormatContext\n  thenableState: ThenableState\n}\n```\n\n### Work Loop\n\nBoth systems process tasks in a similar pattern:\n\n1. **Dequeue**: Pop tasks from `request.pingedTasks`\n2. **Render**: Execute task rendering logic (`renderTask`)\n3. **Suspend**: On Suspense, create new task and await Promise\n4. **Complete**: Emit chunks/segments when tasks finish\n5. **Flush**: Write completed output to destination\n\nSources: [packages/react-server/src/ReactFizzServer.js:791-802](), [packages/react-server/src/ReactFlightServer.js:2420-2500]()\n\n## Streaming Output Formats\n\n### Fizz HTML Format\n\nFizz outputs HTML with embedded JavaScript instructions:\n\n```\n<!DOCTYPE html><html><head>...</head><body>\n<div>Server-rendered content</div>\n<!--$?--><template id="B:0"></template>\n<div>Fallback for suspended content...</div>\n<!--/$-->\n\n<script>\n$RC=function(b,c,e){/* completeBoundary runtime */};\n</script>\n<script>\n$RC("B:0","S:1")\n</script>\n```\n\nInstructions include:\n- `$RC`: Complete boundary (reveal suspended content)\n- `$RX`: Client render boundary (error fallback)\n- `$RS`: Complete segment\n- Form state markers for progressive enhancement\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:1-300]()\n\n### Flight Protocol Format\n\nFlight outputs newline-delimited chunks with a typed protocol:\n\n```\n0:{"id":"./ClientComponent.js#","chunks":["client123"],"name":"default"}\n1:I["module1","ClientComponent",123]\n2:{"type":"div","props":{"children":"Hello"}}\n3:@2\n```\n\nChunk types:\n- **Model row** (`id:json`): JSON-encoded value\n- **Module row** (`id:I[...]`): Client module reference\n- **Error row** (`id:E{...}`): Serialized error\n- **Reference** (`@id`): Pointer to another chunk\n- **Promise row** (`id:@...`): Async value placeholder\n- **Debug info** (`id:D{...}`): DEV-only metadata\n\nSources: [packages/react-server/src/ReactFlightServer.js:2700-3200](), [packages/react-client/src/ReactFlightClient.js:149-164]()\n\n## Request Creation APIs\n\n### Fizz APIs\n\n| Function | Purpose | Environment |\n|----------|---------|-------------|\n| `renderToPipeableStream()` | Node.js streams | server.node |\n| `renderToReadableStream()` | Web Streams API | server.browser, server.edge |\n| `renderToStaticMarkup()` | Non-interactive HTML | server.* |\n| `renderToString()` | Synchronous render | server.* |\n\n**Prerendering:**\n- `createPrerenderRequest()` [packages/react-server/src/ReactFizzServer.js:623-655](): Creates request that tracks postponed holes for resume\n- `resumeRequest()` [packages/react-server/src/ReactFizzServer.js:657-749](): Resumes from `PostponedState`\n\nSources: [packages/react-dom/src/server/ReactDOMFizzServerNode.js:1-300](), [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js:1-200]()\n\n### Flight APIs\n\n| Function | Purpose | Environment |\n|----------|---------|-------------|\n| `renderToReadableStream()` | Render to Web Stream | server.browser, server.edge, server.node |\n| `decodeReply()` | Decode form data/request body | server.* |\n| `decodeAction()` | Decode server action reference | server.* |\n\n**Prerendering:**\n- `createPrerenderRequest()` [packages/react-server/src/ReactFlightServer.js:811-841](): Creates request with `onAllReady` and `onFatalError` callbacks\n- Prerender can be resumed or converted to static output\n\nSources: [packages/react-server/src/ReactFlightServer.js:781-841]()\n\n## Integration Points\n\n### Fizz + Flight Integration\n\nWhen rendering Server Components to HTML:\n\n```mermaid\ngraph TB\n    subgraph "Server Render"\n        ServerComp["Server Component Tree"]\n        FlightRender["Flight: renderToReadableStream()"]\n        FlightStream["Flight Stream<br/>(RSC Protocol)"]\n    end\n    \n    subgraph "HTML Generation"\n        FizzConsume["Fizz consumes Flight stream"]\n        ClientCompRender["Render Client Components"]\n        HTMLOutput["HTML + Inline Flight Data"]\n    end\n    \n    subgraph "Client Hydration"\n        ParseHTML["Parse HTML"]\n        ReadFlight["Read inline Flight data"]\n        Reconstruct["Reconstruct component tree"]\n        Hydrate["hydrateRoot()"]\n    end\n    \n    ServerComp --> FlightRender\n    FlightRender --> FlightStream\n    FlightStream --> FizzConsume\n    FizzConsume --> ClientCompRender\n    ClientCompRender --> HTMLOutput\n    \n    HTMLOutput --> ParseHTML\n    HTMLOutput --> ReadFlight\n    ParseHTML --> Hydrate\n    ReadFlight --> Reconstruct\n    Reconstruct --> Hydrate\n```\n\n**Diagram: Integrated SSR with Server Components**\n\nThe Flight stream can be:\n1. **Embedded**: Serialized into `<script>` tags in HTML for immediate consumption\n2. **Separate**: Sent as a parallel stream for progressive enhancement\n3. **Preloaded**: Generated during build and embedded in HTML\n\nSources: [packages/react-server/src/ReactFizzServer.js:1-100](), [packages/react-server/src/ReactFlightServer.js:1-100]()\n\n### Host Configuration\n\nBoth systems use host configs for platform adaptation:\n\n**Fizz Host Config** [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js]():\n- HTML generation (`pushStartInstance`, `pushEndInstance`)\n- Resource management (scripts, stylesheets, preloads)\n- Streaming format (inline scripts vs external runtime)\n\n**Flight Host Config** [packages/react-server/src/ReactFlightServerConfig.js]():\n- Module reference resolution (`resolveClientReferenceMetadata`)\n- Bundler integration (`getClientReferenceKey`)\n- Request storage (`supportsRequestStorage`, `requestStorage`)\n\n## Error Handling and Suspense\n\nBoth systems handle errors and Suspense similarly:\n\n### Suspense Boundaries\n\n**Fizz** [packages/react-server/src/ReactFizzServer.js:804-849]():\n- Creates `SuspenseBoundary` with fallback content\n- Tracks pending tasks within boundary\n- Streams fallback immediately, content when ready\n- Emits completion instruction to reveal content\n\n**Flight** [packages/react-server/src/ReactFlightServer.js:1034-1136]():\n- Serializes Thenable as Promise reference\n- Creates task for resolved value\n- Client reconstructs async boundary\n\n### Error Recovery\n\nBoth systems:\n1. Catch errors during rendering\n2. Call `onError` callback with error info\n3. Emit error chunks/boundaries\n4. Allow client-side error boundaries to handle\n\nSources: [packages/react-server/src/ReactFizzServer.js:2100-2300](), [packages/react-server/src/ReactFlightServer.js:2600-2800]()\n\n## Performance Considerations\n\n### Progressive Streaming\n\n**Fizz** progressively flushes:\n- Shell (initial content) as soon as possible\n- Suspense boundaries when they resolve\n- Resources (scripts, styles) with proper priorities\n\n**Flight** streams:\n- Chunks as components complete\n- Lazy module references\n- Async boundaries incrementally\n\n### Chunking Strategy\n\n**Fizz** uses `progressiveChunkSize` [packages/react-server/src/ReactFizzServer.js:437]():\n- Default: 12,800 bytes (~500ms on 3G)\n- Controls when to flush buffered HTML\n\n**Flight** streams eagerly:\n- Emits chunks immediately when tasks complete\n- No configurable buffering (streams are already buffered)\n\nSources: [packages/react-server/src/ReactFizzServer.js:422-472](), [packages/react-server/src/ReactFlightServer.js:2420-2500]()\n\n## Feature Flags\n\nKey feature flags affecting SSR:\n\n| Flag | Impact |\n|------|--------|\n| `enableHalt` | Allows prerendering to halt on dynamic content |\n| `enablePostpone` | Enables postpone() API for incremental rendering |\n| `enableFizzExternalRuntime` | Uses external runtime script vs inline |\n| `enableAsyncDebugInfo` | Includes async stack traces in DEV |\n| `enableComponentPerformanceTrack` | Tracks component render timing |\n\nSources: [packages/shared/ReactFeatureFlags.js](), [packages/react-server/src/ReactFizzServer.js:177-187](), [packages/react-server/src/ReactFlightServer.js:14-20]()\n\n## Summary\n\nReact\'s server-side rendering encompasses two complementary systems:\n\n- **Fizz** handles HTML streaming with Suspense, progressive hydration, and resource management\n- **Flight** serializes Server Component trees for efficient client consumption\n\nBoth share a task-based rendering model with progressive streaming, Suspense support, and error recovery. They can operate independently or in an integrated mode where Flight output is consumed by Fizz to generate HTML with embedded RSC data.\n\nFor implementation details, see the child pages: [React Fizz (Streaming SSR)](#5.1) for HTML generation, [React Server Components (Flight)](#5.2) for the RSC protocol, [Build Integration for Server Components](#5.3) for bundler integration, and [Server Actions and Bidirectional Communication](#5.4) for client-to-server RPC.\n\n---\n\n# Page: React Fizz (Streaming SSR)\n\n# React Fizz (Streaming SSR)\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js](packages/react-dom-bindings/src/client/ReactDOMComponentTree.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js)\n- [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js](packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js](packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFloat-test.js](packages/react-dom/src/__tests__/ReactDOMFloat-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js](packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js](packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js)\n- [packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js](packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js)\n- [packages/react-dom/src/__tests__/ReactRenderDocument-test.js](packages/react-dom/src/__tests__/ReactRenderDocument-test.js)\n- [packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js](packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js](packages/react-dom/src/server/ReactDOMFizzServerBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBun.js](packages/react-dom/src/server/ReactDOMFizzServerBun.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerEdge.js](packages/react-dom/src/server/ReactDOMFizzServerEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerNode.js](packages/react-dom/src/server/ReactDOMFizzServerNode.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js](packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticEdge.js](packages/react-dom/src/server/ReactDOMFizzStaticEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticNode.js](packages/react-dom/src/server/ReactDOMFizzStaticNode.js)\n- [packages/react-markup/src/ReactFizzConfigMarkup.js](packages/react-markup/src/ReactFizzConfigMarkup.js)\n- [packages/react-noop-renderer/src/ReactNoopServer.js](packages/react-noop-renderer/src/ReactNoopServer.js)\n- [packages/react-reconciler/src/ReactFiberHydrationContext.js](packages/react-reconciler/src/ReactFiberHydrationContext.js)\n- [packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js](packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js)\n- [packages/react-server/src/ReactFizzServer.js](packages/react-server/src/ReactFizzServer.js)\n- [packages/react-server/src/forks/ReactFizzConfig.custom.js](packages/react-server/src/forks/ReactFizzConfig.custom.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nReact Fizz is the streaming server-side rendering (SSR) system that generates HTML progressively, sending content to the client as it becomes ready. This document covers the core Fizz rendering engine, its request/task/segment model, resource management, and platform-specific implementations for Node.js, Web streams, and static generation.\n\nFor information about React Server Components (RSC) and the Flight protocol, see [React Server Components (Flight)](#5.2). For client-side hydration, see [Hydration System](#6.3).\n\n## High-Level Architecture\n\nReact Fizz operates as a streaming HTML renderer that processes React elements and outputs HTML chunks incrementally. The system is platform-agnostic at its core, with platform-specific adapters for different streaming targets.\n\n**Fizz Architecture Overview**\n\n```mermaid\ngraph TB\n    subgraph "Entry Points"\n        NodeEntry["renderToPipeableStream<br/>(Node.js)"]\n        BrowserEntry["renderToReadableStream<br/>(Web Streams)"]\n        StaticEntry["prerender<br/>(Static Generation)"]\n    end\n    \n    subgraph "Core Engine (ReactFizzServer)"\n        CreateRequest["createRequest()<br/>createPrerenderRequest()<br/>resumeRequest()"]\n        StartWork["startWork()<br/>Process pingedTasks"]\n        PerformWork["performWork()<br/>Main work loop"]\n        RenderTask["renderNode()<br/>Component rendering"]\n    end\n    \n    subgraph "State Management"\n        Request["Request<br/>allPendingTasks<br/>pingedTasks<br/>completedBoundaries"]\n        Task["Task<br/>RenderTask | ReplayTask<br/>node, segment, boundary"]\n        Segment["Segment<br/>chunks, children<br/>status, boundary"]\n        Boundary["SuspenseBoundary<br/>pendingTasks<br/>completedSegments<br/>contentState/fallbackState"]\n    end\n    \n    subgraph "Output Management"\n        RenderState["RenderState<br/>hoistableChunks<br/>bootstrapChunks<br/>styles, scripts"]\n        ResumableState["ResumableState<br/>resumable resources<br/>idPrefix, nextFormID"]\n        FlushFunctions["writeCompletedRoot()<br/>writeCompletedBoundary()<br/>writeCompletedSegment()"]\n    end\n    \n    subgraph "Platform Streaming"\n        Destination["Destination<br/>(Writable | Controller)"]\n        StreamConfig["ReactServerStreamConfig<br/>writeChunk()<br/>scheduleWork()"]\n    end\n    \n    NodeEntry --> CreateRequest\n    BrowserEntry --> CreateRequest\n    StaticEntry --> CreateRequest\n    \n    CreateRequest --> Request\n    CreateRequest --> StartWork\n    StartWork --> PerformWork\n    PerformWork --> RenderTask\n    \n    RenderTask --> Task\n    Task --> Segment\n    Task --> Boundary\n    \n    Request --> RenderState\n    Request --> ResumableState\n    \n    PerformWork --> FlushFunctions\n    FlushFunctions --> StreamConfig\n    StreamConfig --> Destination\n    \n    Boundary --> RenderState\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:1-4000](), [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:1-500](), [packages/react-dom/src/server/ReactDOMFizzServerNode.js:1-300]()\n\n## Core Data Structures\n\n### Request\n\nThe `Request` is the top-level rendering context that tracks the entire SSR operation.\n\n**Request Structure**\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `destination` | `Destination \\| null` | Output stream target |\n| `resumableState` | `ResumableState` | Serializable state for resuming |\n| `renderState` | `RenderState` | Per-request working state |\n| `allPendingTasks` | `number` | Total tasks to complete |\n| `pendingRootTasks` | `number` | Tasks blocking shell completion |\n| `pingedTasks` | `Array<Task>` | High-priority tasks ready to work |\n| `completedBoundaries` | `Array<SuspenseBoundary>` | Boundaries ready to flush |\n| `clientRenderedBoundaries` | `Array<SuspenseBoundary>` | Errored boundaries |\n| `partialBoundaries` | `Array<SuspenseBoundary>` | Boundaries with partial content |\n| `abortableTasks` | `Set<Task>` | Tasks that can be aborted |\n| `trackedPostpones` | `PostponedHoles \\| null` | For prerendering resume |\n\nSources: [packages/react-server/src/ReactFizzServer.js:359-400]()\n\n### Task Types\n\nTasks represent units of work in the rendering pipeline. There are two types:\n\n**RenderTask vs ReplayTask**\n\n```mermaid\ngraph LR\n    subgraph "RenderTask"\n        RT_replay["replay: null"]\n        RT_node["node: ReactNodeList"]\n        RT_segment["blockedSegment: Segment"]\n        RT_boundary["blockedBoundary: Root|SuspenseBoundary"]\n        RT_render["Writes to segment.chunks"]\n    end\n    \n    subgraph "ReplayTask"\n        RPT_replay["replay: ReplaySet"]\n        RPT_node["node: ReactNodeList"]\n        RPT_segment["blockedSegment: null"]\n        RPT_boundary["blockedBoundary: Root|SuspenseBoundary"]\n        RPT_render["Validates against replay nodes"]\n    end\n    \n    RT_node --> RT_render\n    RT_segment --> RT_render\n    \n    RPT_replay --> RPT_render\n    RPT_node --> RPT_render\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:272-324]()\n\n### Segment\n\nA `Segment` represents a chunk of HTML output with its rendering status.\n\n**Segment Lifecycle**\n\n```mermaid\nstateDiagram-v2\n    [*] --> PENDING: createPendingSegment()\n    PENDING --> RENDERING: Start rendering\n    RENDERING --> COMPLETED: finishedTask()\n    RENDERING --> ERRORED: Error occurred\n    RENDERING --> POSTPONED: postponed()\n    RENDERING --> ABORTED: abortTask()\n    COMPLETED --> FLUSHED: flushSegment()\n    PENDING --> ABORTED: abortTask()\n```\n\n| Status | Value | Description |\n|--------|-------|-------------|\n| `PENDING` | 0 | Waiting to render |\n| `COMPLETED` | 1 | Rendered successfully |\n| `FLUSHED` | 2 | Written to destination |\n| `ABORTED` | 3 | Rendering canceled |\n| `ERRORED` | 4 | Error during rendering |\n| `POSTPONED` | 5 | Postponed for later |\n| `RENDERING` | 6 | Currently rendering |\n\nSources: [packages/react-server/src/ReactFizzServer.js:326-351]()\n\n### SuspenseBoundary\n\nA `SuspenseBoundary` manages Suspense boundaries, tracking pending work and managing fallback rendering.\n\n**SuspenseBoundary Fields**\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `status` | `0 \\| 1 \\| 4 \\| 5` | PENDING, COMPLETED, CLIENT_RENDERED, POSTPONED |\n| `rootSegmentID` | `number` | ID for boundary\'s root segment |\n| `pendingTasks` | `number` | Tasks blocking completion |\n| `completedSegments` | `Array<Segment>` | Ready but not flushed |\n| `byteSize` | `number` | Total size for inlining decisions |\n| `defer` | `boolean` | Never inline deferred boundaries |\n| `contentState` | `HoistableState` | Resources for content |\n| `fallbackState` | `HoistableState` | Resources for fallback |\n| `fallbackAbortableTasks` | `Set<Task>` | Cancel if content completes |\n| `errorDigest` | `?string` | Error hash if errored |\n\nSources: [packages/react-server/src/ReactFizzServer.js:248-270]()\n\n## Rendering Pipeline\n\nThe rendering pipeline flows from request creation through task processing to HTML output.\n\n**Complete Rendering Flow**\n\n```mermaid\ngraph TB\n    subgraph "1. Initialization"\n        Create["createRequest(children, options)"]\n        RootSegment["createPendingSegment()<br/>Root segment"]\n        RootTask["createRenderTask()<br/>Initial task"]\n        PushTask["pingedTasks.push(rootTask)"]\n    end\n    \n    subgraph "2. Work Loop"\n        StartWork["startWork(request)"]\n        PerformWork["performWork(request)"]\n        ProcessTask["processTask(task)"]\n        RenderNode["renderNode(request, task, node)"]\n    end\n    \n    subgraph "3. Component Rendering"\n        CheckType["Check node type<br/>(Element, Suspense, etc.)"]\n        RenderElement["renderElement(task, type, props)"]\n        RenderSuspense["renderSuspenseBoundary(task, props)"]\n        RenderText["pushTextInstance(target, text)"]\n    end\n    \n    subgraph "4. Segment Completion"\n        FinishTask["finishedTask(request, boundary, segment)"]\n        CompleteSegment["segment.status = COMPLETED"]\n        DecrementPending["boundary.pendingTasks--"]\n        CheckBoundary["pendingTasks === 0?"]\n    end\n    \n    subgraph "5. Boundary Completion"\n        CompleteBoundary["boundary.status = COMPLETED"]\n        QueueBoundary["completedBoundaries.push(boundary)"]\n        FlushBoundary["flushCompletedBoundary()"]\n    end\n    \n    subgraph "6. Output"\n        WriteInstructions["writeCompletedBoundaryInstruction()"]\n        WriteSegments["writeCompletedSegmentInstruction()"]\n        FlushDestination["flushBuffered(destination)"]\n    end\n    \n    Create --> RootSegment\n    RootSegment --> RootTask\n    RootTask --> PushTask\n    PushTask --> StartWork\n    \n    StartWork --> PerformWork\n    PerformWork --> ProcessTask\n    ProcessTask --> RenderNode\n    \n    RenderNode --> CheckType\n    CheckType --> RenderElement\n    CheckType --> RenderSuspense\n    CheckType --> RenderText\n    \n    RenderElement --> FinishTask\n    FinishTask --> CompleteSegment\n    CompleteSegment --> DecrementPending\n    DecrementPending --> CheckBoundary\n    \n    CheckBoundary -->|Yes| CompleteBoundary\n    CompleteBoundary --> QueueBoundary\n    QueueBoundary --> FlushBoundary\n    \n    FlushBoundary --> WriteInstructions\n    WriteInstructions --> WriteSegments\n    WriteSegments --> FlushDestination\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:548-800](), [packages/react-server/src/ReactFizzServer.js:1600-2000]()\n\n## Task Scheduling and Execution\n\n### Task Creation\n\nTasks are created when starting rendering or when Suspense boundaries need to render their content or fallback.\n\n**Task Creation Functions**\n\n```mermaid\ngraph LR\n    subgraph "Task Factories"\n        CreateRenderTask["createRenderTask()<br/>Regular rendering"]\n        CreateReplayTask["createReplayTask()<br/>Resume rendering"]\n    end\n    \n    subgraph "Task Properties"\n        Node["node: ReactNodeList<br/>What to render"]\n        Segment["blockedSegment: Segment<br/>Where to write (render only)"]\n        Boundary["blockedBoundary: Root|SuspenseBoundary<br/>Parent boundary"]\n        Context["context: ContextSnapshot<br/>treeContext, legacyContext"]\n        FormatContext["formatContext: FormatContext<br/>HTML/SVG/MathML context"]\n        KeyPath["keyPath: Root|KeyNode<br/>Component key path"]\n    end\n    \n    subgraph "Task Lifecycle"\n        AddToAbortSet["abortSet.add(task)"]\n        IncrementPending["allPendingTasks++<br/>boundary.pendingTasks++"]\n        PingTask["pingTask(request, task)<br/>Schedule work"]\n    end\n    \n    CreateRenderTask --> Node\n    CreateRenderTask --> Segment\n    CreateReplayTask --> Node\n    \n    Node --> AddToAbortSet\n    Segment --> IncrementPending\n    Boundary --> IncrementPending\n    IncrementPending --> PingTask\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:843-953]()\n\n### performWork Loop\n\nThe `performWork` function is the main work loop that processes tasks and flushes output.\n\n**performWork Execution**\n\n```mermaid\ngraph TB\n    Entry["performWork(request)"]\n    \n    subgraph "Task Processing"\n        CheckStatus["request.status === OPEN?"]\n        PopTask["task = pingedTasks.pop()"]\n        HasTask["task !== undefined?"]\n        \n        SetCurrentRequest["currentRequest = request"]\n        RenderWithResumeId["renderNodeWithResumeId(request, task)"]\n        \n        RerenderTask["Try rerender task<br/>if it suspended"]\n        ClearCurrentRequest["currentRequest = null"]\n    end\n    \n    subgraph "Flushing Boundaries"\n        FlushClientRendered["flushClientRenderedBoundaries()<br/>Error boundaries"]\n        FlushCompleted["flushCompletedBoundaries()<br/>Ready boundaries"]\n        FlushPartial["flushPartialBoundaries()<br/>Partial boundaries"]\n    end\n    \n    subgraph "Completion"\n        AllComplete["allPendingTasks === 0?"]\n        CloseRequest["request.status = CLOSED<br/>close(destination)"]\n        FlushHeaders["flushHeaders()<br/>Send Link headers"]\n    end\n    \n    Entry --> CheckStatus\n    CheckStatus -->|Yes| PopTask\n    PopTask --> HasTask\n    HasTask -->|Yes| SetCurrentRequest\n    SetCurrentRequest --> RenderWithResumeId\n    RenderWithResumeId --> RerenderTask\n    RerenderTask --> ClearCurrentRequest\n    ClearCurrentRequest --> PopTask\n    \n    HasTask -->|No| FlushClientRendered\n    FlushClientRendered --> FlushCompleted\n    FlushCompleted --> FlushPartial\n    FlushPartial --> AllComplete\n    \n    AllComplete -->|Yes| CloseRequest\n    CloseRequest --> FlushHeaders\n    \n    CheckStatus -->|No| FlushHeaders\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:2800-3000]()\n\n### renderNode Dispatch\n\nThe `renderNode` function dispatches to specialized rendering logic based on node type.\n\n**Node Type Dispatch**\n\n| Node Type | Symbol | Rendering Function |\n|-----------|--------|-------------------|\n| React Element | `REACT_ELEMENT_TYPE` | `renderElement(request, task, type, props, ref)` |\n| Lazy Component | `REACT_LAZY_TYPE` | `renderLazyComponent(request, task, lazyComponent)` |\n| Suspense | `REACT_SUSPENSE_TYPE` | `renderSuspenseBoundary(request, task, props)` |\n| SuspenseList | `REACT_SUSPENSE_LIST_TYPE` | `renderSuspenseList(request, task, props)` |\n| Fragment | `REACT_FRAGMENT_TYPE` | `renderNodeFragment(request, task, children)` |\n| Provider | `REACT_CONTEXT_TYPE` | `pushProvider(context, value)` |\n| Forward Ref | `REACT_FORWARD_REF_TYPE` | `renderForwardRef(request, task, render, props, ref)` |\n| Memo | `REACT_MEMO_TYPE` | `renderMemo(request, task, type, props)` |\n| Portal | `REACT_PORTAL_TYPE` | Error - not supported |\n| String/Number | primitive | `pushTextInstance(segment, text)` |\n| Array | `isArray(node)` | `renderChildrenArray(request, task, children)` |\n| Async Iterable | `node[ASYNC_ITERATOR]` | `renderAsyncIterable(request, task, iterable)` |\n\nSources: [packages/react-server/src/ReactFizzServer.js:1800-2400]()\n\n## Suspense Boundary Management\n\nSuspense boundaries enable streaming and progressive rendering by allowing parts of the tree to suspend while other parts complete.\n\n**Suspense Boundary Rendering Flow**\n\n```mermaid\ngraph TB\n    subgraph "Boundary Setup"\n        CreateBoundary["createSuspenseBoundary(request, row, fallbackTasks, defer)"]\n        ContentSegment["Create content segment<br/>segment.boundary = boundary"]\n        FallbackSegment["Create fallback segment"]\n        \n        ContentTask["createRenderTask(content)<br/>boundary.pendingTasks++"]\n        FallbackTask["createRenderTask(fallback)<br/>fallbackAbortableTasks.add()"]\n    end\n    \n    subgraph "Content Rendering"\n        RenderContent["Render content children"]\n        ContentSuspends["Content suspends?"]\n        ContentComplete["Content completes<br/>boundary.pendingTasks--"]\n    end\n    \n    subgraph "Boundary States"\n        Pending["PENDING<br/>Still waiting"]\n        Completed["COMPLETED<br/>Content ready<br/>cancelFallbackTasks()"]\n        ClientRendered["CLIENT_RENDERED<br/>Error occurred"]\n    end\n    \n    subgraph "Output Decision"\n        CheckEligible["isEligibleForOutlining()<br/>byteSize > 500"]\n        Inline["Inline content<br/>Write directly"]\n        Outline["Outline boundary<br/>Write template + script"]\n    end\n    \n    CreateBoundary --> ContentSegment\n    CreateBoundary --> FallbackSegment\n    ContentSegment --> ContentTask\n    FallbackSegment --> FallbackTask\n    \n    ContentTask --> RenderContent\n    RenderContent --> ContentSuspends\n    ContentSuspends -->|Yes| Pending\n    ContentSuspends -->|No| ContentComplete\n    \n    ContentComplete --> Completed\n    Completed --> CheckEligible\n    \n    CheckEligible -->|Small| Inline\n    CheckEligible -->|Large| Outline\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:796-841](), [packages/react-server/src/ReactFizzServer.js:2500-2700]()\n\n### Boundary Completion and Flushing\n\nWhen a boundary completes, it moves through queues before being flushed to the output.\n\n**Boundary Flush Process**\n\n```mermaid\ngraph LR\n    subgraph "Completion"\n        DecPending["boundary.pendingTasks--"]\n        CheckZero["pendingTasks === 0?"]\n        SetCompleted["boundary.status = COMPLETED"]\n    end\n    \n    subgraph "Queueing"\n        QueueCompleted["completedBoundaries.push(boundary)"]\n        CheckShell["Shell completed?"]\n        QueuePartial["partialBoundaries.push(boundary)"]\n    end\n    \n    subgraph "Flushing"\n        FlushCompleted["flushCompletedBoundary(request, destination, boundary)"]\n        WriteStart["writeStartCompletedSuspenseBoundary()"]\n        WriteSegments["Write all completedSegments"]\n        WriteEnd["writeEndCompletedSuspenseBoundary()"]\n        WriteInstruction["writeCompletedBoundaryInstruction(boundaryID, contentSegmentID)"]\n    end\n    \n    DecPending --> CheckZero\n    CheckZero -->|Yes| SetCompleted\n    SetCompleted --> CheckShell\n    CheckShell -->|Complete| QueueCompleted\n    CheckShell -->|Not complete| QueuePartial\n    \n    QueueCompleted --> FlushCompleted\n    FlushCompleted --> WriteStart\n    WriteStart --> WriteSegments\n    WriteSegments --> WriteEnd\n    WriteEnd --> WriteInstruction\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:3200-3500]()\n\n## Resource Management\n\nReact Fizz manages resources (scripts, stylesheets, preloads) through the `RenderState` and `ResumableState` structures to optimize loading and prevent duplicates.\n\n**Resource State Architecture**\n\n```mermaid\ngraph TB\n    subgraph "ResumableState (Serializable)"\n        DNS["dnsResources: {[key]: Exists}<br/>DNS prefetches"]\n        Connect["connectResources:<br/>default/anonymous/credentials<br/>{[key]: Exists}"]\n        Style["styleResources: {[key]: Exists|Preloaded}"]\n        Script["scriptResources: {[key]: Exists|Preloaded}"]\n        ModuleScript["moduleScriptResources: {[key]: Exists|Preloaded}"]\n        Image["imageResources: {[key]: Preloaded}"]\n    end\n    \n    subgraph "RenderState (Per-Request)"\n        Preconnects["preconnects: Set<Resource><br/>Flush early"]\n        FontPreloads["fontPreloads: Set<Resource><br/>Flush early"]\n        HighImagePreloads["highImagePreloads: Set<Resource><br/>Flush early"]\n        Styles["styles: Map<string, StyleQueue><br/>Stylesheets + dependencies"]\n        Scripts["scripts: Set<Resource><br/>Script tags"]\n        BulkPreloads["bulkPreloads: Set<Resource><br/>Regular preloads"]\n    end\n    \n    subgraph "HoistableState (Per-Boundary)"\n        BoundaryStyles["styles: Set<string><br/>Required stylesheets"]\n        BoundaryScripts["scripts: Set<string><br/>Required scripts"]\n    end\n    \n    subgraph "Headers"\n        HeadersObj["headers: {<br/>preconnects: string,<br/>fontPreloads: string,<br/>highImagePreloads: string,<br/>remainingCapacity: number<br/>}"]\n        OnHeaders["onHeaders(headers: HeadersDescriptor)"]\n    end\n    \n    DNS --> Preconnects\n    Connect --> Preconnects\n    Style --> Styles\n    Script --> Scripts\n    Image --> HighImagePreloads\n    \n    Styles --> BoundaryStyles\n    Scripts --> BoundaryScripts\n    \n    Preconnects --> HeadersObj\n    FontPreloads --> HeadersObj\n    HighImagePreloads --> HeadersObj\n    HeadersObj --> OnHeaders\n```\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:260-310](), [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:148-234]()\n\n### Resource Deduplication\n\nResources are tracked in `ResumableState` to prevent duplicate output across boundaries and resume scenarios.\n\n**Resource Tracking Types**\n\n| Type | Tracked By | Values |\n|------|-----------|--------|\n| DNS Prefetch | `href` | `EXISTS` (null) |\n| Preconnect | `href` + `crossOrigin` | `EXISTS` (null) |\n| Stylesheet | `href` | `EXISTS` \\| `[crossOrigin, integrity]` |\n| Script | `src` | `EXISTS` \\| `[crossOrigin, integrity]` |\n| Module | `src` | `EXISTS` \\| `[crossOrigin, integrity]` |\n| Image Preload | `href` + `imageSrcSet` + `imageSizes` | `[]` (empty array) |\n| Font Preload | `href` | `[]` (empty array) |\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:236-258]()\n\n### Resource Flushing Order\n\nResources are flushed in a specific order to optimize page load performance.\n\n**Resource Flush Sequence**\n\n```mermaid\ngraph TB\n    Start["Start Flushing"]\n    \n    subgraph "Shell Phase"\n        Charset["1. charsetChunks<br/><meta charset>"]\n        Viewport["2. viewportChunks<br/><meta viewport>"]\n        EarlyPreconnects["3. preconnects (Set)<br/><link rel=preconnect>"]\n        EarlyFontPreloads["4. fontPreloads (Set)<br/><link rel=preload as=font>"]\n        EarlyImagePreloads["5. highImagePreloads (Set)<br/><link rel=preload as=image fetchpriority=high>"]\n        Hoistables["6. hoistableChunks<br/>Other <link>/<meta> tags"]\n    end\n    \n    subgraph "Boundary Phase"\n        BoundaryStyles["7. Boundary styles<br/>writeHoistablesForBoundary()"]\n        BoundaryScripts["8. Boundary scripts<br/>Required dependencies"]\n    end\n    \n    subgraph "Late Resources"\n        BulkPreloads["9. bulkPreloads<br/>Regular priority preloads"]\n        BootstrapScripts["10. bootstrapScripts<br/>Application initialization"]\n    end\n    \n    Start --> Charset\n    Charset --> Viewport\n    Viewport --> EarlyPreconnects\n    EarlyPreconnects --> EarlyFontPreloads\n    EarlyFontPreloads --> EarlyImagePreloads\n    EarlyImagePreloads --> Hoistables\n    Hoistables --> BoundaryStyles\n    BoundaryStyles --> BoundaryScripts\n    BoundaryScripts --> BulkPreloads\n    BulkPreloads --> BootstrapScripts\n```\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:3800-4200]()\n\n## Platform-Specific Implementations\n\nReact Fizz has multiple entry points for different JavaScript environments, each adapting the core engine to platform-specific streaming APIs.\n\n**Platform Entry Points**\n\n```mermaid\ngraph TB\n    subgraph "Node.js"\n        NodeEntry["ReactDOMFizzServerNode.js<br/>renderToPipeableStream()"]\n        NodeStream["Node Writable Stream"]\n        NodeDestination["Destination = Writable"]\n    end\n    \n    subgraph "Web Browsers / Workers"\n        BrowserEntry["ReactDOMFizzServerBrowser.js<br/>renderToReadableStream()"]\n        WebStream["ReadableStream (Web Streams API)"]\n        WebDestination["Destination = ReadableStreamController"]\n    end\n    \n    subgraph "Edge Runtime"\n        EdgeEntry["ReactDOMFizzServerEdge.js<br/>renderToReadableStream()"]\n        EdgeStream["ReadableStream"]\n    end\n    \n    subgraph "Bun Runtime"\n        BunEntry["ReactDOMFizzServerBun.js<br/>renderToReadableStream()"]\n        BunStream["ReadableStream"]\n    end\n    \n    subgraph "Static Generation"\n        StaticNode["ReactDOMFizzStaticNode.js<br/>prerender()"]\n        StaticBrowser["ReactDOMFizzStaticBrowser.js<br/>prerender()"]\n        StaticEdge["ReactDOMFizzStaticEdge.js<br/>prerender()"]\n        PrerenderRequest["createPrerenderRequest()<br/>trackedPostpones"]\n    end\n    \n    subgraph "Core Engine"\n        FizzServer["ReactFizzServer.js<br/>createRequest()<br/>performWork()"]\n        StreamConfig["ReactServerStreamConfig<br/>writeChunk()<br/>scheduleWork()"]\n    end\n    \n    NodeEntry --> NodeStream\n    NodeStream --> NodeDestination\n    NodeDestination --> FizzServer\n    \n    BrowserEntry --> WebStream\n    WebStream --> WebDestination\n    WebDestination --> FizzServer\n    \n    EdgeEntry --> EdgeStream\n    BunEntry --> BunStream\n    EdgeStream --> FizzServer\n    BunStream --> FizzServer\n    \n    StaticNode --> PrerenderRequest\n    StaticBrowser --> PrerenderRequest\n    StaticEdge --> PrerenderRequest\n    PrerenderRequest --> FizzServer\n    \n    FizzServer --> StreamConfig\n```\n\nSources: [packages/react-dom/src/server/ReactDOMFizzServerNode.js:1-300](), [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js:1-200](), [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js:1-200]()\n\n### Node.js: renderToPipeableStream\n\nThe Node.js implementation uses Node\'s `Writable` stream interface with backpressure support.\n\n**Node.js Streaming Flow**\n\n```mermaid\ngraph LR\n    subgraph "API"\n        Render["renderToPipeableStream(children, options)"]\n        PipeableStream["PipeableStream<br/>{pipe, abort}"]\n    end\n    \n    subgraph "Setup"\n        CreateReq["createRequestImpl()<br/>createResumableState()<br/>createRenderState()"]\n        StartWork["startWork(request)"]\n    end\n    \n    subgraph "Streaming"\n        Pipe["pipe(destination: Writable)"]\n        DrainHandler["\'drain\' event<br/>startFlowing()"]\n        ErrorHandler["\'error\' event<br/>abort()"]\n        CloseHandler["\'close\' event<br/>abort()"]\n    end\n    \n    subgraph "Callbacks"\n        OnShellReady["onShellReady()<br/>Initial HTML ready"]\n        OnAllReady["onAllReady()<br/>All content ready"]\n        OnShellError["onShellError(error)<br/>Shell failed"]\n    end\n    \n    Render --> CreateReq\n    CreateReq --> StartWork\n    StartWork --> PipeableStream\n    \n    PipeableStream --> Pipe\n    Pipe --> DrainHandler\n    Pipe --> ErrorHandler\n    Pipe --> CloseHandler\n    \n    StartWork --> OnShellReady\n    StartWork --> OnAllReady\n    StartWork --> OnShellError\n```\n\nSources: [packages/react-dom/src/server/ReactDOMFizzServerNode.js:131-166]()\n\n### Browser/Edge: renderToReadableStream\n\nThe browser implementation uses the Web Streams API\'s `ReadableStream` with a bytes source.\n\n**Web Streams Flow**\n\n```mermaid\ngraph LR\n    subgraph "API"\n        Render["renderToReadableStream(children, options)"]\n        Promise["Promise<ReactDOMServerReadableStream>"]\n        ReadableStream["ReadableStream & {allReady: Promise}"]\n    end\n    \n    subgraph "Controller"\n        BytesSource["ReadableStream({type: \'bytes\'})"]\n        Pull["pull(controller)<br/>startFlowing(request, controller)"]\n        Cancel["cancel(reason)<br/>abort(request, reason)"]\n    end\n    \n    subgraph "Promises"\n        ShellPromise["Shell promise<br/>resolve(stream)"]\n        AllReadyPromise["allReady promise<br/>resolve when done"]\n    end\n    \n    subgraph "Error Handling"\n        OnShellReady["onShellReady()<br/>resolve shell promise"]\n        OnShellError["onShellError(error)<br/>reject shell promise"]\n        OnFatalError["onFatalError(error)<br/>reject allReady"]\n    end\n    \n    Render --> BytesSource\n    BytesSource --> Pull\n    BytesSource --> Cancel\n    \n    Pull --> OnShellReady\n    OnShellReady --> ShellPromise\n    ShellPromise --> Promise\n    Promise --> ReadableStream\n    \n    ReadableStream --> AllReadyPromise\n    OnFatalError --> AllReadyPromise\n```\n\nSources: [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js:75-165]()\n\n## Prerendering and Resumability\n\nPrerendering generates static HTML while tracking postponed boundaries for later resumption.\n\n**Prerender Architecture**\n\n```mermaid\ngraph TB\n    subgraph "Prerender Request"\n        CreatePrerender["createPrerenderRequest(children)<br/>trackedPostpones = {<br/>  workingMap: Map<KeyNode, ReplayNode>,<br/>  rootNodes: Array<ReplayNode>,<br/>  rootSlots: ResumeSlots<br/>}"]\n    end\n    \n    subgraph "Tracking Postponed Holes"\n        ComponentKey["keyPath: Root|KeyNode<br/>Unique path in tree"]\n        ReplayNode["ReplayNode<br/>[name, key, children, slots]"]\n        ReplaySuspense["ReplaySuspenseBoundary<br/>[name, key, children, contentSlots, fallback, rootSegmentID]"]\n        WorkingMap["workingMap.set(keyPath, replayNode)"]\n    end\n    \n    subgraph "Completion"\n        PostponedState["getPostponedState(request)<br/>{<br/>  replayNodes,<br/>  replaySlots,<br/>  resumableState,<br/>  nextSegmentId,<br/>  ...formatContext<br/>}"]\n    end\n    \n    subgraph "Resume"\n        ResumeRequest["resumeRequest(children, postponedState)<br/>OR<br/>resumeAndPrerenderRequest(children, postponedState)"]\n        CreateReplayTasks["createReplayTask(replay: ReplaySet)<br/>Validates against tracked nodes"]\n        ReplayContinue["Continue from postponed holes"]\n    end\n    \n    CreatePrerender --> ComponentKey\n    ComponentKey --> ReplayNode\n    ReplayNode --> ReplaySuspense\n    ReplaySuspense --> WorkingMap\n    WorkingMap --> PostponedState\n    \n    PostponedState --> ResumeRequest\n    ResumeRequest --> CreateReplayTasks\n    CreateReplayTasks --> ReplayContinue\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:615-770]()\n\n### PostponedState Structure\n\nThe `PostponedState` captures everything needed to resume rendering from postponed boundaries.\n\n**PostponedState Fields**\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `replayNodes` | `Array<ReplayNode>` | Tree of tracked component keys |\n| `replaySlots` | `ResumeSlots` | Segment IDs to resume |\n| `resumableState` | `ResumableState` | Resource state to continue |\n| `nextSegmentId` | `number` | Next available segment ID |\n| `rootFormatContext` | `FormatContext` | HTML/SVG/MathML context |\n| `progressiveChunkSize` | `number` | Chunk size setting |\n\nSources: [packages/react-server/src/ReactFizzServer.js:3900-4000]()\n\n### ReplayTask Validation\n\nWhen resuming, `ReplayTask` instances validate that the component tree matches the tracked structure.\n\n**Replay Validation Flow**\n\n```mermaid\ngraph TB\n    RenderReplay["renderNode(request, task, node)<br/>task.replay !== null"]\n    \n    subgraph "Key Matching"\n        GetKey["getKeyPath(task)"]\n        FindReplayNode["Find matching ReplayNode<br/>in replay.nodes"]\n        KeyMatches["Keys match?"]\n    end\n    \n    subgraph "Suspense Handling"\n        IsSuspense["Is Suspense boundary?"]\n        ReplaySuspenseBoundary["Cast to ReplaySuspenseBoundary"]\n        ResumeChildren["Create ReplayTask for children"]\n        ResumeFallback["Track fallback if present"]\n    end\n    \n    subgraph "Error Cases"\n        NoMatch["No matching ReplayNode"]\n        AbortReplay["Abort replay<br/>Client render boundary"]\n    end\n    \n    RenderReplay --> GetKey\n    GetKey --> FindReplayNode\n    FindReplayNode --> KeyMatches\n    \n    KeyMatches -->|Yes| IsSuspense\n    KeyMatches -->|No| NoMatch\n    NoMatch --> AbortReplay\n    \n    IsSuspense -->|Yes| ReplaySuspenseBoundary\n    ReplaySuspenseBoundary --> ResumeChildren\n    ReplaySuspenseBoundary --> ResumeFallback\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:1900-2100]()\n\n## Streaming Format and Instructions\n\nReact Fizz can output HTML in two formats: inline scripts or data attributes with an external runtime.\n\n**Streaming Formats**\n\n| Format | Value | Configuration | Use Case |\n|--------|-------|---------------|----------|\n| `ScriptStreamingFormat` | 0 | Default | Inline instructions in `<script>` tags |\n| `DataStreamingFormat` | 1 | `unstable_externalRuntimeSrc` | Instructions via data attributes, separate runtime |\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:122-124]()\n\n### Instruction State Bits\n\nThe `InstructionState` tracks which instructions have been sent to avoid duplication.\n\n**InstructionState Flags**\n\n| Flag | Bit | Purpose |\n|------|-----|---------|\n| `SentCompleteSegmentFunction` | 0b000000001 | `completeSegment` function sent |\n| `SentCompleteBoundaryFunction` | 0b000000010 | `completeBoundary` function sent |\n| `SentClientRenderFunction` | 0b000000100 | `clientRenderBoundary` function sent |\n| `SentStyleInsertionFunction` | 0b000001000 | `completeBoundaryWithStyles` sent |\n| `SentFormReplayingRuntime` | 0b000010000 | Form replaying runtime sent |\n| `SentCompletedShellId` | 0b000100000 | Shell completion marker sent |\n| `SentMarkShellTime` | 0b001000000 | Shell timing marker sent |\n| `NeedUpgradeToViewTransitions` | 0b010000000 | View transitions needed |\n| `SentUpgradeToViewTransitions` | 0b100000000 | View transition upgrade sent |\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:127-136]()\n\n### Boundary Completion Instructions\n\nWhen a boundary completes, an inline script or data attribute instructs the client to reveal the content.\n\n**Boundary Instruction Output**\n\n```mermaid\ngraph LR\n    subgraph "Inline Script Format"\n        ScriptStart["<script>"]\n        FunctionCall["$RC(boundaryID, contentSegmentID)"]\n        ScriptEnd["</script>"]\n    end\n    \n    subgraph "Data Attribute Format"\n        Template["<template id=B:boundaryID"]\n        DataAttr["data-dgst=errorDigest"]\n        DataRender["data-msg=errorMessage"]\n        TemplateEnd["></template>"]\n    end\n    \n    subgraph "Client Processing"\n        Runtime["React runtime on client"]\n        RevealContent["Reveal completed content"]\n        RemoveFallback["Remove fallback"]\n    end\n    \n    ScriptStart --> FunctionCall\n    FunctionCall --> ScriptEnd\n    ScriptEnd --> Runtime\n    \n    Template --> DataAttr\n    DataAttr --> DataRender\n    DataRender --> TemplateEnd\n    TemplateEnd --> Runtime\n    \n    Runtime --> RevealContent\n    RevealContent --> RemoveFallback\n```\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:4500-4700]()\n\n## Error Handling and Recovery\n\nReact Fizz handles errors at different levels with different recovery strategies.\n\n**Error Handling Hierarchy**\n\n```mermaid\ngraph TB\n    subgraph "Error Types"\n        RootError["Root Error<br/>No error boundary"]\n        BoundaryError["Boundary Error<br/>Within Suspense"]\n        FallbackError["Fallback Error<br/>Within fallback"]\n    end\n    \n    subgraph "Root Error Handling"\n        RootAbort["Abort entire request"]\n        RejectPromise["Reject entry point promise"]\n        CloseWithError["closeWithError(destination, error)"]\n    end\n    \n    subgraph "Boundary Error Handling"\n        MarkClientRendered["boundary.status = CLIENT_RENDERED<br/>boundary.errorDigest = digest"]\n        QueueClientRender["clientRenderedBoundaries.push(boundary)"]\n        FlushClientRender["writeClientRenderBoundaryInstruction(boundaryID, digest, message)"]\n    end\n    \n    subgraph "Error Callbacks"\n        OnError["onError(error, errorInfo)<br/>Returns error digest"]\n        OnShellError["onShellError(error)<br/>Called for shell errors"]\n        OnFatalError["onFatalError(error)<br/>Called for unrecoverable errors"]\n    end\n    \n    RootError --> RootAbort\n    RootAbort --> OnShellError\n    RootAbort --> OnFatalError\n    RootAbort --> RejectPromise\n    RejectPromise --> CloseWithError\n    \n    BoundaryError --> MarkClientRendered\n    MarkClientRendered --> OnError\n    OnError --> QueueClientRender\n    QueueClientRender --> FlushClientRender\n    \n    FallbackError --> RootAbort\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:3600-3800]()\n\n### Error Information\n\nThe `onError` callback receives detailed error information for logging and monitoring.\n\n**ErrorInfo Structure**\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `componentStack` | `string` | Component stack trace |\n| `error` | `mixed` | The thrown error object |\n| `errorInfo.digest` | `?string` | Error hash for client matching |\n\nSources: [packages/react-server/src/ReactFizzServer.js:384-400]()\n\n## Performance Optimizations\n\n### Progressive Chunk Size\n\nThe `progressiveChunkSize` option controls how much HTML is buffered before flushing.\n\n**Default Chunk Size Calculation**\n\nThe default of 12,800 bytes is based on:\n- 3G network speed: ~500 kbits/second\n- Target: Send content every 500ms\n- 500ms  (500 kbits/s)  0.8 (realistic throughput)  0.5 (HTML overhead) / 2 = 12.5kb\n\nSources: [packages/react-server/src/ReactFizzServer.js:414-429]()\n\n### Boundary Inlining\n\nSmall boundaries can be inlined directly instead of being outlined with separate instructions.\n\n**Outlining Eligibility**\n\n```javascript\nfunction isEligibleForOutlining(request, boundary) {\n  return (\n    (boundary.byteSize > 500 ||\n      hasSuspenseyContent(boundary.contentState) ||\n      boundary.defer) &&\n    boundary.preamble === null\n  );\n}\n```\n\n- Boundaries < 500 bytes: Inlined\n- Boundaries  500 bytes: Outlined with instructions\n- Defer boundaries: Always outlined\n- Preamble boundaries: Never outlined (for render-blocking)\n\nSources: [packages/react-server/src/ReactFizzServer.js:466-482]()\n\n### Early Headers\n\nThe `onHeaders` callback allows sending `Link` headers before any HTML for early hints.\n\n**Header Capacity Management**\n\nResources are accumulated into Link headers until capacity is reached:\n- Default capacity: 2000 UTF-16 code units (~2KB)\n- Priority order: preconnects, font preloads, high-priority image preloads\n- Remaining resources flush in HTML `<link>` tags\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:367-489]()\n\n---\n\n# Page: React Server Components (Flight)\n\n# React Server Components (Flight)\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightClient.js](packages/react-client/src/ReactFlightClient.js)\n- [packages/react-client/src/ReactFlightReplyClient.js](packages/react-client/src/ReactFlightReplyClient.js)\n- [packages/react-client/src/ReactFlightTemporaryReferences.js](packages/react-client/src/ReactFlightTemporaryReferences.js)\n- [packages/react-client/src/__tests__/ReactFlight-test.js](packages/react-client/src/__tests__/ReactFlight-test.js)\n- [packages/react-server-dom-esm/src/ReactFlightESMReferences.js](packages/react-server-dom-esm/src/ReactFlightESMReferences.js)\n- [packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js](packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js)\n- [packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js](packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js)\n- [packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js](packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js)\n- [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js](packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js)\n- [packages/react-server/src/ReactFlightReplyServer.js](packages/react-server/src/ReactFlightReplyServer.js)\n- [packages/react-server/src/ReactFlightServer.js](packages/react-server/src/ReactFlightServer.js)\n- [packages/react-server/src/ReactFlightServerTemporaryReferences.js](packages/react-server/src/ReactFlightServerTemporaryReferences.js)\n- [scripts/error-codes/codes.json](scripts/error-codes/codes.json)\n\n</details>\n\n\n\nReact Server Components (Flight) is React\'s protocol and runtime system for executing React components on the server, serializing them into a streamable format, and reconstructing them on the client. This system enables server-side computation while maintaining React\'s component model and interactivity on the client.\n\nFor information about streaming server-side rendering with HTML output, see [React Fizz (Streaming SSR)](#5.1). For traditional server rendering patterns, see [Legacy Server Rendering](#5.3).\n\n## Architecture Overview\n\nReact Flight is the protocol and runtime for React Server Components (RSC). It serializes component trees on the server into a streaming wire format and reconstructs them on the client. The protocol enables server-side components to pass serialized data, client component references, and server function references to the client.\n\n### Server-to-Client Data Flow\n\n```mermaid\ngraph TB\n    SC["Server Component<br/>ReactElement"]\n    Request["Request<br/>(RequestInstance)"]\n    Task["Task<br/>(render unit)"]\n    Model["ReactClientValue<br/>(serializable model)"]\n    Chunks["Chunk Array<br/>(completedRegularChunks)"]\n    Stream["Destination<br/>(WritableStream)"]\n    \n    SC -->|"renderToPipeableStream()"| Request\n    Request -->|"createTask()"| Task\n    Task -->|"renderModelDestructive()"| Model\n    Model -->|"emitChunk()"| Chunks\n    Chunks -->|"flushBuffered()"| Stream\n    \n    subgraph "Client Side"\n        Response["Response<br/>(_chunks Map)"]\n        ReactPromise["ReactPromise<br/>(SomeChunk)"]\n        Element["React Element"]\n    end\n    \n    Stream -->|"processFullRow()"| Response\n    Response -->|"getChunk()"| ReactPromise\n    ReactPromise -->|"initializeModelChunk()"| Element\n```\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:651-777](), [packages/react-client/src/ReactFlightClient.js:245-331](), [packages/react-client/src/ReactFlightClient.js:1437-1580]()\n\n## Core Components\n\n### Flight Server (ReactFlightServer)\n\nThe Flight server executes React components and serializes their output into chunks. The `Request` object maintains serialization state and manages chunk emission.\n\n#### Request Structure\n\n```mermaid\ngraph TD\n    Request["Request"]\n    \n    Request --> status["status: OPENING|OPEN|ABORTING|CLOSING|CLOSED"]\n    Request --> destination["destination: Destination"]\n    Request --> bundlerConfig["bundlerConfig: ClientManifest"]\n    Request --> chunks["Chunk Arrays"]\n    Request --> writtenObjects["writtenObjects: WeakMap"]\n    Request --> cache["cache: Map<Function, mixed>"]\n    \n    chunks --> completedRegularChunks["completedRegularChunks"]\n    chunks --> completedErrorChunks["completedErrorChunks"]\n    chunks --> completedImportChunks["completedImportChunks"]\n    chunks --> completedHintChunks["completedHintChunks"]\n    \n    Task["Task"]\n    Task --> id["id: number"]\n    Task --> model["model: ReactClientValue"]\n    Task --> keyPath["keyPath: ReactKey"]\n    Task --> formatContext["formatContext: FormatContext"]\n```\n\n**Key Types and Functions:**\n\n| Symbol | Type | Purpose |\n|--------|------|---------|\n| `Request` | Object | Central state for a Flight render, tracks chunks and serialization |\n| `Task` | Object | Unit of work for rendering a component tree segment |\n| `ReactClientValue` | Type | Union of all serializable types (elements, primitives, references) |\n| `createRequest()` | Function | Initializes request with `bundlerConfig` and callbacks |\n| `createTask()` | Function | Creates a task with `id`, `model`, and `keyPath` |\n| `renderModelDestructive()` | Function | Main serialization dispatcher, mutates model to JSON-compatible form |\n| `emitChunk()` | Function | Writes chunk rows to destination stream |\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:569-615](), [packages/react-server/src/ReactFlightServer.js:533-549](), [packages/react-server/src/ReactFlightServer.js:1756-1858]()\n\n### Flight Client (ReactFlightClient)\n\nThe Flight client parses the streamed protocol and reconstructs React elements. It maintains a `Response` object with a `Map` of chunks that transition through states.\n\n#### Client Architecture\n\n```mermaid\ngraph TD\n    Response["Response"]\n    \n    Response --> _chunks["_chunks: Map<number, SomeChunk>"]\n    Response --> _bundlerConfig["_bundlerConfig: ServerConsumerModuleMap"]\n    Response --> _fromJSON["_fromJSON: (key, value) => any"]\n    Response --> _stringDecoder["_stringDecoder: StringDecoder"]\n    Response --> _closed["_closed: boolean"]\n    \n    SomeChunk["SomeChunk<T>"]\n    SomeChunk --> PendingChunk["PendingChunk<br/>status: \'pending\'"]\n    SomeChunk --> BlockedChunk["BlockedChunk<br/>status: \'blocked\'"]\n    SomeChunk --> ResolvedModelChunk["ResolvedModelChunk<br/>status: \'resolved_model\'"]\n    SomeChunk --> ResolvedModuleChunk["ResolvedModuleChunk<br/>status: \'resolved_module\'"]\n    SomeChunk --> InitializedChunk["InitializedChunk<br/>status: \'fulfilled\'"]\n    SomeChunk --> ErroredChunk["ErroredChunk<br/>status: \'rejected\'"]\n```\n\n**Key Functions:**\n\n| Function | Input | Output | Purpose |\n|----------|-------|--------|---------|\n| `createFromReadableStream()` | `stream: ReadableStream` | `Promise<T>` | Creates Response, starts stream parsing |\n| `processFullRow()` | `response: Response, row: string` | `void` | Parses row format: `id:tag data` |\n| `parseModelString()` | `response: Response, json: string` | `any` | Parses JSON with special prefixes (`$`, `@`, etc.) |\n| `getChunk()` | `response: Response, id: number` | `SomeChunk<T>` | Retrieves or creates chunk by ID |\n| `initializeModelChunk()` | `chunk: ResolvedModelChunk` | `void` | Converts JSON model to React element |\n| `readChunk()` | `chunk: SomeChunk<T>` | `T` | Synchronously reads initialized chunk or throws |\n\n**Row Parser State Machine:**\n\nThe client processes incoming bytes through a state machine defined by `RowParserState`:\n\n| State | Value | Parsing |\n|-------|-------|---------|\n| `ROW_ID` | `0` | Reading chunk ID (hexadecimal) |\n| `ROW_TAG` | `1` | Reading row type tag (single char) |\n| `ROW_LENGTH` | `2` | Reading length field for binary chunks |\n| `ROW_CHUNK_BY_NEWLINE` | `3` | Reading text chunk until `\\n` |\n| `ROW_CHUNK_BY_LENGTH` | `4` | Reading binary chunk by byte count |\n\n**Sources:** [packages/react-client/src/ReactFlightClient.js:345-383](), [packages/react-client/src/ReactFlightClient.js:146-152](), [packages/react-client/src/ReactFlightClient.js:162-235](), [packages/react-client/src/ReactFlightClient.js:1437-1580]()\n\n## Wire Protocol Format\n\n### Row-Based Streaming Protocol\n\nFlight streams data as newline-delimited rows. Each row has the format: `{id}:{tag}{data}\\n`\n\n**Row Format Components:**\n\n| Component | Format | Description |\n|-----------|--------|-------------|\n| `id` | Hex integer | Unique chunk identifier (e.g., `0`, `1a`, `2f`) |\n| `:` | Delimiter | Separates ID from tag |\n| `tag` | Single char | Row type indicator |\n| `data` | Variable | JSON string, binary length, or empty |\n| `\\n` | Terminator | Marks end of row (except binary chunks) |\n\n**Row Tags:**\n\n| Tag | Name | Data Format | Purpose |\n|-----|------|-------------|---------|\n| `J` | Model | JSON string | Serialized model/element |\n| `M` | Module (Client Reference) | JSON string | Client component reference |\n| `E` | Error | JSON error object | Error chunk |\n| `T` | Hint/Metadata | JSON string | Preload hints, metadata |\n| `@` | Promise | Promise ID | Async chunk reference |\n| `H` | Halt (DEV) | Empty | Indicates stopped resolution |\n| `R` | ReadableStream start | Empty | Stream initialization |\n| `r` | BYOB stream start | Empty | Binary stream initialization |\n| `C` | Stream close | Empty or final value | Stream completion |\n| `X` | Async iterator start | Empty | Iterator initialization |\n| `x` | Iterator instance | Empty | Single-shot iterator |\n\n**Example Row Sequences:**\n\n```\n0:J{"type":"div","props":{"children":"Hello"}}\n1:M{"id":"./ClientComponent.js","chunks":["chunk1"],"name":"default"}\n2:@3\n3:J"Resolved value"\n```\n\n**Sources:** [packages/react-client/src/ReactFlightClient.js:1437-1580](), [packages/react-server/src/ReactFlightServer.js:1860-1930]()\n\n### Value Serialization Encoding\n\nThe server encodes special values with prefix markers in JSON strings:\n\n```mermaid\ngraph TD\n    Value["Value to Serialize"]\n    \n    Value -->|"reference to chunk"| RefPrefix["$ + hex ID<br/>e.g., \'$5\'"]\n    Value -->|"Promise"| PromisePrefix["$@ + hex ID<br/>e.g., \'$@a\'"]\n    Value -->|"Server Reference"| ServerPrefix["$F + hex ID<br/>e.g., \'$F3\'"]\n    Value -->|"Client Reference"| ClientPrefix["$$id<br/>e.g., \'$$./Component.js#default\'"]\n    Value -->|"Symbol"| SymbolPrefix["$S + symbol key<br/>e.g., \'$Sreact.element\'"]\n    Value -->|"-0"| NegZero["$-0"]\n    Value -->|"Infinity"| Inf["$Infinity"]\n    Value -->|"-Infinity"| NegInf["$-Infinity"]\n    Value -->|"NaN"| NotANumber["$NaN"]\n    Value -->|"undefined"| Undef["$undefined"]\n    Value -->|"Date"| DatePrefix["$D + ISO string<br/>e.g., \'$D2023-01-01T00:00:00.000Z\'"]\n    Value -->|"BigInt"| BigIntPrefix["$n + decimal<br/>e.g., \'$n12345\'"]\n    Value -->|"Map"| MapPrefix["$Q + hex ID"]\n    Value -->|"Set"| SetPrefix["$W + hex ID"]\n    Value -->|"FormData"| FormDataPrefix["$K + hex ID"]\n    Value -->|"Blob/ArrayBuffer"| BlobPrefix["$B + hex ID"]\n    Value -->|"Iterator"| IteratorPrefix["$i + hex ID"]\n    Value -->|"Typed Array"| TypedArrayPrefix["$O + type + hex ID<br/>e.g., \'$OUint8Array1\'"]\n    Value -->|"Error"| ErrorPrefix["$E + serialized error"]\n    Value -->|"String starting with $"| Escaped["$$ + rest of string"]\n```\n\n**Key Encoding Functions:**\n\n| Function | Return | Purpose |\n|----------|--------|---------|\n| `serializeByValueID(id)` | `\'$\' + id.toString(16)` | References to other chunks |\n| `serializePromiseID(id)` | `\'$@\' + id.toString(16)` | Async chunk placeholders |\n| `serializeServerReferenceID(id)` | `\'$F\' + id.toString(16)` | Server function references |\n| `serializeClientReference(ref)` | `\'$$\' + ref.$$id` | Client component module path |\n| `serializeNumber(n)` | Special string or number | Handles `-0`, `Infinity`, `NaN` |\n| `serializeSymbol(sym)` | `\'$S\' + key` | Well-known React symbols |\n| `escapeStringValue(s)` | `\'$\' + s` if starts with `$` | Escapes `$` prefix in strings |\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:1860-1930](), [packages/react-server/src/ReactFlightServer.js:1932-2042](), [packages/react-client/src/ReactFlightClient.js:1583-1800]()\n\n### Chunk States and Transitions\n\nChunks transition through states as data arrives and is processed:\n\n```mermaid\nstateDiagram-v2\n    [*] --> PENDING: getChunk() creates\n    PENDING --> BLOCKED: waiting on dependencies\n    PENDING --> RESOLVED_MODEL: receiveModel() called\n    PENDING --> RESOLVED_MODULE: receiveModule() called\n    PENDING --> ERRORED: triggerErrorOnChunk()\n    \n    BLOCKED --> RESOLVED_MODEL: dependencies resolved\n    BLOCKED --> ERRORED: dependency failed\n    \n    RESOLVED_MODEL --> INITIALIZED: initializeModelChunk() success\n    RESOLVED_MODEL --> BLOCKED: circular dependencies found\n    RESOLVED_MODEL --> ERRORED: initializeModelChunk() throws\n    \n    RESOLVED_MODULE --> INITIALIZED: initializeModuleChunk() loads\n    \n    INITIALIZED --> [*]\n    ERRORED --> [*]\n```\n\n**State Transitions:**\n\n- **PENDING  RESOLVED_MODEL**: Server sends `J` (JSON model) row with matching ID\n- **PENDING  RESOLVED_MODULE**: Server sends `M` (module reference) row  \n- **RESOLVED_MODEL  INITIALIZED**: `initializeModelChunk()` parses JSON and resolves references\n- **RESOLVED_MODULE  INITIALIZED**: `initializeModuleChunk()` loads client module\n- **BLOCKED**: Created when chunk references another pending chunk\n- **ERRORED**: Server sends `E` row or initialization throws\n\n**Sources:** [packages/react-client/src/ReactFlightClient.js:154-243](), [packages/react-client/src/ReactFlightClient.js:767-908](), [packages/react-client/src/ReactFlightClient.js:1126-1206]()\n\n## Component and Function References\n\n### Client References (Client Components)\n\nClient references represent components that must execute on the client. They are serialized as module metadata that the client can load.\n\n**Server-Side Handling:**\n\n```mermaid\ngraph LR\n    ServerComp["Server Component"]\n    Import["import ClientComp from \'./Client.js\'"]\n    ClientRef["ClientReference<br/>{$$typeof: CLIENT_REFERENCE,<br/>$$id: \'./Client.js#default\'}"]\n    Serialize["serializeClientReference()"]\n    Row["Row: M tag<br/>{id, chunks, name}"]\n    \n    ServerComp --> Import\n    Import --> ClientRef\n    ClientRef --> Serialize\n    Serialize --> Row\n```\n\n**Client-Side Resolution:**\n\n```mermaid\ngraph LR\n    Row["M row received"]\n    CreateChunk["createResolvedModuleChunk()"]\n    ResolvedModule["ResolvedModuleChunk<br/>status: \'resolved_module\'"]\n    InitModule["initializeModuleChunk()"]\n    LoadModule["resolveClientReference()"]\n    PreloadModule["preloadModule()"]\n    RequireModule["requireModule()"]\n    ClientComp["Client Component Function"]\n    \n    Row --> CreateChunk\n    CreateChunk --> ResolvedModule\n    ResolvedModule --> InitModule\n    InitModule --> LoadModule\n    LoadModule --> PreloadModule\n    PreloadModule --> RequireModule\n    RequireModule --> ClientComp\n```\n\n**Key Functions:**\n\n| Side | Function | Purpose |\n|------|----------|---------|\n| Server | `isClientReference(value)` | Checks `$$typeof === CLIENT_REFERENCE` |\n| Server | `getClientReferenceKey(ref)` | Extracts module path from reference |\n| Server | `resolveClientReferenceMetadata(config, ref)` | Gets chunk info from `ClientManifest` |\n| Client | `resolveClientReference(metadata)` | Creates lazy wrapper for module |\n| Client | `preloadModule(metadata)` | Preloads chunks (async) |\n| Client | `requireModule(metadata)` | Synchronously imports module |\n\n**ClientManifest Structure:**\n\nThe server uses a `ClientManifest` (bundler-generated) to map references to chunk IDs:\n\n```typescript\n{\n  "./ClientComponent.js#default": {\n    id: "client-chunk-123",\n    chunks: ["chunk-abc.js", "chunk-def.js"],\n    name: "default"\n  }\n}\n```\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:1932-2042](), [packages/react-client/src/ReactFlightClient.js:1208-1274](), [packages/react-client/src/ReactFlightClient.js:882-908]()\n\n### Server References (Server Actions)\n\nServer references enable client-to-server RPC. The client can call these functions, and Flight serializes arguments, invokes the server function, and returns results.\n\n**Server-Side Creation:**\n\n```mermaid\ngraph TD\n    ServerFunc["async function myAction(data) { }"]\n    Register["registerServerReference(fn, id, name)"]\n    Proxy["Server Reference Proxy<br/>{$$typeof: SERVER_REFERENCE,<br/>$$id: \'module#myAction\',<br/>$$bound: null}"]\n    Serialize["serializeServerReference()"]\n    Row["Row: F tag<br/>id + bound args"]\n    \n    ServerFunc --> Register\n    Register --> Proxy\n    Proxy --> Serialize\n    Serialize --> Row\n```\n\n**Client-Side Invocation:**\n\n```mermaid\ngraph LR\n    ClientCall["clientRef(arg1, arg2)"]\n    CallServer["callServer(id, args)"]\n    EncodeReply["encodeReply([arg1, arg2])"]\n    FormData["FormData with serialized args"]\n    ServerInvoke["Server receives request"]\n    DecodeReply["decodeReply(body, serverMap)"]\n    Invoke["serverFunc(...args)"]\n    Result["Flight response with result"]\n    \n    ClientCall --> CallServer\n    CallServer --> EncodeReply\n    EncodeReply --> FormData\n    FormData --> ServerInvoke\n    ServerInvoke --> DecodeReply\n    DecodeReply --> Invoke\n    Invoke --> Result\n```\n\n**Key Functions:**\n\n| Side | Function | Purpose |\n|------|----------|---------|\n| Server | `registerServerReference(fn, id, name)` | Marks function as server reference |\n| Server | `getServerReferenceId(ref)` | Extracts module ID |\n| Server | `getServerReferenceBoundArguments(ref)` | Gets pre-bound arguments (from `.bind()`) |\n| Client | `createServerReference(id, callServer)` | Creates callable proxy |\n| Client | `callServer(id, args)` | User-provided RPC implementation |\n| Client | `encodeReply(value)` | Serializes arguments to FormData |\n| Server | `decodeReply(body, serverMap)` | Deserializes FormData to values |\n\n**Bound Server References:**\n\nServer references can be partially applied with `.bind()`:\n\n```javascript\n// Server\nexport async function deleteItem(userId, itemId) { ... }\n\n// Server component passes bound reference\nconst boundDelete = deleteItem.bind(null, currentUserId);\nreturn <Button action={boundDelete} />\n```\n\nThe bound arguments are serialized in the Flight stream, and the client proxy includes them when calling back.\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:2044-2143](), [packages/react-client/src/ReactFlightClient.js:1583-1650](), [packages/react-client/src/ReactFlightReplyClient.js:179-560](), [packages/react-server/src/ReactFlightReplyServer.js:400-650]()\n\n## Request Lifecycle\n\n### Server Render Flow\n\n```mermaid\ngraph TD\n    Entry["renderToPipeableStream(model, config)"]\n    CreateReq["createRequest(RENDER, model, bundlerConfig, ...)"]\n    Request["Request<br/>{status: OPENING, nextChunkId: 0}"]\n    RootTask["createTask(request, model, null, ...)"]\n    PingedTasks["pingedTasks array"]\n    \n    Entry --> CreateReq\n    CreateReq --> Request\n    Request --> RootTask\n    RootTask --> PingedTasks\n    \n    StartWork["startWork(request)"]\n    PerformWork["performWork(request)"]\n    RetryTask["retryTask(request, task)"]\n    RenderModel["renderModelDestructive(request, task, ...)"]\n    EmitChunk["emitChunk(request, task.id, model)"]\n    FlushChunks["flushCompletedChunks(request)"]\n    \n    PingedTasks --> StartWork\n    StartWork --> PerformWork\n    PerformWork --> RetryTask\n    RetryTask --> RenderModel\n    RenderModel --> EmitChunk\n    EmitChunk --> FlushChunks\n```\n\n**Processing Steps:**\n\n1. **Initialization**: `createRequest()` creates `Request` with `OPENING` status and root task\n2. **Work Loop**: `performWork()` processes `pingedTasks` array, rendering each task\n3. **Serialization**: `renderModelDestructive()` recursively serializes model, mutating it to JSON-compatible form\n4. **Chunk Emission**: `emitChunk()` generates row string and adds to `completedRegularChunks`\n5. **Flushing**: `flushCompletedChunks()` writes accumulated chunks to destination stream\n6. **Completion**: When all tasks done, status transitions to `CLOSED` and stream is closed\n\n**Key Task States:**\n\n| Task Status | Value | Description |\n|-------------|-------|-------------|\n| `PENDING` | `0` | Task created but not started |\n| `COMPLETED` | `1` | Task finished successfully |\n| `ABORTED` | `3` | Task aborted due to error/abort |\n| `ERRORED` | `4` | Task threw error during render |\n| `RENDERING` | `5` | Task currently executing |\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:779-807](), [packages/react-server/src/ReactFlightServer.js:1373-1445](), [packages/react-server/src/ReactFlightServer.js:1447-1533]()\n\n### Client Parsing Flow\n\n```mermaid\ngraph TD\n    CreateResp["createFromReadableStream(stream, options)"]\n    Response["Response<br/>{_chunks: new Map(), _closed: false}"]\n    ReadStream["Read stream chunks"]\n    ProcessBinary["processBinaryChunk(response, chunk)"]\n    ParseRow["Parse row: id:tag data"]\n    ProcessRow["processFullRow(response, row)"]\n    \n    CreateResp --> Response\n    Response --> ReadStream\n    ReadStream --> ProcessBinary\n    ProcessBinary --> ParseRow\n    ParseRow --> ProcessRow\n    \n    ResolveModel["resolveModel(response, id, model)"]\n    ResolveModule["resolveModule(response, id, metadata)"]\n    ResolveError["resolveError(response, id, error)"]\n    GetChunk["getChunk(response, id)"]\n    CreateChunk["createPendingChunk() or fetch from _chunks"]\n    UpdateChunk["Update chunk status and value"]\n    WakeListeners["Wake pending .then() listeners"]\n    \n    ProcessRow -->|"J tag"| ResolveModel\n    ProcessRow -->|"M tag"| ResolveModule\n    ProcessRow -->|"E tag"| ResolveError\n    \n    ResolveModel --> GetChunk\n    GetChunk --> CreateChunk\n    CreateChunk --> UpdateChunk\n    UpdateChunk --> WakeListeners\n```\n\n**Parsing States:**\n\nThe parser maintains state between stream chunks:\n\n| Parser State | Processing |\n|--------------|------------|\n| `ROW_ID` | Reading chunk ID in hex (e.g., `1a`) |\n| `ROW_TAG` | Reading single-char tag after `:` |\n| `ROW_LENGTH` | Reading length field for binary data |\n| `ROW_CHUNK_BY_NEWLINE` | Accumulating row until `\\n` |\n| `ROW_CHUNK_BY_LENGTH` | Reading exact byte count for binary |\n\n**Processing Steps:**\n\n1. **Stream Reading**: `processBinaryChunk()` processes incoming bytes\n2. **Row Parsing**: State machine extracts `id`, `tag`, and `data` from each row\n3. **Row Processing**: `processFullRow()` dispatches based on tag\n4. **Chunk Resolution**: Updates or creates chunk in `_chunks` Map\n5. **Listener Notification**: Wakes any promises/callbacks waiting on this chunk\n6. **Initialization**: When chunk read via `readChunk()`, calls `initializeModelChunk()` if needed\n\n**Sources:** [packages/react-client/src/ReactFlightClient.js:1437-1580](), [packages/react-client/src/ReactFlightClient.js:1626-1935](), [packages/react-client/src/ReactFlightClient.js:852-880]()\n\n## Configuration and Integration\n\n### Environment-Specific Configurations\n\nFlight supports multiple deployment environments through configuration modules:\n\n- `ReactFlightServerConfig` - Server-side environment configuration\n- `ReactFlightClientConfig` - Client-side environment configuration  \n- Webpack integration through `ReactFlightWebpackPlugin`\n- Turbopack integration for Next.js environments\n\n**Sources:** [packages/react-server-dom-webpack/src/ReactFlightWebpackPlugin.js:1-50](), [packages/react-server-dom-webpack/src/ReactFlightWebpackNodeLoader.js:1-30]()\n\n### Performance and Debugging\n\nFlight includes performance tracking and debugging capabilities:\n\n- Component render timing with `enableComponentPerformanceTrack`\n- Async operation tracking with `enableAsyncDebugInfo`  \n- Console log forwarding from server to client\n- Stack trace preservation across server-client boundary\n\n**Sources:** [packages/react-client/src/ReactFlightPerformanceTrack.js:75-140](), [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js:105-150]()\n\n---\n\n# Page: Build Integration for Server Components\n\n# Build Integration for Server Components\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightClient.js](packages/react-client/src/ReactFlightClient.js)\n- [packages/react-client/src/ReactFlightReplyClient.js](packages/react-client/src/ReactFlightReplyClient.js)\n- [packages/react-client/src/ReactFlightTemporaryReferences.js](packages/react-client/src/ReactFlightTemporaryReferences.js)\n- [packages/react-client/src/__tests__/ReactFlight-test.js](packages/react-client/src/__tests__/ReactFlight-test.js)\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/react-server-dom-esm/src/ReactFlightESMReferences.js](packages/react-server-dom-esm/src/ReactFlightESMReferences.js)\n- [packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js](packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js)\n- [packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js](packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js)\n- [packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js](packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js)\n- [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js](packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js)\n- [packages/react-server/src/ReactFlightReplyServer.js](packages/react-server/src/ReactFlightReplyServer.js)\n- [packages/react-server/src/ReactFlightServer.js](packages/react-server/src/ReactFlightServer.js)\n- [packages/react-server/src/ReactFlightServerTemporaryReferences.js](packages/react-server/src/ReactFlightServerTemporaryReferences.js)\n- [scripts/error-codes/codes.json](scripts/error-codes/codes.json)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document explains how bundlers integrate with React Server Components (RSC) through build-time plugins, manifest generation, and directive processing. It covers the Webpack plugin implementation, module reference systems, and how the build toolchain transforms code containing `\'use client\'` and `\'use server\'` directives into the appropriate module references and manifests.\n\nFor information about the runtime behavior of Flight serialization and deserialization, see [React Server Components (Flight)](#5.2). For server actions and client-to-server communication, see [Server Actions and Bidirectional Communication](#5.4).\n\n---\n\n## Build Integration Architecture\n\nThe build integration for React Server Components consists of several cooperating systems that run at build time to analyze modules, generate manifests, and transform code references.\n\n**Build Integration Flow**\n\n```mermaid\ngraph TB\n    subgraph "Source Code"\n        ServerComponents["Server Components<br/>(no directive)"]\n        ClientComponents["Client Components<br/>\'use client\'"]\n        ServerActions["Server Actions<br/>\'use server\'"]\n    end\n    \n    subgraph "Build Process"\n        WebpackPlugin["ReactFlightWebpackPlugin"]\n        NodeLoader["react-server-dom-webpack/node-loader"]\n        \n        WebpackPlugin -->|analyzes| DirectiveDetection["Directive Detection"]\n        WebpackPlugin -->|generates| ClientManifest["Client Manifest<br/>clientReferenceMap"]\n        WebpackPlugin -->|generates| ServerManifest["Server Manifest<br/>serverReferenceMap"]\n        \n        DirectiveDetection -->|\'use client\'| ClientModuleTransform["Client Module Transform"]\n        DirectiveDetection -->|\'use server\'| ServerModuleTransform["Server Module Transform"]\n    end\n    \n    subgraph "Output Artifacts"\n        ServerBundle["Server Bundle<br/>react-server condition"]\n        ClientBundle["Client Bundle<br/>default condition"]\n        \n        ClientManifest -->|consumed by| ServerBundle\n        ServerManifest -->|consumed by| ClientBundle\n    end\n    \n    subgraph "Runtime"\n        FlightServer["Flight Server<br/>ReactFlightServer.js"]\n        FlightClient["Flight Client<br/>ReactFlightClient.js"]\n        \n        FlightServer -->|serializes with| ClientManifest\n        FlightClient -->|deserializes with| ServerManifest\n    end\n    \n    ServerComponents --> WebpackPlugin\n    ClientComponents --> WebpackPlugin\n    ServerActions --> WebpackPlugin\n    \n    ServerBundle --> FlightServer\n    ClientBundle --> FlightClient\n```\n\nSources: [scripts/rollup/bundles.js:524-558](), [packages/react-server/src/ReactFlightServer.js:1-100](), [packages/react-client/src/ReactFlightClient.js:1-100]()\n\n---\n\n## Webpack Plugin Implementation\n\nThe `ReactFlightWebpackPlugin` is the primary build-time integration point. It analyzes modules for directives, transforms module references, and generates the client and server manifests.\n\n**Plugin Bundle Configuration**\n\n| Property | Value |\n|----------|-------|\n| Entry Point | `react-server-dom-webpack/plugin` |\n| Bundle Type | `NODE_ES2015` |\n| Module Type | `RENDERER_UTILS` |\n| Global Name | `ReactServerWebpackPlugin` |\n| Externals | `fs`, `path`, `url`, `neo-async` |\n\nThe plugin operates as a Webpack compilation plugin that hooks into the module graph construction process to identify client and server boundaries.\n\n**Module Analysis Process**\n\n```mermaid\ngraph LR\n    subgraph "Webpack Compilation"\n        ModuleGraph["Webpack Module Graph"]\n        \n        ModuleGraph -->|for each module| AnalyzeModule["Analyze Module"]\n        \n        AnalyzeModule -->|check| HasDirective{"Has \'use client\'<br/>or \'use server\'?"}\n        \n        HasDirective -->|yes| RegisterReference["Register Module Reference"]\n        HasDirective -->|no| CheckImports["Check Imports"]\n        \n        RegisterReference -->|\'use client\'| AddToClientManifest["Add to Client Manifest"]\n        RegisterReference -->|\'use server\'| AddToServerManifest["Add to Server Manifest"]\n        \n        CheckImports -->|imports client module| ProxyModule["Create Proxy Module"]\n    end\n    \n    subgraph "Reference Generation"\n        AddToClientManifest --> GenerateClientID["Generate Client ID<br/>module path + export name"]\n        AddToServerManifest --> GenerateServerID["Generate Server ID<br/>module path + export name"]\n        \n        GenerateClientID --> ClientMetadata["Client Reference Metadata<br/>{id, chunks, name}"]\n        GenerateServerID --> ServerMetadata["Server Reference Metadata<br/>{id, bound}"]\n    end\n```\n\nSources: [scripts/rollup/bundles.js:524-533]()\n\n---\n\n## Module Reference System\n\nReact Server Components use a module reference system to represent code that crosses the server/client boundary. These references are opaque identifiers that get resolved at runtime using the manifests.\n\n**Client Reference Structure**\n\nA client reference represents a module that should be loaded on the client. When server code imports a client component, it receives a reference instead of the actual module.\n\n```mermaid\ngraph TB\n    subgraph "Server-Side"\n        ServerCode["Server Component Code"]\n        ClientRefProxy["Client Reference Proxy<br/>$$typeof: \'react.client.reference\'"]\n        \n        ServerCode -->|imports| ClientRefProxy\n    end\n    \n    subgraph "Client Manifest Entry"\n        ManifestEntry["Client Manifest Entry"]\n        \n        ManifestEntry -->|contains| ModuleID["id: \'path/to/module.js#Component\'"]\n        ManifestEntry -->|contains| ChunkIDs["chunks: [\'client-chunk-123\']"]\n        ManifestEntry -->|contains| ExportName["name: \'Component\' or \'*\'"]\n    end\n    \n    subgraph "Serialization"\n        FlightProtocol["Flight Protocol Stream"]\n        \n        ClientRefProxy -->|serialized as| ModuleReference["M1:{id,chunks,name}"]\n        ModuleReference -->|written to| FlightProtocol\n    end\n    \n    subgraph "Client-Side"\n        FlightClient["Flight Client"]\n        ManifestLookup["Manifest Lookup"]\n        ModuleLoader["Module Loader"]\n        \n        FlightProtocol -->|read by| FlightClient\n        FlightClient -->|resolves with| ManifestLookup\n        ManifestLookup -->|loads| ModuleLoader\n        ModuleLoader -->|returns| ActualComponent["Actual Component Implementation"]\n    end\n    \n    ClientRefProxy -.manifest key.-> ManifestEntry\n```\n\nSources: [packages/react-client/src/ReactFlightClient.js:1-100](), [packages/react-server/src/ReactFlightServer.js:79-101]()\n\n**Server Reference Structure**\n\nA server reference represents a function that should execute on the server. When client code calls a server action, it sends a reference and arguments back to the server.\n\n```mermaid\ngraph TB\n    subgraph "Client-Side"\n        ClientCode["Client Component Code"]\n        ServerRefFunc["Server Reference Function<br/>$$typeof: \'react.server.reference\'"]\n        \n        ClientCode -->|calls| ServerRefFunc\n        ServerRefFunc -->|serializes| ServerRefCall["Call: {id, args}"]\n    end\n    \n    subgraph "Server Manifest Entry"\n        ServerManifestEntry["Server Manifest Entry"]\n        \n        ServerManifestEntry -->|contains| ServerModuleID["id: \'path/to/actions.js#saveData\'"]\n        ServerManifestEntry -->|contains| BoundArgs["bound: null or Array"]\n    end\n    \n    subgraph "Server-Side"\n        FlightReply["Flight Reply Processor"]\n        ManifestResolve["Manifest Resolution"]\n        ActualFunction["Actual Server Function"]\n        \n        ServerRefCall -->|sent to| FlightReply\n        FlightReply -->|resolves with| ManifestResolve\n        ManifestResolve -->|loads| ActualFunction\n        ActualFunction -->|executes| ReturnValue["Return Value"]\n    end\n    \n    ServerRefFunc -.manifest key.-> ServerManifestEntry\n```\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:52-80](), [packages/react-server/src/ReactFlightReplyServer.js:1-50]()\n\n---\n\n## Directive Processing\n\nThe build system processes two types of directives: `\'use client\'` and `\'use server\'`. These directives must appear at the top of the module, before any other code.\n\n**Directive Detection and Transformation**\n\n| Directive | Location | Meaning | Build Transformation |\n|-----------|----------|---------|---------------------|\n| `\'use client\'` | Top of file | Entire module runs on client | Replace with client reference proxy in server bundle |\n| `\'use server\'` | Top of file | Entire module exports server actions | Replace with server reference proxies in client bundle |\n| `\'use server\'` | Inside function | Single function is server action | Extract and create server reference |\n\n**Client Directive Processing Flow**\n\n```mermaid\ngraph TB\n    subgraph "Source Module"\n        ClientDirective["\'use client\'<br/>export function Button() {...}"]\n    end\n    \n    subgraph "Server Bundle Transform"\n        DetectDirective["Detect \'use client\' Directive"]\n        GenerateProxy["Generate Proxy Module"]\n        \n        DetectDirective --> GenerateProxy\n        GenerateProxy --> ProxyContent["Proxy exports client references<br/>for each export"]\n    end\n    \n    subgraph "Client Bundle Transform"\n        IncludeOriginal["Include Original Module"]\n        AddChunkInfo["Add to Chunk Manifest"]\n        \n        IncludeOriginal --> AddChunkInfo\n    end\n    \n    subgraph "Manifest Generation"\n        ClientManifestEntry["Client Manifest Entry<br/>{<br/>  id: \'Button.js\',<br/>  chunks: [\'chunk-123\'],<br/>  name: \'Button\'<br/>}"]\n    end\n    \n    ClientDirective -->|server bundle| DetectDirective\n    ClientDirective -->|client bundle| IncludeOriginal\n    \n    ProxyContent --> ClientManifestEntry\n    AddChunkInfo --> ClientManifestEntry\n```\n\nSources: [scripts/rollup/bundles.js:448-522]()\n\n**Server Directive Processing Flow**\n\n```mermaid\ngraph TB\n    subgraph "Source Module"\n        ServerDirective["\'use server\'<br/>export async function saveData() {...}"]\n    end\n    \n    subgraph "Client Bundle Transform"\n        DetectServerDirective["Detect \'use server\' Directive"]\n        GenerateServerProxy["Generate Server Reference Proxy"]\n        \n        DetectServerDirective --> GenerateServerProxy\n        GenerateServerProxy --> ProxyFunc["Proxy function calls server<br/>via callServer()"]\n    end\n    \n    subgraph "Server Bundle Transform"\n        KeepOriginal["Keep Original Implementation"]\n        RegisterAction["Register in Server Manifest"]\n        \n        KeepOriginal --> RegisterAction\n    end\n    \n    subgraph "Manifest Generation"\n        ServerManifestEntry["Server Manifest Entry<br/>{<br/>  id: \'actions.js#saveData\',<br/>  bound: null<br/>}"]\n    end\n    \n    ServerDirective -->|client bundle| DetectServerDirective\n    ServerDirective -->|server bundle| KeepOriginal\n    \n    ProxyFunc --> ServerManifestEntry\n    RegisterAction --> ServerManifestEntry\n```\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:1-100](), [packages/react-server/src/ReactFlightReplyServer.js:1-50]()\n\n---\n\n## Manifest Structures\n\nThe build process generates two manifest files that enable runtime module resolution across the server/client boundary.\n\n**Client Manifest Format**\n\nThe client manifest maps module IDs to chunk information, allowing the server to serialize client references that the client can resolve.\n\n```mermaid\ngraph TB\n    subgraph "Client Manifest Structure"\n        ClientManifest["clientReferenceManifest"]\n        \n        ClientManifest --> ModuleMap["Module Map<br/>{[moduleId]: ModuleExports}"]\n        \n        ModuleMap --> ModuleExports["Module Exports<br/>{[exportName]: ExportInfo}"]\n        \n        ModuleExports --> ExportInfo["Export Info"]\n        \n        ExportInfo --> ExportID["id: string<br/>\'path/to/module#export\'"]\n        ExportInfo --> ExportChunks["chunks: Array<string><br/>[\'chunk-abc\', \'chunk-def\']"]\n        ExportInfo --> ExportName["name: string<br/>\'ComponentName\' or \'*\'"]\n    end\n    \n    subgraph "Example Entry"\n        Example["ClientButton.js:<br/>{<br/>  \'Button\': {<br/>    id: \'./ClientButton.js#Button\',<br/>    chunks: [\'client-chunk-123\'],<br/>    name: \'Button\'<br/>  },<br/>  \'*\': {<br/>    id: \'./ClientButton.js#*\',<br/>    chunks: [\'client-chunk-123\'],<br/>    name: \'*\'<br/>  }<br/>}"]\n    end\n```\n\n**Client Manifest Runtime Usage**\n\n| Stage | Operation | Manifest Usage |\n|-------|-----------|----------------|\n| Server Render | Encounter client component | Look up module ID in manifest to get chunks |\n| Flight Serialization | Serialize client reference | Include `{id, chunks, name}` in stream |\n| Client Receive | Deserialize reference | Use chunks to preload/load module |\n| Client Render | Instantiate component | Import module and get export by name |\n\nSources: [packages/react-server/src/ReactFlightServer.js:79-101](), [packages/react-client/src/ReactFlightClient.js:44-64]()\n\n**Server Manifest Format**\n\nThe server manifest maps server action IDs to module locations, allowing the client to invoke server functions.\n\n```mermaid\ngraph TB\n    subgraph "Server Manifest Structure"\n        ServerManifest["serverReferenceManifest"]\n        \n        ServerManifest --> ActionMap["Action Map<br/>{[actionId]: ActionInfo}"]\n        \n        ActionMap --> ActionInfo["Action Info"]\n        \n        ActionInfo --> ActionID["id: string<br/>\'actions.js#saveData\'"]\n        ActionInfo --> BoundArgs["bound: null | Promise<Array>"]\n    end\n    \n    subgraph "Example Entry"\n        ServerExample["Server Actions:<br/>{<br/>  \'actions.js#saveData\': {<br/>    id: \'actions.js#saveData\',<br/>    bound: null<br/>  },<br/>  \'actions.js#deleteData\': {<br/>    id: \'actions.js#deleteData\',<br/>    bound: Promise.resolve([userId])<br/>  }<br/>}"]\n    end\n```\n\n**Server Manifest Runtime Usage**\n\n| Stage | Operation | Manifest Usage |\n|-------|-----------|----------------|\n| Client Render | Receive server reference | Store reference with `$$typeof` marker |\n| Client Invoke | Call server function | Serialize `{id, args}` with Flight Reply |\n| Server Receive | Deserialize call | Look up action ID in manifest |\n| Server Execute | Load and invoke | Require module and call export by name |\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:52-80](), [packages/react-server/src/ReactFlightReplyServer.js:1-50]()\n\n---\n\n## Module Loading Integration\n\nThe build integration includes module loaders that handle the `react-server` condition at runtime, ensuring the correct versions of modules are loaded in each environment.\n\n**Node.js Loader Configuration**\n\n| Property | Value |\n|----------|-------|\n| Entry Point | `react-server-dom-webpack/node-loader` |\n| Bundle Type | `ESM_PROD` |\n| Condition | `react-server` |\n| External | `acorn` (for AST parsing) |\n\nThe Node.js loader uses ESM loader hooks to intercept module resolution and ensure that modules with the `react-server` export condition are loaded in the server environment.\n\n**Module Resolution Flow**\n\n```mermaid\ngraph TB\n    subgraph "Import Statement"\n        ImportReact["import React from \'react\'"]\n    end\n    \n    subgraph "Node.js Loader Hooks"\n        ResolveHook["resolve() hook"]\n        LoadHook["load() hook"]\n        \n        ResolveHook -->|check conditions| ConditionCheck{"Has react-server<br/>export condition?"}\n        \n        ConditionCheck -->|yes| UseReactServer["Use react.react-server.js"]\n        ConditionCheck -->|no| UseDefault["Use index.js"]\n        \n        UseReactServer --> LoadHook\n        UseDefault --> LoadHook\n    end\n    \n    subgraph "Package Exports"\n        PackageJson["package.json exports field"]\n        \n        PackageJson --> ReactServerExport["\'react-server\': \'./react.react-server.js\'"]\n        PackageJson --> DefaultExport["\'default\': \'./index.js\'"]\n    end\n    \n    ImportReact --> ResolveHook\n    ReactServerExport -.used by.-> UseReactServer\n    DefaultExport -.used by.-> UseDefault\n```\n\nSources: [scripts/rollup/bundles.js:535-545](), [packages/react/package.json:24-42]()\n\n**CommonJS Module Registration**\n\nFor CommonJS environments, a registration module handles module loading:\n\n| Property | Value |\n|----------|-------|\n| Entry Point | `react-server-dom-webpack/src/ReactFlightWebpackNodeRegister` |\n| Name | `react-server-dom-webpack-node-register` |\n| Condition | `react-server` |\n| Externals | `url`, `module`, `react-server-dom-webpack/server` |\n\nThis module hooks into Node\'s `require()` system to apply the `react-server` condition for CommonJS modules.\n\nSources: [scripts/rollup/bundles.js:547-558]()\n\n---\n\n## Build Output Organization\n\nThe build system produces separate bundles for server and client environments, each consuming the appropriate manifest.\n\n**Bundle Type Matrix**\n\n| Bundle | Entry Points | Condition | Consumes Manifest | Target Environment |\n|--------|--------------|-----------|-------------------|--------------------|\n| Server | `react-server-dom-webpack/server.{node,browser,edge}` | `react-server` | Client Manifest | Node.js, Edge Runtime, Browser (SSR) |\n| Client | `react-server-dom-webpack/client.{node,browser,edge}` | default | Server Manifest | Node.js (for SSR), Browser |\n| Plugin | `react-server-dom-webpack/plugin` | N/A | Generates both | Build time only |\n| Loader | `react-server-dom-webpack/node-loader` | `react-server` | N/A | Node.js ESM runtime |\n\n**Server Bundle Configuration**\n\n```mermaid\ngraph LR\n    subgraph "Server Entry Points"\n        ServerBrowser["server.browser"]\n        ServerNode["server.node"]\n        ServerEdge["server.edge"]\n    end\n    \n    subgraph "Configuration"\n        Condition["condition: \'react-server\'"]\n        Externals["externals:<br/>react, react-dom,<br/>crypto, stream, util"]\n        GlobalName["global: \'ReactServerDOMServer\'"]\n    end\n    \n    subgraph "Consumes"\n        ClientManifest2["Client Manifest"]\n    end\n    \n    ServerBrowser --> Condition\n    ServerNode --> Condition\n    ServerEdge --> Condition\n    \n    Condition --> ClientManifest2\n    Externals --> ClientManifest2\n```\n\nSources: [scripts/rollup/bundles.js:448-489]()\n\n**Client Bundle Configuration**\n\n```mermaid\ngraph LR\n    subgraph "Client Entry Points"\n        ClientBrowser["client.browser"]\n        ClientNode["client.node"]\n        ClientEdge["client.edge"]\n    end\n    \n    subgraph "Configuration"\n        NoCondition["condition: default"]\n        ClientExternals["externals:<br/>react, react-dom,<br/>util, crypto"]\n        ClientGlobalName["global: \'ReactServerDOMClient\'"]\n    end\n    \n    subgraph "Consumes"\n        ServerManifest2["Server Manifest"]\n    end\n    \n    ClientBrowser --> NoCondition\n    ClientNode --> NoCondition\n    ClientEdge --> NoCondition\n    \n    NoCondition --> ServerManifest2\n    ClientExternals --> ServerManifest2\n```\n\nSources: [scripts/rollup/bundles.js:491-522]()\n\n---\n\n## Fork System Integration\n\nThe build system uses a fork mechanism to provide different implementations of shared modules based on the bundle type and environment.\n\n**React Shared Internals Forking**\n\n```mermaid\ngraph TB\n    subgraph "Import Statement"\n        ImportShared["import ReactSharedInternals"]\n    end\n    \n    subgraph "Fork Resolution"\n        ForkCheck{"Check bundle<br/>condition"}\n        \n        ForkCheck -->|react-server| ServerInternals["ReactSharedInternalsServer"]\n        ForkCheck -->|default| ClientInternals["ReactSharedInternalsClient"]\n    end\n    \n    subgraph "Implementation Files"\n        ServerImpl["packages/react-server/src/<br/>ReactSharedInternalsServer.js"]\n        ClientImpl["packages/react/src/<br/>ReactSharedInternalsClient.js"]\n    end\n    \n    ImportShared --> ForkCheck\n    ServerInternals --> ServerImpl\n    ClientInternals --> ClientImpl\n```\n\n**Fork Configuration Table**\n\n| Module | Condition | Fork Target | Purpose |\n|--------|-----------|-------------|---------|\n| `shared/ReactSharedInternals.js` | `react-server` | `ReactSharedInternalsServer.js` | Server-specific internals (Flight hooks) |\n| `shared/ReactSharedInternals.js` | default | `ReactSharedInternalsClient.js` | Client-specific internals (useState, etc.) |\n| `shared/ReactDOMSharedInternals.js` | `react-server` | N/A | Not available in react-server |\n| `shared/ReactDOMSharedInternals.js` | default | `ReactDOMSharedInternals.js` | DOM-specific internals |\n\nSources: [scripts/rollup/forks.js:52-131](), [scripts/rollup/build.js:354-403]()\n\n---\n\n## Integration with Other Bundlers\n\nWhile the primary implementation uses Webpack, the architecture supports other bundlers through similar plugin systems.\n\n**Turbopack Integration**\n\n| Bundle | Entry Point | Notes |\n|--------|-------------|-------|\n| Server | `react-server-dom-turbopack/server.{browser,node,edge}` | Similar to Webpack server |\n| Client | `react-server-dom-turbopack/client.{browser,node,edge}` | Similar to Webpack client |\n\nThe Turbopack integration follows the same manifest generation and module reference patterns, but uses Turbopack\'s native plugin system instead of Webpack\'s.\n\nSources: [scripts/rollup/bundles.js:560-672]()\n\n**Unbundled (Development) Integration**\n\nFor development and testing without a bundler:\n\n| Bundle | Entry Point | Purpose |\n|--------|-------------|---------|\n| Server | `react-server-dom-unbundled/server.node` | No bundling, direct module resolution |\n| Client | `react-server-dom-unbundled/client.node` | No bundling, direct module imports |\n\nThis configuration is used primarily in tests to validate the Flight protocol without bundler complexity.\n\nSources: Test files show usage of WebpackMock utilities that simulate manifest generation without actual bundling.\n\n---\n\n## Summary\n\nThe build integration for React Server Components operates through:\n\n1. **Plugin System**: `ReactFlightWebpackPlugin` analyzes modules and generates manifests\n2. **Module References**: Abstract representations of cross-boundary modules with `$$typeof` markers\n3. **Directive Processing**: Transform `\'use client\'` and `\'use server\'` directives into appropriate references\n4. **Manifest Generation**: Create client manifest (server  client) and server manifest (client  server)\n5. **Module Loading**: Use condition-based resolution with `react-server` export condition\n6. **Fork System**: Provide environment-specific implementations of shared modules\n\nThe architecture is bundler-agnostic, with implementations for Webpack, Turbopack, and unbundled environments all following the same manifest and reference patterns.\n\nSources: [scripts/rollup/bundles.js:448-672](), [scripts/rollup/forks.js:1-300](), [scripts/rollup/build.js:1-600]()\n\n---\n\n# Page: Server Actions and Bidirectional Communication\n\n# Server Actions and Bidirectional Communication\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightClient.js](packages/react-client/src/ReactFlightClient.js)\n- [packages/react-client/src/ReactFlightReplyClient.js](packages/react-client/src/ReactFlightReplyClient.js)\n- [packages/react-client/src/ReactFlightTemporaryReferences.js](packages/react-client/src/ReactFlightTemporaryReferences.js)\n- [packages/react-client/src/__tests__/ReactFlight-test.js](packages/react-client/src/__tests__/ReactFlight-test.js)\n- [packages/react-server-dom-esm/src/ReactFlightESMReferences.js](packages/react-server-dom-esm/src/ReactFlightESMReferences.js)\n- [packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js](packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js)\n- [packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js](packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js)\n- [packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js](packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js)\n- [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js](packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js)\n- [packages/react-server/src/ReactFlightReplyServer.js](packages/react-server/src/ReactFlightReplyServer.js)\n- [packages/react-server/src/ReactFlightServer.js](packages/react-server/src/ReactFlightServer.js)\n- [packages/react-server/src/ReactFlightServerTemporaryReferences.js](packages/react-server/src/ReactFlightServerTemporaryReferences.js)\n- [scripts/error-codes/codes.json](scripts/error-codes/codes.json)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis page documents React\'s server action system and bidirectional communication protocol. Server actions enable client code to invoke server-side functions, creating a communication channel from client to server. This complements the server-to-client RSC protocol documented in [React Server Components (Flight)](#5.2).\n\nKey topics covered:\n- **Server References**: Functions that can be serialized and invoked from the client\n- **Reply Encoding**: How client arguments are serialized and sent to the server\n- **Reply Decoding**: How the server deserializes client data\n- **Form Integration**: Using server actions as form actions for progressive enhancement\n- **Bound Arguments**: Pre-binding arguments to server functions\n\nFor server-to-client streaming, see [React Server Components (Flight)](#5.2). For build-time module resolution, see [Build Integration for Server Components](#5.3).\n\n---\n\n## Server Reference Architecture\n\nServer references are special function objects that can be serialized and sent to the client, then invoked to trigger server-side execution.\n\n### Server Reference Structure\n\n```mermaid\ngraph TB\n    subgraph "Server Reference Object"\n        SR["ServerReference&lt;T&gt;"]\n        SR --> typeof["$$typeof: SERVER_REFERENCE_TAG"]\n        SR --> id["$$id: string"]\n        SR --> bound["$$bound: null | Array&lt;ReactClientValue&gt;"]\n        SR --> location["$$location?: Error (DEV only)"]\n    end\n    \n    subgraph "Symbol Tags"\n        SERVER_TAG["SERVER_REFERENCE_TAG<br/>Symbol.for(\'react.server.reference\')"]\n        CLIENT_TAG["CLIENT_REFERENCE_TAG<br/>Symbol.for(\'react.client.reference\')"]\n    end\n    \n    typeof -.-> SERVER_TAG\n    \n    subgraph "Registration"\n        registerServerReference["registerServerReference()"]\n        isServerReference["isServerReference()"]\n    end\n    \n    registerServerReference --> SR\n    SR --> isServerReference\n    \n    style SR fill:#f9f9f9\n    style typeof fill:#e8f4f8\n    style id fill:#e8f4f8\n    style bound fill:#e8f4f8\n```\n\n**Server Reference Registration**\n\nServer references are created using `registerServerReference()`:\n\nSources: [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js:111-130]()\n\nThe registration process:\n1. Marks the function with `$$typeof: SERVER_REFERENCE_TAG`\n2. Assigns a unique `$$id` (module path + export name)\n3. Initializes `$$bound` to `null`\n4. Attaches custom `.bind()` implementation\n5. In DEV, adds `$$location` for debugging\n\n### Custom Bind Implementation\n\nServer references override `Function.prototype.bind` to support argument binding:\n\n```mermaid\ngraph LR\n    subgraph "Bind Process"\n        Original["serverAction"]\n        BindCall["serverAction.bind(null, arg1, arg2)"]\n        NewRef["New ServerReference"]\n    end\n    \n    Original --> BindCall\n    BindCall --> NewRef\n    \n    subgraph "New Reference Properties"\n        NewRef --> id2["$$id: same as original"]\n        NewRef --> bound2["$$bound: [arg1, arg2]"]\n        NewRef --> bind2["bind: custom implementation"]\n    end\n    \n    style BindCall fill:#fff4e1\n    style NewRef fill:#f9f9f9\n```\n\nSources: [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js:62-103]()\n\nWhen `.bind()` is called on a server reference:\n1. Uses native `Function.prototype.bind` to create new function\n2. Copies `$$typeof` and `$$id` from original\n3. Concatenates new args with `$$bound` from original\n4. Attaches custom `.bind()` to the new function\n\n**Important**: The first argument (thisArg) must be `null` or `undefined`. In DEV, a warning is logged if a non-null thisArg is provided.\n\n---\n\n## Reply Encoding Protocol\n\nThe reply encoding protocol serializes client-side JavaScript values into a format that can be transmitted to the server and reconstructed.\n\n### Encoding Architecture\n\n```mermaid\ngraph TB\n    subgraph "Client Side"\n        ClientValue["Client JavaScript Value"]\n        encodeReply["ReactServerDOMClient.encodeReply()"]\n        processReply["processReply()"]\n        resolveToJSON["resolveToJSON() recursion"]\n    end\n    \n    ClientValue --> encodeReply\n    encodeReply --> processReply\n    processReply --> resolveToJSON\n    \n    subgraph "Serialization Output"\n        StringOutput["JSON string"]\n        FormDataOutput["FormData (for streams/blobs)"]\n    end\n    \n    resolveToJSON --> StringOutput\n    resolveToJSON --> FormDataOutput\n    \n    subgraph "Special Encodings"\n        ServerRef["Server Reference  $h{id}"]\n        Promise["Promise  $@{id}"]\n        TypedArray["TypedArray  ${tag}{id}"]\n        Stream["ReadableStream  $R{id}"]\n        FormDataRef["FormData  $K{id}"]\n        Undefined["undefined  $undefined"]\n        BigInt["BigInt  $n{value}"]\n        Date["Date  $D{isoString}"]\n    end\n    \n    resolveToJSON -.-> ServerRef\n    resolveToJSON -.-> Promise\n    resolveToJSON -.-> TypedArray\n    resolveToJSON -.-> Stream\n    resolveToJSON -.-> FormDataRef\n    resolveToJSON -.-> Undefined\n    resolveToJSON -.-> BigInt\n    resolveToJSON -.-> Date\n    \n    style encodeReply fill:#e8f4f8\n    style processReply fill:#e8f4f8\n```\n\n**Encoding Entry Point**\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:183-465]()\n\nThe `processReply()` function coordinates encoding:\n1. Maintains a `writtenObjects` WeakMap to handle circular references\n2. Tracks `pendingParts` for async values\n3. Upgrades to FormData when binary data or streams are present\n4. Returns either a JSON string or FormData\n\n### Value Encoding Reference\n\n| Type | Encoding | Example |\n|------|----------|---------|\n| `undefined` | `"$undefined"` | `undefined  "$undefined"` |\n| `-0` | `"$-0"` | `-0  "$-0"` |\n| `Infinity` | `"$Infinity"` | `Infinity  "$Infinity"` |\n| `NaN` | `"$NaN"` | `NaN  "$NaN"` |\n| `BigInt` | `"$n" + value` | `123n  "$n123"` |\n| `Date` | `"$D" + isoString` | `new Date()  "$D2024-01-01..."` |\n| `Map` | `"$Q" + id` | Outlined as separate chunk |\n| `Set` | `"$W" + id` | Outlined as separate chunk |\n| `FormData` | `"$K" + id` | Outlined as separate chunk |\n| `Blob` | `"$B" + id` | Outlined as separate chunk |\n| `TypedArray` | `"$" + tag + id` | `Uint8Array  "$o{id}"` |\n| `Promise` | `"$@" + id` | Async resolution |\n| `ServerReference` | `"$h" + id` | Bound args outlined separately |\n| `Iterator` | `"$i" + id` | Single-shot iteration |\n| `AsyncIterable` | `"$x" + id` | Multi-shot async iteration |\n| `ReadableStream` | `"$R" + id` (text) or `"$r" + id` (binary) | Streaming chunks |\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:103-170]()\n\n### Server Reference Encoding\n\nWhen encoding a server reference with bound arguments:\n\n```mermaid\ngraph TB\n    ServerRef["Server Reference"]\n    CheckBound{"Has $$bound?"}\n    \n    ServerRef --> CheckBound\n    \n    CheckBound -->|No| Simple["Encode as $h{id}"]\n    CheckBound -->|Yes| Complex["Outline bound args"]\n    \n    Complex --> EncodeArgs["processReply() on $$bound array"]\n    EncodeArgs --> OutlineChunk["Create separate chunk for args"]\n    OutlineChunk --> Reference["Encode as $h{id} with args reference"]\n    \n    style ServerRef fill:#f9f9f9\n    style Complex fill:#fff4e1\n```\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:556-607]()\n\nProcess:\n1. Check if `$$bound` is non-null\n2. If bound, outline the arguments array as a separate reply chunk\n3. Encode reference as `{id: $$id, bound: chunkId}` structure\n4. If not bound, encode as simple string `"$h" + id`\n\n### Streaming Values\n\nFor streams and async iterables, the encoding creates streaming channels:\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:260-304](), [packages/react-client/src/ReactFlightReplyClient.js:306-381]()\n\n**ReadableStream Encoding:**\n1. Upgrade to FormData mode\n2. Allocate a stream ID\n3. Create a reader and start reading\n4. For each chunk, append serialized value to FormData with stream ID\n5. When done, append close signal `"C"`\n\n**AsyncIterable Encoding:**\n1. Similar to ReadableStream\n2. Distinguish between single-shot (iterator === iterable) and multi-shot\n3. Encode close instruction with optional final value\n\n---\n\n## Reply Decoding Protocol\n\nThe server reconstructs client values from the encoded reply format.\n\n### Decoding Architecture\n\n```mermaid\ngraph TB\n    subgraph "Server Side"\n        EncodedInput["FormData or string body"]\n        decodeReply["ReactServerDOMServer.decodeReply()"]\n        createResponse["createResponse()"]\n        processReplyChunk["processReplyChunk()"]\n    end\n    \n    EncodedInput --> decodeReply\n    decodeReply --> createResponse\n    createResponse --> processReplyChunk\n    \n    subgraph "Response State"\n        ChunksMap["_chunks: Map&lt;number, Chunk&gt;"]\n        FormDataStore["_formData: FormData"]\n        BundlerConfig["_bundlerConfig: ServerManifest"]\n        TempRefs["_temporaryReferences"]\n    end\n    \n    createResponse --> ChunksMap\n    createResponse --> FormDataStore\n    createResponse --> BundlerConfig\n    createResponse --> TempRefs\n    \n    subgraph "Chunk Processing"\n        ParseJSON["JSON.parse() with revivers"]\n        InitializeChunk["initializeModelChunk()"]\n        ResolveRefs["Resolve cross-references"]\n    end\n    \n    processReplyChunk --> ParseJSON\n    ParseJSON --> InitializeChunk\n    InitializeChunk --> ResolveRefs\n    \n    subgraph "Output"\n        ReconstructedValue["Reconstructed JavaScript Value"]\n    end\n    \n    ResolveRefs --> ReconstructedValue\n    \n    style decodeReply fill:#e8f4f8\n    style createResponse fill:#e8f4f8\n```\n\n**Decoding Entry Point**\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:1113-1183]()\n\nThe `decodeReply()` function:\n1. Creates a `Response` object to track state\n2. Parses FormData entries or JSON string\n3. For each chunk, calls `processReplyChunk()`\n4. Returns root chunk (ID 0) as a Promise\n5. Resolves when all referenced chunks are initialized\n\n### Chunk State Machine\n\nEach chunk in the reply goes through these states:\n\n```mermaid\nstateDiagram-v2\n    [*] --> PENDING: Create chunk\n    PENDING --> RESOLVED_MODEL: Receive data\n    RESOLVED_MODEL --> INITIALIZED: Parse JSON\n    RESOLVED_MODEL --> BLOCKED: Reference not ready\n    BLOCKED --> INITIALIZED: All refs ready\n    PENDING --> ERRORED: Parsing error\n    INITIALIZED --> [*]\n    ERRORED --> [*]\n```\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:53-107]()\n\nChunk types:\n- **PendingChunk**: Waiting for data\n- **BlockedChunk**: Data received but references unresolved\n- **ResolvedModelChunk**: JSON string ready to parse\n- **InitializedChunk**: Final value ready\n- **ErroredChunk**: Failed to decode\n\n### JSON Revival\n\nThe decoder uses custom JSON revivers to handle special encodings:\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:595-951]()\n\nThe `parseModelString()` function handles prefixed values:\n- `"$undefined"`  `undefined`\n- `"$-0"`  `-0`\n- `"$Infinity"`  `Infinity`\n- `"$NaN"`  `NaN`\n- `"$n{digits}"`  `BigInt`\n- `"$D{isoString}"`  `Date`\n- `"$Q{id}"`  Reference to Map chunk\n- `"$W{id}"`  Reference to Set chunk\n- `"$h{id}"`  Server reference with optional bound args\n- `"$@{id}"`  Promise reference\n- `"${tag}{id}"`  Typed array reference\n\n### Server Reference Resolution\n\nWhen decoding a server reference:\n\n```mermaid\ngraph TB\n    RefString["$h{id} string"]\n    Parse["Parse reference structure"]\n    \n    RefString --> Parse\n    \n    HasBound{"Has bound args?"}\n    Parse --> HasBound\n    \n    HasBound -->|No| ResolveModule["resolveServerReference(bundlerConfig, id)"]\n    HasBound -->|Yes| DecodeBound["Decode bound args chunk"]\n    \n    DecodeBound --> CreateBound["createBoundServerReference()"]\n    CreateBound --> BoundFunc["Function with bound args"]\n    \n    ResolveModule --> Module["Server module function"]\n    \n    style Parse fill:#e8f4f8\n    style CreateBound fill:#fff4e1\n```\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:716-778]()\n\nProcess:\n1. Parse `$$id` from the reference\n2. If `$$bound` exists, decode the bound arguments chunk\n3. Use `resolveServerReference()` to load the module\n4. If bound, call `createBoundServerReference()` from Reply Client\n5. Return executable function\n\n---\n\n## Form Actions and Progressive Enhancement\n\nServer actions integrate with HTML forms to enable progressive enhancement, where forms work even without JavaScript.\n\n### Form Action Encoding\n\n```mermaid\ngraph TB\n    subgraph "Server Rendering"\n        ServerAction["Server Action Function"]\n        RenderForm["<form action={serverAction}>"]\n    end\n    \n    ServerAction --> RenderForm\n    \n    subgraph "HTML Output"\n        FormTag["<form action=... enctype=...>"]\n        HiddenInputs["Hidden inputs with encoded action"]\n    end\n    \n    RenderForm --> FormTag\n    RenderForm --> HiddenInputs\n    \n    subgraph "Client Behavior"\n        JSDisabled["JS Disabled: Native form submit"]\n        JSEnabled["JS Enabled: Intercept with React"]\n    end\n    \n    FormTag --> JSDisabled\n    FormTag --> JSEnabled\n    \n    JSDisabled --> HTTPPost["POST to server action endpoint"]\n    JSEnabled --> CallAction["Call action with FormData"]\n    \n    style RenderForm fill:#e8f4f8\n    style JSEnabled fill:#d4f4dd\n```\n\n**Form Action Flow**\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:642-686]()\n\nThe `encodeFormAction()` callback is provided by integrations (webpack, etc.):\n1. Takes a server reference ID and bound arguments\n2. Returns a `ReactCustomFormAction` object\n3. Contains action URL and method for form submission\n4. React inserts hidden inputs to encode the action\n\n**Progressive Enhancement:**\n- **Without JS**: Form submits normally to server action endpoint\n- **With JS**: React intercepts submit, encodes FormData, calls action directly\n- Result: Forms work regardless of JS availability\n\n### Form Data Encoding\n\nWhen a form is submitted:\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:688-763]()\n\nThe `encodeFormData()` function:\n1. Walks the FormData entries\n2. Identifies which entries are files/blobs\n3. Creates a filtered FormData with only files\n4. Encodes non-file entries as JSON\n5. Appends the JSON structure to FormData\n6. Returns the combined FormData\n\nThis allows mixing structured data (objects, arrays) with file uploads in a single form submission.\n\n---\n\n## Bound Arguments\n\nServer actions support partial application through `.bind()`, enabling arguments to be pre-bound on the server before sending to the client.\n\n### Binding Flow\n\n```mermaid\nsequenceDiagram\n    participant Server as Server (RSC Render)\n    participant Client as Client\n    participant ServerExec as Server (Action Execution)\n    \n    Server->>Server: Define serverAction()\n    Server->>Server: boundAction = serverAction.bind(null, \'presetArg\')\n    Server->>Client: Serialize boundAction with $$bound\n    \n    Note over Client: Client receives:<br/>{$$id, $$bound: chunk ref}\n    \n    Client->>Client: User calls boundAction(\'userArg\')\n    Client->>Client: encodeReply([\'userArg\'])\n    Client->>ServerExec: POST with encoded args\n    \n    ServerExec->>ServerExec: decodeReply()  [\'userArg\']\n    ServerExec->>ServerExec: Decode $$bound  [\'presetArg\']\n    ServerExec->>ServerExec: Concat: [\'presetArg\', \'userArg\']\n    ServerExec->>ServerExec: Execute serverAction(\'presetArg\', \'userArg\')\n    ServerExec->>Client: Return result\n```\n\n**Bound Arguments Storage**\n\nSources: [packages/react-server/src/ReactFlightServer.js:2507-2566]()\n\nWhen serializing a server reference with `$$bound`:\n1. Server outlines the bound array as a separate chunk\n2. Serializes the reference as `{id, bound}` structure\n3. Client reconstructs with bound args attached\n4. On invocation, concatenates bound args with call args\n\n**Chaining Binds**\n\nMultiple `.bind()` calls accumulate arguments:\n\n```javascript\nconst action1 = serverAction.bind(null, \'a\');\n// action1.$$bound = [\'a\']\n\nconst action2 = action1.bind(null, \'b\');\n// action2.$$bound = [\'a\', \'b\']\n```\n\nSources: [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js:77-80]()\n\n---\n\n## Streaming and Async Values\n\nBoth encoding and decoding support streaming and asynchronous values, enabling progressive data transmission.\n\n### Streaming Reply Encoding\n\n```mermaid\ngraph TB\n    subgraph "Client Encoding Stream"\n        AsyncValue["Promise or AsyncIterable"]\n        StreamID["Allocate stream ID"]\n        InitialReply["Return $@{id} immediately"]\n    end\n    \n    AsyncValue --> StreamID\n    StreamID --> InitialReply\n    \n    subgraph "Async Resolution"\n        ResolveValue["Value resolves"]\n        EncodeResolved["Encode resolved value"]\n        AppendChunk["Append to FormData with stream ID"]\n    end\n    \n    InitialReply --> ResolveValue\n    ResolveValue --> EncodeResolved\n    EncodeResolved --> AppendChunk\n    \n    subgraph "Stream Completion"\n        CloseSignal["Append \'C\' close signal"]\n        ResolvePending["Resolve pending parts counter"]\n    end\n    \n    AppendChunk --> CloseSignal\n    CloseSignal --> ResolvePending\n    \n    style AsyncValue fill:#fff4e1\n    style InitialReply fill:#e8f4f8\n```\n\n**Promise Encoding**\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:466-554]()\n\nThe `serializePromise()` function:\n1. Returns immediately with `$@{id}` reference\n2. Attaches `.then()` handlers to the promise\n3. When resolved, encodes the value\n4. Appends encoded value to FormData with the stream ID\n5. When FormData is complete, resolves the `processReply()` promise\n\n### Async Iterable Encoding\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:306-381]()\n\nThe `serializeAsyncIterable()` function:\n1. Distinguishes single-shot (iterator === iterable) vs multi-shot\n2. Encodes as `$x{id}` or `$X{id}`\n3. For each iteration result, appends to FormData\n4. Encodes done values if non-undefined\n5. Closes stream with `"C"` signal\n\n### Streaming Reply Decoding\n\nOn the server, streamed values are reconstructed progressively:\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:352-469]()\n\n**Stream Chunk Processing:**\n1. Each FormData entry with a stream ID is a chunk\n2. The first entry creates the stream structure\n3. Subsequent entries enqueue values\n4. The `"C"` entry closes the stream\n\n**Async Iterable Reconstruction:**\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:411-469]()\n\nThe `createAsyncIterable()` function:\n1. Creates a controller with enqueue/close/error methods\n2. Returns an async iterable that yields queued values\n3. Distinguishes single-shot vs multi-shot based on prefix\n\n---\n\n## Execution Flow Diagram\n\nThis diagram shows a complete round-trip from server action definition to execution:\n\n```mermaid\nsequenceDiagram\n    participant ServerRender as Server (RSC Render)\n    participant FlightStream as Flight Stream\n    participant ClientRuntime as Client Runtime\n    participant UserCode as User Code\n    participant ReplyEncoding as Reply Encoding\n    participant ServerAction as Server (Action Exec)\n    participant ServerModule as Server Module\n    \n    ServerRender->>ServerRender: Define greet(name)\n    ServerRender->>ServerRender: registerServerReference(greet, id)\n    ServerRender->>FlightStream: Serialize {$$typeof, $$id, $$bound}\n    \n    FlightStream->>ClientRuntime: Stream server reference\n    ClientRuntime->>ClientRuntime: Reconstruct proxy function\n    ClientRuntime->>UserCode: Provide greet()\n    \n    Note over UserCode: User clicks button,<br/>calls greet(\'Alice\')\n    \n    UserCode->>ReplyEncoding: greet(\'Alice\')\n    ReplyEncoding->>ReplyEncoding: encodeReply([\'Alice\'])\n    ReplyEncoding->>ServerAction: POST body with encoded args\n    \n    ServerAction->>ServerAction: decodeReply(body)\n    ServerAction->>ServerAction: resolveServerReference(id)\n    ServerAction->>ServerModule: Load module\n    ServerModule->>ServerAction: Return greet function\n    ServerAction->>ServerAction: Execute greet(...decodedArgs)\n    ServerAction->>ClientRuntime: Return result\n    \n    ClientRuntime->>UserCode: Resolve promise with result\n```\n\n**Complete Workflow:**\n\n1. **Server Render Phase**: Define and register server actions\n2. **Flight Streaming**: Serialize references with IDs\n3. **Client Reconstruction**: Create callable proxy functions\n4. **User Invocation**: Call action from client code\n5. **Reply Encoding**: Serialize arguments as FormData/JSON\n6. **Server Reception**: Decode reply and resolve module\n7. **Execution**: Run actual server function\n8. **Result Return**: Stream response back to client\n\nSources: [packages/react-server/src/ReactFlightServer.js:2507-2566](), [packages/react-client/src/ReactFlightReplyClient.js:183-465](), [packages/react-server/src/ReactFlightReplyServer.js:1113-1183]()\n\n---\n\n## Key Implementation Files\n\n| Component | File Path | Key Functions |\n|-----------|-----------|---------------|\n| Server Reference Registration | [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js]() | `registerServerReference()`, `isServerReference()`, custom `bind()` |\n| Reply Encoding | [packages/react-client/src/ReactFlightReplyClient.js]() | `encodeReply()`, `processReply()`, `resolveToJSON()` |\n| Reply Decoding | [packages/react-server/src/ReactFlightReplyServer.js]() | `decodeReply()`, `processReplyChunk()`, `parseModelString()` |\n| Server Reference Execution | [packages/react-server/src/ReactFlightReplyServer.js:716-778]() | Server reference resolution and bound arg handling |\n| Form Action Encoding | [packages/react-client/src/ReactFlightReplyClient.js:642-763]() | `encodeFormAction()`, `encodeFormData()` |\n| Bound Server References | [packages/react-client/src/ReactFlightReplyClient.js:69-71]() | `createBoundServerReference()`, `registerBoundServerReference()` |\n\nSources: All files listed in the table above.\n\n---\n\n# Page: Platform Implementations\n\n# Platform Implementations\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis section documents React\'s **platform implementations**the concrete renderers that adapt React\'s reconciler to specific environments. React maintains official implementations for browser DOM ([React DOM Implementation](#6.1)) and React Native ([React Native Renderers](#6.2)), along with specialized features like client-side hydration ([Hydration System](#6.3)) and view transitions ([View Transitions and Gesture Scheduling](#6.4)).\n\nThe foundation enabling these diverse platforms is the **host configuration abstraction layer**an interface between the reconciler and platform-specific code. The host config provides platform-specific implementations of operations like creating instances, updating properties, and managing tree structure. This abstraction allows the same reconciler logic to render to browser DOM, React Native, canvas-based renderers, test environments, and custom targets.\n\nFor the reconciler\'s architecture and how it processes the Fiber tree, see [React Reconciler](#4).\n\n## Platform Overview\n\nReact\'s architecture separates the **reconciler** (platform-agnostic tree diffing and scheduling) from **renderers** (platform-specific instance management and DOM/native manipulation). The primary platforms are:\n\n**React DOM** ([ReactFiberConfigDOM](#6.1)): Renders to browser DOM. Supports mutation mode, hydration of server-rendered HTML, resource management (stylesheets, scripts), singleton components (document head), and view transitions.\n\n**React Native Fabric** ([ReactFiberConfigFabric](#6.2)): New React Native architecture using persistence mode with immutable shadow nodes. Communicates with `nativeFabricUIManager` for native UI operations.\n\n**React Native Legacy** ([ReactFiberConfigNative](#6.2)): Original React Native renderer using mutation mode. Communicates with `UIManager` for native view management.\n\n**Test Renderer** ([ReactFiberConfigTestHost](#6.2)): In-memory tree representation for snapshot testing without actual rendering.\n\n**Noop Renderer** (createReactNoop): Testing-only renderer supporting both mutation and persistence modes for validating reconciler behavior.\n\nEach platform implements the host configuration interface to provide its specific behavior while using the shared reconciler logic.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-153](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-82](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:1-58](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:1-26](), [packages/react-noop-renderer/src/createReactNoop.js:1-111]()\n\n## Host Configuration Architecture\n\nThe host configuration interface defines a contract between the reconciler and the platform. The reconciler calls host config methods during the render and commit phases to perform platform-specific operations. Each renderer (react-dom, react-native-renderer, react-test-renderer, etc.) provides its own implementation of this interface.\n\n```mermaid\ngraph TB\n    subgraph "React Core"\n        Reconciler["Reconciler<br/>(WorkLoop, BeginWork, CommitWork)"]\n    end\n    \n    subgraph "Host Config Interface"\n        HostConfigInterface["Host Configuration Interface<br/>createInstance, commitUpdate,<br/>appendChild, etc."]\n    end\n    \n    subgraph "Platform Implementations"\n        DOM["ReactFiberConfigDOM<br/>Browser DOM operations"]\n        Fabric["ReactFiberConfigFabric<br/>React Native Fabric<br/>(Persistence Mode)"]\n        NativeLegacy["ReactFiberConfigNative<br/>React Native Legacy<br/>(Mutation Mode)"]\n        TestRenderer["ReactFiberConfigTestHost<br/>Test environment"]\n        NoopRenderer["createReactNoop<br/>Testing reconciler"]\n        CustomRenderer["ReactFiberConfig.custom<br/>Third-party renderers"]\n    end\n    \n    subgraph "Native APIs"\n        BrowserAPIs["Browser DOM APIs<br/>document.createElement,<br/>appendChild, etc."]\n        FabricUIManager["nativeFabricUIManager<br/>createNode, cloneNode,<br/>completeRoot"]\n        LegacyUIManager["UIManager<br/>createView, updateView,<br/>manageChildren"]\n        MemoryTree["In-Memory Tree<br/>(for testing)"]\n    end\n    \n    Reconciler -->|"calls"| HostConfigInterface\n    \n    HostConfigInterface -->|"implemented by"| DOM\n    HostConfigInterface -->|"implemented by"| Fabric\n    HostConfigInterface -->|"implemented by"| NativeLegacy\n    HostConfigInterface -->|"implemented by"| TestRenderer\n    HostConfigInterface -->|"implemented by"| NoopRenderer\n    HostConfigInterface -->|"implemented by"| CustomRenderer\n    \n    DOM --> BrowserAPIs\n    Fabric --> FabricUIManager\n    NativeLegacy --> LegacyUIManager\n    TestRenderer --> MemoryTree\n    NoopRenderer --> MemoryTree\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-292](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-160](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:1-115](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:1-59](), [packages/react-noop-renderer/src/createReactNoop.js:1-111]()\n\n## Core Host Configuration Methods\n\nThe host configuration interface consists of several categories of methods that the reconciler invokes at different stages of the rendering process.\n\n```mermaid\ngraph LR\n    subgraph "Instance Management"\n        createInstance["createInstance<br/>(type, props, rootContainer, hostContext)"]\n        createTextInstance["createTextInstance<br/>(text, rootContainer, hostContext)"]\n        createHoistableInstance["createHoistableInstance<br/>(type, props, rootContainer)<br/>(DOM only)"]\n    end\n    \n    subgraph "Context Management"\n        getRootHostContext["getRootHostContext<br/>(rootContainer)"]\n        getChildHostContext["getChildHostContext<br/>(parentContext, type)"]\n    end\n    \n    subgraph "Initial Render"\n        appendInitialChild["appendInitialChild<br/>(parent, child)"]\n        finalizeInitialChildren["finalizeInitialChildren<br/>(instance, type, props)"]\n    end\n    \n    subgraph "Commit Phase"\n        commitMount["commitMount<br/>(instance, type, props)"]\n        commitUpdate["commitUpdate<br/>(instance, type, oldProps, newProps)"]\n        commitTextUpdate["commitTextUpdate<br/>(textInstance, oldText, newText)"]\n    end\n    \n    subgraph "Tree Manipulation - Mutation"\n        appendChild["appendChild<br/>(parent, child)"]\n        insertBefore["insertBefore<br/>(parent, child, beforeChild)"]\n        removeChild["removeChild<br/>(parent, child)"]\n    end\n    \n    subgraph "Tree Manipulation - Persistence"\n        cloneInstance["cloneInstance<br/>(instance, type, oldProps, newProps)"]\n        createContainerChildSet["createContainerChildSet"]\n        replaceContainerChildren["replaceContainerChildren<br/>(container, newChildren)"]\n    end\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:484-608](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:176-220](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:130-169](), [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:56-188]()\n\n## Platform Type Definitions\n\nEach platform implementation defines its own types for instances, containers, and other platform-specific data structures:\n\n| Type | ReactFiberConfigDOM | ReactFiberConfigFabric | ReactFiberConfigNative | ReactFiberConfigTestHost |\n|------|---------------------|------------------------|------------------------|--------------------------|\n| **Type** | `string` (element tag name) | `string` (view type) | `string` (view type) | `string` |\n| **Instance** | `Element` (DOM element) | `{node: Node, canonical: {...}}` (shadow node) | `ReactNativeFiberHostComponent` | `{type, props, children, tag: \'INSTANCE\'}` |\n| **TextInstance** | `Text` (DOM text node) | `{node: Node}` (text shadow node) | `number` (text tag) | `{text, tag: \'TEXT\'}` |\n| **Container** | `Element \\| Document \\| DocumentFragment` | `{containerTag: number, publicInstance}` | `{containerTag: number, publicInstance}` | `{children: [], createNodeMock, tag: \'CONTAINER\'}` |\n| **HostContext** | `HostContextNamespace` (0=None, 1=SVG, 2=Math) | `{isInAParentText: boolean}` | `{isInAParentText: boolean}` | `Object` (NO_CONTEXT) |\n| **UpdatePayload** | `Array<mixed>` (property updates) | `Object` (attribute payload) | `Object` (unused) | `Object` |\n| **Mode** | Mutation | Persistence | Mutation | Mutation |\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:153-250](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:93-139](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:59-73](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:26-58]()\n\n## Mutation vs Persistence Modes\n\nHost configurations can operate in two different modes depending on the platform\'s capabilities:\n\n```mermaid\ngraph TB\n    subgraph "Mutation Mode (DOM, React Native Legacy, Test Renderer)"\n        MutationFlag["supportsMutation = true<br/>supportsPersistence = false"]\n        \n        MutationRender["Render Phase:<br/>Create instances and build tree"]\n        MutationCommit["Commit Phase:<br/>Mutate existing instances in-place"]\n        \n        MutationOps["Operations:<br/> appendChild<br/> insertBefore<br/> removeChild<br/> commitUpdate (mutate props)<br/> commitTextUpdate"]\n        \n        MutationFlag --> MutationRender\n        MutationRender --> MutationCommit\n        MutationCommit --> MutationOps\n    end\n    \n    subgraph "Persistence Mode (React Native Fabric)"\n        PersistenceFlag["supportsMutation = false<br/>supportsPersistence = true"]\n        \n        PersistenceRender["Render Phase:<br/>Clone and build new tree"]\n        PersistenceCommit["Commit Phase:<br/>Replace entire tree atomically"]\n        \n        PersistenceOps["Operations:<br/> cloneInstance<br/> createContainerChildSet<br/> appendChildToContainerChildSet<br/> replaceContainerChildren<br/> No in-place mutations"]\n        \n        PersistenceFlag --> PersistenceRender\n        PersistenceRender --> PersistenceCommit\n        PersistenceCommit --> PersistenceOps\n    end\n```\n\n**Mutation Mode** (DOM, React Native Legacy): Instances can be mutated in place. The reconciler creates instances once and then updates them by calling methods like `commitUpdate`, `appendChild`, `removeChild`. This is more memory efficient but requires careful synchronization.\n\n**Persistence Mode** (React Native Fabric): Instances are immutable. The reconciler clones instances to create modified versions, builds a complete new tree, and replaces the old tree atomically. This provides better concurrency characteristics and aligns with React Native\'s new architecture.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:811](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:449](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:377](), [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js:22]()\n\n## Platform-Specific Instance Creation\n\nEach platform implements `createInstance` differently based on its underlying rendering API. DOM creates actual browser elements with namespace handling for SVG/MathML, while React Native allocates tags and communicates with native UI managers. For detailed implementation specifics, see [React DOM Implementation](#6.1) and [React Native Renderers](#6.2).\n\n**DOM**: Calls `document.createElement()` or `document.createElementNS()` based on namespace context, then sets initial properties and caches the fiber node reference.\n\n**React Native Fabric**: Allocates a unique tag, gets the view configuration, creates an attribute payload, and calls `nativeFabricUIManager.createNode()` to create an immutable shadow node.\n\n**React Native Legacy**: Allocates a tag, creates an update payload, calls `UIManager.createView()`, and wraps the result in a `ReactNativeFiberHostComponent` instance.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:484-608](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:176-220](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:130-169]()\n\n## Host Context Management\n\nHost context flows down the tree during rendering and provides namespace/environment information needed for instance creation. Different platforms use it for different purposes:\n\n**DOM**: Tracks namespace (None, SVG, Math) to create elements with the correct namespace. SVG and MathML elements require `createElementNS`.\n\n```\ngetRootHostContext: Determine initial namespace from root element\ngetChildHostContext: Update namespace when entering/leaving <svg>, <math>, or <foreignObject>\n```\n\n**React Native**: Tracks whether rendering is occurring within a Text component, which affects validation (text strings must be inside `<Text>`).\n\n```\ngetRootHostContext: Returns {isInAParentText: false}\ngetChildHostContext: Updates isInAParentText based on component type (RCTText, AndroidTextInput, etc.)\n```\n\n**Test/Noop Renderers**: Returns a constant `NO_CONTEXT` object since no special context is needed.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:302-406](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:259-291](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:264-287]()\n\n## Priority and Event Management\n\nHost configurations provide methods for managing update priorities and tracking events:\n\n| Method | Purpose | DOM Implementation | React Native Implementation |\n|--------|---------|-------------------|----------------------------|\n| `setCurrentUpdatePriority` | Set the current update priority | Stores in module variable | Stores in module variable |\n| `getCurrentUpdatePriority` | Get the current update priority | Returns stored priority | Returns stored priority |\n| `resolveUpdatePriority` | Resolve priority for a batch of work | Returns current or defers to event priority | Returns current or default priority |\n| `trackSchedulerEvent` | Track the current browser event | Stores `window.event` | No-op |\n| `resolveEventType` | Get the current event type | Returns `window.event.type` | Returns null |\n| `resolveEventTimeStamp` | Get the current event timestamp | Returns `window.event.timeStamp` | Returns -1.1 |\n| `shouldAttemptEagerTransition` | Check if should render transitions synchronously | Checks if `popstate` event | Returns false |\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:709-747](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:386-433](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:343-371]()\n\n## Commit Lifecycle Methods\n\nThe reconciler invokes these methods during the commit phase to finalize changes:\n\n**`prepareForCommit(containerInfo)`**: Called before mutations begin. Returns an object that will be passed to `resetAfterCommit`. DOM uses this to disable events and capture selection state. React Native returns null (no-op).\n\n**`resetAfterCommit(containerInfo)`**: Called after mutations complete. DOM restores event handling and selection. React Native is a no-op.\n\n**`commitMount(instance, type, props, internalInstanceHandle)`**: Called for instances that returned `true` from `finalizeInitialChildren`. Used to implement effects that should happen after the instance is in the tree (e.g., auto-focus, triggering image load events).\n\n**`commitUpdate(instance, type, oldProps, newProps, internalInstanceHandle)`**: Called to update an existing instance with new props. DOM calls `updateProperties` to diff and apply property changes. React Native calls `UIManager.updateView` with diffed payload.\n\n**`commitTextUpdate(textInstance, oldText, newText)`**: Called to update a text node. DOM sets `nodeValue`, React Native calls `UIManager.updateView`.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:412-450](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:813-872](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:917-942](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:317-467]()\n\n## Hydration Support\n\nReact DOM implements client-side **hydration** to attach React to server-rendered HTML. The host config provides methods for traversing and validating existing DOM nodes during initial render:\n\n**`hydrateInstance(instance, type, props, hostContext)`**: Validates and updates a DOM element to match React props. Returns an update payload if properties differ.\n\n**`hydrateTextInstance(textInstance, text, internalInstanceHandle)`**: Validates text node content matches expected text. Returns `true` if text differs (triggering a warning in DEV).\n\n**`getNextHydratableSibling(instance)`**: Returns the next DOM sibling that can be hydrated.\n\n**`getFirstHydratableChild(parentInstance)`**: Returns the first hydratable child of a DOM node.\n\n**`hydrateRootInstance(container)`**: Clears comment nodes and prepares the root container for hydration.\n\n**`shouldDeleteUnhydratedTailInstances()`**: Returns `true` to delete remaining DOM nodes after hydration completes.\n\nThe hydration process handles mismatches, supports Suspense boundaries, and enables selective hydration for improved time-to-interactive. For complete details, see [Hydration System](#6.3).\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1281-1590]()\n\n## View Transitions and Gesture Scheduling\n\nReact DOM includes experimental support for the View Transition API to enable smooth animated transitions between UI states. The host config provides methods for managing view transition instances and gesture-driven animations:\n\n**`startViewTransition(root, updater, options)`**: Initiates a view transition with callback for custom animation timelines.\n\n**`cloneMutableInstance(instance, keepChildren)`**: Clones DOM elements to create animation pairs for view transitions.\n\n**View Transition Instance Management**: Methods for applying/restoring transition names, measuring instance geometry, and tracking viewport visibility.\n\n**Gesture Scheduling**: Integration with gesture recognizers to drive view transitions based on user input (swipes, drags).\n\nThe system coordinates with `ReactFiberCommitViewTransitions` to identify animated elements, clone instances for animation pairs, measure geometry changes, and execute transition animations. For complete details, see [View Transitions and Gesture Scheduling](#6.4).\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:613-638](), [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js:1-50](), [packages/react-reconciler/src/ReactFiberApplyGesture.js:1-100]()\n\n## Testing and Third-Party Renderers\n\n### Test Renderer\n\nThe test renderer creates an in-memory tree representation without rendering to any actual surface. Instances are plain objects with `tag: \'INSTANCE\'` or `tag: \'TEXT\'`. This is used for snapshot testing and asserting on React\'s output without a DOM.\n\n**Sources:** [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:158-174](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:216-227]()\n\n### Noop Renderer\n\nThe noop renderer is similar to the test renderer but provides both mutation and persistence mode implementations. It\'s primarily used for testing the reconciler itself and validating reconciler behavior without platform-specific complications.\n\n**Sources:** [packages/react-noop-renderer/src/createReactNoop.js:111-452]()\n\n### Custom Renderers (Third-Party)\n\nThe `react-reconciler` package allows third parties to create custom renderers by passing a host config object to the reconciler factory function. The `ReactFiberConfig.custom.js` file serves as a shim that forwards all host config methods from a `$$$config` variable (passed as an argument to the reconciler bundle).\n\n```mermaid\ngraph LR\n    CustomRenderer["Custom Renderer Package"]\n    HostConfigObject["Host Config Object<br/>{createInstance, commitUpdate, ...}"]\n    ReconcilerFactory["ReactFiberReconciler(config)"]\n    ReconcilerInstance["Reconciler Instance<br/>{createContainer, updateContainer, ...}"]\n    \n    CustomRenderer --> HostConfigObject\n    HostConfigObject --> ReconcilerFactory\n    ReconcilerFactory --> ReconcilerInstance\n    \n    ReconcilerInstance -->|"calls during render/commit"| HostConfigObject\n```\n\n**Sources:** [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:1-285](), [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js:41-121]()\n\n## Optional Features and Capabilities\n\nHost configurations can opt into or out of various capabilities by implementing specific methods or setting flags:\n\n| Feature | Flag/Methods | DOM | Fabric | Native Legacy | Test |\n|---------|-------------|-----|--------|---------------|------|\n| **Mutation** | `supportsMutation` |  |  |  |  |\n| **Persistence** | `supportsPersistence` |  |  |  |  |\n| **Hydration** | `supportsHydration` |  |  |  |  |\n| **Microtasks** | `supportsMicrotasks` |  |  |  |  |\n| **Resources** | `supportsResources` |  |  |  |  |\n| **Singletons** | `supportsSingletons` |  |  |  |  |\n| **Test Selectors** | `supportsTestSelectors` |  |  |  |  |\n| **Fragment Instances** | `createFragmentInstance` |  |  | No-op | No-op |\n| **View Transitions** | `startViewTransition` | Planned | No-op | No-op | No-op |\n\nMost platforms import default implementations for unsupported features from modules like `ReactFiberConfigWithNoHydration`, `ReactFiberConfigWithNoResources`, etc., which provide no-op implementations or throw errors.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:292](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:160-165](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:115-121](), [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js:22-60]()\n\n## Summary\n\nThe host configuration abstraction is the foundation of React\'s platform independence. By defining a clear interface between the reconciler and platform-specific code, React can:\n\n- Render to vastly different targets (DOM, native mobile, canvas, terminals, etc.)\n- Support different rendering paradigms (mutation vs persistence)\n- Optimize for platform-specific capabilities (hydration, resources, singletons)\n- Enable third-party renderers without forking the reconciler\n\nEach platform implementation makes trade-offs based on its constraintsDOM uses mutation for efficiency and hydration support, Fabric uses persistence for better concurrency, test renderers prioritize simplicity and determinism. The host config interface accommodates all these approaches while keeping the reconciler\'s core logic platform-agnostic.\n\n---\n\n# Page: React DOM Implementation\n\n# React DOM Implementation\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes the React DOM host configuration implementation (`ReactFiberConfigDOM`), which serves as the bridge between React\'s reconciler and the browser\'s DOM APIs. This implementation defines how React creates, updates, and manages DOM elements during rendering and commits.\n\nFor information about the host configuration abstraction itself, see [Host Configuration Abstraction](#4.6). For hydration-specific functionality, see [Hydration System](#6.3). For view transition coordination, see [View Transitions and Gesture Scheduling](#6.4).\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-150]()\n\n## Architecture Overview\n\nThe DOM host configuration implements the interface expected by the React reconciler, translating reconciler operations into browser DOM manipulations. It operates in mutation mode, directly modifying the DOM tree as changes occur.\n\n```mermaid\ngraph TB\n    subgraph "React Reconciler"\n        Reconciler["React Reconciler<br/>Work Loop & Commit"]\n        HostConfigInterface["Host Config Interface<br/>createInstance, commitUpdate, etc."]\n    end\n    \n    subgraph "ReactFiberConfigDOM"\n        InstanceCreation["Instance Creation<br/>createInstance()<br/>createTextInstance()"]\n        PropertyMgmt["Property Management<br/>setInitialProperties()<br/>updateProperties()"]\n        MutationOps["Mutation Operations<br/>appendChild()<br/>insertBefore()<br/>commitUpdate()"]\n        EventIntegration["Event Integration<br/>listenToAllSupportedEvents()"]\n        ResourceMgmt["Resource Management<br/>createHoistableInstance()"]\n        HostContext["Host Context<br/>Namespace Tracking"]\n    end\n    \n    subgraph "Browser APIs"\n        DOM["DOM APIs<br/>createElement, appendChild, etc."]\n        EventSystem["Browser Event System"]\n    end\n    \n    Reconciler --> HostConfigInterface\n    HostConfigInterface --> InstanceCreation\n    HostConfigInterface --> PropertyMgmt\n    HostConfigInterface --> MutationOps\n    HostConfigInterface --> ResourceMgmt\n    HostConfigInterface --> HostContext\n    \n    InstanceCreation --> DOM\n    PropertyMgmt --> DOM\n    MutationOps --> DOM\n    EventIntegration --> EventSystem\n    ResourceMgmt --> DOM\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-292]()\n\n## Type System\n\nReactFiberConfigDOM defines the core types that represent DOM constructs within the reconciler.\n\n### Core Types\n\n| Type | Definition | Description |\n|------|------------|-------------|\n| `Type` | `string` | Element type (e.g., \'div\', \'span\') |\n| `Props` | `object` | React props object with DOM-specific properties |\n| `Container` | `Element \\| Document \\| DocumentFragment` | Root container element with `_reactRootContainer` field |\n| `Instance` | `Element` | A DOM element instance |\n| `TextInstance` | `Text` | A DOM text node |\n| `HostContext` | `HostContextDev \\| HostContextProd` | Namespace context (SVG, MathML, or HTML) |\n| `UpdatePayload` | `Array<mixed>` | Array of alternating property keys and values |\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:153-248]()\n\n### Instance Types Diagram\n\n```mermaid\ngraph LR\n    Container["Container<br/>(Element/Document/DocumentFragment)"]\n    Instance["Instance<br/>(Element)"]\n    TextInstance["TextInstance<br/>(Text)"]\n    HydratableInstance["HydratableInstance<br/>(Instance | TextInstance | SuspenseInstance | ActivityInstance)"]\n    \n    Container -->|"contains"| Instance\n    Container -->|"contains"| TextInstance\n    Instance -->|"children"| Instance\n    Instance -->|"children"| TextInstance\n    Instance -.->|"is a"| HydratableInstance\n    TextInstance -.->|"is a"| HydratableInstance\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:211-237]()\n\n## Host Context Management\n\nThe host context tracks the current namespace (HTML, SVG, MathML) to ensure elements are created with the correct namespace URI. This is critical for proper rendering of SVG and MathML elements within HTML documents.\n\n### Namespace Constants\n\n```mermaid\ngraph TD\n    HostContextNamespace["HostContextNamespace<br/>opaque type: 0 | 1 | 2"]\n    \n    HostContextNamespace --> None["HostContextNamespaceNone = 0<br/>(HTML namespace)"]\n    HostContextNamespace --> Svg["HostContextNamespaceSvg = 1<br/>(SVG namespace)"]\n    HostContextNamespace --> Math["HostContextNamespaceMath = 2<br/>(MathML namespace)"]\n```\n\n### Context Flow\n\nThe reconciler calls `getRootHostContext` when entering a root container, then `getChildHostContext` for each child element to determine the appropriate namespace.\n\n```mermaid\ngraph TB\n    GetRoot["getRootHostContext(rootContainer)"]\n    CheckNodeType{"rootContainer<br/>nodeType"}\n    DocumentNode["DOCUMENT_NODE or<br/>DOCUMENT_FRAGMENT_NODE"]\n    ElementNode["ELEMENT_NODE"]\n    \n    GetRoot --> CheckNodeType\n    CheckNodeType -->|"9 or 11"| DocumentNode\n    CheckNodeType -->|"1"| ElementNode\n    \n    DocumentNode --> CheckDocElement{"documentElement<br/>namespaceURI"}\n    CheckDocElement -->|"svg"| ReturnSvg["Return HostContextNamespaceSvg"]\n    CheckDocElement -->|"math"| ReturnMath["Return HostContextNamespaceMath"]\n    CheckDocElement -->|"other"| ReturnNone["Return HostContextNamespaceNone"]\n    \n    ElementNode --> GetOwnContext["getOwnHostContext(namespaceURI)"]\n    GetOwnContext --> GetChildContext["getChildHostContextProd(context, type)"]\n```\n\nKey functions:\n- `getRootHostContext(rootContainerInstance)` [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:302-355]()\n- `getChildHostContext(parentHostContext, type)` [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:391-406]()\n- `getChildHostContextProd(parentNamespace, type)` [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:368-389]()\n\n### Namespace Transitions\n\nSpecial handling exists for namespace transitions:\n- Entering `<svg>` from HTML switches to SVG namespace\n- Entering `<math>` from HTML switches to MathML namespace  \n- `<foreignObject>` within SVG returns to HTML namespace\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:284-406]()\n\n## Instance Creation\n\nDOM instances are created during the reconciler\'s render phase and finalized during the commit phase.\n\n### Regular Instance Creation\n\n```mermaid\ngraph TB\n    CreateInstance["createInstance(type, props, rootContainer, hostContext, fiber)"]\n    \n    CreateInstance --> CheckContext{"hostContext<br/>namespace"}\n    \n    CheckContext -->|"Svg"| CreateSvg["ownerDocument.createElementNS<br/>(SVG_NAMESPACE, type)"]\n    CheckContext -->|"Math"| CreateMath["ownerDocument.createElementNS<br/>(MATH_NAMESPACE, type)"]\n    CheckContext -->|"None"| CheckSpecial{"Special element?"}\n    \n    CheckSpecial -->|"\'script\'"| CreateScript["Create via innerHTML<br/>to prevent execution"]\n    CheckSpecial -->|"\'select\'"| CreateSelect["createElement(\'select\')<br/>+ handle multiple/size"]\n    CheckSpecial -->|"other"| CreateNormal["createElement(type)"]\n    \n    CreateSvg --> Cache["precacheFiberNode(fiber, element)"]\n    CreateMath --> Cache\n    CreateScript --> Cache\n    CreateSelect --> Cache\n    CreateNormal --> Cache\n    \n    Cache --> UpdateProps["updateFiberProps(element, props)"]\n    UpdateProps --> Return["Return element"]\n```\n\nThe `createInstance` function:\n1. Determines the owner document from the root container\n2. Creates the element with the appropriate namespace\n3. Caches the fiber-to-DOM mapping via `precacheFiberNode`\n4. Stores props on the DOM node via `updateFiberProps`\n5. Does NOT call `setInitialProperties` (that happens in `finalizeInitialChildren`)\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:484-608]()\n\n### Hoistable Instance Creation\n\nHoistable instances are special DOM elements (like `<link>`, `<style>`, `<script>`) that can be "hoisted" to the document head for resource management.\n\n```mermaid\ngraph LR\n    CreateHoistable["createHoistableInstance(type, props, rootContainer, fiber)"]\n    CreateHoistable --> CreateElem["createElement(type)"]\n    CreateElem --> PrecacheAndProps["precacheFiberNode + updateFiberProps"]\n    PrecacheAndProps --> SetInitial["setInitialProperties(element, type, props)"]\n    SetInitial --> Mark["markNodeAsHoistable(element)"]\n    Mark --> Return["Return element"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:452-468]()\n\n### Text Instance Creation\n\nText nodes are simpler:\n\n```mermaid\ngraph LR\n    CreateText["createTextInstance(text, rootContainer, hostContext, fiber)"]\n    CreateText --> Validate["validateTextNesting<br/>(DEV only)"]\n    Validate --> CreateNode["ownerDocument.createTextNode(text)"]\n    CreateNode --> Precache["precacheFiberNode(fiber, textNode)"]\n    Precache --> Return["Return textNode"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:679-701]()\n\n## Property Management\n\nProperties (React props) are translated into DOM attributes and properties through dedicated helper modules.\n\n### Property Application Flow\n\n```mermaid\ngraph TB\n    Mount["Mount (New Element)"]\n    Update["Update (Existing Element)"]\n    \n    Mount --> AppendChild["appendInitialChild(parent, child)"]\n    AppendChild --> Finalize["finalizeInitialChildren(element, type, props)"]\n    Finalize --> SetInitial["setInitialProperties(element, type, props)"]\n    \n    Update --> CommitUpdate["commitUpdate(element, type, oldProps, newProps)"]\n    CommitUpdate --> UpdateProps["updateProperties(element, type, oldProps, newProps)"]\n    UpdateProps --> UpdateFiberProps["updateFiberProps(element, newProps)"]\n```\n\nKey functions from `ReactDOMComponent`:\n- `setInitialProperties(domElement, tag, props)` - Applied during finalization [packages/react-dom-bindings/src/client/ReactDOMComponent.js]()\n- `updateProperties(domElement, tag, lastProps, nextProps)` - Applied during commit update [packages/react-dom-bindings/src/client/ReactDOMComponent.js]()\n\nSpecial property handling includes:\n- `dangerouslySetInnerHTML` - Sets innerHTML\n- `children` (when string/number) - Sets textContent  \n- `style` - Object converted to CSS string\n- `autoFocus` - Handled in `commitMount`\n- Event handlers - Registered with event system\n- `value`, `checked`, `selected` - Special form control properties\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:78-86](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:917-930]()\n\n## Mutation Operations\n\nReactFiberConfigDOM operates in mutation mode (`supportsMutation = true`), directly modifying the DOM tree. All mutation operations support the `moveBefore` API when available.\n\n### Core Mutation Methods\n\n| Method | Purpose | When Called |\n|--------|---------|-------------|\n| `appendChild(parent, child)` | Append child to end | Repositioning during updates |\n| `appendChildToContainer(container, child)` | Append to root container | Mounting root content |\n| `insertBefore(parent, child, before)` | Insert child before sibling | Reordering, insertion |\n| `insertInContainerBefore(container, child, before)` | Insert into root before sibling | Root-level insertions |\n| `removeChild(parent, child)` | Remove child from parent | Deletions |\n| `removeChildFromContainer(container, child)` | Remove from root | Root-level deletions |\n\n### moveBefore Feature Detection\n\nReact detects and uses the `moveBefore` DOM API when available for more efficient repositioning:\n\n```mermaid\ngraph TB\n    AppendChild["appendChild(parentInstance, child)"]\n    \n    CheckMoveBefore{"supportsMoveBefore &&<br/>child.parentNode !== null"}\n    \n    AppendChild --> CheckMoveBefore\n    CheckMoveBefore -->|"true"| UseMoveBefore["parentInstance.moveBefore(child, null)"]\n    CheckMoveBefore -->|"false"| UseAppend["parentInstance.appendChild(child)"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:944-960]()\n\n### Commit Operations\n\n```mermaid\ngraph TB\n    CommitMount["commitMount(element, type, props, fiber)"]\n    CommitUpdate["commitUpdate(element, type, oldProps, newProps, fiber)"]\n    CommitTextUpdate["commitTextUpdate(textInstance, oldText, newText)"]\n    \n    CommitMount --> CheckAutoFocus{"type matches form element<br/>& autoFocus?"}\n    CheckAutoFocus -->|"yes"| Focus["element.focus()"]\n    CheckAutoFocus -->|"img + src"| ReassignSrc["Reassign src/srcSet<br/>to trigger load event"]\n    \n    CommitUpdate --> UpdateProperties["updateProperties(element, type, oldProps, newProps)"]\n    UpdateProperties --> UpdateFiberProps["updateFiberProps(element, newProps)"]\n    \n    CommitTextUpdate --> SetNodeValue["textInstance.nodeValue = newText"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:813-872](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:917-942]()\n\n## Event System Integration\n\nReactFiberConfigDOM integrates with React\'s synthetic event system through several key functions.\n\n### Event Setup\n\n```mermaid\ngraph LR\n    PrepareForCommit["prepareForCommit(container)"]\n    PrepareForCommit --> DisableEvents["ReactBrowserEventEmitterSetEnabled(false)"]\n    DisableEvents --> SaveSelection["getSelectionInformation(container)"]\n    \n    ResetAfterCommit["resetAfterCommit(container)"]\n    ResetAfterCommit --> RestoreSelection["restoreSelection(selectionInfo, container)"]\n    RestoreSelection --> EnableEvents["ReactBrowserEventEmitterSetEnabled(true)"]\n    \n    PreparePortal["preparePortalMount(portalInstance)"]\n    PreparePortal --> ListenAll["listenToAllSupportedEvents(portalInstance)"]\n```\n\nThe event system is temporarily disabled during commits to prevent unwanted event dispatching while the DOM is being mutated.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:412-450](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:767-769]()\n\n### Priority and Event Tracking\n\n```mermaid\ngraph TB\n    TrackEvent["trackSchedulerEvent()"]\n    TrackEvent --> SaveEvent["schedulerEvent = window.event"]\n    \n    ResolveType["resolveEventType()"]\n    ResolveType --> CheckEvent{"event && event !== schedulerEvent?"}\n    CheckEvent -->|"yes"| ReturnType["Return event.type"]\n    CheckEvent -->|"no"| ReturnNull["Return null"]\n    \n    ResolveTimestamp["resolveEventTimeStamp()"]\n    ResolveTimestamp --> CheckEvent2{"event && event !== schedulerEvent?"}\n    CheckEvent2 -->|"yes"| ReturnTS["Return event.timeStamp"]\n    CheckEvent2 -->|"no"| ReturnDefault["Return -1.1"]\n```\n\nThese functions help the reconciler determine the priority and nature of the current event for scheduling purposes.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:734-747]()\n\n### Eager Transitions\n\n```mermaid\ngraph TB\n    ShouldAttempt["shouldAttemptEagerTransition()"]\n    CheckEventType{"event.type === \'popstate\'"}\n    \n    ShouldAttempt --> CheckEventType\n    CheckEventType -->|"no"| ReturnFalse["Return false"]\n    CheckEventType -->|"yes"| CheckCached{"event === currentPopstateTransitionEvent?"}\n    CheckCached -->|"yes"| ReturnFalse2["Return false<br/>(already attempted)"]\n    CheckCached -->|"no"| CacheAndReturn["currentPopstateTransitionEvent = event<br/>Return true"]\n```\n\nThis optimization attempts to render popstate transitions synchronously to avoid flicker during browser history navigation.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:709-732]()\n\n## Resource Management\n\nReactFiberConfigDOM implements special handling for "hoistable" resources - elements like stylesheets and scripts that should be singleton instances in the document head.\n\n### Hoistable Elements\n\nResources are marked as hoistable through the `markNodeAsHoistable` function, which sets an internal flag on the DOM node:\n\n```mermaid\ngraph LR\n    CreateHoistable["createHoistableInstance()"]\n    CreateHoistable --> CreateElement["createElement(type)"]\n    CreateElement --> SetProps["setInitialProperties()"]\n    SetProps --> MarkHoistable["markNodeAsHoistable(element)"]\n    \n    CheckHoistable["isMarkedHoistable(element)"]\n    CheckHoistable --> ReadFlag["Check internal flag"]\n    \n    GetResources["getResourcesFromRoot(root)"]\n    GetResources --> ReturnSet["Return Set of hoistable instances"]\n```\n\nThe hoisting mechanism ensures that:\n- Multiple identical `<link>` or `<script>` elements are deduplicated\n- Resources are moved to the document `<head>`\n- Resources persist across re-renders if they remain in the tree\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js:56-59](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:452-468]()\n\n### Resource Validation\n\nFor stylesheet links, React validates props to ensure correct resource semantics:\n\n```mermaid\ngraph TB\n    ValidateLink["validateLinkPropsForStyleResource(props)"]\n    \n    ValidateLink --> CheckRel{"props.rel === \'stylesheet\'?"}\n    CheckRel -->|"no"| Error1["Warn: link must have rel=\'stylesheet\'"]\n    \n    CheckRel -->|"yes"| CheckHref{"props.href present?"}\n    CheckHref -->|"no"| Error2["Warn: stylesheet link must have href"]\n    \n    CheckHref -->|"yes"| CheckOnLoad{"props.onLoad or props.onError?"}\n    CheckOnLoad -->|"yes"| Error3["Warn: stylesheet links in head<br/>cannot have onLoad/onError"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js:138]()\n\n## Special Element Handling\n\nSeveral element types require special treatment beyond standard property application.\n\n### Script Elements\n\nScript tags must be created in a way that prevents execution:\n\n```mermaid\ngraph LR\n    CreateScript["Creating \'script\' element"]\n    CreateDiv["Create temporary div"]\n    SetInnerHTML["div.innerHTML = \'<script></script>\'"]\n    ExtractScript["Extract script element"]\n    RemoveFromDiv["div.removeChild(firstChild)"]\n    Return["Return non-executing script element"]\n    \n    CreateScript --> CreateDiv --> SetInnerHTML --> ExtractScript --> RemoveFromDiv --> Return\n```\n\nThis ensures scripts don\'t execute during render, only during commit if explicitly mounted.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:523-542]()\n\n### Select Elements\n\nSelect elements handle `multiple` and `size` props specially:\n\n```mermaid\ngraph TB\n    CreateSelect["Creating \'select\' element"]\n    \n    CheckMultiple{"props.multiple?"}\n    CreateSelect --> CheckMultiple\n    \n    CheckMultiple -->|"true"| SetMultiple["element.multiple = true"]\n    CheckMultiple -->|"false"| CheckSize{"props.size?"}\n    \n    CheckSize -->|"yes"| SetSize["element.size = props.size<br/>(enables multi-select mode)"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:544-562]()\n\n### Form Controls (Input, Textarea, Select)\n\nForm controls have specialized prop handling:\n- `finalizeInitialChildren` returns `true` for inputs, selects, textareas to schedule `commitMount`\n- `commitMount` handles `autoFocus` by calling `element.focus()`\n- Dedicated modules handle controlled vs uncontrolled state: `ReactDOMInput`, `ReactDOMTextarea`, `ReactDOMSelect`\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:625-643](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:813-872]()\n\n### Image Elements\n\nImages receive special handling in `commitMount` to ensure `onLoad` events fire correctly:\n\n```mermaid\ngraph TB\n    CommitMountImg["commitMount for \'img\'"]\n    \n    CheckSrc{"props.src present?"}\n    CommitMountImg --> CheckSrc\n    \n    CheckSrc -->|"yes"| CheckObjectSrc{"src is object<br/>(Blob/MediaStream)?"}\n    CheckObjectSrc -->|"yes"| SetSrcObject["setSrcObject(element, type, src)"]\n    CheckObjectSrc -->|"no"| ReassignSrc["element.src = src<br/>(triggers new load)"]\n    \n    CheckSrc -->|"no"| CheckSrcSet{"props.srcSet present?"}\n    CheckSrcSet -->|"yes"| ReassignSrcSet["element.srcset = srcSet"]\n```\n\nThe reassignment ensures that even if the image has already loaded, the `onLoad` handler will be called again.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:838-869]()\n\n## Hydration Support\n\nReactFiberConfigDOM provides hydration functions to match server-rendered HTML with React\'s virtual DOM during client-side hydration. This is a large topic covered in detail in [Hydration System](#6.3).\n\nKey hydration functions exported:\n- `hydrateProperties(domElement, tag, props)` - Matches and validates props\n- `hydrateText(textInstance, text)` - Validates text content\n- `diffHydratedProperties(domElement, tag, props)` - Produces update payload for mismatches\n- `diffHydratedText(textInstance, text)` - Checks for text mismatches\n\nHydration also handles special cases:\n- Dehydrated Suspense boundaries (marked with comment nodes)\n- Form state markers for preserving form data across SSR\n- Input/textarea/select state synchronization via `hydrateInput`, `hydrateTextarea`, `hydrateSelect`\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:81-89](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:874-915]()\n\n## View Transitions and Scheduling\n\nReactFiberConfigDOM includes stubs and partial implementations for view transitions, which enable animated transitions between states. Full details are in [View Transitions and Gesture Scheduling](#6.4).\n\n### View Transition Lifecycle\n\nThe host config provides functions called by the reconciler during view transitions:\n\n| Function | Purpose |\n|----------|---------|\n| `measureInstance(instance)` | Capture instance measurements before transition |\n| `cloneRootViewTransitionContainer(root)` | Clone the root for "old" state capture |\n| `startViewTransition(...)` | Begin coordinating the transition animation |\n| `applyViewTransitionName(instance, name, className)` | Apply CSS view-transition-name |\n| `stopViewTransition(transition)` | End the transition |\n\n### Gesture Scheduling\n\nGesture timeline integration (for scrubbing through transitions) is also stubbed:\n\n```mermaid\ngraph LR\n    StartGesture["startGestureTransition(container, timeline, ...)"]\n    StartGesture --> MutationCB["mutationCallback()"]\n    MutationCB --> AnimateCB["animateCallback()"]\n    AnimateCB --> Return["Return null<br/>(no actual animation)"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1094-1358]()\n\n## Component Tree Mapping\n\nReactFiberConfigDOM maintains a mapping between DOM nodes and React fibers to support:\n- Event dispatching (finding the React instance for a DOM node)\n- React DevTools (inspecting the component tree)\n- Public instance access (refs)\n\n### Mapping Functions\n\n```mermaid\ngraph TB\n    subgraph "Fiber to DOM"\n        PrecacheFiber["precacheFiberNode(fiber, domNode)"]\n        PrecacheFiber --> StoreOnNode["domNode[internalInstanceKey] = fiber"]\n    end\n    \n    subgraph "DOM to Fiber"\n        GetInstance["getInstanceFromNode(domNode)"]\n        GetInstance --> ReadKey["return domNode[internalInstanceKey]"]\n    end\n    \n    subgraph "Props Storage"\n        UpdateFiberProps["updateFiberProps(domNode, props)"]\n        UpdateFiberProps --> StoreProps["domNode[internalPropsKey] = props"]\n        \n        GetFiberProps["getFiberCurrentPropsFromNode(domNode)"]\n        GetFiberProps --> ReadProps["return domNode[internalPropsKey]"]\n    end\n```\n\nThese mappings are established during instance creation and used throughout the lifecycle for event handling and introspection.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js:47-60]()\n\n## Summary\n\nReactFiberConfigDOM serves as the critical bridge between React\'s platform-agnostic reconciler and the browser DOM. It:\n\n- **Creates DOM instances** with proper namespacing (HTML, SVG, MathML)\n- **Manages properties** by translating React props to DOM attributes/properties\n- **Performs mutations** efficiently using native DOM APIs (with `moveBefore` optimization)\n- **Integrates events** by coordinating with React\'s synthetic event system\n- **Handles resources** through hoisting mechanisms for stylesheets and scripts\n- **Supports hydration** by matching server-rendered HTML with the React tree\n- **Enables view transitions** for animated state changes (experimental)\n\nThe implementation is mutation-based (unlike React Native\'s persistence mode) and optimized for the browser environment, with special handling for form controls, scripts, images, and other HTML-specific elements.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-1500]()\n\n---\n\n# Page: React Native Renderers\n\n# React Native Renderers\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React Native\'s renderer implementations, which enable React to target native mobile platforms (iOS and Android). React Native provides two distinct renderers: **Fabric** (the new architecture using persistence mode) and **Legacy/Paper** (the old architecture using mutation mode). Both implement the host config interface defined by the reconciler to bridge React\'s virtual representation with platform-specific native UI components.\n\nFor information about the general host configuration abstraction, see [Host Configuration Abstraction](#4.6). For React DOM\'s implementation, see [React DOM Implementation](#6.1).\n\n---\n\n## Host Config Interface\n\nReact Native renderers implement the same host config interface as other renderers, providing platform-specific implementations of instance creation, updates, and tree manipulation. The reconciler calls these methods to perform platform operations without knowing the underlying implementation details.\n\n### Core Type Definitions\n\nBoth renderers define these fundamental types:\n\n| Type | Fabric | Legacy |\n|------|--------|--------|\n| `Type` | `string` (component type) | `string` (component type) |\n| `Instance` | Object with `node` and `canonical` | `ReactNativeFiberHostComponent` |\n| `TextInstance` | Object with `node` | `number` (native tag) |\n| `Container` | `{containerTag, publicInstance}` | `{containerTag, publicInstance}` |\n| `Props` | `Object` | `Object` |\n| `HostContext` | `{isInAParentText: boolean}` | `{isInAParentText: boolean}` |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:93-134](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:59-73]()\n\n---\n\n## Fabric Renderer (New Architecture)\n\n### Architecture Overview\n\n```mermaid\ngraph TB\n    Reconciler["React Reconciler"]\n    FabricConfig["ReactFiberConfigFabric"]\n    FabricUIManager["nativeFabricUIManager"]\n    ShadowTree["C++ Shadow Tree"]\n    NativeUI["Native UI Components"]\n    \n    Reconciler -->|"Host config calls"| FabricConfig\n    FabricConfig -->|"createNode()<br/>cloneNode()<br/>appendChild()"| FabricUIManager\n    FabricUIManager -->|"Synchronous updates"| ShadowTree\n    ShadowTree -->|"commitRoot()"| NativeUI\n    \n    subgraph "JavaScript Layer"\n        Reconciler\n        FabricConfig\n    end\n    \n    subgraph "Native Bridge"\n        FabricUIManager\n    end\n    \n    subgraph "Native Layer"\n        ShadowTree\n        NativeUI\n    end\n```\n\nFabric Renderer Architecture\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:31-60]()\n\n### Instance Structure\n\nFabric uses a **canonical instance pattern** where all clones of an instance share a common data structure:\n\n```mermaid\ngraph LR\n    Instance1["Instance (clone 1)"]\n    Instance2["Instance (clone 2)"]\n    Instance3["Instance (clone 3)"]\n    Canonical["Canonical Object"]\n    Node1["Shadow Node 1"]\n    Node2["Shadow Node 2"]\n    Node3["Shadow Node 3"]\n    \n    Instance1 -->|"node"| Node1\n    Instance2 -->|"node"| Node2\n    Instance3 -->|"node"| Node3\n    \n    Instance1 -->|"canonical"| Canonical\n    Instance2 -->|"canonical"| Canonical\n    Instance3 -->|"canonical"| Canonical\n    \n    Canonical -->|"nativeTag"| Tag["Unique Tag"]\n    Canonical -->|"viewConfig"| ViewConfig["View Configuration"]\n    Canonical -->|"currentProps"| Props["Current Props"]\n    Canonical -->|"internalInstanceHandle"| Fiber["Fiber Reference"]\n    Canonical -->|"publicInstance"| Public["Public Instance (lazy)"]\n```\n\nFabric Instance Canonical Pattern\n\nThe canonical object contains:\n- `nativeTag`: Unique identifier (even numbers starting from 2)\n- `viewConfig`: Native component configuration from registry\n- `currentProps`: Current props for event handling\n- `internalInstanceHandle`: Reference to the Fiber\n- `publicInstance`: Lazily created public instance for refs\n- `publicRootInstance`: Root instance (nulled after public instance creation)\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:95-113]()\n\n### Tag Allocation\n\nFabric tags follow a specific pattern:\n- Start at `2` and increment by `2` for each new instance\n- `tag % 10 === 1` means it\'s a root tag\n- `tag % 2 === 0` means it\'s a Fabric tag\n- This ensures Fabric tags never overlap with Legacy tags\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:86-89]()\n\n### Persistence Mode Operations\n\nFabric uses **persistence mode** (`supportsPersistence = true`), meaning it creates new shadow node instances rather than mutating existing ones:\n\n| Operation | Implementation |\n|-----------|----------------|\n| `createInstance` | `createNode(tag, viewName, rootTag, props, handle)` |\n| `cloneInstance` | `cloneNodeWithNewProps()` or `cloneNodeWithNewChildren()` |\n| `appendInitialChild` | `appendChildNode(parent.node, child.node)` |\n| `createContainerChildSet` | Returns `[]` (array mode) |\n| `appendChildToContainerChildSet` | `childSet.push(child.node)` |\n| `finalizeContainerChildren` | No-op (children replaced in next step) |\n| `replaceContainerChildren` | `completeRoot(containerTag, newChildren)` |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:449-561]()\n\n### Native UI Manager Integration\n\nFabric communicates with the native layer through `nativeFabricUIManager`:\n\n```mermaid\ngraph TB\n    createNode["createNode(tag, viewName, rootTag, props, handle)"]\n    cloneNode["cloneNodeWithNewProps(node, props)"]\n    appendChild["appendChildNode(parent, child)"]\n    completeRoot["completeRoot(containerTag, children)"]\n    registerEventHandler["registerEventHandler(dispatchEvent)"]\n    \n    createNode -->|"Returns"| ShadowNode["Shadow Node"]\n    cloneNode -->|"Returns"| ClonedNode["Cloned Shadow Node"]\n    appendChild -->|"Mutates"| ParentNode["Parent Shadow Tree"]\n    completeRoot -->|"Commits"| NativeUI["Native UI Tree"]\n    registerEventHandler -->|"Sets"| EventBridge["Event Bridge"]\n```\n\nFabric UI Manager API\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:45-60]()\n\n---\n\n## Legacy Renderer (Old Architecture/Paper)\n\n### Architecture Overview\n\n```mermaid\ngraph TB\n    Reconciler["React Reconciler"]\n    LegacyConfig["ReactFiberConfigNative"]\n    UIManager["UIManager"]\n    NativeBridge["Native Bridge (async)"]\n    NativeUI["Native UI Components"]\n    \n    Reconciler -->|"Host config calls"| LegacyConfig\n    LegacyConfig -->|"createView()<br/>updateView()<br/>manageChildren()"| UIManager\n    UIManager -->|"JSON over bridge"| NativeBridge\n    NativeBridge -->|"Async updates"| NativeUI\n    \n    subgraph "JavaScript Layer"\n        Reconciler\n        LegacyConfig\n        UIManager\n    end\n    \n    subgraph "Native Layer"\n        NativeBridge\n        NativeUI\n    end\n```\n\nLegacy Renderer Architecture\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:14-20]()\n\n### Instance Structure\n\nLegacy renderer uses `ReactNativeFiberHostComponent` as instances, which are simpler objects with:\n- `_nativeTag`: The native view tag\n- `_children`: Array of child instances\n- `viewConfig`: View configuration\n- Internal methods for event handling\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:29](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:157-169]()\n\n### Tag Allocation\n\nLegacy tags use a different allocation strategy:\n- Start at `3` and increment by `2`\n- Skip tags where `tag % 10 === 1` (reserved for root tags)\n- Skip tags where `tag % 2 === 0` (reserved for Fabric tags)\n\n```javascript\nfunction allocateTag() {\n  let tag = nextReactTag;\n  if (tag % 10 === 1) {\n    tag += 2;\n  }\n  nextReactTag = tag + 2;\n  return tag;\n}\n```\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:94-102]()\n\n### Mutation Mode Operations\n\nLegacy uses **mutation mode** (`supportsMutation = true`), directly mutating the native view hierarchy:\n\n| Operation | Implementation |\n|-----------|----------------|\n| `createInstance` | `UIManager.createView(tag, viewName, rootTag, props)` |\n| `commitUpdate` | `UIManager.updateView(tag, viewName, updatePayload)` |\n| `appendChild` | `UIManager.manageChildren(parent, moveFrom, moveTo, add, addAt, remove)` |\n| `insertBefore` | `UIManager.manageChildren()` with calculated indices |\n| `removeChild` | `UIManager.manageChildren()` with removeAtIndices |\n| `commitTextUpdate` | `UIManager.updateView(tag, \'RCTRawText\', {text})` |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:377-541]()\n\n### UIManager Integration\n\nThe Legacy renderer uses the `UIManager` module to communicate with native:\n\n```mermaid\ngraph LR\n    createView["UIManager.createView(tag, viewName, rootTag, props)"]\n    updateView["UIManager.updateView(tag, viewName, props)"]\n    manageChildren["UIManager.manageChildren(parent, moveFrom, moveTo, add, addAt, remove)"]\n    setChildren["UIManager.setChildren(parent, children)"]\n    \n    createView -->|"Async"| NativeQueue["Native Command Queue"]\n    updateView -->|"Async"| NativeQueue\n    manageChildren -->|"Async"| NativeQueue\n    setChildren -->|"Async"| NativeQueue\n    \n    NativeQueue -->|"Batched"| NativeUI["Native UI Thread"]\n```\n\nLegacy UIManager API\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:150-155](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:392-410]()\n\n---\n\n## Key Differences Between Fabric and Legacy\n\n### Comparison Table\n\n| Aspect | Fabric | Legacy |\n|--------|--------|--------|\n| **Mode** | Persistence | Mutation |\n| **Instance Type** | `{node, canonical}` | `ReactNativeFiberHostComponent` |\n| **Text Instance** | `{node, publicInstance?}` | `number` (tag only) |\n| **Tag Pattern** | Even numbers (2, 4, 6...) | Odd numbers (3, 5, 7...) skipping multiples of 10 |\n| **Native API** | `nativeFabricUIManager` (synchronous) | `UIManager` (asynchronous) |\n| **Cloning** | `cloneNodeWithNewProps/Children()` | Not supported |\n| **Child Updates** | Replace entire child set | `manageChildren()` with indices |\n| **Event Registration** | `registerEventHandler(dispatchEvent)` | Implicit via `UIManager` |\n| **Public Instance** | Lazily created via `createPublicInstance` | Instance itself (or Fabric compat) |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:449](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:377]()\n\n### Architectural Comparison Diagram\n\n```mermaid\ngraph TB\n    subgraph "Fabric (New)"\n        FabricReact["React Tree"]\n        FabricClone["Clone Operations<br/>(persistence)"]\n        FabricShadow["Shadow Tree<br/>(synchronous)"]\n        FabricCommit["completeRoot()"]\n        FabricNative["Native UI"]\n        \n        FabricReact --> FabricClone\n        FabricClone --> FabricShadow\n        FabricShadow --> FabricCommit\n        FabricCommit --> FabricNative\n    end\n    \n    subgraph "Legacy (Old)"\n        LegacyReact["React Tree"]\n        LegacyMutate["Mutation Operations"]\n        LegacyQueue["Command Queue<br/>(asynchronous)"]\n        LegacyNative["Native UI"]\n        \n        LegacyReact --> LegacyMutate\n        LegacyMutate --> LegacyQueue\n        LegacyQueue --> LegacyNative\n    end\n```\n\nFabric vs Legacy Architecture\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-8](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:1-8]()\n\n---\n\n## Instance Management and Public Instances\n\n### Public Instance Creation\n\nBoth renderers expose instances to user code via refs, but they handle this differently:\n\n**Fabric:**\n- Public instances are created lazily via `createPublicInstance(tag, viewConfig, handle, rootInstance)`\n- Stored in the `canonical.publicInstance` field\n- All clones share the same public instance through the canonical object\n- `getPublicInstance()` creates on first access\n\n**Legacy:**\n- The instance itself serves as the public instance\n- Simpler model without lazy initialization\n- Compatibility layer exists for Fabric instances in mixed environments\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:293-325](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:289-315]()\n\n### Host Context Management\n\nBoth renderers track whether the current tree position is inside a text component:\n\n```mermaid\ngraph TD\n    Root["Root Context<br/>{isInAParentText: false}"]\n    View["<View><br/>isInAParentText: false"]\n    Text["<Text><br/>isInAParentText: true"]\n    TextInput["<TextInput><br/>isInAParentText: true"]\n    String["Text String<br/>(must be in text)"]\n    \n    Root --> View\n    View --> Text\n    Text --> String\n    View --> TextInput\n    \n    Text -.->|"Sets true"| String\n    TextInput -.->|"Sets true"| String\n```\n\nHost Context Propagation\n\nThe context prevents raw text strings from appearing outside text components. In DEV mode, this triggers a warning.\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:259-291](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:264-287]()\n\n---\n\n## Fragment Refs Support\n\nFabric includes support for fragment instance handles, enabling refs to fragments. The `FragmentInstance` class implements DOM-like APIs for native components:\n\n### FragmentInstance Implementation\n\n```mermaid\nclassDiagram\n    class FragmentInstance {\n        -Fiber _fragmentFiber\n        -Set~IntersectionObserver~ _observers\n        +observeUsing(observer)\n        +unobserveUsing(observer)\n        +compareDocumentPosition(otherNode)\n        +getRootNode(options)\n        +getClientRects()\n    }\n    \n    class IntersectionObserver {\n        +observe(target)\n        +unobserve(target)\n    }\n    \n    FragmentInstance --> IntersectionObserver : manages\n    FragmentInstance --> Fiber : references\n```\n\nFragmentInstance Class Structure\n\n### Key Methods\n\n| Method | Purpose | Implementation |\n|--------|---------|----------------|\n| `observeUsing()` | Attach IntersectionObserver | Traverses fragment, calls `observer.observe()` on each child |\n| `unobserveUsing()` | Detach IntersectionObserver | Traverses fragment, calls `observer.unobserve()` on each child |\n| `compareDocumentPosition()` | Compare positions | Uses first/last child positions with special empty fragment handling |\n| `getRootNode()` | Get root container | Delegates to parent host fiber\'s `getRootNode()` |\n| `getClientRects()` | Get bounding rects | Collects `getBoundingClientRect()` from all children |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:646-799]()\n\n### Fragment Traversal\n\nFragment instances use `traverseFragmentInstance()` from the reconciler to walk the fragment\'s children:\n\n```mermaid\ngraph TB\n    FragmentFiber["Fragment Fiber"]\n    Child1["Host Component 1"]\n    Child2["Host Component 2"]\n    Child3["Nested Fragment"]\n    Child3a["Host Component 3a"]\n    Child3b["Host Component 3b"]\n    \n    FragmentFiber --> Child1\n    FragmentFiber --> Child2\n    FragmentFiber --> Child3\n    Child3 --> Child3a\n    Child3 --> Child3b\n    \n    Traverse["traverseFragmentInstance(fiber, callback, data)"]\n    Traverse -.->|"Visits"| Child1\n    Traverse -.->|"Visits"| Child2\n    Traverse -.->|"Recursively visits"| Child3a\n    Traverse -.->|"Recursively visits"| Child3b\n```\n\nFragment Traversal Pattern\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:27-29](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:672-678]()\n\n---\n\n## Props and Attribute Handling\n\n### Attribute Payload Creation\n\nBoth renderers use the React Native view configuration registry to validate and transform props:\n\n```mermaid\ngraph LR\n    Props["Component Props"]\n    ViewConfig["View Config<br/>(from registry)"]\n    ValidAttributes["validAttributes"]\n    \n    Props --> CreatePayload["createAttributePayload()"]\n    ViewConfig --> CreatePayload\n    ValidAttributes --> CreatePayload\n    \n    CreatePayload --> Payload["Native Attribute Payload"]\n    \n    Payload --> FabricCreate["Fabric: createNode()"]\n    Payload --> LegacyCreate["Legacy: UIManager.createView()"]\n```\n\nAttribute Payload Flow\n\n**Fabric:**\n```javascript\nconst updatePayload = createAttributePayload(\n  props,\n  viewConfig.validAttributes,\n);\nconst node = createNode(tag, viewConfig.uiViewClassName, rootTag, updatePayload, handle);\n```\n\n**Legacy:**\n```javascript\nconst updatePayload = create(props, viewConfig.validAttributes);\nUIManager.createView(tag, viewConfig.uiViewClassName, rootTag, updatePayload);\n```\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:196-207](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:148-155]()\n\n### Update Payload Diffing\n\nWhen props change, both renderers compute a diff to minimize native updates:\n\n**Fabric:**\n```javascript\nconst updatePayload = diffAttributePayloads(\n  oldProps,\n  newProps,\n  viewConfig.validAttributes,\n);\n// Updates canonical.currentProps for events\ninstance.canonical.currentProps = newProps;\n```\n\n**Legacy:**\n```javascript\nconst updatePayload = diff(oldProps, newProps, viewConfig.validAttributes);\nif (updatePayload != null) {\n  UIManager.updateView(tag, viewConfig.uiViewClassName, updatePayload);\n}\n```\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:460-468](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:452-467]()\n\n---\n\n## Event Priority Integration\n\nBoth renderers integrate with the React event priority system to map native events to React priorities:\n\n### Priority Resolution\n\n```mermaid\ngraph TD\n    GetPriority["resolveUpdatePriority()"]\n    CurrentPriority["currentUpdatePriority<br/>(from setState, etc)"]\n    FabricPriority["fabricGetCurrentEventPriority()<br/>(from native)"]\n    \n    GetPriority --> CheckCurrent{{"currentUpdatePriority<br/>!== NoEventPriority?"}}\n    CheckCurrent -->|Yes| CurrentPriority\n    CheckCurrent -->|No| FabricPriority\n    \n    FabricPriority --> MapPriority["Map to React Priority"]\n    MapPriority --> Discrete["DiscreteEventPriority<br/>(clicks, inputs)"]\n    MapPriority --> Continuous["ContinuousEventPriority<br/>(scrolls, drags)"]\n    MapPriority --> Idle["IdleEventPriority"]\n    MapPriority --> Default["DefaultEventPriority"]\n```\n\nEvent Priority Resolution (Fabric)\n\n**Fabric Priority Mapping:**\n| Fabric Priority | React Priority |\n|----------------|----------------|\n| `FabricDiscretePriority` | `DiscreteEventPriority` |\n| `FabricContinuousPriority` | `ContinuousEventPriority` |\n| `FabricIdlePriority` | `IdleEventPriority` |\n| `FabricDefaultPriority` | `DefaultEventPriority` |\n\n**Legacy:** Always returns `DefaultEventPriority` (no native priority integration).\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:395-419](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:352-357]()\n\n---\n\n## Summary\n\nReact Native provides two renderer implementations that bridge React\'s platform-agnostic reconciler to native mobile UI:\n\n1. **Fabric** (new architecture): Uses persistence mode with synchronous shadow tree operations, enabling better performance and simpler concurrency support\n2. **Legacy/Paper** (old architecture): Uses mutation mode with asynchronous command batching via the bridge\n\nBoth implement the same host config interface but with fundamentally different operational models. Fabric\'s persistence approach aligns better with React\'s concurrent rendering model, while Legacy maintains backward compatibility with existing React Native applications.\n\nThe key architectural components are:\n- **Tag allocation** strategies ensuring Fabric and Legacy tags don\'t conflict\n- **Instance management** patterns (canonical sharing vs direct instances)\n- **Native bridge integration** (synchronous vs asynchronous)\n- **Public instance creation** for refs\n- **Fragment refs support** (Fabric only)\n- **Attribute payload** creation and diffing\n- **Event priority** mapping (enhanced in Fabric)\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-838](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:1-751]()\n\n---\n\n# Page: Hydration System\n\n# Hydration System\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js](packages/react-dom-bindings/src/client/ReactDOMComponentTree.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js)\n- [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js](packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js](packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFloat-test.js](packages/react-dom/src/__tests__/ReactDOMFloat-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js](packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js](packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js)\n- [packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js](packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js)\n- [packages/react-dom/src/__tests__/ReactRenderDocument-test.js](packages/react-dom/src/__tests__/ReactRenderDocument-test.js)\n- [packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js](packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js](packages/react-dom/src/server/ReactDOMFizzServerBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBun.js](packages/react-dom/src/server/ReactDOMFizzServerBun.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerEdge.js](packages/react-dom/src/server/ReactDOMFizzServerEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerNode.js](packages/react-dom/src/server/ReactDOMFizzServerNode.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js](packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticEdge.js](packages/react-dom/src/server/ReactDOMFizzStaticEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticNode.js](packages/react-dom/src/server/ReactDOMFizzStaticNode.js)\n- [packages/react-markup/src/ReactFizzConfigMarkup.js](packages/react-markup/src/ReactFizzConfigMarkup.js)\n- [packages/react-noop-renderer/src/ReactNoopServer.js](packages/react-noop-renderer/src/ReactNoopServer.js)\n- [packages/react-reconciler/src/ReactFiberHydrationContext.js](packages/react-reconciler/src/ReactFiberHydrationContext.js)\n- [packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js](packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js)\n- [packages/react-server/src/ReactFizzServer.js](packages/react-server/src/ReactFizzServer.js)\n- [packages/react-server/src/forks/ReactFizzConfig.custom.js](packages/react-server/src/forks/ReactFizzConfig.custom.js)\n\n</details>\n\n\n\nThis document describes React\'s hydration system, which attaches React to server-rendered HTML, transforming static markup into an interactive application. Hydration reuses existing DOM nodes rather than creating new ones, validating that the server and client render the same content.\n\nFor server-side rendering fundamentals, see [React Fizz (Streaming SSR)](#5.1). For broader React DOM rendering concepts, see [React DOM](#4.1). For the underlying reconciliation mechanics, see [Fiber Architecture and Work Loop](#3.1).\n</thinking>\n\n## Hydration Overview\n\nHydration is the process of attaching React\'s event listeners and internal state to server-rendered HTML. Instead of creating new DOM nodes, React walks the existing DOM tree, attaching Fiber nodes to existing elements and validating that the client render matches the server render.\n\n```mermaid\ngraph TD\n    SSR["Server-Rendered HTML<br/>(ReactDOMFizzServer)"]\n    Container["DOM Container"]\n    HydrateRoot["ReactDOMClient.hydrateRoot()"]\n    HydrationContext["ReactFiberHydrationContext"]\n    FiberTree["Fiber Tree"]\n    AttachedDOM["Attached DOM with Event Listeners"]\n    \n    SSR --> Container\n    Container --> HydrateRoot\n    HydrateRoot --> HydrationContext\n    HydrationContext --> FiberTree\n    FiberTree --> AttachedDOM\n```\n\n**Hydration Flow**\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-1500](), [packages/react-reconciler/src/ReactFiberHydrationContext.js:1-100]()\n\n## Hydration Context State\n\nReact maintains hydration state in `ReactFiberHydrationContext`, tracking the current position in the DOM tree and whether hydration is in progress.\n\n| State Variable | Type | Purpose |\n|---------------|------|---------|\n| `hydrationParentFiber` | `Fiber | null` | Current fiber being hydrated |\n| `nextHydratableInstance` | `HydratableInstance | null` | Next DOM node to hydrate |\n| `isHydrating` | `boolean` | Whether currently hydrating |\n| `didSuspendOrErrorDEV` | `boolean` | Suppress warnings after errors |\n| `hydrationDiffRootDEV` | `HydrationDiffNode | null` | Tracked diffs for error reporting |\n| `hydrationErrors` | `Array<CapturedValue> | null` | Collected hydration errors |\n\n```mermaid\ngraph TD\n    BeginWork["beginWork()"]\n    TryToClaimNextHydratableInstance["tryToClaimNextHydratableInstance()"]\n    NextHydratableInstance["nextHydratableInstance"]\n    CanHydrate["canHydrateInstance()"]\n    PopHydrationState["popHydrationState()"]\n    \n    BeginWork --> TryToClaimNextHydratableInstance\n    TryToClaimNextHydratableInstance --> NextHydratableInstance\n    NextHydratableInstance --> CanHydrate\n    CanHydrate -->|"match"| AttachFiber["Attach Fiber to DOM node"]\n    CanHydrate -->|"mismatch"| RecordMismatch["deleteHydratableInstance()"]\n    BeginWork --> PopHydrationState\n```\n\n**Hydration State Management**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:78-95](), [packages/react-reconciler/src/ReactFiberHydrationContext.js:135-200]()\n\n## Hydration Process\n\nDuring hydration, React walks the Fiber tree and the DOM tree in parallel, attempting to match each Fiber to an existing DOM node.\n\n### Host Component Hydration\n\nFor host components (DOM elements), React validates the tag name and props, attaching the existing DOM node to the Fiber.\n\n```mermaid\nsequenceDiagram\n    participant Reconciler\n    participant HydrationContext\n    participant HostConfig\n    participant DOM\n    \n    Reconciler->>HydrationContext: tryToClaimNextHydratableInstance()\n    HydrationContext->>DOM: Get nextHydratableInstance\n    HydrationContext->>HostConfig: canHydrateInstance(type, instance)\n    HostConfig-->>HydrationContext: true/false\n    alt Can Hydrate\n        HydrationContext->>HostConfig: hydrateInstance(instance, type, props)\n        HostConfig->>DOM: Validate props\n        HostConfig-->>HydrationContext: updatePayload | null\n        HydrationContext->>Reconciler: Attach instance to fiber\n    else Cannot Hydrate\n        HydrationContext->>HydrationContext: deleteHydratableInstance()\n        HydrationContext->>Reconciler: Create new instance\n    end\n```\n\n**Host Component Hydration Sequence**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:400-500](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1200-1350]()\n\n### Text Node Hydration\n\nText nodes are compared directly. If the text content differs, React logs a warning but uses the existing node.\n\n```mermaid\ngraph TD\n    TryHydrateText["tryToClaimNextHydratableInstance()<br/>(text)"]\n    CanHydrateText["canHydrateTextInstance()"]\n    HydrateText["hydrateTextInstance()"]\n    DiffText["diffHydratedTextForDevWarnings()"]\n    \n    TryHydrateText --> CanHydrateText\n    CanHydrateText -->|"is text node"| HydrateText\n    CanHydrateText -->|"wrong type"| DeleteAndCreate["Delete + Create new"]\n    HydrateText --> DiffText\n    DiffText -->|"DEV only"| LogWarning["Log mismatch warning"]\n```\n\n**Text Node Hydration**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:500-550](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1350-1400]()\n\n## Mismatch Detection and Recovery\n\nWhen React detects a mismatch between server-rendered HTML and client render, it attempts recovery by deleting the mismatched server node and creating the correct client node.\n\n### Mismatch Types\n\n| Mismatch Type | Detection Method | Recovery Strategy |\n|--------------|------------------|-------------------|\n| Tag name mismatch | `canHydrateInstance()` returns false | Delete server node, insert client node |\n| Text mismatch | `diffHydratedText()` compares strings | Use server text, log warning |\n| Missing children | No DOM node for Fiber child | Insert client-rendered child |\n| Extra DOM nodes | DOM nodes without Fiber | Delete extra nodes |\n| Prop mismatch | `diffHydratedProperties()` | Apply client props, log warning |\n\n```mermaid\ngraph TD\n    BeginHydration["Begin Hydration"]\n    TryClaim["tryToClaimNextHydratableInstance()"]\n    Validate["Validate node type and props"]\n    \n    Match["Match Found"]\n    Mismatch["Mismatch Detected"]\n    \n    DeleteServer["deleteHydratableInstance()"]\n    InsertClient["insertNonHydratedInstance()"]\n    LogError["queueHydrationError()"]\n    \n    BeginHydration --> TryClaim\n    TryClaim --> Validate\n    Validate --> Match\n    Validate --> Mismatch\n    \n    Mismatch --> DeleteServer\n    Mismatch --> InsertClient\n    Mismatch --> LogError\n    \n    Match --> ContinueHydration["Continue Hydration"]\n```\n\n**Mismatch Recovery Flow**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:300-400](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1400-1500]()\n\n### Hydration Diff Tracking (DEV)\n\nIn development, React builds a tree of hydration differences to provide detailed error messages with component stacks.\n\n```mermaid\ngraph TD\n    DetectMismatch["Detect Mismatch"]\n    BuildDiffNode["buildHydrationDiffNode()"]\n    RecordDiff["Record in hydrationDiffRootDEV"]\n    ThrowError["throwOnHydrationMismatch()"]\n    DescribeDiff["describeDiff()"]\n    ErrorWithStack["Error with Component Stack"]\n    \n    DetectMismatch --> BuildDiffNode\n    BuildDiffNode --> RecordDiff\n    RecordDiff --> ThrowError\n    ThrowError --> DescribeDiff\n    DescribeDiff --> ErrorWithStack\n```\n\n**Hydration Diff Reporting**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:96-135](), [packages/react-reconciler/src/ReactFiberHydrationDiffs.js:1-200]()\n\n## Dehydrated Suspense Boundaries\n\nWhen React Fizz server renders a Suspense boundary that suspended, it emits special HTML comment markers to indicate dehydrated content. These markers allow the client to skip hydrating the fallback and wait for the real content.\n\n### Suspense Boundary Markers\n\nReact uses specific comment node data to mark Suspense boundaries in SSR output:\n\n| Marker | Data Attribute | Purpose |\n|--------|---------------|---------|\n| Pending Start | `$?` | Suspense that hasn\'t resolved yet |\n| Fallback Start | `$!` | Suspense showing fallback |\n| Complete Start | `$` | Completed Suspense |\n| End | `/$` | End of Suspense boundary |\n\n```mermaid\ngraph TD\n    ServerRender["Server Render<br/>(ReactFizzServer)"]\n    SuspensePending["Component Suspends"]\n    EmitMarker["Emit <!--$?--> marker"]\n    StreamFallback["Stream fallback HTML"]\n    \n    ClientHydrate["Client Hydration"]\n    FindMarker["Find dehydrated boundary"]\n    SkipFallback["Skip hydrating fallback"]\n    WaitForContent["Wait for streamed content"]\n    HydrateContent["Hydrate real content"]\n    \n    ServerRender --> SuspensePending\n    SuspensePending --> EmitMarker\n    EmitMarker --> StreamFallback\n    \n    ClientHydrate --> FindMarker\n    FindMarker --> SkipFallback\n    SkipFallback --> WaitForContent\n    WaitForContent --> HydrateContent\n```\n\n**Dehydrated Suspense Boundary Flow**\n\nSources: [packages/react-server/src/ReactFizzServer.js:262-274](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:262-274]()\n\n### Suspense Instance Recognition\n\nThe client recognizes dehydrated Suspense boundaries by checking comment node data attributes.\n\n```mermaid\ngraph TD\n    GetNextSibling["getNextHydratableSibling()"]\n    CheckComment["Check if Comment node"]\n    CheckData["Check node.data"]\n    \n    SuspenseStart["SUSPENSE_*_DATA"]\n    ActivityStart["ACTIVITY_*_DATA"]\n    RegularComment["Regular comment"]\n    \n    GetNextSibling --> CheckComment\n    CheckComment --> CheckData\n    CheckData --> SuspenseStart\n    CheckData --> ActivityStart\n    CheckData --> RegularComment\n    \n    SuspenseStart --> CreateDehydratedFragment["createFiberFromDehydratedFragment()"]\n    ActivityStart --> HandleActivity["Handle Activity boundary"]\n    RegularComment --> SkipNode["Skip to next sibling"]\n```\n\n**Suspense Instance Recognition**\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1120-1180](), [packages/react-reconciler/src/ReactFiberHydrationContext.js:550-650]()\n\n### Hydrating Dehydrated Boundaries\n\nWhen React encounters a dehydrated Suspense boundary, it creates a `DehydratedFragment` fiber and skips the initial content, waiting for the server stream to complete.\n\n```mermaid\nsequenceDiagram\n    participant Reconciler\n    participant HydrationContext\n    participant FiberTree\n    participant SuspenseComponent\n    \n    Reconciler->>HydrationContext: tryToClaimNextHydratableInstance()\n    HydrationContext->>HydrationContext: Check for suspense marker\n    HydrationContext->>FiberTree: createFiberFromDehydratedFragment()\n    FiberTree->>SuspenseComponent: Mount with dehydrated state\n    SuspenseComponent->>SuspenseComponent: Register _reactRetry callback\n    \n    Note over SuspenseComponent: Wait for server completion\n    \n    SuspenseComponent->>SuspenseComponent: Receive completion signal\n    SuspenseComponent->>HydrationContext: Hydrate real content\n    HydrationContext->>FiberTree: Replace dehydrated fiber\n```\n\n**Dehydrated Fragment Hydration**\n\nSources: [packages/react-reconciler/src/ReactFiber.js:800-850](), [packages/react-reconciler/src/ReactFiberHydrationContext.js:700-800]()\n\n## Selective Hydration\n\nSelective hydration allows React to prioritize hydrating Suspense boundaries based on user interactions, improving perceived performance.\n\n### Priority-Based Hydration\n\nWhen a user interacts with a dehydrated boundary, React immediately schedules that boundary for hydration at a higher priority.\n\n| Interaction Type | Priority | Scheduling |\n|-----------------|----------|-----------|\n| Click, focus, submit | Discrete | Sync hydration |\n| Hover, scroll | Continuous | High priority |\n| No interaction | Default | Normal priority |\n\n```mermaid\ngraph TD\n    UserClick["User clicks dehydrated area"]\n    FindTarget["findInstanceBlockingEvent()"]\n    CheckHydrated["Check if target hydrated"]\n    \n    IsDehydrated["Target is dehydrated"]\n    ScheduleHydration["attemptDiscreteHydration()"]\n    QueueEvent["queueDiscreteEvent()"]\n    \n    CompleteHydration["Hydration completes"]\n    ReplayEvent["replayUnblockedEvents()"]\n    DispatchToHandler["Dispatch to event handler"]\n    \n    UserClick --> FindTarget\n    FindTarget --> CheckHydrated\n    CheckHydrated --> IsDehydrated\n    IsDehydrated --> ScheduleHydration\n    IsDehydrated --> QueueEvent\n    ScheduleHydration --> CompleteHydration\n    CompleteHydration --> ReplayEvent\n    ReplayEvent --> DispatchToHandler\n```\n\n**Selective Hydration with Event Replay**\n\nSources: [packages/react-dom-bindings/src/events/ReactDOMEventReplaying.js:1-300](), [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js:146-200]()\n\n### Event Queueing and Replay\n\nEvents targeting dehydrated content are queued until hydration completes, then replayed to ensure they\'re handled correctly.\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant EventSystem\n    participant HydrationContext\n    participant QueuedEvent\n    participant EventHandler\n    \n    User->>EventSystem: Click on dehydrated area\n    EventSystem->>HydrationContext: attemptDiscreteHydration()\n    EventSystem->>QueuedEvent: queueDiscreteEvent()\n    \n    Note over HydrationContext: Hydrate boundary at high priority\n    \n    HydrationContext->>HydrationContext: Complete hydration\n    HydrationContext->>QueuedEvent: replayUnblockedEvents()\n    QueuedEvent->>EventHandler: Dispatch original event\n    EventHandler->>User: Handle interaction\n```\n\n**Event Replay Flow**\n\nSources: [packages/react-dom-bindings/src/events/ReactDOMEventReplaying.js:150-250](), [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js:728-850]()\n\n### Multiple Boundary Prioritization\n\nWhen multiple Suspense boundaries are dehydrated, React hydrates the one the user interacted with first, deferring others.\n\n```mermaid\ngraph TD\n    MultipleBoundaries["Multiple Dehydrated Boundaries"]\n    \n    BoundaryA["Boundary A<br/>(dehydrated)"]\n    BoundaryB["Boundary B<br/>(dehydrated)"]\n    BoundaryC["Boundary C<br/>(dehydrated)"]\n    \n    UserInteraction["User clicks Boundary B"]\n    \n    PrioritizeB["Prioritize Boundary B"]\n    HydrateB["Hydrate B first"]\n    HydrateRest["Hydrate A & C later"]\n    \n    MultipleBoundaries --> BoundaryA\n    MultipleBoundaries --> BoundaryB\n    MultipleBoundaries --> BoundaryC\n    \n    UserInteraction --> PrioritizeB\n    PrioritizeB --> HydrateB\n    HydrateB --> HydrateRest\n```\n\n**Multi-Boundary Prioritization**\n\nSources: [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js:300-400]()\n\n## Error Handling and Recovery\n\nReact\'s hydration system includes comprehensive error handling to recover from mismatches and provide useful diagnostics.\n\n### Recoverable Errors\n\nHydration mismatches are treated as recoverable errors. React logs the error via `onRecoverableError` callback but continues rendering.\n\n| Error Type | Recovery Strategy | User Impact |\n|-----------|------------------|-------------|\n| Tag mismatch | Client render subtree | Flicker during replacement |\n| Text mismatch | Use server text | Dev warning only |\n| Missing attribute | Apply client attribute | Attribute updates |\n| Extra DOM nodes | Delete extra nodes | Removed from DOM |\n\n```mermaid\ngraph TD\n    DetectError["Detect Hydration Mismatch"]\n    CaptureError["createCapturedValueAtFiber()"]\n    QueueError["queueHydrationError()"]\n    \n    ClientRenderBoundary["Find nearest Suspense boundary"]\n    UnmountServer["Unmount server subtree"]\n    MountClient["Mount client tree"]\n    \n    CallRecoverable["onRecoverableError()"]\n    LogWarning["Log warning in DEV"]\n    \n    DetectError --> CaptureError\n    CaptureError --> QueueError\n    QueueError --> ClientRenderBoundary\n    ClientRenderBoundary --> UnmountServer\n    UnmountServer --> MountClient\n    MountClient --> CallRecoverable\n    MountClient --> LogWarning\n```\n\n**Error Recovery Process**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:850-950](), [packages/react-reconciler/src/ReactCapturedValue.js:1-50]()\n\n### HydrationMismatchException\n\nIn DEV, React throws `HydrationMismatchException` with detailed component stacks and diff information.\n\n```mermaid\ngraph TD\n    BuildDiff["buildHydrationDiffNode()"]\n    CollectAncestors["Collect ancestor path"]\n    ThrowException["throwOnHydrationMismatch()"]\n    \n    ServerProps["Record server props"]\n    ClientProps["Record client props"]\n    DescribeDiff["describeDiff()"]\n    \n    FormatError["Format error message"]\n    ComponentStack["Generate component stack"]\n    ThrowError["Throw HydrationMismatchException"]\n    \n    BuildDiff --> CollectAncestors\n    BuildDiff --> ServerProps\n    BuildDiff --> ClientProps\n    ThrowException --> DescribeDiff\n    DescribeDiff --> FormatError\n    FormatError --> ComponentStack\n    ComponentStack --> ThrowError\n```\n\n**HydrationMismatchException Generation**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:950-1050](), [packages/react-reconciler/src/ReactFiberHydrationDiffs.js:50-150]()\n\n## Integration Points\n\nThe DOM event system and selective hydration work together to provide seamless interactivity in server-rendered applications:\n\n1. **Event Detection**: The event system identifies user interactions that should trigger hydration\n2. **Priority Assignment**: Different event types receive different hydration priorities\n3. **Boundary Targeting**: Events target specific Suspense boundaries for hydration\n4. **Event Queueing**: Original events are queued during hydration\n5. **Replay Execution**: Events are replayed after hydration completes\n\nThis integration ensures that server-rendered applications feel responsive while optimizing initial load performance through strategic hydration.\n\nSources: [packages/react-dom/src/__tests__/ReactDOMServerSelectiveHydration-test.internal.js:1-2200](), [packages/react-dom/src/events/__tests__/DOMPluginEventSystem-test.internal.js:1-2000]()\n\n---\n\n# Page: View Transitions and Gesture Scheduling\n\n# View Transitions and Gesture Scheduling\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React\'s view transition and gesture scheduling systems, which coordinate smooth animations and gesture-driven updates with React\'s rendering lifecycle. View transitions integrate with the browser\'s View Transition API to animate between UI states, while gesture scheduling manages gesture-driven animations (such as scroll-linked or drag-based animations) by scheduling renders at specific points along a gesture timeline.\n\nFor information about the general reconciler architecture and commit phase, see [React Reconciler](#4). For lane-based scheduling and priorities, see [Lane-Based Scheduling and Priorities](#4.4).\n\n---\n\n## Overview\n\nReact\'s view transition and gesture scheduling systems provide host configuration APIs that allow renderers to:\n\n1. **Coordinate view transitions** - Apply view-transition-name CSS properties, measure DOM changes, and manage the lifecycle of browser view transitions\n2. **Schedule gesture-driven renders** - Queue gestures, track their progress along timelines, and render at specific animation offsets\n3. **Detect visual changes** - Measure instance dimensions and positions to determine what changed during updates\n4. **Manage transition lifecycle** - Start, stop, and cancel transitions in coordination with React\'s commit phases\n\nThese systems are primarily implemented for the DOM renderer, with stub implementations in React Native and test renderers.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js]()\n\n---\n\n## Host Configuration Interface\n\n### Core Types and Data Structures\n\n**Type Hierarchy and Relationships**\n\n```mermaid\ngraph TB\n    subgraph "View Transition Types"\n        VTI["ViewTransitionInstance<br/>{name, group, imagePair, old, new}"]\n        VTS["ViewTransitionState<br/>{autoName, paired, clones, ref}"]\n        RVT["RunningViewTransition<br/>Platform-specific handle"]\n        IM["InstanceMeasurement<br/>Position & size data"]\n    end\n    \n    subgraph "Gesture Types"\n        GT["GestureTimeline<br/>Timeline provider"]\n        SG["ScheduledGesture<br/>{provider, count, rangeStart,<br/>rangeEnd, types, running, commit}"]\n    end\n    \n    subgraph "Host Config Methods"\n        SVTN["applyViewTransitionName()"]\n        RVTN["restoreViewTransitionName()"]\n        CMI["cloneMutableInstance()"]\n        MI["measureInstance()"]\n        MCI["measureClonedInstance()"]\n        SVT["startViewTransition()"]\n        SGT["startGestureTransition()"]\n        GGO["getCurrentGestureOffset()"]\n    end\n    \n    VTS --> VTI\n    VTI --> SVTN\n    RVT --> SVT\n    RVT --> SGT\n    IM --> MI\n    IM --> MCI\n    GT --> SGT\n    GT --> GGO\n    SG --> SGT\n    VTS --> CMI\n```\n\n**ViewTransitionState Structure**\n\nThe `ViewTransitionState` is attached to ViewTransition fiber nodes and tracks transition lifecycle:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `autoName` | `null \\| string` | Auto-generated view-transition-name (when name prop is \'auto\') |\n| `paired` | `null \\| ViewTransitionState` | Paired instance during enter/exit transitions |\n| `clones` | `null \\| Array<Instance>` | Cloned host instances during gesture apply phase |\n| `ref` | `null \\| ViewTransitionInstance` | Current ref instance exposed to user code |\n\n**ViewTransitionInstance Structure**\n\nThe `ViewTransitionInstance` represents a view transition element with animatable pseudo-elements:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `name` | `string` | The view-transition-name identifying this element |\n| `group` | `mixin$Animatable` | The ::view-transition-group pseudo-element |\n| `imagePair` | `mixin$Animatable` | The ::view-transition-image-pair pseudo-element |\n| `old` | `mixin$Animatable` | The ::view-transition-old pseudo-element |\n| `new` | `mixin$Animatable` | The ::view-transition-new pseudo-element |\n\n**ScheduledGesture Structure**\n\nGestures are queued and tracked in a linked list per `FiberRoot.pendingGestures`:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `provider` | `GestureTimeline` | The timeline provider (e.g., ScrollTimeline) |\n| `count` | `number` | Reference count for active starts |\n| `rangeStart` | `number` | Start percentage (0-100) of current state |\n| `rangeEnd` | `number` | End percentage (0-100) of destination state |\n| `types` | `null \\| TransitionTypes` | Transition type annotations from addTransitionType |\n| `running` | `null \\| RunningViewTransition` | Active transition handle |\n| `commit` | `null \\| (() => void)` | Deferred commit callback |\n| `committing` | `boolean` | Whether gesture should commit on release |\n| `revertLane` | `Lane` | Lane used to schedule revert render |\n| `prev` | `null \\| ScheduledGesture` | Previous gesture in linked list |\n| `next` | `null \\| ScheduledGesture` | Next gesture in linked list |\n\nSources: [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js:19-24](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:253-259](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js:31-43]()\n\n---\n\n## View Transition Lifecycle\n\n### ViewTransition Component and State Management\n\n**ViewTransition Name Resolution**\n\nThe `getViewTransitionName` function in `ReactFiberViewTransitionComponent.js` resolves the transition name:\n\n1. If `props.name` is explicitly set (and not \'auto\'), use that name\n2. Otherwise, if `instance.autoName` exists, use the cached auto-generated name\n3. Otherwise, generate a unique name: `\'_\' + identifierPrefix + \'t_\' + globalClientId + \'_\'`\n\nThe `getViewTransitionClassName` function resolves CSS classes based on:\n- `props.default` - Default class for all transitions\n- `props.enter` / `props.exit` / `props.share` - Event-specific classes\n- Active transition types from `getPendingTransitionTypes()`\n\n**Class Name Selection by Type**\n\n```mermaid\ngraph LR\n    subgraph "Props"\n        D["props.default"]\n        E["props.enter / exit / share"]\n    end\n    \n    subgraph "Runtime"\n        TT["getPendingTransitionTypes()"]\n        ATT["Active types array"]\n    end\n    \n    subgraph "Resolution"\n        GCBT["getClassNameByType()"]\n        Result["Resolved className"]\n    end\n    \n    D --> GCBT\n    E --> GCBT\n    TT --> ATT\n    ATT --> GCBT\n    GCBT --> Result\n    \n    Result --> Apply["applyViewTransitionName(instance, name, className)"]\n```\n\nSources: [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js:28-92]()\n\n### Applying and Managing View Transition Names\n\n**View Transition Name Application Sequence**\n\n```mermaid\nsequenceDiagram\n    participant R as Reconciler\n    participant CV as ReactFiberCommitViewTransitions\n    participant H as Host Config\n    participant D as DOM Element\n    participant V as View Transition API\n    \n    Note over R,CV: Before Mutation Phase\n    R->>CV: commitAppearingPairViewTransitions()\n    CV->>CV: Find paired enter/exit transitions\n    CV->>H: applyViewTransitionName(instance, name, className)\n    H->>D: element.style.viewTransitionName = name\n    H->>D: element.style.viewTransitionClass = className\n    \n    Note over R,V: Mutation Phase\n    R->>H: startViewTransition(container, types, callbacks...)\n    H->>V: document.startViewTransition(() => mutationCallback())\n    V-->>H: transition handle\n    H->>R: mutationCallback()\n    H->>R: layoutCallback()\n    H->>R: spawnedWorkCallback()\n    \n    Note over V,H: Animation Phase\n    V->>V: Capture old state pseudo-elements\n    V->>V: Apply DOM mutations\n    V->>V: Capture new state pseudo-elements\n    V->>V: Animate between states\n    \n    Note over R,H: After Animation\n    V->>H: Animation completes\n    H->>R: finishedAnimation() (profiling)\n    \n    Note over R,D: Cleanup Phase\n    R->>H: restoreViewTransitionName(instance, props)\n    H->>D: Restore original view-transition-name\n```\n\n**Key Host Config Methods:**\n\n- **`applyViewTransitionName(instance, name, className)`** - Sets `view-transition-name` and optional `view-transition-class` CSS properties\n- **`restoreViewTransitionName(instance, props)`** - Restores the view-transition-name from props after transition completes\n- **`cancelViewTransitionName(instance, name, props)`** - Removes view-transition-name from an element\n- **`cancelRootViewTransitionName(rootContainer)`** - Cancels view transition name on the root container\n- **`restoreRootViewTransitionName(rootContainer)`** - Restores root container\'s view transition name\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1212-1297](), [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js:232-285](), [packages/react-noop-renderer/src/createReactNoop.js:799-826]()\n\n### Starting and Stopping View Transitions\n\n**startViewTransition Host Config Method**\n\nThe `startViewTransition` method coordinates a view transition with React\'s commit phases:\n\n```javascript\nstartViewTransition(\n  rootContainer: Container,\n  transitionTypes: null | TransitionTypes,\n  mutationCallback: () => void,\n  layoutCallback: () => void,\n  afterMutationCallback: () => void,\n  spawnedWorkCallback: () => void,\n  passiveCallback: () => mixed,\n  errorCallback: mixed => void,\n  blockedCallback: string => void,  // Profiling-only\n  finishedAnimation: () => void      // Profiling-only\n): null | RunningViewTransition\n```\n\n**DOM Implementation**\n\nThe DOM renderer in `ReactFiberConfigDOM.js` wraps the native View Transition API:\n\n1. Calls `document.startViewTransition(() => { mutationCallback(); })` to start the transition\n2. Attaches `.finished` promise handler to call `finishedAnimation()` for profiling\n3. Returns the transition object which has `.skipTransition()` method\n4. If animation detection enabled, uses `suspendOnActiveViewTransition()` to wait for animation\n\n**Callback Execution Order:**\n\n1. **`mutationCallback()`** - Executed inside `document.startViewTransition()` to apply DOM changes\n2. **`layoutCallback()`** - Called immediately after mutation to execute layout effects\n3. **`afterMutationCallback()`** - Called after mutations complete (skipped in some paths)\n4. **`spawnedWorkCallback()`** - Called to signal that spawned work needs scheduling\n5. **`passiveCallback()`** - Called during passive effects phase (skipped in some paths)\n6. **`finishedAnimation()`** - Called when animation completes (profiling builds only)\n\n**Stopping Transitions**\n\nThe `stopViewTransition(transition)` method cancels an active transition:\n- In DOM: Calls `transition.skipTransition()` to abort the animation\n- In test renderers: No-op since no actual animation occurs\n\n**Transition Lifecycle Tracking**\n\n```mermaid\ngraph TB\n    subgraph "Start Transition"\n        SVT["startViewTransition()"]\n        DVT["document.startViewTransition()"]\n        MutCB["mutationCallback()"]\n        LayoutCB["layoutCallback()"]\n    end\n    \n    subgraph "Running State"\n        RVT["RunningViewTransition handle"]\n        FP["transition.finished Promise"]\n    end\n    \n    subgraph "Completion"\n        FA["finishedAnimation()"]\n        Cleanup["Restore view transition names"]\n    end\n    \n    SVT --> DVT\n    DVT --> MutCB\n    MutCB --> LayoutCB\n    DVT --> RVT\n    RVT --> FP\n    FP --> FA\n    FA --> Cleanup\n    \n    RVT --> |"stopViewTransition()"| Skip["transition.skipTransition()"]\n    Skip --> Cleanup\n```\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1299-1412](), [packages/react-noop-renderer/src/createReactNoop.js:854-896](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:668-690]()\n\n---\n\n## Apply Gesture Phase\n\n### Instance Cloning for Gestures\n\nDuring gesture transitions, React clones the tree to create a snapshot that can be animated while the live tree renders the destination state. The cloning process is managed by `ReactFiberApplyGesture.js`.\n\n**Cloning Architecture**\n\n```mermaid\ngraph TB\n    subgraph "Original Tree"\n        OF["Original Fiber Tree"]\n        OHI["Original Host Instances"]\n    end\n    \n    subgraph "Cloning Process"\n        CMI["cloneMutableInstance(instance, keepChildren)"]\n        CMTI["cloneMutableTextInstance(textInstance)"]\n        Clone["Clone Tree Construction"]\n    end\n    \n    subgraph "Cloned Tree"\n        CF["Cloned Fiber References"]\n        CHI["Cloned Host Instances"]\n        VTS["ViewTransitionState.clones"]\n    end\n    \n    OF --> CMI\n    OHI --> CMI\n    CMI --> Clone\n    CMTI --> Clone\n    Clone --> CHI\n    Clone --> VTS\n    CF --> CHI\n```\n\n**Visit Phases**\n\nThe apply gesture algorithm uses different visit phases to determine cloning behavior:\n\n| Phase | Value | Description |\n|-------|-------|-------------|\n| `CLONE_UPDATE` | 0 | Mutations or layout changes in this subtree |\n| `CLONE_EXIT` | 1 | Inside reappearing offscreen before next ViewTransition/HostComponent |\n| `CLONE_UNHIDE` | 2 | Inside reappearing offscreen before next HostComponent |\n| `CLONE_APPEARING_PAIR` | 3 | Finding paired appearing transitions |\n| `CLONE_UNCHANGED` | 4 | No changes but walking to clone tree |\n| `INSERT_EXIT` | 5 | Inside newly mounted tree before next ViewTransition/HostComponent |\n| `INSERT_APPEND` | 6 | Inside newly mounted tree before next HostComponent |\n| `INSERT_APPEARING_PAIR` | 7 | Inside newly mounted tree finding pairs |\n\n**Cloning and Mutation Tracking**\n\n```mermaid\nsequenceDiagram\n    participant WL as Work Loop\n    participant AG as ReactFiberApplyGesture\n    participant MT as ReactFiberMutationTracking\n    participant HC as Host Config\n    \n    Note over WL,AG: Apply Gesture Phase\n    WL->>AG: applyGestureToRoot(root, gesture)\n    AG->>MT: pushMutationContext(viewTransitionMutationContext)\n    AG->>AG: Walk fiber tree with visitPhase\n    \n    loop For each ViewTransition boundary\n        AG->>AG: Detect if mutations/layout changes\n        AG->>HC: cloneMutableInstance(instance, keepChildren)\n        HC-->>AG: Cloned instance\n        AG->>AG: Store in ViewTransitionState.clones\n        AG->>HC: applyViewTransitionName(clone, name, className)\n    end\n    \n    AG->>MT: popMutationContext()\n    AG->>MT: Apply tracked mutations to clones\n    AG->>HC: Insert cloned tree into DOM\n```\n\n**Instance Cloning Methods:**\n\n- **`cloneMutableInstance(instance, keepChildren)`** - Clones a host instance, optionally keeping children\n- **`cloneMutableTextInstance(textInstance)`** - Clones a text instance\n- **`cloneRootViewTransitionContainer(rootContainer)`** - Clones the root container for transitions\n\nSources: [packages/react-reconciler/src/ReactFiberApplyGesture.js:104-316](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:613-638]()\n\n### Measurement System\n\n**Instance Measurement and Change Detection**\n\nReact measures instance positions and sizes to determine what changed during a transition:\n\n```mermaid\ngraph TB\n    subgraph "Measurement Phase"\n        MI["measureInstance(instance)"]\n        MCI["measureClonedInstance(clone)"]\n        IM["InstanceMeasurement<br/>{position, size, viewport}"]\n    end\n    \n    subgraph "Change Detection"\n        WIV["wasInstanceInViewport(measurement)"]\n        HIC["hasInstanceChanged(oldMeasurement, newMeasurement)"]\n        HIAP["hasInstanceAffectedParent(oldMeasurement, newMeasurement)"]\n    end\n    \n    subgraph "Decision Logic"\n        Decision["Should animate?"]\n        Apply["Apply view transition name"]\n        Skip["Skip transition"]\n    end\n    \n    MI --> IM\n    MCI --> IM\n    IM --> WIV\n    IM --> HIC\n    IM --> HIAP\n    \n    WIV --> Decision\n    HIC --> Decision\n    HIAP --> Decision\n    \n    Decision --> |"Yes"| Apply\n    Decision --> |"No"| Skip\n```\n\n**Measurement API Methods:**\n\n| Method | Purpose | Implementation |\n|--------|---------|----------------|\n| `measureInstance(instance)` | Captures position and size before changes | DOM: Uses `getBoundingClientRect()` |\n| `measureClonedInstance(instance)` | Measures a cloned instance | DOM: Uses `getBoundingClientRect()` on clone |\n| `wasInstanceInViewport(measurement)` | Checks if instance was in viewport | DOM: Compares bounds to window dimensions |\n| `hasInstanceChanged(oldMeasurement, newMeasurement)` | Detects position/size changes | DOM: Compares measurement values |\n| `hasInstanceAffectedParent(oldMeasurement, newMeasurement)` | Checks if parent layout affected | DOM: Compares parent-relative positions |\n\n**Root Container Cloning:**\n\nFor view transitions involving the root, React clones the entire container:\n\n- **`cloneRootViewTransitionContainer(rootContainer)`** - Creates a snapshot clone of the root\n- **`removeRootViewTransitionClone(rootContainer, clone)`** - Removes the cloned snapshot after transition\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1508-1584](), [packages/react-noop-renderer/src/createReactNoop.js:828-852](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:639-666]()\n\n---\n\n## Gesture Scheduling System\n\n### Gesture Queue and Lifecycle\n\n**FiberRoot Gesture State Management**\n\n```mermaid\ngraph TB\n    subgraph "FiberRoot State"\n        PG["root.pendingGestures<br/>(ScheduledGesture linked list)"]\n        SG["root.stoppingGestures<br/>(Gestures to stop)"]\n        PL["root.pendingLanes"]\n        GL["GestureLane bit"]\n    end\n    \n    subgraph "Scheduling Operations"\n        SchG["scheduleGesture(root, provider)"]\n        StSG["startScheduledGesture(root, timeline, options, types)"]\n        CanG["cancelScheduledGesture(root, gesture)"]\n        DelG["deleteScheduledGesture(root, gesture)"]\n        StopG["stopCompletedGestures(root)"]\n    end\n    \n    subgraph "Work Loop Integration"\n        ERS["ensureRootIsScheduled(root)"]\n        RGL["renderOnGestureLane()"]\n        AGR["applyGestureToRoot()"]\n    end\n    \n    SchG --> PG\n    StSG --> PG\n    CanG --> SG\n    DelG --> PG\n    StopG --> SG\n    \n    PG --> GL\n    GL --> PL\n    PL --> ERS\n    ERS --> RGL\n    RGL --> AGR\n```\n\n### Scheduling Gestures\n\n**scheduleGesture Function Flow**\n\nThe `scheduleGesture(root, provider)` function in `ReactFiberGestureScheduler.js` adds a gesture to the pending queue:\n\n1. Searches `root.pendingGestures` linked list for matching `provider`\n2. If found, returns existing `ScheduledGesture`\n3. If not found, creates new `ScheduledGesture` with initial state:\n   - `count: 0` (not yet started)\n   - `rangeStart: 0, rangeEnd: 100` (uninitialized)\n   - `types: null` (no transition types yet)\n   - `running: null` (no active transition)\n4. Appends to linked list\n5. Calls `ensureRootIsScheduled(root)` to schedule render work\n\n**startScheduledGesture Activation**\n\nThe `startScheduledGesture(root, gestureTimeline, gestureOptions, transitionTypes)` function activates a gesture:\n\n1. Calculates `rangeStart` from `gestureOptions.rangeStart` or `getCurrentGestureOffset(gestureTimeline)`\n2. Calculates `rangeEnd` from `gestureOptions.rangeEnd` or heuristic based on current offset:\n   - If `rangeStart < 50`, default `rangeEnd = 100`\n   - If `rangeStart >= 50`, default `rangeEnd = 0`\n3. Finds matching gesture in `root.pendingGestures`\n4. Increments `gesture.count` (reference counting)\n5. Updates `gesture.rangeStart`, `gesture.rangeEnd`\n6. Merges `transitionTypes` into `gesture.types` array (deduplicates)\n7. Returns the `ScheduledGesture` for tracking\n\n**Gesture Lifecycle Sequence**\n\n```mermaid\nsequenceDiagram\n    participant Hook as startGestureTransition hook\n    participant GS as ReactFiberGestureScheduler\n    participant FR as FiberRoot\n    participant WL as Work Loop\n    participant AG as ReactFiberApplyGesture\n    \n    Note over Hook,GS: Schedule Phase\n    Hook->>GS: scheduleGesture(root, provider)\n    GS->>FR: Search pendingGestures\n    alt Gesture exists\n        FR-->>GS: Return existing ScheduledGesture\n    else New gesture\n        GS->>FR: Create & append ScheduledGesture\n        GS->>GS: ensureRootIsScheduled(root)\n    end\n    GS-->>Hook: Return ScheduledGesture\n    \n    Note over Hook,GS: Start Phase\n    Hook->>GS: startScheduledGesture(root, timeline, options, types)\n    GS->>GS: Calculate rangeStart/rangeEnd\n    GS->>FR: gesture.count++, update ranges & types\n    GS-->>Hook: Return ScheduledGesture\n    \n    Note over FR,AG: Render Phase\n    FR->>WL: Render on GestureLane\n    WL->>AG: applyGestureToRoot(root, gesture)\n    AG->>AG: Clone tree, apply mutations\n    AG->>FR: gesture.running = startGestureTransition(...)\n    \n    Note over Hook,GS: Cancel Phase\n    Hook->>GS: cancelScheduledGesture(root, gesture)\n    GS->>FR: gesture.count--\n    alt count === 0\n        GS->>GS: Delete gesture from list\n        alt Has runningTransition & pending lanes\n            GS->>FR: Move to root.stoppingGestures\n        else Has runningTransition & no pending work\n            GS->>GS: stopViewTransition(runningTransition)\n        end\n    end\n    \n    Note over FR,WL: Post-Commit\n    WL->>GS: stopCompletedGestures(root)\n    GS->>GS: Stop all deferred transitions\n```\n\nSources: [packages/react-reconciler/src/ReactFiberGestureScheduler.js:48-130]()\n\n### Canceling and Stopping Gestures\n\n**cancelScheduledGesture Implementation**\n\nThe `cancelScheduledGesture(root, gesture)` function handles gesture cleanup with reference counting:\n\n1. If `gesture.revertLane !== NoLane`, entangles it with any new transition lanes to ensure they commit together\n2. Decrements `gesture.count`\n3. If `count === 0`:\n   - Determines whether to commit or revert based on final offset:\n     - If `rangeStart < rangeEnd`: commit if `finalOffset > midpoint`\n     - If `rangeStart > rangeEnd`: commit if `finalOffset < midpoint`\n   - If committing and has `gesture.running`:\n     - Sets `gesture.committing = true`\n     - Schedules render on `GestureLane` to commit\n   - Otherwise, calls `deleteScheduledGesture(root, gesture)` to remove\n\n**deleteScheduledGesture Linked List Management**\n\nThe `deleteScheduledGesture(root, gesture)` function removes gesture from queue:\n\n1. Updates linked list pointers:\n   - `gesture.prev.next = gesture.next`\n   - `gesture.next.prev = gesture.prev`\n2. If removing head, updates `root.pendingGestures = gesture.next`\n3. If queue becomes empty (`root.pendingGestures === null`):\n   - Clears `GestureLane` from `root.pendingLanes` via `markRootFinished(root, GestureLane)`\n4. If `gesture.running` exists:\n   - If blocking/transition lanes pending: moves to `root.stoppingGestures`\n   - Otherwise: immediately calls `stopViewTransition(gesture.running)`\n\n**stopCompletedGestures Deferred Cleanup**\n\nThe `stopCompletedGestures(root)` function is called after commit:\n\n1. Checks if `root.stoppingGestures` is non-null\n2. Iterates through linked list of deferred gestures\n3. Calls `stopViewTransition(gesture.running)` for each\n4. Clears `root.stoppingGestures = null`\n\n**Commit Handling**\n\nIf `gesture.committing === true` during render:\n1. Applies mutations to commit the destination state\n2. After commit, triggers revert transition if new gesture scheduled\n3. Otherwise, completes normally without revert\n\nSources: [packages/react-reconciler/src/ReactFiberGestureScheduler.js:132-198]()\n\n---\n\n## Gesture Timeline Integration\n\n### Starting Gesture Transitions\n\nThe `startGestureTransition` method initiates a gesture-driven view transition:\n\n```javascript\nstartGestureTransition(\n  rootContainer: Container,\n  timeline: GestureTimeline,\n  rangeStart: number,\n  rangeEnd: number,\n  transitionTypes: null | TransitionTypes,\n  mutationCallback: () => void,\n  animateCallback: () => void,\n  errorCallback: mixed => void,\n  finishedAnimation: () => void\n): null | RunningViewTransition\n```\n\n**Execution Flow:**\n\n1. Calls `mutationCallback()` to apply DOM mutations\n2. Calls `animateCallback()` to set up animations along the timeline\n3. Optionally calls `finishedAnimation()` for profiling\n4. Returns handle to cancel the gesture transition\n\n**`getCurrentGestureOffset(provider)`** - Queries current position along the gesture timeline (0-100 percentage).\n\nSources: [packages/react-noop-renderer/src/createReactNoop.js:874-897](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:694-730]()\n\n---\n\n## Platform-Specific Implementations\n\n### DOM Renderer Implementation\n\nThe DOM renderer in `ReactFiberConfigDOM.js` provides full view transition support:\n\n**View Transition Name Management**\n\n```javascript\n// Apply view transition name and class\nfunction applyViewTransitionName(instance, name, className) {\n  const style = instance.style;\n  if (typeof style.viewTransitionName === \'string\') {\n    style.viewTransitionName = name;\n    if (className != null) {\n      style.viewTransitionClass = className;\n    }\n  }\n}\n\n// Restore from props\nfunction restoreViewTransitionName(instance, props) {\n  const style = instance.style;\n  if (typeof style.viewTransitionName === \'string\') {\n    const propName = props.style?.viewTransitionName ?? \n                     props.style?.[\'view-transition-name\'];\n    style.viewTransitionName = propName ?? \'\';\n    // Also restore viewTransitionClass...\n  }\n}\n```\n\n**Native View Transition API Integration**\n\nThe `startViewTransition` implementation wraps the browser API:\n\n```javascript\nfunction startViewTransition(\n  rootContainer,\n  transitionTypes,\n  mutationCallback,\n  layoutCallback,\n  afterMutationCallback,\n  spawnedWorkCallback,\n  passiveCallback,\n  errorCallback,\n  blockedCallback,\n  finishedAnimation\n) {\n  const transition = document.startViewTransition(() => {\n    mutationCallback();\n  });\n  \n  layoutCallback();\n  afterMutationCallback();\n  spawnedWorkCallback();\n  \n  transition.finished.then(() => {\n    finishedAnimation();\n  });\n  \n  return transition;\n}\n```\n\n**Measurement Implementation**\n\n- **`measureInstance(instance)`** - Uses `instance.getBoundingClientRect()` to capture position/size\n- **`wasInstanceInViewport(measurement)`** - Compares bounds to `window.innerWidth` and `window.innerHeight`\n- **`hasInstanceChanged(oldMeasurement, newMeasurement)`** - Compares rect properties\n- **`hasInstanceAffectedParent(oldMeasurement, newMeasurement)`** - Checks parent-relative position changes\n\n**Event-Driven Scheduling**\n\n- **`shouldAttemptEagerTransition()`** - Returns `true` during popstate events to render transitions synchronously\n- **`trackSchedulerEvent()`** - Captures `window.event` in `schedulerEvent` variable\n- **`resolveEventType()`** - Returns `window.event.type` if it differs from `schedulerEvent`\n- **`resolveEventTimeStamp()`** - Returns `window.event.timeStamp` for timing\n\n**Instance Cloning**\n\n```javascript\nfunction cloneMutableInstance(instance, keepChildren) {\n  return instance.cloneNode(keepChildren);\n}\n\nfunction cloneMutableTextInstance(textInstance) {\n  return textInstance.cloneNode(false);\n}\n```\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:613-638](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1212-1297](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1299-1412](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:733-770]()\n\n### React Native Implementations\n\n**Fabric Renderer (New Architecture)**\n\nReact Native\'s Fabric renderer in `ReactFiberConfigFabric.js` provides stub implementations:\n\n```javascript\n// View transition names - not yet implemented\nexport function applyViewTransitionName(instance, name, className) {\n  // Not yet implemented\n}\n\n// Start view transition - executes callbacks but no animation\nexport function startViewTransition(...callbacks) {\n  mutationCallback();\n  layoutCallback();\n  // Skip afterMutationCallback - not needed\n  spawnedWorkCallback();\n  // Skip passiveCallback - spawned work will schedule\n  return null;\n}\n\n// Start gesture transition - executes callbacks but no animation\nexport function startGestureTransition(...callbacks) {\n  mutationCallback();\n  animateCallback();\n  if (enableProfilerTimer) {\n    finishedAnimation();\n  }\n  return null;\n}\n\n// Gesture offset - throws error\nexport function getCurrentGestureOffset(provider) {\n  throw new Error(\'startGestureTransition is not yet supported in React Native.\');\n}\n```\n\n**Legacy Renderer (Old Architecture)**\n\nThe legacy renderer in `ReactFiberConfigNative.js` has identical stub implementations. Both renderers execute the callbacks to ensure React\'s commit phases complete correctly, but no actual animations occur since React Native doesn\'t have a native view transition API.\n\n**Measurement Methods**\n\nAll measurement methods return null or dummy values:\n- `measureInstance(instance)` returns `null`\n- `measureClonedInstance(instance)` returns `null`\n- `wasInstanceInViewport(measurement)` returns `true`\n- `hasInstanceChanged(old, new)` returns `false`\n- `hasInstanceAffectedParent(old, new)` returns `false`\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:593-730](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:593-730]()\n\n### Test Renderer Implementation\n\n**react-test-renderer**\n\nThe test renderer in `ReactFiberConfigTestHost.js` provides no-op implementations that allow tests to execute:\n\n```javascript\nexport function startViewTransition(...callbacks) {\n  mutationCallback();\n  layoutCallback();\n  // Skip afterMutationCallback\n  spawnedWorkCallback();\n  // Skip passiveCallback\n  return null;\n}\n\nexport function startGestureTransition(...callbacks) {\n  mutationCallback();\n  animateCallback();\n  if (enableProfilerTimer) {\n    finishedAnimation();\n  }\n  return null;\n}\n\nexport function cloneMutableInstance(instance, keepChildren) {\n  return {\n    type: instance.type,\n    props: instance.props,\n    isHidden: instance.isHidden,\n    children: keepChildren ? instance.children : [],\n    internalInstanceHandle: null,\n    rootContainerInstance: instance.rootContainerInstance,\n    tag: \'INSTANCE\',\n  };\n}\n```\n\n**react-noop-renderer**\n\nThe noop renderer used in React\'s internal tests has more sophisticated implementations for testing purposes:\n- Tracks call counts via `hostCloneCounter`\n- Maintains instance relationships\n- Validates clone operations\n\nSources: [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:176-458](), [packages/react-noop-renderer/src/createReactNoop.js:243-288](), [packages/react-noop-renderer/src/createReactNoop.js:799-897]()\n\n---\n\n## Integration with Reconciler\n\n### Gesture Lane Scheduling\n\nGestures use a dedicated lane (`GestureLane`) defined in `ReactFiberLane.js`:\n\n**Lane Assignment Flow**\n\n```mermaid\ngraph TB\n    subgraph "Component Layer"\n        Hook["startGestureTransition() hook"]\n        Action["User gesture action"]\n    end\n    \n    subgraph "Scheduling Layer"\n        SG["scheduleGesture(root, provider)"]\n        SSG["startScheduledGesture(root, timeline, options)"]\n        ERS["ensureRootIsScheduled(root)"]\n    end\n    \n    subgraph "Lane Management"\n        PL["root.pendingLanes"]\n        GL["GestureLane bit"]\n        MRE["markRootEntangled()"]\n    end\n    \n    subgraph "Work Loop"\n        RGL["performWorkOnRoot(GestureLane)"]\n        AGR["applyGestureToRoot()"]\n        Commit["Commit phase"]\n    end\n    \n    Action --> Hook\n    Hook --> SG\n    SG --> GL\n    GL --> PL\n    SG --> ERS\n    Hook --> SSG\n    SSG --> MRE\n    \n    ERS --> RGL\n    RGL --> AGR\n    AGR --> Commit\n    \n    Commit --> SCG["stopCompletedGestures()"]\n```\n\n**Lane Lifecycle:**\n\n1. `scheduleGesture()` adds gesture to `root.pendingGestures` and implicitly adds `GestureLane` to `root.pendingLanes`\n2. `ensureRootIsScheduled(root)` schedules work on `GestureLane`\n3. During render, `applyGestureToRoot()` processes the gesture\n4. `deleteScheduledGesture()` clears `GestureLane` via `markRootFinished(root, GestureLane)` when queue empties\n5. If gesture has blocking/transition work, lane stays set until commit completes\n\n**Entanglement:**\n\nWhen canceling a gesture with `revertLane !== NoLane`, the revert lane is entangled with new transition lanes via `markRootEntangled()` to ensure they commit together.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:108](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js:17-22](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js:138-141]()\n\n### Commit Phase Integration\n\n**View Transition Commit Sequence**\n\n```mermaid\nsequenceDiagram\n    participant WL as Work Loop\n    participant CV as ReactFiberCommitViewTransitions\n    participant HC as Host Config\n    participant AG as ReactFiberApplyGesture\n    participant GS as ReactFiberGestureScheduler\n    \n    Note over WL,CV: Before Mutation Phase\n    WL->>CV: Track appearing view transitions\n    WL->>CV: commitAppearingPairViewTransitions()\n    CV->>HC: applyViewTransitionName() for pairs\n    \n    Note over WL,HC: Mutation Phase\n    WL->>HC: startViewTransition(callbacks...)\n    HC->>HC: document.startViewTransition(() => mutationCallback())\n    HC->>WL: Execute mutation effects\n    \n    Note over WL,HC: Layout Phase\n    HC->>WL: layoutCallback()\n    WL->>WL: Execute layout effects\n    \n    Note over WL,HC: After Mutation\n    HC->>WL: spawnedWorkCallback()\n    WL->>WL: Schedule spawned work\n    \n    Note over WL,HC: Passive Phase\n    HC->>WL: passiveCallback()\n    WL->>WL: Execute passive effects\n    \n    Note over WL,GS: Cleanup Phase\n    WL->>GS: stopCompletedGestures(root)\n    GS->>HC: stopViewTransition() for deferred gestures\n    GS->>GS: Clear root.stoppingGestures\n```\n\n**Phase Responsibilities:**\n\n| Phase | Responsibilities |\n|-------|------------------|\n| **Before Mutation** | Track appearing ViewTransitions, find pairs, measure instances |\n| **Mutation** | Start view transition, apply DOM mutations in mutationCallback |\n| **Layout** | Execute layout effects, measure after layout |\n| **After Mutation** | Coordinate spawned work, insert cloned trees for gestures |\n| **Passive** | Execute passive effects, schedule any remaining work |\n| **Post-Commit** | Stop deferred gesture transitions, clean up stoppingGestures |\n\n**Gesture Apply Phase:**\n\nFor gesture transitions, `applyGestureToRoot()` is called during the render phase (not commit):\n1. Clones the fiber tree to create a snapshot\n2. Applies mutations to clones\n3. Inserts cloned tree into DOM\n4. Starts `startGestureTransition()` with timeline\n5. Stores handle in `gesture.running`\n\nSources: [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js:232-285](), [packages/react-reconciler/src/ReactFiberApplyGesture.js:317-800](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js:185-198]()\n\n---\n\n## Summary\n\nReact\'s view transition and gesture scheduling systems provide:\n\n| Component | Purpose | Key Types | Key Methods |\n|-----------|---------|-----------|-------------|\n| **View Transitions** | Browser API integration | `ViewTransitionInstance`, `RunningViewTransition` | `startViewTransition`, `applyViewTransitionName`, measurement methods |\n| **Gesture Scheduling** | Timeline-driven animations | `ScheduledGesture`, `GestureTimeline` | `scheduleGesture`, `startScheduledGesture`, `cancelScheduledGesture` |\n| **Measurement** | Change detection | `InstanceMeasurement` | `measureInstance`, `hasInstanceChanged`, `wasInstanceInViewport` |\n| **Host Config** | Platform abstraction | Platform-specific handles | All methods implemented per-platform |\n\nThe DOM renderer provides full support for these features, while React Native and test renderers provide stub implementations that maintain API compatibility without actual animations.\n\nSources: [packages/react-reconciler/src/ReactFiberGestureScheduler.js](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](), [packages/react-noop-renderer/src/createReactNoop.js]()\n\n---\n\n# Page: Developer Tools and Debugging\n\n# Developer Tools and Debugging\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [fixtures/devtools/standalone/index.html](fixtures/devtools/standalone/index.html)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-devtools-core/README.md](packages/react-devtools-core/README.md)\n- [packages/react-devtools-core/src/backend.js](packages/react-devtools-core/src/backend.js)\n- [packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js](packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js)\n- [packages/react-devtools-extensions/src/contentScripts/installHook.js](packages/react-devtools-extensions/src/contentScripts/installHook.js)\n- [packages/react-devtools-extensions/src/contentScripts/messages.js](packages/react-devtools-extensions/src/contentScripts/messages.js)\n- [packages/react-devtools-inline/src/backend.js](packages/react-devtools-inline/src/backend.js)\n- [packages/react-devtools-shared/src/__tests__/componentStacks-test.js](packages/react-devtools-shared/src/__tests__/componentStacks-test.js)\n- [packages/react-devtools-shared/src/__tests__/console-test.js](packages/react-devtools-shared/src/__tests__/console-test.js)\n- [packages/react-devtools-shared/src/__tests__/inspectedElement-test.js](packages/react-devtools-shared/src/__tests__/inspectedElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js](packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/setupTests.js](packages/react-devtools-shared/src/__tests__/setupTests.js)\n- [packages/react-devtools-shared/src/__tests__/store-test.js](packages/react-devtools-shared/src/__tests__/store-test.js)\n- [packages/react-devtools-shared/src/attachRenderer.js](packages/react-devtools-shared/src/attachRenderer.js)\n- [packages/react-devtools-shared/src/backend/agent.js](packages/react-devtools-shared/src/backend/agent.js)\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js](packages/react-devtools-shared/src/backend/fiber/renderer.js)\n- [packages/react-devtools-shared/src/backend/legacy/renderer.js](packages/react-devtools-shared/src/backend/legacy/renderer.js)\n- [packages/react-devtools-shared/src/backend/types.js](packages/react-devtools-shared/src/backend/types.js)\n- [packages/react-devtools-shared/src/backend/views/Highlighter/index.js](packages/react-devtools-shared/src/backend/views/Highlighter/index.js)\n- [packages/react-devtools-shared/src/backendAPI.js](packages/react-devtools-shared/src/backendAPI.js)\n- [packages/react-devtools-shared/src/bridge.js](packages/react-devtools-shared/src/bridge.js)\n- [packages/react-devtools-shared/src/devtools/store.js](packages/react-devtools-shared/src/devtools/store.js)\n- [packages/react-devtools-shared/src/devtools/utils.js](packages/react-devtools-shared/src/devtools/utils.js)\n- [packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js](packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js)\n- [packages/react-devtools-shared/src/devtools/views/utils.js](packages/react-devtools-shared/src/devtools/views/utils.js)\n- [packages/react-devtools-shared/src/frontend/types.js](packages/react-devtools-shared/src/frontend/types.js)\n- [packages/react-devtools-shared/src/hook.js](packages/react-devtools-shared/src/hook.js)\n- [packages/react-devtools-shared/src/hydration.js](packages/react-devtools-shared/src/hydration.js)\n- [packages/react-devtools-shared/src/utils.js](packages/react-devtools-shared/src/utils.js)\n- [packages/react-devtools-shell/src/app/ElementTypes/index.js](packages/react-devtools-shell/src/app/ElementTypes/index.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js](packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js](packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js](packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/react/src/ReactForwardRef.js](packages/react/src/ReactForwardRef.js)\n- [packages/react/src/ReactMemo.js](packages/react/src/ReactMemo.js)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\nThe React repository provides comprehensive developer tooling that operates across the development lifecycle:\n\n| Tool | Phase | Purpose |\n|------|-------|---------|\n| **eslint-plugin-react-hooks** | Edit/Build Time | Statically validates Rules of Hooks and dependency arrays |\n| **React DevTools** | Runtime | Inspects component trees, profiles performance, debugs state |\n| **Console Patching** | Runtime | Appends component stacks to console messages |\n| **Performance Tracks** | Runtime | Emits User Timing marks for Performance panel |\n\nReact DevTools consists of a backend that attaches to React renderers via `__REACT_DEVTOOLS_GLOBAL_HOOK__`, a frontend that displays component trees and profiling data, and a versioned bridge protocol for communication. The ESLint plugin uses AST analysis to enforce Hook usage patterns. Console patching infrastructure enhances error messages with component stacks.\n\n**Sources:**\n- [packages/react-devtools-shared/src/hook.js:58-86]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1006-1102]()\n- [packages/eslint-plugin-react-hooks/src/RulesOfHooks.ts:1-50]()\n\n## React DevTools\n\nReact DevTools provides runtime inspection and profiling of React applications. The system consists of:\n\n- **Backend**: Attaches to React renderers via `__REACT_DEVTOOLS_GLOBAL_HOOK__.inject()`, wraps Fiber nodes in `DevToolsInstance` objects with stable IDs\n- **Frontend**: Displays component trees, state/props, and profiling data through the `Store` class\n- **Bridge**: Versioned protocol (version 2) for communication, serializes tree mutations as compact integer arrays\n\nDevTools Tooling Ecosystem\n\n```mermaid\ngraph TB\n    subgraph Packages["DevTools Packages"]\n        hook["react-devtools-shared/src/hook.js<br/>__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        backend["react-devtools-shared/src/backend/<br/>agent.js, renderer.js"]\n        frontend["react-devtools-shared/src/devtools/<br/>store.js, views/"]\n        bridge["react-devtools-shared/src/bridge.js<br/>FrontendBridge, BackendBridge"]\n    end\n    \n    subgraph Distributions["Distribution Models"]\n        standalone["react-devtools<br/>Electron + WebSocket"]\n        extension["react-devtools-extensions<br/>Chrome/Firefox/Edge"]\n        inline["react-devtools-inline<br/>Embeddable UI"]\n    end\n    \n    subgraph ReactApp["React Application"]\n        renderer["ReactDOM/ReactNative<br/>renderer.inject()"]\n        fibers["Fiber tree"]\n    end\n    \n    hook --> renderer\n    renderer --> backend\n    backend --> bridge\n    bridge --> frontend\n    \n    backend --> standalone\n    backend --> extension\n    backend --> inline\n    \n    renderer --> fibers\n    backend -.->|"wraps"| fibers\n    \n    style hook fill:#f9f9f9\n    style backend fill:#f9f9f9\n    style bridge fill:#f9f9f9\n```\n\nKey capabilities:\n- **Component Tree**: `Store` maintains `_idToElement`, `_ownersMap`, `_roots` to track component hierarchy\n- **State Inspection**: `inspectHooksOfFiber()` extracts hook values, `cleanForBridge()` serializes complex data\n- **Performance Profiling**: `injectProfilingHooks()` collects `fiberActualDurations`, effect timings\n- **Suspense Debugging**: `_idToSuspense` tracks suspension state, visualizes boundaries spatially\n\nDevTools supports three deployment models: standalone Electron app, browser extensions, and inline embeddable UI. See page 7.1 for detailed architecture and page 7.2 for distribution details.\n\n**Sources:**\n- [packages/react-devtools-shared/src/hook.js:58-86]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:183-292]()\n- [packages/react-devtools-shared/src/devtools/store.js:143-348]()\n- [packages/react-devtools-shared/src/bridge.js:47-73]()\n- [packages/react-devtools/package.json:1-32]()\n\n## Console Integration and Debugging Utilities\n\nBeyond the DevTools UI, React provides several runtime debugging utilities that enhance the browser console experience.\n\n### Console Patching\n\nConsole Patching Implementation (hook.js)\n\n```mermaid\ngraph TB\n    subgraph HookSetup["Global Hook Setup (hook.js:58-110)"]\n        installHook["installHook()"]\n        GlobalHook["window.__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        settings["settings: DevToolsHookSettings"]\n    end\n    \n    subgraph Patching["Console Method Patching (hook.js:110-267)"]\n        targetMethod["console.error/warn/log"]\n        savedMethod["Save original method"]\n        overrideMethod["Override with patched version"]\n        checkSettings["if settings.appendComponentStack"]\n        formatArgs["formatConsoleArguments()"]\n    end\n    \n    subgraph StackGen["Component Stack Generation"]\n        getCurrentFiber["renderer.getCurrentFiber()"]\n        getStack["getStackByFiberInDevAndProd()<br/>or getOwnerStackByFiberInDev()"]\n        appendStack["Append to console args"]\n        callOriginal["Call original console method"]\n    end\n    \n    installHook --> GlobalHook\n    GlobalHook --> settings\n    targetMethod --> savedMethod\n    savedMethod --> overrideMethod\n    overrideMethod --> checkSettings\n    checkSettings -->|"true"| formatArgs\n    formatArgs --> getCurrentFiber\n    getCurrentFiber --> getStack\n    getStack --> appendStack\n    appendStack --> callOriginal\n    checkSettings -->|"false"| callOriginal\n```\n\nThe hook patches console methods in [hook.js:110-267](). Key implementation details:\n\n- **Settings**: `DevToolsHookSettings` controls behavior\n  - `appendComponentStack` - Whether to append stacks (default: true in dev)\n  - `breakOnConsoleErrors` - Debugger breakpoint on errors\n- **Stack Extraction**: Calls `renderer.getCurrentFiber()` to get active Fiber, then `getStackByFiberInDevAndProd()` or `getOwnerStackByFiberInDev()` [renderer.js:133-138]()\n- **Formatting**: `formatConsoleArguments()` inserts ANSI/CSS styling for dimmed component stacks\n\n### Component Stacks\n\nReact 19.1+ supports **Owner Stacks** which show logical component ownership rather than the render tree hierarchy:\n\n- `captureOwnerStack()` - Public API to capture owner stack at any point [CHANGELOG.md:98]()\n- `supportsOwnerStacks()` - Backend check for owner stack support [DevToolsFiberComponentStack.js:136-137]()\n- `getOwnerStackByFiberInDev()` - Extracts owner chain from Fiber [DevToolsFiberComponentStack.js:135-138]()\n- `formatOwnerStack()` - Formats owner stack for display [DevToolsOwnerStack.js]()\n\nOwner stacks differ from traditional component stacks:\n- Show which component created an element (owner), not which component rendered it (parent)\n- Useful for HOCs and render props where ownership  parent-child relationship\n- Work across server-client boundaries in Server Components\n\n### Performance Tracks\n\nReact 19.2+ emits User Timing API marks that appear in the Performance panel [CHANGELOG.md:12]():\n\n- Profiling hooks injected via `injectProfilingHooks()` [renderer.js:1106-1119]()\n- Marks created for:\n  - Component render start/end\n  - Commit phase start/end  \n  - Passive effects start/end\n- `supportsPerformanceTracks` capability flag [store.js:86]()\n\n**Sources:**\n- [packages/react-devtools-shared/src/hook.js:110-267]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:133-138]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1106-1119]()\n- [packages/react-devtools-shared/src/devtools/store.js:86]()\n- [CHANGELOG.md:12]()\n- [CHANGELOG.md:86]()\n\n## ESLint Plugin for React Hooks\n\nThe `eslint-plugin-react-hooks` package enforces Hook usage patterns through static AST analysis. It provides two rules:\n\n| Rule | Severity | Purpose |\n|------|----------|---------|\n| `rules-of-hooks` | error | Ensures Hooks are only called at top level, not in loops/conditions |\n| `exhaustive-deps` | warn | Validates dependency arrays for `useEffect`, `useMemo`, `useCallback` |\n\nESLint Plugin Analysis Flow\n\n```mermaid\ngraph TB\n    subgraph RulesOfHooks["rules-of-hooks"]\n        visitCall["Visit CallExpression"]\n        matchHook["Match /^use[A-Z]/ pattern"]\n        getCodePath["ESLint CodePathSegment"]\n        checkContext["isInsideLoop()<br/>isInsideConditional()"]\n        reportViolation["Report: Hook in loop/condition"]\n    end\n    \n    subgraph ExhaustiveDeps["exhaustive-deps"]\n        visitEffect["Visit useEffect/useMemo/useCallback"]\n        extractDeps["Extract dependency array"]\n        analyzeScope["Analyze callback scope"]\n        collectRefs["collectReferencesInScope()"]\n        checkStable["Filter stable values:<br/>setState, dispatch, ref.current"]\n        diffDeps["Compare vs declared deps"]\n        suggestFix["Suggest missing/extra deps"]\n    end\n    \n    visitCall --> matchHook\n    matchHook --> getCodePath\n    getCodePath --> checkContext\n    checkContext -->|"invalid"| reportViolation\n    \n    visitEffect --> extractDeps\n    visitEffect --> analyzeScope\n    analyzeScope --> collectRefs\n    collectRefs --> checkStable\n    extractDeps --> diffDeps\n    checkStable --> diffDeps\n    diffDeps --> suggestFix\n    \n    style visitCall fill:#f9f9f9\n    style visitEffect fill:#f9f9f9\n```\n\nThe plugin uses ESLint\'s `CodePath` API to track control flow and detects violations through visitor pattern on `CallExpression` nodes. `rules-of-hooks` validates calling context, while `exhaustive-deps` analyzes closure scope to identify missing dependencies.\n\nConfiguration example:\n```javascript\nimport reactHooks from \'eslint-plugin-react-hooks\';\nexport default [reactHooks.configs.flat.recommended];\n```\n\nOptions include `additionalHooks` for custom hook patterns and `enableDangerousAutofixThreshold` for automatic fixes. See page 7.3 for detailed implementation.\n\n**Sources:**\n- [packages/eslint-plugin-react-hooks/src/RulesOfHooks.ts:1-50]()\n- [packages/eslint-plugin-react-hooks/src/ExhaustiveDeps.ts:1-100]()\n- [packages/eslint-plugin-react-hooks/README.md:1-150]()\n\n## Build and Distribution\n\n### Package Structure\n\nThe DevTools codebase is organized into several npm packages:\n\n| Package | Purpose | Main Exports |\n|---------|---------|--------------|\n| `react-devtools` | Standalone Electron app | Binary: `bin.js` |\n| `react-devtools-core` | Backend + WebSocket server | `backend.js`, `standalone.js` |\n| `react-devtools-inline` | Embeddable UI | `backend.js`, `frontend.js` |\n| `react-devtools-extensions` | Browser extensions | Not published to npm |\n| `react-devtools-shared` | Shared utilities | Internal only |\n| `eslint-plugin-react-hooks` | ESLint rules | Plugin export |\n\n**Sources:**\n- [packages/react-devtools/package.json:1-32]()\n- [packages/react-devtools-core/package.json:1-38]()\n- [packages/react-devtools-inline/package.json:1-52]()\n\n### Build Process\n\nDevTools Build System (Webpack)\n\n```mermaid\ngraph TB\n    subgraph Sources["Source Packages"]\n        shared["react-devtools-shared/src/"]\n        backend["backend/"]\n        frontend["devtools/"]\n        core["react-devtools-core/src/"]\n        inline["react-devtools-inline/src/"]\n    end\n    \n    subgraph WebpackConfigs["Webpack Configurations"]\n        backendWebpack["webpack.backend.js"]\n        standaloneWebpack["webpack.standalone.js"]\n        extensionWebpack["chrome/webpack.config.js<br/>firefox/webpack.config.js"]\n    end\n    \n    subgraph Artifacts["Build Artifacts"]\n        coreBackend["react-devtools-core/dist/backend.js"]\n        coreStandalone["react-devtools-core/dist/standalone.js"]\n        inlineBackend["react-devtools-inline/dist/backend.js"]\n        inlineFrontend["react-devtools-inline/dist/frontend.js"]\n        extensionBundle["extensions/chrome/build/react_devtools_backend.js"]\n    end\n    \n    shared --> backendWebpack\n    backend --> backendWebpack\n    shared --> standaloneWebpack\n    frontend --> standaloneWebpack\n    \n    backendWebpack --> coreBackend\n    standaloneWebpack --> coreStandalone\n    backendWebpack --> inlineBackend\n    standaloneWebpack --> inlineFrontend\n    extensionWebpack --> extensionBundle\n```\n\n**Build Environment Variables**:\n\n| Variable | Values | Effect |\n|----------|--------|--------|\n| `NODE_ENV` | `development`, `production` | Affects `__DEV__` checks, minification |\n| `FEATURE_FLAG_TARGET` | `core`, `backend-fb` | Enables Meta-internal features |\n| Source Maps | Generated for inline/extension builds | `devtool: \'source-map\'` in webpack config |\n\n**Bundle Targets**:\n- **backend.js**: Runs in application context, exports `initialize()` [backend/index.js]()\n- **frontend.js**: UI bundle with React DevTools components\n- **standalone.js**: Combined frontend with WebSocket client\n\nThe build system uses Webpack DefinePlugin to inline environment-specific constants, and BabelPlugin for JSX transformation.\n\n**Sources:**\n- [packages/react-devtools-core/package.json:17-25]()\n- [packages/react-devtools-inline/package.json:19-21]()\n\n### Version Compatibility\n\nDevTools maintains backward and forward compatibility through:\n\n1. **Bridge Protocol Versioning**: Current version is 2 [bridge.js:66-69]()\n2. **Unsupported Renderer Detection**: Shows warnings for too-old React versions\n3. **NPM Version Ranges**: Protocol includes `minNpmVersion` and `maxNpmVersion` [bridge.js:32-34]()\n\nWhen versions mismatch:\n- Newer backend  older frontend: Backend sends `minNpmVersion`, frontend shows upgrade prompt\n- Older backend  newer frontend: Frontend uses embedded version map to show downgrade instructions\n\n**Sources:**\n- [packages/react-devtools-shared/src/bridge.js:47-73]()\n- [packages/react-devtools-shared/src/devtools/store.js:169-220]()\n\n---\n\n# Page: React DevTools Architecture\n\n# React DevTools Architecture\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [fixtures/devtools/standalone/index.html](fixtures/devtools/standalone/index.html)\n- [packages/react-devtools-core/README.md](packages/react-devtools-core/README.md)\n- [packages/react-devtools-core/src/backend.js](packages/react-devtools-core/src/backend.js)\n- [packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js](packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js)\n- [packages/react-devtools-extensions/src/contentScripts/installHook.js](packages/react-devtools-extensions/src/contentScripts/installHook.js)\n- [packages/react-devtools-extensions/src/contentScripts/messages.js](packages/react-devtools-extensions/src/contentScripts/messages.js)\n- [packages/react-devtools-inline/src/backend.js](packages/react-devtools-inline/src/backend.js)\n- [packages/react-devtools-shared/src/__tests__/componentStacks-test.js](packages/react-devtools-shared/src/__tests__/componentStacks-test.js)\n- [packages/react-devtools-shared/src/__tests__/console-test.js](packages/react-devtools-shared/src/__tests__/console-test.js)\n- [packages/react-devtools-shared/src/__tests__/inspectedElement-test.js](packages/react-devtools-shared/src/__tests__/inspectedElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js](packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/setupTests.js](packages/react-devtools-shared/src/__tests__/setupTests.js)\n- [packages/react-devtools-shared/src/__tests__/store-test.js](packages/react-devtools-shared/src/__tests__/store-test.js)\n- [packages/react-devtools-shared/src/attachRenderer.js](packages/react-devtools-shared/src/attachRenderer.js)\n- [packages/react-devtools-shared/src/backend/agent.js](packages/react-devtools-shared/src/backend/agent.js)\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js](packages/react-devtools-shared/src/backend/fiber/renderer.js)\n- [packages/react-devtools-shared/src/backend/legacy/renderer.js](packages/react-devtools-shared/src/backend/legacy/renderer.js)\n- [packages/react-devtools-shared/src/backend/types.js](packages/react-devtools-shared/src/backend/types.js)\n- [packages/react-devtools-shared/src/backend/views/Highlighter/index.js](packages/react-devtools-shared/src/backend/views/Highlighter/index.js)\n- [packages/react-devtools-shared/src/backendAPI.js](packages/react-devtools-shared/src/backendAPI.js)\n- [packages/react-devtools-shared/src/bridge.js](packages/react-devtools-shared/src/bridge.js)\n- [packages/react-devtools-shared/src/devtools/store.js](packages/react-devtools-shared/src/devtools/store.js)\n- [packages/react-devtools-shared/src/devtools/utils.js](packages/react-devtools-shared/src/devtools/utils.js)\n- [packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js](packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js)\n- [packages/react-devtools-shared/src/devtools/views/utils.js](packages/react-devtools-shared/src/devtools/views/utils.js)\n- [packages/react-devtools-shared/src/frontend/types.js](packages/react-devtools-shared/src/frontend/types.js)\n- [packages/react-devtools-shared/src/hook.js](packages/react-devtools-shared/src/hook.js)\n- [packages/react-devtools-shared/src/hydration.js](packages/react-devtools-shared/src/hydration.js)\n- [packages/react-devtools-shared/src/utils.js](packages/react-devtools-shared/src/utils.js)\n- [packages/react-devtools-shell/src/app/ElementTypes/index.js](packages/react-devtools-shell/src/app/ElementTypes/index.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js](packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js](packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js](packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js)\n- [packages/react/src/ReactForwardRef.js](packages/react/src/ReactForwardRef.js)\n- [packages/react/src/ReactMemo.js](packages/react/src/ReactMemo.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes the architecture of React DevTools, the debugging and profiling tooling for React applications. It covers the three-tier architecture (Backend, Bridge, Frontend), the instrumentation mechanism, the bridge protocol for cross-context communication, and the various distribution channels (browser extensions, standalone app, inline embedding).\n\nFor information about the ESLint plugin for React hooks, see [7.2](#7.2). For details about React\'s internal reconciler and Fiber architecture that DevTools instruments, see [4.1](#4.1).\n\n---\n\n## High-Level Architecture\n\nReact DevTools uses a **three-tier architecture** that separates concerns between application instrumentation, communication, and user interface:\n\n```mermaid\ngraph TB\n    subgraph "Application Context"\n        App["React Application"]\n        Hook["__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        Renderer["React Renderer<br/>(react-dom, react-native)"]\n        Backend["DevTools Backend<br/>FiberRenderer/LegacyRenderer"]\n        Agent["Agent<br/>Command Dispatcher"]\n    end\n    \n    subgraph "Communication Layer"\n        Bridge["Bridge Protocol<br/>EventEmitter + Wall"]\n    end\n    \n    subgraph "DevTools UI Context"\n        Store["Store<br/>Tree State Manager<br/>_idToElement Map"]\n        ProfilerStore["ProfilerStore<br/>Profiling Data"]\n        ComponentsPanel["Components Panel"]\n        ProfilerPanel["Profiler Panel"]\n    end\n    \n    App --> Renderer\n    Renderer -->|"inject()"| Hook\n    Hook -->|"attach()"| Backend\n    Backend --> Agent\n    Agent <-->|"send/listen"| Bridge\n    Bridge <-->|"operations"| Store\n    Store --> ComponentsPanel\n    ProfilerStore --> ProfilerPanel\n    Store --> ProfilerStore\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1007-1014]()\n- [packages/react-devtools-shared/src/backend/agent.js:263-276]()\n- [packages/react-devtools-shared/src/devtools/store.js:143-169]()\n- [packages/react-devtools-shared/src/hook.js:58-68]()\n\nThe architecture separates concerns:\n- **Backend** runs in the same JavaScript context as the React application, instrumenting the reconciler\n- **Bridge** provides version-agnostic message passing between backend and frontend\n- **Frontend** runs in a separate context (extension panel, standalone window, or embedded iframe) and provides the UI\n\n---\n\n## Backend Architecture\n\n### Global Hook Injection\n\nThe DevTools backend uses a global hook installed on `window.__REACT_DEVTOOLS_GLOBAL_HOOK__` to intercept React renderer initialization. This hook is a de facto public API that React renderers detect and call during initialization.\n\n**DevToolsHook Object Structure:**\n\n```mermaid\ngraph TB\n    Hook["__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n    \n    subgraph "Core Properties"\n        renderers["renderers: Map<RendererID, ReactRenderer>"]\n        rendererInterfaces["rendererInterfaces: Map<RendererID, RendererInterface>"]\n        backends["backends: Map<string, DevToolsBackend>"]\n        listeners["listeners: {[event]: Array<Handler>}"]\n    end\n    \n    subgraph "React Callbacks"\n        inject["inject(renderer): number | null"]\n        onCommitFiberRoot["onCommitFiberRoot(rendererID, root, priority?)"]\n        onCommitFiberUnmount["onCommitFiberUnmount(rendererID, fiber)"]\n    end\n    \n    subgraph "DevTools Callbacks"\n        emit["emit(event, data)"]\n        on["on(event, handler)"]\n        sub["sub(event, handler)"]\n    end\n    \n    subgraph "Settings"\n        settings["settings: DevToolsHookSettings"]\n    end\n    \n    Hook --> renderers\n    Hook --> rendererInterfaces\n    Hook --> backends\n    Hook --> listeners\n    Hook --> inject\n    Hook --> onCommitFiberRoot\n    Hook --> onCommitFiberUnmount\n    Hook --> emit\n    Hook --> on\n    Hook --> sub\n    Hook --> settings\n```\n\n**Hook Installation Flow:**\n\n```mermaid\nsequenceDiagram\n    participant PageLoad as "Page Load"\n    participant installHook as "installHook()"\n    participant Hook as "__REACT_DEVTOOLS_GLOBAL_HOOK__"\n    participant Renderer as "React Renderer"\n    participant Backend as "Backend attach()"\n    \n    PageLoad->>installHook: Execute\n    installHook->>Hook: Create hook object\n    installHook->>Hook: Set listeners, backends, renderers Maps\n    installHook->>Hook: Define inject(), onCommitFiberRoot(), etc.\n    \n    Note over Renderer: React loads and initializes\n    \n    Renderer->>Hook: Check for __REACT_DEVTOOLS_GLOBAL_HOOK__\n    Renderer->>Hook: call inject(renderer)\n    Hook->>Hook: Assign rendererID = ++UID\n    Hook->>Hook: renderers.set(rendererID, renderer)\n    Hook->>Hook: emit("renderer", {id, renderer})\n    Hook->>Backend: Listener receives "renderer" event\n    Backend->>Backend: Call attach(hook, rendererID, renderer)\n    Backend->>Hook: rendererInterfaces.set(rendererID, interface)\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/hook.js:59-230]()\n- [packages/react-devtools-shared/src/backend/types.js:552-593]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1004-1028]()\n\nThe hook is installed early, before React loads, by:\n- **Browser extensions**: injected via content script executing `installHook.js`\n- **Standalone app**: served from local HTTP server on `http://localhost:8097`\n- **Inline embedding**: bundled in the page via `activate(window)`\n\n**Sources:**\n- [packages/react-devtools-extensions/src/contentScripts/installHook.js:1-85]()\n- [packages/react-devtools-core/src/backend.js:63-150]()\n- [packages/react-devtools-inline/src/backend.js:1-100]()\n\n### Backend Renderer Interface\n\nThe backend provides a `RendererInterface` that handles all interactions with a specific React renderer:\n\n| Method | Purpose |\n|--------|---------|\n| `flushInitialOperations()` | Send initial tree state to frontend |\n| `findHostInstancesForElementID()` | Map DevTools element ID to DOM/host instances |\n| `inspectElement()` | Retrieve detailed props/state/hooks for an element |\n| `overrideProps()` / `overrideHookState()` | Live-edit component data |\n| `getProfilingData()` | Collect profiling measurements |\n| `setTraceUpdatesEnabled()` | Enable/disable render highlighting |\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/types.js:412-455]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1007-1425]()\n\n### Fiber Tree Instrumentation\n\nThe backend instruments React\'s Fiber reconciler by creating a parallel data structure that mirrors the component tree. For each Fiber, the backend creates either a `FiberInstance`, `VirtualInstance`, or `FilteredFiberInstance`:\n\n```mermaid\ngraph TB\n    subgraph "React Reconciler"\n        FiberTree["Fiber Tree<br/>(React Internal)"]\n        FiberNode1["Fiber Node"]\n        FiberNode2["Fiber Node"]\n    end\n    \n    subgraph "DevTools Backend"\n        DevToolsTree["DevTools Instance Tree"]\n        FiberInstance["FiberInstance<br/>{kind: 0, id, data: Fiber}"]\n        VirtualInstance["VirtualInstance<br/>{kind: 1, id, data: ReactComponentInfo}"]\n        FilteredInstance["FilteredFiberInstance<br/>{kind: 2, data: Fiber}"]\n    end\n    \n    subgraph "Maps"\n        idToElement["idToDevToolsInstanceMap<br/>Map<id, DevToolsInstance>"]\n        rootToFiber["rootToFiberInstanceMap<br/>Map<FiberRoot, FiberInstance>"]\n        publicToElement["publicInstanceToDevToolsInstanceMap<br/>Map<HostInstance, DevToolsInstance>"]\n    end\n    \n    FiberNode1 -.->|"instruments"| FiberInstance\n    FiberNode2 -.->|"instruments"| VirtualInstance\n    FiberInstance --> DevToolsTree\n    VirtualInstance --> DevToolsTree\n    FilteredInstance -.->|"filtered but tracked"| DevToolsTree\n    \n    DevToolsTree --> idToElement\n    DevToolsTree --> rootToFiber\n    DevToolsTree --> publicToElement\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:185-293]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:864-888]()\n\nInstance types:\n- **FiberInstance** (`kind: 0`): Represents a stateful Fiber pair (current/work-in-progress) for client components\n- **VirtualInstance** (`kind: 1`): Represents server components or optimized-away components that don\'t create Fibers\n- **FilteredFiberInstance** (`kind: 2`): Hidden by component filters but tracked to find host instances\n\n### Tree Operations Protocol\n\nThe backend sends tree mutations to the frontend as compact numeric arrays called **operations**. Each operation is prefixed with an operation code:\n\n| Operation Code | Constant | Purpose |\n|----------------|----------|---------|\n| `1` | `TREE_OPERATION_ADD` | Add new element to tree |\n| `2` | `TREE_OPERATION_REMOVE` | Remove element(s) from tree |\n| `3` | `TREE_OPERATION_REORDER_CHILDREN` | Reorder children of an element |\n| `4` | `TREE_OPERATION_UPDATE_TREE_BASE_DURATION` | Update profiling duration |\n| `5` | `TREE_OPERATION_UPDATE_ERRORS_OR_WARNINGS` | Update error/warning counts |\n| `7` | `TREE_OPERATION_SET_SUBTREE_MODE` | Update StrictMode status |\n| `8` | `SUSPENSE_TREE_OPERATION_ADD` | Add Suspense boundary |\n| `12` | `SUSPENSE_TREE_OPERATION_SUSPENDERS` | Update Suspense state |\n\n**Sources:**\n- [packages/react-devtools-shared/src/constants.js:20-32]()\n- [packages/react-devtools-shared/src/utils.js:224-464]()\n\nOperations include a string table to avoid repetition:\n\n```\n[rendererID, rootID, stringTableSize, ...encodedStrings, ...operations]\n```\n\nThis compact format minimizes serialization overhead when sending tree updates across the bridge.\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1426-1600]()\n\n---\n\n## Bridge Protocol\n\n### Protocol Versioning\n\nThe bridge uses a versioned protocol to handle compatibility between different DevTools versions. The protocol version is negotiated on connection:\n\n```mermaid\nsequenceDiagram\n    participant Backend\n    participant Bridge\n    participant Frontend\n    \n    Backend->>Bridge: emit("bridgeProtocol", {version: 2})\n    Bridge->>Frontend: "bridgeProtocol" event\n    Frontend->>Frontend: Check compatibility\n    alt Versions compatible\n        Frontend->>Backend: Continue normal operation\n    else Backend newer\n        Frontend->>Frontend: Display upgrade prompt\n    else Frontend newer\n        Frontend->>Frontend: Display downgrade prompt\n    end\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/bridge.js:36-73]()\n- [packages/react-devtools-shared/src/devtools/store.js:273-320]()\n\nThe `BRIDGE_PROTOCOL` array defines version history with NPM version ranges:\n\n```javascript\n// Protocol version 2 added StrictMode support\n{\n  version: 2,\n  minNpmVersion: \'4.22.0\',\n  maxNpmVersion: null,\n}\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/bridge.js:47-70]()\n\n### Message Passing\n\nThe bridge is built on two abstractions:\n- **EventEmitter**: For typed event handling with `addListener()` / `emit()`\n- **Wall**: For low-level message transport with `send()` / `listen()`\n\n```mermaid\ngraph LR\n    subgraph "Backend Context"\n        BackendCode["Backend Code"]\n        BackendBridge["BackendBridge<br/>extends EventEmitter"]\n        BackendWall["Wall Implementation"]\n    end\n    \n    subgraph "Frontend Context"\n        FrontendWall["Wall Implementation"]\n        FrontendBridge["FrontendBridge<br/>extends EventEmitter"]\n        FrontendCode["Frontend Code"]\n    end\n    \n    BackendCode -->|"emit(\'operations\', data)"| BackendBridge\n    BackendBridge -->|"wall.send()"| BackendWall\n    BackendWall -.->|"postMessage/WebSocket/etc"| FrontendWall\n    FrontendWall -->|"wall.listen()"| FrontendBridge\n    FrontendBridge -->|"emit(\'operations\')"| FrontendCode\n    \n    FrontendCode -->|"emit(\'inspectElement\', params)"| FrontendBridge\n    FrontendBridge -->|"wall.send()"| FrontendWall\n    FrontendWall -.->|"postMessage/WebSocket/etc"| BackendWall\n    BackendWall -->|"wall.listen()"| BackendBridge\n    BackendBridge -->|"emit(\'inspectElement\')"| BackendCode\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/bridge.js:1-10]()\n- [packages/react-devtools-shared/src/backend/agent.js:307-356]()\n\n### Transport Implementations\n\nThe Wall abstraction enables different transport mechanisms for different environments:\n\n| Environment | Wall Implementation | Transport Mechanism |\n|-------------|---------------------|---------------------|\n| Browser Extension | `chrome.runtime.connect()` | Chrome extension messaging |\n| Standalone App | WebSocket | TCP socket over localhost |\n| Inline Embedding | `window.postMessage()` | Same-page iframe messaging |\n| React Native | WebSocket or Metro | RN debugging protocol |\n\n**Sources:**\n- [packages/react-devtools-extensions/chrome/manifest.json:1-65]()\n- [packages/react-devtools-core/package.json:1-38]()\n- [packages/react-devtools-inline/package.json:1-52]()\n\n---\n\n## Frontend Architecture\n\n### Store\n\nThe `Store` class is the single source of truth for the component tree state on the frontend. It processes operations from the backend and maintains several maps:\n\n```mermaid\ngraph TB\n    Store["Store"]\n    \n    subgraph "Core State"\n        idToElement["_idToElement<br/>Map<id, Element>"]\n        roots["_roots<br/>Array<rootID>"]\n        ownersMap["_ownersMap<br/>Map<id, Set<id>>"]\n        errorsAndWarnings["_errorsAndWarnings<br/>Map<id, {errorCount, warningCount}>"]\n    end\n    \n    subgraph "Suspense State"\n        idToSuspense["_idToSuspense<br/>Map<id, SuspenseNode>"]\n        rtree["_rtree<br/>RBush spatial index"]\n    end\n    \n    subgraph "Metadata"\n        rootIDToRendererID["_rootIDToRendererID<br/>Map<rootID, rendererID>"]\n        rootIDToCapabilities["_rootIDToCapabilities<br/>Map<rootID, Capabilities>"]\n    end\n    \n    Store --> idToElement\n    Store --> roots\n    Store --> ownersMap\n    Store --> errorsAndWarnings\n    Store --> idToSuspense\n    Store --> rtree\n    Store --> rootIDToRendererID\n    Store --> rootIDToCapabilities\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/store.js:143-272]()\n- [packages/react-devtools-shared/src/devtools/store.js:197-236]()\n\nThe Store processes operations in `onBridgeOperations()`:\n\n1. Parse string table from operations array\n2. Iterate through operations\n3. For each operation type (ADD, REMOVE, etc.), update internal maps\n4. Emit `mutated` event to trigger UI updates\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/store.js:1139-1784]()\n\n### Component State Serialization\n\nElement inspection uses a request-response pattern with **dehydration** and **hydration** to handle complex nested objects efficiently.\n\n**Serialization Pipeline:**\n\n```mermaid\ngraph TB\n    subgraph "Backend Serialization"\n        Fiber["Fiber Node"]\n        inspectElementRaw["inspectElementRaw(fiber)"]\n        getPropsForFiber["Get fiber.memoizedProps"]\n        getStateForFiber["Get fiber.memoizedState"]\n        getHooksForFiber["inspectHooksOfFiber()"]\n        dehydrate["dehydrate(data, path, cleaned)"]\n    end\n    \n    subgraph "Dehydrated Data Structure"\n        DehydratedData["{data: Array, cleaned: Array, unserializable: Array}"]\n        meta["Dehydrated objects: {inspectable, type, preview_short, preview_long}"]\n    end\n    \n    subgraph "Frontend Hydration"\n        InspectedElement["InspectedElement"]\n        hydrate["hydrate(data, cleaned, unserializable)"]\n        AddMetaSymbols["Add meta[Symbol] properties"]\n    end\n    \n    Fiber --> inspectElementRaw\n    inspectElementRaw --> getPropsForFiber\n    inspectElementRaw --> getStateForFiber\n    inspectElementRaw --> getHooksForFiber\n    getPropsForFiber --> dehydrate\n    getStateForFiber --> dehydrate\n    getHooksForFiber --> dehydrate\n    dehydrate --> DehydratedData\n    DehydratedData --> meta\n    \n    DehydratedData --> InspectedElement\n    InspectedElement --> hydrate\n    hydrate --> AddMetaSymbols\n```\n\n**Dehydration Process:**\n\nThe `dehydrate()` function recursively traverses objects and replaces complex values with `Dehydrated` metadata:\n\n| Value Type | Dehydration Strategy |\n|------------|---------------------|\n| Primitives (string, number, boolean) | Pass through unchanged |\n| Shallow objects (depth < 2) | Recursively dehydrate properties |\n| Deep objects (depth >= 2) | Replace with `{inspectable: true, type, preview_short, preview_long}` |\n| Arrays | Dehydrate each element |\n| React Elements | Replace with `{type: "react_element", preview}` |\n| Functions | Replace with `{type: "function", name}` |\n| Symbols | Replace with `{type: "symbol", name}` |\n| Unserializable (BigInt, ArrayBuffer) | Mark in `unserializable` array |\n\n**Sources:**\n- [packages/react-devtools-shared/src/hydration.js:200-350]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:2900-3100]()\n\n**Inspection Request-Response Flow:**\n\n```mermaid\nsequenceDiagram\n    participant UI as "UI Component"\n    participant Context as "InspectedElementContext"\n    participant Bridge\n    participant Agent\n    participant Backend as "fiber/renderer.js"\n    \n    UI->>Context: Read inspectedElement\n    Context->>Context: fetchElement(id, path)\n    Context->>Bridge: send("inspectElement", {id, path: null, requestID, rendererID})\n    Bridge->>Agent: emit("inspectElement", params)\n    Agent->>Backend: inspectElement(requestID, id, inspectedPaths, forceFullData)\n    \n    Backend->>Backend: Find DevToolsInstance by id\n    Backend->>Backend: inspectElementRaw(instance)\n    Backend->>Backend: Get props from fiber.memoizedProps\n    Backend->>Backend: Get state from fiber.memoizedState\n    Backend->>Backend: Call inspectHooksOfFiber(fiber, currentDispatcherRef)\n    Backend->>Backend: dehydrate(props, [], cleaned, unserializable)\n    Backend->>Backend: dehydrate(state, [], cleaned, unserializable)\n    Backend->>Backend: dehydrate(hooks, [], cleaned, unserializable)\n    \n    Backend->>Agent: Return InspectedElementPayload\n    Agent->>Bridge: send("inspectedElement", payload)\n    Bridge->>Context: emit("inspectedElement")\n    Context->>Context: hydrate(payload.value)\n    Context->>UI: Update inspected element\n    \n    Note over UI: User clicks to expand nested object\n    \n    UI->>Context: inspectPaths(["props", "user", "address"])\n    Context->>Bridge: send("inspectElement", {id, path: ["props","user","address"]})\n    Backend->>Backend: getInObject(fiber.memoizedProps, path)\n    Backend->>Backend: dehydrate(value at path)\n    Backend->>Agent: Return {type: "hydrated-path", path, value}\n    Agent->>Bridge: send("inspectedElement")\n    Context->>Context: fillInPath(data, path, value)\n```\n\n**Hooks Inspection:**\n\nThe backend uses `react-debug-tools` to inspect hooks:\n\n```javascript\n// In inspectElementRaw()\nimport {inspectHooksOfFiber} from \'react-debug-tools\';\n\nconst hooks = inspectHooksOfFiber(\n  fiber,\n  currentDispatcherRef, // ReactSharedInternals.H\n);\n```\n\nThis returns a `HooksTree` structure representing the hook call stack:\n\n```typescript\ntype HooksNode = {\n  id: number,\n  isStateEditable: boolean,\n  name: string,\n  value: mixed,\n  subHooks: Array<HooksNode>,\n  hookSource?: {\n    lineNumber: number,\n    columnNumber: number,\n    functionName: string,\n    fileName: string,\n  },\n};\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:2700-2900]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:98]()\n- [packages/react-debug-tools/src/ReactDebugHooks.js:1-500]()\n- [packages/react-devtools-shared/src/hydration.js:1-500]()\n- [packages/react-devtools-shared/src/backendAPI.js:50-200]()\n\n### UI Components\n\nThe frontend UI is organized into major panels:\n\n| Panel | Component | Purpose |\n|-------|-----------|---------|\n| Components | `Components.js` | Tree view + element inspector |\n| Profiler | `Profiler.js` | Commit timeline + flame graph |\n| Settings | `Settings/` | DevTools configuration |\n| Suspense | `SuspenseTab/` | Suspense boundary visualization (experimental) |\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/views/Components/]()\n- [packages/react-devtools-shared/src/devtools/views/Profiler/]()\n\nThe Components panel uses React Context for state management:\n\n```mermaid\ngraph TB\n    TreeContext["TreeContext<br/>(selected element, expansion state)"]\n    StoreContext["StoreContext<br/>(Store instance)"]\n    BridgeContext["BridgeContext<br/>(Bridge instance)"]\n    InspectedElementContext["InspectedElementContext<br/>(inspection cache)"]\n    \n    TreeContext --> Tree["Tree.js<br/>(virtualized tree)"]\n    StoreContext --> Tree\n    BridgeContext --> Tree\n    \n    TreeContext --> Inspector["InspectedElement.js<br/>(props/state/hooks)"]\n    InspectedElementContext --> Inspector\n    BridgeContext --> Inspector\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/views/Components/TreeContext.js]()\n- [packages/react-devtools-shared/src/devtools/views/Components/InspectedElementContext.js]()\n- [packages/react-devtools-shared/src/devtools/views/context.js]()\n\n### Profiling Hooks Integration\n\nThe DevTools backend injects profiling hooks into the React reconciler to collect performance data during renders.\n\n**Profiling Hooks Architecture:**\n\n```mermaid\ngraph TB\n    subgraph "DevTools Backend"\n        createProfilingHooks["createProfilingHooks()"]\n        ProfilingHooks["DevToolsProfilingHooks object"]\n    end\n    \n    subgraph "Profiling Hooks Methods"\n        markRenderScheduled["markRenderScheduled(lane)"]\n        markRenderStarted["markRenderStarted(lanes)"]\n        markComponentRenderStarted["markComponentRenderStarted(fiber)"]\n        markComponentRenderStopped["markComponentRenderStopped()"]\n        markCommitStarted["markCommitStarted(lanes)"]\n        markLayoutEffectsStarted["markLayoutEffectsStarted(lanes)"]\n        markPassiveEffectsStarted["markPassiveEffectsStarted(lanes)"]\n    end\n    \n    subgraph "React Reconciler"\n        Scheduler["Scheduler scheduleCallback()"]\n        WorkLoop["performConcurrentWorkOnRoot()"]\n        beginWork["beginWork(fiber)"]\n        completeWork["completeWork(fiber)"]\n        commitRoot["commitRoot()"]\n    end\n    \n    subgraph "Collected Data"\n        CommitData["CommitDataBackend: {duration, fiberActualDurations, fiberSelfDurations}"]\n        ProfilingData["ProfilingDataBackend: {dataForRoots, timelineData}"]\n    end\n    \n    createProfilingHooks --> ProfilingHooks\n    ProfilingHooks --> markRenderScheduled\n    ProfilingHooks --> markRenderStarted\n    ProfilingHooks --> markComponentRenderStarted\n    \n    Scheduler -->|calls| markRenderScheduled\n    WorkLoop -->|calls| markRenderStarted\n    beginWork -->|calls| markComponentRenderStarted\n    completeWork -->|calls| markComponentRenderStopped\n    commitRoot -->|calls| markCommitStarted\n    commitRoot -->|calls| markLayoutEffectsStarted\n    commitRoot -->|calls| markPassiveEffectsStarted\n    \n    markCommitStarted --> CommitData\n    CommitData --> ProfilingData\n```\n\n**Profiling Session Lifecycle:**\n\n```mermaid\nsequenceDiagram\n    participant Frontend\n    participant Bridge\n    participant Agent\n    participant Backend as "fiber/renderer.js"\n    participant Reconciler as "React Reconciler"\n    \n    Frontend->>Bridge: send("startProfiling", {recordChangeDescriptions, recordTimeline})\n    Bridge->>Agent: emit("startProfiling")\n    Agent->>Backend: startProfiling(recordChangeDescriptions, recordTimeline)\n    Backend->>Backend: Set isProfiling = true\n    Backend->>Backend: Clear profilingData, recordChangeDescriptions flag\n    Backend->>Reconciler: injectProfilingHooks(profilingHooks)\n    \n    Note over Reconciler: App renders and commits...\n    \n    Reconciler->>Backend: markRenderScheduled(lane)\n    Backend->>Backend: Track scheduled update\n    Reconciler->>Backend: markRenderStarted(lanes)\n    Backend->>Backend: currentCommitProfilingMetadata = {startTime}\n    Reconciler->>Backend: markComponentRenderStarted(fiber)\n    Backend->>Backend: Track fiber render start time\n    Reconciler->>Backend: markComponentRenderStopped()\n    Backend->>Backend: Calculate fiber actual duration\n    Reconciler->>Backend: markCommitStarted(lanes)\n    Backend->>Backend: Record commit start\n    Reconciler->>Backend: markCommitStopped()\n    Backend->>Backend: Build CommitDataBackend\n    Backend->>Backend: profilingData.dataForRoots[rootID].commitData.push(data)\n    \n    Note over Reconciler: Multiple commits may occur...\n    \n    Frontend->>Bridge: send("stopProfiling")\n    Bridge->>Agent: emit("stopProfiling")\n    Agent->>Backend: stopProfiling()\n    Backend->>Backend: Set isProfiling = false\n    Frontend->>Bridge: send("getProfilingData", {rendererID})\n    Bridge->>Agent: emit("getProfilingData")\n    Agent->>Backend: getProfilingData()\n    Backend->>Backend: Serialize profilingData\n    Backend->>Agent: Return ProfilingDataBackend\n    Agent->>Bridge: send("profilingData", data)\n    Bridge->>Frontend: emit("profilingData")\n```\n\n**Collected Profiling Metrics:**\n\n| Metric | Source | Purpose |\n|--------|--------|---------|\n| `fiberActualDurations` | `markComponentRenderStarted/Stopped()` | Time spent rendering each fiber |\n| `fiberSelfDurations` | Calculated from actual - children | Time excluding child renders |\n| `effectDuration` | `markLayoutEffectsStarted/Stopped()` | Time in useLayoutEffect/useEffect |\n| `passiveEffectDuration` | `markPassiveEffectsStarted/Stopped()` | Time in passive effects only |\n| `priorityLevel` | From scheduler priority | Render priority (UserBlocking, Normal, etc.) |\n| `changeDescriptions` | `recordProfilingDurations()` | Which props/state changed |\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/profilingHooks.js:1-500]()\n- [packages/react-devtools-shared/src/backend/types.js:500-538]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1105-1300]()\n- [packages/react-devtools-shared/src/devtools/ProfilerStore.js:1-200]()\n\n---\n\n## Distribution Channels\n\nReact DevTools is distributed through multiple channels, each with a different architecture:\n\n### Browser Extensions\n\nBrowser extensions use Manifest V3 with a service worker backend:\n\n```mermaid\ngraph TB\n    subgraph "Extension Components"\n        Background["background.js<br/>Service Worker"]\n        ContentScript["prepareInjection.js<br/>Content Script"]\n        DevToolsPage["main.html<br/>DevTools Page"]\n        Panel["panel.html<br/>DevTools Panel"]\n    end\n    \n    subgraph "Injection"\n        Hook["installHook.js<br/>Injected to page"]\n        Backend["backend.js<br/>Injected to page"]\n    end\n    \n    subgraph "Page Context"\n        App["React Application"]\n    end\n    \n    ContentScript -->|"injectScript()"| Hook\n    Hook --> App\n    Background -->|"chrome.scripting.executeScript"| Backend\n    Backend --> App\n    \n    DevToolsPage -->|"chrome.devtools.panels.create"| Panel\n    Panel <-->|"chrome.runtime.connect"| Background\n    Background <-->|"chrome.tabs.sendMessage"| Backend\n```\n\n**Sources:**\n- [packages/react-devtools-extensions/chrome/manifest.json:40-64]()\n- [packages/react-devtools-extensions/firefox/manifest.json:45-69]()\n\nExtension-specific features:\n- Icon changes color based on React build type (dev/prod)\n- Popup warns if React is not detected\n- Integration with browser Elements panel for DOM node selection\n\n**Sources:**\n- [packages/react-devtools-extensions/chrome/manifest.json:14-22]()\n\n### Standalone Application\n\nThe standalone app is an Electron application that starts a local WebSocket server:\n\n```mermaid\ngraph LR\n    subgraph "Electron App"\n        Main["Main Process<br/>bin.js"]\n        Renderer["Renderer Process<br/>app.html"]\n    end\n    \n    subgraph "Local Server"\n        HTTPServer["HTTP Server<br/>(serves hook script)"]\n        WSServer["WebSocket Server<br/>(bridge transport)"]\n    end\n    \n    subgraph "Browser/App"\n        Page["User\'s Application"]\n        BackendScript["<script> from localhost"]\n    end\n    \n    Main --> HTTPServer\n    Main --> WSServer\n    Main --> Renderer\n    \n    Page -->|"GET http://localhost:8097"| HTTPServer\n    HTTPServer -->|"installHook + backend"| BackendScript\n    BackendScript <-->|"WebSocket"| WSServer\n    WSServer <-->|"IPC"| Renderer\n```\n\n**Sources:**\n- [packages/react-devtools/package.json:11-23]()\n- [packages/react-devtools-core/package.json:1-38]()\n\nThe user adds a script tag to their page:\n\n```html\n<script src="http://localhost:8097"></script>\n```\n\nThis loads the hook and backend, which connect back via WebSocket.\n\n**Sources:**\n- [packages/react-devtools-core/]()\n\n### Inline Embedding\n\nThe inline package allows embedding DevTools directly in a web page:\n\n```javascript\nimport {initialize} from \'react-devtools-inline/frontend\';\nimport {activate} from \'react-devtools-inline/backend\';\n\n// In application context\nactivate(window);\n\n// In DevTools UI context\nconst DevTools = initialize(window);\n```\n\nThis is used for demos, playgrounds, and React Native debugging.\n\n**Sources:**\n- [packages/react-devtools-inline/package.json:12-17]()\n\n### React Native Integration\n\nReact Native embeds the DevTools backend and connects via Metro bundler\'s WebSocket connection or custom RN debugging bridge.\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/views/Highlighter/index.js:1-20]()\n\n---\n\n## Data Flow Examples\n\n### Component Tree Update\n\nWhen a component updates, the following flow occurs:\n\n```mermaid\nsequenceDiagram\n    participant React as "React Reconciler"\n    participant Backend as "Backend Renderer"\n    participant Agent\n    participant Bridge\n    participant Store\n    participant UI\n    \n    React->>Backend: commitMutationEffects()\n    Backend->>Backend: updateFiberRecursively()\n    Backend->>Backend: recordMount(fiber) or recordUnmount(fiber)\n    Backend->>Backend: Build operations array\n    Backend->>Agent: flushPendingEvents()\n    Agent->>Bridge: send("operations", operations)\n    Bridge->>Store: emit("operations", operations)\n    Store->>Store: onBridgeOperations()\n    Store->>Store: Update _idToElement, _roots, etc.\n    Store->>Store: emit("mutated", changes)\n    UI->>UI: Re-render tree view\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1426-1600]()\n- [packages/react-devtools-shared/src/backend/agent.js:567-700]()\n- [packages/react-devtools-shared/src/devtools/store.js:1139-1784]()\n\n### Element Inspection Data Flow\n\nWhen a user inspects an element, the full flow spans from the UI click to backend serialization:\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant Tree as "Tree.js"\n    participant TreeContext\n    participant InspectedElementContext\n    participant Bridge\n    participant Agent\n    participant RendererInterface as "fiber/renderer.js"\n    \n    User->>Tree: Click element in tree\n    Tree->>TreeContext: selectElementByID(id)\n    TreeContext->>TreeContext: Set selectedElementID state\n    InspectedElementContext->>InspectedElementContext: useEffect detects selectedElementID change\n    InspectedElementContext->>InspectedElementContext: fetchElement(id, null)\n    InspectedElementContext->>Bridge: send("inspectElement", {id, path: null, requestID, rendererID, forceFullData})\n    Bridge->>Agent: emit("inspectElement", params)\n    Agent->>Agent: Look up rendererInterface by rendererID\n    Agent->>RendererInterface: inspectElement(requestID, id, inspectedPaths, forceFullData)\n    \n    RendererInterface->>RendererInterface: idToDevToolsInstanceMap.get(id)\n    RendererInterface->>RendererInterface: inspectElementRaw(instance, path, forceFullData)\n    RendererInterface->>RendererInterface: Extract fiber.memoizedProps\n    RendererInterface->>RendererInterface: Extract fiber.memoizedState\n    RendererInterface->>RendererInterface: inspectHooksOfFiber(fiber, currentDispatcherRef)\n    RendererInterface->>RendererInterface: dehydrate(props, state, hooks)\n    RendererInterface->>RendererInterface: Build InspectedElement payload\n    RendererInterface->>Agent: Return {type: "full-data", value: InspectedElement}\n    \n    Agent->>Bridge: send("inspectedElement", payload)\n    Bridge->>InspectedElementContext: emit("inspectedElement", payload)\n    InspectedElementContext->>InspectedElementContext: hydrate(payload.value)\n    InspectedElementContext->>Tree: Render updated inspector panel\n    Tree->>User: Display props, state, hooks\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/views/Components/Tree.js:1-500]()\n- [packages/react-devtools-shared/src/devtools/views/Components/TreeContext.js:1-300]()\n- [packages/react-devtools-shared/src/devtools/views/Components/InspectedElementContext.js:1-400]()\n- [packages/react-devtools-shared/src/backend/agent.js:320-330]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:2700-3200]()\n- [packages/react-devtools-shared/src/backendAPI.js:50-200]()\n\n---\n\n## Key Design Decisions\n\n### Why Three-Tier Architecture?\n\nThe separation of backend, bridge, and frontend enables:\n- **Security isolation**: DevTools UI runs in a different context with different privileges\n- **Version independence**: Protocol versioning allows newer backends with older frontends\n- **Multiple transport layers**: Same code works across extensions, standalone, inline, and React Native\n\n### Why Operations Arrays?\n\nCompact numeric arrays minimize serialization overhead:\n- Strings are deduplicated via string table\n- Tree changes encoded as integers\n- No JSON parsing overhead\n- Works well with `postMessage()` structured clone algorithm\n\n**Sources:**\n- [packages/react-devtools-shared/src/utils.js:224-464]()\n\n### Why Dehydration?\n\nLazy loading of nested data:\n- Initial inspection sends shallow representation\n- Deeply nested objects represented as `{inspectable: true}`\n- User expansion triggers path-specific fetch\n- Reduces initial payload size for large component trees\n\n**Sources:**\n- [packages/react-devtools-shared/src/hydration.js:65-250]()\n\n### Why WeakMap for Fiber Tracking?\n\nUsing WeakMaps for `internalInstanceToIDMap` prevents memory leaks:\n- Fibers can be garbage collected without explicit cleanup\n- DevTools doesn\'t hold strong references to unmounted components\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:864-873]()\n\n---\n\n# Page: DevTools Distribution and Integration\n\n# DevTools Distribution and Integration\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [fixtures/devtools/standalone/index.html](fixtures/devtools/standalone/index.html)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-devtools-core/README.md](packages/react-devtools-core/README.md)\n- [packages/react-devtools-core/src/backend.js](packages/react-devtools-core/src/backend.js)\n- [packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js](packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js)\n- [packages/react-devtools-extensions/src/contentScripts/installHook.js](packages/react-devtools-extensions/src/contentScripts/installHook.js)\n- [packages/react-devtools-extensions/src/contentScripts/messages.js](packages/react-devtools-extensions/src/contentScripts/messages.js)\n- [packages/react-devtools-inline/src/backend.js](packages/react-devtools-inline/src/backend.js)\n- [packages/react-devtools-shared/src/__tests__/componentStacks-test.js](packages/react-devtools-shared/src/__tests__/componentStacks-test.js)\n- [packages/react-devtools-shared/src/__tests__/console-test.js](packages/react-devtools-shared/src/__tests__/console-test.js)\n- [packages/react-devtools-shared/src/__tests__/inspectedElement-test.js](packages/react-devtools-shared/src/__tests__/inspectedElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js](packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/setupTests.js](packages/react-devtools-shared/src/__tests__/setupTests.js)\n- [packages/react-devtools-shared/src/__tests__/store-test.js](packages/react-devtools-shared/src/__tests__/store-test.js)\n- [packages/react-devtools-shared/src/attachRenderer.js](packages/react-devtools-shared/src/attachRenderer.js)\n- [packages/react-devtools-shared/src/backend/agent.js](packages/react-devtools-shared/src/backend/agent.js)\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js](packages/react-devtools-shared/src/backend/fiber/renderer.js)\n- [packages/react-devtools-shared/src/backend/legacy/renderer.js](packages/react-devtools-shared/src/backend/legacy/renderer.js)\n- [packages/react-devtools-shared/src/backend/types.js](packages/react-devtools-shared/src/backend/types.js)\n- [packages/react-devtools-shared/src/backend/views/Highlighter/index.js](packages/react-devtools-shared/src/backend/views/Highlighter/index.js)\n- [packages/react-devtools-shared/src/backendAPI.js](packages/react-devtools-shared/src/backendAPI.js)\n- [packages/react-devtools-shared/src/bridge.js](packages/react-devtools-shared/src/bridge.js)\n- [packages/react-devtools-shared/src/devtools/store.js](packages/react-devtools-shared/src/devtools/store.js)\n- [packages/react-devtools-shared/src/devtools/utils.js](packages/react-devtools-shared/src/devtools/utils.js)\n- [packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js](packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js)\n- [packages/react-devtools-shared/src/devtools/views/utils.js](packages/react-devtools-shared/src/devtools/views/utils.js)\n- [packages/react-devtools-shared/src/frontend/types.js](packages/react-devtools-shared/src/frontend/types.js)\n- [packages/react-devtools-shared/src/hook.js](packages/react-devtools-shared/src/hook.js)\n- [packages/react-devtools-shared/src/hydration.js](packages/react-devtools-shared/src/hydration.js)\n- [packages/react-devtools-shared/src/utils.js](packages/react-devtools-shared/src/utils.js)\n- [packages/react-devtools-shell/src/app/ElementTypes/index.js](packages/react-devtools-shell/src/app/ElementTypes/index.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js](packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js](packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js](packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/react/src/ReactForwardRef.js](packages/react/src/ReactForwardRef.js)\n- [packages/react/src/ReactMemo.js](packages/react/src/ReactMemo.js)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes how React DevTools is packaged and distributed across different platforms, and how each distribution integrates with React applications. DevTools exists in multiple formsbrowser extensions, a standalone Electron application, and an embeddable inline libraryall sharing a common backend but using different integration strategies.\n\nFor information about the DevTools architecture and communication protocol between frontend and backend, see [React DevTools Architecture](#7.1).\n\n## Distribution Packages Overview\n\nReact DevTools is published as four distinct npm packages, each serving different use cases:\n\n| Package | Purpose | Primary Use Case |\n|---------|---------|------------------|\n| `react-devtools` | Standalone Electron app | Debugging React Native apps |\n| `react-devtools-core` | Backend and standalone server | Custom integrations, React Native |\n| `react-devtools-inline` | Embeddable frontend + backend | Integrated developer tools in web apps |\n| `react-devtools-extensions` | Browser extensions | Debugging web apps in Chrome, Firefox, Edge |\n\nEach package shares the `react-devtools-shared` codebase but bundles it differently for its target environment.\n\n**Diagram: Distribution Package Architecture**\n\n```mermaid\ngraph TB\n    Shared["react-devtools-shared<br/>(Core functionality)"]\n    \n    subgraph "Distribution Packages"\n        Standalone["react-devtools<br/>Electron app<br/>bin.js, app.js"]\n        Core["react-devtools-core<br/>Backend + Server<br/>backend.js, standalone.js"]\n        Inline["react-devtools-inline<br/>Embeddable<br/>backend.js, frontend.js"]\n        Extensions["react-devtools-extensions<br/>Browser Extensions<br/>Chrome, Firefox, Edge"]\n    end\n    \n    Shared -->|"bundles into"| Standalone\n    Shared -->|"bundles into"| Core\n    Shared -->|"bundles into"| Inline\n    Shared -->|"bundles into"| Extensions\n    \n    subgraph "Build Process"\n        Webpack["Webpack Configurations<br/>webpack.backend.js<br/>webpack.standalone.js<br/>webpack.config.js"]\n    end\n    \n    Webpack -->|"builds"| Standalone\n    Webpack -->|"builds"| Core\n    Webpack -->|"builds"| Inline\n    Webpack -->|"builds"| Extensions\n    \n    subgraph "Target Environments"\n        RN["React Native Apps"]\n        Web["Web Applications"]\n        Browser["Browser DevTools Panel"]\n    end\n    \n    Standalone -->|"connects to"| RN\n    Core -->|"integrates with"| RN\n    Inline -->|"embeds in"| Web\n    Extensions -->|"runs in"| Browser\n```\n\nSources: [packages/react-devtools/package.json:1-32](), [packages/react-devtools-core/package.json:1-38](), [packages/react-devtools-inline/package.json:1-52]()\n\n## Bridge Protocol and Version Compatibility\n\nAll DevTools distributions communicate using a versioned bridge protocol defined in `BRIDGE_PROTOCOL`. This enables graceful handling of version mismatches between frontend and backend.\n\n**Protocol Version Management**\n\nThe bridge protocol uses semantic versioning to track breaking changes:\n\n```mermaid\ngraph LR\n    Frontend["Frontend<br/>(DevTools UI)"]\n    Backend["Backend<br/>(Injected in app)"]\n    Bridge["Bridge Protocol<br/>currentBridgeProtocol"]\n    \n    Frontend -->|"sends/receives messages"| Bridge\n    Backend -->|"sends/receives messages"| Bridge\n    \n    subgraph "Version Checking"\n        V0["Version 0<br/>< 4.11.0"]\n        V1["Version 1<br/>4.13.0 - 4.21.0"]\n        V2["Version 2<br/>4.22.0+<br/>(current)"]\n    end\n    \n    Bridge -->|"version history"| V0\n    Bridge -->|"version history"| V1\n    Bridge -->|"version history"| V2\n    \n    subgraph "Compatibility Checks"\n        UpgradePrompt["Upgrade Prompt<br/>(newer backend)"]\n        DowngradePrompt["Downgrade Prompt<br/>(newer frontend)"]\n    end\n    \n    Frontend -->|"if mismatch"| UpgradePrompt\n    Frontend -->|"if mismatch"| DowngradePrompt\n```\n\nThe protocol version is checked during initialization. Each version includes:\n- `version`: Protocol version number\n- `minNpmVersion`: Minimum compatible npm package version\n- `maxNpmVersion`: Maximum compatible npm package version\n\nWhen incompatibility is detected, the Store sets `_unsupportedBridgeProtocolDetected` and the UI displays an appropriate message.\n\nSources: [packages/react-devtools-shared/src/bridge.js:26-73](), [packages/react-devtools-shared/src/devtools/store.js:254-256]()\n\n## Browser Extensions\n\nBrowser extensions for Chrome, Firefox, and Edge follow Manifest V3 specifications and share most code while adapting to browser-specific APIs.\n\n**Extension Architecture**\n\n```mermaid\ngraph TB\n    subgraph "Extension Components"\n        Background["Background Service Worker<br/>build/background.js"]\n        ContentScript["Content Script<br/>build/prepareInjection.js<br/>(runs at document_start)"]\n        DevToolsPage["DevTools Page<br/>main.html"]\n        Panel["DevTools Panel<br/>panel.html"]\n        Popup["Action Popup<br/>popups/disabled.html"]\n    end\n    \n    subgraph "Injection Process"\n        Hook["Global Hook Script<br/>installHook()"]\n        Backend["Backend Renderer<br/>renderer.js"]\n    end\n    \n    subgraph "Target Page"\n        ReactApp["React Application<br/>window.__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n    end\n    \n    ContentScript -->|"injects"| Hook\n    Hook -->|"installed on"| ReactApp\n    Backend -->|"connects to"| ReactApp\n    \n    Background -->|"manages"| ContentScript\n    DevToolsPage -->|"creates"| Panel\n    Panel -->|"loads"| Backend\n    \n    Panel <-->|"Bridge messages"| Backend\n```\n\n**Manifest Structure**\n\nEach browser has a slightly different manifest configuration:\n\n| Property | Chrome/Edge | Firefox | Purpose |\n|----------|-------------|---------|---------|\n| `manifest_version` | 3 | 3 | Manifest V3 for all browsers |\n| `background` | `service_worker` | `scripts` | Background script execution model |\n| `permissions` | tabs, storage, scripting | tabs, storage, scripting, clipboardWrite | Required permissions |\n| `optional_permissions` | clipboardWrite | - | User-granted permissions |\n| `browser_specific_settings` | - | gecko.id, strict_min_version | Firefox-specific metadata |\n\n**Content Script Injection**\n\nThe extension injects `prepareInjection.js` at `document_start` to ensure the global hook is available before React loads:\n\n1. Content script runs immediately when page loads\n2. Injects the global hook into the page context\n3. The hook intercepts React renderer registrations\n4. When DevTools panel opens, backend connects to hook\n\nSources: [packages/react-devtools-extensions/chrome/manifest.json:1-65](), [packages/react-devtools-extensions/firefox/manifest.json:1-70](), [packages/react-devtools-extensions/edge/manifest.json:1-65]()\n\n## Standalone Electron Application\n\nThe `react-devtools` package provides a standalone Electron application for debugging React Native applications.\n\n**Package Structure**\n\n```mermaid\ngraph TB\n    subgraph "react-devtools Package"\n        Bin["bin.js<br/>(CLI entry point)"]\n        App["app.js<br/>(Main process)"]\n        AppHTML["app.html<br/>(Renderer process)"]\n        Preload["preload.js<br/>(Preload script)"]\n    end\n    \n    subgraph "Dependencies"\n        Electron["electron ^23.1.2"]\n        Core["react-devtools-core"]\n        InternalIP["internal-ip<br/>(Network detection)"]\n        UpdateNotifier["update-notifier<br/>(Version checks)"]\n    end\n    \n    Bin -->|"spawns"| Electron\n    Electron -->|"loads"| App\n    App -->|"creates window with"| AppHTML\n    App -->|"configures"| Preload\n    \n    Core -->|"provides backend"| App\n    InternalIP -->|"detects IP for"| App\n    UpdateNotifier -->|"checks version"| Bin\n    \n    subgraph "Connection Modes"\n        WebSocket["WebSocket Server<br/>(Default port 8097)"]\n        ReactNative["React Native App<br/>connects via ws://"]\n    end\n    \n    Core -->|"starts"| WebSocket\n    ReactNative -->|"connects to"| WebSocket\n```\n\n**Startup Flow**\n\nWhen running `react-devtools` from the command line:\n\n1. `bin.js` checks for updates via `update-notifier`\n2. Spawns Electron with `app.js` as entry point\n3. `app.js` starts a WebSocket server using `react-devtools-core`\n4. Creates Electron window loading `app.html`\n5. React Native app connects to WebSocket server\n6. Frontend and backend communicate over WebSocket bridge\n\n**Command-Line Options**\n\nThe standalone app supports these options:\n- `--port`: WebSocket server port (default: 8097)\n- `--host`: Host to bind to (default: localhost)\n- `--https`: Use HTTPS for secure connections\n- `--react-devtools-port`: Alternative port specification\n\nSources: [packages/react-devtools/package.json:1-32](), [packages/react-devtools-core/package.json:1-38]()\n\n## Inline Embeddable Library\n\nThe `react-devtools-inline` package enables embedding DevTools directly into web applications, useful for development environments and internal tools.\n\n**Package Exports**\n\n```mermaid\ngraph LR\n    subgraph "react-devtools-inline Exports"\n        Backend["backend.js<br/>(Backend bundle)"]\n        Frontend["frontend.js<br/>(Frontend UI bundle)"]\n        HookNames["hookNames.js<br/>(Hook name resolution)"]\n    end\n    \n    subgraph "Build Artifacts"\n        BackendBundle["dist/backend.js<br/>(Webpack bundle)"]\n        FrontendBundle["dist/frontend.js<br/>(Webpack bundle)"]\n    end\n    \n    Backend -->|"exports from"| BackendBundle\n    Frontend -->|"exports from"| FrontendBundle\n    \n    subgraph "Usage Pattern"\n        InitBackend["initialize(contentWindow,<br/>{ bridge, store })"]\n        CreateFrontend["createRoot(container).render(<br/>DevTools bridge={bridge} store={store} />)"]\n    end\n    \n    Backend -->|"provides"| InitBackend\n    Frontend -->|"provides"| CreateFrontend\n    \n    subgraph "Communication"\n        Wall["Wall<br/>(Message passing abstraction)"]\n        BridgeInline["FrontendBridge + BackendBridge"]\n    end\n    \n    InitBackend -->|"uses"| Wall\n    CreateFrontend -->|"uses"| Wall\n    Wall -->|"implements"| BridgeInline\n```\n\n**Integration Example**\n\nTo embed DevTools inline:\n\n```javascript\n// Backend initialization (in target iframe/window)\nimport {initialize as initBackend} from \'react-devtools-inline/backend\';\n\n// Frontend rendering (in host page)\nimport {initialize as initFrontend} from \'react-devtools-inline/frontend\';\nimport {createRoot} from \'react-dom/client\';\n\n// Create bridges\nconst wall = {\n  listen(listener) { /* handle messages */ },\n  send(event, payload) { /* send messages */ }\n};\n\n// Initialize backend in target window\ninitBackend(targetWindow, { wall });\n\n// Render frontend\nconst {bridge, store} = initFrontend(wall);\nconst container = document.getElementById(\'devtools\');\ncreateRoot(container).render(<DevTools bridge={bridge} store={store} />);\n```\n\nThe inline library bundles all shared code into self-contained artifacts that can be loaded independently.\n\nSources: [packages/react-devtools-inline/package.json:1-52]()\n\n## Core Library for Custom Integrations\n\nThe `react-devtools-core` package provides the backend and a standalone server for custom DevTools integrations, primarily used by React Native.\n\n**Package Exports and Build Targets**\n\n```mermaid\ngraph TB\n    subgraph "react-devtools-core"\n        MainExport["main: ./dist/backend.js"]\n        BackendJS["backend.js"]\n        StandaloneJS["standalone.js"]\n    end\n    \n    subgraph "Build Scripts"\n        BuildBackend["build:backend<br/>webpack.backend.js"]\n        BuildBackendFB["build:backend:fb<br/>FEATURE_FLAG_TARGET=core/backend-fb"]\n        BuildStandalone["build:standalone<br/>webpack.standalone.js"]\n        BuildStandaloneFB["build:standalone:fb<br/>FEATURE_FLAG_TARGET=core/standalone-fb"]\n    end\n    \n    BuildBackend -->|"produces"| BackendJS\n    BuildBackendFB -->|"produces"| BackendJS\n    BuildStandalone -->|"produces"| StandaloneJS\n    BuildStandaloneFB -->|"produces"| StandaloneJS\n    \n    subgraph "Feature Flag Targeting"\n        CoreBackend["Core Backend<br/>(OSS)"]\n        CoreBackendFB["Core Backend FB<br/>(Internal)"]\n        CoreStandalone["Core Standalone<br/>(OSS)"]\n        CoreStandaloneFB["Core Standalone FB<br/>(Internal)"]\n    end\n    \n    BuildBackend -->|"targets"| CoreBackend\n    BuildBackendFB -->|"targets"| CoreBackendFB\n    BuildStandalone -->|"targets"| CoreStandalone\n    BuildStandaloneFB -->|"targets"| CoreStandaloneFB\n    \n    subgraph "Dependencies"\n        WS["ws ^7<br/>(WebSocket)"]\n        ShellQuote["shell-quote ^1.6.1<br/>(Command parsing)"]\n    end\n    \n    StandaloneJS -->|"uses"| WS\n    StandaloneJS -->|"uses"| ShellQuote\n```\n\n**Integration Modes**\n\nThe core library supports two integration modes:\n\n1. **Backend-only**: Import `backend.js` to inject the backend into a custom environment\n2. **Standalone server**: Import `standalone.js` to start a WebSocket server for remote connections\n\n**WebSocket Server API**\n\nThe standalone server exposes these methods:\n\n```javascript\nimport {initialize} from \'react-devtools-core/standalone\';\n\nconst server = await initialize({\n  port: 8097,\n  host: \'localhost\',\n  httpsOptions: null, // Optional TLS config\n  onDisconnect: () => { /* cleanup */ },\n  onError: (error) => { /* error handling */ }\n});\n\n// Server provides:\n// - server.close() - Stop the server\n// - server.port - Actual port (useful for port 0)\n```\n\nReact Native integrates by connecting to this WebSocket server during development.\n\nSources: [packages/react-devtools-core/package.json:1-38]()\n\n## Backend Injection Mechanisms\n\nThe DevTools backend must be injected into the target application before React loads. Different distributions use different injection strategies.\n\n**Injection Strategies by Distribution**\n\n```mermaid\ngraph TB\n    subgraph "Browser Extensions"\n        ExtContentScript["Content Script<br/>document_start"]\n        ExtInject["Script Injection<br/>(inline script tag)"]\n        ExtHook["Global Hook Installation<br/>window.__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        \n        ExtContentScript -->|"injects"| ExtInject\n        ExtInject -->|"installs"| ExtHook\n    end\n    \n    subgraph "Standalone/Core"\n        WSServer["WebSocket Server"]\n        RNClient["React Native Client<br/>setupDevtools()"]\n        RNHook["Native Hook<br/>(RN DevTools integration)"]\n        \n        WSServer -->|"awaits connection"| RNClient\n        RNClient -->|"installs"| RNHook\n    end\n    \n    subgraph "Inline"\n        InlineInit["initialize(window)"]\n        InlineHook["Direct Hook Install<br/>(same context)"]\n        \n        InlineInit -->|"installs"| InlineHook\n    end\n    \n    subgraph "React Application"\n        ReactRenderer["React Renderer<br/>reconcilerVersion"]\n        RendererDetection["Renderer Detection<br/>hook.renderers.set(id, renderer)"]\n        BackendBridge["BackendBridge<br/>operations, events"]\n        \n        ExtHook -->|"detects"| ReactRenderer\n        RNHook -->|"detects"| ReactRenderer\n        InlineHook -->|"detects"| ReactRenderer\n        \n        ReactRenderer -->|"registers with"| RendererDetection\n        RendererDetection -->|"creates"| BackendBridge\n    end\n```\n\n**Global Hook Interface**\n\nAll injection mechanisms install a global hook with this interface:\n\n```javascript\nwindow.__REACT_DEVTOOLS_GLOBAL_HOOK__ = {\n  renderers: Map<RendererID, ReactRenderer>,\n  supportsFiber: true,\n  inject(renderer) { /* called by React */ },\n  onCommitFiberRoot(rendererID, root, priorityLevel) { /* fiber commits */ },\n  onCommitFiberUnmount(rendererID, fiber) { /* fiber unmounts */ },\n  // Backend connection\n  backends: Map<RendererID, RendererInterface>,\n  // Settings from DevTools\n  settings: DevToolsHookSettings\n}\n```\n\nThe hook must be installed synchronously before React loads to intercept renderer registration.\n\n**Backend Initialization Sequence**\n\n```mermaid\nsequenceDiagram\n    participant Hook as Global Hook\n    participant React as React Renderer\n    participant Backend as DevTools Backend\n    participant Agent as Agent\n    participant Bridge as Bridge\n    \n    Note over Hook: 1. Hook installed<br/>(before React loads)\n    \n    React->>Hook: inject(renderer)\n    Hook->>Hook: renderers.set(id, renderer)\n    \n    Note over Backend: 2. Backend connects<br/>(when DevTools opens)\n    \n    Backend->>Hook: Check hook.renderers\n    Backend->>Agent: Create Agent(bridge)\n    \n    loop For each renderer\n        Backend->>Backend: attach(renderer, rendererID)\n        Backend->>Agent: Add RendererInterface\n    end\n    \n    Agent->>Bridge: Send \'operations\' messages\n    Bridge->>Agent: Receive commands\n    \n    Note over React,Backend: 3. Ongoing communication\n    \n    React->>Hook: onCommitFiberRoot(id, root)\n    Hook->>Backend: Forward to backend\n    Backend->>Agent: Process commit\n    Agent->>Bridge: Send tree operations\n```\n\nThe backend uses `Agent` to coordinate multiple `RendererInterface` instances (one per React renderer) and communicate with the frontend via the `Bridge`.\n\nSources: [packages/react-devtools-shared/src/backend/fiber/renderer.js:1007-1014](), [packages/react-devtools-shared/src/backend/agent.js:1-694]()\n\n## Settings and Configuration\n\nDevTools settings can be configured in two places:\n\n1. **Hook Settings**: Injected before React loads via `window.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings`\n2. **Frontend Settings**: Stored in localStorage and synchronized via bridge\n\n**Settings Flow**\n\n```mermaid\ngraph TB\n    subgraph "Settings Sources"\n        HookSettings["Hook Settings<br/>window.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings"]\n        LocalStorage["localStorage<br/>React::DevTools::*"]\n        EnvVars["Environment Variables<br/>process.env.EDITOR_URL"]\n    end\n    \n    subgraph "Backend"\n        BackendInit["Backend Initialization<br/>reads hook.settings"]\n        BackendAgent["Agent<br/>_hookSettings"]\n    end\n    \n    subgraph "Frontend"\n        Store["Store<br/>componentFilters,<br/>collapseNodesByDefault"]\n        SettingsContext["SettingsContext<br/>UI preferences"]\n    end\n    \n    HookSettings -->|"read at init"| BackendInit\n    BackendInit -->|"stores in"| BackendAgent\n    BackendAgent -->|"sends \'hookSettings\'"| Store\n    \n    LocalStorage -->|"loads into"| Store\n    LocalStorage -->|"loads into"| SettingsContext\n    EnvVars -->|"default values"| SettingsContext\n    \n    Store -->|"persists to"| LocalStorage\n    SettingsContext -->|"persists to"| LocalStorage\n```\n\n**Configurable Settings**\n\nKey settings and their storage locations:\n\n| Setting | Storage | Default | Purpose |\n|---------|---------|---------|---------|\n| `componentFilters` | localStorage | `[{type: ElementType, isEnabled: true}]` | Component tree filtering |\n| `collapseNodesByDefault` | localStorage | `true` | Auto-collapse tree nodes |\n| `recordChangeDescriptions` | localStorage | `false` | Profile change descriptions |\n| `EDITOR_URL` | process.env | `\'vscode://file/{path}:{line}:{column}\'` | Open in editor URL pattern |\n| `appendComponentStack` | hook.settings | varies | Append stacks to console |\n| `breakOnConsoleErrors` | hook.settings | varies | Break on console.error |\n| `showInlineWarningsAndErrors` | hook.settings | varies | Display inline errors |\n| `hideConsoleLogsInStrictMode` | hook.settings | varies | Dim duplicate logs |\n\nSettings can be provided at backend initialization time:\n\n```javascript\nimport {installHook} from \'react-devtools-core/backend\';\n\ninstallHook(window, {\n  appendComponentStack: true,\n  breakOnConsoleErrors: false,\n  showInlineWarningsAndErrors: true,\n  hideConsoleLogsInStrictMode: true\n});\n```\n\nSources: [packages/react-devtools-shared/src/backend/types.js:519-534](), [packages/react-devtools-shared/src/devtools/store.js:273-320](), [packages/react-devtools-shared/src/devtools/views/Settings/SettingsContext.js:1-196]()\n\n## Distribution File Sizes and Dependencies\n\nEach distribution has different size constraints and dependency requirements:\n\n**Package Dependencies**\n\n| Package | Runtime Dependencies | Dev Dependencies | Key External Deps |\n|---------|---------------------|------------------|-------------------|\n| `react-devtools` | electron, react-devtools-core, internal-ip | - | Large (Electron app) |\n| `react-devtools-core` | ws, shell-quote | webpack, workerize-loader | Minimal |\n| `react-devtools-inline` | @jridgewell/sourcemap-codec, source-map-js | webpack, babel, playwright | Medium |\n| `react-devtools-extensions` | - | webpack, babel | None (bundled) |\n\n**Build Artifact Sizes** (approximate):\n\n- Browser extensions: ~1-2 MB bundled\n- Standalone app: ~100 MB (includes Electron)\n- Core backend: ~500 KB bundled\n- Inline library: ~1 MB (frontend + backend)\n\nExtensions must minimize bundle size as Chrome Web Store has size limits. The build process uses Closure Compiler for production builds to aggressively minify and tree-shake.\n\nSources: [packages/react-devtools/package.json:24-30](), [packages/react-devtools-core/package.json:27-37](), [packages/react-devtools-inline/package.json:24-51]()\n\n---\n\n# Page: ESLint Plugin for React Hooks\n\n# ESLint Plugin for React Hooks\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\nThe ESLint plugin for React Hooks (`eslint-plugin-react-hooks`) is a static analysis tool that enforces the Rules of Hooksthe constraints that govern how React Hooks must be called to ensure correct behavior. The plugin provides two primary rules: `rules-of-hooks` validates that Hooks are only called at the top level of React function components or custom Hooks, and `exhaustive-deps` ensures that effect dependencies are correctly declared.\n\nFor information about the Hooks system implementation itself, see [React Hooks System](#4.3). For DevTools integration with Hooks inspection, see [React DevTools Architecture](#7.1).\n\n---\n\n## Purpose and Scope\n\nThe plugin statically analyzes JavaScript and TypeScript code to detect violations of Hook calling conventions before runtime. It prevents common mistakes such as conditional Hook calls, Hook calls inside loops, or missing effect dependencies that would cause bugs or inconsistent behavior. The plugin integrates directly into the ESLint workflow and supports modern JavaScript syntax including JSX, TypeScript, and Flow.\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:1-68]()\n\n---\n\n## Package Structure and Distribution\n\n```mermaid\ngraph TB\n    subgraph "Package Distribution"\n        PackageJSON["eslint-plugin-react-hooks<br/>package.json"]\n        IndexJS["index.js<br/>Main entry point"]\n        IndexDTS["index.d.ts<br/>TypeScript definitions"]\n        CJSDir["cjs/<br/>Compiled CommonJS"]\n    end\n    \n    subgraph "Source Code (TypeScript)"\n        SrcDir["src/<br/>TypeScript source"]\n        RulesOfHooks["RulesOfHooks.ts<br/>Top-level call validation"]\n        ExhaustiveDeps["ExhaustiveDeps.ts<br/>Dependency validation"]\n    end\n    \n    subgraph "Build Process"\n        TSCompile["TypeScript Compiler"]\n        TSConfig["tsconfig.json"]\n    end\n    \n    subgraph "Dependencies"\n        BabelCore["@babel/core<br/>Parser infrastructure"]\n        BabelParser["@babel/parser<br/>JavaScript parsing"]\n        HermesParser["hermes-parser<br/>Alternative parser"]\n        Zod["zod<br/>Schema validation"]\n    end\n    \n    SrcDir --> TSCompile\n    TSConfig --> TSCompile\n    TSCompile --> CJSDir\n    CJSDir --> IndexJS\n    \n    RulesOfHooks -.part of.-> SrcDir\n    ExhaustiveDeps -.part of.-> SrcDir\n    \n    IndexJS --> PackageJSON\n    IndexDTS --> PackageJSON\n    \n    BabelCore -.required by.-> IndexJS\n    BabelParser -.required by.-> IndexJS\n    HermesParser -.required by.-> IndexJS\n    Zod -.required by.-> IndexJS\n```\n\n**Distribution Format**\n\nThe plugin is distributed as an npm package with the following structure:\n\n| File/Directory | Purpose |\n|----------------|---------|\n| `index.js` | Main entry point that exports the plugin configuration |\n| `index.d.ts` | TypeScript type definitions for IDE integration |\n| `cjs/` | Compiled CommonJS modules from TypeScript source |\n| `package.json` | Package metadata with peer dependency on ESLint 3.x-9.x |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:1-68]()\n\n---\n\n## Integration with React Repository\n\nThe React repository uses the plugin in two distinct ways:\n\n```mermaid\ngraph TB\n    subgraph "React Repository ESLint Setup"\n        RootESLint[".eslintrc.js<br/>Root configuration"]\n        \n        subgraph "Plugin Usage"\n            PublishedPlugin["eslint-plugin-react-hooks-published<br/>npm:eslint-plugin-react-hooks@^5.2.0"]\n            InternalPlugin["eslint-plugin-react-internal<br/>link:./scripts/eslint-rules"]\n        end\n        \n        subgraph "Applied To"\n            DevToolsCode["react-devtools*/**/*.js<br/>DevTools packages"]\n            PluginSource["packages/eslint-plugin-react-hooks/src/**/*<br/>Plugin\'s own TypeScript code"]\n        end\n    end\n    \n    subgraph "Rule Application"\n        RulesOfHooksRule["rules-of-hooks: ERROR<br/>Enforces Hook calling rules"]\n        TSESLintRules["@typescript-eslint rules<br/>For plugin source code"]\n    end\n    \n    RootESLint --> PublishedPlugin\n    RootESLint --> InternalPlugin\n    \n    PublishedPlugin --> DevToolsCode\n    RulesOfHooksRule --> DevToolsCode\n    \n    PluginSource --> TSESLintRules\n```\n\n**Configuration Override for DevTools**\n\nThe plugin is explicitly enabled for DevTools code to catch Hook violations:\n\n```javascript\n// .eslintrc.js lines 522-528\n{\n  files: [\'packages/react-devtools-*/**/*.js\'],\n  excludedFiles: \'**/__tests__/**/*.js\',\n  plugins: [\'eslint-plugin-react-hooks-published\'],\n  rules: {\n    \'react-hooks-published/rules-of-hooks\': ERROR,\n  },\n}\n```\n\n**Configuration Override for Plugin Source**\n\nThe plugin\'s own TypeScript source code has specialized linting configuration:\n\n```javascript\n// .eslintrc.js lines 530-548\n{\n  files: [\'packages/eslint-plugin-react-hooks/src/**/*\'],\n  extends: [\'plugin:@typescript-eslint/recommended\'],\n  parser: \'@typescript-eslint/parser\',\n  plugins: [\'@typescript-eslint\', \'eslint-plugin\'],\n  rules: {\n    \'@typescript-eslint/no-explicit-any\': OFF,\n    \'@typescript-eslint/no-non-null-assertion\': OFF,\n    \'@typescript-eslint/array-type\': [ERROR, {default: \'generic\'}],\n    \'es/no-optional-chaining\': OFF,\n    \'eslint-plugin/prefer-object-rule\': ERROR,\n    \'eslint-plugin/require-meta-fixable\': [ERROR, {catchNoFixerButFixableProperty: true}],\n    \'eslint-plugin/require-meta-has-suggestions\': ERROR,\n  },\n}\n```\n\n**Sources:** [.eslintrc.js:522-548](), [package.json:74-75]()\n\n---\n\n## Core Rules\n\nThe plugin exports two primary ESLint rules:\n\n### rules-of-hooks\n\nValidates that Hooks follow the calling conventions required for correct operation:\n\n| Validation | Description |\n|------------|-------------|\n| **Top-level only** | Hooks must not be called inside loops, conditions, or nested functions |\n| **React functions only** | Hooks must be called from React function components or custom Hooks |\n| **Consistent order** | The order of Hook calls must remain constant across renders |\n\n### exhaustive-deps\n\nEnsures that effect Hooks declare all dependencies correctly:\n\n| Validation | Description |\n|------------|-------------|\n| **Complete dependency list** | All reactive values used inside effects must be in the dependency array |\n| **No unnecessary dependencies** | Warns about dependencies that don\'t need to be in the array |\n| **Stable references** | Detects when dependencies change on every render |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:1-68]()\n\n---\n\n## Parser Support and AST Analysis\n\nThe plugin supports multiple JavaScript parsers to handle different syntax variants:\n\n```mermaid\ngraph LR\n    subgraph "Input Code"\n        JSX["JSX<br/>React components"]\n        TS["TypeScript<br/>Type annotations"]\n        Flow["Flow<br/>Type annotations"]\n        HermesCode["Hermes<br/>React Native syntax"]\n    end\n    \n    subgraph "Parser Selection"\n        BabelParser["@babel/parser<br/>Default JavaScript/JSX/TS"]\n        HermesParser["hermes-parser<br/>React Native specific"]\n        ESLintParser["ESLint configured parser<br/>From ESLint config"]\n    end\n    \n    subgraph "AST Processing"\n        ASTNodes["AST Node Types<br/>CallExpression, Identifier, etc."]\n        Visitors["ESLint Rule Visitors<br/>Traverse and analyze"]\n    end\n    \n    subgraph "Rule Logic"\n        CallSiteAnalysis["Hook Call Site Detection<br/>Find use* calls"]\n        ScopeAnalysis["Scope Analysis<br/>Determine function context"]\n        DependencyTracking["Dependency Tracking<br/>Track reactive values"]\n    end\n    \n    JSX --> BabelParser\n    TS --> BabelParser\n    Flow --> BabelParser\n    HermesCode --> HermesParser\n    \n    BabelParser --> ASTNodes\n    HermesParser --> ASTNodes\n    ESLintParser --> ASTNodes\n    \n    ASTNodes --> Visitors\n    Visitors --> CallSiteAnalysis\n    Visitors --> ScopeAnalysis\n    Visitors --> DependencyTracking\n```\n\n**Parser Dependencies**\n\n| Package | Version | Purpose |\n|---------|---------|---------|\n| `@babel/core` | ^7.24.4 | Core transformation infrastructure |\n| `@babel/parser` | ^7.24.4 | JavaScript/JSX/TypeScript parsing |\n| `hermes-parser` | ^0.25.1 | React Native and Flow syntax support |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:41-46]()\n\n---\n\n## Schema Validation with Zod\n\nThe plugin uses Zod for validating rule options and configurations:\n\n```mermaid\ngraph TB\n    subgraph "Rule Configuration Input"\n        UserConfig["User-provided ESLint config<br/>{rules: {...}}"]\n        RuleOptions["Rule-specific options<br/>Arrays or objects"]\n    end\n    \n    subgraph "Zod Schema Validation"\n        ZodSchema["Zod Schema Definitions<br/>Type-safe validation"]\n        ValidationError["zod-validation-error<br/>User-friendly error messages"]\n    end\n    \n    subgraph "Validated Output"\n        TypedOptions["Typed Rule Options<br/>Safe to use in rule logic"]\n        ErrorMessages["Validation Error Messages<br/>Displayed to user"]\n    end\n    \n    UserConfig --> RuleOptions\n    RuleOptions --> ZodSchema\n    ZodSchema --> TypedOptions\n    ZodSchema --> ValidationError\n    ValidationError --> ErrorMessages\n```\n\n**Validation Benefits**\n\n- **Type Safety**: Rule options are validated against schemas before use\n- **Clear Error Messages**: `zod-validation-error` converts Zod errors to readable ESLint diagnostics\n- **Runtime Guarantees**: Invalid configurations are caught early with helpful feedback\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:45-46]()\n\n---\n\n## Testing Infrastructure\n\n```mermaid\ngraph TB\n    subgraph "Test Organization"\n        TestDir["__tests__/<br/>Test files"]\n        RulesTests["RulesOfHooks.test.ts<br/>Hook calling rule tests"]\n        DepsTests["ExhaustiveDeps.test.ts<br/>Dependency rule tests"]\n    end\n    \n    subgraph "Test Framework"\n        Jest["Jest ^29.5.0<br/>Test runner"]\n        BabelCompiler["@babel/preset-typescript<br/>Compile tests"]\n    end\n    \n    subgraph "Test Utilities"\n        ESLintTester["ESLint RuleTester<br/>Rule testing API"]\n        ParserVariants["Multiple Parser Tests<br/>Babel, TypeScript ESLint, etc."]\n    end\n    \n    subgraph "Test Coverage"\n        ValidCases["Valid Code Examples<br/>Should not trigger errors"]\n        InvalidCases["Invalid Code Examples<br/>Should report violations"]\n        EdgeCases["Edge Cases<br/>Complex scenarios"]\n    end\n    \n    TestDir --> RulesTests\n    TestDir --> DepsTests\n    \n    RulesTests --> Jest\n    DepsTests --> Jest\n    \n    Jest --> BabelCompiler\n    Jest --> ESLintTester\n    \n    ESLintTester --> ParserVariants\n    ParserVariants --> ValidCases\n    ParserVariants --> InvalidCases\n    ParserVariants --> EdgeCases\n```\n\n**Test Execution**\n\nThe plugin\'s test suite is run with:\n\n```bash\n# packages/eslint-plugin-react-hooks/package.json lines 23-26\n"scripts": {\n  "build:compiler": "cd ../../compiler && yarn workspace babel-plugin-react-compiler build",\n  "test": "yarn build:compiler && jest",\n  "typecheck": "tsc --noEmit"\n}\n```\n\n**Parser Compatibility Testing**\n\nThe test suite validates behavior across multiple ESLint parser configurations:\n\n| Parser | Package | Use Case |\n|--------|---------|----------|\n| `babel-eslint` | ^10.0.3 | Legacy Babel parser |\n| `@typescript-eslint/parser` v2-v5 | Multiple versions | TypeScript files across ESLint versions |\n| `eslint` v7-v9 | Multiple versions | Compatibility with different ESLint versions |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:23-26,48-66]()\n\n---\n\n## Build and Compilation Process\n\n```mermaid\ngraph LR\n    subgraph "Source Files"\n        TSSource["src/**/*.ts<br/>TypeScript source"]\n        TSConfig["tsconfig.json<br/>TypeScript config"]\n    end\n    \n    subgraph "Compilation"\n        TypeScript["tsc<br/>TypeScript compiler"]\n        StrictConfig["@tsconfig/strictest<br/>Strict type checking"]\n    end\n    \n    subgraph "Output"\n        CJSOutput["cjs/<br/>CommonJS modules"]\n        DTS["*.d.ts<br/>Type definitions"]\n    end\n    \n    subgraph "Package Artifacts"\n        IndexJS["index.js<br/>Exports rules"]\n        IndexDTS["index.d.ts<br/>Type definitions"]\n    end\n    \n    TSSource --> TypeScript\n    TSConfig --> TypeScript\n    StrictConfig -.configures.-> TypeScript\n    \n    TypeScript --> CJSOutput\n    TypeScript --> DTS\n    \n    CJSOutput --> IndexJS\n    DTS --> IndexDTS\n```\n\n**TypeScript Configuration**\n\nThe plugin uses strict TypeScript settings for type safety:\n\n```typescript\n// Configured via @tsconfig/strictest\n{\n  "extends": "@tsconfig/strictest",\n  // Strict null checks, no implicit any, etc.\n}\n```\n\n**Compilation Command**\n\n```bash\n# TypeScript check without emitting\n"typecheck": "tsc --noEmit"\n```\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:26,52]()\n\n---\n\n## Version Compatibility and Peer Dependencies\n\n| Component | Version Range | Notes |\n|-----------|---------------|-------|\n| **Node.js** | >=18 | Minimum required version |\n| **ESLint** | ^3.0.0 \\|\\| ^4.0.0 \\|\\| ^5.0.0 \\|\\| ^6.0.0 \\|\\| ^7.0.0 \\|\\| ^8.0.0-0 \\|\\| ^9.0.0 | Supports all modern ESLint versions |\n| **Zod** | ^3.25.0 \\|\\| ^4.0.0 | Schema validation library |\n| **React** (indirect) | Any version with Hooks (16.8+) | Plugin works with any React version that supports Hooks |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:34-46]()\n\n---\n\n## Integration with Build System\n\nThe plugin is integrated into the React repository\'s build and validation workflow:\n\n```mermaid\ngraph TB\n    subgraph "Developer Workflow"\n        CodeChange["Developer modifies code"]\n        GitCommit["Git commit"]\n    end\n    \n    subgraph "Lint Stage"\n        ESLintRun["yarn lint<br/>node ./scripts/tasks/eslint.js"]\n        PluginExecution["ESLint runs react-hooks plugin"]\n    end\n    \n    subgraph "Build Stage"\n        BuildAll["yarn build<br/>node ./scripts/rollup/build-all-release-channels.js"]\n        BuildValidation["yarn lint-build<br/>node ./scripts/rollup/validate/index.js"]\n    end\n    \n    subgraph "Test Stage"\n        TestRun["yarn test<br/>node ./scripts/jest/jest-cli.js"]\n        PluginTests["yarn test in eslint-plugin-react-hooks"]\n    end\n    \n    CodeChange --> GitCommit\n    GitCommit --> ESLintRun\n    ESLintRun --> PluginExecution\n    \n    PluginExecution --> BuildAll\n    BuildAll --> BuildValidation\n    \n    BuildValidation --> TestRun\n    TestRun --> PluginTests\n```\n\n**Lint Command**\n\nThe repository\'s lint script applies ESLint (including the Hooks plugin) to all source files:\n\n```bash\n# package.json line 134\n"lint": "node ./scripts/tasks/eslint.js"\n```\n\n**Sources:** [package.json:134-135](), [.eslintrc.js:522-548]()\n\n---\n\n## Rule Enforcement in Different Environments\n\nThe plugin\'s rules are selectively applied based on the code environment:\n\n| Environment | Rule Application | Configuration |\n|-------------|------------------|---------------|\n| **DevTools packages** | `rules-of-hooks` enforced | [.eslintrc.js:522-528]() |\n| **Core React packages** | Not explicitly enabled in config | Developers expected to know Hook rules |\n| **Test files** | Excluded from `react-devtools-*` enforcement | `excludedFiles: \'**/__tests__/**/*.js\'` |\n| **Plugin source code** | TypeScript ESLint rules only | [.eslintrc.js:530-548]() |\n\n**Rationale for Selective Application**\n\n- DevTools uses Hooks extensively and benefits from automated checking\n- Core React packages are authored by developers intimately familiar with Hook rules\n- Test files may intentionally violate Hook rules to test error handling\n\n**Sources:** [.eslintrc.js:522-548]()\n\n---\n\n## Relationship to React Compiler\n\nThe plugin\'s test infrastructure coordinates with the React Compiler (Babel plugin):\n\n```bash\n# packages/eslint-plugin-react-hooks/package.json lines 24-25\n"build:compiler": "cd ../../compiler && yarn workspace babel-plugin-react-compiler build",\n"test": "yarn build:compiler && jest"\n```\n\n**Compiler Integration**\n\nThe React Compiler automatically memoizes components and values, potentially affecting how dependency arrays should be specified. The ESLint plugin\'s tests ensure compatibility with compiler-transformed code.\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:24-25]()\n\n---\n\n## Development and Contribution Workflow\n\n```mermaid\ngraph TB\n    subgraph "Local Development"\n        CloneRepo["Clone facebook/react"]\n        InstallDeps["yarn install"]\n        NavigatePlugin["cd packages/eslint-plugin-react-hooks"]\n    end\n    \n    subgraph "Making Changes"\n        EditSource["Edit src/*.ts files"]\n        RunTests["yarn test"]\n        TypeCheck["yarn typecheck"]\n    end\n    \n    subgraph "Integration Testing"\n        LinkPlugin["Test in consuming project"]\n        YarnLink["yarn link eslint-plugin-react-hooks"]\n    end\n    \n    subgraph "Pull Request"\n        CommitChanges["Commit changes"]\n        CIValidation["CI runs full test suite"]\n        ReviewMerge["Code review and merge"]\n    end\n    \n    CloneRepo --> InstallDeps\n    InstallDeps --> NavigatePlugin\n    NavigatePlugin --> EditSource\n    \n    EditSource --> RunTests\n    EditSource --> TypeCheck\n    \n    RunTests --> LinkPlugin\n    TypeCheck --> LinkPlugin\n    \n    LinkPlugin --> YarnLink\n    YarnLink --> CommitChanges\n    \n    CommitChanges --> CIValidation\n    CIValidation --> ReviewMerge\n```\n\n**Local Development Commands**\n\n```bash\n# Run the plugin\'s test suite\ncd packages/eslint-plugin-react-hooks\nyarn test\n\n# Type check without building\nyarn typecheck\n\n# Test against consuming application\nyarn link\ncd /path/to/your/app\nyarn link eslint-plugin-react-hooks\n```\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:23-26]()\n\n---\n\n## Key Files and Their Roles\n\n| File Path | Purpose |\n|-----------|---------|\n| `packages/eslint-plugin-react-hooks/package.json` | Package metadata, dependencies, and scripts |\n| `packages/eslint-plugin-react-hooks/index.js` | Main entry point exporting rules |\n| `packages/eslint-plugin-react-hooks/index.d.ts` | TypeScript type definitions |\n| `packages/eslint-plugin-react-hooks/src/RulesOfHooks.ts` | Implementation of `rules-of-hooks` rule |\n| `packages/eslint-plugin-react-hooks/src/ExhaustiveDeps.ts` | Implementation of `exhaustive-deps` rule |\n| `packages/eslint-plugin-react-hooks/tsconfig.json` | TypeScript compiler configuration |\n| `.eslintrc.js` (root) | Configures plugin usage in React repository |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:1-68](), [.eslintrc.js:522-548]()'}, meta=None, data='# Page: Overview\n\n# Overview\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThe React repository at https://github.com/facebook/react is a monorepo containing the implementation of React, a JavaScript library for building user interfaces. This repository includes:\n\n- The core `react` package providing the public API (hooks, components, JSX runtime)\n- Multiple renderer implementations for different platforms (DOM, Native, test environments)\n- The `react-reconciler` package implementing the Fiber architecture\n- Server-side rendering systems (Fizz for HTML streaming, Flight for Server Components)\n- The `scheduler` package for cooperative task scheduling\n- Build tooling, feature flags, and development tools\n\nThis document provides a high-level overview of the repository structure and major systems. For detailed information about specific subsystems, see:\n- Feature flag management: [Feature Flags System](#2)\n- Build and packaging: [Build System and Package Distribution](#3)\n- Core reconciliation algorithm: [React Reconciler](#4)\n- Server rendering: [Server-Side Rendering](#5)\n- Platform implementations: [Platform Implementations](#6)\n- Developer tools: [Developer Tools and Debugging](#7)\n\n---\n\n## Repository Structure\n\nThe React repository uses a **Yarn workspaces** monorepo structure with 13 packages under the `packages/` directory. The root [package.json:3-5]() defines the workspace configuration.\n\n```mermaid\ngraph TB\n    subgraph "Monorepo Root"\n        Root[react repository]\n        PackageJSON["package.json<br/>Workspace configuration"]\n        Scripts["scripts/<br/>Build & tooling"]\n    end\n    \n    subgraph "packages/ Directory"\n        React["react<br/>Core API"]\n        ReactDOM["react-dom<br/>DOM renderer"]\n        Reconciler["react-reconciler<br/>Fiber algorithm"]\n        Scheduler["scheduler<br/>Task scheduling"]\n        ReactNative["react-native-renderer<br/>Native platform"]\n        ReactArt["react-art<br/>Canvas/SVG renderer"]\n        TestRenderer["react-test-renderer<br/>Testing utilities"]\n        NoopRenderer["react-noop-renderer<br/>Test infrastructure"]\n        ReactIs["react-is<br/>Type checks"]\n        DevTools["react-devtools-*<br/>Debugging tools"]\n        ESLintPlugin["eslint-plugin-react-hooks<br/>Linting rules"]\n        JestReact["jest-react<br/>Test matchers"]\n        ServerPackages["react-server-dom-*<br/>Server Components"]\n    end\n    \n    Root --> PackageJSON\n    Root --> Scripts\n    Root --> React\n    Root --> ReactDOM\n    Root --> Reconciler\n    Root --> Scheduler\n    Root --> ReactNative\n    Root --> ReactArt\n    Root --> TestRenderer\n    Root --> NoopRenderer\n    Root --> ReactIs\n    Root --> DevTools\n    Root --> ESLintPlugin\n    Root --> JestReact\n    Root --> ServerPackages\n```\n\n**Sources:** [package.json:1-5](), [packages/react/package.json:1-7](), [packages/react-dom/package.json:1-10](), [packages/react-reconciler/package.json:1-10]()\n\n---\n\n## Package Categories and Dependencies\n\nThe repository\'s packages are organized by functional category:\n\n| Category | Packages | Purpose |\n|----------|----------|---------|\n| **Core API** | `react` | Public-facing React API, hooks (`useState`, `useEffect`), JSX runtime |\n| **Reconciler** | `react-reconciler` | Fiber reconciliation algorithm, work loop, scheduling |\n| **DOM Renderer** | `react-dom` | Browser DOM manipulation, event system, hydration |\n| **Native Renderer** | `react-native-renderer` | React Native platform integration |\n| **Scheduler** | `scheduler` | Cooperative task scheduling with priority queues |\n| **Server Rendering** | `react-dom` (server exports), `react-server-dom-*` | Fizz (streaming HTML), Flight (Server Components) |\n| **Test Infrastructure** | `react-test-renderer`, `react-noop-renderer`, `jest-react` | Testing utilities and test environments |\n| **Developer Tools** | `react-devtools-*`, `react-debug-tools` | Browser extensions, component inspection |\n| **Utilities** | `react-is`, `react-art` | Type checking, Canvas/SVG rendering |\n| **Linting** | `eslint-plugin-react-hooks` | Rules of Hooks enforcement |\n\n```mermaid\ngraph LR\n    subgraph "Public API Layer"\n        ReactPkg["react<br/>v19.3.0"]\n    end\n    \n    subgraph "Renderer Layer"\n        ReactDOM["react-dom<br/>Client & Server"]\n        ReactNative["react-native-renderer"]\n        ReactArt["react-art"]\n        TestRenderer["react-test-renderer"]\n    end\n    \n    subgraph "Core Engine"\n        Reconciler["react-reconciler<br/>v0.34.0<br/>Fiber algorithm"]\n        Scheduler["scheduler<br/>v0.28.0<br/>Priority queues"]\n    end\n    \n    ReactPkg -->|peer dependency| ReactDOM\n    ReactPkg -->|peer dependency| ReactNative\n    ReactPkg -->|peer dependency| ReactArt\n    ReactPkg -->|peer dependency| TestRenderer\n    \n    ReactDOM --> Reconciler\n    ReactNative --> Reconciler\n    ReactArt --> Reconciler\n    TestRenderer --> Reconciler\n    \n    Reconciler --> Scheduler\n    ReactDOM -->|dependency| Scheduler\n    ReactNative -->|dependency| Scheduler\n    ReactArt -->|dependency| Scheduler\n    TestRenderer -->|dependency| Scheduler\n```\n\n**Sources:** [packages/react/package.json:1-52](), [packages/react-dom/package.json:19-21](), [packages/react-reconciler/package.json:28-33](), [packages/scheduler/package.json:1-27]()\n\n---\n\n## Major System Components\n\nThe React codebase is organized around several interconnected systems:\n\n### Feature Flags System\n\nThe **Feature Flags** system (`ReactFeatureFlags.js` and environment-specific forks) controls which features are enabled in different deployment targets (Facebook web, React Native FB, React Native OSS, test environments). This is the highest-importance system (importance score: 820.92) as it affects all other packages.\n\nSee [Feature Flags System](#2) for detailed documentation.\n\n### Build System\n\nThe **Build System** uses **Rollup** to generate bundles across multiple module formats (CommonJS, ESM) and environments (Node.js, browser, Bun, React Native). The build is configured through:\n- `scripts/rollup/build-all-release-channels.js` - Main build orchestrator\n- `scripts/rollup/bundles.js` - Bundle definitions (importance: 365.86)\n- `scripts/rollup/forks.js` - Module replacement configuration\n- `scripts/shared/inlinedHostConfigs.js` - Renderer configurations (importance: 317.91)\n\nSee [Build System and Package Distribution](#3) for detailed documentation.\n\n### Fiber Reconciler\n\nThe **Fiber Reconciler** (`react-reconciler` package) implements React\'s core rendering algorithm. It manages:\n- Virtual DOM diffing and updates\n- Work loop with interruptible rendering\n- Lane-based priority scheduling\n- Suspense and error boundaries\n- Host configuration abstraction for platform independence\n\nSee [React Reconciler](#4) for detailed documentation.\n\n### Server Rendering\n\nReact provides two server-side rendering systems:\n- **Fizz** (`ReactFizzServer`) - Streaming HTML with Suspense support\n- **Flight** (`ReactFlightServer`) - Server Components with RSC protocol\n\nSee [Server-Side Rendering](#5) for detailed documentation.\n\n### Developer Tools\n\nThe **React DevTools** system provides component inspection, profiling, and debugging capabilities through browser extensions and standalone applications. The DevTools backend hooks into React renderers via `__REACT_DEVTOOLS_GLOBAL_HOOK__`.\n\nSee [Developer Tools and Debugging](#7) for detailed documentation.\n\n**Sources:** [scripts/rollup/build-all-release-channels.js](), [scripts/shared/inlinedHostConfigs.js](), [packages/react-reconciler/package.json:1-34]()\n\n---\n\n## Code Organization and File Structure\n\nThe repository follows a consistent structure across packages:\n\n```mermaid\ngraph TB\n    subgraph "Package Structure"\n        PkgRoot["packages/package-name/"]\n        PkgJSON["package.json<br/>Metadata, exports"]\n        SrcDir["src/<br/>Source code"]\n        NPMDir["npm/<br/>Wrapper files"]\n        CJSDir["cjs/<br/>Build output (gitignored)"]\n    end\n    \n    subgraph "Source Organization"\n        MainFiles["Entry points<br/>index.js, client.js, server.js"]\n        ImplFiles["Implementation files<br/>React*.js"]\n        ForksDir["forks/<br/>Environment-specific variants"]\n        TestsDir["__tests__/<br/>Jest test files"]\n    end\n    \n    subgraph "Build Artifacts"\n        DevBuild["*-dev.js<br/>Development builds"]\n        ProdBuild["*-prod.js<br/>Production builds"]\n        ProfileBuild["*-profiling.js<br/>Profiling builds"]\n    end\n    \n    PkgRoot --> PkgJSON\n    PkgRoot --> SrcDir\n    PkgRoot --> NPMDir\n    PkgRoot --> CJSDir\n    \n    SrcDir --> MainFiles\n    SrcDir --> ImplFiles\n    SrcDir --> ForksDir\n    SrcDir --> TestsDir\n    \n    CJSDir --> DevBuild\n    CJSDir --> ProdBuild\n    CJSDir --> ProfileBuild\n```\n\n**Key conventions:**\n\n1. **Entry points** follow naming conventions:\n   - `index.js` - Main entry point\n   - `client.js` - Client-side only code\n   - `server.js`, `server.node.js`, `server.browser.js` - Server rendering variants\n   - `*.react-server.js` - Server Components environment\n\n2. **Fork files** enable environment-specific implementations:\n   - `ReactFeatureFlags.www.js` - Facebook web\n   - `ReactFeatureFlags.native-fb.js` - React Native FB\n   - `ReactFeatureFlags.native-oss.js` - React Native OSS\n   - `ReactFiberConfig.dom.js`, `ReactFiberConfig.native.js` - Host configs\n\n3. **Shared code** lives in `packages/shared/`:\n   - `ReactVersion.js` - Current version string\n   - `ReactSymbols.js` - Internal symbols\n   - Various utility modules\n\n**Sources:** [packages/react-dom/package.json:51-126](), [packages/react/package.json:11-42](), [packages/shared/ReactVersion.js:1-16]()\n\n---\n\n## Development Tools and Configuration\n\n### ESLint Configuration\n\nThe repository uses a comprehensive ESLint configuration with custom rules:\n\n```mermaid\ngraph TB\n    subgraph "ESLint Setup"\n        MainConfig[".eslintrc.js<br/>Root configuration"]\n        CustomRules["scripts/eslint-rules/<br/>react-internal rules"]\n        Plugin["eslint-plugin-react-hooks<br/>Published package"]\n    end\n    \n    subgraph "Environment-Specific Configs"\n        CJSConfig["scripts/rollup/validate/<br/>eslintrc.cjs.js"]\n        ESMConfig["scripts/rollup/validate/<br/>eslintrc.esm.js"]\n        FBConfig["scripts/rollup/validate/<br/>eslintrc.fb.js"]\n        RNConfig["scripts/rollup/validate/<br/>eslintrc.rn.js"]\n    end\n    \n    MainConfig --> CustomRules\n    MainConfig --> Plugin\n    \n    MainConfig -.->|validates| CJSConfig\n    MainConfig -.->|validates| ESMConfig\n    MainConfig -.->|validates| FBConfig\n    MainConfig -.->|validates| RNConfig\n```\n\n**Custom rules include:**\n- `react-internal/prod-error-codes` - Enforces error code extraction\n- `react-internal/warning-args` - Validates warning message literals\n- `react-internal/safe-string-coercion` - Type-safe string conversion\n- `react-internal/no-production-logging` - Removes console calls in production\n- `no-for-of-loops` - Prevents Symbol polyfill requirement\n\n**Sources:** [.eslintrc.js:1-658](), [scripts/rollup/validate/eslintrc.cjs.js:1-112](), [packages/eslint-plugin-react-hooks/package.json:1-68]()\n\n### Flow Type Checking\n\nThe repository uses **Flow** for type checking with environment-specific configurations generated by `scripts/flow/createFlowConfigs.js`. This script creates separate `.flowconfig` files for each renderer to handle module resolution with forked implementations.\n\n```mermaid\ngraph LR\n    Template["scripts/flow/config/<br/>flowconfig template"]\n    Generator["createFlowConfigs.js<br/>Config generation"]\n    \n    Template --> Generator\n    \n    Generator --> DOMConfig["scripts/flow/dom/<br/>.flowconfig"]\n    Generator --> NativeConfig["scripts/flow/native/<br/>.flowconfig"]\n    Generator --> CustomConfig["scripts/flow/custom/<br/>.flowconfig"]\n    \n    Generator -.->|uses| HostConfigs["inlinedHostConfigs.js<br/>Renderer definitions"]\n```\n\n**Sources:** [scripts/flow/createFlowConfigs.js:1-153](), [scripts/flow/config/flowconfig:1-45](), [scripts/flow/environment.js:1-636]()\n\n### Testing Infrastructure\n\nThe repository uses **Jest** for testing with custom matchers and utilities:\n\n- `jest-react` package provides custom matchers for React-specific assertions\n- `react-test-renderer` enables snapshot testing without a DOM\n- `react-noop-renderer` provides a test-only renderer for reconciler testing\n- `internal-test-utils` contains shared test helpers\n\nTest files follow the pattern `**/__tests__/**/*.js` and are excluded from production builds.\n\n**Sources:** [package.json:121-123](), [packages/jest-react/package.json:1-32](), [packages/react-test-renderer/package.json:1-35](), [packages/react-noop-renderer/package.json:1-32]()\n\n---\n\n## Build Constants and Globals\n\nReact uses several global constants that are replaced at build time:\n\n| Constant | Purpose | Set By |\n|----------|---------|--------|\n| `__DEV__` | Development mode flag | Rollup replace plugin |\n| `__PROFILE__` | Profiling build flag | Build configuration |\n| `__EXPERIMENTAL__` | Experimental features flag | Release channel |\n| `__VARIANT__` | A/B test variant (www only) | Dynamic loading |\n| `__TEST__` | Test environment flag | Jest configuration |\n\nThese constants enable **dead code elimination** during production builds, significantly reducing bundle size.\n\n```mermaid\ngraph TB\n    subgraph "Source Code"\n        Code["Source with<br/>if (__DEV__) { ... }"]\n    end\n    \n    subgraph "Build Process"\n        RollupReplace["@rollup/plugin-replace<br/>Constant substitution"]\n        ClosureCompiler["Google Closure Compiler<br/>Dead code elimination"]\n    end\n    \n    subgraph "Output"\n        DevBundle["*-dev.js<br/>__DEV__ = true"]\n        ProdBundle["*-prod.js<br/>__DEV__ = false<br/>Dev code removed"]\n    end\n    \n    Code --> RollupReplace\n    RollupReplace --> DevBundle\n    RollupReplace --> ClosureCompiler\n    ClosureCompiler --> ProdBundle\n```\n\n**Sources:** [scripts/flow/environment.js:12-14](), [scripts/rollup/validate/eslintrc.cjs.js:43-60](), [.eslintrc.js:639-648]()\n\n---\n\n## Package Export Strategy\n\nReact packages use **conditional exports** in `package.json` to provide different entry points for different environments:\n\n```mermaid\ngraph TB\n    subgraph "Import Resolution"\n        UserImport["import { ... } from \'react-dom\'"]\n    end\n    \n    subgraph "Conditional Exports"\n        ReactServer["react-server condition<br/>react-dom.react-server.js"]\n        NodeEnv["node condition<br/>server.node.js"]\n        BrowserEnv["browser condition<br/>server.browser.js"]\n        WorkerdEnv["workerd condition<br/>server.edge.js"]\n        DefaultEnv["default<br/>index.js"]\n    end\n    \n    UserImport --> ReactServer\n    UserImport --> NodeEnv\n    UserImport --> BrowserEnv\n    UserImport --> WorkerdEnv\n    UserImport --> DefaultEnv\n```\n\nThe `exports` field in [packages/react-dom/package.json:51-126]() demonstrates this pattern:\n- `react-server` condition provides Server Components-compatible exports\n- `node`, `browser`, `workerd`, `deno`, `bun` conditions select runtime-specific code\n- `default` provides the fallback for other environments\n\n**Sources:** [packages/react-dom/package.json:51-126](), [packages/react/package.json:24-42]()\n\n---\n\n## Version and Release Management\n\nThe repository maintains version information in multiple locations:\n\n1. **Source of truth:** [packages/shared/ReactVersion.js:15]() exports the current version string (`\'19.3.0\'`)\n2. **Package manifests:** Each `package.json` declares its version\n3. **Dependency versions:** Peer and regular dependencies specify version ranges\n\nThe versioning strategy follows semantic versioning:\n- `react` and `react-dom` share the same major.minor.patch version\n- `react-reconciler` uses a separate version (`0.34.0`)\n- `scheduler` has an independent version (`0.28.0`)\n\n**Sources:** [packages/shared/ReactVersion.js:1-16](), [packages/react/package.json:7](), [packages/react-dom/package.json:3](), [packages/react-reconciler/package.json:4](), [packages/scheduler/package.json:3]()\n\n---\n\n# Page: Repository Structure and Packages\n\n# Repository Structure and Packages\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes the organizational structure of the React monorepo, detailing how packages are arranged within the Yarn workspaces, their interdependencies, and their specific purposes. It covers core library packages, platform-specific renderers, server-side rendering packages, and development tooling packages.\n\nFor information about the build system that processes these packages, see [Build System and Package Distribution](#3). For details on feature flag configuration that affects package behavior across environments, see [Feature Flags System](#2).\n\n---\n\n## Monorepo Workspace Structure\n\nThe React repository is organized as a Yarn monorepo using workspaces. The root [`package.json:3-4`]() declares a single workspace pattern:\n\n```json\n"workspaces": [\n  "packages/*"\n]\n```\n\nAll publishable and internal packages reside under the `packages/` directory. The workspace configuration allows packages to reference each other using symbolic links during development, while maintaining separate `package.json` files for individual publishing.\n\n### Workspace Configuration Diagram\n\n```mermaid\ngraph TB\n    Root["Root package.json<br/>Workspace manager<br/>Shared devDependencies"]\n    PackagesDir["packages/ directory<br/>13 workspace members"]\n    \n    React["react/<br/>Core library API"]\n    ReactDOM["react-dom/<br/>DOM renderer"]\n    ReactReconciler["react-reconciler/<br/>Fiber reconciler"]\n    Scheduler["scheduler/<br/>Cooperative scheduler"]\n    ReactNative["react-native-renderer/<br/>Native renderer"]\n    ReactArt["react-art/<br/>Canvas/SVG renderer"]\n    ReactTestRenderer["react-test-renderer/<br/>Test snapshot renderer"]\n    ReactNoop["react-noop-renderer/<br/>Test reconciler"]\n    EslintPlugin["eslint-plugin-react-hooks/<br/>Hooks linting rules"]\n    ReactIs["react-is/<br/>Type checking utilities"]\n    JestReact["jest-react/<br/>Test matchers"]\n    Shared["shared/<br/>Internal utilities"]\n    \n    Root --> PackagesDir\n    PackagesDir --> React\n    PackagesDir --> ReactDOM\n    PackagesDir --> ReactReconciler\n    PackagesDir --> Scheduler\n    PackagesDir --> ReactNative\n    PackagesDir --> ReactArt\n    PackagesDir --> ReactTestRenderer\n    PackagesDir --> ReactNoop\n    PackagesDir --> EslintPlugin\n    PackagesDir --> ReactIs\n    PackagesDir --> JestReact\n    PackagesDir --> Shared\n```\n\n**Sources:** [`package.json:1-164`](), [`packages/react/package.json`](), [`packages/react-dom/package.json`]()\n\n---\n\n## Core Library Packages\n\n### react\n\nThe `react` package provides the foundational API for building user interfaces, including:\n- Component base classes and hooks API\n- JSX transformation runtime (`jsx-runtime.js`, `jsx-dev-runtime.js`)\n- React Server Components support (`react.react-server.js`)\n- Compiler runtime support (`compiler-runtime.js`)\n\n**Package Configuration:**\n\n| Property | Value |\n|----------|-------|\n| Main Entry | `index.js` |\n| Version | `19.3.0` |\n| Peer Dependencies | None (provides base API) |\n\nThe package exports multiple entry points via the `exports` field in [`packages/react/package.json:24-42`]():\n- `.` - Main React API with conditional `react-server` export\n- `./jsx-runtime` - JSX transformation runtime\n- `./jsx-dev-runtime` - Development JSX runtime with debugging\n- `./compiler-runtime` - React Compiler support functions\n\n**Sources:** [`packages/react/package.json:1-52`](), [`packages/shared/ReactVersion.js:15`]()\n\n### react-dom\n\nThe `react-dom` package implements the DOM renderer with extensive platform-specific entry points:\n\n**Client-Side Rendering:**\n- `client.js` - Modern client entry using `createRoot`\n- `index.js` - Legacy and compatibility entry\n\n**Server-Side Rendering:**\n- `server.node.js` - Node.js streaming SSR\n- `server.browser.js` - Browser-compatible SSR\n- `server.edge.js` - Edge runtime SSR\n- `server.bun.js` - Bun runtime SSR\n- `static.node.js` - Static pre-rendering for Node.js\n- `static.browser.js` - Static pre-rendering for browsers\n- `static.edge.js` - Static pre-rendering for edge runtimes\n\n**Testing Utilities:**\n- `test-utils.js` - DOM testing helpers\n- `unstable_testing.js` - Experimental testing APIs\n\nThe package uses conditional exports to select the appropriate implementation based on runtime environment. From [`packages/react-dom/package.json:51-125`](), the exports use conditions like `react-server`, `workerd`, `bun`, `deno`, `worker`, `node`, `edge-light`, and `browser`.\n\n**Dependencies:**\n\n| Dependency | Type | Version |\n|------------|------|---------|\n| `scheduler` | Dependency | `^0.28.0` |\n| `react` | Peer Dependency | `^19.3.0` |\n\n**Sources:** [`packages/react-dom/package.json:1-127`]()\n\n### react-reconciler\n\nThe `react-reconciler` package exposes the Fiber reconciler as a standalone API for building custom renderers. It implements the core reconciliation algorithm that all React renderers use.\n\n**Entry Points:**\n- `index.js` - Main reconciler API\n- `constants.js` - Fiber-related constants\n- `reflection.js` - Reconciler reflection utilities\n\nThis package is used internally by `react-dom`, `react-native-renderer`, `react-test-renderer`, and `react-art`. It provides a host config interface that renderers must implement to integrate with the reconciler.\n\n**Dependencies:**\n\n| Dependency | Type | Version |\n|------------|------|---------|\n| `scheduler` | Dependency | `^0.28.0` |\n| `react` | Peer Dependency | `^19.3.0` |\n\n**Sources:** [`packages/react-reconciler/package.json:1-34`]()\n\n### scheduler\n\nThe `scheduler` package provides cooperative scheduling primitives used by the reconciler to prioritize and time-slice work:\n\n**Entry Points:**\n- `index.js` - Main scheduler API\n- `index.native.js` - React Native-specific implementation\n- `unstable_mock.js` - Deterministic mock for testing\n- `unstable_post_task.js` - Browser Scheduler API integration\n\nThe scheduler manages priority queues and uses `MessageChannel` or other APIs to yield control back to the browser between units of work.\n\n**Sources:** [`packages/scheduler/package.json:1-27`]()\n\n---\n\n## Package Dependency Graph\n\n```mermaid\ngraph TB\n    subgraph "Public Packages"\n        React["react<br/>Core API + Hooks"]\n        ReactDOM["react-dom<br/>DOM Renderer"]\n        ReactArt["react-art<br/>Canvas/SVG Renderer"]\n        ReactNative["react-native-renderer<br/>Native Renderer"]\n        ReactTestRenderer["react-test-renderer<br/>Test Renderer"]\n    end\n    \n    subgraph "Internal Packages"\n        ReactReconciler["react-reconciler<br/>Fiber Reconciler"]\n        Scheduler["scheduler<br/>Cooperative Scheduler"]\n        Shared["shared<br/>Internal Utilities"]\n        ReactNoop["react-noop-renderer<br/>Test Infrastructure"]\n    end\n    \n    subgraph "Development Tools"\n        EslintPlugin["eslint-plugin-react-hooks<br/>Linting Rules"]\n        JestReact["jest-react<br/>Test Matchers"]\n        ReactIs["react-is<br/>Type Checking"]\n    end\n    \n    ReactDOM --> ReactReconciler\n    ReactArt --> ReactReconciler\n    ReactNative --> ReactReconciler\n    ReactTestRenderer --> ReactReconciler\n    ReactNoop --> ReactReconciler\n    \n    ReactReconciler --> Scheduler\n    ReactDOM --> Scheduler\n    ReactArt --> Scheduler\n    ReactNative --> Scheduler\n    ReactTestRenderer --> Scheduler\n    \n    ReactDOM -.peer.-> React\n    ReactArt -.peer.-> React\n    ReactNative -.peer.-> React\n    ReactTestRenderer -.peer.-> React\n    ReactReconciler -.peer.-> React\n    \n    EslintPlugin -.dev.-> React\n    JestReact -.peer.-> React\n    JestReact -.peer.-> ReactTestRenderer\n    \n    ReactDOM --> Shared\n    ReactReconciler --> Shared\n    Scheduler --> Shared\n```\n\n**Sources:** [`packages/react-dom/package.json:19-21`](), [`packages/react-reconciler/package.json:28-33`](), [`packages/react-test-renderer/package.json:21-26`]()\n\n---\n\n## Renderer Packages\n\n### react-native-renderer\n\nAn internal package (not published to npm) that implements the React renderer for React Native environments. It supports both the legacy and Fabric architectures.\n\n**Configuration:**\n\n| Property | Value |\n|----------|-------|\n| Version | `16.0.0` (internal) |\n| Private | `true` |\n| Dependencies | `scheduler: ^0.28.0` |\n| Peer Dependencies | `react: ^18.0.0` |\n\nThis package has platform-specific behavior controlled by global variables:\n- `nativeFabricUIManager` - Fabric UI manager interface\n- `RN$enableMicrotasksInReact` - Microtask scheduling flag\n\n**Sources:** [`packages/react-native-renderer/package.json:1-16`](), [`.eslintrc.js:462-467`]()\n\n### react-art\n\nThe `react-art` package provides a renderer for vector graphics using the ART library, supporting Canvas, SVG, and VML (for IE8) outputs.\n\n**Public Exports:**\n- `index.js` - Main ART renderer\n- `Circle.js` - Circle shape component\n- `Rectangle.js` - Rectangle shape component\n- `Wedge.js` - Wedge/arc shape component\n\n**Dependencies:**\n\n| Dependency | Type | Version |\n|------------|------|---------|\n| `art` | Dependency | `^0.10.1` |\n| `create-react-class` | Dependency | `^15.6.2` |\n| `scheduler` | Dependency | `^0.28.0` |\n| `react` | Peer Dependency | `^19.3.0` |\n\n**Sources:** [`packages/react-art/package.json:1-41`]()\n\n### react-test-renderer\n\nA specialized renderer for snapshot testing that renders React components to pure JavaScript objects without requiring a DOM.\n\n**Entry Points:**\n- `index.js` - Main test renderer\n- `shallow.js` - Shallow rendering utilities\n\n**Dependencies:**\n\n| Dependency | Type | Version |\n|------------|------|---------|\n| `react-is` | Dependency | `^19.3.0` |\n| `scheduler` | Dependency | `^0.28.0` |\n| `react` | Peer Dependency | `^19.3.0` |\n\n**Sources:** [`packages/react-test-renderer/package.json:1-35`]()\n\n### react-noop-renderer\n\nAn internal test package providing mock implementations for testing the Fiber reconciler, Fizz server renderer, and Flight protocol without a real host environment.\n\n**Entry Points:**\n- `index.js` - Client-side noop renderer\n- `persistent.js` - Persistent mode noop renderer\n- `server.js` - Noop server renderer\n- `flight-client.js` - Flight client implementation\n- `flight-server.js` - Flight server implementation\n- `flight-modules.js` - Flight module system\n\nThis package is marked as `private: true` and depends on internal packages:\n- `react-reconciler`\n- `react-client`\n- `react-server`\n\n**Sources:** [`packages/react-noop-renderer/package.json:1-32`]()\n\n---\n\n## Development Tooling Packages\n\n### eslint-plugin-react-hooks\n\nAn ESLint plugin that enforces the Rules of Hooks and provides linting for React Hooks usage patterns.\n\n**Key Features:**\n- Enforces hook call ordering and conditional usage restrictions\n- Validates exhaustive dependencies for effect hooks\n- TypeScript type definitions included (`index.d.ts`)\n\n**Build Process:**\nThe plugin includes a build step that compiles the React Compiler:\n```json\n"scripts": {\n  "build:compiler": "cd ../../compiler && yarn workspace babel-plugin-react-compiler build",\n  "test": "yarn build:compiler && jest"\n}\n```\n\n**Dependencies:**\n\n| Dependency | Purpose |\n|------------|---------|\n| `@babel/core` | AST parsing and traversal |\n| `@babel/parser` | JavaScript/TypeScript parsing |\n| `hermes-parser` | Alternative parser for Flow |\n| `zod` | Configuration schema validation |\n\n**Peer Dependencies:**\n- ESLint versions 3.x through 9.x\n\n**Sources:** [`packages/eslint-plugin-react-hooks/package.json:1-68`]()\n\n### react-is\n\nA utility package for checking React element types and determining what kind of element a value represents.\n\n**Package Configuration:**\n\n| Property | Value |\n|----------|-------|\n| Version | `19.3.0` |\n| Side Effects | `false` (tree-shakeable) |\n| Main Entry | `index.js` |\n\nThis package is used internally by `react-test-renderer` and other tools to identify element types without depending on the full React package.\n\n**Sources:** [`packages/react-is/package.json:1-26`]()\n\n### jest-react\n\nProvides Jest matchers and utilities specifically designed for testing React components.\n\n**Peer Dependencies:**\n\n| Dependency | Supported Versions |\n|------------|-------------------|\n| `jest` | 23.x - 29.x |\n| `react` | `^19.0.0` |\n| `react-test-renderer` | `^19.0.0` |\n\n**Sources:** [`packages/jest-react/package.json:1-32`]()\n\n---\n\n## Package Organization by Purpose\n\n```mermaid\ngraph LR\n    subgraph "User-Facing APIs"\n        React["react<br/>Component API, Hooks"]\n        ReactDOM["react-dom<br/>Browser Rendering"]\n    end\n    \n    subgraph "Renderer Implementations"\n        RN["react-native-renderer<br/>iOS/Android UI"]\n        Art["react-art<br/>Vector Graphics"]\n        Test["react-test-renderer<br/>Snapshot Testing"]\n    end\n    \n    subgraph "Core Infrastructure"\n        Reconciler["react-reconciler<br/>Diff Algorithm"]\n        Sched["scheduler<br/>Priority Scheduling"]\n    end\n    \n    subgraph "Developer Experience"\n        Eslint["eslint-plugin-react-hooks<br/>Code Quality"]\n        JestReact["jest-react<br/>Test Utilities"]\n        ReactIs["react-is<br/>Type Checking"]\n    end\n    \n    subgraph "Internal Testing"\n        Noop["react-noop-renderer<br/>Mock Environment"]\n    end\n    \n    React --> |"used by"| ReactDOM\n    React --> |"used by"| RN\n    React --> |"used by"| Art\n    React --> |"used by"| Test\n    \n    Reconciler --> |"powers"| ReactDOM\n    Reconciler --> |"powers"| RN\n    Reconciler --> |"powers"| Art\n    Reconciler --> |"powers"| Test\n    Reconciler --> |"tested by"| Noop\n    \n    Sched --> |"schedules"| Reconciler\n    \n    Eslint -.-> |"validates"| React\n    ReactIs --> |"supports"| Test\n    JestReact -.-> |"tests"| Test\n```\n\n**Sources:** [`package.json:1-164`](), [`packages/react/package.json`](), [`packages/react-reconciler/package.json`]()\n\n---\n\n## Build System Configuration\n\n### Shared Development Dependencies\n\nThe root [`package.json:6-120`]() declares all development dependencies used across packages:\n\n**Build Tools:**\n- `rollup: ^3.29.5` - Module bundler\n- `@rollup/plugin-babel: ^6.0.3` - Babel integration\n- `@rollup/plugin-commonjs: ^24.0.1` - CommonJS module support\n- `@rollup/plugin-typescript: ^12.1.2` - TypeScript support\n- `google-closure-compiler: ^20230206.0.0` - Advanced optimization\n\n**Transpilation:**\n- `@babel/core: ^7.11.1` - Babel compiler core\n- `flow-bin: ^0.279.0` - Flow type checker\n- `typescript: ^5.4.3` - TypeScript compiler\n\n**Testing:**\n- `jest: ^29.4.2` - Test framework\n- `jest-environment-jsdom: ^29.4.2` - DOM environment\n- `@types/eslint: ^9.6.1` - TypeScript definitions\n\n**Linting:**\n- `eslint: ^7.7.0` - Linter\n- `prettier: ^3.3.3` - Code formatter\n\n**Sources:** [`package.json:6-120`]()\n\n### Build Scripts\n\nThe root package defines several build scripts in [`package.json:124-157`]():\n\n| Script | Purpose |\n|--------|---------|\n| `build` | Build all packages for all release channels |\n| `build-for-devtools` | Build experimental packages for DevTools |\n| `build-for-flight-dev` | Build Server Components packages for development |\n| `lint` | Run ESLint on all packages |\n| `test` | Run Jest tests |\n| `test-stable` | Run tests against stable release channel |\n| `test-www` | Run tests for Facebook www environment |\n\n**Sources:** [`package.json:124-157`]()\n\n---\n\n## Flow Type Configuration\n\nThe repository uses Flow for type checking with multiple configurations for different renderer environments. The script [`scripts/flow/createFlowConfigs.js:1-153`]() generates environment-specific `.flowconfig` files.\n\n### Flow Configuration Generation\n\n```mermaid\ngraph TB\n    ConfigTemplate["config/flowconfig<br/>Template with placeholders"]\n    CreateScript["createFlowConfigs.js<br/>Configuration generator"]\n    InlinedConfigs["inlinedHostConfigs<br/>Renderer definitions"]\n    \n    DOMConfig["flow/dom/.flowconfig<br/>DOM renderer config"]\n    NativeConfig["flow/native/.flowconfig<br/>Native renderer config"]\n    ArtConfig["flow/art/.flowconfig<br/>ART renderer config"]\n    \n    ForkDiscovery["Fork Discovery<br/>Scans packages/*/forks/"]\n    ModuleMappings["Module Mappings<br/>Maps forked files to renderers"]\n    IgnorePaths["Ignore Paths<br/>Excludes other renderer paths"]\n    \n    ConfigTemplate --> CreateScript\n    InlinedConfigs --> CreateScript\n    ForkDiscovery --> CreateScript\n    \n    CreateScript --> ModuleMappings\n    CreateScript --> IgnorePaths\n    \n    ModuleMappings --> DOMConfig\n    IgnorePaths --> DOMConfig\n    \n    ModuleMappings --> NativeConfig\n    IgnorePaths --> NativeConfig\n    \n    ModuleMappings --> ArtConfig\n    IgnorePaths --> ArtConfig\n```\n\nThe configuration generation process:\n1. Reads the template from [`scripts/flow/config/flowconfig:1-45`]()\n2. Discovers all forked files in `packages/*/forks/` directories\n3. Maps forked implementations to specific renderers (e.g., `ReactFiberConfig.dom.js`)\n4. Generates ignore patterns for other renderers\' code paths\n5. Writes separate `.flowconfig` files for each renderer\n\n**Key Forked Files:**\n- `ReactFiberConfig` - Reconciler host config\n- `ReactServerStreamConfig` - Server streaming config\n- `ReactFizzConfig` - HTML streaming config\n- `ReactFlightServerConfig` - Server Components config\n- `ReactFlightClientConfig` - Server Components client config\n\n**Sources:** [`scripts/flow/createFlowConfigs.js:1-153`](), [`scripts/flow/config/flowconfig:1-45`]()\n\n---\n\n## ESLint Configuration by Environment\n\nThe repository uses different ESLint configurations for different output targets, defined in [`scripts/rollup/validate/`]():\n\n### ESLint Configuration Matrix\n\n| Configuration | Parser | ECMAVersion | Source Type | Purpose |\n|---------------|--------|-------------|-------------|---------|\n| `eslintrc.cjs.js` | `espree` | 2020 | `script` | CommonJS builds |\n| `eslintrc.cjs2015.js` | `espree` | 2015 | `script` | ES2015 CommonJS builds |\n| `eslintrc.esm.js` | `espree` | 2020 | `module` | ES Module builds |\n| `eslintrc.fb.js` | `espree` | 5 | `script` | Facebook internal builds |\n| `eslintrc.rn.js` | `espree` | 5 | `script` | React Native builds |\n\nEach configuration declares environment-specific globals. For example, [`scripts/rollup/validate/eslintrc.fb.js:8-70`]() includes:\n- ES6+ globals: `Map`, `Set`, `Symbol`, `Proxy`, `WeakRef`\n- Typed arrays: `Int8Array`, `Uint8Array`, etc.\n- Platform-specific: `__DEV__`, `trustedTypes`, `AsyncLocalStorage`\n\n**Sources:** [`scripts/rollup/validate/eslintrc.cjs.js:1-112`](), [`scripts/rollup/validate/eslintrc.fb.js:1-96`](), [`scripts/rollup/validate/eslintrc.rn.js:1-98`]()\n\n---\n\n## Package Manager Configuration\n\nThe repository uses Yarn 1.x as specified in [`package.json:163`]():\n\n```json\n"packageManager": "yarn@1.22.22"\n```\n\n### Yarn Resolutions\n\nThe repository overrides specific transitive dependencies via resolutions in [`package.json:159-162`]():\n\n```json\n"resolutions": {\n  "react-is": "npm:react-is",\n  "jsdom": "22.1.0"\n}\n```\n\nThis ensures consistent versions of `react-is` across all packages and pins `jsdom` to a specific version for test stability.\n\n**Sources:** [`package.json:159-164`]()\n\n---\n\n## Summary of Key Packages\n\n| Package | Type | Purpose | Exported |\n|---------|------|---------|----------|\n| `react` | Core | Public component API and hooks | Yes |\n| `react-dom` | Renderer | DOM rendering with SSR support | Yes |\n| `react-reconciler` | Infrastructure | Fiber reconciler for custom renderers | Yes |\n| `scheduler` | Infrastructure | Cooperative scheduling primitives | Yes |\n| `react-native-renderer` | Renderer | React Native platform renderer | No (internal) |\n| `react-art` | Renderer | Canvas/SVG vector graphics | Yes |\n| `react-test-renderer` | Testing | Snapshot testing without DOM | Yes |\n| `react-noop-renderer` | Testing | Mock renderer for internal tests | No (internal) |\n| `eslint-plugin-react-hooks` | Tooling | Hooks linting rules | Yes |\n| `react-is` | Utility | Element type checking | Yes |\n| `jest-react` | Testing | Jest matchers for React | Yes |\n| `shared` | Infrastructure | Internal shared utilities | No (internal) |\n\n**Sources:** All package.json files referenced throughout this document\n\n---\n\n# Page: Feature Flags System\n\n# Feature Flags System\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/shared/ReactFeatureFlags.js](packages/shared/ReactFeatureFlags.js)\n- [packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js](packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js)\n- [packages/shared/forks/ReactFeatureFlags.native-fb.js](packages/shared/forks/ReactFeatureFlags.native-fb.js)\n- [packages/shared/forks/ReactFeatureFlags.native-oss.js](packages/shared/forks/ReactFeatureFlags.native-oss.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.js](packages/shared/forks/ReactFeatureFlags.test-renderer.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js](packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.www.js](packages/shared/forks/ReactFeatureFlags.test-renderer.www.js)\n- [packages/shared/forks/ReactFeatureFlags.www-dynamic.js](packages/shared/forks/ReactFeatureFlags.www-dynamic.js)\n- [packages/shared/forks/ReactFeatureFlags.www.js](packages/shared/forks/ReactFeatureFlags.www.js)\n- [scripts/flow/xplat.js](scripts/flow/xplat.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThe Feature Flags System is React\'s comprehensive mechanism for controlling experimental features, platform-specific behavior, and gradual feature rollouts across different environments and release channels. It enables the same codebase to be compiled with different behaviors for Facebook\'s internal infrastructure (www), React Native Facebook internal (native-fb), React Native open source (native-oss), and test renderers, while also supporting A/B testing and runtime-controllable flags in production environments.\n\nThis document covers the flag definition structure, forking mechanism, dynamic flag integration, build-time macros, and flag lifecycle management. For information about how the build system processes these flags, see [Build System and Package Distribution](#3). For information about how flags affect reconciler behavior, see [React Reconciler](#4).\n\n## System Architecture\n\nThe feature flag system is structured as a base definition file with environment-specific forks that override default values. The system supports both static flags (determined at build time) and dynamic flags (controllable at runtime via gatekeepers or feature management systems).\n\n```mermaid\ngraph TB\n    subgraph "Base Definitions"\n        BaseFlags["ReactFeatureFlags.js<br/>Canonical flag definitions"]\n    end\n    \n    subgraph "Static Forks"\n        WWWFork["ReactFeatureFlags.www.js<br/>Facebook internal"]\n        NativeFBFork["ReactFeatureFlags.native-fb.js<br/>React Native FB"]\n        NativeOSSFork["ReactFeatureFlags.native-oss.js<br/>React Native OSS"]\n        TestRendererFork["ReactFeatureFlags.test-renderer.js<br/>Test renderer"]\n        TestRendererWWWFork["ReactFeatureFlags.test-renderer.www.js<br/>Test renderer www"]\n        TestRendererNativeFBFork["ReactFeatureFlags.test-renderer.native-fb.js<br/>Test renderer native-fb"]\n    end\n    \n    subgraph "Dynamic Forks"\n        WWWDynamic["ReactFeatureFlags.www-dynamic.js<br/>Gatekeeper integration"]\n        NativeFBDynamic["ReactFeatureFlags.native-fb-dynamic.js<br/>Native feature flags"]\n    end\n    \n    subgraph "Build-Time Macros"\n        ExperimentalMacro["__EXPERIMENTAL__<br/>Experimental channel"]\n        ProfileMacro["__PROFILE__<br/>Profiling builds"]\n        VariantMacro["__VARIANT__<br/>A/B testing"]\n    end\n    \n    subgraph "Runtime Integration"\n        Gatekeeper["Gatekeeper System<br/>Facebook infrastructure"]\n        ReactNativeFlags["ReactNativeInternalFeatureFlags<br/>Native module"]\n    end\n    \n    BaseFlags --> WWWFork\n    BaseFlags --> NativeFBFork\n    BaseFlags --> NativeOSSFork\n    BaseFlags --> TestRendererFork\n    BaseFlags --> TestRendererWWWFork\n    BaseFlags --> TestRendererNativeFBFork\n    \n    WWWFork --> WWWDynamic\n    NativeFBFork --> NativeFBDynamic\n    \n    WWWDynamic --> Gatekeeper\n    NativeFBDynamic --> ReactNativeFlags\n    \n    ExperimentalMacro --> WWWFork\n    ExperimentalMacro --> NativeFBFork\n    ExperimentalMacro --> BaseFlags\n    ProfileMacro --> WWWFork\n    ProfileMacro --> NativeFBFork\n    ProfileMacro --> BaseFlags\n    VariantMacro --> WWWDynamic\n    VariantMacro --> NativeFBDynamic\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:1-259](), [packages/shared/forks/ReactFeatureFlags.www.js:1-121](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:1-92](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:1-91]()\n\n## Base Feature Flag Definitions\n\nThe base feature flag definitions reside in `ReactFeatureFlags.js` and serve as the canonical source of all flags with their default values for open source builds. This file organizes flags into explicit lifecycle categories that document their intended purpose and stability.\n\n### Flag Organization Structure\n\n```mermaid\ngraph LR\n    BaseFlags["ReactFeatureFlags.js"]\n    \n    BaseFlags --> LandOrRemoveZero["Land or remove (zero effort)<br/>Lines 10-16"]\n    BaseFlags --> Killswitch["Killswitch<br/>Lines 18-26"]\n    BaseFlags --> LandOrRemoveModerate["Land or remove (moderate effort)<br/>Lines 28-36"]\n    BaseFlags --> SlatedForRemoval["Slated for removal (significant effort)<br/>Lines 38-62"]\n    BaseFlags --> OngoingExperiments["Ongoing experiments<br/>Lines 64-152"]\n    BaseFlags --> ReadyForMajor["Ready for next major<br/>Lines 154-196"]\n    BaseFlags --> ChoppingBlock["Chopping Block<br/>Lines 198-223"]\n    BaseFlags --> DebuggingDevTools["Debugging and DevTools<br/>Lines 225-259"]\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:10-259]()\n\n### Key Flag Categories\n\n| Category | Purpose | Example Flags | Lines |\n|----------|---------|---------------|-------|\n| **Killswitch** | Emergency disable switches for production issues | `enableHydrationLaneScheduling` | [25]() |\n| **Land or remove (moderate)** | Flags requiring migration effort | `disableSchedulerTimeoutInWorkLoop` | [35]() |\n| **Slated for removal** | Deprecated features awaiting migration | `enableSuspenseCallback`, `enableScopeAPI`, `enableCreateEventHandleAPI` | [52, 55, 58]() |\n| **Ongoing experiments** | Active feature development | `enableLegacyCache`, `enableTaint`, `enableViewTransition` | [77, 81, 85]() |\n| **Ready for next major** | Features planned for next major release | `disableLegacyContext`, `disableLegacyMode`, `renameElementSymbol` | [177, 195, 167]() |\n| **Debugging and DevTools** | Profiling and development tools | `enableProfilerTimer`, `enableComponentPerformanceTrack` | [229, 235]() |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:10-259]()\n\n### Common Flag Patterns\n\nThe base file defines several patterns of flags:\n\n**Boolean Feature Toggles:**\n```\nexport const enableHalt: boolean = true;\nexport const enableViewTransition: boolean = true;\nexport const enableGestureTransition = __EXPERIMENTAL__;\n```\n\n**Expiration Timeouts:**\n```\nexport const retryLaneExpirationMs = 5000;\nexport const syncLaneExpirationMs = 250;\nexport const transitionLaneExpirationMs = 5000;\n```\n\n**Limits and Thresholds:**\n```\nexport const ownerStackLimit = 1e4;\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:83-141, 167-172, 258]()\n\n## Fork Mechanism\n\nThe fork mechanism allows different builds to use different implementations of the feature flags module. During the build process, Rollup\'s module resolution is configured to substitute the appropriate fork based on the target bundle type.\n\n### Fork Resolution Process\n\n```mermaid\ngraph TB\n    BuildProcess["Rollup Build Process"]\n    \n    BuildProcess --> BundleType{"Bundle Type"}\n    \n    BundleType -->|"FB_WWW"| WWW["packages/shared/forks/<br/>ReactFeatureFlags.www.js"]\n    BundleType -->|"RN_FB"| NativeFB["packages/shared/forks/<br/>ReactFeatureFlags.native-fb.js"]\n    BundleType -->|"RN_OSS"| NativeOSS["packages/shared/forks/<br/>ReactFeatureFlags.native-oss.js"]\n    BundleType -->|"TEST_RENDERER"| TestRenderer["packages/shared/forks/<br/>ReactFeatureFlags.test-renderer.js"]\n    BundleType -->|"TEST_RENDERER_WWW"| TestRendererWWW["packages/shared/forks/<br/>ReactFeatureFlags.test-renderer.www.js"]\n    BundleType -->|"TEST_RENDERER_NATIVE_FB"| TestRendererNativeFB["packages/shared/forks/<br/>ReactFeatureFlags.test-renderer.native-fb.js"]\n    BundleType -->|"Default"| Base["packages/shared/<br/>ReactFeatureFlags.js"]\n    \n    WWW --> Import1["Import in reconciler/renderers"]\n    NativeFB --> Import1\n    NativeOSS --> Import1\n    TestRenderer --> Import1\n    TestRendererWWW --> Import1\n    TestRendererNativeFB --> Import1\n    Base --> Import1\n```\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:1-121](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:1-92](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:1-91]()\n\n### Fork Type Verification\n\nEach fork file includes Flow type verification at the end to ensure it exports the same interface as the base file:\n\n```\n((((null: any): ExportsType): FeatureFlagsType): ExportsType);\n```\n\nThis type assertion ensures that:\n1. The fork exports all flags defined in the base\n2. The fork doesn\'t export extra flags not in the base\n3. Type signatures match exactly\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:120](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:91](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:90]()\n\n### Platform-Specific Flag Values\n\nDifferent forks set different default values based on platform capabilities and requirements:\n\n| Flag | Base | www | native-fb | native-oss |\n|------|------|-----|-----------|------------|\n| `enableLegacyFBSupport` | false | true | false | false |\n| `disableLegacyMode` | true | true | false | false |\n| `enableMoveBefore` | false | false | true | true |\n| `enableSuspenseCallback` | false | true | true | false |\n| `enableScopeAPI` | false | true | false | false |\n| `enableViewTransition` | true | true | false | true |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:61, 195, 184, 52, 55, 85](), [packages/shared/forks/ReactFeatureFlags.www.js:55, 101, 53, 87, 85](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:51, 39, 46, 62, 60](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:37, 24, 31, 50, 47, 65]()\n\n## Dynamic Feature Flags\n\nDynamic feature flags enable runtime control of features in internal Meta builds through gatekeeper systems. These flags are re-exported from platform-specific feature flag modules and their values can change without redeploying code.\n\n### www Dynamic Flags\n\nThe `ReactFeatureFlags.www.js` fork imports dynamic flags from a runtime module:\n\n```mermaid\ngraph LR\n    WWWFork["ReactFeatureFlags.www.js"]\n    DynamicModule["ReactFeatureFlags.www-dynamic.js"]\n    GatekeeperSystem["Gatekeeper System<br/>Meta infrastructure"]\n    RuntimeValue["Runtime Flag Values"]\n    \n    DynamicModule -->|"require(\'ReactFeatureFlags\')"| GatekeeperSystem\n    GatekeeperSystem --> RuntimeValue\n    RuntimeValue --> WWWFork\n    WWWFork -->|"Destructure and re-export"| Exports["Exported Flags"]\n    \n    WWWFork -->|"Lines 17-39"| ExportedDynamic["alwaysThrottleRetries<br/>disableLegacyContextForFunctionComponents<br/>enableObjectFiber<br/>enableRetryLaneExpiration<br/>enableTransitionTracing<br/>enableViewTransition<br/>enableComponentPerformanceTrack<br/>..."]\n```\n\nThe www fork destructures and re-exports specific flags from the dynamic module:\n\n```\nexport const {\n  alwaysThrottleRetries,\n  disableLegacyContextForFunctionComponents,\n  disableSchedulerTimeoutInWorkLoop,\n  enableHiddenSubtreeInsertionEffectCleanup,\n  enableInfiniteRenderLoopDetection,\n  enableNoCloningMemoCache,\n  enableObjectFiber,\n  enableRetryLaneExpiration,\n  enableTransitionTracing,\n  ...\n} = dynamicFeatureFlags;\n```\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:15-39]()\n\n### Native Facebook Dynamic Flags\n\nThe native-fb fork imports dynamic flags from the `ReactNativeInternalFeatureFlags` native module:\n\n```\nimport * as dynamicFlagsUntyped from \'ReactNativeInternalFeatureFlags\';\nconst dynamicFlags: DynamicExportsType = (dynamicFlagsUntyped: any);\n\nexport const {\n  alwaysThrottleRetries,\n  enableHiddenSubtreeInsertionEffectCleanup,\n  enableObjectFiber,\n  enableEagerAlternateStateNodeCleanup,\n  passChildrenWhenCloningPersistedNodes,\n  renameElementSymbol,\n  enableFragmentRefs,\n  enableFragmentRefsScrollIntoView,\n  enableFragmentRefsInstanceHandles,\n} = dynamicFlags;\n```\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.native-fb.js:16-31](), [scripts/flow/xplat.js:10-12]()\n\n### __VARIANT__ Testing Pattern\n\nDynamic flag definition files use the `__VARIANT__` macro to enable A/B testing during development. The build system runs tests twice: once with `__VARIANT__ = true` and once with `__VARIANT__ = false`:\n\n```\nexport const alwaysThrottleRetries: boolean = __VARIANT__;\nexport const disableLegacyContextForFunctionComponents: boolean = __VARIANT__;\nexport const enableObjectFiber: boolean = __VARIANT__;\nexport const enableRetryLaneExpiration: boolean = __VARIANT__;\n```\n\nThis allows testing both code paths for flags that will be dynamically controlled in production.\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www-dynamic.js:13-42](), [packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js:10-30]()\n\n## Build-Time Macros\n\nBuild-time macros are special identifiers that are replaced with boolean values during the build process. These enable conditional compilation based on build configuration.\n\n### Macro Types and Usage\n\n```mermaid\ngraph TB\n    SourceCode["Source Code with Macros"]\n    \n    SourceCode --> Experimental["__EXPERIMENTAL__"]\n    SourceCode --> Profile["__PROFILE__"]\n    SourceCode --> Variant["__VARIANT__"]\n    \n    Experimental -->|"Experimental builds"| ExpTrue["true"]\n    Experimental -->|"Stable builds"| ExpFalse["false"]\n    \n    Profile -->|"Profiling builds"| ProfTrue["true"]\n    Profile -->|"Production builds"| ProfFalse["false"]\n    \n    Variant -->|"Test run 1"| VarTrue["true"]\n    Variant -->|"Test run 2"| VarFalse["false"]\n    \n    ExpTrue --> ClosureCompiler["Closure Compiler<br/>Dead code elimination"]\n    ExpFalse --> ClosureCompiler\n    ProfTrue --> ClosureCompiler\n    ProfFalse --> ClosureCompiler\n    VarTrue --> ClosureCompiler\n    VarFalse --> ClosureCompiler\n    \n    ClosureCompiler --> OptimizedBundle["Optimized Bundle<br/>Unused paths removed"]\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:77-126, 229-256](), [packages/shared/forks/ReactFeatureFlags.www.js:41-69]()\n\n### __EXPERIMENTAL__ Macro\n\nUsed to enable features only in experimental release channels:\n\n```\nexport const enableLegacyCache = __EXPERIMENTAL__;\nexport const enableAsyncIterableChildren = __EXPERIMENTAL__;\nexport const enableTaint = __EXPERIMENTAL__;\nexport const enableGestureTransition = __EXPERIMENTAL__;\n```\n\nIn the www fork, `__EXPERIMENTAL__` is also used for the new modern build variant:\n\n```\nexport const disableLegacyContext = __EXPERIMENTAL__;\nexport const disableTextareaChildren = __EXPERIMENTAL__;\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:77, 79, 81, 87](), [packages/shared/forks/ReactFeatureFlags.www.js:69, 91]()\n\n### __PROFILE__ Macro\n\nUsed to enable profiling and performance measurement features:\n\n```\nexport const enableProfilerTimer = __PROFILE__;\nexport const enableProfilerCommitHooks = __PROFILE__;\nexport const enableProfilerNestedUpdatePhase = __PROFILE__;\nexport const enableUpdaterTracking = __PROFILE__;\nexport const enableSchedulingProfiler: boolean = \n  !enableComponentPerformanceTrack && __PROFILE__;\n```\n\nThis enables React DevTools profiling capabilities without impacting production bundle size.\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:229, 248, 251, 256, 244-245](), [packages/shared/forks/ReactFeatureFlags.www.js:44-47, 66-67]()\n\n### __VARIANT__ Macro\n\nUsed in dynamic flag definition files to simulate gatekeepers during testing:\n\n```\nexport const alwaysThrottleRetries: boolean = __VARIANT__;\nexport const enableObjectFiber: boolean = __VARIANT__;\nexport const enableRetryLaneExpiration: boolean = __VARIANT__;\nexport const enableTransitionTracing: boolean = __VARIANT__;\n```\n\nThe test infrastructure runs tests multiple times with different `__VARIANT__` values to ensure both code paths work correctly.\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www-dynamic.js:16-24](), [packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js:20-29]()\n\n## Feature Flag Lifecycle\n\nFlags move through different lifecycle stages as features are developed, stabilized, and eventually removed. The base file explicitly documents these stages through code comments and organization.\n\n### Lifecycle Stage Flow\n\n```mermaid\nstateDiagram-v2\n    [*] --> OngoingExperiment: New feature flag\n    OngoingExperiment --> ReadyForMajor: Feature stabilized\n    OngoingExperiment --> SlatedForRemoval: Feature rejected\n    ReadyForMajor --> LandOrRemove: Released in major\n    SlatedForRemoval --> LandOrRemove: Migration complete\n    LandOrRemove --> [*]: Flag removed\n    \n    OngoingExperiment --> Killswitch: Production issue\n    Killswitch --> OngoingExperiment: Issue resolved\n    Killswitch --> SlatedForRemoval: Feature abandoned\n    \n    note right of OngoingExperiment: Lines 64-152<br/>Active development\n    note right of ReadyForMajor: Lines 154-196<br/>Next major release\n    note right of SlatedForRemoval: Lines 38-62<br/>Awaiting cleanup\n    note right of Killswitch: Lines 18-26<br/>Emergency disable\n```\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:10-259]()\n\n### Stage Definitions\n\n**Ongoing Experiments (Lines 64-152):**\nFeatures under active development that may change or be reverted. Examples:\n- `enableYieldingBeforePassive`: Yield to browser event loop before passive effects\n- `enableThrottledScheduling`: Intentionally yield less to block high framerate animations\n- `enableViewTransition`: View transition API integration\n- `enableSuspenseyImages`: Enhanced image loading with Suspense\n\n**Ready for Next Major (Lines 154-196):**\nFeatures that are stable and will be enabled by default in the next major release:\n- `disableLegacyContext`: Remove legacy context API\n- `disableLegacyMode`: Remove legacy rendering mode\n- `renameElementSymbol`: Update internal element representation\n- `enableReactTestRendererWarning`: Warn about test renderer usage\n\n**Slated for Removal (Lines 38-62):**\nDeprecated features that didn\'t ship but can\'t be deleted until internal migrations complete:\n- `enableSuspenseCallback`: Legacy Suspense callback API\n- `enableScopeAPI`: Experimental Scope support\n- `enableCreateEventHandleAPI`: Experimental event handle API\n- `enableLegacyFBSupport`: Legacy Primer support on Facebook internal\n\n**Killswitch (Lines 18-26):**\nFlags that exist to quickly disable features if they cause production issues:\n- `enableHydrationLaneScheduling`: Can be disabled if hydration scheduling causes issues\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:64-152, 154-196, 38-62, 18-26]()\n\n## Integration with Build System\n\nThe feature flag system integrates deeply with the build pipeline through module forking and macro replacement. The build system selects the appropriate fork based on the bundle configuration.\n\n### Build-Time Flag Resolution\n\n```mermaid\ngraph TB\n    BundleConfig["scripts/rollup/bundles.js<br/>Bundle configuration"]\n    ForksConfig["scripts/rollup/forks.js<br/>Fork mappings"]\n    RollupPlugin["Rollup Plugin<br/>Module resolution"]\n    \n    BundleConfig --> BundleType["Bundle Type<br/>FB_WWW, RN_OSS, etc."]\n    ForksConfig --> ForkMapping["Fork Mapping<br/>shared/ReactFeatureFlags  shared/forks/ReactFeatureFlags.www"]\n    \n    BundleType --> RollupPlugin\n    ForkMapping --> RollupPlugin\n    \n    RollupPlugin --> ResolvedModule["Resolved Module<br/>packages/shared/forks/ReactFeatureFlags.www.js"]\n    \n    ResolvedModule --> BabelTransform["Babel Transform<br/>Macro replacement"]\n    \n    BabelTransform --> ExperimentalTrue["__EXPERIMENTAL__  true"]\n    BabelTransform --> ExperimentalFalse["__EXPERIMENTAL__  false"]\n    BabelTransform --> ProfileTrue["__PROFILE__  true"]\n    BabelTransform --> ProfileFalse["__PROFILE__  false"]\n    \n    ExperimentalTrue --> ClosureCompiler["Closure Compiler<br/>Dead code elimination"]\n    ExperimentalFalse --> ClosureCompiler\n    ProfileTrue --> ClosureCompiler\n    ProfileFalse --> ClosureCompiler\n    \n    ClosureCompiler --> FinalBundle["Final Bundle<br/>Optimized code"]\n```\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:1-121](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:1-92]()\n\n### Fork Selection Examples\n\nDifferent bundle types resolve to different forks:\n\n| Bundle Type | Fork Path | Purpose |\n|-------------|-----------|---------|\n| `FB_WWW` | `shared/forks/ReactFeatureFlags.www.js` | Facebook internal web |\n| `RN_FB` | `shared/forks/ReactFeatureFlags.native-fb.js` | React Native Facebook internal |\n| `RN_OSS` | `shared/forks/ReactFeatureFlags.native-oss.js` | React Native open source |\n| `NODE_DEV`, `NODE_PROD` | `shared/ReactFeatureFlags.js` | Node.js builds (base) |\n| `UMD_DEV`, `UMD_PROD` | `shared/ReactFeatureFlags.js` | Browser UMD builds (base) |\n\nFor test renderer builds, additional specialized forks are used:\n\n| Bundle Type | Fork Path |\n|-------------|-----------|\n| Test renderer (www) | `shared/forks/ReactFeatureFlags.test-renderer.www.js` |\n| Test renderer (native-fb) | `shared/forks/ReactFeatureFlags.test-renderer.native-fb.js` |\n| Test renderer (default) | `shared/forks/ReactFeatureFlags.test-renderer.js` |\n\n**Sources:** [packages/shared/forks/ReactFeatureFlags.www.js:1](), [packages/shared/forks/ReactFeatureFlags.native-fb.js:1](), [packages/shared/forks/ReactFeatureFlags.native-oss.js:1](), [packages/shared/forks/ReactFeatureFlags.test-renderer.www.js:1](), [packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js:1](), [packages/shared/forks/ReactFeatureFlags.test-renderer.js:1]()\n\n## Flag Consumption in Runtime Code\n\nRuntime code imports feature flags from `shared/ReactFeatureFlags` and the build system resolves this to the appropriate fork:\n\n```\nimport {\n  enableProfilerTimer,\n  enableSuspenseCallback,\n  enableTransitionTracing,\n  enableLegacyHidden,\n} from \'shared/ReactFeatureFlags\';\n```\n\nThe reconciler, renderers, and other systems check these flags to conditionally enable features:\n\n```javascript\nif (enableTransitionTracing) {\n  // Transition tracing logic\n}\n\nif (enableProfilerTimer) {\n  // Profiling timer logic\n}\n```\n\nAfter Babel macro replacement and Closure Compiler dead code elimination, only the active code path remains in the final bundle.\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:1-259]()\n\n## Special Flag Categories\n\n### Profiling Flags\n\nProfiling flags are controlled by the `__PROFILE__` macro and enable performance measurement features:\n\n| Flag | Purpose | Lines |\n|------|---------|-------|\n| `enableProfilerTimer` | Gather timing metrics for Profiler subtrees | [229]() |\n| `enableComponentPerformanceTrack` | Add performance.measure() marks for Chrome | [235]() |\n| `enableSchedulingProfiler` | User timing marks for experimental timeline | [244-245]() |\n| `enableProfilerCommitHooks` | Record commit phase durations | [248]() |\n| `enableProfilerNestedUpdatePhase` | Differentiate update vs cascading-update | [251]() |\n| `enableUpdaterTracking` | Track which Fibers schedule render work | [256]() |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:229, 235, 244-245, 248, 251, 256]()\n\n### Expiration and Timeout Flags\n\nThese flags control timing behaviors in the scheduler and reconciler:\n\n| Flag | Default Value | Purpose | Lines |\n|------|---------------|---------|-------|\n| `enableRetryLaneExpiration` | false | Enable expiration time for retry lanes | [137]() |\n| `retryLaneExpirationMs` | 5000 | Retry lane expiration timeout | [138]() |\n| `syncLaneExpirationMs` | 250 | Sync lane expiration timeout | [139]() |\n| `transitionLaneExpirationMs` | 5000 | Transition lane expiration timeout | [140]() |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:137-140]()\n\n### Legacy API Deprecation Flags\n\nFlags controlling the removal of legacy APIs:\n\n| Flag | Status | Purpose | Lines |\n|------|--------|---------|-------|\n| `disableLegacyContext` | Ready for major | Remove static contextTypes API | [177]() |\n| `disableLegacyContextForFunctionComponents` | Ready for major | Remove legacy context from function components only | [181]() |\n| `disableLegacyMode` | Ready for major | Remove legacy rendering mode | [195]() |\n| `enableLegacyHidden` | Slated for removal | Legacy hidden subtree API (FB-only) | [111]() |\n| `enableLegacyFBSupport` | Slated for removal | Legacy Primer support | [61]() |\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:177, 181, 195, 111, 61]()\n\n## Flag Naming Conventions\n\nThe codebase follows consistent naming conventions for feature flags:\n\n**Enable/Disable Prefix:**\n- `enable*`: Positive feature flags (e.g., `enableViewTransition`, `enableTaint`)\n- `disable*`: Negative feature flags for deprecations (e.g., `disableLegacyContext`, `disableClientCache`)\n\n**Lifecycle Indicators:**\n- Flags in "Slated for removal" section typically start with `enable` but are set to `false`\n- Flags in "Ready for next major" that deprecate features use `disable` prefix\n- Killswitch flags are typically feature enables that can be toggled to `false` for emergency rollback\n\n**Timing/Configuration Suffixes:**\n- `*Ms`: Millisecond timeouts (e.g., `retryLaneExpirationMs`)\n- `*Limit`: Numeric limits (e.g., `ownerStackLimit`)\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:1-259]()\n\n## Summary Table: All Feature Flags\n\n| Flag Name | Base | www | native-fb | native-oss | test-renderer | Category |\n|-----------|------|-----|-----------|------------|---------------|----------|\n| `enableHydrationLaneScheduling` | true | true | true | true | true | Killswitch |\n| `disableSchedulerTimeoutInWorkLoop` | false | dynamic | false | false | false | Land/remove (moderate) |\n| `enableSuspenseCallback` | false | true | true | false | false | Slated for removal |\n| `enableScopeAPI` | false | true | false | false | false | Slated for removal |\n| `enableCreateEventHandleAPI` | false | true | false | false | false | Slated for removal |\n| `enableLegacyFBSupport` | false | true | false | false | false | Slated for removal |\n| `enableYieldingBeforePassive` | false | false | false | false | true | Ongoing |\n| `enableThrottledScheduling` | false | false | false | false | false | Ongoing |\n| `enableLegacyCache` | __EXPERIMENTAL__ | true | false | false | __EXPERIMENTAL__ | Ongoing |\n| `enableTaint` | __EXPERIMENTAL__ | false | true | true | true | Ongoing |\n| `enableHalt` | true | true | true | true | true | Ongoing |\n| `enableViewTransition` | true | dynamic | false | true | false | Ongoing |\n| `disableLegacyContext` | true | __EXPERIMENTAL__ | false | true | true | Ready for major |\n| `disableLegacyMode` | true | true | false | false | true | Ready for major |\n| `renameElementSymbol` | true | dynamic | dynamic | true | false | Ready for major |\n\n**Sources:** All ReactFeatureFlags files listed above\n\n---\n\n# Page: Build System and Package Distribution\n\n# Build System and Package Distribution\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React\'s build system architecture, which compiles source code into distributable packages for multiple environments and platforms. The system uses Rollup as its core bundler, applies environment-specific transformations, and generates dozens of bundle variants from a shared codebase.\n\nFor information about feature flags that control which code is included in each build, see [Feature Flags System](#2). For details on how the built artifacts integrate with CI/CD, see [CI/CD and Artifact Management](#3.3).\n\n---\n\n## Build Pipeline Overview\n\nReact\'s build system transforms source files through a multi-stage pipeline, generating bundles for different environments (Node.js, browsers, React Native, Facebook internal) with different optimizations (development, production, profiling).\n\n### Build Orchestration Flow\n\n```mermaid\ngraph TB\n    CLI["yarn build<br/>(package.json:126)"]\n    BuildScript["scripts/rollup/build-all-release-channels.js"]\n    BuildCore["scripts/rollup/build.js"]\n    \n    CLI --> BuildScript\n    BuildScript --> BuildCore\n    \n    subgraph "Bundle Configuration"\n        BundlesJS["bundles.js<br/>Bundle definitions"]\n        ForksJS["forks.js<br/>Module replacements"]\n        HostConfigs["inlinedHostConfigs.js<br/>Platform mappings"]\n    end\n    \n    BuildCore --> BundlesJS\n    BuildCore --> ForksJS\n    BuildCore --> HostConfigs\n    \n    subgraph "Plugin Pipeline"\n        FlowRemoval["Flow Type Removal<br/>or TypeScript"]\n        Babel["Babel Transform<br/>getBabelConfig()"]\n        Replace["Replace Plugin<br/>__DEV__, __EXPERIMENTAL__"]\n        Closure["Closure Compiler<br/>SIMPLE mode"]\n        Prettier["Prettier<br/>Code formatting"]\n    end\n    \n    BuildCore --> FlowRemoval\n    FlowRemoval --> Babel\n    Babel --> Replace\n    Replace --> Closure\n    Closure --> Prettier\n    \n    subgraph "Output Generation"\n        Wrappers["wrappers.js<br/>Add headers & guards"]\n        OutputPath["packaging.js<br/>Determine output paths"]\n        Files["Build artifacts<br/>build/node_modules/"]\n    end\n    \n    Prettier --> Wrappers\n    Wrappers --> OutputPath\n    OutputPath --> Files\n```\n\n**Sources:** [scripts/rollup/build.js:1-700](), [package.json:126](), [scripts/rollup/bundles.js:1-100](), [scripts/rollup/forks.js:1-485](), [scripts/rollup/packaging.js:1-292](), [scripts/rollup/wrappers.js:1-300]()\n\n---\n\n## Bundle Type System\n\nThe build system generates multiple bundle types from the same source code. Each bundle type represents a combination of environment, module format, and optimization level.\n\n### Bundle Type Definitions\n\n| Bundle Type | Module Format | Environment | Description |\n|------------|---------------|-------------|-------------|\n| `NODE_DEV` | CommonJS | Node.js | Development build with full error messages |\n| `NODE_PROD` | CommonJS | Node.js | Production build with minified errors |\n| `NODE_PROFILING` | CommonJS | Node.js | Production with profiling instrumentation |\n| `NODE_ES2015` | CommonJS | Node.js | ES2015+ syntax preserved |\n| `ESM_DEV` | ES Modules | Browser/Node | Development ES modules |\n| `ESM_PROD` | ES Modules | Browser/Node | Production ES modules |\n| `BUN_DEV` | CommonJS | Bun runtime | Development for Bun |\n| `BUN_PROD` | CommonJS | Bun runtime | Production for Bun |\n| `FB_WWW_DEV` | CommonJS | Facebook web | Facebook development build |\n| `FB_WWW_PROD` | CommonJS | Facebook web | Facebook production build |\n| `FB_WWW_PROFILING` | CommonJS | Facebook web | Facebook profiling build |\n| `RN_OSS_DEV` | CommonJS | React Native OSS | RN open source development |\n| `RN_OSS_PROD` | CommonJS | React Native OSS | RN open source production |\n| `RN_OSS_PROFILING` | CommonJS | React Native OSS | RN open source profiling |\n| `RN_FB_DEV` | CommonJS | React Native FB | RN internal development |\n| `RN_FB_PROD` | CommonJS | React Native FB | RN internal production |\n| `RN_FB_PROFILING` | CommonJS | React Native FB | RN internal profiling |\n| `BROWSER_SCRIPT` | IIFE | Browser | Standalone browser script |\n| `CJS_DTS` | CommonJS | TypeScript | Type definitions for CJS |\n| `ESM_DTS` | ES Modules | TypeScript | Type definitions for ESM |\n\n**Sources:** [scripts/rollup/bundles.js:10-54](), [scripts/rollup/build.js:50-71]()\n\n### Bundle Configuration Structure\n\n```mermaid\ngraph LR\n    Bundle["Bundle Object"]\n    \n    Bundle --> Entry["entry<br/>\'react\' or \'react-dom\'"]\n    Bundle --> BundleTypes["bundleTypes[]<br/>NODE_DEV, NODE_PROD, etc."]\n    Bundle --> ModuleType["moduleType<br/>ISOMORPHIC, RENDERER, etc."]\n    Bundle --> Global["global<br/>\'React\' or \'ReactDOM\'"]\n    Bundle --> Externals["externals[]<br/>Dependencies"]\n    Bundle --> MinifyFlag["minifyWithProdErrorCodes<br/>boolean"]\n    Bundle --> WrapFlag["wrapWithModuleBoundaries<br/>boolean"]\n    Bundle --> Condition["condition<br/>\'react-server\' or undefined"]\n    \n    ModuleType --> ISOMORPHIC["ISOMORPHIC<br/>Core React package"]\n    ModuleType --> RENDERER["RENDERER<br/>ReactDOM, ReactNative"]\n    ModuleType --> RECONCILER["RECONCILER<br/>react-reconciler"]\n    ModuleType --> RENDERER_UTILS["RENDERER_UTILS<br/>TestUtils, plugins"]\n```\n\n**Sources:** [scripts/rollup/bundles.js:56-68](), [scripts/rollup/bundles.js:69-885]()\n\n---\n\n## Module Forking Mechanism\n\nThe forking system allows different modules to be substituted based on the target environment. This enables shipping different implementations of the same interface to different platforms without runtime checks.\n\n### Fork Resolution Process\n\n```mermaid\ngraph TB\n    ImportStmt["Import Statement<br/>import X from \'shared/ReactFeatureFlags\'"]\n    \n    ForksConfig["forks.js<br/>Fork definitions"]\n    ImportStmt --> ForksConfig\n    \n    ForksConfig --> BundleCheck{"Check bundleType"}\n    \n    BundleCheck -->|"FB_WWW_*"| WWWFork["ReactFeatureFlags.www.js"]\n    BundleCheck -->|"RN_FB_*"| NativeFBFork["ReactFeatureFlags.native-fb.js"]\n    BundleCheck -->|"RN_OSS_*"| NativeOSSFork["ReactFeatureFlags.native-oss.js"]\n    BundleCheck -->|"Other"| Default["ReactFeatureFlags.js"]\n    \n    WWWFork --> Plugin["useForks plugin<br/>Replaces module path"]\n    NativeFBFork --> Plugin\n    NativeOSSFork --> Plugin\n    Default --> Plugin\n    \n    Plugin --> RollupBundle["Final bundle with<br/>correct module"]\n```\n\n### Key Forked Modules\n\n| Source Module | Purpose | Fork Variants |\n|--------------|---------|---------------|\n| `ReactFeatureFlags.js` | Feature flag definitions | `www.js`, `native-fb.js`, `native-oss.js`, `test-renderer.js` |\n| `ReactSharedInternals.js` | Shared state object | `ReactSharedInternalsClient.js`, `ReactSharedInternalsServer.js` |\n| `ReactFiberConfig.js` | Renderer host config | Platform-specific implementations (dom, native, etc.) |\n| `ReactFlightServerConfig.js` | Flight server config | `dom`, `webpack`, `turbopack`, `parcel`, etc. |\n| `ReactFlightClientConfig.js` | Flight client config | Platform-specific client implementations |\n| `EventListener.js` | Event attachment | `EventListener-www.js` for Facebook |\n\n**Sources:** [scripts/rollup/forks.js:52-482](), [scripts/rollup/build.js:398](), [scripts/rollup/modules.js:64-81]()\n\n### Fork Function Signature\n\nEach entry in `forks.js` is a function that receives context and returns the replacement path:\n\n```\n(bundleType, entry, dependencies, moduleType, bundle) => string | Error | null\n```\n\n- Returns `null` if no fork is needed\n- Returns a file path string to replace the module\n- Returns an Error object for modules that should error if imported\n\n**Sources:** [scripts/rollup/forks.js:52-89](), [scripts/rollup/modules.js:64-81]()\n\n---\n\n## Host Configuration System\n\nHost configs define platform-specific behavior for renderers. The `inlinedHostConfigs.js` file maps entry points to platform implementations.\n\n### Host Config Structure\n\n```mermaid\ngraph TB\n    Entry["Entry Point<br/>react-dom"]\n    \n    HostConfig["inlinedHostConfigs.js<br/>Configuration array"]\n    Entry --> HostConfig\n    \n    HostConfig --> ShortName["shortName<br/>\'dom-browser\', \'dom-node\', etc."]\n    HostConfig --> EntryPoints["entryPoints[]<br/>Associated entry points"]\n    HostConfig --> Paths["paths[]<br/>Included source paths"]\n    HostConfig --> Flags["Feature flags<br/>isServerSupported, isFlightSupported"]\n    \n    ShortName --> FiberConfig["ReactFiberConfig.{shortName}.js"]\n    ShortName --> FizzConfig["ReactFizzConfig.{shortName}.js"]\n    ShortName --> FlightServerConfig["ReactFlightServerConfig.{shortName}.js"]\n    ShortName --> FlightClientConfig["ReactFlightClientConfig.{shortName}.js"]\n    \n    FiberConfig --> FindFork["findNearestExistingForkFile()<br/>Segment matching"]\n    FizzConfig --> FindFork\n    FlightServerConfig --> FindFork\n    FlightClientConfig --> FindFork\n    \n    FindFork --> Segments["Try segments:<br/>\'dom-browser\'<br/>\'dom\'<br/>until match found"]\n```\n\n### Host Config Examples\n\n| Short Name | Entry Points | Server Support | Flight Support |\n|-----------|--------------|----------------|----------------|\n| `dom-browser` | `react-dom`, `react-dom/client` | Yes | Yes |\n| `dom-node` | `react-dom/server.node` | Yes | Yes |\n| `dom-edge` | `react-dom/server.edge` | Yes | Yes |\n| `dom-bun` | `react-dom/server.bun` | Yes | Yes |\n| `native-fb` | `react-native-renderer` | No | No |\n| `native-oss` | `react-native-renderer` | No | No |\n\n**Sources:** [scripts/shared/inlinedHostConfigs.js:9-500](), [scripts/rollup/forks.js:242-436]()\n\n### Segmented Fork Resolution\n\nThe `findNearestExistingForkFile` function implements a fallback mechanism:\n\n```mermaid\ngraph LR\n    Start["Host config:<br/>\'dom-browser\'"]\n    \n    Start --> Try1["Try: ReactFiberConfig.dom-browser.js"]\n    Try1 -->|exists| Use1["Use this file"]\n    Try1 -->|not found| Try2["Try: ReactFiberConfig.dom.js"]\n    Try2 -->|exists| Use2["Use this file"]\n    Try2 -->|not found| Error["Throw error:<br/>No fork found"]\n```\n\n**Sources:** [scripts/rollup/forks.js:29-43]()\n\n---\n\n## Plugin Pipeline\n\nThe build system applies a series of Rollup plugins to transform source code. The order is critical for correctness.\n\n### Plugin Execution Sequence\n\n```mermaid\ngraph TB\n    Source["Source Files<br/>.js, .ts files"]\n    \n    Source --> Dynamic["dynamicImports()<br/>Keep dynamic imports external"]\n    \n    Dynamic --> TypeCheck{"Has tsconfig?"}\n    TypeCheck -->|Yes| TS["typescript plugin<br/>Compile TypeScript"]\n    TypeCheck -->|No| Flow["flowRemoveTypes<br/>Strip Flow annotations"]\n    \n    TS --> CommonJS["commonjs plugin<br/>Handle CJS modules"]\n    Flow --> CommonJS\n    \n    CommonJS --> Forks["useForks()<br/>Module replacement"]\n    Forks --> Forbid["forbidFBJSImports()<br/>Prevent fbjs imports"]\n    Forbid --> Resolve["resolve plugin<br/>Node resolution"]\n    \n    Resolve --> Strip["stripBanner()<br/>Remove license headers"]\n    Strip --> BabelPlugin["babel()<br/>ES6+ transformation"]\n    \n    BabelPlugin --> StrictRemove["Remove \'use strict\'<br/>String replacement"]\n    StrictRemove --> ReplacePlugin["replace()<br/>__DEV__, __EXPERIMENTAL__"]\n    \n    ReplacePlugin --> External["externalRuntime()<br/>Fizz runtime transform"]\n    External --> TopLevel["Top-level definitions<br/>Wrappers"]\n    \n    TopLevel --> ClosureCheck{"Needs Closure?"}\n    ClosureCheck -->|Yes| ClosurePlugin["closure()<br/>SIMPLE compilation"]\n    ClosureCheck -->|No| Skip["Skip"]\n    \n    ClosurePlugin --> PrettierPlugin["prettier()<br/>Reformat code"]\n    Skip --> PrettierPlugin\n    \n    PrettierPlugin --> License["License header<br/>Wrappers"]\n    License --> Sizes["sizes()<br/>Record bundle size"]\n    \n    Sizes --> Output["Final Bundle"]\n```\n\n**Sources:** [scripts/rollup/build.js:354-546]()\n\n### Babel Configuration\n\nThe Babel plugin applies different transformations based on bundle type and development mode:\n\n```mermaid\ngraph LR\n    GetBabelConfig["getBabelConfig()"]\n    \n    GetBabelConfig --> Base["Base plugins:<br/>class-properties<br/>object-rest-spread<br/>template-literals<br/>transform-spread<br/>etc."]\n    \n    Base --> DevCheck{"isDevelopment?"}\n    DevCheck -->|Yes| ES5["Add ES5 plugins:<br/>arrow-functions<br/>block-scoping<br/>shorthand-properties<br/>etc."]\n    DevCheck -->|No| Skip["Skip ES5<br/>(Closure handles)"]\n    \n    ES5 --> ErrorCheck{"minifyWithProdErrorCodes?"}\n    Skip --> ErrorCheck\n    ErrorCheck -->|Yes & Prod| Errors["transform-error-messages<br/>Replace with codes"]\n    ErrorCheck -->|No| NoErrors["Keep full messages"]\n```\n\n**Sources:** [scripts/rollup/build.js:143-172](), [scripts/rollup/build.js:111-141]()\n\n---\n\n## Package Output Structure\n\nBuilt artifacts are organized into a specific directory structure for npm distribution and internal use.\n\n### Output Directory Layout\n\n```mermaid\ngraph TB\n    Build["build/"]\n    \n    Build --> NodeModules["node_modules/"]\n    Build --> Facebook["facebook-www/"]\n    Build --> ReactNative["react-native/"]\n    \n    NodeModules --> ReactPkg["react/"]\n    NodeModules --> ReactDOMPkg["react-dom/"]\n    NodeModules --> OtherPkgs["Other packages..."]\n    \n    ReactPkg --> ReactCJS["cjs/<br/>CommonJS builds"]\n    ReactPkg --> ReactFiles["index.js<br/>jsx-runtime.js<br/>compiler-runtime.js"]\n    \n    ReactDOMPkg --> DOMCJS["cjs/<br/>CommonJS builds"]\n    ReactDOMPkg --> DOMESM["esm/<br/>ESM builds (if any)"]\n    ReactDOMPkg --> DOMFiles["index.js<br/>client.js<br/>server.node.js<br/>server.browser.js"]\n    \n    Facebook --> Shims["shims/<br/>Facebook-specific"]\n    Facebook --> WWWFiles["React-www.js<br/>ReactDOM-www.js"]\n    \n    ReactNative --> Implementations["implementations/<br/>RN renderer files"]\n    ReactNative --> RNShims["shims/<br/>RN-specific"]\n```\n\n**Sources:** [scripts/rollup/packaging.js:48-114]()\n\n### Path Determination Logic\n\nThe `getBundleOutputPath` function maps bundle configuration to output paths:\n\n| Bundle Type | Package Name | Output Path Pattern |\n|------------|--------------|-------------------|\n| `NODE_DEV`, `NODE_PROD`, `NODE_PROFILING` | Any | `build/node_modules/{pkg}/cjs/{filename}` |\n| `ESM_DEV`, `ESM_PROD` | Any | `build/node_modules/{pkg}/esm/{filename}` |\n| `FB_WWW_*` | Any | `build/facebook-www/{filename}` |\n| `RN_OSS_*` | `react-native-renderer` | `build/react-native/implementations/{filename}` |\n| `RN_FB_*` | `react-native-renderer` | `build/react-native/implementations/{filename}.fb.js` |\n| `RN_FB_*` | Other | `build/facebook-react-native/{pkg}/cjs/{filename}` |\n| `BROWSER_SCRIPT` | Any | `build/node_modules/{pkg}/{bundle.outputPath}` |\n\n**Sources:** [scripts/rollup/packaging.js:48-115]()\n\n---\n\n## Npm Package Preparation\n\nAfter building, packages must be prepared for npm publication. This involves copying metadata files, filtering entry points, and creating tarballs.\n\n### Package Preparation Flow\n\n```mermaid\ngraph TB\n    PrepareNpm["prepareNpmPackages()"]\n    \n    PrepareNpm --> Scan["Scan build/node_modules/<br/>for packages"]\n    \n    Scan --> ForEach["For each package:"]\n    \n    ForEach --> Copy["Copy files:<br/>LICENSE<br/>package.json<br/>README.md<br/>npm/ contents"]\n    \n    Copy --> Filter["filterOutEntrypoints()<br/>Remove unbundled entry points"]\n    \n    Filter --> ReadPkg["Read package.json"]\n    ReadPkg --> CheckFiles["Check files[] array"]\n    \n    CheckFiles --> CheckBundle{"Entry point<br/>has bundle?"}\n    CheckBundle -->|Yes| Keep["Keep in files[]"]\n    CheckBundle -->|No| Remove["Remove from files[]<br/>Delete file<br/>Remove from exports{}"]\n    \n    Remove --> UpdatePkg["Write updated package.json"]\n    Keep --> UpdatePkg\n    \n    UpdatePkg --> Pack["npm pack<br/>Create .tgz"]\n    Pack --> Extract["Extract tarball<br/>Strip \'package/\' prefix"]\n    Extract --> Cleanup["Delete .tgz"]\n```\n\n**Sources:** [scripts/rollup/packaging.js:253-284](), [scripts/rollup/packaging.js:171-251]()\n\n### Entry Point Filtering\n\nThe `filterOutEntrypoints` function uses a map to determine which entry points should exist:\n\n```mermaid\ngraph LR\n    EntryMap["entryPointsToHasBundle<br/>Map<entry, boolean>"]\n    \n    EntryMap --> BuildMap["Built during bundle<br/>iteration"]\n    \n    BuildMap --> Check["For each file<br/>in package.json:"]\n    \n    Check --> EntryName["Convert filename<br/>to entry name"]\n    EntryName --> Lookup["Look up in map"]\n    \n    Lookup --> HasBundle{"Has bundle in<br/>this channel?"}\n    HasBundle -->|true| Keep["Keep file"]\n    HasBundle -->|false| RemoveFile["Remove from package"]\n    HasBundle -->|undefined| ExtraFile["Extra file<br/>(keep)"]\n    \n    RemoveFile --> UpdateExports["Update exports field"]\n    RemoveFile --> UpdateBrowser["Update browser field"]\n```\n\n**Sources:** [scripts/rollup/packaging.js:158-251]()\n\n---\n\n## Code Wrapping and Headers\n\nDifferent bundle types require different code wrappers, headers, and guards. The `wrappers.js` module handles this transformation.\n\n### Wrapper Application\n\n```mermaid\ngraph TB\n    Source["Rollup output"]\n    \n    Source --> TopLevel["wrapWithTopLevelDefinitions()<br/>Bundle-type specific wrapper"]\n    \n    TopLevel --> DevGuard{"Is development<br/>bundle?"}\n    \n    DevGuard -->|NODE_DEV| NodeDev["Wrap in:<br/>if (process.env.NODE_ENV !== \'production\')"]\n    DevGuard -->|FB_WWW_DEV| WWWDev["Wrap in:<br/>if (__DEV__)"]\n    DevGuard -->|RN_*_DEV| RNDev["Wrap in:<br/>if (__DEV__)"]\n    DevGuard -->|Production| NoProd["No guard needed"]\n    \n    NodeDev --> DevTools["wrapWithRegisterInternalModule()<br/>DevTools registration"]\n    WWWDev --> DevTools\n    RNDev --> DevTools\n    NoProd --> ProdCheck{"wrapWithModule<br/>Boundaries?"}\n    \n    DevTools --> ProdCheck\n    ProdCheck -->|Yes| ModuleBoundary["Add __REACT_DEVTOOLS_GLOBAL_HOOK__<br/>registration calls"]\n    ProdCheck -->|No| Skip["Skip"]\n    \n    ModuleBoundary --> License["wrapWithLicenseHeader()<br/>Add copyright header"]\n    Skip --> License\n    \n    License --> Final["Final bundle code"]\n```\n\n**Sources:** [scripts/rollup/wrappers.js:32-50](), [scripts/rollup/wrappers.js:58-169](), [scripts/rollup/build.js:446-520]()\n\n### License Header Format\n\nAll bundles include a standard MIT license header:\n\n```\n/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n```\n\n**Sources:** [scripts/rollup/wrappers.js:53-56]()\n\n---\n\n## Bundle Type-Specific Behaviors\n\nDifferent bundle types have unique compilation and optimization requirements.\n\n### Development vs Production Differences\n\n| Aspect | Development | Production |\n|--------|------------|------------|\n| `__DEV__` constant | `true` | `false` |\n| Error messages | Full text | Error codes (minified) |\n| Babel plugins | Full ES5 transform | Minimal (Closure handles) |\n| Closure Compiler | Not used | SIMPLE mode |\n| Guard wrappers | `if (process.env.NODE_ENV !== "production")` | None |\n| Source maps | Not generated | Not generated |\n\n**Sources:** [scripts/rollup/build.js:253-280](), [scripts/rollup/build.js:432-442](), [scripts/rollup/build.js:469-500]()\n\n### Profiling Bundles\n\nProfiling bundles are production builds with the `__PROFILE__` flag set to `true`. They include:\n\n- All production optimizations\n- Additional performance tracking code\n- Profiler hooks enabled\n\n**Sources:** [scripts/rollup/build.js:283-310](), [scripts/rollup/build.js:432-442]()\n\n### Facebook Internal Bundles\n\nFacebook bundles (`FB_WWW_*` and `RN_FB_*`) have special characteristics:\n\n- Use different feature flag forks (`ReactFeatureFlags.www.js`, `ReactFeatureFlags.native-fb.js`)\n- Support dynamic flags via `__VARIANT__` or external gatekeeper systems\n- May use Facebook-specific event listener wrappers\n- Output to separate directories (`facebook-www/`, `facebook-react-native/`)\n\n**Sources:** [scripts/rollup/bundles.js:19-21](), [scripts/rollup/forks.js:180-188](), [scripts/rollup/packaging.js:64-94]()\n\n---\n\n## Build Commands and Workflow\n\nThe monorepo provides several build commands for different use cases.\n\n### Primary Build Commands\n\n| Command | Description | Implementation |\n|---------|-------------|----------------|\n| `yarn build` | Build all release channels | [package.json:126]()  `build-all-release-channels.js` |\n| `yarn build --type=NODE` | Build only Node bundles | [scripts/rollup/build.js:94-98]() |\n| `yarn build react/index,react-dom/index` | Build specific entry points | [scripts/rollup/build.js:100-104]() |\n| `yarn build --watch` | Watch mode for development | [scripts/rollup/build.js:106]() |\n\n**Sources:** [package.json:124-157](), [scripts/rollup/build.js:94-106]()\n\n### Specialized Build Targets\n\n```mermaid\ngraph LR\n    BuildCommands["Build Commands"]\n    \n    BuildCommands --> DevTools["build-for-devtools<br/>Subset for DevTools testing"]\n    BuildCommands --> Flight["build-for-flight-dev<br/>Server Components dev"]\n    BuildCommands --> VT["build-for-vt-dev<br/>View Transitions dev"]\n    \n    DevTools --> Subset1["react, react-dom,<br/>react-is, scheduler,<br/>react-test-renderer"]\n    Flight --> Subset2["react, react-dom,<br/>react-server-dom-*"]\n    VT --> Subset3["react, react-dom,<br/>server bundles"]\n```\n\n**Sources:** [package.json:127-131]()\n\n---\n\n## Module Resolution and Dependencies\n\nThe build system needs to resolve modules and determine dependencies for bundling.\n\n### Dependency Resolution\n\n```mermaid\ngraph TB\n    Entry["Bundle entry point"]\n    \n    Entry --> GetDeps["getDependencies()<br/>modules.js"]\n    \n    GetDeps --> LoadPkg["Load package.json<br/>for entry point"]\n    \n    LoadPkg --> Extract["Extract:<br/>dependencies{}<br/>peerDependencies{}"]\n    \n    Extract --> Merge["Merge into<br/>single array"]\n    \n    Merge --> Externals["Mark as external<br/>in Rollup config"]\n    \n    Externals --> Bundle["Bundle generation<br/>(external deps excluded)"]\n```\n\n**Sources:** [scripts/rollup/modules.js:50-61](), [scripts/rollup/build.js:653-654]()\n\n### Global Variable Mapping\n\nFor bundles that expose globals (UMD-style), the system maps package names to global variables:\n\n| Package Name | Global Variable |\n|-------------|-----------------|\n| `react` | `React` |\n| `react-dom` | `ReactDOM` |\n| `react-dom/server` | `ReactDOMServer` |\n| `scheduler` | `Scheduler` |\n| `scheduler/unstable_mock` | `SchedulerMock` |\n\n**Sources:** [scripts/rollup/modules.js:31-38](), [scripts/rollup/build.js:650]()\n\n---\n\n## Build Validation\n\nAfter building, the system validates the output to catch build pipeline bugs.\n\n### Validation Process\n\n```mermaid\ngraph TB\n    Validate["yarn lint-build"]\n    \n    Validate --> Scan["Scan build/ directory<br/>for .js files"]\n    \n    Scan --> Categorize{"Determine<br/>bundle type"}\n    \n    Categorize --> CJS["CJS bundles<br/>eslintrc.cjs.js"]\n    Categorize --> CJS2015["CJS ES2015 bundles<br/>eslintrc.cjs2015.js"]\n    Categorize --> ESM["ESM bundles<br/>eslintrc.esm.js"]\n    Categorize --> FB["FB bundles<br/>eslintrc.fb.js"]\n    Categorize --> RN["RN bundles<br/>eslintrc.rn.js"]\n    \n    CJS --> ESLint["Run ESLint<br/>with config"]\n    CJS2015 --> ESLint\n    ESM --> ESLint\n    FB --> ESLint\n    RN --> ESLint\n    \n    ESLint --> Check["Check for:<br/>- Undefined globals<br/>- Invalid syntax<br/>- Closure artifacts"]\n    \n    Check --> Report["Report errors"]\n```\n\n**Sources:** [scripts/rollup/validate/index.js:1-100](), [package.json:135]()\n\n### Validation Rules\n\nEach bundle type has specific global variables and syntax requirements:\n\n- **CJS**: ES2020 features, Node.js globals (`process`, `Buffer`)\n- **CJS ES2015**: ES2015+ features, Node.js globals\n- **ESM**: ES2020 features, module syntax\n- **FB**: ES5 syntax, `__DEV__` global\n- **RN**: ES5 syntax, React Native globals (`nativeFabricUIManager`)\n\n**Sources:** [scripts/rollup/validate/eslintrc.cjs.js:1-111](), [scripts/rollup/validate/eslintrc.fb.js:1-100](), [scripts/rollup/validate/eslintrc.rn.js:1-96]()\n\n---\n\n## Environment-Specific Entry Points\n\nReact packages use conditional exports and entry point suffixes to select the correct implementation.\n\n### Entry Point Fork Resolution\n\n```mermaid\ngraph TB\n    Entry["Bundle entry:<br/>react-dom"]\n    \n    Entry --> Resolve["require.resolve()<br/>Get full path"]\n    \n    Resolve --> Fork["resolveEntryFork()"]\n    \n    Fork --> IsFB{"Is Facebook<br/>bundle?"}\n    \n    IsFB -->|Yes| TryModern["Try: .modern.fb.js<br/>(if experimental)"]\n    IsFB -->|No| TryChannel["Try: .experimental.js<br/>or .stable.js"]\n    \n    TryModern --> ExistsModern{"File exists?"}\n    ExistsModern -->|Yes| UseModern["Use modern FB fork"]\n    ExistsModern -->|No| TryClassic["Try: .classic.fb.js<br/>or .fb.js"]\n    \n    TryClassic --> UseClassic["Use if exists<br/>else try channel fork"]\n    \n    TryChannel --> UseChannel["Use channel fork<br/>or fallback to .js"]\n    \n    UseModern --> DevCheck{"Is development?"}\n    UseClassic --> DevCheck\n    UseChannel --> DevCheck\n    \n    DevCheck -->|Yes| TryDev["Try: .development.js"]\n    DevCheck -->|No| UseProd["Use production file"]\n    \n    TryDev --> FinalEntry["Resolved entry path"]\n    UseProd --> FinalEntry\n```\n\n**Sources:** [scripts/rollup/build.js:585-633]()\n\n### Conditional Exports in package.json\n\nReact packages use Node.js conditional exports to select implementations:\n\n```json\n{\n  "exports": {\n    ".": {\n      "react-server": "./react.react-server.js",\n      "default": "./index.js"\n    },\n    "./server": {\n      "react-server": "./server.react-server.js",\n      "workerd": "./server.edge.js",\n      "bun": "./server.bun.js",\n      "node": "./server.node.js",\n      "browser": "./server.browser.js",\n      "default": "./server.node.js"\n    }\n  }\n}\n```\n\n**Sources:** [packages/react-dom/package.json:51-125](), [packages/react/package.json:24-43]()\n\n---\n\n## Summary\n\nReact\'s build system is a sophisticated multi-stage pipeline that:\n\n1. **Reads configuration** from `bundles.js`, `forks.js`, and `inlinedHostConfigs.js`\n2. **Processes source files** through TypeScript/Flow removal, Babel, and Closure Compiler\n3. **Applies environment-specific forks** to swap modules based on target platform\n4. **Generates dozens of bundle variants** for different environments and optimization levels\n5. **Wraps code** with appropriate headers, guards, and DevTools registration\n6. **Organizes output** into platform-specific directory structures\n7. **Prepares npm packages** by filtering entry points and creating tarballs\n8. **Validates output** using ESLint to catch build pipeline errors\n\nThe system enables React to maintain a single codebase while shipping optimized, platform-specific implementations to Node.js, browsers, React Native, and Facebook\'s internal infrastructure.\n\n---\n\n# Page: Build Pipeline and Module Forking\n\n# Build Pipeline and Module Forking\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/react-reconciler/src/ReactFiberOffscreenComponent.js](packages/react-reconciler/src/ReactFiberOffscreenComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React\'s build system architecture, which transforms the monorepo\'s source code into distributable packages for different environments and platforms. The build pipeline uses Rollup to generate hundreds of bundle variants from shared source code, employing a sophisticated module forking mechanism to adapt behavior for specific deployment targets (Facebook internal, React Native, Node.js, browsers, etc.) without maintaining separate codebases.\n\nFor information about feature flags that control which features are enabled in each environment, see [Feature Flags System](#2). For details on release channels and versioning, see [Release Channels and Versioning](#3.2). For CI/CD and artifact preparation, see [CI/CD and Artifact Management](#3.3).\n\n---\n\n## Build System Architecture\n\nThe React build system is orchestrated by [scripts/rollup/build.js]() and centers around three core concepts:\n\n1. **Bundle Definitions** - Configurations specifying entry points, target environments, and module formats\n2. **Module Forking** - Environment-specific module replacement\n3. **Plugin Pipeline** - Sequential transformations applied to source code\n\n### Bundle Configuration System\n\nBundle definitions in [scripts/rollup/bundles.js:69-1244]() specify all possible build outputs. Each bundle configuration contains:\n\n| Property | Purpose |\n|----------|---------|\n| `bundleTypes` | Array of target bundle types (NODE_DEV, FB_WWW_PROD, etc.) |\n| `moduleType` | Classification (ISOMORPHIC, RENDERER, RECONCILER, RENDERER_UTILS) |\n| `entry` | Source entry point path |\n| `global` | Global variable name for UMD/IIFE bundles |\n| `externals` | External dependencies not to bundle |\n| `minifyWithProdErrorCodes` | Whether to replace error messages with codes in production |\n| `wrapWithModuleBoundaries` | Whether to wrap with module boundary markers |\n\n**Bundle Types by Environment**\n\n```mermaid\ngraph TB\n    subgraph "Module Formats"\n        CJS["CommonJS<br/>(NODE_DEV/PROD/PROFILING)"]\n        ESM["ES Modules<br/>(ESM_DEV/PROD)"]\n        IIFE["IIFE<br/>(BROWSER_SCRIPT)"]\n        ES2015["ES2015<br/>(NODE_ES2015)"]\n    end\n    \n    subgraph "Facebook Internal"\n        FBWWW["FB WWW<br/>(FB_WWW_DEV/PROD/PROFILING)"]\n        RNFB["RN Facebook<br/>(RN_FB_DEV/PROD/PROFILING)"]\n    end\n    \n    subgraph "Open Source"\n        BUN["Bun Runtime<br/>(BUN_DEV/PROD)"]\n        RNOSS["RN OSS<br/>(RN_OSS_DEV/PROD/PROFILING)"]\n    end\n    \n    subgraph "TypeScript"\n        CJSDTS["CJS Type Defs<br/>(CJS_DTS)"]\n        ESMDTS["ESM Type Defs<br/>(ESM_DTS)"]\n    end\n```\n\nSources: [scripts/rollup/bundles.js:10-54]()\n\n---\n\n## Module Forking Mechanism\n\nModule forking allows React to replace specific modules with environment-specific implementations at build time. The forking system is defined in [scripts/rollup/forks.js:52-482]().\n\n### Fork Resolution Process\n\n```mermaid\ngraph TB\n    ImportRequest["Import Request<br/>(\'./packages/shared/ReactFeatureFlags.js\')"]\n    \n    GetForks["getForks()<br/>[modules.js:64-81]"]\n    \n    LookupFork["Lookup in forks map<br/>[forks.js:52]"]\n    \n    EvalFunction["Evaluate fork function<br/>(bundleType, entry, deps, moduleType, bundle)"]\n    \n    Decision{Fork<br/>Applies?}\n    \n    ReturnFork["Return fork path<br/>e.g., ReactFeatureFlags.www.js"]\n    \n    ReturnNull["Return null<br/>(use original)"]\n    \n    ApplyFork["useForks plugin applies replacement<br/>[plugins/use-forks-plugin.js]"]\n    \n    ImportRequest --> GetForks\n    GetForks --> LookupFork\n    LookupFork --> EvalFunction\n    EvalFunction --> Decision\n    Decision -->|"Yes"| ReturnFork\n    Decision -->|"No"| ReturnNull\n    ReturnFork --> ApplyFork\n```\n\nSources: [scripts/rollup/forks.js:52-482](), [scripts/rollup/modules.js:64-81]()\n\n### Critical Forked Modules\n\n**ReactFeatureFlags.js**\n\nThe feature flags module has environment-specific forks:\n\n- `ReactFeatureFlags.www.js` - Facebook web builds\n- `ReactFeatureFlags.native-fb.js` - Facebook React Native builds\n- `ReactFeatureFlags.native-oss.js` - Open source React Native builds\n- `ReactFeatureFlags.test-renderer.js` - Test renderer builds\n\nFork logic: [scripts/rollup/forks.js:134-191]()\n\n**ReactFiberConfig.js (Host Configuration)**\n\nThis module provides the host environment abstraction for the reconciler. Different renderers have different implementations:\n\n```mermaid\ngraph LR\n    ReactFiberConfig["ReactFiberConfig.js<br/>(abstract interface)"]\n    \n    subgraph "Fork Resolution"\n        FindRenderer["Find renderer in<br/>inlinedHostConfigs"]\n        BuildPath["Build fork path<br/>ReactFiberConfig.{shortName}.js"]\n        TrySegments["Try segmented names<br/>dom-browser  dom"]\n    end\n    \n    subgraph "Implementations"\n        DOMBrowser["ReactFiberConfig.dom-browser.js<br/>(Browser DOM)"]\n        DOMNode["ReactFiberConfig.dom-node.js<br/>(Node.js SSR)"]\n        NativeFB["ReactFiberConfig.native-fb.js<br/>(RN Facebook)"]\n        NativeOSS["ReactFiberConfig.native-oss.js<br/>(RN OSS)"]\n        Test["ReactFiberConfig.test.js<br/>(Test renderer)"]\n    end\n    \n    ReactFiberConfig --> FindRenderer\n    FindRenderer --> BuildPath\n    BuildPath --> TrySegments\n    TrySegments --> DOMBrowser\n    TrySegments --> DOMNode\n    TrySegments --> NativeFB\n    TrySegments --> NativeOSS\n    TrySegments --> Test\n```\n\nFork logic: [scripts/rollup/forks.js:242-274]()\n\nThe `findNearestExistingForkFile` function [scripts/rollup/forks.js:29-43]() tries progressively shorter segment combinations:\n- `ReactFiberConfig.dom-browser.js`\n- `ReactFiberConfig.dom.js`\n- (fallback to error if none found)\n\n**ReactSharedInternals.js**\n\nForked to prevent circular dependencies when the `react` package imports shared internals:\n\n- Inside `react` package  uses `ReactSharedInternalsClient.js`\n- Inside `react-server` condition  uses `ReactSharedInternalsServer.js`\n- Other packages  uses default `ReactSharedInternals.js`\n\nFork logic: [scripts/rollup/forks.js:55-89]()\n\n**Server Configuration Modules**\n\nThree related config modules for server rendering:\n\n| Module | Purpose | Fork Examples |\n|--------|---------|---------------|\n| `ReactServerStreamConfig.js` | Stream handling | `ReactServerStreamConfig.dom-browser.js` |\n| `ReactFizzConfig.js` | HTML rendering (Fizz) | `ReactFizzConfig.dom-node.js` |\n| `ReactFlightServerConfig.js` | Server Components (Flight) | `ReactFlightServerConfig.dom-node-webpack.js` |\n\nFork logic: [scripts/rollup/forks.js:276-392]()\n\n---\n\n## Entry Point Forking\n\nBeyond module forking, the build system also forks entire entry points based on environment and release channel.\n\n### Entry Fork Resolution Algorithm\n\n```mermaid\ngraph TB\n    Start["resolveEntryFork()<br/>[build.js:585-633]"]\n    \n    IsFB{Is FB<br/>Bundle?}\n    \n    TryModernClassic["Try .modern.fb.js or .classic.fb.js<br/>(based on __EXPERIMENTAL__)"]\n    \n    TryGenericFB["Try .fb.js"]\n    \n    TryExperimentalStable["Try .experimental.js or .stable.js<br/>(based on __EXPERIMENTAL__)"]\n    \n    UsePlain["Use plain .js"]\n    \n    CheckDev{Is<br/>DEV?}\n    \n    TryDevVariant["Try .development.js variant<br/>at each step"]\n    \n    Return["Return resolved path"]\n    \n    Start --> IsFB\n    IsFB -->|Yes| TryModernClassic\n    TryModernClassic --> CheckDev\n    CheckDev -->|Yes| TryDevVariant\n    CheckDev -->|No| TryGenericFB\n    TryDevVariant --> TryGenericFB\n    TryGenericFB --> TryExperimentalStable\n    IsFB -->|No| TryExperimentalStable\n    TryExperimentalStable --> UsePlain\n    UsePlain --> Return\n```\n\nSources: [scripts/rollup/build.js:585-633]()\n\n**Example Entry Point Variants**\n\nFor `packages/react-dom/src/ReactDOMFB.js`:\n- `ReactDOMFB.modern.fb.js` - Facebook experimental builds\n- `ReactDOMFB.classic.fb.js` - Facebook stable builds  \n- `ReactDOMFB.js` - Base implementation\n\nFor `packages/react/index.js`:\n- `index.experimental.js` - OSS experimental builds\n- `index.stable.js` - OSS stable builds\n- `index.js` - Base implementation\n\n---\n\n## Plugin Pipeline\n\nThe Rollup plugin pipeline transforms source code through multiple stages. The pipeline is constructed in [scripts/rollup/build.js:354-546]().\n\n### Pipeline Stages\n\n```mermaid\ngraph TB\n    Source["Source Code<br/>(Flow/TypeScript)"]\n    \n    DynamicImports["dynamicImports()<br/>Externalize dynamic imports"]\n    \n    TypeRemoval["typescript() or flowRemoveTypes<br/>Strip type annotations"]\n    \n    CommonJS["commonjs()<br/>(TypeScript only)"]\n    \n    Forks["useForks()<br/>Apply module replacements"]\n    \n    ForbidFBJS["forbidFBJSImports()<br/>Block fbjs imports"]\n    \n    Resolve["resolve()<br/>Node module resolution"]\n    \n    StripBanner["stripBanner()<br/>Remove individual license headers"]\n    \n    Babel["babel()<br/>Transpile to ES2015 (+ ES5 in DEV)"]\n    \n    RemoveStrict["Remove \'use strict\'<br/>from individual modules"]\n    \n    Replace["replace()<br/>__DEV__, __PROFILE__, __EXPERIMENTAL__"]\n    \n    ExternalRuntime["externalRuntime()<br/>(for server-external-runtime)"]\n    \n    TopLevel["wrapWithTopLevelDefinitions()<br/>Module boundaries"]\n    \n    Closure["closure()<br/>Minification (SIMPLE mode)"]\n    \n    Prettier["prettier()<br/>Format output"]\n    \n    License["wrapWithLicenseHeader()<br/>Add license"]\n    \n    Sizes["sizes()<br/>Record bundle size"]\n    \n    Output["Output Bundle"]\n    \n    Source --> DynamicImports\n    DynamicImports --> TypeRemoval\n    TypeRemoval --> CommonJS\n    CommonJS --> Forks\n    Forks --> ForbidFBJS\n    ForbidFBJS --> Resolve\n    Resolve --> StripBanner\n    StripBanner --> Babel\n    Babel --> RemoveStrict\n    RemoveStrict --> Replace\n    Replace --> ExternalRuntime\n    ExternalRuntime --> TopLevel\n    TopLevel --> Closure\n    Closure --> Prettier\n    Prettier --> License\n    License --> Sizes\n    Sizes --> Output\n```\n\nSources: [scripts/rollup/build.js:380-539]()\n\n### Key Plugin Details\n\n**Babel Configuration** [scripts/rollup/build.js:143-172]()\n\nBase plugins (all builds):\n- `@babel/plugin-proposal-class-properties` (loose)\n- `@babel/plugin-proposal-object-rest-spread` (loose)\n- `@babel/plugin-transform-template-literals` (loose)\n- `@babel/plugin-transform-for-of`\n- `@babel/plugin-transform-spread` (loose)\n- `@babel/plugin-transform-parameters`\n- `@babel/plugin-transform-destructuring` (loose)\n- Custom `transform-object-assign`\n\nAdditional ES5 plugins (DEV builds only):\n- `@babel/plugin-transform-literals`\n- `@babel/plugin-transform-arrow-functions`\n- `@babel/plugin-transform-block-scoped-functions`\n- `@babel/plugin-transform-shorthand-properties`\n- `@babel/plugin-transform-computed-properties`\n- `@babel/plugin-transform-block-scoping`\n\n**Closure Compiler Configuration** [scripts/rollup/build.js:470-500]()\n\nSettings:\n- `compilation_level: \'SIMPLE\'` - Basic minification without aggressive optimizations\n- `language_in: \'ECMASCRIPT_2020\'`\n- `language_out: \'ECMASCRIPT5_STRICT\'` (except NODE_ES2015  ES2020, BROWSER_SCRIPT  ES5)\n- `renaming: false` - Preserve symbol names (let gzip handle compression)\n- `assume_function_wrapper: true` - Prevent global variable pollution\n\n**Constant Replacement** [scripts/rollup/build.js:432-442]()\n\nThe `replace()` plugin substitutes build-time constants:\n\n```javascript\n__DEV__  \'true\' (development) or \'false\' (production)\n__PROFILE__  \'true\' (profiling/dev) or \'false\' (production)\nprocess.env.NODE_ENV  "\'development\'" or "\'production\'"\n__EXPERIMENTAL__  true/false (based on RELEASE_CHANNEL)\n```\n\n---\n\n## Host Configuration System\n\nThe host configuration system allows React to target different platforms (DOM, React Native, custom renderers) through a common abstraction layer.\n\n### Host Config Registry\n\nHost configurations are registered in [scripts/shared/inlinedHostConfigs.js:9-357](). Each configuration specifies:\n\n| Property | Description |\n|----------|-------------|\n| `shortName` | Identifier for fork resolution (e.g., "dom-browser", "native-fb") |\n| `entryPoints` | Array of entry points that use this config |\n| `paths` | File paths that should use this config |\n| `isServerSupported` | Whether server rendering is supported |\n| `isFlightSupported` | Whether Server Components are supported |\n\n**Major Host Configurations**\n\n```mermaid\ngraph TB\n    subgraph "Browser Environments"\n        DOMBrowser["dom-browser<br/>ReactDOM in browsers<br/>entryPoints: react-dom, react-dom/client"]\n        DOMEdge["dom-edge<br/>Edge runtime<br/>entryPoints: react-dom-server.edge.js"]\n        DOMBun["dom-bun<br/>Bun runtime<br/>entryPoints: react-dom-server.bun.js"]\n    end\n    \n    subgraph "Server Environments"\n        DOMNode["dom-node<br/>Node.js SSR<br/>entryPoints: react-dom-server.node.js"]\n        DOMNodeWebpack["dom-node-webpack<br/>Webpack bundler<br/>entryPoints: react-server-dom-webpack"]\n        DOMNodeTurbopack["dom-node-turbopack<br/>Turbopack bundler<br/>entryPoints: react-server-dom-turbopack"]\n    end\n    \n    subgraph "React Native"\n        NativeFB["native-fb<br/>RN Facebook<br/>entryPoints: react-native-renderer"]\n        NativeOSS["native-oss<br/>RN OSS<br/>entryPoints: react-native-renderer"]\n    end\n    \n    subgraph "Other"\n        ART["art<br/>React ART<br/>entryPoints: react-art"]\n        Test["test<br/>Test renderer<br/>entryPoints: react-test-renderer"]\n        Custom["custom<br/>Custom renderers<br/>entryPoints: react-reconciler"]\n    end\n```\n\nSources: [scripts/shared/inlinedHostConfigs.js:9-357]()\n\n### Fork Path Resolution\n\nThe `findNearestExistingForkFile` function [scripts/rollup/forks.js:29-43]() resolves forks by trying progressively shorter path segments:\n\n```javascript\n// For shortName "dom-node-webpack" and base path \n// "ReactFiberConfig.", tries:\n// 1. ReactFiberConfig.dom-node-webpack.js\n// 2. ReactFiberConfig.dom-node.js  \n// 3. ReactFiberConfig.dom.js\n// Returns first that exists\n```\n\nThis allows sharing implementations across related configs (e.g., `dom-browser` and `dom-node` can share `dom` forks).\n\n---\n\n## Bundle Output Paths\n\nBundle outputs are organized by environment and package. Output path generation is in [scripts/rollup/packaging.js:48-115]().\n\n### Output Directory Structure\n\n```mermaid\ngraph TB\n    BuildRoot["build/"]\n    \n    NodeModules["node_modules/<br/>(OSS packages)"]\n    FBWWW["facebook-www/<br/>(FB internal)"]\n    ReactNative["react-native/<br/>(RN builds)"]\n    FBRN["facebook-react-native/<br/>(FB RN)"]\n    \n    subgraph "Package Structure"\n        PackageDir["&lt;package-name&gt;/"]\n        CJS["cjs/<br/>(CommonJS)"]\n        ESM["esm/<br/>(ES Modules)"]\n        Files["*.js (entry points)"]\n        Package["package.json"]\n    end\n    \n    BuildRoot --> NodeModules\n    BuildRoot --> FBWWW\n    BuildRoot --> ReactNative\n    BuildRoot --> FBRN\n    \n    NodeModules --> PackageDir\n    PackageDir --> CJS\n    PackageDir --> ESM\n    PackageDir --> Files\n    PackageDir --> Package\n```\n\nSources: [scripts/rollup/packaging.js:48-115]()\n\n**Path Generation by Bundle Type**\n\n| Bundle Type | Output Path Pattern |\n|-------------|-------------------|\n| NODE_DEV/PROD/PROFILING | `build/node_modules/<package>/cjs/<filename>` |\n| ESM_DEV/PROD | `build/node_modules/<package>/esm/<filename>` |\n| BUN_DEV/PROD | `build/node_modules/<package>/cjs/<filename>` |\n| FB_WWW_* | `build/facebook-www/<filename>` |\n| RN_OSS_* | `build/react-native/implementations/<filename>` |\n| RN_FB_* (react-native-renderer) | `build/react-native/implementations/<filename>.fb.js` |\n| RN_FB_* (other packages) | `build/facebook-react-native/<package>/cjs/<filename>` |\n| BROWSER_SCRIPT | `build/node_modules/<package>/<outputPath>` |\n\nCode: [scripts/rollup/packaging.js:48-115]()\n\n---\n\n## Code Wrappers\n\nDifferent bundle types require different code wrappers for module boundaries and conditional loading. Wrapper logic is in [scripts/rollup/wrappers.js]().\n\n### Top-Level Definition Wrappers\n\n**NODE_DEV Wrapper** [scripts/rollup/wrappers.js:86-95]()\n\n```javascript\n\'use strict\';\n\nif (process.env.NODE_ENV !== "production") {\n  (function() {\n    // ... bundle code ...\n  })();\n}\n```\n\n**FB_WWW_DEV Wrapper** [scripts/rollup/wrappers.js:107-116]()\n\n```javascript\n\'use strict\';\n\nif (__DEV__) {\n  (function() {\n    // ... bundle code ...\n  })();\n}\n```\n\n**RN_OSS_DEV Wrapper** [scripts/rollup/wrappers.js:128-137]()\n\n```javascript\n\'use strict\';\n\nif (__DEV__) {\n  (function() {\n    // ... bundle code ...\n  })();\n}\n```\n\nSources: [scripts/rollup/wrappers.js:58-169]()\n\n### Reconciler Wrappers\n\nThe reconciler (react-reconciler package) uses a special factory function wrapper that accepts a host config:\n\n**NODE_DEV Reconciler** [scripts/rollup/wrappers.js:172-186]()\n\n```javascript\n\'use strict\';\n\nif (process.env.NODE_ENV !== "production") {\n  module.exports = function $$$reconciler($$$config) {\n    var exports = {};\n    // ... bundle code ...\n    return exports;\n  };\n  module.exports.default = module.exports;\n  Object.defineProperty(module.exports, "__esModule", { value: true });\n}\n```\n\nThis allows custom renderers to provide their own host config at runtime.\n\nSources: [scripts/rollup/wrappers.js:171-263]()\n\n### License Headers\n\nLicense headers vary by bundle type. Example for OSS builds [scripts/rollup/wrappers.js:326-336]():\n\n```javascript\n/**\n * @license React\n * <filename>\n *\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n```\n\nFacebook builds include Flow/lint directives [scripts/rollup/wrappers.js:362-374]():\n\n```javascript\n/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n * ...\n * @noflow\n * @nolint\n * @preventMunge\n * @preserve-invariant-messages\n */\n```\n\nSources: [scripts/rollup/wrappers.js:265-492]()\n\n---\n\n## Build Orchestration\n\nThe main build script [scripts/rollup/build.js]() orchestrates the entire build process.\n\n### Build Execution Flow\n\n```mermaid\ngraph TB\n    Start["buildEverything()<br/>[build.js:828]"]\n    \n    Clean["asyncRimRaf(\'build/\')<br/>Clean output directory"]\n    \n    EnumerateBundles["Enumerate all bundles<br/>[bundles.js:69-1244]"]\n    \n    FilterBundles["Filter by CLI args<br/>(--type, names)"]\n    \n    CISplit["Split across CI nodes<br/>(CI_TOTAL, CI_INDEX)"]\n    \n    ForEachBundle["For each bundle"]\n    \n    Prebuild{Has<br/>prebuild?}\n    \n    RunPrebuild["runShellCommand(bundle.prebuild)"]\n    \n    CreateBundle["createBundle(bundle, bundleType)<br/>[build.js:635-751]"]\n    \n    ResolveEntry["resolveEntryFork()<br/>Pick entry point variant"]\n    \n    GetForks["getForks()<br/>Get module replacements"]\n    \n    ConfigureRollup["Configure Rollup<br/>(input, plugins, externals)"]\n    \n    RunRollup["rollup.rollup(config)"]\n    \n    WriteOutput["result.write(outputPath)"]\n    \n    CopyShims["copyAllShims()<br/>Copy www & RN shims"]\n    \n    PrepareNPM["prepareNpmPackages()<br/>npm pack & extract"]\n    \n    Sync{Sync to<br/>FB repos?}\n    \n    SyncFB["Sync to fbsource/www"]\n    \n    PrintStats["Print build statistics"]\n    \n    Start --> Clean\n    Clean --> EnumerateBundles\n    EnumerateBundles --> FilterBundles\n    FilterBundles --> CISplit\n    CISplit --> ForEachBundle\n    ForEachBundle --> Prebuild\n    Prebuild -->|Yes| RunPrebuild\n    Prebuild -->|No| CreateBundle\n    RunPrebuild --> CreateBundle\n    CreateBundle --> ResolveEntry\n    ResolveEntry --> GetForks\n    GetForks --> ConfigureRollup\n    ConfigureRollup --> RunRollup\n    RunRollup --> WriteOutput\n    WriteOutput --> ForEachBundle\n    ForEachBundle -->|More| ForEachBundle\n    ForEachBundle -->|Done| CopyShims\n    CopyShims --> PrepareNPM\n    PrepareNPM --> Sync\n    Sync -->|Yes| SyncFB\n    Sync -->|No| PrintStats\n    SyncFB --> PrintStats\n```\n\nSources: [scripts/rollup/build.js:828-896]()\n\n### Bundle Filtering\n\nThe build supports filtering via command-line arguments:\n\n**By Bundle Type** (`--type` flag)\n\n```bash\n# Build only Facebook www bundles\nyarn build --type=fb_www\n\n# Build multiple types\nyarn build --type=node_dev,node_prod\n```\n\nCode: [scripts/rollup/build.js:94-98]()\n\n**By Bundle Name** (positional arguments)\n\n```bash\n# Build only react-dom\nyarn build react-dom\n\n# Build multiple packages\nyarn build react react-dom\n```\n\nCode: [scripts/rollup/build.js:100-104](), [scripts/rollup/build.js:548-583]()\n\n**Skip Logic** [scripts/rollup/build.js:548-583]()\n\nA bundle is skipped if:\n1. Its `bundleTypes` array doesn\'t include the target bundle type\n2. User specified `--type` flags and none match\n3. User specified names and the bundle\'s entry doesn\'t match\n\n### Package Preparation\n\nAfter building, packages are prepared for npm publishing [scripts/rollup/packaging.js:253-284]():\n\n1. Copy metadata files (LICENSE, package.json, README.md)\n2. Copy npm/ directory contents (wrapper files)\n3. Filter out non-built entry points from package.json\n4. Run `npm pack` to create tarball\n5. Extract tarball to final location\n6. Delete tarball\n\nThe filtering step [scripts/rollup/packaging.js:171-251]() removes entry points that weren\'t built in the current release channel from `package.json` files field and exports map.\n\nSources: [scripts/rollup/packaging.js:253-284](), [scripts/rollup/packaging.js:171-251]()\n\n---\n\n## External Dependencies\n\nThe build system tracks external dependencies and their import side effects.\n\n### Import Side Effects Registry\n\n[scripts/rollup/modules.js:10-28]() declares whether externals have side effects during import:\n\n```javascript\nconst importSideEffects = Object.freeze({\n  fs: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  \'fs/promises\': HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  path: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  stream: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  \'prop-types/checkPropTypes\': HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  scheduler: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  react: HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  \'react-dom\': HAS_NO_SIDE_EFFECTS_ON_IMPORT,\n  // ...\n});\n```\n\nThis allows tree-shaking unused DEV-only imports in production builds. The `pureExternalModules` list is passed to Rollup\'s treeshake configuration [scripts/rollup/build.js:656-666]().\n\n### Known Globals\n\nFor UMD/IIFE bundles, external dependencies are mapped to global variables [scripts/rollup/modules.js:31-38]():\n\n```javascript\nconst knownGlobals = Object.freeze({\n  react: \'React\',\n  \'react-dom\': \'ReactDOM\',\n  \'react-dom/server\': \'ReactDOMServer\',\n  scheduler: \'Scheduler\',\n  \'scheduler/unstable_mock\': \'SchedulerMock\',\n  ReactNativeInternalFeatureFlags: \'ReactNativeInternalFeatureFlags\',\n});\n```\n\nSources: [scripts/rollup/modules.js:10-38](), [scripts/rollup/build.js:656-666]()\n\n---\n\n## Special Cases and Edge Cases\n\n### Facebook-Specific Entry Point Aliasing\n\nIn Facebook builds, multiple public entry points may alias to a single internal entry point. For example, `react-dom` and `react-dom/client` both resolve to `ReactDOMFB.js` [scripts/jest/setupHostConfigs.js:18-56]().\n\n### DevTools Integration\n\nCertain bundles wrap code with DevTools hooks for profiling [scripts/rollup/wrappers.js:32-51]():\n\n```javascript\nif (\n  typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== \'undefined\' &&\n  typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart === \'function\'\n) {\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error());\n}\n// ... bundle code ...\nif (\n  typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== \'undefined\' &&\n  typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop === \'function\'\n) {\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error());\n}\n```\n\nThis is controlled by `wrapWithModuleBoundaries` in bundle configs.\n\n### Reconciler Factory Pattern\n\nThe `react-reconciler` package exports a factory function rather than direct exports [scripts/rollup/wrappers.js:171-263](), allowing custom renderers to provide their own host config:\n\n```javascript\nconst Reconciler = require(\'react-reconciler\');\nconst reconciler = Reconciler({\n  // custom host config\n  createInstance() { /*...*/ },\n  appendInitialChild() { /*...*/ },\n  // ...\n});\n```\n\n### .new and .old File System\n\nThe React codebase uses a `.new.js` / `.old.js` suffix pattern for staged changes (not explicitly shown in build code but mentioned in documentation). The build system doesn\'t special-case these - they\'re selected via the entry point or fork resolution mechanisms.\n\nSources: [scripts/rollup/wrappers.js:32-51](), [scripts/rollup/wrappers.js:171-263](), [scripts/jest/setupHostConfigs.js:18-56]()\n\n---\n\n# Page: Release Channels and Versioning\n\n# Release Channels and Versioning\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/shared/ReactFeatureFlags.js](packages/shared/ReactFeatureFlags.js)\n- [packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js](packages/shared/forks/ReactFeatureFlags.native-fb-dynamic.js)\n- [packages/shared/forks/ReactFeatureFlags.native-fb.js](packages/shared/forks/ReactFeatureFlags.native-fb.js)\n- [packages/shared/forks/ReactFeatureFlags.native-oss.js](packages/shared/forks/ReactFeatureFlags.native-oss.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.js](packages/shared/forks/ReactFeatureFlags.test-renderer.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js](packages/shared/forks/ReactFeatureFlags.test-renderer.native-fb.js)\n- [packages/shared/forks/ReactFeatureFlags.test-renderer.www.js](packages/shared/forks/ReactFeatureFlags.test-renderer.www.js)\n- [packages/shared/forks/ReactFeatureFlags.www-dynamic.js](packages/shared/forks/ReactFeatureFlags.www-dynamic.js)\n- [packages/shared/forks/ReactFeatureFlags.www.js](packages/shared/forks/ReactFeatureFlags.www.js)\n- [scripts/flow/xplat.js](scripts/flow/xplat.js)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React\'s release channel system and versioning strategy, which enables the codebase to ship different feature sets to different environments from a single source tree. The release channel system determines which experimental features are included in builds, how entry points are resolved, and where build artifacts are placed.\n\nFor information about how feature flags control individual features within a release channel, see [Feature Flags System](#2). For details on the build pipeline that processes these channels, see [Build Pipeline and Module Forking](#3.1).\n\n---\n\n## Release Channel Fundamentals\n\nReact uses a release channel system to control which features are enabled at build time. The `RELEASE_CHANNEL` environment variable determines the channel, which propagates throughout the build system as the `__EXPERIMENTAL__` constant.\n\n### Channel Types\n\n| Channel | __EXPERIMENTAL__ Value | Purpose |\n|---------|----------------------|---------|\n| `experimental` | `true` | Includes all experimental features, used for canary releases and internal testing |\n| `stable` (default) | `true` (when unset) | Standard releases with stable features only |\n| Facebook-specific | varies | Internal Facebook builds may use custom channels |\n\nThe core logic appears in [scripts/rollup/bundles.js:3-8]() and [scripts/rollup/build.js:31-38]():\n\n```javascript\nconst RELEASE_CHANNEL = process.env.RELEASE_CHANNEL;\n\nconst __EXPERIMENTAL__ =\n  typeof RELEASE_CHANNEL === \'string\'\n    ? RELEASE_CHANNEL === \'experimental\'\n    : true;\n```\n\n**Key behavior**: When `RELEASE_CHANNEL` is undefined, `__EXPERIMENTAL__` defaults to `true`, making experimental the default during development.\n\n### Release Channel Flow\n\n```mermaid\ngraph TB\n    EnvVar["process.env.RELEASE_CHANNEL"]\n    CheckType{"typeof === \'string\'?"}\n    CheckValue{"value === \'experimental\'?"}\n    DefaultTrue["__EXPERIMENTAL__ = true"]\n    SetTrue["__EXPERIMENTAL__ = true"]\n    SetFalse["__EXPERIMENTAL__ = false"]\n    \n    EnvVar --> CheckType\n    CheckType -->|"Yes"| CheckValue\n    CheckType -->|"No (undefined)"| DefaultTrue\n    CheckValue -->|"Yes"| SetTrue\n    CheckValue -->|"No"| SetFalse\n    \n    DefaultTrue --> PropagateToPlugins["Propagate to Rollup plugins"]\n    SetTrue --> PropagateToPlugins\n    SetFalse --> PropagateToPlugins\n    \n    PropagateToPlugins --> ReplacePlugin["@rollup/plugin-replace"]\n    PropagateToPlugins --> EntryForkResolution["Entry Point Fork Resolution"]\n    PropagateToPlugins --> FeatureFlagSelection["Feature Flag Configuration"]\n    \n    ReplacePlugin --> CodeTransform["__EXPERIMENTAL__  true/false in source"]\n    EntryForkResolution --> FileSelection[".experimental.js vs .stable.js"]\n    FeatureFlagSelection --> FlagValues["Flag true/false values"]\n```\n\nSources: [scripts/rollup/bundles.js:3-8](), [scripts/rollup/build.js:31-38](), [scripts/rollup/build.js:432-442]()\n\n---\n\n## Bundle Types and Target Environments\n\nReact generates multiple bundle variants for different environments, runtimes, and optimization levels. These bundle types form a matrix with release channels to determine the final build artifacts.\n\n### Bundle Type Categories\n\nThe build system defines bundle types in [scripts/rollup/bundles.js:10-31]():\n\n**Node.js Bundles**\n- `NODE_ES2015` - ES2015+ syntax for modern Node\n- `NODE_DEV` - Development builds with guards\n- `NODE_PROD` - Minified production builds\n- `NODE_PROFILING` - Profiling-enabled builds\n\n**Browser Bundles**\n- `ESM_DEV` - ES modules for development\n- `ESM_PROD` - ES modules for production\n- `BROWSER_SCRIPT` - Standalone browser scripts\n\n**Facebook Internal**\n- `FB_WWW_DEV` - Facebook web development\n- `FB_WWW_PROD` - Facebook web production\n- `FB_WWW_PROFILING` - Facebook web with profiling\n\n**React Native**\n- `RN_OSS_DEV/PROD/PROFILING` - Open source React Native\n- `RN_FB_DEV/PROD/PROFILING` - Facebook\'s internal React Native\n\n**Bun Runtime**\n- `BUN_DEV` - Bun development builds\n- `BUN_PROD` - Bun production builds\n\n### Bundle Type Characteristics\n\n```mermaid\ngraph LR\n    BundleType["Bundle Type"]\n    \n    subgraph "Production vs Development"\n        ProdCheck["isProductionBundleType()"]\n        DevGuards["if (process.env.NODE_ENV !== \'production\')"]\n        DevCode["Development-only code"]\n    end\n    \n    subgraph "Profiling"\n        ProfCheck["isProfilingBundleType()"]\n        ProfFlag["__PROFILE__ = true"]\n        ProfFeatures["Profiling APIs enabled"]\n    end\n    \n    subgraph "Module Format"\n        FormatCheck["getFormat()"]\n        CJS["CommonJS (cjs)"]\n        ESM["ES Modules (es)"]\n        IIFE["IIFE (iife)"]\n    end\n    \n    subgraph "Environment Flags"\n        FlagsCheck["getBundleTypeFlags()"]\n        IsFBWWW["isFBWWWBundle"]\n        IsRN["isRNBundle"]\n        IsFBRN["isFBRNBundle"]\n    end\n    \n    BundleType --> ProdCheck\n    BundleType --> ProfCheck\n    BundleType --> FormatCheck\n    BundleType --> FlagsCheck\n    \n    ProdCheck --> DevGuards\n    DevGuards --> DevCode\n    \n    ProfCheck --> ProfFlag\n    ProfFlag --> ProfFeatures\n    \n    FormatCheck --> CJS\n    FormatCheck --> ESM\n    FormatCheck --> IIFE\n    \n    FlagsCheck --> IsFBWWW\n    FlagsCheck --> IsRN\n    FlagsCheck --> IsFBRN\n```\n\nThe classification logic is in [scripts/rollup/build.js:253-310]():\n\n```javascript\nfunction isProductionBundleType(bundleType) {\n  switch (bundleType) {\n    case NODE_DEV:\n    case FB_WWW_DEV:\n    case RN_OSS_DEV:\n      return false;\n    case NODE_PROD:\n    case FB_WWW_PROD:\n      return true;\n    // ...\n  }\n}\n```\n\nSources: [scripts/rollup/bundles.js:10-54](), [scripts/rollup/build.js:225-310](), [scripts/rollup/build.js:312-338]()\n\n---\n\n## Entry Point Fork Resolution\n\nReact uses file naming conventions to provide different implementations for different release channels and environments. The build system resolves these "forks" at build time.\n\n### Fork Resolution Priority\n\nEntry points are resolved with the following priority order, from most specific to least specific:\n\n1. `.modern.fb.js` / `.classic.fb.js` (Facebook builds)\n2. `.fb.js` (generic Facebook)\n3. `.experimental.js` / `.stable.js` (release channel)\n4. `.development.js` (development mode)\n5. `.js` (base file)\n\n### Entry Point Resolution Algorithm\n\n```mermaid\ngraph TB\n    ResolveEntry["resolveEntryFork(resolvedEntry, isFBBundle, isDev)"]\n    \n    CheckFB{"isFBBundle?"}\n    \n    subgraph "Facebook Fork Resolution"\n        TryModernFB["Try: entry.modern.fb.js"]\n        ExistsModernFB{"File exists?"}\n        TryModernFBDev["Try: entry.modern.fb.development.js"]\n        ExistsModernFBDev{"File exists?"}\n        \n        TryClassicFB["Try: entry.classic.fb.js"]\n        ExistsClassicFB{"File exists?"}\n        TryClassicFBDev["Try: entry.classic.fb.development.js"]\n        ExistsClassicFBDev{"File exists?"}\n        \n        TryGenericFB["Try: entry.fb.js"]\n        ExistsGenericFB{"File exists?"}\n        TryGenericFBDev["Try: entry.fb.development.js"]\n        ExistsGenericFBDev{"File exists?"}\n    end\n    \n    subgraph "Channel Fork Resolution"\n        TryExp["Try: entry.experimental.js"]\n        ExistsExp{"File exists?"}\n        TryExpDev["Try: entry.experimental.development.js"]\n        ExistsExpDev{"File exists?"}\n        \n        TryStable["Try: entry.stable.js"]\n        ExistsStable{"File exists?"}\n        TryStableDev["Try: entry.stable.development.js"]\n        ExistsStableDev{"File exists?"}\n    end\n    \n    TryPlainDev["Try: entry.development.js"]\n    ExistsPlainDev{"File exists?"}\n    \n    UsePlain["Use: entry.js"]\n    \n    ResolveEntry --> CheckFB\n    \n    CheckFB -->|"Yes && __EXPERIMENTAL__"| TryModernFBDev\n    CheckFB -->|"Yes && !__EXPERIMENTAL__"| TryClassicFBDev\n    CheckFB -->|"No"| TryExpDev\n    \n    TryModernFBDev --> ExistsModernFBDev\n    ExistsModernFBDev -->|"Yes && isDev"| Return1["Return modern.fb.development.js"]\n    ExistsModernFBDev -->|"No"| TryModernFB\n    \n    TryModernFB --> ExistsModernFB\n    ExistsModernFB -->|"Yes"| Return2["Return modern.fb.js"]\n    ExistsModernFB -->|"No"| TryGenericFBDev\n    \n    TryClassicFBDev --> ExistsClassicFBDev\n    ExistsClassicFBDev -->|"Yes && isDev"| Return3["Return classic.fb.development.js"]\n    ExistsClassicFBDev -->|"No"| TryClassicFB\n    \n    TryClassicFB --> ExistsClassicFB\n    ExistsClassicFB -->|"Yes"| Return4["Return classic.fb.js"]\n    ExistsClassicFB -->|"No"| TryGenericFBDev\n    \n    TryGenericFBDev --> ExistsGenericFBDev\n    ExistsGenericFBDev -->|"Yes && isDev"| Return5["Return fb.development.js"]\n    ExistsGenericFBDev -->|"No"| TryGenericFB\n    \n    TryGenericFB --> ExistsGenericFB\n    ExistsGenericFB -->|"Yes"| Return6["Return fb.js"]\n    ExistsGenericFB -->|"No"| TryExpDev\n    \n    TryExpDev --> ExistsExpDev\n    ExistsExpDev -->|"Yes && isDev && __EXPERIMENTAL__"| Return7["Return experimental.development.js"]\n    ExistsExpDev -->|"No"| TryExp\n    \n    TryExp --> ExistsExp\n    ExistsExp -->|"Yes && __EXPERIMENTAL__"| Return8["Return experimental.js"]\n    ExistsExp -->|"No"| TryStableDev\n    \n    TryStableDev --> ExistsStableDev\n    ExistsStableDev -->|"Yes && isDev && !__EXPERIMENTAL__"| Return9["Return stable.development.js"]\n    ExistsStableDev -->|"No"| TryStable\n    \n    TryStable --> ExistsStable\n    ExistsStable -->|"Yes && !__EXPERIMENTAL__"| Return10["Return stable.js"]\n    ExistsStable -->|"No"| TryPlainDev\n    \n    TryPlainDev --> ExistsPlainDev\n    ExistsPlainDev -->|"Yes && isDev"| Return11["Return development.js"]\n    ExistsPlainDev -->|"No"| UsePlain\n    \n    UsePlain --> Return12["Return entry.js"]\n```\n\nThe implementation is in [scripts/rollup/build.js:585-633]():\n\n```javascript\nfunction resolveEntryFork(resolvedEntry, isFBBundle, isDev) {\n  if (isFBBundle) {\n    const resolvedFBEntry = resolvedEntry.replace(\n      \'.js\',\n      __EXPERIMENTAL__ ? \'.modern.fb.js\' : \'.classic.fb.js\'\n    );\n    const devFBEntry = resolvedFBEntry.replace(\'.js\', \'.development.js\');\n    if (isDev && fs.existsSync(devFBEntry)) {\n      return devFBEntry;\n    }\n    if (fs.existsSync(resolvedFBEntry)) {\n      return resolvedFBEntry;\n    }\n    // Falls through to generic .fb.js, then to channel forks\n  }\n  \n  const resolvedForkedEntry = resolvedEntry.replace(\n    \'.js\',\n    __EXPERIMENTAL__ ? \'.experimental.js\' : \'.stable.js\'\n  );\n  // ...\n}\n```\n\nSources: [scripts/rollup/build.js:585-633](), [scripts/jest/setupHostConfigs.js:7-99]()\n\n---\n\n## Interaction with Feature Flags\n\nRelease channels directly influence which feature flag configurations are loaded. The fork resolution system (documented in [Feature Flags System](#2)) selects flag files based on both the bundle type and release channel.\n\n### Feature Flag Fork Selection\n\nThe feature flag forking logic in [scripts/rollup/forks.js:134-191]() demonstrates the relationship:\n\n```javascript\n\'./packages/shared/ReactFeatureFlags.js\': (bundleType, entry) => {\n  switch (entry) {\n    case \'react-native-renderer\':\n      switch (bundleType) {\n        case RN_FB_DEV:\n        case RN_FB_PROD:\n          return \'./packages/shared/forks/ReactFeatureFlags.native-fb.js\';\n        case RN_OSS_DEV:\n        case RN_OSS_PROD:\n          return \'./packages/shared/forks/ReactFeatureFlags.native-oss.js\';\n      }\n    default:\n      switch (bundleType) {\n        case FB_WWW_DEV:\n        case FB_WWW_PROD:\n          return \'./packages/shared/forks/ReactFeatureFlags.www.js\';\n      }\n  }\n  return null; // Use canonical flags\n}\n```\n\n### Channel-Dependent Flag Values\n\nCertain flags have their values controlled by `__EXPERIMENTAL__`:\n\n```mermaid\ngraph LR\n    subgraph "Canonical Flags"\n        CanonicalFile["ReactFeatureFlags.js"]\n        FlagDefinitions["Flag = __EXPERIMENTAL__"]\n    end\n    \n    subgraph "Environment Forks"\n        WWWFork["ReactFeatureFlags.www.js"]\n        NativeFBFork["ReactFeatureFlags.native-fb.js"]\n        NativeOSSFork["ReactFeatureFlags.native-oss.js"]\n        TestRendererFork["ReactFeatureFlags.test-renderer.js"]\n    end\n    \n    subgraph "Dynamic Flags"\n        WWWDynamic["ReactFeatureFlags.www-dynamic.js"]\n        NativeFBDynamic["ReactFeatureFlags.native-fb-dynamic.js"]\n        VariantFlag["Flag = __VARIANT__"]\n    end\n    \n    EXPERIMENTAL["__EXPERIMENTAL__ constant"]\n    \n    EXPERIMENTAL --> CanonicalFile\n    CanonicalFile --> FlagDefinitions\n    \n    FlagDefinitions -.overrides.-> WWWFork\n    FlagDefinitions -.overrides.-> NativeFBFork\n    FlagDefinitions -.overrides.-> NativeOSSFork\n    FlagDefinitions -.overrides.-> TestRendererFork\n    \n    WWWFork --> WWWDynamic\n    NativeFBFork --> NativeFBDynamic\n    \n    WWWDynamic --> VariantFlag\n    NativeFBDynamic --> VariantFlag\n```\n\nExamples from [packages/shared/ReactFeatureFlags.js:75-100]():\n\n```javascript\nexport const enableLegacyCache = __EXPERIMENTAL__;\nexport const enableAsyncIterableChildren = __EXPERIMENTAL__;\nexport const enableTaint = __EXPERIMENTAL__;\nexport const enableGestureTransition = __EXPERIMENTAL__;\nexport const enableFizzBlockingRender = __EXPERIMENTAL__;\n```\n\nSources: [scripts/rollup/forks.js:134-191](), [packages/shared/ReactFeatureFlags.js:75-100](), [packages/shared/forks/ReactFeatureFlags.www.js:1-119]()\n\n---\n\n## Build Output Organization\n\nBuild artifacts are organized by environment, with different directory structures for different deployment targets.\n\n### Output Path Resolution\n\nThe `getBundleOutputPath()` function in [scripts/rollup/packaging.js:48-115]() determines where each bundle is written:\n\n| Bundle Type | Output Path Pattern | Example |\n|-------------|-------------------|---------|\n| NODE_ES2015, NODE_DEV, NODE_PROD, NODE_PROFILING | `build/node_modules/{package}/cjs/{filename}` | `build/node_modules/react/cjs/react.development.js` |\n| ESM_DEV, ESM_PROD | `build/node_modules/{package}/esm/{filename}` | `build/node_modules/react/esm/react.development.js` |\n| BUN_DEV, BUN_PROD | `build/node_modules/{package}/cjs/{filename}` | `build/node_modules/react-dom/cjs/react-dom-server.bun.development.js` |\n| FB_WWW_* | `build/facebook-www/{filename}` | `build/facebook-www/React-prod.classic.js` |\n| RN_OSS_* | `build/react-native/implementations/{filename}` | `build/react-native/implementations/ReactFabric-prod.js` |\n| RN_FB_* (most packages) | `build/facebook-react-native/{package}/cjs/{filename}` | `build/facebook-react-native/react/cjs/react.production.js` |\n| RN_FB_* (renderer) | `build/react-native/implementations/{filename}.fb.js` | `build/react-native/implementations/ReactFabric-prod.fb.js` |\n| BROWSER_SCRIPT | `build/node_modules/{package}/{outputPath}` | `build/node_modules/react-dom/unstable_server-external-runtime.js` |\n\n### Build Directory Structure\n\n```mermaid\ngraph TB\n    BuildRoot["build/"]\n    \n    subgraph "npm Packages"\n        NodeModules["node_modules/"]\n        PackageDir["react/, react-dom/, etc."]\n        CJSDir["cjs/"]\n        ESMDir["esm/"]\n        CJSFiles["*.development.js<br/>*.production.js<br/>*.profiling.js"]\n        ESMFiles["*.development.js<br/>*.production.js"]\n    end\n    \n    subgraph "Facebook Web"\n        FBWWW["facebook-www/"]\n        WWWFiles["React-prod.classic.js<br/>React-dev.classic.js<br/>ReactDOM-prod.modern.js"]\n        WWWShims["shims/"]\n    end\n    \n    subgraph "React Native"\n        RN["react-native/"]\n        RNImplementations["implementations/"]\n        RNShims["shims/"]\n        RNFiles["ReactFabric-dev.js<br/>ReactFabric-prod.fb.js"]\n    end\n    \n    subgraph "Facebook React Native"\n        FBRN["facebook-react-native/"]\n        FBRNPackages["react/, react-dom/, etc."]\n        FBRNCJSDir["cjs/"]\n        FBRNCJSFiles["*.development.js<br/>*.production.js"]\n    end\n    \n    BuildRoot --> NodeModules\n    BuildRoot --> FBWWW\n    BuildRoot --> RN\n    BuildRoot --> FBRN\n    \n    NodeModules --> PackageDir\n    PackageDir --> CJSDir\n    PackageDir --> ESMDir\n    CJSDir --> CJSFiles\n    ESMDir --> ESMFiles\n    \n    FBWWW --> WWWFiles\n    FBWWW --> WWWShims\n    \n    RN --> RNImplementations\n    RN --> RNShims\n    RNImplementations --> RNFiles\n    \n    FBRN --> FBRNPackages\n    FBRNPackages --> FBRNCJSDir\n    FBRNCJSDir --> FBRNCJSFiles\n```\n\nSources: [scripts/rollup/packaging.js:48-115](), [scripts/rollup/packaging.js:117-137]()\n\n---\n\n## Package Preparation and Distribution\n\nAfter building, packages undergo preparation steps to make them ready for distribution. The process varies by target environment.\n\n### npm Package Preparation\n\nThe `prepareNpmPackages()` function in [scripts/rollup/packaging.js:253-284]() performs the following steps:\n\n1. **Copy package metadata**: LICENSE, package.json, README.md, npm/ directory\n2. **Filter entry points**: Remove entry points not built for the current channel using `filterOutEntrypoints()`\n3. **Pack and extract**: Use `npm pack` to create a tarball, then extract it\n\n### Entry Point Filtering\n\nThe `filterOutEntrypoints()` function in [scripts/rollup/packaging.js:171-251]() removes entry points from package.json that weren\'t built for the current release channel:\n\n```mermaid\ngraph TB\n    PackageJSON["Read package.json"]\n    FilesArray["files: []"]\n    ExportsField["exports: {}"]\n    BrowserField["browser: {}"]\n    \n    IterateFiles["For each file in files[]"]\n    DetermineEntry["Determine entry point name"]\n    CheckBundle{"Has bundle for<br/>this entry?"}\n    \n    KeepFile["Keep in files[]<br/>Keep in exports"]\n    RemoveFile["Remove from files[]<br/>Delete from exports<br/>unlink() from disk"]\n    \n    WriteJSON["Write updated package.json"]\n    \n    PackageJSON --> FilesArray\n    PackageJSON --> ExportsField\n    PackageJSON --> BrowserField\n    \n    FilesArray --> IterateFiles\n    IterateFiles --> DetermineEntry\n    DetermineEntry --> CheckBundle\n    \n    CheckBundle -->|"Yes"| KeepFile\n    CheckBundle -->|"No (wrong channel)"| RemoveFile\n    \n    KeepFile --> WriteJSON\n    RemoveFile --> WriteJSON\n```\n\nThe function uses the `entryPointsToHasBundle` map built in [scripts/rollup/packaging.js:158-169]():\n\n```javascript\nlet entryPointsToHasBundle = new Map();\nfor (const bundle of Bundles.bundles) {\n  const hasNonFBBundleTypes = bundle.bundleTypes.some(\n    type =>\n      type !== FB_WWW_DEV && type !== FB_WWW_PROD && type !== FB_WWW_PROFILING\n  );\n  entryPointsToHasBundle.set(bundle.entry, hasNonFBBundleTypes);\n}\n```\n\nThis ensures that if a bundle is only built for internal Facebook use, it won\'t appear in the public npm package.\n\n### Conditional Package Exports\n\nReact uses package.json `exports` field to provide different entry points based on environment. Entry points may include suffixes like `.react-server` or `.rsc` that inherit their bundle status from the base entry point:\n\n```javascript\nif (entry.endsWith(\'.react-server\')) {\n  hasBundle = entryPointsToHasBundle.get(\n    entry.slice(0, \'.react-server\'.length * -1)\n  );\n} else if (entry.endsWith(\'.rsc\')) {\n  hasBundle = entryPointsToHasBundle.get(\n    entry.slice(0, \'.rsc\'.length * -1)\n  );\n}\n```\n\nFrom [scripts/rollup/packaging.js:197-205]().\n\n### Server Entry Point Distribution\n\nReact provides multiple server rendering entry points with conditional loading based on `process.env.NODE_ENV`. These are demonstrated in npm wrapper files:\n\n**Node.js Server** - [packages/react-dom/npm/server.node.js:1-19]():\n```javascript\nvar l, s;\nif (process.env.NODE_ENV === \'production\') {\n  l = require(\'./cjs/react-dom-server-legacy.node.production.js\');\n  s = require(\'./cjs/react-dom-server.node.production.js\');\n} else {\n  l = require(\'./cjs/react-dom-server-legacy.node.development.js\');\n  s = require(\'./cjs/react-dom-server.node.development.js\');\n}\n\nexports.renderToString = l.renderToString;\nexports.renderToStaticMarkup = l.renderToStaticMarkup;\nexports.renderToPipeableStream = s.renderToPipeableStream;\n```\n\n**Browser Server** - [packages/react-dom/npm/server.browser.js:1-17]()\n\n**Bun Server** - [packages/react-dom/npm/server.bun.js:1-20]()\n\n**Edge Runtime** - [packages/react-dom/npm/server.edge.js:1-18]()\n\nEach runtime has slightly different API surfaces based on capabilities. For example, `renderToPipeableStream` is only available in Node.js and Bun, not in the browser.\n\nSources: [scripts/rollup/packaging.js:158-273](), [packages/react-dom/npm/server.node.js:1-19](), [packages/react-dom/npm/server.browser.js:1-17](), [packages/react-dom/npm/server.bun.js:1-20]()\n\n---\n\n## Release Channel Usage in Tests\n\nThe test infrastructure respects release channels through environment setup. The `setupHostConfigs.js` file in [scripts/jest/setupHostConfigs.js:7-99]() uses the same `resolveEntryFork()` logic to ensure tests load the correct entry points.\n\n### Test Environment Globals\n\nTests can set global flags to simulate different environments:\n\n- `global.__WWW__` - Simulates Facebook web environment\n- `global.__XPLAT__` - Simulates cross-platform (React Native) environment  \n- `global.__DEV__` - Simulates development vs production mode\n- `__EXPERIMENTAL__` - Set based on test configuration to simulate different channels\n\nThese globals interact with `resolveEntryFork()` to load the appropriate module variants:\n\n```javascript\nfunction mockReact() {\n  jest.mock(\'react\', () => {\n    const resolvedEntryPoint = resolveEntryFork(\n      require.resolve(\'react\'),\n      global.__WWW__ || global.__XPLAT__,\n      global.__DEV__\n    );\n    return jest.requireActual(resolvedEntryPoint);\n  });\n}\n```\n\nFrom [scripts/jest/setupHostConfigs.js:101-115]().\n\nSources: [scripts/jest/setupHostConfigs.js:7-115]()\n\n---\n\n# Page: CI/CD and Artifact Management\n\n# CI/CD and Artifact Management\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\nThis document describes the build artifact generation, packaging, and distribution system in the React repository. It covers the build pipeline that produces multiple bundle variants, npm package preparation, Facebook internal synchronization, and validation processes.\n\nFor information about the build system\'s bundle configuration and plugin pipeline, see [Build Pipeline and Module Forking](#3.1). For release channel management, see [Release Channels and Versioning](#3.2).\n\n---\n\n## Build Artifact Structure\n\nThe React build system generates artifacts in multiple formats and configurations, organized by deployment target and environment.\n\n### Bundle Types\n\nThe build system produces 13 distinct bundle types, each targeting specific runtime environments:\n\n| Bundle Type | Format | Environment | Purpose |\n|------------|--------|-------------|---------|\n| `NODE_ES2015` | CJS | Node.js | ES2015+ features, modern Node |\n| `NODE_DEV` | CJS | Node.js | Development with DEV checks |\n| `NODE_PROD` | CJS | Node.js | Production, minified |\n| `NODE_PROFILING` | CJS | Node.js | Production with profiling |\n| `BUN_DEV` | CJS | Bun runtime | Development for Bun |\n| `BUN_PROD` | CJS | Bun runtime | Production for Bun |\n| `ESM_DEV` | ESM | Browsers/Bundlers | ES Module development |\n| `ESM_PROD` | ESM | Browsers/Bundlers | ES Module production |\n| `FB_WWW_DEV` | CJS | Facebook web | Internal development |\n| `FB_WWW_PROD` | CJS | Facebook web | Internal production |\n| `FB_WWW_PROFILING` | CJS | Facebook web | Internal profiling |\n| `RN_OSS_DEV` | CJS | React Native OSS | RN open source dev |\n| `RN_OSS_PROD` | CJS | React Native OSS | RN open source prod |\n| `RN_OSS_PROFILING` | CJS | React Native OSS | RN open source profiling |\n| `RN_FB_DEV` | CJS | React Native FB | RN internal dev |\n| `RN_FB_PROD` | CJS | React Native FB | RN internal prod |\n| `RN_FB_PROFILING` | CJS | React Native FB | RN internal profiling |\n| `BROWSER_SCRIPT` | IIFE | Browser | Direct script inclusion |\n\n**Sources:** [scripts/rollup/bundles.js:10-31](), [scripts/rollup/build.js:50-71]()\n\n### Output Directory Structure\n\n```mermaid\ngraph TB\n    Build["build/"]\n    \n    NodeModules["node_modules/"]\n    FacebookWWW["facebook-www/"]\n    FacebookRN["facebook-react-native/"]\n    ReactNative["react-native/"]\n    \n    Build --> NodeModules\n    Build --> FacebookWWW\n    Build --> FacebookRN\n    Build --> ReactNative\n    \n    NodeModules --> ReactPkg["react/"]\n    NodeModules --> ReactDOMPkg["react-dom/"]\n    NodeModules --> SchedulerPkg["scheduler/"]\n    \n    ReactPkg --> ReactCJS["cjs/"]\n    ReactPkg --> ReactESM["esm/"]\n    ReactPkg --> ReactNPM["npm/"]\n    \n    ReactDOMPkg --> DOMcjs["cjs/"]\n    ReactDOMPkg --> DOMesm["esm/"]\n    \n    FacebookWWW --> WWWBundles["*.js (FB_WWW_* bundles)"]\n    FacebookWWW --> WWWShims["shims/"]\n    \n    ReactNative --> RNImplementations["implementations/"]\n    ReactNative --> RNShims["shims/"]\n    \n    FacebookRN --> FBRNReact["react/cjs/"]\n    FacebookRN --> FBRNReactDOM["react-dom/cjs/"]\n    FacebookRN --> FBRNScheduler["scheduler/cjs/"]\n```\n\n**Sources:** [scripts/rollup/packaging.js:48-114]()\n\n---\n\n## Build Pipeline\n\n### Build Orchestration\n\nThe build process is orchestrated by `build.js`, which coordinates bundle generation across all configurations:\n\n```mermaid\ngraph TB\n    Entry["Build Entry Point<br/>scripts/rollup/build.js"]\n    \n    ParseArgs["Parse CLI Arguments<br/>--type, bundle names, --watch"]\n    LoadBundles["Load Bundle Configs<br/>from bundles.js"]\n    FilterBundles["Filter by Requested<br/>Types and Names"]\n    \n    Entry --> ParseArgs\n    ParseArgs --> LoadBundles\n    LoadBundles --> FilterBundles\n    \n    subgraph "For Each Bundle"\n        ResolveEntry["Resolve Entry Fork<br/>resolveEntryFork()"]\n        GetPlugins["Build Plugin Pipeline<br/>getPlugins()"]\n        ConfigRollup["Configure Rollup<br/>input, external, treeshake"]\n        RunRollup["Execute Rollup Build"]\n        WrapOutput["Apply Wrappers<br/>license, module boundaries"]\n        RecordSize["Record Bundle Size<br/>to Stats"]\n    end\n    \n    FilterBundles --> ResolveEntry\n    ResolveEntry --> GetPlugins\n    GetPlugins --> ConfigRollup\n    ConfigRollup --> RunRollup\n    RunRollup --> WrapOutput\n    WrapOutput --> RecordSize\n    \n    RecordSize --> PackagePrep["Prepare NPM Packages<br/>prepareNpmPackages()"]\n    RecordSize --> CopyShims["Copy Shims<br/>copyAllShims()"]\n    RecordSize --> Sync["Sync to Facebook<br/>if --sync-* args"]\n```\n\n**Sources:** [scripts/rollup/build.js:635-785](), [scripts/rollup/build.js:94-108]()\n\n### Entry Point Resolution\n\nEntry points use a forking mechanism to select environment-specific implementations:\n\n```mermaid\ngraph LR\n    BaseEntry["base/entry.js"]\n    \n    FBModern[".modern.fb.js"]\n    FBClassic[".classic.fb.js"]\n    FBGeneric[".fb.js"]\n    Experimental[".experimental.js"]\n    Stable[".stable.js"]\n    DevVariant[".development.js"]\n    \n    BaseEntry -->|"FB_WWW + __EXPERIMENTAL__"| FBModern\n    BaseEntry -->|"FB_WWW + !__EXPERIMENTAL__"| FBClassic\n    BaseEntry -->|"FB_WWW (fallback)"| FBGeneric\n    BaseEntry -->|"!FB + __EXPERIMENTAL__"| Experimental\n    BaseEntry -->|"!FB + !__EXPERIMENTAL__"| Stable\n    \n    FBModern -.->|"isDev"| DevVariant\n    Experimental -.->|"isDev"| DevVariant\n```\n\n**Sources:** [scripts/rollup/build.js:585-633]()\n\n### Plugin Pipeline\n\nEach bundle type uses a customized Rollup plugin pipeline:\n\n```mermaid\ngraph TB\n    SourceCode["Source Code<br/>(Flow/TypeScript)"]\n    \n    subgraph "Preprocessing"\n        DynamicImports["dynamicImports()<br/>Keep dynamic imports external"]\n        TypeRemoval["Flow/TypeScript Removal<br/>flowRemoveTypes() or typescript()"]\n        CommonJS["commonjs()<br/>For TypeScript bundles only"]\n    end\n    \n    subgraph "Module Resolution"\n        Forks["useForks()<br/>Environment-specific modules"]\n        ForbidFB["forbidFBJSImports()<br/>Prevent fbjs imports"]\n        Resolve["resolve()<br/>Node module resolution"]\n    end\n    \n    subgraph "Transformation"\n        StripBanner["stripBanner()<br/>Remove license headers"]\n        Babel["babel()<br/>ES2015+  ES5"]\n        RemoveStrict["Remove \'use strict\'"]\n        Replace["replace()<br/>__DEV__, __PROFILE__, etc"]\n        External["externalRuntime()<br/>For server-external-runtime"]\n    end\n    \n    subgraph "Optimization"\n        TopLevel["wrapWithTopLevelDefinitions()<br/>Module boundaries"]\n        Closure["closure()<br/>Google Closure Compiler"]\n        Prettier["prettier()<br/>Format output"]\n    end\n    \n    subgraph "Finalization"\n        License["wrapWithLicenseHeader()"]\n        Sizes["sizes()<br/>Record bundle metrics"]\n    end\n    \n    SourceCode --> DynamicImports\n    DynamicImports --> TypeRemoval\n    TypeRemoval --> CommonJS\n    CommonJS --> Forks\n    Forks --> ForbidFB\n    ForbidFB --> Resolve\n    Resolve --> StripBanner\n    StripBanner --> Babel\n    Babel --> RemoveStrict\n    RemoveStrict --> Replace\n    Replace --> External\n    External --> TopLevel\n    TopLevel --> Closure\n    Closure --> Prettier\n    Prettier --> License\n    License --> Sizes\n```\n\n**Sources:** [scripts/rollup/build.js:354-546]()\n\n---\n\n## Package Preparation\n\n### NPM Package Generation Process\n\nAfter building, artifacts are prepared for npm distribution:\n\n```mermaid\ngraph TB\n    BuildComplete["Build Complete<br/>Artifacts in build/"]\n    \n    CopyFiles["Copy Package Files<br/>LICENSE, README.md, package.json"]\n    CopyNPM["Copy npm/ Directory<br/>Wrapper files"]\n    \n    FilterEntries["filterOutEntrypoints()<br/>Remove unbundled entries"]\n    ReadPkgJSON["Read package.json"]\n    CheckFiles["Check files[] array"]\n    \n    subgraph "Entry Point Filtering"\n        FindEntry["For each file in files[]"]\n        CheckBundle["Check entryPointsToHasBundle Map"]\n        HasBundle{Has Bundle?}\n        KeepFile["Keep in files[]"]\n        RemoveFile["Remove from files[]<br/>Delete file<br/>Update exports, browser"]\n    end\n    \n    NPMPack["npm pack build/node_modules/PKG"]\n    ExtractTar["Extract .tgz"]\n    StripPackage["Strip \'package/\' prefix"]\n    \n    BuildComplete --> CopyFiles\n    CopyFiles --> CopyNPM\n    CopyNPM --> FilterEntries\n    \n    FilterEntries --> ReadPkgJSON\n    ReadPkgJSON --> CheckFiles\n    CheckFiles --> FindEntry\n    FindEntry --> CheckBundle\n    CheckBundle --> HasBundle\n    HasBundle -->|Yes| KeepFile\n    HasBundle -->|No| RemoveFile\n    \n    RemoveFile --> NPMPack\n    KeepFile --> NPMPack\n    NPMPack --> ExtractTar\n    ExtractTar --> StripPackage\n```\n\n**Sources:** [scripts/rollup/packaging.js:253-273](), [scripts/rollup/packaging.js:171-251]()\n\n### Package Structure Example (react-dom)\n\nThe `react-dom` package demonstrates multi-environment entry points:\n\n| Entry Point | File | Condition | Bundle Type |\n|-------------|------|-----------|-------------|\n| `.` | `index.js` | default | NODE_DEV/PROD |\n| `.` | `react-dom.react-server.js` | react-server | SERVER |\n| `./client` | `client.js` | default | NODE_DEV/PROD |\n| `./client` | `client.react-server.js` | react-server | SERVER |\n| `./server` | `server.node.js` | node | NODE_DEV/PROD |\n| `./server` | `server.browser.js` | browser/worker | BROWSER |\n| `./server` | `server.edge.js` | edge-light/workerd | EDGE |\n| `./server` | `server.bun.js` | bun | BUN_DEV/PROD |\n| `./profiling` | `profiling.js` | default | NODE_PROFILING |\n| `./test-utils` | `test-utils.js` | default | NODE_DEV/PROD |\n\n**Sources:** [packages/react-dom/package.json:51-125]()\n\n### Bundle Output Path Mapping\n\nThe `getBundleOutputPath()` function maps bundles to their destination paths:\n\n```mermaid\ngraph TB\n    Bundle["Bundle Configuration"]\n    \n    NodeESM["NODE_ES2015/ESM_*<br/> build/node_modules/PKG/esm/"]\n    NodeCJS["NODE_DEV/PROD/PROFILING<br/> build/node_modules/PKG/cjs/"]\n    BunCJS["BUN_DEV/PROD<br/> build/node_modules/PKG/cjs/"]\n    \n    FBWWW["FB_WWW_*<br/> build/facebook-www/"]\n    \n    RNOSSImpl["RN_OSS_* (react-native-renderer)<br/> build/react-native/implementations/"]\n    RNFBImpl["RN_FB_* (react-native-renderer)<br/> build/react-native/implementations/*.fb.js"]\n    RNFBPkg["RN_FB_* (other packages)<br/> build/facebook-react-native/PKG/cjs/"]\n    \n    BrowserScript["BROWSER_SCRIPT<br/> build/node_modules/PKG/outputPath"]\n    \n    Bundle --> NodeESM\n    Bundle --> NodeCJS\n    Bundle --> BunCJS\n    Bundle --> FBWWW\n    Bundle --> RNOSSImpl\n    Bundle --> RNFBImpl\n    Bundle --> RNFBPkg\n    Bundle --> BrowserScript\n```\n\n**Sources:** [scripts/rollup/packaging.js:48-114]()\n\n---\n\n## Facebook Internal Synchronization\n\n### Sync Infrastructure\n\nThe `sync.js` module provides utilities to copy build artifacts to Facebook\'s internal repositories:\n\n```mermaid\ngraph TB\n    BuildArtifacts["Build Artifacts"]\n    \n    SyncFBSource["Sync to fbsource<br/>--sync-fbsource PATH"]\n    SyncWWW["Sync to www<br/>--sync-www PATH"]\n    \n    subgraph "fbsource Sync"\n        RNPath["xplat/js/react-native-github/<br/>Libraries/Renderer/"]\n        CopyRN["Copy RN_FB_* bundles"]\n    end\n    \n    subgraph "www Sync"\n        WWWPath["~/www/"]\n        CopyWWW["Copy FB_WWW_* bundles"]\n    end\n    \n    BuildArtifacts --> SyncFBSource\n    BuildArtifacts --> SyncWWW\n    \n    SyncFBSource --> RNPath\n    RNPath --> CopyRN\n    \n    SyncWWW --> WWWPath\n    WWWPath --> CopyWWW\n```\n\n**Sources:** [scripts/rollup/sync.js:1-47]()\n\n### Shim Files\n\nEnvironment-specific shims are copied to build outputs:\n\n- **Facebook WWW**: [scripts/rollup/shims/facebook-www]()  `build/facebook-www/shims/`\n- **React Native**: [scripts/rollup/shims/react-native]()  `build/react-native/shims/`\n- **RN Types**: [react-native-renderer/src/ReactNativeTypes.js]()  `build/react-native/shims/ReactNativeTypes.js`\n\n**Sources:** [scripts/rollup/packaging.js:117-137]()\n\n---\n\n## Build Validation\n\n### Artifact Linting System\n\nAfter the build completes, all artifacts are validated using ESLint with environment-specific configurations:\n\n```mermaid\ngraph TB\n    Validate["validate/index.js"]\n    \n    GlobFiles["Glob build/**/*.js"]\n    DetermineFormat["getFormat(filepath)"]\n    \n    FormatFB{Format?}\n    FormatRN[RN]\n    FormatCJS[CJS]\n    FormatCJS2015[CJS2015]\n    FormatESM[ESM]\n    \n    ConfigFB["eslintrc.fb.js"]\n    ConfigRN["eslintrc.rn.js"]\n    ConfigCJS["eslintrc.cjs.js"]\n    ConfigCJS2015["eslintrc.cjs2015.js"]\n    ConfigESM["eslintrc.esm.js"]\n    \n    RunESLint["ESLint.lintFiles()"]\n    CheckResults["Check for Errors"]\n    ReportErrors["Log Errors with Context"]\n    \n    Validate --> GlobFiles\n    GlobFiles --> DetermineFormat\n    DetermineFormat --> FormatFB\n    \n    FormatFB -->|fb| ConfigFB\n    FormatFB -->|rn| ConfigRN\n    FormatFB -->|cjs| ConfigCJS\n    FormatFB -->|cjs2015| ConfigCJS2015\n    FormatFB -->|esm| ConfigESM\n    \n    ConfigFB --> RunESLint\n    ConfigRN --> RunESLint\n    ConfigCJS --> RunESLint\n    ConfigCJS2015 --> RunESLint\n    ConfigESM --> RunESLint\n    \n    RunESLint --> CheckResults\n    CheckResults --> ReportErrors\n```\n\n**Sources:** [scripts/rollup/validate/index.js:11-100]()\n\n### Environment-Specific ESLint Rules\n\nEach build format has specific global variable and syntax constraints:\n\n| Format | Parser | ECMAScript | Unique Globals |\n|--------|--------|------------|----------------|\n| `fb` | ESLint (ES5) | ES5 | `__DEV__` |\n| `rn` | ESLint (ES5) | ES5 | `__DEV__`, `nativeFabricUIManager`, `RN$enableMicrotasksInReact` |\n| `cjs` | ESLint (ES2020) | ES2020 | Node.js globals (`process`, `Buffer`, `setImmediate`) |\n| `cjs2015` | ESLint (ES2020) | ES2020 | Same as CJS, plus ES2015+ features |\n| `esm` | ESLint (ES2020) | ES2020 | Same as CJS |\n\nAll formats validate:\n- No undefined variables (`no-undef`)\n- No shadowing restricted names (`no-shadow-restricted-names`)\n- No `JSCompiler_OptimizeArgumentsArray_*` identifiers (GCC optimization artifact)\n\n**Sources:** [scripts/rollup/validate/eslintrc.fb.js:1-112](), [scripts/rollup/validate/eslintrc.rn.js:1-97](), [scripts/rollup/validate/eslintrc.cjs.js:1-111](), [scripts/rollup/validate/eslintrc.cjs2015.js:1-111](), [scripts/rollup/validate/eslintrc.esm.js:1-112]()\n\n---\n\n## Build Script Integration\n\n### Primary Build Commands\n\nThe root `package.json` defines build workflows:\n\n```mermaid\ngraph LR\n    BuildCmd["yarn build"]\n    BuildReleaseChannels["build-all-release-channels.js"]\n    \n    BuildDevTools["yarn build-for-devtools"]\n    BuildFlight["yarn build-for-flight-dev"]\n    BuildVT["yarn build-for-vt-dev"]\n    \n    BuildCmd --> BuildReleaseChannels\n    BuildReleaseChannels --> BuildStable["Build stable channel"]\n    BuildReleaseChannels --> BuildExperimental["Build experimental channel"]\n    \n    BuildDevTools --> FilteredBuild1["react, react-dom, scheduler<br/>NODE_DEV/PROD, experimental"]\n    BuildFlight --> FilteredBuild2["RSC packages<br/>NODE_DEV, ESM_PROD, NODE_ES2015"]\n    BuildVT --> FilteredBuild3["View Transitions<br/>NODE_DEV, experimental"]\n```\n\nKey command arguments:\n- `--type=BUNDLE_TYPE`: Filter by bundle type (e.g., `NODE_DEV`, `FB_WWW_PROD`)\n- Bundle names: Filter by entry point (e.g., `react/index`, `react-dom/server`)\n- `--watch`: Enable watch mode for development\n- `--sync-fbsource PATH`: Sync to Facebook internal monorepo\n- `--sync-www PATH`: Sync to Facebook www repository\n\n**Sources:** [package.json:124-157]()\n\n### Release Channel Environment Variable\n\nThe `RELEASE_CHANNEL` environment variable controls which feature flag fork is used:\n\n- `RELEASE_CHANNEL=experimental`: Enables experimental features, uses `.experimental.js` forks\n- `RELEASE_CHANNEL=stable`: Uses stable feature flags, uses `.stable.js` forks\n- Undefined: Defaults to experimental\n\n**Sources:** [scripts/rollup/build.js:31-38](), [scripts/rollup/bundles.js:3-8]()\n\n---\n\n## Artifact Metadata\n\n### Bundle Size Tracking\n\nThe `sizes-plugin` records bundle sizes during build:\n\n```javascript\n// In getPlugins()\nsizes({\n  getSize: (size, gzip) => {\n    const currentSizes = Stats.currentBuildResults.bundleSizes;\n    const recordIndex = currentSizes.findIndex(\n      record =>\n        record.filename === filename && record.bundleType === bundleType\n    );\n    const index = recordIndex !== -1 ? recordIndex : currentSizes.length;\n    currentSizes[index] = {\n      filename,\n      bundleType,\n      packageName,\n      size,\n      gzip,\n    };\n  },\n})\n```\n\nThis data is stored in the `Stats` module and used for size regression analysis.\n\n**Sources:** [scripts/rollup/build.js:522-538]()\n\n### Version Management\n\nThe canonical version is maintained in `ReactVersion.js`:\n\n```javascript\nexport default \'19.3.0\';\n```\n\nThis version is:\n- Used at runtime for DevTools compatibility\n- Injected into package.json files during package preparation\n- Referenced by release scripts\n\n**Sources:** [packages/shared/ReactVersion.js:1-16](), [packages/react/package.json:7](), [packages/react-dom/package.json:3]()\n\n---\n\n## Code Wrapping and Headers\n\n### Module Boundary Wrappers\n\nThe `wrappers.js` module provides environment-specific code wrapping:\n\n**Development Bundles (NODE_DEV, FB_WWW_DEV, RN_OSS_DEV, RN_FB_DEV)**:\n```javascript\n\'use strict\';\n\nif (__DEV__) {  // or process.env.NODE_ENV !== "production"\n  (function() {\n    // Bundle code here\n  })();\n}\n```\n\n**Production Bundles**: No wrapping, direct execution\n\n**Reconciler Bundles with DevTools**:\n```javascript\n\'use strict\';\nif (typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== \'undefined\' &&\n    typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart === \'function\') {\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error());\n}\n// Bundle code\nif (typeof __REACT_DEVTOOLS_GLOBAL_HOOK__ !== \'undefined\' &&\n    typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop === \'function\') {\n  __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error());\n}\n```\n\n**Sources:** [scripts/rollup/wrappers.js:32-169]()\n\n### License Headers\n\nAll production artifacts include the MIT license header:\n\n```\n/**\n * Copyright (c) Meta Platforms, Inc. and affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n```\n\n**Sources:** [scripts/rollup/wrappers.js:53-56]()\n\n---\n\n# Page: React Reconciler\n\n# React Reconciler\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-debug-tools/src/ReactDebugHooks.js](packages/react-debug-tools/src/ReactDebugHooks.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspection-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspection-test.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegration-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegration-test.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegrationDOM-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegrationDOM-test.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/CustomHooks.js](packages/react-devtools-shell/src/app/InspectableElements/CustomHooks.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberHooks.js](packages/react-reconciler/src/ReactFiberHooks.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRoot.js](packages/react-reconciler/src/ReactFiberRoot.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactInternalTypes.js](packages/react-reconciler/src/ReactInternalTypes.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactHooks-test.internal.js](packages/react-reconciler/src/__tests__/ReactHooks-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFizzHooks.js](packages/react-server/src/ReactFizzHooks.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightHooks.js](packages/react-server/src/ReactFlightHooks.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactHooks.js](packages/react/src/ReactHooks.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\nThe React Reconciler is the platform-agnostic core reconciliation algorithm that coordinates React updates. It implements the Fiber architecture, manages component lifecycles, schedules work, and delegates host-specific operations to pluggable renderers through the `ReactFiberConfig` interface.\n\n**Scope**: This page covers the reconciler\'s architecture, work loop execution, phase separation, and coordination mechanisms. For specific renderer implementations (DOM, Native), see [Rendering Targets](#4). For server-side rendering systems (Fizz, Flight), see [Server-Side Rendering](#5). For Hooks implementation details, see [React Hooks System](#3.2). For scheduling and priority details, see [Lane-Based Priority and Scheduling](#3.4).\n\n---\n\n## Reconciler Architecture Overview\n\n```mermaid\ngraph TB\n    subgraph "React Public API"\n        JSX["JSX / React.createElement"]\n        Hooks["useState/useEffect/..."]\n        Context["Context API"]\n    end\n    \n    subgraph "Reconciler Core (react-reconciler/src/)"\n        ReconcilerAPI["ReactFiberReconciler.js<br/>createContainer()<br/>updateContainer()"]\n        WorkLoop["ReactFiberWorkLoop.js<br/>performWorkOnRoot()<br/>renderRootSync/Concurrent()"]\n        BeginWork["ReactFiberBeginWork.js<br/>beginWork()<br/>updateFunctionComponent()"]\n        CompleteWork["ReactFiberCompleteWork.js<br/>completeWork()<br/>createInstance()"]\n        CommitWork["ReactFiberCommitWork.js<br/>commitMutationEffects()<br/>commitLayoutEffects()"]\n        Hooks2["ReactFiberHooks.js<br/>renderWithHooks()<br/>mountState()/updateState()"]\n    end\n    \n    subgraph "Fiber Data Structure"\n        FiberNode["Fiber (ReactInternalTypes.js)<br/>tag: WorkTag<br/>stateNode: any<br/>memoizedState: any<br/>updateQueue: UpdateQueue"]\n        FiberRoot["FiberRoot<br/>current: Fiber<br/>containerInfo: Container<br/>pendingLanes: Lanes"]\n    end\n    \n    subgraph "Host Configuration"\n        HostConfig["ReactFiberConfig.js<br/>createInstance()<br/>appendChild()<br/>commitUpdate()"]\n    end\n    \n    subgraph "Renderers"\n        DOM["ReactFiberConfigDOM"]\n        Native["ReactFiberConfigNative"]\n    end\n    \n    JSX --> ReconcilerAPI\n    Hooks --> Hooks2\n    Context --> BeginWork\n    \n    ReconcilerAPI --> WorkLoop\n    WorkLoop --> BeginWork\n    BeginWork --> CompleteWork\n    CompleteWork --> CommitWork\n    Hooks2 --> BeginWork\n    \n    BeginWork --> FiberNode\n    CompleteWork --> FiberNode\n    WorkLoop --> FiberRoot\n    \n    CompleteWork --> HostConfig\n    CommitWork --> HostConfig\n    \n    HostConfig --> DOM\n    HostConfig --> Native\n    \n    style WorkLoop fill:#f9f9f9\n    style HostConfig fill:#f9f9f9\n```\n\nThe reconciler operates through a two-phase render cycle: the **render phase** (interruptible) walks the Fiber tree calling `beginWork` and `completeWork`, and the **commit phase** (synchronous) applies changes to the host environment.\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1-1279](), [packages/react-reconciler/src/ReactFiberReconciler.js:1-354](), [packages/react-reconciler/src/ReactInternalTypes.js:88-207]()\n\n---\n\n## Fiber Data Structure\n\nThe **Fiber** is the fundamental unit of work in the reconciler. Each Fiber node represents a component instance and its associated work.\n\n```mermaid\ngraph LR\n    subgraph "Fiber Node Structure"\n        Fiber["Fiber<br/>ReactInternalTypes.js:88-207"]\n        \n        Identity["Identity Fields<br/>tag: WorkTag<br/>key: string | null<br/>elementType: any<br/>type: any<br/>stateNode: any"]\n        \n        Tree["Tree Structure<br/>return: Fiber | null<br/>child: Fiber | null<br/>sibling: Fiber | null<br/>index: number"]\n        \n        State["State & Props<br/>pendingProps: mixed<br/>memoizedProps: mixed<br/>memoizedState: any<br/>updateQueue: UpdateQueue"]\n        \n        Effects["Effects<br/>flags: Flags<br/>subtreeFlags: Flags<br/>deletions: Array<Fiber>"]\n        \n        Scheduling["Scheduling<br/>lanes: Lanes<br/>childLanes: Lanes<br/>alternate: Fiber | null"]\n    end\n    \n    Fiber --> Identity\n    Fiber --> Tree\n    Fiber --> State\n    Fiber --> Effects\n    Fiber --> Scheduling\n```\n\n| Field | Purpose |\n|-------|---------|\n| `tag` | WorkTag identifying component type (FunctionComponent, ClassComponent, HostComponent, etc.) |\n| `stateNode` | Reference to DOM node, class instance, or other host instance |\n| `memoizedState` | Output state from last render; for hooks, this is the linked list of Hook objects |\n| `updateQueue` | Queue of state updates and effects to process |\n| `flags` | Side-effect flags (Placement, Update, Deletion, Passive, etc.) |\n| `lanes` | Priority lanes representing pending work on this fiber |\n| `alternate` | Double-buffering: points to the current tree\'s corresponding fiber during updates |\n\n**Sources**: [packages/react-reconciler/src/ReactInternalTypes.js:88-207](), [packages/react-reconciler/src/ReactFiber.js:136-209]()\n\n---\n\n## Work Loop Execution Model\n\nThe work loop is the heart of the reconciler, managing the progression through render and commit phases.\n\n```mermaid\ngraph TB\n    Start["scheduleUpdateOnFiber()<br/>ReactFiberWorkLoop.js:916"]\n    \n    EnsureScheduled["ensureRootIsScheduled()<br/>Determine next work lanes"]\n    \n    PerformWork["performWorkOnRoot()<br/>ReactFiberWorkLoop.js:1066"]\n    \n    TimeSlice{"shouldTimeSlice?<br/>!forceSync &&<br/>!includesBlockingLane()"}\n    \n    RenderSync["renderRootSync()<br/>ReactFiberWorkLoop.js:1499"]\n    RenderConcurrent["renderRootConcurrent()<br/>ReactFiberWorkLoop.js:1416"]\n    \n    WorkLoopSync["workLoopSync()<br/>while (workInProgress !== null)<br/>  performUnitOfWork()"]\n    \n    WorkLoopConcurrent["workLoopConcurrent()<br/>while (workInProgress !== null<br/>  && !shouldYield())<br/>  performUnitOfWork()"]\n    \n    UnitOfWork["performUnitOfWork()<br/>ReactFiberWorkLoop.js:1794"]\n    \n    BeginPhase["beginWork()<br/>ReactFiberBeginWork.js"]\n    CompletePhase["completeUnitOfWork()<br/>completeWork()"]\n    \n    CommitRoot["commitRoot()<br/>ReactFiberWorkLoop.js:2386"]\n    \n    CommitBeforeMutation["commitBeforeMutationEffects()"]\n    CommitMutation["commitMutationEffects()"]\n    CommitLayout["commitLayoutEffects()"]\n    CommitPassive["flushPassiveEffects()"]\n    \n    Start --> EnsureScheduled\n    EnsureScheduled --> PerformWork\n    PerformWork --> TimeSlice\n    \n    TimeSlice -->|Yes| RenderConcurrent\n    TimeSlice -->|No| RenderSync\n    \n    RenderSync --> WorkLoopSync\n    RenderConcurrent --> WorkLoopConcurrent\n    \n    WorkLoopSync --> UnitOfWork\n    WorkLoopConcurrent --> UnitOfWork\n    \n    UnitOfWork --> BeginPhase\n    BeginPhase --> CompletePhase\n    \n    CompletePhase --> CommitRoot\n    \n    CommitRoot --> CommitBeforeMutation\n    CommitBeforeMutation --> CommitMutation\n    CommitMutation --> CommitLayout\n    CommitLayout --> CommitPassive\n```\n\n### Render Phase\n\nThe render phase walks the Fiber tree and determines what changes are needed. It consists of two sub-phases:\n\n**Begin Work** ([ReactFiberBeginWork.js:1400-2900]()):\n- Processes the component (calls render, hooks, etc.)\n- Reconciles children using `reconcileChildren`\n- Returns the next child fiber to process\n- Key functions: `updateFunctionComponent`, `updateClassComponent`, `updateHostComponent`\n\n**Complete Work** ([ReactFiberCompleteWork.js:600-1200]()):\n- Creates or updates host instances via `createInstance`, `finalizeInitialChildren`\n- Bubbles up side-effect flags from children\n- Returns to parent, then processes sibling\n\nThe render phase is **interruptible** in concurrent mode  `shouldYield()` allows pausing to handle higher-priority work.\n\n### Commit Phase\n\nThe commit phase applies the work from the render phase. It is **synchronous and uninterruptible**:\n\n1. **Before Mutation** ([ReactFiberCommitWork.js:343-591]()): `getSnapshotBeforeUpdate`, prepare for DOM mutations\n2. **Mutation** ([ReactFiberCommitWork.js:2400-3100]()): Apply DOM changes (insert, update, delete nodes)\n3. **Layout** ([ReactFiberCommitWork.js:593-870]()): `componentDidMount`, `useLayoutEffect`, ref attachment\n4. **Passive** ([ReactFiberCommitWork.js:2629-2800]()): `useEffect` (scheduled after paint)\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1066-1800](), [packages/react-reconciler/src/ReactFiberBeginWork.js:341-470](), [packages/react-reconciler/src/ReactFiberCommitWork.js:343-870]()\n\n---\n\n## Host Configuration Abstraction\n\nThe reconciler delegates all platform-specific operations through the `ReactFiberConfig` interface. This enables React to target multiple platforms without modifying core logic.\n\n```mermaid\ngraph TB\n    subgraph "Reconciler Operations"\n        CreateInst["createInstance() call<br/>in completeWork()"]\n        AppendChild["appendChild() call<br/>in commitMutationEffects()"]\n        CommitUpdate["commitUpdate() call<br/>in commitMutationEffects()"]\n    end\n    \n    subgraph "ReactFiberConfig Interface"\n        Config["ReactFiberConfig.js<br/>Platform-specific implementation"]\n        \n        Methods["Key Methods:<br/>createInstance(type, props)<br/>createTextInstance(text)<br/>appendChild(parent, child)<br/>insertBefore(parent, child, before)<br/>removeChild(parent, child)<br/>commitUpdate(instance, type, oldProps, newProps)<br/>finalizeInitialChildren(instance, type, props)<br/>prepareForCommit(container)<br/>resetAfterCommit(container)"]\n    end\n    \n    subgraph "Renderer Implementations"\n        DOMConfig["ReactFiberConfigDOM.js<br/>DOM-specific"]\n        FabricConfig["ReactFiberConfigFabric.js<br/>React Native Fabric"]\n        NoopConfig["ReactNoop.js<br/>Testing"]\n    end\n    \n    CreateInst --> Config\n    AppendChild --> Config\n    CommitUpdate --> Config\n    \n    Config --> Methods\n    \n    Methods --> DOMConfig\n    Methods --> FabricConfig\n    Methods --> NoopConfig\n```\n\n### Mutation vs Persistence\n\nRenderers implement one of two strategies:\n\n**Mutation Mode** (DOM, React Native Legacy):\n- `supportsMutation = true`\n- Modifies host instances in place\n- Methods: `appendChild`, `removeChild`, `commitUpdate`\n\n**Persistence Mode** (React Native Fabric):\n- `supportsPersistence = true`\n- Clones and replaces entire subtrees\n- Methods: `cloneInstance`, `createContainerChildSet`, `replaceContainerChildren`\n\n### Example: DOM Renderer Integration\n\n```\ncompleteWork()  createInstance()  document.createElement()\ncommitMutationEffects()  appendChild()  parentInstance.appendChild()\ncommitMutationEffects()  commitUpdate()  updateProperties()\n```\n\nThe reconciler calls high-level operations like `createInstance`; the DOM renderer translates these to `document.createElement()`, `node.appendChild()`, etc.\n\n**Sources**: [packages/react-reconciler/src/ReactFiberCompleteWork.js:105-129](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-50](), [packages/react-reconciler/src/ReactFiberCommitWork.js:154-186]()\n\n---\n\n## Reconciliation and Diffing\n\nWhen React updates a component, it reconciles the new children with the existing Fiber tree.\n\n```mermaid\ngraph TB\n    ReconcileChildren["reconcileChildren()<br/>ReactFiberBeginWork.js:341"]\n    \n    MountOrUpdate{"current === null?"}\n    \n    MountChildren["mountChildFibers()<br/>No side-effects tracking"]\n    ReconcileExisting["reconcileChildFibers()<br/>Track Placement, Deletion"]\n    \n    ChildReconciler["ChildReconciler<br/>ReactChildFiber.js"]\n    \n    SingleChild["reconcileSingleElement()<br/>Single child reconciliation"]\n    ArrayChildren["reconcileChildrenArray()<br/>List reconciliation with keys"]\n    \n    PlacementFlag["Mark Fiber with Placement flag"]\n    DeletionFlag["Add old Fiber to deletions array"]\n    UpdateFlag["Reuse existing Fiber, update props"]\n    \n    ReconcileChildren --> MountOrUpdate\n    MountOrUpdate -->|Mount| MountChildren\n    MountOrUpdate -->|Update| ReconcileExisting\n    \n    MountChildren --> ChildReconciler\n    ReconcileExisting --> ChildReconciler\n    \n    ChildReconciler --> SingleChild\n    ChildReconciler --> ArrayChildren\n    \n    SingleChild --> PlacementFlag\n    ArrayChildren --> PlacementFlag\n    ArrayChildren --> DeletionFlag\n    ArrayChildren --> UpdateFlag\n```\n\n### Array Reconciliation Algorithm\n\nWhen reconciling an array of children ([ReactChildFiber.js:800-1200]()):\n\n1. **First Pass**: Walk old and new children in parallel, matching by `key` (if provided) or `index`\n   - If `key` matches and `type` matches: reuse Fiber, update props\n   - If mismatch: break and proceed to repositioning\n\n2. **Deletions**: Remaining old children not matched are marked for deletion\n\n3. **Insertions**: Remaining new children create new Fibers with `Placement` flag\n\n4. **Key Map**: For complex reorderings, build a map of `key  Fiber` to efficiently find matches\n\nThe reconciler marks each Fiber with flags:\n- `Placement`: Needs to be inserted into DOM\n- `Update`: Props changed, needs DOM update\n- `Deletion`: Needs to be removed from DOM\n\n**Sources**: [packages/react-reconciler/src/ReactFiberBeginWork.js:341-404](), [packages/react-reconciler/src/ReactChildFiber.js:800-1200]()\n\n---\n\n## Global State and Work-in-Progress\n\nThe reconciler maintains global mutable state during rendering:\n\n```mermaid\ngraph LR\n    subgraph "Global State (ReactFiberWorkLoop.js)"\n        ExecutionContext["executionContext: ExecutionContext<br/>NoContext | RenderContext | CommitContext"]\n        WIPRoot["workInProgressRoot: FiberRoot | null"]\n        WIP["workInProgress: Fiber | null"]\n        WIPLanes["workInProgressRootRenderLanes: Lanes"]\n        WIPExitStatus["workInProgressRootExitStatus: RootExitStatus<br/>RootInProgress | RootCompleted | RootSuspended..."]\n    end\n    \n    subgraph "Current vs Work-in-Progress"\n        CurrentTree["current tree<br/>Visible on screen"]\n        WIPTree["workInProgress tree<br/>Being built"]\n        Alternate["Fibers linked via<br/>alternate pointer"]\n    end\n    \n    ExecutionContext -.-> WIPRoot\n    WIPRoot --> WIP\n    WIPRoot --> CurrentTree\n    CurrentTree --> Alternate\n    Alternate --> WIPTree\n```\n\n**Double Buffering**: React maintains two Fiber trees:\n- **Current tree**: The currently rendered tree, visible to the user\n- **Work-in-progress tree**: The tree being built during an update\n\nEach Fiber\'s `alternate` pointer links to its counterpart in the other tree. After commit, the work-in-progress tree becomes the current tree via pointer swap ([ReactFiberWorkLoop.js:2600-2650]()).\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:406-526](), [packages/react-reconciler/src/ReactFiber.js:360-480]()\n\n---\n\n## Render Exit Statuses\n\nThe render phase can exit in multiple states ([ReactFiberWorkLoop.js:413-420]()):\n\n| Status | Description |\n|--------|-------------|\n| `RootInProgress` | Render is still in progress |\n| `RootCompleted` | Render completed successfully |\n| `RootErrored` | Render hit an error |\n| `RootSuspended` | Render suspended waiting for data |\n| `RootSuspendedWithDelay` | Suspended with throttling delay |\n| `RootSuspendedAtTheShell` | Suspended during initial shell, show fallback immediately |\n| `RootFatalErrored` | Fatal error, cannot recover |\n\nThe status determines whether to commit immediately, retry, or show a Suspense fallback.\n\n---\n\n## Error Handling and Boundaries\n\nError handling propagates up the Fiber tree until an error boundary is found.\n\n```mermaid\ngraph TB\n    ThrowException["throwException()<br/>ReactFiberThrow.js"]\n    \n    FindBoundary["Find nearest Suspense or ErrorBoundary<br/>Walk up fiber.return chain"]\n    \n    Boundary{"Boundary type?"}\n    \n    ErrorBoundary["Error Boundary (ClassComponent)<br/>getDerivedStateFromError<br/>componentDidCatch"]\n    \n    SuspenseBoundary["Suspense Boundary<br/>Show fallback UI"]\n    \n    CreateUpdate["createClassErrorUpdate()<br/>Schedule re-render with error"]\n    \n    ShowFallback["Mark SuspenseComponent with<br/>DidCapture flag"]\n    \n    UnwindWork["unwindWork()<br/>ReactFiberUnwindWork.js<br/>Clean up context stacks"]\n    \n    ThrowException --> FindBoundary\n    FindBoundary --> Boundary\n    \n    Boundary -->|Error| ErrorBoundary\n    Boundary -->|Suspense| SuspenseBoundary\n    \n    ErrorBoundary --> CreateUpdate\n    SuspenseBoundary --> ShowFallback\n    \n    CreateUpdate --> UnwindWork\n    ShowFallback --> UnwindWork\n```\n\nWhen an error or promise is thrown:\n\n1. `throwException()` is called with the thrown value\n2. Walk up the tree to find an appropriate boundary\n3. For errors: call `getDerivedStateFromError` on error boundary, schedule re-render\n4. For Suspense: mark boundary with `DidCapture`, prepare to show fallback\n5. `unwindWork()` cleans up any context stacks, unwinds to the boundary\n6. Restart render from the boundary\n\n**Sources**: [packages/react-reconciler/src/ReactFiberThrow.js:400-600](), [packages/react-reconciler/src/ReactFiberUnwindWork.js:63-180](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1900-2100]()\n\n---\n\n## Concurrent Features and Interruption\n\nIn concurrent mode, the render phase can be interrupted to handle higher-priority updates.\n\n```mermaid\ngraph TB\n    WorkLoop["workLoopConcurrent()<br/>ReactFiberWorkLoop.js:1794"]\n    \n    CheckYield{"shouldYield()?<br/>Time slice expired?"}\n    \n    Continue["performUnitOfWork()<br/>Continue rendering"]\n    \n    Yield["Yield to browser<br/>Return from work loop"]\n    \n    Schedule["Schedule continuation<br/>Scheduler.scheduleCallback()"]\n    \n    HighPriorityInterrupt["High-priority update arrives<br/>prepareFreshStack()<br/>Discard WIP, restart"]\n    \n    WorkLoop --> CheckYield\n    CheckYield -->|No| Continue\n    Continue --> WorkLoop\n    \n    CheckYield -->|Yes| Yield\n    Yield --> Schedule\n    \n    Continue -.->|Update arrives| HighPriorityInterrupt\n    HighPriorityInterrupt --> WorkLoop\n```\n\n**Interruption points**:\n- Between units of work (fibers)\n- `shouldYield()` checks if time slice exhausted\n- New higher-priority updates can discard work-in-progress\n\n**Resumption**:\n- Work-in-progress state is preserved\n- Can resume from `workInProgress` fiber\n- Or restart from root for higher priority\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1776-1850](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1300-1400]()\n\n---\n\n## Component Types and Tags\n\nThe reconciler handles different component types via the `WorkTag` enum.\n\n```mermaid\ngraph TB\n    subgraph "Host Components"\n        HostRoot["HostRoot = 3<br/>Root of Fiber tree"]\n        HostComponent["HostComponent = 5<br/>DOM element (div, span)"]\n        HostText["HostText = 6<br/>Text node"]\n        HostPortal["HostPortal = 4<br/>ReactDOM.createPortal"]\n    end\n    \n    subgraph "React Components"\n        FunctionComponent["FunctionComponent = 0<br/>Function components"]\n        ClassComponent["ClassComponent = 1<br/>Class components"]\n        ForwardRef["ForwardRef = 11<br/>React.forwardRef"]\n        MemoComponent["MemoComponent = 14<br/>React.memo"]\n        SimpleMemoComponent["SimpleMemoComponent = 15<br/>Memo with simple comparison"]\n    end\n    \n    subgraph "Async Components"\n        SuspenseComponent["SuspenseComponent = 13<br/>React.Suspense"]\n        SuspenseListComponent["SuspenseListComponent = 23<br/>React.SuspenseList"]\n        OffscreenComponent["OffscreenComponent = 22<br/>Hidden content"]\n        ActivityComponent["ActivityComponent = 25<br/>React.Activity"]\n    end\n    \n    subgraph "Other"\n        Fragment["Fragment = 7<br/>React.Fragment"]\n        ContextProvider["ContextProvider = 10<br/>Context.Provider"]\n        ContextConsumer["ContextConsumer = 9<br/>Context.Consumer"]\n        Profiler["Profiler = 12<br/>React.Profiler"]\n    end\n```\n\nThe `tag` field on each Fiber determines which code path `beginWork` and `completeWork` take.\n\n**Example dispatching** ([ReactFiberBeginWork.js:3800-4100]()):\n```\nswitch (workInProgress.tag) {\n  case FunctionComponent:\n    return updateFunctionComponent(...)\n  case ClassComponent:\n    return updateClassComponent(...)\n  case HostComponent:\n    return updateHostComponent(...)\n  ...\n}\n```\n\n**Sources**: [packages/react-reconciler/src/ReactWorkTags.js:1-60](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3800-4100]()\n\n---\n\n## Context System\n\nReact Context is implemented at the reconciler level.\n\n```mermaid\ngraph TB\n    subgraph "Context Definition"\n        CreateContext["React.createContext(defaultValue)<br/>Returns Context object"]\n        ContextObject["Context = {<br/>  $$typeof: REACT_CONTEXT_TYPE<br/>  _currentValue: any<br/>  Provider: ReactProviderType<br/>  Consumer: ReactContext<br/>}"]\n    end\n    \n    subgraph "Provider in Tree"\n        ProviderFiber["Fiber with tag=ContextProvider<br/>type = Context<br/>pendingProps.value = newValue"]\n        \n        PushProvider["pushProvider()<br/>ReactFiberNewContext.js:200<br/>Push value onto stack"]\n    end\n    \n    subgraph "Consumer in Tree"\n        ConsumerFiber["Component using useContext()<br/>or Context.Consumer"]\n        \n        ReadContext["readContext(Context)<br/>ReactFiberNewContext.js:250<br/>Read from stack"]\n        \n        Dependencies["fiber.dependencies = {<br/>  lanes: Lanes<br/>  firstContext: ContextDependency<br/>}"]\n    end\n    \n    subgraph "Change Propagation"\n        ValueChange["Provider value changes"]\n        Propagate["propagateContextChange()<br/>ReactFiberNewContext.js:300<br/>Mark consumers with lanes"]\n    end\n    \n    CreateContext --> ContextObject\n    ContextObject --> ProviderFiber\n    ProviderFiber --> PushProvider\n    \n    PushProvider --> ConsumerFiber\n    ConsumerFiber --> ReadContext\n    ReadContext --> Dependencies\n    \n    ValueChange --> Propagate\n    Propagate --> ConsumerFiber\n```\n\n**Context mechanism**:\n1. **Stack-based**: Providers push values onto a stack as the tree is traversed\n2. **Dependencies**: Consuming components record a dependency in `fiber.dependencies`\n3. **Bailout prevention**: When context value changes, `propagateContextChange()` marks all consumers with update lanes, preventing bailout\n\n**Key functions**:\n- `pushProvider()` - Push new context value onto stack ([ReactFiberNewContext.js:200-250]())\n- `readContext()` - Read current context value and record dependency ([ReactFiberNewContext.js:250-350]())\n- `propagateContextChange()` - Mark consumers for update when value changes ([ReactFiberNewContext.js:400-550]())\n\n**Sources**: [packages/react-reconciler/src/ReactFiberNewContext.js:200-550](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3200-3350]()\n\n---\n\n## Scheduling Entry Points\n\nUpdates enter the reconciler through several paths:\n\n```mermaid\ngraph TB\n    subgraph "Public API Entry Points"\n        Root["root.render(element)<br/>ReactFiberReconciler.js:356"]\n        SetState["this.setState(update)<br/>classComponentUpdater"]\n        UseState["setStateFromHook<br/>from useState()"]\n        ForceUpdate["this.forceUpdate()"]\n    end\n    \n    subgraph "Update Creation"\n        CreateUpdate["createUpdate(lane)<br/>ReactFiberClassUpdateQueue.js:200"]\n        UpdatePayload["Update = {<br/>  lane: Lane<br/>  tag: UpdateState<br/>  payload: any<br/>  callback: Function | null<br/>  next: Update<br/>}"]\n    end\n    \n    subgraph "Enqueueing"\n        EnqueueUpdate["enqueueUpdate(fiber, update, lane)<br/>ReactFiberClassUpdateQueue.js:500"]\n        \n        ConcurrentUpdate["enqueueConcurrentHookUpdate()<br/>For hooks updates"]\n        \n        UpdateQueue["fiber.updateQueue<br/>Circular linked list"]\n    end\n    \n    subgraph "Scheduling"\n        ScheduleUpdate["scheduleUpdateOnFiber()<br/>ReactFiberWorkLoop.js:916"]\n        RequestLane["requestUpdateLane(fiber)<br/>Determine priority"]\n        MarkRootUpdated["markRootUpdated(root, lane)"]\n        EnsureScheduled["ensureRootIsScheduled(root)<br/>Schedule work with Scheduler"]\n    end\n    \n    Root --> CreateUpdate\n    SetState --> CreateUpdate\n    UseState --> ConcurrentUpdate\n    ForceUpdate --> CreateUpdate\n    \n    CreateUpdate --> UpdatePayload\n    UpdatePayload --> EnqueueUpdate\n    ConcurrentUpdate --> EnqueueUpdate\n    \n    EnqueueUpdate --> UpdateQueue\n    UpdateQueue --> ScheduleUpdate\n    \n    ScheduleUpdate --> RequestLane\n    ScheduleUpdate --> MarkRootUpdated\n    ScheduleUpdate --> EnsureScheduled\n```\n\n**Update lifecycle**:\n1. User calls `setState()` or `render()`\n2. Create an `Update` object with priority lane\n3. Enqueue update onto fiber\'s `updateQueue`\n4. Call `scheduleUpdateOnFiber()` with root and lane\n5. `ensureRootIsScheduled()` schedules work with Scheduler based on lanes\n\n**Sources**: [packages/react-reconciler/src/ReactFiberReconciler.js:356-461](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:916-1042](), [packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:165-243]()\n\n---\n\n## Batching and Synchronization\n\nThe reconciler batches updates to minimize renders.\n\n```mermaid\ngraph TB\n    subgraph "Batching Mechanisms"\n        ExecutionContext2["executionContext flag<br/>BatchedContext = 0b001<br/>RenderContext = 0b010<br/>CommitContext = 0b100"]\n        \n        BatchedUpdates["batchedUpdates(fn)<br/>Set BatchedContext<br/>Execute fn<br/>Clear BatchedContext"]\n        \n        FlushSync["flushSync(fn)<br/>Force synchronous render<br/>Execute fn<br/>flushSyncWork()"]\n    end\n    \n    subgraph "Update Accumulation"\n        Update1["setState() call 1"]\n        Update2["setState() call 2"]\n        Update3["setState() call 3"]\n        \n        Accumulated["All updates on same fiber<br/>merged into updateQueue"]\n    end\n    \n    subgraph "Rendering"\n        SingleRender["Single render pass<br/>processes all updates"]\n    end\n    \n    ExecutionContext2 --> BatchedUpdates\n    BatchedUpdates --> Update1\n    BatchedUpdates --> Update2\n    BatchedUpdates --> Update3\n    \n    Update1 --> Accumulated\n    Update2 --> Accumulated\n    Update3 --> Accumulated\n    \n    Accumulated --> SingleRender\n    \n    FlushSync -.->|Forces| SingleRender\n```\n\n**Automatic batching**: In React 18+, all updates are automatically batched within a single event, timeout, or promise callback. The `executionContext` prevents nested flush operations.\n\n**Manual control**:\n- `flushSync()` - Force synchronous rendering ([ReactFiberWorkLoop.js:1244-1278]())\n- `batchedUpdates()` - Explicit batching (mostly legacy) ([ReactFiberWorkLoop.js:2832-2850]())\n\n**Sources**: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1244-1278](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:2832-2850]()\n\n---\n\n## Refs and Imperative Handles\n\nThe reconciler manages refs and provides imperative access to instances.\n\n```mermaid\ngraph TB\n    subgraph "Ref Types"\n        CallbackRef["Callback Ref<br/>ref={(node) => {...}}"]\n        ObjectRef["Object Ref<br/>ref={useRef()}"]\n        StringRef["String Ref (legacy)<br/>ref=\'myRef\'"]\n    end\n    \n    subgraph "Ref Attachment"\n        CommitLayoutPhase["Layout Effects Phase<br/>commitLayoutEffects()"]\n        \n        AttachRef["safelyAttachRef()<br/>ReactFiberCommitEffects.js:650"]\n        \n        SetRef["Set ref.current = instance<br/>or call ref(instance)"]\n    end\n    \n    subgraph "Ref Cleanup"\n        BeforeUpdate["Before mutation or unmount"]\n        \n        DetachRef["safelyDetachRef()<br/>ReactFiberCommitEffects.js:680"]\n        \n        ClearRef["Set ref.current = null<br/>or call ref(null)"]\n    end\n    \n    subgraph "Imperative Handle"\n        UseImperativeHandle["useImperativeHandle()<br/>Customize ref value"]\n        \n        ImperativeInstance["Custom instance object<br/>returned by callback"]\n    end\n    \n    CallbackRef --> CommitLayoutPhase\n    ObjectRef --> CommitLayoutPhase\n    StringRef --> CommitLayoutPhase\n    \n    CommitLayoutPhase --> AttachRef\n    AttachRef --> SetRef\n    \n    BeforeUpdate --> DetachRef\n    DetachRef --> ClearRef\n    \n    UseImperativeHandle --> ImperativeInstance\n    ImperativeInstance --> AttachRef\n```\n\n**Ref lifecycle**:\n1. **Detachment**: Before mutations, call `safelyDetachRef()` to clear old refs\n2. **Attachment**: In layout phase, call `safelyAttachRef()` to set new refs\n3. **Instance**: For host components, ref points to DOM node; for class components, to class instance; for function components with `useImperativeHandle`, to custom object\n\n**Sources**: [packages/react-reconciler/src/ReactFiberCommitEffects.js:650-720](), [packages/react-reconciler/src/ReactFiberHooks.js:2100-2200]()\n\n---\n\n## Profiler Integration\n\nThe reconciler integrates with React DevTools Profiler to track render times.\n\n```mermaid\ngraph TB\n    subgraph "Timing Collection"\n        ProfilerTimer["enableProfilerTimer<br/>feature flag"]\n        \n        ActualDuration["fiber.actualDuration<br/>Time spent in this render"]\n        \n        TreeBaseDuration["fiber.treeBaseDuration<br/>Total time for subtree"]\n        \n        RecordStart["startProfilerTimer()<br/>ReactProfilerTimer.js:200"]\n        \n        RecordStop["stopProfilerTimerIfRunning()<br/>ReactProfilerTimer.js:250"]\n    end\n    \n    subgraph "Profiler Component"\n        ProfilerTag["<Profiler id=\'x\' onRender={callback}>"]\n        \n        OnRenderCallback["onRender(id, phase, actualDuration,<br/>  baseDuration, startTime, commitTime)"]\n    end\n    \n    subgraph "DevTools Hook"\n        DevToolsHook["__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        \n        MarkRenderStarted["markRenderStarted(lane)"]\n        MarkRenderStopped["markRenderStopped()"]\n        OnCommitRoot["onCommitRoot(root)"]\n    end\n    \n    ProfilerTimer --> RecordStart\n    ProfilerTimer --> RecordStop\n    \n    RecordStart --> ActualDuration\n    RecordStop --> TreeBaseDuration\n    \n    ActualDuration --> ProfilerTag\n    TreeBaseDuration --> ProfilerTag\n    \n    ProfilerTag --> OnRenderCallback\n    \n    RecordStart --> MarkRenderStarted\n    RecordStop --> MarkRenderStopped\n    ActualDuration --> OnCommitRoot\n    \n    MarkRenderStarted --> DevToolsHook\n    MarkRenderStopped --> DevToolsHook\n    OnCommitRoot --> DevToolsHook\n```\n\n**Profiler mechanism**:\n- `actualDuration`: Time spent rendering this component in the current render\n- `treeBaseDuration`: Estimated time to re-render entire subtree (cached from previous render)\n- `startProfilerTimer()` / `stopProfilerTimerIfRunning()`: Record timing around component render\n- `<Profiler>` component invokes `onRender` callback with timing data after commit\n- DevTools hook receives notifications of render start/stop/commit\n\n**Sources**: [packages/react-reconciler/src/ReactProfilerTimer.js:150-350](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:720-780](), [packages/react-reconciler/src/ReactFiberDevToolsHook.js:200-350]()\n\n---\n\n## Concurrent Mode Rendering Patterns\n\n### Selective Hydration\n\nThe reconciler supports hydrating server-rendered content selectively based on user interactions.\n\n```mermaid\ngraph TB\n    HydrateRoot["hydrateRoot(container, element)"]\n    \n    Dehydrated["Dehydrated Suspense boundary<br/>Server-rendered fallback"]\n    \n    UserClick["User clicks inside boundary"]\n    \n    UpgradePriority["Upgrade hydration lane<br/>to higher priority"]\n    \n    HydrateBoundary["Hydrate clicked boundary first<br/>Before other boundaries"]\n    \n    ThrowException2["If data not ready:<br/>throw SelectiveHydrationException"]\n    \n    HydrateRoot --> Dehydrated\n    Dehydrated --> UserClick\n    UserClick --> UpgradePriority\n    UpgradePriority --> HydrateBoundary\n    HydrateBoundary --> ThrowException2\n```\n\nWhen a user interacts with a dehydrated boundary, React prioritizes hydrating that boundary to make it interactive quickly.\n\n**Sources**: [packages/react-reconciler/src/ReactFiberBeginWork.js:311-317](), [packages/react-reconciler/src/ReactFiberReconciler.js:489-520]()\n\n### Offscreen Rendering\n\n`OffscreenComponent` allows pre-rendering content that\'s not yet visible.\n\n```mermaid\ngraph TB\n    Offscreen["<Offscreen mode=\'hidden\'>"]\n    \n    Hidden["Content rendered but not visible<br/>style={{ visibility: \'hidden\' }}"]\n    \n    DeferredLane["Scheduled at OffscreenLane<br/>Low priority"]\n    \n    Visible["<Offscreen mode=\'visible\'>"]\n    \n    Reveal["Content becomes visible<br/>Re-render at higher priority"]\n    \n    Offscreen --> Hidden\n    Hidden --> DeferredLane\n    DeferredLane --> Visible\n    Visible --> Reveal\n```\n\nOffscreen components are rendered at low priority and kept in the DOM with `visibility: hidden`, then revealed instantly when needed.\n\n**Sources**: [packages/react-reconciler/src/ReactFiberBeginWork.js:613-871](), [packages/react-reconciler/src/ReactFiberOffscreenComponent.js:1-50]()\n\n---\n\n## Summary\n\nThe React Reconciler is the core reconciliation engine that:\n\n- **Manages Fiber trees**: Double-buffered trees with `current` and `workInProgress`\n- **Coordinates render phases**: Interruptible render phase, synchronous commit phase\n- **Abstracts platforms**: Delegates host operations through `ReactFiberConfig` interface\n- **Schedules work**: Priority-based scheduling using lanes and the Scheduler\n- **Handles updates**: Batches updates, processes update queues, reconciles children\n- **Supports features**: Hooks, Context, Suspense, Error Boundaries, Concurrent Rendering\n\nKey entry points:\n- `createContainer()` / `updateContainer()` - Initialize and update roots\n- `scheduleUpdateOnFiber()` - Schedule work on a fiber\n- `performWorkOnRoot()` - Execute render and commit phases\n- `beginWork()` / `completeWork()` - Walk the fiber tree\n- `commitMutationEffects()` / `commitLayoutEffects()` - Apply changes to host\n\nThe reconciler is platform-agnostic, enabling React to target DOM, Native, Canvas, and custom renderers while maintaining a single core algorithm.\n\n---\n\n# Page: Fiber Architecture and Data Structures\n\n# Fiber Architecture and Data Structures\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberOffscreenComponent.js](packages/react-reconciler/src/ReactFiberOffscreenComponent.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis page documents React\'s Fiber data structure, the FiberRoot container, the double-buffering technique using current and work-in-progress trees, and the tree traversal mechanisms using child/sibling/return pointers. These are the foundational data structures that enable React\'s incremental reconciliation.\n\nFor related topics, see:\n- Work loop execution and render/commit phases: [Work Loop and Rendering Phases](#4.2)\n- Hooks implementation: [React Hooks System](#4.3)\n- Priority scheduling: [Lane-Based Scheduling and Priorities](#4.4)\n- Error and Suspense handling: [Suspense and Error Boundaries](#4.5)\n- Host-specific operations: [Host Configuration Abstraction](#4.6)\n\n## FiberRoot: The Container\n\nThe `FiberRoot` is the container object that holds the entire fiber tree and coordinates rendering. It is created by `createFiberRoot` in [ReactFiberRoot.js:109-225]() when calling `createRoot()` or `createContainer()`.\n\n### FiberRoot Structure\n\nKey fields defined in [ReactInternalTypes.js:253-334]():\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `containerInfo` | `Container` | The host container (e.g., DOM node) |\n| `current` | `Fiber` | Pointer to the current HostRoot fiber |\n| `finishedWork` | `Fiber \\| null` | Work-in-progress root after render completes |\n| `pendingLanes` | `Lanes` | Lanes with pending work |\n| `suspendedLanes` | `Lanes` | Lanes suspended by promises |\n| `pingedLanes` | `Lanes` | Lanes that have been pinged to retry |\n| `expiredLanes` | `Lanes` | Lanes that have expired |\n| `callbackNode` | `mixed` | Scheduler callback node |\n| `callbackPriority` | `Lane` | Priority of scheduled callback |\n| `hydrationCallbacks` | `null \\| SuspenseHydrationCallbacks` | Hydration callbacks |\n| `context` | `Object \\| null` | Context object for legacy context |\n| `pendingContext` | `Object \\| null` | Pending context updates |\n\n**Diagram: FiberRoot and HostRoot Relationship**\n\n```mermaid\ngraph TB\n    ContainerDiv["containerInfo<br/>(DOM div)"]\n    FiberRoot["FiberRoot"]\n    CurrentHostRoot["current<br/>(HostRoot fiber)"]\n    WIPHostRoot["finishedWork<br/>(HostRoot fiber WIP)"]\n    \n    FiberRoot -->|"containerInfo"| ContainerDiv\n    FiberRoot -->|"current"| CurrentHostRoot\n    FiberRoot -->|"finishedWork"| WIPHostRoot\n    \n    CurrentHostRoot -->|"stateNode"| FiberRoot\n    WIPHostRoot -->|"stateNode"| FiberRoot\n    \n    CurrentHostRoot -.->|"alternate"| WIPHostRoot\n    WIPHostRoot -.->|"alternate"| CurrentHostRoot\n    \n    CurrentHostRoot -->|"child"| CurrentApp["App fiber (current)"]\n    WIPHostRoot -->|"child"| WIPApp["App fiber (WIP)"]\n```\n\nThe `HostRoot` fiber (tag = 3) is special:\n- Its `stateNode` points back to the `FiberRoot`\n- It has no React element (it\'s the root of the React tree)\n- Its `memoizedState` contains the initial element passed to `render()` [ReactInternalTypes.js:246-251]()\n\nSources: [ReactFiberRoot.js:109-225](), [ReactInternalTypes.js:253-334](), [ReactInternalTypes.js:246-251]()\n\n## The Fiber Data Structure\n\n### Fiber Node Definition\n\nA Fiber is React\'s internal unit of work, representing a component instance, DOM node, or other React element. It is a mutable JavaScript object containing all information needed for reconciliation, scheduling, and effects.\n\nThe `FiberNode` constructor is defined in [ReactFiber.js:138-211](). React provides two implementations:\n- Class-based: `createFiberImplClass` (default)\n- Object literal: `createFiberImplObject` (controlled by `enableObjectFiber` flag)\n\n### Fiber Fields by Category\n\n| Field Category | Key Fields | Purpose |\n|---------------|------------|---------|\n| **Instance Identity** | `tag`, `key`, `elementType`, `type` | Identify what this fiber represents |\n| **Instance State** | `stateNode` | Reference to component instance, DOM node, or other state |\n| **Tree Structure** | `return`, `child`, `sibling`, `index` | Form the fiber tree via pointers |\n| **Refs** | `ref`, `refCleanup` | Handle ref attachment and cleanup |\n| **Props** | `pendingProps`, `memoizedProps` | Props being processed and last rendered props |\n| **State** | `memoizedState`, `updateQueue` | Component state and pending updates |\n| **Context** | `dependencies` | Context subscriptions |\n| **Mode** | `mode` | Bitfield for ConcurrentMode, StrictMode, etc. |\n| **Effects** | `flags`, `subtreeFlags`, `deletions` | Side-effects to perform in commit phase |\n| **Scheduling** | `lanes`, `childLanes` | Work priority for this fiber and its subtree |\n| **Double Buffering** | `alternate` | Link to counterpart fiber in other tree |\n| **Profiling** | `actualDuration`, `selfBaseDuration`, etc. | Timing information (if enabled) |\n\n**Fiber Creation:**\n\nNew fibers are created by `createFiber` [ReactFiber.js:303-305]():\n```javascript\nconst createFiber = enableObjectFiber\n  ? createFiberImplObject\n  : createFiberImplClass;\n```\n\nSources: [ReactFiber.js:138-211](), [ReactFiber.js:226-305](), [ReactInternalTypes.js:89-205]()\n\n### Work Tags\n\nEach fiber\'s `tag` field identifies its type, defined in [ReactWorkTags.js:10-37]():\n\n| Tag Constant | Value | Represents |\n|--------------|-------|------------|\n| `FunctionComponent` | 0 | Function component |\n| `ClassComponent` | 1 | Class component |\n| `HostRoot` | 3 | Root of a fiber tree (container) |\n| `HostComponent` | 5 | Platform element (e.g., DOM `<div>`) |\n| `HostText` | 6 | Text node |\n| `HostPortal` | 4 | Portal to different container |\n| `Fragment` | 7 | `React.Fragment` |\n| `Mode` | 8 | StrictMode, ConcurrentMode, etc. |\n| `ContextProvider` | 10 | `Context.Provider` |\n| `ContextConsumer` | 9 | `Context.Consumer` |\n| `ForwardRef` | 11 | `React.forwardRef()` wrapper |\n| `Profiler` | 12 | `<Profiler>` component |\n| `SuspenseComponent` | 13 | `<Suspense>` boundary |\n| `MemoComponent` | 14 | `React.memo()` wrapper |\n| `SimpleMemoComponent` | 15 | Optimized memo for simple functions |\n| `LazyComponent` | 16 | `React.lazy()` wrapper |\n| `OffscreenComponent` | 22 | Hidden/deferred subtree |\n| `CacheComponent` | 24 | Cache boundary |\n| `TracingMarkerComponent` | 25 | Transition tracing marker |\n\nThe tag determines how the fiber is processed during reconciliation (in `beginWork`/`completeWork`) and what lifecycle methods or hooks it supports.\n\nSources: [ReactWorkTags.js:10-37](), [ReactFiber.js:146]()\n\n## Double Buffering: Current and Work-in-Progress Trees\n\nReact maintains two fiber trees using a technique called double buffering:\n- **Current tree**: Reflects what\'s currently rendered on screen\n- **Work-in-progress tree**: Being constructed during the render phase\n\n### The `alternate` Pointer\n\nEach fiber has an `alternate` field pointing to its counterpart in the other tree [ReactFiber.js:177]():\n\n```mermaid\ngraph LR\n    subgraph Current["Current Tree (on screen)"]\n        C_Root["HostRoot"]\n        C_App["App"]\n        C_Div["div"]\n        C_Text["\'Hello\'"]\n    end\n    \n    subgraph WorkInProgress["Work-in-Progress Tree (being built)"]\n        W_Root["HostRoot"]\n        W_App["App"]\n        W_Div["div"]\n        W_Text["\'Hello World\'"]\n    end\n    \n    C_Root <-.alternate.-> W_Root\n    C_App <-.alternate.-> W_App\n    C_Div <-.alternate.-> W_Div\n    C_Text <-.alternate.-> W_Text\n```\n\n**Diagram: Alternate Pointers Between Trees**\n\n### Creating Work-in-Progress Fibers\n\nThe `createWorkInProgress` function [ReactFiber.js:327-383]() manages fiber reuse:\n\n**On first update (alternate is null):**\n1. Creates new fiber with `createFiber()`\n2. Copies `elementType`, `type`, `stateNode` from current\n3. Sets up bidirectional `alternate` pointers\n4. Initializes with `pendingProps`\n\n**On subsequent updates (alternate exists):**\n1. Reuses existing alternate fiber\n2. Resets flags: `flags = NoFlags`, `subtreeFlags = NoFlags`\n3. Clears `deletions` array\n4. Updates `pendingProps` to new props\n5. Resets `lanes` and `childLanes`\n\n**Benefits of double buffering:**\n- Memory efficiency: reuses fiber objects across renders\n- Enables bailout optimizations by comparing to `current`\n- Allows interruption: work-in-progress can be discarded if superseded\n- Atomic updates: switch trees by updating single pointer (`FiberRoot.current`)\n\nSources: [ReactFiber.js:327-383](), [ReactFiber.js:177]()\n\n### Tree Swap on Commit\n\nAfter rendering completes successfully, the work-in-progress tree becomes current via a single pointer update in `commitRootImpl` [ReactFiberWorkLoop.js:2268-2826]():\n\n```javascript\nroot.current = finishedWork;\n```\n\nThe previous current tree becomes the new work-in-progress alternate for the next update.\n\nSources: [ReactFiberWorkLoop.js:2268-2826]()\n\n## Work Loop Architecture\n\n### Overview: `performWorkOnRoot`\n\nThe work loop orchestrates rendering and committing. The main entry point is `performWorkOnRoot` [ReactFiberWorkLoop.js:940-1089](), which:\n\n1. Prepares the work-in-progress root\n2. Executes the render phase (`renderRootSync` or `renderRootConcurrent`)\n3. If successful, executes the commit phase (`commitRoot`)\n4. Handles errors and suspensions\n5. Schedules any remaining work\n\n```mermaid\ngraph TB\n    ScheduleUpdate["scheduleUpdateOnFiber()<br/>(mark fiber with lane)"]\n    EnsureScheduled["ensureRootIsScheduled()<br/>(schedule work on root)"]\n    PerformWork["performWorkOnRoot()<br/>(process scheduled work)"]\n    \n    DetermineMode{"Sync or<br/>Concurrent?"}\n    RenderSync["renderRootSync()<br/>(uninterruptible)"]\n    RenderConcurrent["renderRootConcurrent()<br/>(can yield)"]\n    \n    WorkLoop["workLoopSync() or<br/>workLoopConcurrent()"]\n    PerformUnit["performUnitOfWork()"]\n    \n    CheckExitStatus{"Exit Status?"}\n    CommitRoot["commitRoot()<br/>(apply changes)"]\n    HandleError["Handle error/<br/>suspension"]\n    \n    ScheduleUpdate --> EnsureScheduled\n    EnsureScheduled --> PerformWork\n    PerformWork --> DetermineMode\n    \n    DetermineMode -->|"includes SyncLane"| RenderSync\n    DetermineMode -->|"concurrent lanes"| RenderConcurrent\n    \n    RenderSync --> WorkLoop\n    RenderConcurrent --> WorkLoop\n    WorkLoop --> PerformUnit\n    \n    PerformUnit --> CheckExitStatus\n    CheckExitStatus -->|"RootCompleted"| CommitRoot\n    CheckExitStatus -->|"RootErrored/<br/>RootSuspended"| HandleError\n```\n\n**Diagram: Work Loop Execution Flow**\n\nSources: [ReactFiberWorkLoop.js:940-1089](), [ReactFiberWorkLoop.js:1643-1846]()\n\n### Work Loop State Variables\n\nKey module-level state in [ReactFiberWorkLoop.js:423-496]():\n\n```javascript\nlet workInProgressRoot: FiberRoot | null = null;     // Root being rendered\nlet workInProgress: Fiber | null = null;             // Current fiber being processed\nlet workInProgressRootRenderLanes: Lanes = NoLanes; // Lanes being rendered\n\nlet workInProgressSuspendedReason: SuspendedReason = NotSuspended;\nlet workInProgressThrownValue: mixed = null;\n\nlet workInProgressRootExitStatus: RootExitStatus = RootInProgress;\n```\n\nThese variables track the current render\'s state globally within the reconciler.\n\nSources: [ReactFiberWorkLoop.js:423-496]()\n\n## The Render Phase\n\nThe render phase builds the work-in-progress tree by traversing fibers depth-first. This phase is **interruptible** in concurrent mode.\n\n### Work Loop Functions\n\nTwo variants exist [ReactFiberWorkLoop.js:1848-1856]():\n\n**Synchronous (uninterruptible):**\n```javascript\nfunction workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress);\n  }\n}\n```\n\n**Concurrent (interruptible):**\n```javascript\nfunction workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress);\n  }\n}\n```\n\nThe concurrent version checks `shouldYield()` from Scheduler to yield control back to the browser.\n\nSources: [ReactFiberWorkLoop.js:1848-1856]()\n\n### Unit of Work: `performUnitOfWork`\n\nEach iteration processes one fiber [ReactFiberWorkLoop.js:1858-1884]():\n\n```javascript\nfunction performUnitOfWork(unitOfWork: Fiber): void {\n  const current = unitOfWork.alternate;\n  \n  let next = beginWork(current, unitOfWork, renderLanes);\n  \n  unitOfWork.memoizedProps = unitOfWork.pendingProps;\n  \n  if (next === null) {\n    completeUnitOfWork(unitOfWork);\n  } else {\n    workInProgress = next;\n  }\n}\n```\n\n**Flow:**\n1. Call `beginWork` to process the fiber and generate children\n2. If `beginWork` returns a child, set it as next `workInProgress`\n3. If no child, call `completeUnitOfWork` to finish this fiber and move to sibling/parent\n\nSources: [ReactFiberWorkLoop.js:1858-1884]()\n\n### Begin Work: `beginWork`\n\nThe `beginWork` function [ReactFiberBeginWork.js:3649-4221]() is a large switch statement that processes each fiber type:\n\n```mermaid\ngraph TB\n    BeginWork["beginWork(current, workInProgress, lanes)"]\n    \n    CheckBailout{"Can bailout?<br/>(props unchanged &&<br/>no work in subtree)"}\n    BailoutPath["bailoutOnAlreadyFinishedWork()"]\n    \n    SwitchTag["Switch on workInProgress.tag"]\n    \n    FuncComp["updateFunctionComponent()<br/>(call renderWithHooks)"]\n    ClassComp["updateClassComponent()<br/>(process lifecycle, call render)"]\n    HostRoot["updateHostRoot()<br/>(process update queue)"]\n    HostComp["updateHostComponent()<br/>(no render, just reconcile)"]\n    HostText["updateHostText()<br/>(text has no children)"]\n    Suspense["updateSuspenseComponent()<br/>(check fallback/primary)"]\n    Fragment["updateFragment()<br/>(just reconcile children)"]\n    \n    ReconcileChildren["reconcileChildren()<br/>(diff algorithm)"]\n    ReturnChild["Return child<br/>(or null)"]\n    \n    BeginWork --> CheckBailout\n    CheckBailout -->|Yes| BailoutPath\n    CheckBailout -->|No| SwitchTag\n    \n    SwitchTag --> FuncComp\n    SwitchTag --> ClassComp\n    SwitchTag --> HostRoot\n    SwitchTag --> HostComp\n    SwitchTag --> HostText\n    SwitchTag --> Suspense\n    SwitchTag --> Fragment\n    \n    FuncComp --> ReconcileChildren\n    ClassComp --> ReconcileChildren\n    HostRoot --> ReconcileChildren\n    HostComp --> ReconcileChildren\n    Fragment --> ReconcileChildren\n    \n    ReconcileChildren --> ReturnChild\n    BailoutPath --> ReturnChild\n    Suspense --> ReturnChild\n    HostText --> ReturnChild\n```\n\n**Diagram: beginWork Processing Flow**\n\n#### Key Operations in `beginWork`:\n\n1. **Bailout optimization** [ReactFiberBeginWork.js:3798-3823](): If props haven\'t changed and there\'s no work scheduled in the subtree, skip processing\n\n2. **Component-specific updates**:\n   - `updateFunctionComponent` [ReactFiberBeginWork.js:1363-1434](): Calls `renderWithHooks` to execute the function\n   - `updateClassComponent` [ReactFiberBeginWork.js:1179-1298](): Processes lifecycle methods and calls `render()`\n   - `updateHostComponent` [ReactFiberBeginWork.js:1745-1791](): For DOM elements, just prepares for children reconciliation\n\n3. **Child reconciliation** [ReactFiberBeginWork.js:340-371](): Calls `reconcileChildren` which:\n   - Uses `mountChildFibers` for initial mount (no placement flags)\n   - Uses `reconcileChildFibers` for updates (tracks side-effects)\n   - Implements React\'s diffing algorithm in [ReactChildFiber.js]()\n\nSources: [ReactFiberBeginWork.js:3649-4221](), [ReactFiberBeginWork.js:340-371](), [ReactChildFiber.js]()\n\n### Complete Work: `completeWork`\n\nAfter all children are processed, `completeUnitOfWork` [ReactFiberWorkLoop.js:1886-1949]() calls `completeWork` [ReactFiberCompleteWork.js:652-1441]() to finalize the fiber.\n\n```mermaid\ngraph TB\n    CompleteWork["completeWork(current, workInProgress, lanes)"]\n    \n    SwitchTag["Switch on workInProgress.tag"]\n    \n    HostComp["HostComponent"]\n    HostText["HostText"]\n    HostRoot["HostRoot"]\n    Suspense["SuspenseComponent"]\n    ContextProv["ContextProvider"]\n    \n    CheckMount{"current === null?<br/>(initial mount)"}\n    \n    CreateInstance["createInstance()<br/>(create DOM node)"]\n    AppendChildren["appendAllChildren()<br/>(attach child DOM nodes)"]\n    FinalizeProps["finalizeInitialChildren()<br/>(set props, event listeners)"]\n    \n    UpdateCheck{"Props changed?"}\n    MarkUpdate["Mark fiber with Update flag"]\n    \n    BubbleProps["bubbleProperties()<br/>(aggregate flags/lanes from children)"]\n    ReturnNull["Return null<br/>(move to sibling/parent)"]\n    \n    CompleteWork --> SwitchTag\n    \n    SwitchTag --> HostComp\n    SwitchTag --> HostText\n    SwitchTag --> HostRoot\n    SwitchTag --> Suspense\n    SwitchTag --> ContextProv\n    \n    HostComp --> CheckMount\n    CheckMount -->|"Yes (mount)"| CreateInstance\n    CreateInstance --> AppendChildren\n    AppendChildren --> FinalizeProps\n    \n    CheckMount -->|"No (update)"| UpdateCheck\n    UpdateCheck -->|Yes| MarkUpdate\n    \n    FinalizeProps --> BubbleProps\n    MarkUpdate --> BubbleProps\n    HostText --> BubbleProps\n    HostRoot --> BubbleProps\n    Suspense --> BubbleProps\n    ContextProv --> BubbleProps\n    \n    BubbleProps --> ReturnNull\n```\n\n**Diagram: completeWork Processing Flow**\n\n#### Key Operations in `completeWork`:\n\nFor **HostComponent** (DOM elements) on mount [ReactFiberCompleteWork.js:652-1441]():\n1. `createInstance` - Creates the DOM node via host config\n2. `appendAllChildren` - Walks the fiber tree and attaches child DOM nodes\n3. `finalizeInitialChildren` - Sets initial props and event listeners\n4. Marks with Update flag if needed (e.g., autoFocus)\n\nFor **HostComponent** on update:\n1. Calls `updateHostComponent` [ReactFiberCompleteWork.js:455-540]()\n2. If old props !== new props, marks fiber with Update flag\n3. The actual prop update happens in commit phase\n\n**Property Bubbling** [ReactFiberCompleteWork.js:1443-1543]():\n- Aggregates all child `flags` into `subtreeFlags`\n- Aggregates all child `lanes` and `childLanes` into this fiber\'s `childLanes`\n- Enables efficient subtree skipping during traversal\n\nSources: [ReactFiberCompleteWork.js:652-1441](), [ReactFiberCompleteWork.js:242-346](), [ReactFiberCompleteWork.js:1443-1543]()\n\n### Traversal Pattern: Depth-First with Siblings\n\nThe work loop implements depth-first traversal with sibling processing [ReactFiberWorkLoop.js:1886-1949]():\n\n```\n1. Begin work on fiber A\n2. If A has child B, begin work on B (go deeper)\n3. If B has no child, complete work on B\n4. If B has sibling C, begin work on C\n5. If no sibling, complete parent A\n6. Continue until root is complete\n```\n\nThis ensures proper parentchildsibling ordering.\n\nSources: [ReactFiberWorkLoop.js:1886-1949]()\n\n## The Commit Phase\n\nOnce render phase completes successfully (`RootCompleted`), the commit phase applies all changes to the host environment. This phase is **uninterruptible** and **synchronous**.\n\n### Commit Phase Structure\n\nThe `commitRootImpl` function [ReactFiberWorkLoop.js:2268-2826]() orchestrates commit in three sub-phases plus passive effects:\n\n```mermaid\ngraph LR\n    Start["commitRootImpl(root, recoverableErrors, lanes)"]\n    \n    BeforeMut["Before Mutation Phase<br/>commitBeforeMutationEffects()"]\n    MutPhase["Mutation Phase<br/>commitMutationEffects()"]\n    SwapTrees["root.current = finishedWork<br/>(swap trees)"]\n    LayoutPhase["Layout Phase<br/>commitLayoutEffects()"]\n    \n    SchedulePassive["Schedule Passive Effects<br/>scheduleCallback(commitPassiveMountEffects)"]\n    \n    CleanupSync["Cleanup & schedule<br/>next work"]\n    \n    Start --> BeforeMut\n    BeforeMut --> MutPhase\n    MutPhase --> SwapTrees\n    SwapTrees --> LayoutPhase\n    LayoutPhase --> SchedulePassive\n    SchedulePassive --> CleanupSync\n```\n\n**Diagram: Commit Phase Sub-phases**\n\nSources: [ReactFiberWorkLoop.js:2268-2826]()\n\n### Before Mutation Phase\n\n`commitBeforeMutationEffects` [ReactFiberCommitWork.js:344-363]() traverses the tree and:\n\n1. Calls `getSnapshotBeforeUpdate` on class components [ReactFiberCommitWork.js:475-574]()\n2. Schedules useEffect hooks (doesn\'t run them yet)\n3. Handles view transition tracking (if enabled)\n4. Detects focus changes for `beforeActiveInstanceBlur`\n\n**Key point:** This phase reads from the DOM *before* any mutations, allowing components to capture information (e.g., scroll position).\n\nSources: [ReactFiberCommitWork.js:344-363](), [ReactFiberCommitWork.js:475-574]()\n\n### Mutation Phase\n\n`commitMutationEffects` [ReactFiberCommitWork.js:856-1097]() applies actual DOM changes:\n\n```mermaid\ngraph TB\n    MutationEffects["commitMutationEffects(root, finishedWork, lanes)"]\n    \n    RecursiveTraverse["Recursively traverse tree<br/>commitMutationEffectsOnFiber()"]\n    \n    CheckFlags["Check fiber.flags"]\n    \n    ContentReset["ContentReset:<br/>clearTextContent()"]\n    Ref["Ref:<br/>safelyDetachRef()"]\n    Visibility["Visibility:<br/>Hide/show instances"]\n    Placement["Placement:<br/>commitPlacement()"]\n    Update["Update:<br/>commitWork()"]\n    ChildDeletion["ChildDeletion:<br/>commitDeletionEffects()"]\n    \n    PlacementOps["Insert DOM node into parent<br/>via insertBefore/appendChild"]\n    UpdateOps["Update DOM properties<br/>updateProperties()"]\n    DeletionOps["Remove DOM node<br/>removeChild()"]\n    \n    MutationEffects --> RecursiveTraverse\n    RecursiveTraverse --> CheckFlags\n    \n    CheckFlags --> ContentReset\n    CheckFlags --> Ref\n    CheckFlags --> Visibility\n    CheckFlags --> Placement\n    CheckFlags --> Update\n    CheckFlags --> ChildDeletion\n    \n    Placement --> PlacementOps\n    Update --> UpdateOps\n    ChildDeletion --> DeletionOps\n```\n\n**Diagram: Mutation Phase Operations**\n\n**Key operations:**\n- **Placement** [ReactFiberCommitWork.js](): Inserts new or moved DOM nodes using `insertBefore` or `appendChild`\n- **Update** [ReactFiberCommitWork.js](): Updates properties on existing DOM nodes via `updateProperties`\n- **Deletion** [ReactFiberCommitWork.js](): Recursively unmounts components and removes DOM nodes\n- **Visibility** [ReactFiberCommitWork.js](): Hides/shows DOM nodes for Suspense/Offscreen\n\nSources: [ReactFiberCommitWork.js:856-1097](), [ReactFiberCommitHostEffects.js]()\n\n### Tree Swap\n\nBetween mutation and layout phases [ReactFiberWorkLoop.js:2268-2826]():\n\n```javascript\nroot.current = finishedWork;\n```\n\nThis swaps the work-in-progress tree to become the current tree. From this point forward, the newly committed tree represents what\'s on screen.\n\nSources: [ReactFiberWorkLoop.js:2268-2826]()\n\n### Layout Phase\n\n`commitLayoutEffects` [ReactFiberCommitWork.js:594-854]() runs immediately after DOM mutations, while browser is still processing layout:\n\n1. **Class components** [ReactFiberCommitWork.js:607-638](): \n   - Calls `componentDidMount` on mount\n   - Calls `componentDidUpdate` on update\n   - Invokes `setState` callbacks\n\n2. **Function components** [ReactFiberCommitWork.js:607-619]():\n   - Calls `useLayoutEffect` effect functions\n\n3. **Refs** [ReactFiberCommitWork.js:635-637]():\n   - Calls `safelyAttachRef` to set refs to current instances\n\n4. **Host components** [ReactFiberCommitWork.js:657-697]():\n   - Calls `commitMount` for initial mount side-effects (e.g., autoFocus)\n\n**Key point:** This phase can synchronously read layout from the DOM. `useLayoutEffect` runs here specifically to allow synchronous DOM measurements before paint.\n\nSources: [ReactFiberCommitWork.js:594-854](), [ReactFiberCommitEffects.js]()\n\n### Passive Effects Phase\n\n`commitPassiveEffects` [ReactFiberWorkLoop.js:2858-3025]() runs **asynchronously** after browser paint, scheduled via `scheduleCallback`:\n\n```javascript\nscheduleCallback(NormalSchedulerPriority, () => {\n  flushPassiveEffects();\n  return null;\n});\n```\n\n**Two passes:**\n\n1. **Unmount effects** [ReactFiberCommitWork.js:2446-2593]():\n   - Calls cleanup functions from previous `useEffect` hooks\n   - Invokes `componentWillUnmount` on unmounted class components\n\n2. **Mount effects** [ReactFiberCommitWork.js:2595-2774]():\n   - Calls effect functions from current `useEffect` hooks\n\n**Key characteristics:**\n- Runs after paint (non-blocking)\n- Lower priority than layout effects\n- Ideal for side-effects that don\'t need synchronous DOM access (data fetching, subscriptions)\n\nSources: [ReactFiberWorkLoop.js:2858-3025](), [ReactFiberCommitWork.js:2446-2774]()\n\n## Error Handling and Suspension\n\n### Unwinding on Errors/Suspensions\n\nWhen `beginWork` or other code throws during render, React unwinds the stack using `unwindWork` [ReactFiberUnwindWork.js:66-235]():\n\n1. Walks back up the tree via `return` pointers\n2. Pops context stacks to maintain consistency\n3. Looks for error boundaries (`ClassComponent` with `getDerivedStateFromError` or `componentDidCatch`)\n4. Looks for Suspense boundaries (`SuspenseComponent`)\n5. Marks boundary with `ShouldCapture` flag\n\n```javascript\n// Simplified unwinding logic\nfunction unwindWork(current, workInProgress, renderLanes) {\n  switch (workInProgress.tag) {\n    case ClassComponent:\n      if (flags & ShouldCapture) {\n        workInProgress.flags = (flags & ~ShouldCapture) | DidCapture;\n        return workInProgress; // Re-render this boundary\n      }\n      return null;\n    \n    case SuspenseComponent:\n      if (flags & ShouldCapture) {\n        workInProgress.flags = (flags & ~ShouldCapture) | DidCapture;\n        return workInProgress; // Show fallback\n      }\n      return null;\n    \n    // ... other cases pop context\n  }\n}\n```\n\nSources: [ReactFiberUnwindWork.js:66-235]()\n\n### Handling Thrown Values\n\n`throwException` [ReactFiberThrow.js]() processes different types of thrown values:\n\n**Promises (Suspense):**\n- Attaches ping listener to the promise\n- Finds nearest Suspense boundary\n- Marks boundary to show fallback\n\n**Errors:**\n- Finds nearest error boundary\n- Creates error update with `getDerivedStateFromError` or `componentDidCatch`\n- Schedules re-render of boundary\n\n**Special values:**\n- `SelectiveHydrationException`: Signals need to interrupt current render for hydration\n\nSources: [ReactFiberThrow.js]()\n\n### Suspended Work Tracking\n\nWhen work suspends [ReactFiberWorkLoop.js:1987-2134]():\n\n```javascript\nworkInProgressSuspendedReason = SuspendedOnData;\nworkInProgressThrownValue = thrownValue;\n```\n\nThe work loop checks this state and:\n- Attempts to unwind to a Suspense boundary\n- May continue rendering siblings to "pre-warm" them\n- Marks lanes for retry when promise resolves\n\nSources: [ReactFiberWorkLoop.js:1987-2134]()\n\n## Integration with Scheduler\n\n### Scheduling Root Work\n\n`ensureRootIsScheduled` [ReactFiberRootScheduler.js:185-403]() is called after updates are enqueued:\n\n1. Determines next lanes to process via `getNextLanes`\n2. Calculates Scheduler priority from lane priority via `lanesToEventPriority`\n3. Schedules callback:\n   - **Sync lanes**: Uses microtask or immediate callback\n   - **Concurrent lanes**: Uses `Scheduler_scheduleCallback` with appropriate priority\n\n```javascript\nconst schedulerPriorityLevel = lanesToEventPriority(nextLanes);\nconst newCallbackNode = scheduleCallback(\n  schedulerPriorityLevel,\n  performWorkOnRoot.bind(null, root)\n);\n```\n\nSources: [ReactFiberRootScheduler.js:185-403]()\n\n### Yielding to Browser\n\nIn concurrent mode, `workLoopConcurrent` [ReactFiberWorkLoop.js:1851-1856]() checks `shouldYield()` from Scheduler:\n\n```javascript\nfunction workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress);\n  }\n}\n```\n\nIf `shouldYield()` returns true:\n- Work loop exits\n- Current render state is preserved in module variables\n- Scheduler callback is re-scheduled\n- When callback runs again, rendering resumes from `workInProgress`\n\nThis enables:\n- Responding to higher-priority user input\n- Keeping frame rate high during complex renders\n- Time-slicing long operations\n\nSources: [ReactFiberWorkLoop.js:1851-1856](), [Scheduler.js]()\n\n### Priority Mapping\n\nLane priorities map to Scheduler priorities [ReactEventPriorities.js]():\n\n| React Lane | Scheduler Priority |\n|------------|-------------------|\n| `SyncLane` | `ImmediatePriority` |\n| `InputContinuousLane` | `UserBlockingPriority` |\n| `DefaultLane` | `NormalPriority` |\n| `TransitionLanes` | `NormalPriority` |\n| `RetryLanes` | `NormalPriority` |\n| `IdleLane` | `IdlePriority` |\n\nSources: [ReactEventPriorities.js](), [ReactFiberLane.js]()\n\n## Profiling and Performance Tracking\n\n### Profiler Timing\n\nWhen `enableProfilerTimer` is enabled, each fiber tracks timing information [ReactFiber.js:179-197]():\n\n```javascript\nfiber.actualDuration = -0;        // Time spent rendering this update\nfiber.actualStartTime = -1.1;     // When rendering started\nfiber.selfBaseDuration = -0;      // Base time excluding children\nfiber.treeBaseDuration = -0;      // Base time including children\n```\n\nThese are updated during:\n- `performUnitOfWork` starts the timer\n- `completeWork` stops and accumulates duration\n- Child durations are subtracted to compute self time\n\nThe `Profiler` component [ReactFiberBeginWork.js:1136-1177]() uses these to report render times via the `onRender` callback.\n\nSources: [ReactFiber.js:179-197](), [ReactProfilerTimer.js]()\n\n### Performance Track Logging\n\n`ReactFiberPerformanceTrack` [ReactFiberPerformanceTrack.js]() logs performance events to browser DevTools Performance panel:\n\n**Component tracks:**\n- `logComponentRender` logs individual component render times with color-coded severity\n- `logComponentMount/Unmount` logs lifecycle events\n- Tracks props changes and deep equality warnings\n\n**Lane tracks:**\n- Separate tracks for Blocking, Gesture, Transition, Suspense, Idle\n- Shows update propagation and priority changes\n- Visualizes which updates triggered renders\n\n**Event tracking:**\n- Correlates user events with resulting updates\n- Tracks cascading updates (updates triggered during render)\n- Measures time from event to commit\n\nSources: [ReactFiberPerformanceTrack.js:221-450]()\n\n## Summary\n\nThe Fiber architecture and work loop provide React\'s reconciliation mechanism with these key characteristics:\n\n**Fiber Structure:**\n- Mutable plain objects forming a linked tree\n- Double-buffered (current  work-in-progress)\n- Tracks props, state, effects, and scheduling information\n\n**Work Loop:**\n- Depth-first traversal via `performUnitOfWork`\n- **Render phase** (interruptible): `beginWork`  `completeWork`\n- **Commit phase** (uninterruptible): before-mutation  mutation  layout  passive\n\n**Key Capabilities:**\n- Incremental rendering with yielding to browser\n- Priority-based scheduling via lanes\n- Efficient bailout and memoization\n- Error boundaries and Suspense\n- Profiling and performance tracking\n\nThis architecture enables React to:\n- Keep UIs responsive during complex updates\n- Prioritize user interactions over background work\n- Gracefully handle async operations and errors\n- Provide detailed performance insights\n\nSources: [ReactFiberWorkLoop.js](), [ReactFiberBeginWork.js](), [ReactFiberCompleteWork.js](), [ReactFiberCommitWork.js](), [ReactFiber.js](), [ReactProfilerTimer.js](), [ReactFiberPerformanceTrack.js]()\n\n---\n\n# Page: Work Loop and Rendering Phases\n\n# Work Loop and Rendering Phases\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\nThis document describes the reconciler\'s work loop execution and the three phases of processing the Fiber tree: **begin work**, **complete work**, and **commit work**. The work loop is the core mechanism that processes fibers, determines what changed, and applies updates to the host environment.\n\nFor information about the Fiber data structure itself, see [Fiber Architecture and Data Structures](#4.1). For details on scheduling and priority management, see [Lane-Based Scheduling and Priorities](#4.4). For the commit phase effects system, see [React Hooks System](#4.3).\n\n## Overview\n\nThe work loop is implemented in [packages/react-reconciler/src/ReactFiberWorkLoop.js](). It orchestrates two distinct phases:\n\n| Phase | Purpose | Can be interrupted? |\n|-------|---------|-------------------|\n| **Render Phase** | Traverse the Fiber tree, compute changes, and mark effects | Yes (in concurrent mode) |\n| **Commit Phase** | Apply computed changes to the host environment | No (synchronous) |\n\nThe render phase processes fibers through two sub-phases: `beginWork` and `completeWork`. The commit phase executes through three sub-phases: `commitBeforeMutationEffects`, `commitMutationEffects`, and `commitLayoutEffects`.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1-3000]()\n\n## Work Loop Execution\n\n### Entry Points and Root Processing\n\nWork on a root begins through one of two main entry points:\n\n```\nperformSyncWorkOnRoot(root)      // Synchronous, uninterruptible\nperformConcurrentWorkOnRoot(root) // Concurrent, can yield\n```\n\nBoth functions follow this pattern:\n1. Prepare the work-in-progress root and lanes\n2. Enter the render phase (`renderRootSync` or `renderRootConcurrent`)\n3. If render completes successfully, enter commit phase (`commitRoot`)\n\n**Render Phase Entry:**\n\n```mermaid\ngraph TB\n    scheduleUpdateOnFiber["scheduleUpdateOnFiber(root, fiber, lane)"]\n    ensureRoot["ensureRootIsScheduled(root)"]\n    performSync["performSyncWorkOnRoot(root)"]\n    performConcurrent["performConcurrentWorkOnRoot(root)"]\n    \n    scheduleUpdateOnFiber --> ensureRoot\n    ensureRoot -->|"SyncLane"| performSync\n    ensureRoot -->|"other lanes"| performConcurrent\n    \n    performSync --> renderRootSync["renderRootSync(root, lanes)"]\n    performConcurrent --> renderRootConcurrent["renderRootConcurrent(root, lanes)"]\n    \n    renderRootSync --> prepareFresh["prepareFreshStack(root, lanes)<br/>Creates workInProgress tree"]\n    renderRootConcurrent --> prepareFresh\n    \n    prepareFresh --> setContext["executionContext |= RenderContext"]\n    setContext --> workLoopSync["workLoopSync()"]\n    setContext --> workLoopConcurrent["workLoopConcurrent()"]\n    \n    workLoopSync --> exitRender["exitStatus = RootCompleted/RootErrored/etc"]\n    workLoopConcurrent --> exitRender\n```\n\nThe `prepareFreshStack` function creates the work-in-progress tree by calling `createWorkInProgress(root.current, null)`, which either reuses the existing alternate fiber or creates a new one.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:966-1092](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1116-1300]()\n\n### The Work Loops\n\nThe actual work loop is remarkably simple:\n\n```javascript\n// Synchronous mode - never yields\nfunction workLoopSync() {\n  while (workInProgress !== null) {\n    performUnitOfWork(workInProgress);\n  }\n}\n\n// Concurrent mode - yields when shouldYield() returns true\nfunction workLoopConcurrent() {\n  while (workInProgress !== null && !shouldYield()) {\n    performUnitOfWork(workInProgress);\n  }\n}\n```\n\nThe `workInProgress` variable points to the current Fiber being processed. `performUnitOfWork` processes one unit of work and advances to the next fiber.\n\nThe `shouldYield()` function is imported from the Scheduler package and checks if the current time slice has expired. In concurrent mode, React will pause work and return control to the browser if `shouldYield()` returns true, allowing the browser to handle higher-priority work like user input.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1801-1812](), [packages/react-reconciler/src/Scheduler.js:70-76]()\n\n### Work Loop State Variables\n\nThe work loop maintains several module-level variables that track the current state:\n\n| Variable | Type | Purpose |\n|----------|------|---------|\n| `workInProgressRoot` | `FiberRoot \\| null` | The root currently being worked on |\n| `workInProgress` | `Fiber \\| null` | The fiber currently being processed |\n| `workInProgressRootRenderLanes` | `Lanes` | The lanes being rendered |\n| `workInProgressSuspendedReason` | `SuspendedReason` | Why work is suspended (0-9: NotSuspended, SuspendedOnError, SuspendedOnData, etc.) |\n| `workInProgressRootExitStatus` | `RootExitStatus` | Final status: RootInProgress, RootCompleted, RootErrored, RootSuspended, etc. |\n| `workInProgressThrownValue` | `mixed` | The value that was thrown (promise, error, etc.) |\n| `executionContext` | `ExecutionContext` | Bitmask tracking current context: NoContext, RenderContext, CommitContext |\n\nThe `executionContext` variable tracks what phase React is currently executing:\n\n```javascript\nconst NoContext = 0b000;\nconst RenderContext = 0b010;  // Currently in render phase\nconst CommitContext = 0b100;  // Currently in commit phase\n```\n\nThis prevents re-entrant updates and helps detect improper usage patterns.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:418-458]()\n\n## Render Phase: Begin Work and Complete Work\n\nThe render phase processes the Fiber tree in a depth-first traversal, calling `beginWork` on the way down and `completeWork` on the way up.\n\n### performUnitOfWork Flow\n\n```mermaid\ngraph TB\n    start["performUnitOfWork(unitOfWork)"]\n    begin["next = beginWork(current, unitOfWork, lanes)"]\n    hasNext{"next !== null?"}\n    complete["completeUnitOfWork(unitOfWork)"]\n    advance["workInProgress = next"]\n    \n    start --> begin\n    begin --> hasNext\n    hasNext -->|"Yes (has child)"| advance\n    hasNext -->|"No (no child)"| complete\n    advance --> return["return to workLoop"]\n    complete --> return\n```\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1814-1848]()\n\n### Begin Work Phase\n\nThe `beginWork` function in [packages/react-reconciler/src/ReactFiberBeginWork.js]() is responsible for:\n\n1. Determining if the fiber\'s work can be skipped (bailout optimization)\n2. Creating or updating child fibers based on the fiber\'s tag\n3. Returning the first child fiber to process next\n\n**Begin Work Dispatch by Fiber Tag:**\n\n```mermaid\ngraph TB\n    beginWork["beginWork(current, workInProgress, renderLanes)"]\n    \n    checkBailout{"Can bailout?"}\n    bailout["bailoutOnAlreadyFinishedWork()"]\n    \n    beginWork --> checkBailout\n    checkBailout -->|"Yes"| bailout\n    \n    checkBailout -->|"No"| switch{"workInProgress.tag"}\n    \n    switch -->|"FunctionComponent"| updateFunction["updateFunctionComponent()"]\n    switch -->|"ClassComponent"| updateClass["updateClassComponent()"]\n    switch -->|"HostComponent"| updateHost["updateHostComponent()"]\n    switch -->|"HostRoot"| updateRoot["updateHostRoot()"]\n    switch -->|"SuspenseComponent"| updateSuspense["updateSuspenseComponent()"]\n    switch -->|"OffscreenComponent"| updateOffscreen["updateOffscreenComponent()"]\n    \n    updateFunction --> reconcile["reconcileChildren()"]\n    updateClass --> reconcile\n    updateHost --> reconcile\n    updateRoot --> reconcile\n    updateSuspense --> reconcile\n    updateOffscreen --> reconcile\n    \n    reconcile --> returnChild["return workInProgress.child"]\n```\n\n**Key Begin Work Functions:**\n\n| Function | Fiber Tag | Responsibility |\n|----------|-----------|----------------|\n| `updateFunctionComponent` | FunctionComponent, ForwardRef, SimpleMemoComponent | Calls `renderWithHooks` to execute function body and hooks |\n| `updateClassComponent` | ClassComponent | Processes lifecycle: `componentWillMount`, `getDerivedStateFromProps`, `render`, etc. |\n| `updateHostComponent` | HostComponent | Processes DOM elements (div, span, etc.), marks props updates |\n| `updateHostRoot` | HostRoot | Processes root container, applies context updates |\n| `updateSuspenseComponent` | SuspenseComponent | Manages fallback vs primary content based on suspension state |\n| `updateOffscreenComponent` | OffscreenComponent | Handles hidden subtrees and prerendering |\n| `reconcileChildren` | (all) | Core diffing algorithm - reconciles current children with new children |\n\nThe `bailoutOnAlreadyFinishedWork` function is called when a component can skip re-rendering. It checks if `workInProgress.lanes` and `renderLanes` have no overlap, and if so, clones the children without doing any work.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberBeginWork.js:3746-4016](), [packages/react-reconciler/src/ReactFiberBeginWork.js:340-371](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3569-3633]()\n\n### Complete Work Phase\n\nWhen `beginWork` returns `null` (no more children to process), `completeUnitOfWork` is called. This function:\n\n1. Calls `completeWork` on the current fiber\n2. Collects subtree flags by bubbling them up\n3. Moves to the next sibling or returns to the parent\n\n**Complete Unit of Work Flow:**\n\n```mermaid\ngraph TB\n    start["completeUnitOfWork(unitOfWork)"]\n    loop["Loop: completedWork = unitOfWork"]\n    complete["completeWork(current, completedWork, lanes)"]\n    hasFlags{"completedWork.flags & Incomplete?"}\n    unwind["unwindWork() - handle errors"]\n    \n    start --> loop\n    loop --> complete\n    complete --> hasFlags\n    \n    hasFlags -->|"Yes (error)"| unwind\n    hasFlags -->|"No (success)"| bubble["bubbleProperties(completedWork)<br/>Aggregate child flags"]\n    \n    bubble --> resetLanes["Reset completedWork.lanes = NoLanes"]\n    resetLanes --> hasSibling{"completedWork.sibling !== null?"}\n    \n    hasSibling -->|"Yes"| returnSibling["workInProgress = sibling<br/>Return to performUnitOfWork"]\n    hasSibling -->|"No"| moveParent["completedWork = completedWork.return"]\n    \n    moveParent --> atRoot{"completedWork === null?"}\n    atRoot -->|"Yes (at root)"| exit["workInProgress = null<br/>Render phase complete"]\n    atRoot -->|"No"| loop\n```\n\nDuring `completeUnitOfWork`, if the `Incomplete` flag is set, it indicates an error or suspension occurred. The function then calls `unwindWork` to clean up context stacks and find an error boundary or suspense boundary.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1850-1980]()\n\nThe `completeWork` function in [packages/react-reconciler/src/ReactFiberCompleteWork.js]() handles:\n\n- Creating host instances (DOM nodes) for new HostComponents\n- Updating props that changed\n- Marking Update flags when work is needed\n- Handling hydration for server-rendered content\n\n**Key Complete Work Responsibilities:**\n\n| Fiber Tag | Complete Work Action |\n|-----------|---------------------|\n| HostComponent | Create DOM node, append children, finalize props |\n| HostText | Create text node |\n| HostRoot | Finalize container if using persistence mode |\n| SuspenseComponent | Determine if showing fallback or primary content |\n| OffscreenComponent | Handle visibility transitions |\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1850-1980](), [packages/react-reconciler/src/ReactFiberCompleteWork.js:845-1400]()\n\n### Flags and Subtree Flags\n\nDuring the render phase, fibers are marked with **flags** indicating what effects need to be applied during commit. The `bubbleProperties` function propagates these flags up the tree:\n\n```javascript\nfunction bubbleProperties(completedWork) {\n  let subtreeFlags = NoFlags;\n  let child = completedWork.child;\n  \n  // Collect flags from all children\n  while (child !== null) {\n    subtreeFlags |= child.subtreeFlags;\n    subtreeFlags |= child.flags;\n    child = child.sibling;\n  }\n  \n  completedWork.subtreeFlags = subtreeFlags;\n}\n```\n\nThis allows ancestor fibers to know if any descendant has effects, enabling efficient traversal during commit.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCompleteWork.js:662-724]()\n\n## Commit Phase\n\nOnce the render phase completes successfully (`workInProgressRootExitStatus === RootCompleted`), the commit phase begins. The commit phase is **synchronous and uninterruptible** - it must complete once started.\n\n### Commit Root Entry\n\n```mermaid\ngraph TB\n    renderComplete["renderRoot completes successfully"]\n    finishConcurrent["finishQueueingConcurrentUpdates()"]\n    commitRoot["commitRoot(root, recoverableErrors, transitions)"]\n    \n    renderComplete --> finishConcurrent\n    finishConcurrent --> commitRoot\n    \n    commitRoot --> commitImpl["commitRootImpl(root, recoverableErrors, transitions, renderPriorityLevel)"]\n    \n    commitImpl --> beforeMutation["commitBeforeMutationEffects(root, finishedWork)"]\n    commitImpl --> mutation["commitMutationEffects(root, finishedWork, lanes)"]\n    commitImpl --> layout["commitLayoutEffects(finishedWork, root, lanes)"]\n```\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:2210-2350]()\n\n### Commit Sub-Phases\n\nThe commit phase executes in three sequential sub-phases:\n\n#### 1. Before Mutation Phase\n\n**Purpose:** Run effects that read the DOM before mutations occur\n\n**Key Function:** `commitBeforeMutationEffects(root, firstChild, committedLanes)`\n\nThis phase traverses the tree and for each fiber:\n\n| Fiber Tag | Action |\n|-----------|--------|\n| ClassComponent | Calls `instance.getSnapshotBeforeUpdate(prevProps, prevState)` |\n| HostRoot | Clears container if needed |\n| FunctionComponent | Updates ref.impl for `useImperativeHandle` |\n\nThe traversal pattern uses `nextEffect` pointer and processes:\n1. Deletions array on each fiber\n2. The fiber itself via `commitBeforeMutationEffectsOnFiber`\n3. Children recursively\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:343-362](), [packages/react-reconciler/src/ReactFiberCommitWork.js:474-569]()\n\n#### 2. Mutation Phase\n\n**Purpose:** Apply all DOM mutations (insertions, updates, deletions)\n\n**Key Function:** `commitMutationEffects(root, finishedWork, committedLanes)`\n\nThis is where the actual DOM changes occur:\n\n| Operation | Function | What It Does |\n|-----------|----------|--------------|\n| Insert/Move | `commitPlacement(finishedWork)` | Inserts fiber\'s host instance into parent using `insertBefore` or `appendChild` |\n| Update | `commitUpdate(instance, updatePayload, type, oldProps, newProps)` | Updates DOM properties using `updateProperties` |\n| Delete | `commitDeletion(root, deletion)` | Recursively unmounts subtree and removes from DOM |\n| Text Update | `commitTextUpdate(textInstance, oldText, newText)` | Updates text node\'s `nodeValue` |\n| Ref Update | `safelyDetachRef(fiber)` / `safelyAttachRef(fiber)` | Detaches old refs, attaches new ones |\n\n**Critical Moment:** After mutations complete, the tree switch occurs:\n\n```javascript\nroot.current = finishedWork;\n```\n\nThe work-in-progress tree becomes the current tree. From this point, the new tree is "live."\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:1817-1900](), [packages/react-reconciler/src/ReactFiberCommitHostEffects.js:250-485](), [packages/react-reconciler/src/ReactFiberCommitHostEffects.js:132-150]()\n\n#### 3. Layout Phase\n\n**Purpose:** Run effects that need to read the updated DOM layout\n\n**Key Function:** `commitLayoutEffects(finishedRoot, finishedWork, committedLanes)`\n\nThis phase runs synchronously after mutations and calls:\n\n| Fiber Tag | Lifecycle Methods Called |\n|-----------|-------------------------|\n| ClassComponent | `componentDidMount()` or `componentDidUpdate(prevProps, prevState, snapshot)` |\n| FunctionComponent | Layout effects from `useLayoutEffect(() => { ... })` |\n| HostRoot | Root-level callbacks if any |\n| Profiler | `onRender(id, phase, actualDuration, ...)` |\n\nThe layout effect execution order:\n1. Traverse tree depth-first\n2. Call `commitHookLayoutEffects(fiber, HookLayout | HookHasEffect)` for function components\n3. Call `commitClassLayoutLifecycles(fiber, current)` for class components\n4. Attach refs via `safelyAttachRef(fiber, fiber.return)`\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:590-800](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:1-150]()\n\n**Commit Phase Timeline:**\n\n```mermaid\ngraph LR\n    start["Commit Begins"]\n    before["Before Mutation<br/>getSnapshotBeforeUpdate"]\n    switch["Switch Trees<br/>root.current = finishedWork"]\n    mutation["Mutation<br/>Apply DOM changes"]\n    layout["Layout<br/>componentDidMount<br/>useLayoutEffect"]\n    passive["Passive Effects<br/>useEffect<br/>(scheduled async)"]\n    \n    start --> before\n    before --> mutation\n    mutation --> switch\n    switch --> layout\n    layout --> passive\n```\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:2510-2900]()\n\n### Passive Effects (useEffect)\n\nUnlike layout effects which run synchronously during commit, passive effects (from `useEffect`) are scheduled to run **after** the commit phase completes. They run in a separate task:\n\n**Passive Effect Scheduling Flow:**\n\n```mermaid\ngraph TB\n    beforeMut["Before Mutation Phase"]\n    detectPassive["Detect fibers with PassiveMask flag"]\n    scheduleCallback["scheduleCallback(NormalPriority, flushPassiveEffects)"]\n    \n    beforeMut --> detectPassive\n    detectPassive --> scheduleCallback\n    \n    layoutDone["Layout Phase Complete"]\n    layoutDone --> yieldToBrowser["Yield to browser"]\n    \n    yieldToBrowser --> passiveTask["Scheduler picks up passive effects task"]\n    passiveTask --> flushPassive["flushPassiveEffects()"]\n    \n    flushPassive --> unmount["commitPassiveUnmountEffects(root, finishedWork)<br/>Run cleanup functions"]\n    unmount --> mount["commitPassiveMountEffects(root, finishedWork)<br/>Run effect create functions"]\n```\n\n**Key Functions:**\n\n- `commitPassiveUnmountEffects`: Walks tree and calls `destroy()` functions from previous render\n- `commitPassiveMountEffects`: Walks tree and calls effect `create()` functions, storing returned cleanup\n- `commitHookPassiveUnmountEffects(fiber, HookPassive | HookHasEffect)`: Processes individual hook effects\n- `commitHookPassiveMountEffects(fiber, HookPassive | HookHasEffect)`: Runs effect callbacks\n\nThe separation allows the browser to paint before running effects, improving perceived performance.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:2300-2500](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:150-300]()\n\n## Error Handling and Suspension\n\n### Suspended Render\n\nIf during `beginWork` a component throws a promise (Suspense) or encounters an error, the work loop enters a suspended state:\n\n```mermaid\ngraph TB\n    beginWork["beginWork throws"]\n    caught["try/catch in performUnitOfWork or workLoopConcurrent"]\n    handleThrow["handleThrow(root, thrownValue)"]\n    \n    beginWork --> caught\n    caught --> handleThrow\n    \n    handleThrow --> classify{"Classify thrown value"}\n    \n    classify -->|"SuspenseException"| suspendedOnData["workInProgressSuspendedReason = SuspendedOnData"]\n    classify -->|"Error object"| suspendedOnError["workInProgressSuspendedReason = SuspendedOnError"]\n    classify -->|"SuspenseActionException"| suspendedOnAction["workInProgressSuspendedReason = SuspendedOnAction"]\n    classify -->|"Wakeable/Promise"| suspendedOnImmediate["workInProgressSuspendedReason = SuspendedOnImmediate"]\n    \n    suspendedOnData --> throwException["throwException(root, errorInfo, lane)"]\n    suspendedOnError --> throwException\n    suspendedOnAction --> throwException\n    suspendedOnImmediate --> throwException\n    \n    throwException --> getSuspense["getSuspenseHandler() - find nearest Suspense boundary"]\n    getSuspense --> markCapture["boundary.flags |= ShouldCapture"]\n    markCapture --> attachPing["Attach ping listener to promise"]\n    attachPing --> unwind["Begin unwinding: unwindUnitOfWork()"]\n```\n\n**Key Suspension Reasons (workInProgressSuspendedReason):**\n\n| Reason | Value | Triggered By |\n|--------|-------|--------------|\n| NotSuspended | 0 | Normal execution |\n| SuspendedOnError | 1 | Error thrown during render |\n| SuspendedOnData | 2 | Promise thrown from `use(promise)` or legacy Suspense |\n| SuspendedOnImmediate | 3 | Promise without fallback |\n| SuspendedOnAction | 9 | Server Action suspended |\n\nWhen a promise is thrown, React:\n1. Finds the nearest Suspense boundary via `getSuspenseHandler()`\n2. Marks it with `ShouldCapture` flag\n3. Attaches a ping listener that will schedule a retry when the promise resolves\n4. Unwinds the stack to the boundary\n5. Re-renders from the boundary, this time rendering the fallback\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:1610-1800](), [packages/react-reconciler/src/ReactFiberThrow.js:200-600](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:441-451]()\n\n### Unwind Work\n\nWhen unwinding due to an error or suspension, `unwindWork` is called on each fiber to clean up:\n\n**Unwind Work By Fiber Tag:**\n\n| Fiber Tag | Cleanup Actions |\n|-----------|----------------|\n| ClassComponent | `popLegacyContext(workInProgress)` if context provider |\n| HostRoot | `popHostContainer`, `popTopLevelLegacyContextObject`, `popRootTransition`, `popCacheProvider` |\n| HostComponent | `popHostContext(workInProgress)` |\n| SuspenseComponent | `popSuspenseHandler(workInProgress)` |\n| OffscreenComponent | `popHiddenContext`, `popSuspenseHandler` |\n| CacheComponent | `popCacheProvider` |\n\nIf the fiber has the `ShouldCapture` flag, `unwindWork` converts it to `DidCapture` and returns the fiber, telling the work loop to re-render from this point (for error boundaries and Suspense boundaries).\n\nThe function `unwindInterruptedWork` is similar but used when work is interrupted (e.g., higher priority update arrives), and doesn\'t handle error capture.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberUnwindWork.js:66-200]()\n\n## Complete Work Loop Diagram\n\n```mermaid\ngraph TB\n    update["State update or initial render"]\n    schedule["scheduleUpdateOnFiber(root, fiber, lane)"]\n    ensureScheduled["ensureRootIsScheduled(root)"]\n    \n    update --> schedule\n    schedule --> ensureScheduled\n    \n    ensureScheduled --> performRoot["performSyncWorkOnRoot or<br/>performConcurrentWorkOnRoot"]\n    \n    performRoot --> prepareStack["prepareFreshStack(root, lanes)<br/>Create workInProgress tree"]\n    \n    prepareStack --> workLoop["workLoopSync() or<br/>workLoopConcurrent()"]\n    \n    workLoop --> performUnit["performUnitOfWork(workInProgress)"]\n    \n    performUnit --> beginPhase["beginWork(current, workInProgress, lanes)"]\n    \n    beginPhase --> hasChild{"Returns child?"}\n    \n    hasChild -->|"Yes"| nextFiber["workInProgress = child<br/>Continue loop"]\n    hasChild -->|"No"| completePhase["completeUnitOfWork(workInProgress)"]\n    \n    completePhase --> completeWork["completeWork(current, completedWork, lanes)"]\n    \n    completeWork --> hasSibling{"Has sibling?"}\n    \n    hasSibling -->|"Yes"| nextSibling["workInProgress = sibling<br/>Continue loop"]\n    hasSibling -->|"No"| parent["Move to parent"]\n    \n    parent --> atRoot{"At root?"}\n    atRoot -->|"No"| completeWork\n    atRoot -->|"Yes"| checkStatus{"Exit status?"}\n    \n    checkStatus -->|"RootCompleted"| commitPhase["Commit Phase"]\n    checkStatus -->|"RootSuspended"| scheduleRetry["Schedule retry"]\n    checkStatus -->|"RootErrored"| handleError["Handle error"]\n    \n    commitPhase --> beforeMutation["Before Mutation Sub-Phase"]\n    beforeMutation --> mutationPhase["Mutation Sub-Phase"]\n    mutationPhase --> switchCurrent["root.current = finishedWork"]\n    switchCurrent --> layoutPhase["Layout Sub-Phase"]\n    layoutPhase --> schedulePassive["Schedule Passive Effects"]\n    schedulePassive --> done["Commit Complete"]\n    \n    nextFiber --> performUnit\n    nextSibling --> performUnit\n```\n\n**Sources:** [packages/react-reconciler/src/ReactFiberWorkLoop.js:400-3000](), [packages/react-reconciler/src/ReactFiberBeginWork.js:1-4000](), [packages/react-reconciler/src/ReactFiberCompleteWork.js:1-1400](), [packages/react-reconciler/src/ReactFiberCommitWork.js:1-3500]()\n\n---\n\n# Page: React Hooks System\n\n# React Hooks System\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-debug-tools/src/ReactDebugHooks.js](packages/react-debug-tools/src/ReactDebugHooks.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspection-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspection-test.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegration-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegration-test.js)\n- [packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegrationDOM-test.js](packages/react-debug-tools/src/__tests__/ReactHooksInspectionIntegrationDOM-test.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/CustomHooks.js](packages/react-devtools-shell/src/app/InspectableElements/CustomHooks.js)\n- [packages/react-reconciler/src/ReactFiberHooks.js](packages/react-reconciler/src/ReactFiberHooks.js)\n- [packages/react-reconciler/src/ReactFiberOffscreenComponent.js](packages/react-reconciler/src/ReactFiberOffscreenComponent.js)\n- [packages/react-reconciler/src/ReactFiberRoot.js](packages/react-reconciler/src/ReactFiberRoot.js)\n- [packages/react-reconciler/src/ReactInternalTypes.js](packages/react-reconciler/src/ReactInternalTypes.js)\n- [packages/react-reconciler/src/__tests__/ReactHooks-test.internal.js](packages/react-reconciler/src/__tests__/ReactHooks-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js)\n- [packages/react-server/src/ReactFizzHooks.js](packages/react-server/src/ReactFizzHooks.js)\n- [packages/react-server/src/ReactFlightHooks.js](packages/react-server/src/ReactFlightHooks.js)\n- [packages/react/src/ReactHooks.js](packages/react/src/ReactHooks.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes the React Hooks System implementation, including the dispatcher pattern, hook data structures, effect execution lifecycle, and debugging capabilities. Hooks enable function components to use state and lifecycle features without writing classes.\n\nFor information about the overall reconciliation process that invokes hooks, see [Fiber Architecture and Work Loop](#4.1). For server-side rendering specifics, see [React Fizz (Streaming SSR)](#5.1). For static analysis of hook usage, see [ESLint Plugin for React Hooks](#7.2).\n\n## Architecture Overview\n\nThe hooks system uses a **dispatcher pattern** to provide different implementations based on component lifecycle phase. During render, hooks resolve to mount, update, or rerender dispatchers. Hook state is stored as a linked list on `fiber.memoizedState`, while effects form a circular list on `fiber.updateQueue.lastEffect`.\n\n**Hooks System Architecture**\n\n```mermaid\ngraph TB\n    subgraph "Public API Layer"\n        ReactHooks["React.useState<br/>React.useEffect<br/>React.useCallback<br/>etc."]\n    end\n    \n    subgraph "Dispatcher Resolution"\n        resolveDispatcher["resolveDispatcher()<br/>ReactSharedInternals.H"]\n        MountDispatcher["HooksDispatcherOnMount"]\n        UpdateDispatcher["HooksDispatcherOnUpdate"]\n        RerenderDispatcher["HooksDispatcherOnRerender"]\n        ContextOnlyDispatcher["ContextOnlyDispatcher"]\n    end\n    \n    subgraph "Core Render Function"\n        renderWithHooks["renderWithHooks()<br/>Sets dispatcher, calls component"]\n        finishRenderingHooks["finishRenderingHooks()<br/>Resets state"]\n    end\n    \n    subgraph "Hook Implementation"\n        mountState["mountState()<br/>Initialize hook"]\n        updateState["updateState()<br/>Process updates"]\n        mountEffect["mountEffect()<br/>Create effect"]\n        updateEffect["updateEffect()<br/>Update effect"]\n    end\n    \n    subgraph "Data Structures"\n        HookList["Hook Linked List<br/>fiber.memoizedState"]\n        UpdateQueue["UpdateQueue<br/>pending updates"]\n        EffectList["Effect Circular List<br/>fiber.updateQueue.lastEffect"]\n    end\n    \n    subgraph "Commit Phase"\n        commitHookEffectListMount["commitHookEffectListMount()"]\n        commitHookEffectListUnmount["commitHookEffectListUnmount()"]\n        flushPassiveEffects["flushPassiveEffects()"]\n    end\n    \n    ReactHooks --> resolveDispatcher\n    resolveDispatcher --> MountDispatcher\n    resolveDispatcher --> UpdateDispatcher\n    resolveDispatcher --> RerenderDispatcher\n    resolveDispatcher --> ContextOnlyDispatcher\n    \n    MountDispatcher --> renderWithHooks\n    UpdateDispatcher --> renderWithHooks\n    RerenderDispatcher --> renderWithHooks\n    \n    renderWithHooks --> mountState\n    renderWithHooks --> updateState\n    renderWithHooks --> mountEffect\n    renderWithHooks --> updateEffect\n    renderWithHooks --> finishRenderingHooks\n    \n    mountState --> HookList\n    updateState --> HookList\n    updateState --> UpdateQueue\n    mountEffect --> EffectList\n    updateEffect --> EffectList\n    \n    EffectList --> commitHookEffectListMount\n    EffectList --> commitHookEffectListUnmount\n    EffectList --> flushPassiveEffects\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1-200](), [packages/react/src/ReactHooks.js:1-242]()\n\n## Public Hooks API\n\nThe public API is exposed through `packages/react/src/ReactHooks.js`. Each hook function calls `resolveDispatcher()` to obtain the current dispatcher from `ReactSharedInternals.H`, then delegates to the dispatcher implementation.\n\n**Available Hooks**\n\n| Hook | Purpose | Stateful |\n|------|---------|----------|\n| `useState` | Local component state | Yes |\n| `useReducer` | State with reducer logic | Yes |\n| `useEffect` | Side effects after paint | No |\n| `useLayoutEffect` | Side effects before paint | No |\n| `useInsertionEffect` | CSS-in-JS insertions | No |\n| `useContext` | Read context value | No |\n| `useRef` | Mutable reference | Yes |\n| `useMemo` | Memoized value | Yes |\n| `useCallback` | Memoized callback | Yes |\n| `useImperativeHandle` | Customize ref value | No |\n| `useDebugValue` | DevTools label | No |\n| `useId` | Stable unique ID | Yes |\n| `useTransition` | Non-blocking updates | Yes |\n| `useDeferredValue` | Defer value updates | Yes |\n| `useSyncExternalStore` | Subscribe to external store | Yes |\n| `useOptimistic` | Optimistic UI updates | Yes |\n| `useActionState` | Form action state | Yes |\n| `use` | Read Promise/Context | No |\n\n**Dispatcher Resolution Flow**\n\n```mermaid\ngraph LR\n    App["Component calls<br/>useState()"]\n    resolveDispatcher["resolveDispatcher()"]\n    SharedInternals["ReactSharedInternals.H"]\n    \n    CurrentDispatcher{{"Current<br/>Dispatcher?"}}\n    \n    Mount["HooksDispatcherOnMount"]\n    Update["HooksDispatcherOnUpdate"]\n    Rerender["HooksDispatcherOnRerender"]\n    ContextOnly["ContextOnlyDispatcher"]\n    \n    mountState["mountState()"]\n    updateState["updateState()"]\n    \n    App --> resolveDispatcher\n    resolveDispatcher --> SharedInternals\n    SharedInternals --> CurrentDispatcher\n    \n    CurrentDispatcher -->|"First render"| Mount\n    CurrentDispatcher -->|"Subsequent render"| Update\n    CurrentDispatcher -->|"Render phase update"| Rerender\n    CurrentDispatcher -->|"Outside render"| ContextOnly\n    \n    Mount --> mountState\n    Update --> updateState\n    Rerender --> updateState\n    ContextOnly -->|"Throws error"| Error["Invalid hook call"]\n```\n\nSources: [packages/react/src/ReactHooks.js:24-42](), [packages/react/src/ReactHooks.js:66-71]()\n\n## Dispatcher Pattern\n\nThe dispatcher is a dynamic vtable that changes based on component lifecycle phase. `renderWithHooks()` sets the appropriate dispatcher before calling the component function, ensuring hooks resolve to the correct implementation.\n\n**Dispatcher Implementations**\n\n| Dispatcher | When Used | Behavior |\n|------------|-----------|----------|\n| `HooksDispatcherOnMount` | First render (`current === null`) | Initializes hook state, creates linked list |\n| `HooksDispatcherOnUpdate` | Subsequent renders | Reuses existing hooks, processes updates |\n| `HooksDispatcherOnRerender` | Render phase updates | Handles setState during render |\n| `ContextOnlyDispatcher` | Outside component render | Throws "Invalid hook call" error |\n| `HooksDispatcherOnMountInDEV` | DEV first render | Validates hook order, dependencies |\n| `HooksDispatcherOnUpdateInDEV` | DEV subsequent render | Validates hook order changes |\n\n**renderWithHooks Execution Flow**\n\n```mermaid\ngraph TB\n    Start["renderWithHooks(current, workInProgress, Component)"]\n    \n    SetContext["Set module state:<br/>renderLanes = nextRenderLanes<br/>currentlyRenderingFiber = workInProgress"]\n    \n    ResetFiber["Reset fiber state:<br/>workInProgress.memoizedState = null<br/>workInProgress.updateQueue = null"]\n    \n    CheckCurrent{{"current === null ||<br/>current.memoizedState === null"}}\n    \n    SetMount["ReactSharedInternals.H =<br/>HooksDispatcherOnMount"]\n    SetUpdate["ReactSharedInternals.H =<br/>HooksDispatcherOnUpdate"]\n    \n    CallComponent["children = Component(props, secondArg)"]\n    \n    CheckRerender{{"didScheduleRenderPhaseUpdateDuringThisPass"}}\n    \n    RerenderLoop["renderWithHooksAgain():<br/>Loop while updates scheduled<br/>Use HooksDispatcherOnRerender"]\n    \n    StrictModeCheck{{"StrictMode enabled?"}}\n    \n    DoubleInvoke["Double invoke component<br/>for side effect detection"]\n    \n    Finish["finishRenderingHooks():<br/>Reset dispatcher to ContextOnlyDispatcher"]\n    \n    Return["Return children"]\n    \n    Start --> SetContext\n    SetContext --> ResetFiber\n    ResetFiber --> CheckCurrent\n    \n    CheckCurrent -->|"Yes (mount)"| SetMount\n    CheckCurrent -->|"No (update)"| SetUpdate\n    \n    SetMount --> CallComponent\n    SetUpdate --> CallComponent\n    \n    CallComponent --> CheckRerender\n    \n    CheckRerender -->|"Yes"| RerenderLoop\n    CheckRerender -->|"No"| StrictModeCheck\n    \n    RerenderLoop --> StrictModeCheck\n    \n    StrictModeCheck -->|"Yes"| DoubleInvoke\n    StrictModeCheck -->|"No"| Finish\n    \n    DoubleInvoke --> Finish\n    Finish --> Return\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:503-632](), [packages/react-reconciler/src/ReactFiberHooks.js:634-750]()\n\n## Hook Data Structures\n\n### Hook Linked List\n\nEach hook call appends a `Hook` object to a singly-linked list stored on `fiber.memoizedState`. The list order must remain constant across renders (enforced by DEV warnings).\n\n**Hook Object Structure**\n\n```mermaid\ngraph LR\n    Fiber["Fiber Node"]\n    \n    subgraph "fiber.memoizedState"\n        Hook1["Hook {<br/>memoizedState: any<br/>baseState: any<br/>baseQueue: Update | null<br/>queue: UpdateQueue | null<br/>next: Hook | null<br/>}"]\n        \n        Hook2["Hook {<br/>memoizedState: any<br/>...next<br/>}"]\n        \n        Hook3["Hook {<br/>memoizedState: any<br/>...next<br/>}"]\n    end\n    \n    Fiber --> Hook1\n    Hook1 -->|"next"| Hook2\n    Hook2 -->|"next"| Hook3\n    Hook3 -->|"next"| Null["null"]\n```\n\nThe `Hook` type definition:\n\n```typescript\ntype Hook = {\n  memoizedState: any,      // Current state value or effect list\n  baseState: any,          // State before pending updates\n  baseQueue: Update | null, // Updates skipped by priority\n  queue: any,              // UpdateQueue for useState/useReducer\n  next: Hook | null        // Next hook in list\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:195-201](), [packages/react-reconciler/src/ReactFiberHooks.js:980-999]()\n\n### UpdateQueue Structure\n\nState hooks (`useState`, `useReducer`) maintain an `UpdateQueue` to track pending updates. Updates form a circular linked list and are processed in order during render.\n\n**UpdateQueue and Update Structure**\n\n```mermaid\ngraph TB\n    Hook["Hook"]\n    \n    subgraph "hook.queue (UpdateQueue)"\n        Queue["UpdateQueue {<br/>pending: Update | null<br/>lanes: Lanes<br/>dispatch: Function<br/>lastRenderedReducer: Function<br/>lastRenderedState: any<br/>}"]\n    end\n    \n    subgraph "Circular Update List"\n        Update1["Update {<br/>lane: Lane<br/>action: any<br/>hasEagerState: boolean<br/>eagerState: any<br/>next: Update<br/>}"]\n        \n        Update2["Update {<br/>lane: Lane<br/>action: any<br/>...next<br/>}"]\n        \n        Update3["Update {<br/>lane: Lane<br/>action: any<br/>...next<br/>}"]\n    end\n    \n    Hook -->|"queue"| Queue\n    Queue -->|"pending"| Update3\n    Update3 -->|"next"| Update1\n    Update1 -->|"next"| Update2\n    Update2 -->|"next"| Update3\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:165-181](), [packages/react-reconciler/src/ReactFiberHooks.js:175-181]()\n\n### Effect Circular List\n\nEffects (`useEffect`, `useLayoutEffect`, `useInsertionEffect`) are stored in a circular linked list on `fiber.updateQueue.lastEffect`. Each `Effect` object contains the effect function, cleanup function, dependencies, and flags.\n\n**Effect Data Structure**\n\n```typescript\ntype Effect = {\n  tag: HookFlags,              // HookPassive | HookLayout | HookInsertion\n  inst: EffectInstance,        // { destroy: Function | void }\n  create: () => (() => void) | void,  // Effect function\n  deps: Array<mixed> | void | null,   // Dependency array\n  next: Effect                 // Next effect in circular list\n}\n\ntype FunctionComponentUpdateQueue = {\n  lastEffect: Effect | null,   // Tail of circular effect list\n  events: Array<any> | null,   // Event functions\n  stores: Array<any> | null,   // Store consistency checks\n  memoCache: MemoCache | null  // Compiler cache\n}\n```\n\nThe `lastEffect` pointer points to the **last** effect in the circular list, so `lastEffect.next` is the **first** effect.\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:217-227](), [packages/react-reconciler/src/ReactFiberHooks.js:247-252]()\n\n## Core Hook Implementations\n\n### State Hooks: useState and useReducer\n\n`useState` is implemented as a specialized `useReducer` with a basic state reducer. Both follow the mount/update pattern.\n\n**useState/useReducer Implementation Flow**\n\n```mermaid\ngraph TB\n    Call["useState(initialState)<br/>or useReducer(reducer, initialArg, init)"]\n    \n    CreateWIP["createWorkInProgressHook()"]\n    \n    CheckPhase{{"Mount or Update?"}}\n    \n    subgraph "Mount Phase"\n        InitState["Calculate initial state:<br/>- useState: call initializer if function<br/>- useReducer: call init(initialArg) if provided"]\n        CreateQueue["Create UpdateQueue:<br/>queue = {<br/>  pending: null,<br/>  lanes: NoLanes,<br/>  dispatch: null,<br/>  lastRenderedReducer: reducer,<br/>  lastRenderedState: initialState<br/>}"]\n        BindDispatch["dispatch = dispatchSetState.bind(null, fiber, queue)"]\n        StoreState["hook.memoizedState = initialState<br/>hook.queue = queue"]\n        ReturnMount["Return [initialState, dispatch]"]\n    end\n    \n    subgraph "Update Phase"\n        CloneHook["Clone hook from current:<br/>workInProgressHook = {<br/>  memoizedState: currentHook.memoizedState,<br/>  baseState: currentHook.baseState,<br/>  baseQueue: currentHook.baseQueue,<br/>  queue: currentHook.queue<br/>}"]\n        \n        CheckUpdates{{"queue.pending !== null?"}}\n        \n        ProcessQueue["Process update queue:<br/>- Apply baseQueue (skipped updates)<br/>- Apply pending updates<br/>- Calculate new state<br/>- Determine if state changed"]\n        \n        UpdateBaseState["Update baseState, baseQueue<br/>for next render"]\n        \n        ReturnUpdate["Return [newState, dispatch]"]\n    end\n    \n    Call --> CreateWIP\n    CreateWIP --> CheckPhase\n    \n    CheckPhase -->|"Mount"| InitState\n    InitState --> CreateQueue\n    CreateQueue --> BindDispatch\n    BindDispatch --> StoreState\n    StoreState --> ReturnMount\n    \n    CheckPhase -->|"Update"| CloneHook\n    CloneHook --> CheckUpdates\n    \n    CheckUpdates -->|"Yes"| ProcessQueue\n    CheckUpdates -->|"No"| ReturnUpdate\n    \n    ProcessQueue --> UpdateBaseState\n    UpdateBaseState --> ReturnUpdate\n```\n\n**Eager State Computation**\n\nWhen `setState` is called, React attempts to compute the new state eagerly (outside render) if the queue is empty. If the new state equals the current state (using `Object.is`), React can bail out of the render entirely.\n\n```mermaid\ngraph TB\n    SetState["setState(action)<br/>or dispatch(action)"]\n    \n    CheckContext{{"Is inside render?"}}\n    \n    RenderPhaseUpdate["Enqueue render phase update:<br/>Store in renderPhaseUpdates Map"]\n    \n    CreateUpdate["Create Update object:<br/>update = {<br/>  lane: requestUpdateLane(),<br/>  action: action,<br/>  hasEagerState: false,<br/>  eagerState: null,<br/>  next: null<br/>}"]\n    \n    EnqueueConcurrent["enqueueConcurrentHookUpdate(fiber, queue, update, lane)"]\n    \n    CheckEager{{"Queue is empty &<br/>alternate exists?"}}\n    \n    ComputeEager["Eager computation:<br/>eagerState = lastRenderedReducer(lastRenderedState, action)"]\n    \n    CheckSame{{"Object.is(eagerState, currentState)?"}}\n    \n    MarkEager["update.hasEagerState = true<br/>update.eagerState = eagerState"]\n    \n    BailOut["Bail out:<br/>Do not schedule update<br/>Return immediately"]\n    \n    ScheduleUpdate["scheduleUpdateOnFiber(fiber, lane)"]\n    \n    SetState --> CheckContext\n    \n    CheckContext -->|"Yes"| RenderPhaseUpdate\n    CheckContext -->|"No"| CreateUpdate\n    \n    CreateUpdate --> EnqueueConcurrent\n    EnqueueConcurrent --> CheckEager\n    \n    CheckEager -->|"Yes"| ComputeEager\n    CheckEager -->|"No"| ScheduleUpdate\n    \n    ComputeEager --> CheckSame\n    \n    CheckSame -->|"Yes"| MarkEager\n    CheckSame -->|"No"| ScheduleUpdate\n    \n    MarkEager --> BailOut\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1095-1253](), [packages/react-reconciler/src/ReactFiberHooks.js:2648-2861]()\n\n### Effect Hooks: useEffect, useLayoutEffect, useInsertionEffect\n\nEffect hooks create `Effect` objects and append them to the circular effect list. The `tag` field determines when the effect is executed:\n\n- `HookInsertion`: During commit before mutations (for CSS-in-JS)\n- `HookLayout`: During commit after mutations, before paint (sync)\n- `HookPassive`: After commit and paint (async via scheduler)\n\n**Effect Mount and Update**\n\n```mermaid\ngraph TB\n    CallEffect["useEffect(create, deps)"]\n    \n    CreateWIP["createWorkInProgressHook()"]\n    \n    CheckPhase{{"Mount or Update?"}}\n    \n    subgraph "Mount Phase"\n        CreateEffect["Create Effect object:<br/>effect = {<br/>  tag: HookPassive | HookHasEffect,<br/>  inst: { destroy: undefined },<br/>  create: create,<br/>  deps: deps,<br/>  next: null<br/>}"]\n        \n        AppendEffect["Append to circular list:<br/>fiber.updateQueue.lastEffect = effect"]\n        \n        MarkFlag["Mark fiber flag:<br/>fiber.flags |= PassiveEffect"]\n    end\n    \n    subgraph "Update Phase"\n        CheckDeps{{"areHookInputsEqual(nextDeps, prevDeps)?"}}\n        \n        CreateNoOpEffect["Create Effect without HookHasEffect:<br/>effect.tag = HookPassive<br/>(won\'t fire)"]\n        \n        CreateNewEffect["Create Effect with HookHasEffect:<br/>effect.tag = HookPassive | HookHasEffect<br/>(will fire)"]\n        \n        UpdateList["Update circular list"]\n    end\n    \n    CallEffect --> CreateWIP\n    CreateWIP --> CheckPhase\n    \n    CheckPhase -->|"Mount"| CreateEffect\n    CreateEffect --> AppendEffect\n    AppendEffect --> MarkFlag\n    \n    CheckPhase -->|"Update"| CheckDeps\n    \n    CheckDeps -->|"Deps unchanged"| CreateNoOpEffect\n    CheckDeps -->|"Deps changed"| CreateNewEffect\n    \n    CreateNoOpEffect --> UpdateList\n    CreateNewEffect --> UpdateList\n    UpdateList --> MarkFlag\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1956-2023](), [packages/react-reconciler/src/ReactFiberHooks.js:2025-2069]()\n\n### Ref Hook: useRef\n\n`useRef` is a simple hook that stores a mutable object with a `current` property. The ref object identity remains stable across renders.\n\n```mermaid\ngraph LR\n    Call["useRef(initialValue)"]\n    \n    CreateWIP["createWorkInProgressHook()"]\n    \n    CheckPhase{{"Mount or Update?"}}\n    \n    Mount["Mount:<br/>ref = { current: initialValue }<br/>hook.memoizedState = ref"]\n    \n    Update["Update:<br/>ref = hook.memoizedState"]\n    \n    Return["Return ref"]\n    \n    Call --> CreateWIP\n    CreateWIP --> CheckPhase\n    CheckPhase -->|"Mount"| Mount\n    CheckPhase -->|"Update"| Update\n    Mount --> Return\n    Update --> Return\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1764-1779]()\n\n### Memoization Hooks: useMemo and useCallback\n\n`useMemo` and `useCallback` cache computed values based on dependency arrays. During mount, they compute and store the value. During update, they check dependencies and either reuse or recompute.\n\n**useMemo Implementation**\n\n```mermaid\ngraph TB\n    Call["useMemo(create, deps)"]\n    \n    CreateWIP["createWorkInProgressHook()"]\n    \n    CheckPhase{{"Mount or Update?"}}\n    \n    subgraph "Mount Phase"\n        CallCreate["value = create()"]\n        StoreMount["hook.memoizedState = [value, deps]"]\n        ReturnMount["Return value"]\n    end\n    \n    subgraph "Update Phase"\n        GetPrev["prevState = hook.memoizedState<br/>[prevValue, prevDeps] = prevState"]\n        \n        CheckDeps{{"areHookInputsEqual(nextDeps, prevDeps)?"}}\n        \n        ReuseValue["Return prevValue"]\n        \n        RecomputeValue["value = create()<br/>hook.memoizedState = [value, nextDeps]"]\n        \n        ReturnNew["Return value"]\n    end\n    \n    Call --> CreateWIP\n    CreateWIP --> CheckPhase\n    \n    CheckPhase -->|"Mount"| CallCreate\n    CallCreate --> StoreMount\n    StoreMount --> ReturnMount\n    \n    CheckPhase -->|"Update"| GetPrev\n    GetPrev --> CheckDeps\n    \n    CheckDeps -->|"Yes"| ReuseValue\n    CheckDeps -->|"No"| RecomputeValue\n    \n    RecomputeValue --> ReturnNew\n```\n\n`useCallback(fn, deps)` is implemented as `useMemo(() => fn, deps)`.\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:1890-1931](), [packages/react-reconciler/src/ReactFiberHooks.js:1933-1954]()\n\n## Effect Execution Lifecycle\n\nEffects are executed during the commit phase, but at different times based on their type. The fiber flags (`PassiveEffect`, `UpdateEffect`) indicate which effects need to be processed.\n\n**Effect Execution Timeline**\n\n```mermaid\ngraph TB\n    subgraph "Render Phase"\n        RenderComponent["renderWithHooks()<br/>Component executes"]\n        CollectEffects["Effects collected in<br/>fiber.updateQueue.lastEffect"]\n        MarkFlags["Set fiber.flags:<br/>PassiveEffect, UpdateEffect, etc."]\n    end\n    \n    subgraph "Commit Phase - Before Mutation"\n        BeforeMutation["commitBeforeMutationEffects()"]\n        Snapshots["No effect execution<br/>(getSnapshotBeforeUpdate)"]\n    end\n    \n    subgraph "Commit Phase - Mutation"\n        Mutation["commitMutationEffects()"]\n        InsertionUnmount["commitHookEffectListUnmount(HookInsertion):<br/>Run insertion effect cleanups"]\n    end\n    \n    subgraph "Commit Phase - Layout"\n        Layout["commitLayoutEffects()"]\n        \n        InsertionMount["commitHookEffectListMount(HookInsertion):<br/>Run insertion effects"]\n        \n        LayoutUnmount["commitHookEffectListUnmount(HookLayout):<br/>Run layout effect cleanups"]\n        \n        LayoutMount["commitHookEffectListMount(HookLayout):<br/>Run layout effects (useLayoutEffect)"]\n    end\n    \n    subgraph "After Paint - Async"\n        SchedulePassive["scheduleCallback(NormalPriority, flushPassiveEffects)"]\n        \n        FlushPassive["flushPassiveEffects()"]\n        \n        PassiveUnmount["commitHookPassiveUnmountEffects():<br/>Run passive effect cleanups"]\n        \n        PassiveMount["commitHookPassiveMountEffects():<br/>Run passive effects (useEffect)"]\n    end\n    \n    RenderComponent --> CollectEffects\n    CollectEffects --> MarkFlags\n    \n    MarkFlags --> BeforeMutation\n    BeforeMutation --> Snapshots\n    \n    Snapshots --> Mutation\n    Mutation --> InsertionUnmount\n    \n    InsertionUnmount --> Layout\n    Layout --> InsertionMount\n    InsertionMount --> LayoutUnmount\n    LayoutUnmount --> LayoutMount\n    \n    LayoutMount --> SchedulePassive\n    SchedulePassive --> FlushPassive\n    FlushPassive --> PassiveUnmount\n    PassiveUnmount --> PassiveMount\n```\n\n**Effect Tag Bits**\n\n| Tag | Constant | Meaning |\n|-----|----------|---------|\n| `HookHasEffect` | `0b001` | Effect should fire this render |\n| `HookInsertion` | `0b010` | Insertion effect (CSS-in-JS) |\n| `HookLayout` | `0b100` | Layout effect (sync after mutations) |\n| `HookPassive` | `0b1000` | Passive effect (async after paint) |\n\nEffects only execute if `effect.tag & HookHasEffect !== 0`. During mount, all effects have `HookHasEffect`. During update, only effects with changed dependencies have `HookHasEffect`.\n\nSources: [packages/react-reconciler/src/ReactHookEffectTags.js:1-21](), [packages/react-reconciler/src/ReactFiberHooks.js:1956-2023]()\n\n## Server-Side Hooks Implementation\n\nThe Fizz server renderer (`packages/react-server/src/ReactFizzHooks.js`) provides a separate hooks implementation optimized for synchronous server rendering. Key differences:\n\n- **No effects**: `useEffect`, `useLayoutEffect`, `useInsertionEffect` are no-ops\n- **Simpler state management**: No concurrent updates or lanes\n- **Synchronous execution**: No scheduling or yielding\n- **Render phase updates**: Handled via re-render loop with `renderPhaseUpdates` Map\n\n**Server Hook State Management**\n\n```mermaid\ngraph TB\n    PrepareHooks["prepareToUseHooks(request, task, componentIdentity)"]\n    \n    SetContext["Set module state:<br/>currentlyRenderingComponent = componentIdentity<br/>currentlyRenderingTask = task<br/>currentlyRenderingRequest = request"]\n    \n    CallComponent["Component(props, context)"]\n    \n    CreateWIPHook["createWorkInProgressHook():<br/>Create or reuse hook"]\n    \n    CheckRerender{{"didScheduleRenderPhaseUpdate?"}}\n    \n    RerenderLoop["Loop while updates scheduled:<br/>Apply renderPhaseUpdates<br/>Re-call Component()"]\n    \n    FinishHooks["finishHooks():<br/>Return children"]\n    \n    ResetState["resetHooksState():<br/>Clear module state"]\n    \n    PrepareHooks --> SetContext\n    SetContext --> CallComponent\n    \n    CallComponent --> CreateWIPHook\n    CreateWIPHook --> CheckRerender\n    \n    CheckRerender -->|"Yes"| RerenderLoop\n    RerenderLoop --> CheckRerender\n    \n    CheckRerender -->|"No"| FinishHooks\n    FinishHooks --> ResetState\n```\n\n**Server useActionState Hook**\n\n`useActionState` (formerly `useFormState`) is special on the server. It receives permalink information and action state from the request, enabling progressive enhancement of forms.\n\nSources: [packages/react-server/src/ReactFizzHooks.js:207-316](), [packages/react-server/src/ReactFizzHooks.js:665-831]()\n\n## Debug and DevTools Integration\n\n### ReactDebugHooks\n\nThe `react-debug-tools` package provides `inspectHooks()` and `inspectHooksOfFiber()` to extract hook information for DevTools. It uses a custom dispatcher that logs all hook calls.\n\n**Hook Inspection Architecture**\n\n```mermaid\ngraph TB\n    DevTools["React DevTools"]\n    \n    InspectAPI["ReactDebugTools.inspectHooksOfFiber(fiber)"]\n    \n    subgraph "Inspection Process"\n        SaveDispatcher["Save current dispatcher"]\n        \n        SetDebugDispatcher["Set ReactSharedInternals.H = DispatcherProxy"]\n        \n        SetupContext["Setup currentFiber, currentHook<br/>from fiber.memoizedState"]\n        \n        ReplayRender["Call Component(props)<br/>to replay render"]\n        \n        LogHooks["Dispatcher logs each hook call:<br/>hookLog.push({ primitive, value, stackError })"]\n        \n        RestoreDispatcher["Restore original dispatcher"]\n        \n        BuildTree["buildTree(rootStack, hookLog):<br/>Parse stack traces<br/>Construct hook tree with nesting"]\n    end\n    \n    ReturnTree["Return HooksTree:<br/>Array of HooksNode"]\n    \n    DevTools --> InspectAPI\n    InspectAPI --> SaveDispatcher\n    SaveDispatcher --> SetDebugDispatcher\n    SetDebugDispatcher --> SetupContext\n    SetupContext --> ReplayRender\n    ReplayRender --> LogHooks\n    LogHooks --> RestoreDispatcher\n    RestoreDispatcher --> BuildTree\n    BuildTree --> ReturnTree\n    ReturnTree --> DevTools\n```\n\n**HooksNode Structure**\n\n```typescript\ntype HooksNode = {\n  id: number | null,              // Hook index for state hooks\n  isStateEditable: boolean,       // Can DevTools edit this state?\n  name: string,                   // Hook name (e.g., "State", "Effect", "Custom")\n  value: mixed,                   // Hook value\n  subHooks: Array<HooksNode>,     // Nested custom hook calls\n  debugInfo: ReactDebugInfo | null, // Debug metadata\n  hookSource: HookSource | null   // Source location { fileName, lineNumber, etc. }\n}\n```\n\nThe debug dispatcher intercepts every hook call, extracts its value from the fiber\'s hook list, and records it in `hookLog`. Stack trace parsing determines which hooks are nested inside custom hooks.\n\nSources: [packages/react-debug-tools/src/ReactDebugHooks.js:1-300](), [packages/react-debug-tools/src/ReactDebugHooks.js:996-1098]()\n\n### DEV-Only Validation\n\nIn development builds, React enforces the Rules of Hooks through several mechanisms:\n\n**Hook Order Validation**\n\n```mermaid\ngraph TB\n    Render["Component renders"]\n    \n    CheckDev{{"__DEV__ mode?"}}\n    \n    SaveTypes["Save hook types:<br/>workInProgress._debugHookTypes = hookTypesDev"]\n    \n    MountHook["mountHookTypesDev():<br/>hookTypesDev.push(hookName)"]\n    \n    UpdateHook["updateHookTypesDev():<br/>Check hookTypesDev[index] === hookName"]\n    \n    Mismatch{{"Hook type mismatch?"}}\n    \n    WarnMismatch["console.error:<br/>\'React has detected a change in the order of Hooks\'<br/>Show table of previous vs current"]\n    \n    CheckDeps["checkDepsAreArrayDev(deps):<br/>Warn if deps is not array"]\n    \n    CheckDepLength["Check deps.length matches prevDeps.length"]\n    \n    Continue["Continue render"]\n    \n    Render --> CheckDev\n    \n    CheckDev -->|"Yes"| SaveTypes\n    CheckDev -->|"No"| Continue\n    \n    SaveTypes --> MountHook\n    SaveTypes --> UpdateHook\n    \n    UpdateHook --> Mismatch\n    \n    Mismatch -->|"Yes"| WarnMismatch\n    Mismatch -->|"No"| CheckDeps\n    \n    WarnMismatch --> Continue\n    CheckDeps --> CheckDepLength\n    CheckDepLength --> Continue\n```\n\n**Validated Conditions**\n\n| Rule | Check | Error Message |\n|------|-------|---------------|\n| Hook order | `hookTypesDev[index] === currentHookName` | "React has detected a change in the order of Hooks" |\n| Dependency array | `isArray(deps)` | "received a final argument that is not an array" |\n| Dependency length | `nextDeps.length === prevDeps.length` | "changed size between renders" |\n| Effect callback | `create != null` | "requires an effect callback" |\n| Invalid context | `currentlyRenderingFiber !== null` | "Invalid hook call" |\n| Async component | `Object.prototype.toString.call(Component) !== \'[object AsyncFunction]\'` | "is an async Client Component" |\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:309-394](), [packages/react-reconciler/src/ReactFiberHooks.js:334-347]()\n\n## Hook Lifecycle Summary\n\n**Complete Hook Execution Flow**\n\n```mermaid\ngraph TB\n    subgraph "Initial Mount"\n        Mount1["renderWithHooks() sets HooksDispatcherOnMount"]\n        Mount2["Component calls hooks"]\n        Mount3["mountWorkInProgressHook() creates Hook nodes"]\n        Mount4["Hooks stored in fiber.memoizedState linked list"]\n        Mount5["Effects stored in fiber.updateQueue.lastEffect"]\n        Mount6["Fiber marked with PassiveEffect, UpdateEffect flags"]\n    end\n    \n    subgraph "Update Render"\n        Update1["renderWithHooks() sets HooksDispatcherOnUpdate"]\n        Update2["Component calls hooks"]\n        Update3["updateWorkInProgressHook() clones from current"]\n        Update4["Process update queues"]\n        Update5["Compare dependencies for effects"]\n        Update6["Mark changed effects with HookHasEffect"]\n    end\n    \n    subgraph "Commit Effects"\n        Commit1["Commit phase begins"]\n        Commit2["commitMutationEffects(): Insertion effect cleanups"]\n        Commit3["commitLayoutEffects(): Insertion + Layout effects"]\n        Commit4["Layout effect cleanups, then mounts"]\n        Commit5["scheduleCallback for passive effects"]\n        Commit6["After paint: flushPassiveEffects()"]\n        Commit7["Passive effect cleanups, then mounts"]\n    end\n    \n    subgraph "setState Called"\n        SetState1["setState(action) during event"]\n        SetState2["Create Update object"]\n        SetState3["Eager state computation if possible"]\n        SetState4["enqueueConcurrentHookUpdate()"]\n        SetState5["scheduleUpdateOnFiber()"]\n        SetState6["Triggers new render"]\n    end\n    \n    Mount1 --> Mount2\n    Mount2 --> Mount3\n    Mount3 --> Mount4\n    Mount4 --> Mount5\n    Mount5 --> Mount6\n    \n    Mount6 --> Commit1\n    \n    Update1 --> Update2\n    Update2 --> Update3\n    Update3 --> Update4\n    Update4 --> Update5\n    Update5 --> Update6\n    \n    Update6 --> Commit1\n    \n    Commit1 --> Commit2\n    Commit2 --> Commit3\n    Commit3 --> Commit4\n    Commit4 --> Commit5\n    Commit5 --> Commit6\n    Commit6 --> Commit7\n    \n    SetState1 --> SetState2\n    SetState2 --> SetState3\n    SetState3 --> SetState4\n    SetState4 --> SetState5\n    SetState5 --> SetState6\n    SetState6 --> Update1\n```\n\nSources: [packages/react-reconciler/src/ReactFiberHooks.js:503-750](), [packages/react-reconciler/src/ReactFiberHooks.js:2648-2861]()\n\n## Key Implementation Files\n\n| File | Purpose |\n|------|---------|\n| [packages/react/src/ReactHooks.js]() | Public hooks API, dispatcher resolution |\n| [packages/react-reconciler/src/ReactFiberHooks.js]() | Core hooks implementation for client-side rendering |\n| [packages/react-reconciler/src/ReactInternalTypes.js:46-66]() | `HookType`, `Dispatcher`, `Hook` type definitions |\n| [packages/react-reconciler/src/ReactInternalTypes.js:398-459]() | `Dispatcher` interface with all hook methods |\n| [packages/react-server/src/ReactFizzHooks.js]() | Server-side hooks implementation for Fizz |\n| [packages/react-debug-tools/src/ReactDebugHooks.js]() | Hook inspection for DevTools |\n| [packages/react-reconciler/src/ReactHookEffectTags.js]() | Effect type flags and constants |\n| [packages/react-reconciler/src/ReactFiberCommitWork.js]() | Effect execution during commit phase |\n\n---\n\n# Page: Lane-Based Scheduling and Priorities\n\n# Lane-Based Scheduling and Priorities\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document explains React\'s lane-based scheduling system, which assigns priority levels to updates and determines the order in which work is processed. Lanes are React\'s internal mechanism for implementing concurrent rendering, allowing high-priority updates to interrupt lower-priority work.\n\nFor information about the reconciler work loop that executes scheduled work, see [4.2](#4.2). For hook state management within the scheduling system, see [4.3](#4.3). For Suspense-specific retry scheduling, see [4.5](#4.5).\n\n## Overview\n\nThe lane system represents priority levels as bit flags in a 32-bit integer, where each bit position corresponds to a specific priority level. This allows React to efficiently perform set operations (union, intersection, difference) on groups of lanes and quickly determine the highest priority work.\n\nUpdates are assigned lanes based on their origin (user input, transition, idle work) and context (render phase, commit phase). The reconciler then selects which lanes to work on, potentially preempting lower-priority work when higher-priority updates arrive.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:1-100]()\n\n## Lane Definitions and Priority Levels\n\nThe following table lists all lane types from highest to lowest priority:\n\n| Lane Name | Binary Representation | Use Case |\n|-----------|----------------------|----------|\n| `SyncHydrationLane` | `0b...0001` | Synchronous hydration during SSR |\n| `SyncLane` | `0b...0010` | Synchronous updates (e.g., `flushSync`) |\n| `InputContinuousHydrationLane` | `0b...0100` | Hydration for continuous input |\n| `InputContinuousLane` | `0b...1000` | Continuous user input (drag, scroll) |\n| `DefaultHydrationLane` | `0b...10000` | Default hydration priority |\n| `DefaultLane` | `0b...100000` | Default updates (most `setState` calls) |\n| `GestureLane` | `0b...1000000` | Gesture-driven transitions |\n| `TransitionHydrationLane` | `0b...10000000` | Hydration for transitions |\n| `TransitionLanes` (16 lanes) | `0b...1111111100000000` | Transition updates (`startTransition`) |\n| `RetryLanes` (5 lanes) | `0b...11111000000000000000000` | Suspense boundary retries |\n| `IdleHydrationLane` | `0b...100000000000000000000000` | Idle hydration work |\n| `IdleLane` | `0b...1000000000000000000000000` | Idle updates |\n| `OffscreenLane` | `0b...10000000000000000000000000` | Offscreen/prerendering work |\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:40-93]()\n\n## Lane Representation and Bitwise Operations\n\n### Lane Type Definitions\n\n```\ntype Lanes = number;  // Set of lanes (bitwise OR of Lane values)\ntype Lane = number;   // Single lane (power of 2)\n```\n\nLanes use bitwise operations for efficient set manipulation:\n\n```mermaid\ngraph TB\n    subgraph "Lane Operations"\n        A["mergeLanes(a, b)"]\n        B["removeLanes(set, subset)"]\n        C["intersectLanes(a, b)"]\n        D["isSubsetOfLanes(set, subset)"]\n        E["includesSomeLane(a, b)"]\n        F["getHighestPriorityLane(lanes)"]\n    end\n    \n    A -->|"a | b"| OR["Bitwise OR"]\n    B -->|"set & ~subset"| AND_NOT["Bitwise AND NOT"]\n    C -->|"a & b"| AND["Bitwise AND"]\n    D -->|"(set & subset) === subset"| CHECK1["Equality Check"]\n    E -->|"(a & b) !== NoLanes"| CHECK2["Non-zero Check"]\n    F -->|"lanes & -lanes"| ISOLATE["Isolate Rightmost Bit"]\n```\n\n**Diagram: Lane Bitwise Operations**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:145-223]()\n\n### Common Lane Groupings\n\n| Group Name | Lanes Included | Purpose |\n|------------|----------------|---------|\n| `SyncUpdateLanes` | `SyncLane \\| InputContinuousLane \\| DefaultLane` | Synchronous or near-synchronous updates |\n| `UpdateLanes` | All non-hydration, non-offscreen lanes | Normal update work |\n| `NonIdleWork` | All lanes except `IdleLane` and `OffscreenLane` | Work that shouldn\'t be idle |\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:55-56]()\n\n## Lane Assignment Process\n\n### Update Lane Request Flow\n\n```mermaid\ngraph TD\n    Update["Update Triggered"]\n    Update --> CheckContext{"Execution Context?"}\n    \n    CheckContext -->|"RenderContext"| RenderPhase["pickArbitraryLane(workInProgressRootRenderLanes)"]\n    CheckContext -->|"NoContext"| CheckTransition{"In Transition?"}\n    \n    CheckTransition -->|"Yes"| RequestTransition["requestTransitionLane(transition)"]\n    CheckTransition -->|"No"| EventPriority["eventPriorityToLane(resolveUpdatePriority())"]\n    \n    RequestTransition --> ClaimTransition["claimNextTransitionLane()"]\n    ClaimTransition --> AssignedLane["Transition Lane Assigned"]\n    \n    EventPriority --> MapEvent{"Event Priority"}\n    MapEvent -->|"DiscreteEventPriority"| Sync["SyncLane"]\n    MapEvent -->|"ContinuousEventPriority"| Continuous["InputContinuousLane"]\n    MapEvent -->|"DefaultEventPriority"| Default["DefaultLane"]\n    MapEvent -->|"IdleEventPriority"| Idle["IdleLane"]\n    \n    RenderPhase --> AssignedLane\n    Sync --> AssignedLane\n    Continuous --> AssignedLane\n    Default --> AssignedLane\n    Idle --> AssignedLane\n```\n\n**Diagram: Lane Assignment Decision Tree**\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:803-847](), [packages/react-reconciler/src/ReactFiberRootScheduler.js:206-271]()\n\n### Transition Lane Allocation\n\nTransition lanes are allocated cyclically from a pool of 16 lanes:\n\n```mermaid\ngraph LR\n    T["Transition Created"] --> Pool["Transition Lane Pool<br/>(16 lanes)"]\n    Pool --> Claim["claimNextTransitionLane()"]\n    Claim --> Next["nextTransitionLane<br/>(cycling index)"]\n    Next --> Assign["Assign TransitionLane1-16"]\n    Assign --> Increment["Increment nextTransitionLane"]\n    Increment --> Wrap{"Wrapped around?"}\n    Wrap -->|"Yes"| Reset["Reset to TransitionLane1"]\n    Wrap -->|"No"| Pool\n```\n\n**Diagram: Transition Lane Cycling**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:394-439]()\n\n### Retry Lane Allocation\n\nWhen Suspense boundaries suspend, they\'re assigned retry lanes from a pool of 5 lanes:\n\n```\nclaimNextRetryLane(): Lane\n   Checks current lane against retry lane mask\n   Returns next available retry lane\n   Wraps around after lane 5\n```\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:353-385]()\n\n## Lane Selection Algorithm\n\nThe `getNextLanes()` function determines which lanes React should work on next:\n\n```mermaid\ngraph TD\n    Start["getNextLanes(root, wipLanes)"]\n    Start --> CheckPending{"pendingLanes === NoLanes?"}\n    CheckPending -->|"Yes"| ReturnNone["return NoLanes"]\n    CheckPending -->|"No"| MarkExpired["markStarvedLanesAsExpired(root, currentTime)"]\n    \n    MarkExpired --> CheckNonIdle{"includesNonIdleWork(wipLanes)?"}\n    CheckNonIdle -->|"Yes"| NonIdlePath["nonIdlePendingLanes = pendingLanes & ~IdleLanes"]\n    CheckNonIdle -->|"No"| IdlePath["Work from all pendingLanes"]\n    \n    NonIdlePath --> CheckBlocking{"includesBlockingLane()?"}\n    IdlePath --> CheckBlocking\n    \n    CheckBlocking -->|"Yes"| BlockingLanes["return blocking lanes<br/>(SyncUpdateLanes)"]\n    CheckBlocking -->|"No"| CheckExpired{"includesExpiredLane()?"}\n    \n    CheckExpired -->|"Yes"| ExpiredLanes["return expired lanes"]\n    CheckExpired -->|"No"| CheckEntangled{"Check entangled lanes"}\n    \n    CheckEntangled --> FinalLanes["return highest priority lanes"]\n```\n\n**Diagram: Lane Selection Algorithm**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:544-697]()\n\n### Priority Checks\n\nThe selection algorithm uses several helper functions to categorize lanes:\n\n| Function | Purpose |\n|----------|---------|\n| `includesBlockingLane(lanes)` | Checks if lanes include sync or input-continuous work |\n| `includesExpiredLane(root, lanes)` | Checks if any lanes have expired |\n| `includesNonIdleWork(lanes)` | Checks if work is not idle priority |\n| `includesOnlyRetries(lanes)` | Checks if only retry lanes remain |\n| `includesTransitionLane(lanes)` | Checks if transition work is present |\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:225-304]()\n\n## Root Lane Management\n\nEach `FiberRoot` maintains several lane sets to track work state:\n\n```mermaid\ngraph TD\n    subgraph FiberRoot["FiberRoot Lane State"]\n        Pending["pendingLanes<br/>All pending work"]\n        Suspended["suspendedLanes<br/>Work blocked on Suspense"]\n        Pinged["pingedLanes<br/>Suspense resolved"]\n        Expired["expiredLanes<br/>Starved lanes"]\n        Finished["finishedLanes<br/>Just committed"]\n    end\n    \n    Update["New Update"] -->|"markRootUpdated()"| Pending\n    Suspend["Suspends"] -->|"markRootSuspended()"| Suspended\n    Resolve["Promise Resolves"] -->|"markRootPinged()"| Pinged\n    TimeOut["Time Passes"] -->|"markStarvedLanesAsExpired()"| Expired\n    Commit["Commit"] -->|"markRootFinished()"| Finished\n    \n    Pending -.->|"influences"| NextLanes["getNextLanes()"]\n    Suspended -.->|"influences"| NextLanes\n    Pinged -.->|"influences"| NextLanes\n    Expired -.->|"influences"| NextLanes\n```\n\n**Diagram: Root Lane State Management**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:845-1065]()\n\n### Lane State Transitions\n\n```mermaid\nstateDiagram-v2\n    [*] --> Pending: markRootUpdated()\n    Pending --> Rendering: performWorkOnRoot()\n    Rendering --> Suspended: Suspends\n    Rendering --> Committed: Completes\n    Suspended --> Pinged: markRootPinged()\n    Pinged --> Rendering: Retry\n    Suspended --> Expired: Timeout\n    Expired --> Rendering: Force retry\n    Committed --> [*]: markRootFinished()\n```\n\n**Diagram: Lane Lifecycle**\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1116-1400](), [packages/react-reconciler/src/ReactFiberLane.js:845-949]()\n\n## Lane Entanglement\n\nEntanglement forces certain lanes to render together, ensuring consistency:\n\n```mermaid\ngraph TD\n    subgraph "Entanglement Scenarios"\n        A["Update in Transition"]\n        B["Update to Suspense Boundary"]\n        C["Context Provider Update"]\n    end\n    \n    A --> Track["Track entangled lanes<br/>root.entangledLanes"]\n    B --> Track\n    C --> Track\n    \n    Track --> Get["getEntangledLanes(root, renderLanes)"]\n    Get --> Merge["mergeLanes(renderLanes, entangled)"]\n    Merge --> Render["Render all entangled work together"]\n```\n\n**Diagram: Lane Entanglement Process**\n\nWhen an update occurs during a transition that also affects non-transition work, both must complete together to maintain consistency.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:699-787](), [packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:534-553]()\n\n### Entanglement Example\n\n```\nScenario: User in transition, context updates\n  1. Transition lane: TransitionLane1\n  2. Context update schedules: DefaultLane\n  3. Entangle: TransitionLane1 | DefaultLane\n  4. Both lanes render together\n```\n\nSources: [packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:534-553]()\n\n## Expiration and Starvation Prevention\n\nReact prevents starvation by marking lanes as expired after they wait too long:\n\n```mermaid\ngraph LR\n    Check["markStarvedLanesAsExpired()"]\n    Check --> CurrentTime["now()"]\n    CurrentTime --> Compare{"For each pending lane"}\n    \n    Compare --> CheckTime{"expirationTime > 0<br/>&& expirationTime <= currentTime?"}\n    CheckTime -->|"Yes"| MarkExpired["expiredLanes |= lane"]\n    CheckTime -->|"No"| CheckExist{"expirationTime === NoTimestamp?"}\n    \n    CheckExist -->|"Yes"| SetExpire["Set expirationTime =<br/>currentTime + timeout"]\n    CheckExist -->|"No"| Continue["Continue to next lane"]\n    \n    MarkExpired --> Continue\n    SetExpire --> Continue\n```\n\n**Diagram: Expiration Marking Process**\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:789-843]()\n\n### Timeout Values\n\n| Lane Type | Timeout (ms) | Constant |\n|-----------|--------------|----------|\n| Sync lanes | 250 | `syncLaneExpirationMs` |\n| Transition lanes | 5000 | `transitionLaneExpirationMs` |\n| Retry lanes | 5000 | `retryLaneExpirationMs` |\n\nSources: [packages/shared/ReactFeatureFlags.js]() (referenced in [packages/react-reconciler/src/ReactFiberLane.js:22-28]())\n\n## Transitions and Deferred Updates\n\n### Transition Lane Characteristics\n\nTransitions use a dedicated pool of 16 lanes with special properties:\n\n1. **Interruptible**: Can be interrupted by higher-priority updates\n2. **Deferrable**: Use `useDeferredValue` to defer derived values\n3. **Suspense-aware**: Show loading states for longer waits\n4. **Batched**: Multiple transitions can be in flight simultaneously\n\n```mermaid\ngraph TD\n    StartTransition["startTransition(callback)"]\n    StartTransition --> SetTransition["Set ReactSharedInternals.T = {transition object}"]\n    SetTransition --> Callback["Execute callback()"]\n    \n    Callback --> SetState["setState() called"]\n    SetState --> RequestLane["requestUpdateLane(fiber)"]\n    RequestLane --> CheckTransition{"ReactSharedInternals.T !== null?"}\n    CheckTransition -->|"Yes"| ClaimLane["claimNextTransitionLane()"]\n    CheckTransition -->|"No"| EventLane["eventPriorityToLane()"]\n    \n    ClaimLane --> TransitionWork["Schedule as TransitionLane"]\n    EventLane --> NormalWork["Schedule as normal lane"]\n```\n\n**Diagram: Transition Update Flow**\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:824-843](), [packages/react-reconciler/src/ReactFiberRootScheduler.js:206-271]()\n\n### Deferred Lane Allocation\n\nThe `requestDeferredLane()` function allocates lanes for `useDeferredValue`:\n\n```\nrequestDeferredLane(): Lane\n   Check if already allocated: workInProgressDeferredLane\n   If prerendering: return OffscreenLane\n   Otherwise: claimNextTransitionDeferredLane()\n   Mark Suspense boundary with DidDefer flag\n```\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:863-900]()\n\n## Concurrent Rendering and Preemption\n\nThe scheduler checks if work should yield based on lane priority:\n\n```mermaid\ngraph TD\n    Rendering["Rendering fiber tree"]\n    Rendering --> CheckYield{"shouldYield()?"}\n    \n    CheckYield -->|"No"| Continue["Continue rendering"]\n    CheckYield -->|"Yes"| CheckInterrupt{"Higher priority work?"}\n    \n    CheckInterrupt -->|"Yes"| Interrupt["Interrupt render<br/>Return to work loop"]\n    CheckInterrupt -->|"No"| YieldTime["Yield to browser<br/>Resume later"]\n    \n    Continue --> NextUnit["workLoopConcurrent()"]\n    Interrupt --> Schedule["ensureRootIsScheduled()"]\n    YieldTime --> Schedule\n    \n    Schedule --> NextRender["Restart with new lanes"]\n```\n\n**Diagram: Concurrent Rendering Preemption**\n\nWhen higher-priority lanes arrive during a concurrent render, React interrupts the current work and restarts with the higher priority lanes.\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:2210-2276]()\n\n## Event Priority to Lane Mapping\n\nEvents are classified by priority and mapped to lanes:\n\n```mermaid\ngraph LR\n    subgraph Events["Event Types"]\n        Discrete["Discrete<br/>(click, keypress)"]\n        Continuous["Continuous<br/>(drag, scroll)"]\n        Default["Default<br/>(network, timers)"]\n        Idle["Idle<br/>(analytics)"]\n    end\n    \n    subgraph Priorities["Event Priorities"]\n        DiscretePri["DiscreteEventPriority"]\n        ContinuousPri["ContinuousEventPriority"]\n        DefaultPri["DefaultEventPriority"]\n        IdlePri["IdleEventPriority"]\n    end\n    \n    subgraph Lanes["Lanes"]\n        SyncL["SyncLane"]\n        InputL["InputContinuousLane"]\n        DefaultL["DefaultLane"]\n        IdleL["IdleLane"]\n    end\n    \n    Discrete --> DiscretePri\n    Continuous --> ContinuousPri\n    Default --> DefaultPri\n    Idle --> IdlePri\n    \n    DiscretePri --> SyncL\n    ContinuousPri --> InputL\n    DefaultPri --> DefaultL\n    IdlePri --> IdleL\n```\n\n**Diagram: Event to Lane Priority Mapping**\n\nSources: [packages/react-reconciler/src/ReactEventPriorities.js:14-83](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:846]()\n\n## Lane Debugging and Introspection\n\nFor development and profiling, lanes can be converted to human-readable labels:\n\n| Function | Purpose |\n|----------|---------|\n| `getLabelForLane(lane)` | Returns string label like "Sync", "Transition", "Retry" |\n| `getGroupNameOfHighestPriorityLane(lanes)` | Returns priority group: "Blocking", "Transition", "Idle" |\n| `checkIfRootIsPrerendering(root)` | Checks if root is prerendering (OffscreenLane) |\n\nThese functions are used by React DevTools and performance tracking to display which priority level is being worked on.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:1287-1412]()\n\n## Implementation Details\n\n### Key Data Structures\n\n**FiberRoot Lane Fields:**\n```\ntype FiberRoot = {\n  pendingLanes: Lanes,              // All scheduled work\n  suspendedLanes: Lanes,            // Work blocked on Suspense\n  pingedLanes: Lanes,               // Suspense resolved, ready to retry\n  expiredLanes: Lanes,              // Expired (must complete)\n  finishedLanes: Lanes,             // Just committed\n  entangledLanes: Lanes,            // Must render together\n  entanglements: LaneMap<Lanes>,    // Per-lane entanglements\n  expirationTimes: LaneMap<number>, // Expiration timestamps\n  hiddenUpdates: LaneMap<Array<ConcurrentUpdate>>, // Offscreen updates\n  ...\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberRoot.js:87-173]()\n\n### Critical Functions Reference\n\n| Function | Location | Purpose |\n|----------|----------|---------|\n| `getNextLanes()` | [ReactFiberLane.js:544-697]() | Select next lanes to render |\n| `requestUpdateLane()` | [ReactFiberWorkLoop.js:803-847]() | Determine lane for update |\n| `markRootUpdated()` | [ReactFiberLane.js:845-877]() | Mark new work on root |\n| `markRootSuspended()` | [ReactFiberLane.js:879-917]() | Mark lanes as suspended |\n| `markRootPinged()` | [ReactFiberLane.js:919-949]() | Mark suspended lanes ready |\n| `markStarvedLanesAsExpired()` | [ReactFiberLane.js:789-843]() | Expire starved lanes |\n| `includesBlockingLane()` | [ReactFiberLane.js:244-246]() | Check for blocking work |\n| `claimNextTransitionLane()` | [ReactFiberRootScheduler.js:253-271]() | Allocate transition lane |\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:1-1412](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1-3095]()\n\n---\n\n# Page: Suspense and Error Boundaries\n\n# Suspense and Error Boundaries\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberOffscreenComponent.js](packages/react-reconciler/src/ReactFiberOffscreenComponent.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactHooksWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseWithNoopRenderer-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes how React handles asynchronous operations and errors during rendering through two key mechanisms: **Suspense boundaries** and **Error boundaries**. Suspense boundaries enable components to declaratively wait for asynchronous data by catching thrown promises and rendering fallback UI. Error boundaries catch JavaScript errors anywhere in their child component tree and display fallback UI instead of crashing the entire application.\n\nFor information about hydration of server-rendered Suspense boundaries, see [Hydration System](#6.3). For details on how Suspense integrates with Server Components and streaming SSR, see [React Fizz (Streaming SSR)](#5.1).\n\n---\n\n## Overview: Two Boundary Types\n\nReact provides two types of boundaries that interrupt normal rendering flow:\n\n| Boundary Type | Catches | Defined By | Triggers |\n|--------------|---------|------------|----------|\n| **Suspense Boundary** | Thrown promises (async operations) | `<Suspense>` component with `fallback` prop | Components throw promises during render |\n| **Error Boundary** | JavaScript errors | Class components with `componentDidCatch` or `getDerivedStateFromError` | Errors thrown during render, lifecycle methods, or event handlers |\n\nBoth boundaries share similar mechanics for capturing exceptions during render phase and unwinding the fiber tree, but differ in what they catch and how they recover.\n\nSources: [packages/react-reconciler/src/ReactFiberBeginWork.js:1-100](), [packages/react-reconciler/src/ReactFiberClassComponent.js:1-50]()\n\n---\n\n## Suspense Boundaries\n\n### Suspense Component Structure\n\nA Suspense boundary is created using the `<Suspense>` component which accepts `fallback` and `children` props:\n\n```javascript\n<Suspense fallback={<LoadingSpinner />}>\n  <AsyncComponent />\n</Suspense>\n```\n\nInternally, Suspense is represented by the `SuspenseComponent` work tag and maintains state via `SuspenseState`:\n\n```typescript\ntype SuspenseState = {\n  dehydrated: null | SuspenseInstance,  // Non-null if SSR dehydrated\n  retryLane: Lane,                       // Lane to retry rendering\n  treeContext: TreeContext | null,       // Tree context for hydration\n  ...\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberSuspenseComponent.js:24-36](), [packages/react-reconciler/src/ReactWorkTags.js:70]()\n\n### How Suspense Works\n\n```mermaid\ngraph TB\n    Render["Component Render<br/>(beginWork)"]\n    ThrowPromise["Throw Promise<br/>Component suspends"]\n    ThrowException["throwException()<br/>ReactFiberThrow"]\n    FindBoundary["Find Suspense Boundary<br/>Walk up fiber tree"]\n    SetFlags["Set ShouldCapture flag<br/>on boundary fiber"]\n    Unwind["unwindWork()<br/>Pop contexts"]\n    ReRender["Re-render boundary<br/>with fallback"]\n    ShowFallback["Display fallback UI"]\n    PromiseResolve["Promise resolves"]\n    Ping["Ping boundary<br/>scheduleUpdateOnFiber"]\n    RetryRender["Retry with RetryLane<br/>Render children again"]\n    ShowContent["Display content"]\n    \n    Render --> ThrowPromise\n    ThrowPromise --> ThrowException\n    ThrowException --> FindBoundary\n    FindBoundary --> SetFlags\n    SetFlags --> Unwind\n    Unwind --> ReRender\n    ReRender --> ShowFallback\n    ShowFallback --> PromiseResolve\n    PromiseResolve --> Ping\n    Ping --> RetryRender\n    RetryRender --> ShowContent\n```\n\n**Suspense Flow Steps:**\n\n1. **Component Throws Promise**: During render, a component reads async data and throws a promise if data isn\'t ready\n2. **Catch in Work Loop**: The work loop catches the thrown value in `handleThrow` ([packages/react-reconciler/src/ReactFiberWorkLoop.js:1800-1900]())\n3. **throwException**: Identifies what was thrown and finds the nearest Suspense boundary ([packages/react-reconciler/src/ReactFiberThrow.js:1-100]())\n4. **Mark Boundary**: Sets `ShouldCapture` flag on the Suspense boundary fiber ([packages/react-reconciler/src/ReactFiberBeginWork.js:3800-3900]())\n5. **Unwind Stack**: Unwinds the fiber tree via `unwindWork`, popping contexts and checking each fiber for `ShouldCapture` ([packages/react-reconciler/src/ReactFiberUnwindWork.js:156-183]())\n6. **Convert to DidCapture**: When unwinding reaches the Suspense boundary, converts `ShouldCapture` to `DidCapture` flag ([packages/react-reconciler/src/ReactFiberUnwindWork.js:170-180]())\n7. **Re-render with Fallback**: Re-renders the Suspense boundary which now shows fallback instead of children ([packages/react-reconciler/src/ReactFiberBeginWork.js:3800-4000]())\n8. **Attach Listener**: Attaches a ping listener to the thrown promise via `attachPingListener` ([packages/react-reconciler/src/ReactFiberThrow.js:400-500]())\n9. **Promise Resolves**: When the promise resolves, the ping callback triggers `retryDehydratedSuspenseBoundary` or schedules an update\n10. **Retry Render**: Re-renders at a retry lane, attempting to render children again ([packages/react-reconciler/src/ReactFiberWorkLoop.js:2000-2100]())\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1800-2000](), [packages/react-reconciler/src/ReactFiberThrow.js:1-500](), [packages/react-reconciler/src/ReactFiberUnwindWork.js:156-183]()\n\n### Suspense Context and Handler Stack\n\nReact maintains a `SuspenseContext` stack to track which Suspense boundaries are active during rendering:\n\n```mermaid\ngraph TB\n    subgraph "Suspense Context Stack"\n        Root["Root (no handler)"]\n        Outer["Outer Suspense Boundary<br/>pushPrimaryTreeSuspenseHandler"]\n        Inner["Inner Suspense Boundary<br/>pushPrimaryTreeSuspenseHandler"]\n    end\n    \n    GetHandler["getSuspenseHandler()<br/>Returns current boundary"]\n    Component["Component throws promise"]\n    FindBoundary["throwException finds handler<br/>via getSuspenseHandler()"]\n    \n    Root --> Outer\n    Outer --> Inner\n    Inner -.-> GetHandler\n    Component --> FindBoundary\n    FindBoundary -.-> GetHandler\n```\n\nKey functions for managing Suspense context:\n\n- `pushPrimaryTreeSuspenseHandler(workInProgress)` - Pushes a new Suspense boundary onto the stack ([packages/react-reconciler/src/ReactFiberSuspenseContext.js:100-150]())\n- `pushFallbackTreeSuspenseHandler(workInProgress)` - Pushes when rendering fallback tree\n- `popSuspenseHandler(workInProgress)` - Pops the handler when leaving a Suspense boundary\n- `getSuspenseHandler()` - Returns the current innermost Suspense boundary ([packages/react-reconciler/src/ReactFiberSuspenseContext.js:200-250]())\n\nSources: [packages/react-reconciler/src/ReactFiberSuspenseContext.js:1-300](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3700-3800]()\n\n### Retry Mechanism and Lanes\n\nWhen a promise resolves, React needs to retry rendering the suspended tree. This is managed via **retry lanes**:\n\n```mermaid\ngraph LR\n    Suspend["Component Suspends<br/>Shows fallback"]\n    AttachPing["Attach ping listener<br/>to promise"]\n    PromiseResolve["Promise resolves"]\n    PingCallback["pingCallback invoked"]\n    ClaimRetryLane["claimNextRetryLane()<br/>Assigns RetryLane"]\n    ScheduleUpdate["scheduleUpdateOnFiber<br/>with RetryLane"]\n    RenderRoot["performWorkOnRoot<br/>renders at RetryLane"]\n    AttemptRender["Attempt to render<br/>children again"]\n    \n    Suspend --> AttachPing\n    AttachPing --> PromiseResolve\n    PromiseResolve --> PingCallback\n    PingCallback --> ClaimRetryLane\n    ClaimRetryLane --> ScheduleUpdate\n    ScheduleUpdate --> RenderRoot\n    RenderRoot --> AttemptRender\n```\n\n**Key components:**\n\n- `RetryQueue`: Stored on `workInProgress.updateQueue` for Suspense boundaries, contains `Wakeable` (promises) being tracked ([packages/react-reconciler/src/ReactFiberSuspenseComponent.js:100-120]())\n- `claimNextRetryLane()`: Assigns a specific retry lane from the `RetryLanes` bitmask ([packages/react-reconciler/src/ReactFiberLane.js:850-900]())\n- `attachPingListener()`: Attaches callback to promise that will schedule an update when resolved ([packages/react-reconciler/src/ReactFiberThrow.js:400-500]())\n- `retryDehydratedSuspenseBoundary()`: Schedules a retry for dehydrated boundaries ([packages/react-reconciler/src/ReactFiberWorkLoop.js:1200-1300]())\n\nSources: [packages/react-reconciler/src/ReactFiberSuspenseComponent.js:100-150](), [packages/react-reconciler/src/ReactFiberLane.js:850-900](), [packages/react-reconciler/src/ReactFiberThrow.js:400-500]()\n\n### Suspended Reasons\n\nThe work loop tracks why rendering is suspended via `workInProgressSuspendedReason`:\n\n| Reason | Value | Description |\n|--------|-------|-------------|\n| `NotSuspended` | 0 | Not currently suspended |\n| `SuspendedOnError` | 1 | Suspended due to an error |\n| `SuspendedOnData` | 2 | Suspended waiting for data (promise) |\n| `SuspendedOnImmediate` | 3 | Suspended on immediate priority |\n| `SuspendedOnInstance` | 4 | Suspended on resource instance |\n| `SuspendedOnInstanceAndReadyToContinue` | 5 | Instance ready, can continue |\n| `SuspendedOnDeprecatedThrowPromise` | 6 | Legacy throw promise |\n| `SuspendedAndReadyToContinue` | 7 | Suspended but ready to continue |\n| `SuspendedOnHydration` | 8 | Suspended during hydration |\n| `SuspendedOnAction` | 9 | Suspended on async action |\n\nThese reasons determine how the work loop handles the suspension and whether to unwind immediately or continue.\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:431-441]()\n\n---\n\n## Error Boundaries\n\n### Defining Error Boundaries\n\nError boundaries are class components that implement one or both of these lifecycle methods:\n\n```javascript\nclass ErrorBoundary extends React.Component {\n  static getDerivedStateFromError(error) {\n    // Update state to show fallback UI\n    return { hasError: true };\n  }\n\n  componentDidCatch(error, errorInfo) {\n    // Log error to error reporting service\n    logErrorToService(error, errorInfo);\n  }\n\n  render() {\n    if (this.state.hasError) {\n      return <h1>Something went wrong.</h1>;\n    }\n    return this.props.children;\n  }\n}\n```\n\n**Key characteristics:**\n- Must be class components (function components cannot be error boundaries)\n- `getDerivedStateFromError`: Static method called during render phase to update state\n- `componentDidCatch`: Instance method called during commit phase for side effects\n- Only catches errors in child components, not in the boundary itself\n\nSources: [packages/react-reconciler/src/ReactFiberClassComponent.js:1-100]()\n\n### Error Capture Flow\n\n```mermaid\ngraph TB\n    Render["Component Render"]\n    ThrowError["Error thrown"]\n    Catch["Work loop catches error<br/>handleThrow()"]\n    ThrowException["throwException()<br/>Classify error"]\n    WalkTree["Walk up fiber tree<br/>Find error boundary"]\n    FindBoundary{"Class with error<br/>lifecycle methods?"}\n    CreateUpdate["createClassErrorUpdate()<br/>Create error update"]\n    SetFlags["Set ShouldCapture flag<br/>on boundary"]\n    Unwind["unwindWork()<br/>Unwind to boundary"]\n    ConvertFlag["Convert ShouldCapture<br/>to DidCapture"]\n    ApplyUpdate["Process update queue<br/>Call getDerivedStateFromError"]\n    ReRender["Re-render boundary<br/>Shows fallback UI"]\n    CommitPhase["Commit phase"]\n    CallDidCatch["Call componentDidCatch<br/>with error info"]\n    \n    Render --> ThrowError\n    ThrowError --> Catch\n    Catch --> ThrowException\n    ThrowException --> WalkTree\n    WalkTree --> FindBoundary\n    FindBoundary -->|Yes| CreateUpdate\n    FindBoundary -->|No| WalkTree\n    CreateUpdate --> SetFlags\n    SetFlags --> Unwind\n    Unwind --> ConvertFlag\n    ConvertFlag --> ApplyUpdate\n    ApplyUpdate --> ReRender\n    ReRender --> CommitPhase\n    CommitPhase --> CallDidCatch\n```\n\n**Error Boundary Flow:**\n\n1. **Error Occurs**: An error is thrown during render, lifecycle method, or event handler\n2. **Catch in Work Loop**: The work loop catches the error in `handleThrow` ([packages/react-reconciler/src/ReactFiberWorkLoop.js:1800-1900]())\n3. **throwException**: Examines the error and walks up the fiber tree to find an error boundary ([packages/react-reconciler/src/ReactFiberThrow.js:200-400]())\n4. **Identify Boundary**: Looks for class components with `getDerivedStateFromError` or `componentDidCatch` ([packages/react-reconciler/src/ReactFiberThrow.js:250-350]())\n5. **Create Error Update**: Calls `createClassErrorUpdate` to create an update on the boundary\'s queue ([packages/react-reconciler/src/ReactFiberThrow.js:300-350]())\n6. **Set ShouldCapture**: Marks the error boundary fiber with `ShouldCapture` flag\n7. **Unwind**: Unwinds the stack via `unwindWork`, checking each fiber for `ShouldCapture` ([packages/react-reconciler/src/ReactFiberUnwindWork.js:77-93]())\n8. **Convert to DidCapture**: When unwinding reaches the error boundary, converts `ShouldCapture` to `DidCapture` ([packages/react-reconciler/src/ReactFiberUnwindWork.js:83-91]())\n9. **Process Update**: During re-render, processes the error update and calls `getDerivedStateFromError` ([packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:200-300]())\n10. **Render Fallback**: Re-renders the boundary with updated state showing fallback UI\n11. **Commit Phase**: During commit, calls `componentDidCatch` with error and error info ([packages/react-reconciler/src/ReactFiberCommitWork.js:1000-1100]())\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1800-1900](), [packages/react-reconciler/src/ReactFiberThrow.js:200-400](), [packages/react-reconciler/src/ReactFiberUnwindWork.js:77-93]()\n\n### Error Boundary Detection\n\nError boundaries are identified by checking for specific static and instance methods:\n\n```mermaid\ngraph LR\n    Fiber["Class Component Fiber"]\n    CheckType["Check ctor.getDerivedStateFromError"]\n    CheckInstance["Check instance.componentDidCatch"]\n    IsErrorBoundary{"Has error<br/>lifecycle?"}\n    Capture["Can capture errors"]\n    Skip["Skip, not error boundary"]\n    \n    Fiber --> CheckType\n    CheckType --> IsErrorBoundary\n    CheckInstance --> IsErrorBoundary\n    IsErrorBoundary -->|Yes| Capture\n    IsErrorBoundary -->|No| Skip\n```\n\nCode logic in `throwException`:\n\n```javascript\n// Check if this is a class component error boundary\nif (\n  sourceFiber.tag === ClassComponent &&\n  (ctor.getDerivedStateFromError !== undefined ||\n   (instance !== null && \n    typeof instance.componentDidCatch === \'function\'))\n) {\n  // This is an error boundary\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberThrow.js:250-350]()\n\n---\n\n## Throwing and Capturing Mechanism\n\n### throwException Function\n\nThe `throwException` function in `ReactFiberThrow.js` is the central dispatcher that handles both promises (Suspense) and errors (Error Boundaries):\n\n```mermaid\ngraph TB\n    ThrowException["throwException(root, returnFiber, sourceFiber, value)"]\n    CheckValue{"Check value type"}\n    IsPromise["Is Wakeable/Promise?"]\n    IsError["Is Error?"]\n    IsSuspenseException["Is SuspenseException?"]\n    HandleSuspense["Handle Suspense<br/>Find Suspense boundary<br/>Attach ping listener"]\n    HandleError["Handle Error<br/>Find Error boundary<br/>Create error update"]\n    HandleSpecial["Handle SuspenseException<br/>Special suspension handling"]\n    SetFlags["Set ShouldCapture flags<br/>on boundaries"]\n    \n    ThrowException --> CheckValue\n    CheckValue --> IsPromise\n    CheckValue --> IsError\n    CheckValue --> IsSuspenseException\n    IsPromise --> HandleSuspense\n    IsError --> HandleError\n    IsSuspenseException --> HandleSpecial\n    HandleSuspense --> SetFlags\n    HandleError --> SetFlags\n    HandleSpecial --> SetFlags\n```\n\n**Key responsibilities:**\n\n1. **Type Detection**: Determines whether the thrown value is a promise, error, or special exception type\n2. **Boundary Search**: Walks up the fiber tree from `sourceFiber` to find appropriate boundary\n3. **Flag Setting**: Marks boundaries with `ShouldCapture` flag to trigger unwinding\n4. **Listener Attachment**: For promises, attaches ping listeners for retry when resolved\n5. **Update Creation**: For errors, creates updates on error boundary components\n\nSources: [packages/react-reconciler/src/ReactFiberThrow.js:1-600]()\n\n### Fiber Flags for Capture\n\nReact uses specific flags to coordinate the capture and unwinding process:\n\n| Flag | Value | Description |\n|------|-------|-------------|\n| `ShouldCapture` | Bit flag | Marks that a fiber should capture an error/suspense |\n| `DidCapture` | Bit flag | Marks that a fiber has captured and is showing fallback |\n| `ForceClientRender` | Bit flag | Forces client-side render (hydration failure) |\n\n**Flag transitions during unwinding:**\n\n```mermaid\nstateDiagram-v2\n    [*] --> NoFlags: Normal render\n    NoFlags --> ShouldCapture: Error/Suspense thrown\n    ShouldCapture --> DidCapture: Unwinding reaches boundary\n    DidCapture --> NoFlags: Retry/recovery\n    ShouldCapture --> NoFlags: Unwinding complete (no capture)\n```\n\nThe `unwindWork` function checks and transforms these flags:\n\n```javascript\nconst flags = workInProgress.flags;\nif (flags & ShouldCapture) {\n  workInProgress.flags = (flags & ~ShouldCapture) | DidCapture;\n  // Return this fiber to re-render with fallback\n  return workInProgress;\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberFlags.js:1-200](), [packages/react-reconciler/src/ReactFiberUnwindWork.js:66-200]()\n\n### Unwinding the Fiber Tree\n\nWhen an error or promise is caught, React must unwind the fiber tree to the nearest boundary. The `unwindWork` function handles this:\n\n```mermaid\ngraph TB\n    ThrowCaught["Exception caught in work loop"]\n    StartUnwind["Begin unwinding"]\n    CheckFiber["Process current fiber<br/>unwindWork()"]\n    PopContexts["Pop contexts<br/>(Host, Suspense, etc.)"]\n    CheckFlags{"Has ShouldCapture<br/>flag?"}\n    ConvertFlags["Convert to DidCapture<br/>Return fiber"]\n    MoveUp["Move to parent fiber<br/>workInProgress.return"]\n    ReachedRoot{"Reached root?"}\n    HandleRootError["Handle uncaught error<br/>at root level"]\n    ReRenderBoundary["Re-render boundary<br/>with fallback"]\n    \n    ThrowCaught --> StartUnwind\n    StartUnwind --> CheckFiber\n    CheckFiber --> PopContexts\n    PopContexts --> CheckFlags\n    CheckFlags -->|Yes| ConvertFlags\n    CheckFlags -->|No| MoveUp\n    ConvertFlags --> ReRenderBoundary\n    MoveUp --> ReachedRoot\n    ReachedRoot -->|No| CheckFiber\n    ReachedRoot -->|Yes| HandleRootError\n```\n\nKey operations during unwinding:\n\n1. **Pop Contexts**: Each fiber type pops its associated contexts (host context, suspense context, cache context, etc.)\n2. **Check Capture Flag**: Examines whether `ShouldCapture` flag is set\n3. **Transform Flag**: Converts `ShouldCapture` to `DidCapture` for boundaries that will handle the exception\n4. **Transfer Duration**: For profiling, transfers actual duration to parent if in profile mode\n5. **Return Fiber**: Returns the boundary fiber to re-render, or null to continue unwinding\n\nThe `unwindWork` function is called for each fiber type during unwinding:\n\n- **ClassComponent**: Pops legacy context if context provider ([packages/react-reconciler/src/ReactFiberUnwindWork.js:77-93]())\n- **HostRoot**: Pops all root-level contexts ([packages/react-reconciler/src/ReactFiberUnwindWork.js:95-118]())\n- **SuspenseComponent**: Pops suspense handler and checks for dehydrated boundaries ([packages/react-reconciler/src/ReactFiberUnwindWork.js:156-183]())\n- **SuspenseListComponent**: Pops suspense list context ([packages/react-reconciler/src/ReactFiberUnwindWork.js:184-194]())\n\nSources: [packages/react-reconciler/src/ReactFiberUnwindWork.js:66-250]()\n\n---\n\n## Integration with Work Loop\n\n### Handling Throws in performWorkOnRoot\n\nThe main work loop integrates error and suspense handling via `handleThrow`:\n\n```mermaid\ngraph TB\n    PerformWork["performWorkOnRoot(root, lanes)"]\n    PrepareFresh["prepareFreshStack(root, lanes)"]\n    WorkLoop["workLoopSync() or<br/>workLoopConcurrent()"]\n    BeginWork["beginWork(current, workInProgress, lanes)"]\n    ThrowOccurs["Exception thrown"]\n    CatchBlock["try/catch block"]\n    HandleThrow["handleThrow(root, thrownValue)"]\n    ClassifyError["Classify thrown value<br/>Error vs Promise vs Special"]\n    ThrowException["throwException(root, returnFiber,<br/>sourceFiber, thrownValue)"]\n    UnwindLoop["Start unwinding loop"]\n    CompleteUnitOfWork["completeUnitOfWork() or<br/>continue work loop"]\n    \n    PerformWork --> PrepareFresh\n    PrepareFresh --> WorkLoop\n    WorkLoop --> BeginWork\n    BeginWork --> ThrowOccurs\n    ThrowOccurs --> CatchBlock\n    CatchBlock --> HandleThrow\n    HandleThrow --> ClassifyError\n    ClassifyError --> ThrowException\n    ThrowException --> UnwindLoop\n    UnwindLoop --> CompleteUnitOfWork\n```\n\nThe work loop wraps rendering in try/catch:\n\n```javascript\ndo {\n  try {\n    workLoopSync(); // or workLoopConcurrent()\n    break;\n  } catch (thrownValue) {\n    handleThrow(root, thrownValue);\n  }\n} while (true);\n```\n\nThe `handleThrow` function:\n\n1. Sets `workInProgressSuspendedReason` based on thrown value type\n2. Stores `workInProgressThrownValue` for later processing\n3. Calls `throwException` to find and mark boundaries\n4. Initiates the unwinding process\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:1700-2000]()\n\n### Retry and Ping Mechanism\n\nWhen a suspended boundary is ready to retry (promise resolved), React uses the ping mechanism:\n\n```mermaid\nsequenceDiagram\n    participant C as Component\n    participant P as Promise\n    participant L as Ping Listener\n    participant S as Scheduler\n    participant WL as Work Loop\n    participant B as Suspense Boundary\n    \n    C->>P: Throw promise\n    WL->>P: Attach ping listener\n    Note over P,L: attachPingListener(root, wakeable, lanes)\n    P->>P: Promise resolves\n    P->>L: Call ping callback\n    L->>S: scheduleUpdateOnFiber(root, fiber, lane)\n    S->>WL: Schedule work at RetryLane\n    WL->>B: Re-render boundary\n    B->>C: Retry rendering component\n    C->>C: Data available, render succeeds\n```\n\n**Ping callback implementation:**\n\n```javascript\nfunction attachPingListener(root, wakeable, lanes) {\n  let pingCache = root.pingCache;\n  let threadIDs;\n  if (pingCache === null) {\n    pingCache = root.pingCache = new PossiblyWeakMap();\n    threadIDs = new Set();\n    pingCache.set(wakeable, threadIDs);\n  } else {\n    threadIDs = pingCache.get(wakeable);\n    if (threadIDs === undefined) {\n      threadIDs = new Set();\n      pingCache.set(wakeable, threadIDs);\n    }\n  }\n  \n  if (!threadIDs.has(lanes)) {\n    threadIDs.add(lanes);\n    let ping = pingSuspendedRoot.bind(null, root, wakeable, lanes);\n    wakeable.then(ping, ping);\n  }\n}\n```\n\nThe `pingSuspendedRoot` callback schedules an update at the retry lane, triggering a re-render of the suspended tree.\n\nSources: [packages/react-reconciler/src/ReactFiberThrow.js:400-500](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:1000-1100]()\n\n---\n\n## Dehydrated Suspense Boundaries\n\nDuring Server-Side Rendering (SSR), Suspense boundaries can be rendered in a "dehydrated" state where the server sends placeholder markers instead of waiting for all async data. The client then "hydrates" these boundaries by matching them with real DOM nodes.\n\n### Dehydrated State Structure\n\n```mermaid\ngraph TB\n    subgraph "Server-Rendered HTML"\n        Comment1["<!-- $? --> Start marker"]\n        Fallback["Fallback UI (initially hidden)"]\n        Comment2["<!-- /$? --> End marker"]\n    end\n    \n    subgraph "SuspenseState"\n        Dehydrated["dehydrated: SuspenseInstance"]\n        RetryLane["retryLane: Lane"]\n        TreeContext["treeContext: TreeContext"]\n    end\n    \n    Comment1 -.-> Dehydrated\n    Comment2 -.-> Dehydrated\n    Dehydrated --> RetryLane\n    Dehydrated --> TreeContext\n```\n\n**Key functions for dehydrated boundaries:**\n\n- `isSuspenseInstancePending(instance)`: Checks if dehydrated boundary is still waiting\n- `isSuspenseInstanceFallback(instance)`: Checks if showing fallback\n- `reenterHydrationStateFromDehydratedSuspenseInstance()`: Re-enters hydration mode for dehydrated content ([packages/react-reconciler/src/ReactFiberHydrationContext.js:400-500]())\n\nDuring hydration, when React encounters a dehydrated Suspense boundary:\n\n1. **Detect Marker**: Identifies the `<!-- $? -->` comment marker in the DOM\n2. **Store Instance**: Stores the `SuspenseInstance` in `SuspenseState.dehydrated`\n3. **Skip Children**: Skips hydrating children initially (they\'re not yet in the DOM)\n4. **Wait for Data**: Waits for server to stream the actual content\n5. **Hydrate on Arrival**: When content arrives, hydrates the real DOM nodes\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:1-500](), [packages/react-reconciler/src/ReactFiberBeginWork.js:3900-4100]()\n\n---\n\n## Error Boundary Lifecycle Methods\n\n### getDerivedStateFromError\n\nStatic method called during the render phase to update state in response to an error:\n\n```javascript\nstatic getDerivedStateFromError(error: Error): PartialState {\n  return { hasError: true, error };\n}\n```\n\n**Characteristics:**\n- Called during render phase (can be called multiple times)\n- Must be pure and have no side effects\n- Returns state update or null\n- Called before `componentDidCatch`\n\n**Processing in update queue:**\n\nWhen an error is caught, React creates an error update with tag `CaptureUpdate`:\n\n```javascript\nfunction createClassErrorUpdate(fiber, errorInfo, lane) {\n  const update = createUpdate(lane);\n  update.tag = CaptureUpdate;\n  update.payload = {element: null};\n  \n  const error = errorInfo.value;\n  update.callback = function() {\n    // This will be called after getDerivedStateFromError\n    onUncaughtError(error);\n  };\n  return update;\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberThrow.js:100-200](), [packages/react-reconciler/src/ReactFiberClassUpdateQueue.js:100-200]()\n\n### componentDidCatch\n\nInstance method called during the commit phase for side effects:\n\n```javascript\ncomponentDidCatch(error: Error, errorInfo: {componentStack: string}) {\n  // Side effects like logging\n  logErrorToMyService(error, errorInfo);\n}\n```\n\n**Characteristics:**\n- Called during commit phase (effects phase)\n- Can have side effects (logging, analytics, etc.)\n- Receives error and errorInfo with component stack\n- Called after render is committed\n- Not called if boundary is unmounting\n\n**Invocation during commit:**\n\n```javascript\nfunction commitClassLifecycles(finishedWork, current) {\n  const instance = finishedWork.stateNode;\n  if (finishedWork.flags & DidCapture) {\n    // Error was caught, call componentDidCatch\n    if (typeof instance.componentDidCatch === \'function\') {\n      const error = /* error from update queue */;\n      const errorInfo = createCapturedValueFromError(error);\n      instance.componentDidCatch(error, errorInfo);\n    }\n  }\n}\n```\n\nSources: [packages/react-reconciler/src/ReactFiberCommitWork.js:800-1000](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:200-400]()\n\n---\n\n## Advanced: Multiple Nested Boundaries\n\nReact can have multiple nested Suspense boundaries and error boundaries, each catching exceptions at different levels:\n\n```mermaid\ngraph TB\n    Root["Root"]\n    ErrorBoundary["Error Boundary"]\n    OuterSuspense["Outer Suspense"]\n    InnerSuspense["Inner Suspense"]\n    Component["Component"]\n    \n    Root --> ErrorBoundary\n    ErrorBoundary --> OuterSuspense\n    OuterSuspense --> InnerSuspense\n    InnerSuspense --> Component\n    \n    Component -.->|Throws promise| InnerSuspense\n    Component -.->|Throws error| ErrorBoundary\n    InnerSuspense -.->|If suspends| OuterSuspense\n```\n\n**Boundary selection rules:**\n\n1. **Innermost First**: Always captures at the nearest boundary\n2. **Type Matters**: Suspense catches promises, Error Boundaries catch errors\n3. **Fallback Hiding**: Outer boundaries can hide inner boundaries\' fallback if outer also suspends\n4. **Throttling**: React throttles showing multiple fallbacks to avoid UI flickering ([packages/react-reconciler/src/ReactFiberWorkLoop.js:500-520]())\n\n### Suspense List Coordination\n\n`<SuspenseList>` coordinates the reveal order of multiple Suspense boundaries:\n\n```javascript\n<SuspenseList revealOrder="forwards">\n  <Suspense fallback={<Spinner />}>\n    <Item1 />\n  </Suspense>\n  <Suspense fallback={<Spinner />}>\n    <Item2 />\n  </Suspense>\n  <Suspense fallback={<Spinner />}>\n    <Item3 />\n  </Suspense>\n</SuspenseList>\n```\n\nThe `SuspenseListComponent` maintains `SuspenseListRenderState` to track which children are suspended and control reveal order.\n\nSources: [packages/react-reconciler/src/ReactFiberSuspenseComponent.js:150-250](), [packages/react-reconciler/src/ReactFiberBeginWork.js:4100-4300]()\n\n---\n\n## Performance Considerations\n\n### Fallback Throttling\n\nTo prevent UI flickering from rapid fallback showing/hiding, React implements throttling:\n\n```javascript\nconst FALLBACK_THROTTLE_MS = 300;\n```\n\nIf a Suspense boundary suspends, React waits 300ms before showing the fallback, hoping the promise will resolve quickly.\n\nSources: [packages/react-reconciler/src/ReactFiberWorkLoop.js:514]()\n\n### Retry Lane Priority\n\nRetry lanes are lower priority than user-blocking updates but higher than idle work:\n\n```javascript\nconst RetryLanes = 0b0000011110000000000000000000000;\n```\n\nThis ensures retries happen promptly but don\'t block urgent user interactions.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:93-99]()\n\n### Error Boundary Re-render Optimization\n\nAfter catching an error, React skips rendering the error boundary\'s children and goes straight to the fallback, avoiding wasted work.\n\nSources: [packages/react-reconciler/src/ReactFiberBeginWork.js:1200-1300]()\n\n---\n\n# Page: Host Configuration Abstraction\n\n# Host Configuration Abstraction\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n\n</details>\n\n\n\nThe Host Configuration abstraction is React\'s platform adaptation layer that enables the reconciler to target different rendering environments (DOM, React Native, canvas, terminal, etc.) through a consistent interface. Each renderer implements a host config that translates React\'s universal operations into platform-specific actions.\n\nFor information about the reconciler\'s work loop and rendering phases, see [4.2](#4.2). For platform-specific implementations like React DOM and hydration, see [6.1](#6.1) and [6.3](#6.3).\n\n## Host Config Interface\n\nThe host config defines a contract between the reconciler and the host platform. Renderers provide implementations by passing a configuration object to `react-reconciler` which acts as a factory function wrapping the reconciler code.\n\n### Core Configuration Structure\n\n```mermaid\ngraph TB\n    Reconciler["react-reconciler<br/>(ReactFiberWorkLoop)"]\n    CustomConfig["ReactFiberConfig.custom.js<br/>Interface Definition"]\n    \n    subgraph "Platform Implementations"\n        DOMConfig["ReactFiberConfigDOM.js<br/>DOM Renderer"]\n        FabricConfig["ReactFiberConfigFabric.js<br/>RN Fabric"]\n        NativeConfig["ReactFiberConfigNative.js<br/>RN Legacy"]\n        NoopConfig["createReactNoop.js<br/>Test Renderer"]\n        TestConfig["ReactFiberConfigTestHost.js<br/>Test Renderer"]\n        ARTConfig["ReactFiberConfigART.js<br/>ART Renderer"]\n    end\n    \n    Reconciler -->|"uses via $$$config"| CustomConfig\n    CustomConfig -.->|"implemented by"| DOMConfig\n    CustomConfig -.->|"implemented by"| FabricConfig\n    CustomConfig -.->|"implemented by"| NativeConfig\n    CustomConfig -.->|"implemented by"| NoopConfig\n    CustomConfig -.->|"implemented by"| TestConfig\n    CustomConfig -.->|"implemented by"| ARTConfig\n```\n\n**Diagram: Host Config Architecture**\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:1-287](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-150](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-82]()\n\n### Essential Host Config Methods\n\nThe host config interface consists of over 100 methods, organized into several categories:\n\n| Category | Required | Example Methods | Purpose |\n|----------|----------|----------------|---------|\n| **Metadata** | Yes | `rendererVersion`, `rendererPackageName`, `isPrimaryRenderer` | Identify the renderer |\n| **Instance Creation** | Yes | `createInstance`, `createTextInstance`, `appendInitialChild` | Build host trees during render |\n| **Context Management** | Yes | `getRootHostContext`, `getChildHostContext` | Track rendering context (e.g., namespace) |\n| **Finalization** | Yes | `finalizeInitialChildren`, `shouldSetTextContent` | Complete initial setup |\n| **Commit Preparation** | Yes | `prepareForCommit`, `resetAfterCommit` | Bracket commit phase |\n| **Public Instance** | Yes | `getPublicInstance` | Expose instances through refs |\n| **Scheduling** | Yes | `scheduleTimeout`, `cancelTimeout`, `now` | Time-based operations |\n| **Priority Management** | Yes | `setCurrentUpdatePriority`, `getCurrentUpdatePriority`, `resolveUpdatePriority` | Manage event priorities |\n| **Mutation** | Optional | `appendChild`, `removeChild`, `commitUpdate`, `commitTextUpdate` | Mutate existing trees |\n| **Persistence** | Optional | `cloneInstance`, `replaceContainerChildren` | Replace trees immutably |\n| **Hydration** | Optional | `canHydrateInstance`, `hydrateInstance`, `getNextHydratableSibling` | Match server-rendered markup |\n| **Resources** | Optional | `supportsResources`, `acquireResource`, `releaseResource` | Manage hoistable resources |\n| **Singletons** | Optional | `supportsSingletons`, `acquireSingletonInstance` | Manage singleton elements |\n| **View Transitions** | Optional | `startViewTransition`, `measureInstance` | Animate state transitions |\n| **Suspense Commit** | Optional | `maySuspendCommit`, `waitForCommitToBeReady` | Delay commits for loading |\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:52-287]()\n\n### Host Config Method Signatures\n\n```mermaid\ngraph LR\n    subgraph "Render Phase"\n        CreateInstance["createInstance()<br/>type, props, rootContainer,<br/>hostContext, handle"]\n        CreateText["createTextInstance()<br/>text, rootContainer,<br/>hostContext, handle"]\n        AppendInitial["appendInitialChild()<br/>parent, child"]\n        Finalize["finalizeInitialChildren()<br/>instance, type, props"]\n    end\n    \n    subgraph "Commit Phase - Mutation"\n        AppendChild["appendChild()<br/>parent, child"]\n        RemoveChild["removeChild()<br/>parent, child"]\n        CommitUpdate["commitUpdate()<br/>instance, type,<br/>oldProps, newProps"]\n        CommitText["commitTextUpdate()<br/>textInstance,<br/>oldText, newText"]\n    end\n    \n    subgraph "Commit Phase - Persistence"\n        CloneInstance["cloneInstance()<br/>instance, type,<br/>oldProps, newProps,<br/>keepChildren, newChildren"]\n        ReplaceChildren["replaceContainerChildren()<br/>container, newChildren"]\n    end\n    \n    CreateInstance --> AppendInitial\n    CreateText --> AppendInitial\n    AppendInitial --> Finalize\n    Finalize -.->|"mutation"| AppendChild\n    Finalize -.->|"persistence"| CloneInstance\n```\n\n**Diagram: Key Host Config Method Flow**\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:61-189]()\n\n## Mutation vs Persistence Modes\n\nReact\'s reconciler supports two modes for applying updates, chosen at compile time through the host config:\n\n### Mutation Mode\n\n**Mode Identifier**: `supportsMutation = true`, `supportsPersistence = false`\n\nIn mutation mode, the reconciler directly modifies existing host instances. This is more memory-efficient but requires the host platform to support in-place updates.\n\n**Required Methods**:\n- `appendChild(parentInstance, child)` - Add child to parent\n- `removeChild(parentInstance, child)` - Remove child from parent\n- `insertBefore(parentInstance, child, beforeChild)` - Insert at position\n- `commitUpdate(instance, type, oldProps, newProps)` - Update instance properties\n- `commitTextUpdate(textInstance, oldText, newText)` - Update text content\n- `resetTextContent(instance)` - Clear text content\n- `hideInstance(instance)` / `unhideInstance(instance, props)` - Toggle visibility\n\n**Example Implementation (DOM)**:\n\n```mermaid\ngraph TB\n    Reconciler["Reconciler detects update"]\n    CommitUpdate["commitUpdate() called"]\n    UpdateProps["updateProperties()<br/>diff oldProps vs newProps"]\n    UpdateDOM["Apply changes to DOM node"]\n    UpdateFiberProps["updateFiberProps()<br/>cache on DOM node"]\n    \n    Reconciler --> CommitUpdate\n    CommitUpdate --> UpdateProps\n    UpdateProps --> UpdateDOM\n    CommitUpdate --> UpdateFiberProps\n```\n\n**Diagram: DOM Mutation Mode Flow**\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:940-953](), [packages/react-dom-bindings/src/client/ReactDOMComponent.js:78-82]()\n\n### Persistence Mode\n\n**Mode Identifier**: `supportsMutation = false`, `supportsPersistence = true`\n\nIn persistence mode, the reconciler creates new clones of instances that need updates, building a new tree structure. This enables features like time-travel debugging and structural sharing.\n\n**Required Methods**:\n- `cloneInstance(instance, type, oldProps, newProps, keepChildren, newChildren)` - Clone with updates\n- `createContainerChildSet()` - Create new child collection\n- `appendChildToContainerChildSet(childSet, child)` - Add to collection\n- `finalizeContainerChildren(container, newChildren)` - Prepare for replacement\n- `replaceContainerChildren(container, newChildren)` - Atomic swap\n- `cloneHiddenInstance(instance, type, props)` - Clone as hidden\n- `cloneHiddenTextInstance(instance, text)` - Clone text as hidden\n\n**Example Implementation (React Native Fabric)**:\n\n```mermaid\ngraph TB\n    Reconciler["Reconciler detects update"]\n    CloneInstance["cloneInstance() called"]\n    DiffProps["diffAttributePayloads()<br/>compute property changes"]\n    CloneNode["cloneNodeWithNewProps()<br/>native clone operation"]\n    ShareCanonical["Share canonical object<br/>with original instance"]\n    \n    Reconciler --> CloneInstance\n    CloneInstance --> DiffProps\n    DiffProps --> CloneNode\n    CloneInstance --> ShareCanonical\n```\n\n**Diagram: Fabric Persistence Mode Flow**\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:451-504]()\n\n### Mode Comparison\n\n| Aspect | Mutation Mode | Persistence Mode |\n|--------|---------------|------------------|\n| **Memory** | Lower (reuses instances) | Higher (creates clones) |\n| **Complexity** | Higher (manage mutations) | Lower (immutable trees) |\n| **Debugging** | Harder (state changes) | Easier (tree snapshots) |\n| **Platform Fit** | DOM, legacy systems | React Native Fabric, immutable backends |\n| **Update Mechanism** | In-place modification | Clone and replace |\n| **Instance Lifetime** | Long-lived | Short-lived per update |\n\nSources: [packages/react-reconciler/src/ReactFiberConfigWithNoPersistence.js:1-62](), [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js:1-62]()\n\n## Fork Resolution System\n\nReact uses a build-time fork system to select the appropriate host config implementation without runtime overhead. The reconciler imports from `react-reconciler/src/ReactFiberConfig` which is resolved to different files based on the target renderer.\n\n### Fork Resolution Mechanism\n\n```mermaid\ngraph TB\n    Source["reconciler imports<br/>\'./ReactFiberConfig\'"]\n    BuildSystem["Rollup Build System<br/>(scripts/rollup/build.js)"]\n    ForksConfig["forks.js configuration"]\n    \n    subgraph "Fork Targets"\n        DOMFork["ReactFiberConfigDOM.js"]\n        FabricFork["ReactFiberConfigFabric.js"]\n        NativeFork["ReactFiberConfigNative.js"]\n        CustomFork["ReactFiberConfig.custom.js"]\n    end\n    \n    Source --> BuildSystem\n    BuildSystem --> ForksConfig\n    ForksConfig -.->|"react-dom bundle"| DOMFork\n    ForksConfig -.->|"react-native-renderer<br/>(fabric)"| FabricFork\n    ForksConfig -.->|"react-native-renderer<br/>(legacy)"| NativeFork\n    ForksConfig -.->|"react-reconciler npm"| CustomFork\n```\n\n**Diagram: Build-Time Fork Resolution**\n\nThe fork configuration in `scripts/rollup/forks.js` maps bundle types to specific host config files:\n\n```\n\'react-reconciler/src/ReactFiberConfig\': {\n  \'react-dom\': \'react-dom-bindings/src/client/ReactFiberConfigDOM\',\n  \'react-native-renderer\': \'react-native-renderer/src/ReactFiberConfigNative\',\n  \'react-native-renderer/fabric\': \'react-native-renderer/src/ReactFiberConfigFabric\',\n  \'react-test-renderer\': \'react-test-renderer/src/ReactFiberConfigTestHost\',\n  \'react-art\': \'react-art/src/ReactFiberConfigART\',\n  \'react-reconciler\': \'react-reconciler/src/forks/ReactFiberConfig.custom\'\n}\n```\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:10-24](), build system configuration (inferred from imports)\n\n### Custom Renderer Pattern\n\nThe `react-reconciler` npm package enables third-party renderers by exporting a factory function. The custom host config uses a global `$$$config` variable that gets injected at build time:\n\n```mermaid\ngraph LR\n    ThirdParty["Third-party Renderer"]\n    ReconcilerFactory["reconciler(hostConfig)"]\n    GlobalConfig["$$$config variable<br/>(injected by wrapper)"]\n    CustomConfig["ReactFiberConfig.custom.js<br/>re-exports from $$$config"]\n    ReconcilerCore["Reconciler Core Logic"]\n    \n    ThirdParty -->|"calls with config"| ReconcilerFactory\n    ReconcilerFactory -->|"wraps and injects"| GlobalConfig\n    GlobalConfig --> CustomConfig\n    CustomConfig --> ReconcilerCore\n```\n\n**Diagram: Third-Party Renderer Integration**\n\nThe custom config file exports all methods from the injected `$$$config` object:\n\n```javascript\ndeclare const $$$config: any;\nexport const getPublicInstance = $$$config.getPublicInstance;\nexport const getRootHostContext = $$$config.getRootHostContext;\nexport const createInstance = $$$config.createInstance;\n// ... 100+ more exports\n```\n\nSources: [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:26-287]()\n\n## Platform Implementations\n\n### React DOM (Mutation Mode)\n\nThe DOM host config is the most feature-complete implementation, supporting hydration, resources, singletons, view transitions, and suspense commits.\n\n**Key Characteristics**:\n- Mutation mode: directly modifies DOM nodes\n- Namespace context: tracks SVG, MathML, HTML contexts\n- Event system integration: delegates to `ReactDOMEventListener`\n- Resource management: hoists `<link>`, `<script>`, `<style>` to document head\n- Hydration: matches server-rendered markup\n\n**Instance Types**:\n\n| Type | Definition | Usage |\n|------|------------|-------|\n| `Instance` | `Element` | DOM element nodes |\n| `TextInstance` | `Text` | DOM text nodes |\n| `Container` | `Element \\| Document \\| DocumentFragment` | Root container |\n| `SuspenseInstance` | `Comment` (with `_reactRetry`) | Suspense boundaries in SSR |\n| `ActivityInstance` | `Comment` | Activity boundaries in SSR |\n| `HydratableInstance` | Union of above | Any hydratable node |\n\n**Context Management**:\n\n```mermaid\ngraph TB\n    RootContext["getRootHostContext()<br/>Detect document/fragment/<br/>element namespace"]\n    ChildContext["getChildHostContext()<br/>parentContext, type"]\n    \n    subgraph "Namespace Detection"\n        None["HostContextNamespaceNone<br/>(HTML)"]\n        SVG["HostContextNamespaceSvg"]\n        Math["HostContextNamespaceMath"]\n    end\n    \n    RootContext --> None\n    RootContext --> SVG\n    RootContext --> Math\n    \n    ChildContext -.->|"svg tag"| SVG\n    ChildContext -.->|"math tag"| Math\n    ChildContext -.->|"foreignObject in SVG"| None\n    ChildContext -.->|"inherits parent"| None\n```\n\n**Diagram: DOM Context Tracking**\n\n**Instance Creation**:\n\nThe `createInstance` method creates DOM elements with proper namespace handling:\n\n```\n1. Extract host context (namespace)\n2. Get owner document from root container\n3. Create element with appropriate createElementNS or createElement\n4. Special handling for \'script\' (create via innerHTML to prevent execution)\n5. Special handling for \'select\' (apply size/multiple before children)\n6. Cache fiber node on DOM node via precacheFiberNode()\n7. Cache props on DOM node via updateFiberProps()\n8. Return DOM element\n```\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:303-609](), [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js:47-59]()\n\n### React Native Fabric (Persistence Mode)\n\nFabric is React Native\'s modern rendering architecture, using persistence mode to enable structural sharing and better integration with native rendering.\n\n**Key Characteristics**:\n- Persistence mode: creates clones instead of mutating\n- Shadow nodes: lightweight native representations\n- Canonical object sharing: multiple clones share state\n- Public instance laziness: created on first ref access\n\n**Instance Structure**:\n\n```typescript\ntype Instance = {\n  node: Node,  // Shadow node reference (native)\n  canonical: {\n    nativeTag: number,\n    viewConfig: ViewConfig,\n    currentProps: Props,\n    internalInstanceHandle: Fiber,\n    publicInstance: PublicInstance | null,  // Lazily created\n    publicRootInstance?: PublicRootInstance | null\n  }\n}\n```\n\n**Clone Strategy**:\n\n```mermaid\ngraph TB\n    CloneCall["cloneInstance() called"]\n    DiffProps["diffAttributePayloads()<br/>compute changes"]\n    CheckChildren["Check keepChildren flag"]\n    \n    subgraph "Clone Operations"\n        ClonePropsOnly["cloneNodeWithNewProps()<br/>(keep children)"]\n        CloneChildren["cloneNodeWithNewChildren()<br/>(replace children)"]\n        CloneBoth["cloneNodeWithNewChildrenAndProps()<br/>(both changed)"]\n    end\n    \n    ShareCanonical["Share canonical object<br/>across all clones"]\n    \n    CloneCall --> DiffProps\n    DiffProps --> CheckChildren\n    CheckChildren -->|"keepChildren=true<br/>props changed"| ClonePropsOnly\n    CheckChildren -->|"keepChildren=false<br/>no props changed"| CloneChildren\n    CheckChildren -->|"keepChildren=false<br/>props changed"| CloneBoth\n    \n    ClonePropsOnly --> ShareCanonical\n    CloneChildren --> ShareCanonical\n    CloneBoth --> ShareCanonical\n```\n\n**Diagram: Fabric Clone Strategy**\n\nThe `canonical` object is shared across all clones of an instance, providing a stable identity for:\n- Public instance exposure through refs\n- Event handler lookup\n- Current props access for event dispatching\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:95-113](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:451-504]()\n\n### React Native Legacy (Mutation Mode)\n\nThe legacy React Native renderer uses mutation mode with the UIManager bridge API.\n\n**Key Characteristics**:\n- Mutation mode: calls UIManager to modify native views\n- Instance tracking: `ReactNativeFiberHostComponent` wrapper\n- Children management: tracks `_children` array on instance\n- Bridge batching: accumulates changes before native calls\n\n**Instance Management**:\n\n```mermaid\ngraph TB\n    CreateInstance["createInstance()"]\n    AllocateTag["allocateTag()<br/>unique view ID"]\n    GetConfig["getViewConfigForType()<br/>from registry"]\n    CreatePayload["create()<br/>attribute payload"]\n    UIManagerCreate["UIManager.createView()<br/>tag, viewName, rootTag, props"]\n    WrapInstance["new ReactNativeFiberHostComponent()"]\n    \n    CreateInstance --> AllocateTag\n    CreateInstance --> GetConfig\n    CreateInstance --> CreatePayload\n    CreateInstance --> UIManagerCreate\n    CreateInstance --> WrapInstance\n```\n\n**Diagram: Legacy RN Instance Creation**\n\n**Mutation Operations**:\n\nAll mutations go through `UIManager.manageChildren()` which batches multiple operations:\n- `moveFromIndices` / `moveToIndices` - Reorder children\n- `addChildReactTags` / `addAtIndices` - Insert new children\n- `removeAtIndices` - Remove children\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigNative.js:130-169](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:379-411]()\n\n### Test Renderers (Noop and Test)\n\nReact provides test renderers for unit testing without real host platforms.\n\n**Noop Renderer** (`react-noop-renderer`):\n- Used by React\'s internal tests\n- Simple JS object instances: `{type, props, children, hidden, id}`\n- Supports both mutation and persistence modes\n- Configurable behavior (e.g., errors, suspense)\n\n**Test Renderer** (`react-test-renderer`):\n- Public testing API\n- Mutation mode only\n- Creates mockable instances\n- Simple tree inspection: `root.toJSON()`\n\n**Noop Instance Structure**:\n\n```javascript\ntype Instance = {\n  id: number,           // Hidden from enumeration\n  type: string,\n  children: Array<Instance | TextInstance>,\n  parent: number,       // Hidden from enumeration\n  text: string | null,  // Hidden from enumeration\n  prop: any,            // User-defined prop\n  hidden: boolean,\n  context: HostContext  // Hidden from enumeration\n}\n```\n\nThe noop renderer uses `Object.defineProperty()` to hide implementation details from test assertions, making test output cleaner.\n\nSources: [packages/react-noop-renderer/src/createReactNoop.js:399-453](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:158-174]()\n\n### ART Renderer (Canvas/SVG)\n\nThe ART renderer targets the ART drawing library for canvas and SVG rendering.\n\n**Key Characteristics**:\n- Mutation mode\n- Transform-based positioning\n- Pooled transform object (reused across calls)\n- Event listener management\n\n**Transform Application**:\n\n```mermaid\ngraph LR\n    Props["props: x, y, rotation,<br/>scaleX, scaleY, transform"]\n    PooledTransform["pooledTransform<br/>(reused Transform object)"]\n    Compose["Compose transformations:<br/>1. move(x, y)<br/>2. rotate()<br/>3. scale()<br/>4. apply custom transform"]\n    CheckDirty["Compare with instance<br/>current transform"]\n    Apply["instance.transformTo()<br/>if changed"]\n    \n    Props --> PooledTransform\n    PooledTransform --> Compose\n    Compose --> CheckDirty\n    CheckDirty -->|"changed"| Apply\n```\n\n**Diagram: ART Transform Management**\n\nThe pooled transform pattern avoids allocating a new transform object for every update, reducing GC pressure during animations.\n\nSources: [packages/react-art/src/ReactFiberConfigART.js:140-184]()\n\n## Key Host Config Methods\n\n### Instance Lifecycle\n\n**createInstance(type, props, rootContainer, hostContext, internalInstanceHandle)**\n\nCreates a new host instance during the render phase. This is the primary factory method for host components.\n\n**Parameters**:\n- `type`: Component type string (e.g., "div", "View")\n- `props`: Component props object\n- `rootContainer`: The root container being rendered into\n- `hostContext`: Context from parent (e.g., namespace, text context)\n- `internalInstanceHandle`: Fiber reference for this instance\n\n**Returns**: Platform-specific instance (Element, native node, JS object, etc.)\n\n**Timing**: Called during `completeWork` in the render phase when a host component is first mounted.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:485-609](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:176-220]()\n\n**appendInitialChild(parentInstance, child)**\n\nAttaches a child instance to its parent during initial tree construction. This builds the tree bottom-up before commit.\n\n**Note**: Only called for newly created instances. Updates use different methods depending on mutation/persistence mode.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:640-646](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:167-172]()\n\n**finalizeInitialChildren(instance, type, props, hostContext)**\n\nCalled after all children have been appended to a newly created instance, allowing any final initialization.\n\n**Returns**: Boolean indicating whether `commitMount` should be called during commit phase (e.g., for autofocus).\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:648-666](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:250-257]()\n\n### Context Management\n\n**getRootHostContext(rootContainer)**\n\nInitializes the host context for the root of the tree. This determines the initial rendering context.\n\n**DOM Example**: Detects whether root is SVG, MathML, or HTML based on namespace.\n\n**React Native Example**: Returns `{isInAParentText: false}`.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:303-356](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:259-267]()\n\n**getChildHostContext(parentHostContext, type)**\n\nComputes child context based on parent context and the current component type. This propagates context down the tree.\n\n**DOM Example**: Entering `<svg>` switches to SVG namespace, `<foreignObject>` switches back to HTML.\n\n**React Native Example**: Entering text component types sets `isInAParentText: true`.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:392-407](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:269-291]()\n\n### Commit Phase Operations\n\n**prepareForCommit(containerInfo)** / **resetAfterCommit(containerInfo)**\n\nThese methods bracket the entire commit phase, allowing renderers to prepare and cleanup.\n\n**DOM Example**: \n- `prepareForCommit`: Disables event system, saves selection state, returns focused instance\n- `resetAfterCommit`: Re-enables event system, restores selection\n\n**React Native Example**: Both are no-ops (native rendering is synchronous).\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:413-451]()\n\n### Mutation Mode Methods\n\n**appendChild(parentInstance, child)** / **removeChild(parentInstance, child)**\n\nAdd or remove a child from a parent instance. Only defined in mutation mode.\n\n**DOM**: Uses `moveBefore()` if available (future API), otherwise `appendChild()`/`removeChild()`.\n\n**React Native Legacy**: Calls `UIManager.manageChildren()` to batch native changes.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:973-983](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:379-411]()\n\n**commitUpdate(instance, type, oldProps, newProps, internalInstanceHandle)**\n\nUpdates an existing instance\'s properties. Only defined in mutation mode.\n\n**DOM**: Calls `updateProperties()` which diffs props and applies changes to DOM.\n\n**React Native Legacy**: Diffs props and calls `UIManager.updateView()`.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:940-953](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:445-468]()\n\n### Persistence Mode Methods\n\n**cloneInstance(instance, type, oldProps, newProps, keepChildren, newChildSet)**\n\nCreates a clone of an instance with updated properties. Only defined in persistence mode.\n\n**Fabric**: Calls native clone operations (`cloneNodeWithNewProps`, `cloneNodeWithNewChildren`, etc.) and shares the `canonical` object.\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:451-504]()\n\n**replaceContainerChildren(container, newChildren)**\n\nAtomically replaces the root container\'s children with a new child set. Only defined in persistence mode.\n\n**Fabric**: Calls `completeRoot()` to finalize the native tree.\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:556-561]()\n\n### Priority and Scheduling\n\n**setCurrentUpdatePriority(priority)** / **getCurrentUpdatePriority()** / **resolveUpdatePriority()**\n\nManage the priority of the current update. These methods bridge React\'s event priorities with platform-specific priority systems.\n\n**DOM**: Uses React\'s priority constants directly.\n\n**React Native Fabric**: Maps between React priorities and Fabric\'s native priority system:\n- `FabricDiscretePriority`  `DiscreteEventPriority`\n- `FabricContinuousPriority`  `ContinuousEventPriority`\n- `FabricIdlePriority`  `IdleEventPriority`\n- `FabricDefaultPriority`  `DefaultEventPriority`\n\nSources: [packages/react-dom-bindings/src/client/ReactDOMUpdatePriority.js:42-45](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:386-419]()\n\n### Suspense Commit Support\n\n**maySuspendCommit(type, props)** / **preloadInstance(instance, type, props)**\n\nThese optional methods enable the reconciler to delay commits while resources load, preventing layout thrashing.\n\n**maySuspendCommit**: Returns true if this type+props combination might need to load before committing.\n\n**preloadInstance**: Initiates loading and returns true if already loaded, false if still loading.\n\n**DOM Example**: Implements for `<img>` with `loading="lazy"` and `<link>` resources.\n\n**startSuspendingCommit()** / **suspendInstance()** / **waitForCommitToBeReady()**\n\nCreate suspended state, track instances blocking commit, and provide a callback-based API for resuming when ready.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1213-1264](), [packages/react-noop-renderer/src/createReactNoop.js:618-679]()\n\n### View Transition Support\n\n**startViewTransition()** / **startGestureTransition()**\n\nOptional methods for animating state changes using the View Transition API or gesture-driven transitions.\n\n**Parameters include**:\n- Callbacks for mutation, layout, and passive phases\n- Transition types for CSS class selection  \n- Timeline objects for gesture control\n- Error and profiling callbacks\n\n**DOM**: Integrates with native `document.startViewTransition()` API.\n\n**Other platforms**: Typically no-op or call callbacks without animation.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1383-1520]()\n\n## Default Implementations\n\nReact provides default implementations for optional features that throw errors or return no-ops:\n\n- **ReactFiberConfigWithNoMutation.js**: Exports that throw for mutation methods\n- **ReactFiberConfigWithNoPersistence.js**: Exports that throw for persistence methods\n- **ReactFiberConfigWithNoHydration.js**: Exports that return false/null for hydration\n- **ReactFiberConfigWithNoResources.js**: Exports that throw for resource management\n- **ReactFiberConfigWithNoSingletons.js**: Exports that throw for singleton management\n- **ReactFiberConfigWithNoTestSelectors.js**: Exports that throw for test selectors\n- **ReactFiberConfigWithNoMicrotasks.js**: Exports that disable microtask scheduling\n- **ReactFiberConfigWithNoScopes.js**: Exports for disabled scope API\n\nRenderers import these default modules and then override only the features they support:\n\n```javascript\nexport * from \'react-reconciler/src/ReactFiberConfigWithNoMutation\';\nexport * from \'react-reconciler/src/ReactFiberConfigWithNoHydration\';\n// ... etc\n\n// Then override specific methods:\nexport const supportsPersistence = true;\nexport function cloneInstance(...) { /* implementation */ }\n```\n\nSources: [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js:1-62](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:160-165]()\n\n---\n\n# Page: Profiling and Performance Tracking\n\n# Profiling and Performance Tracking\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightPerformanceTrack.js](packages/react-client/src/ReactFlightPerformanceTrack.js)\n- [packages/react-dom/index.js](packages/react-dom/index.js)\n- [packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js](packages/react-dom/src/__tests__/ReactDOMFiberAsync-test.js)\n- [packages/react-dom/src/__tests__/refs-test.js](packages/react-dom/src/__tests__/refs-test.js)\n- [packages/react-reconciler/src/ReactChildFiber.js](packages/react-reconciler/src/ReactChildFiber.js)\n- [packages/react-reconciler/src/ReactFiber.js](packages/react-reconciler/src/ReactFiber.js)\n- [packages/react-reconciler/src/ReactFiberBeginWork.js](packages/react-reconciler/src/ReactFiberBeginWork.js)\n- [packages/react-reconciler/src/ReactFiberClassComponent.js](packages/react-reconciler/src/ReactFiberClassComponent.js)\n- [packages/react-reconciler/src/ReactFiberCommitWork.js](packages/react-reconciler/src/ReactFiberCommitWork.js)\n- [packages/react-reconciler/src/ReactFiberCompleteWork.js](packages/react-reconciler/src/ReactFiberCompleteWork.js)\n- [packages/react-reconciler/src/ReactFiberLane.js](packages/react-reconciler/src/ReactFiberLane.js)\n- [packages/react-reconciler/src/ReactFiberPerformanceTrack.js](packages/react-reconciler/src/ReactFiberPerformanceTrack.js)\n- [packages/react-reconciler/src/ReactFiberReconciler.js](packages/react-reconciler/src/ReactFiberReconciler.js)\n- [packages/react-reconciler/src/ReactFiberRootScheduler.js](packages/react-reconciler/src/ReactFiberRootScheduler.js)\n- [packages/react-reconciler/src/ReactFiberSuspenseComponent.js](packages/react-reconciler/src/ReactFiberSuspenseComponent.js)\n- [packages/react-reconciler/src/ReactFiberUnwindWork.js](packages/react-reconciler/src/ReactFiberUnwindWork.js)\n- [packages/react-reconciler/src/ReactFiberWorkLoop.js](packages/react-reconciler/src/ReactFiberWorkLoop.js)\n- [packages/react-reconciler/src/ReactProfilerTimer.js](packages/react-reconciler/src/ReactProfilerTimer.js)\n- [packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js](packages/react-reconciler/src/__tests__/ReactDeferredValue-test.js)\n- [packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js](packages/react-reconciler/src/__tests__/ReactLazy-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js](packages/react-reconciler/src/__tests__/ReactPerformanceTrack-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js](packages/react-reconciler/src/__tests__/ReactSiblingPrerendering-test.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspense-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js](packages/react-reconciler/src/__tests__/ReactSuspensePlaceholder-test.internal.js)\n- [packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js](packages/react-reconciler/src/__tests__/ReactSuspenseyCommitPhase-test.js)\n- [packages/react-server/src/ReactFlightAsyncSequence.js](packages/react-server/src/ReactFlightAsyncSequence.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNode.js](packages/react-server/src/ReactFlightServerConfigDebugNode.js)\n- [packages/react-server/src/ReactFlightServerConfigDebugNoop.js](packages/react-server/src/ReactFlightServerConfigDebugNoop.js)\n- [packages/react-server/src/ReactFlightStackConfigV8.js](packages/react-server/src/ReactFlightStackConfigV8.js)\n- [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js](packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js)\n- [packages/react/src/ReactLazy.js](packages/react/src/ReactLazy.js)\n- [packages/react/src/__tests__/ReactProfiler-test.internal.js](packages/react/src/__tests__/ReactProfiler-test.internal.js)\n- [packages/shared/ReactPerformanceTrackProperties.js](packages/shared/ReactPerformanceTrackProperties.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThe profiling system provides instrumentation for measuring React component rendering performance through four key mechanisms:\n\n1. **Profiler Component** - Public `<Profiler>` API for programmatic performance monitoring\n2. **Performance Measurement** - `actualDuration` and `baseDuration` fields tracking render times\n3. **Component Effects Tracking** - Measurement of effect execution times within Profiler boundaries\n4. **Browser DevTools Integration** - `performance.measure()` and `console.timeStamp()` integration for visual profiling\n\nThis system enables both runtime performance callbacks via the Profiler component and offline analysis through browser performance timelines and React DevTools.\n\nFor information about the DevTools profiling interface, see page 7.1. For lane-based scheduling that determines update priorities, see page 4.4.\n\n---\n\n## System Architecture\n\nThe profiling system operates across multiple phases of the React reconciliation and commit lifecycle:\n\n```mermaid\ngraph TB\n    subgraph "Public API"\n        ProfilerComponent["<Profiler> Component<br/>with onRender callback"]\n    end\n    \n    subgraph "Fiber Fields"\n        ActualDuration["actualDuration<br/>Time spent rendering"]\n        ActualStartTime["actualStartTime<br/>When render began"]\n        SelfBaseDuration["selfBaseDuration<br/>Component time only"]\n        TreeBaseDuration["treeBaseDuration<br/>Including children"]\n    end\n    \n    subgraph "Timing Infrastructure"\n        StartProfilerTimer["startProfilerTimer()<br/>Begin timing"]\n        StopProfilerTimer["stopProfilerTimerIfRunning()<br/>End timing"]\n        RecordRenderTime["recordRenderTime()<br/>Track render duration"]\n        RecordCommitTime["recordCommitTime()<br/>Track commit duration"]\n    end\n    \n    subgraph "Render Phase Instrumentation"\n        MarkRenderStarted["markComponentRenderStarted()<br/>BeginWork hooks"]\n        MarkRenderStopped["markComponentRenderStopped()<br/>After component render"]\n        TransferDuration["transferActualDuration()<br/>Bubble up times"]\n    end\n    \n    subgraph "Commit Phase Instrumentation"\n        CommitProfilerUpdate["commitProfilerUpdate()<br/>Layout effects"]\n        PushEffectDurations["pushNestedEffectDurations()<br/>Track effect times"]\n        PopEffectDurations["popNestedEffectDurations()<br/>Bubble effect times"]\n    end\n    \n    subgraph "Performance Track"\n        LogComponentRender["logComponentRender()<br/>Browser timeline"]\n        LogComponentMount["logComponentMount()"]\n        LogComponentEffect["logComponentEffect()"]\n        ConsoleTimeStamp["console.timeStamp()"]\n        PerformanceMeasure["performance.measure()"]\n    end\n    \n    ProfilerComponent --> ActualDuration\n    ProfilerComponent --> TreeBaseDuration\n    \n    StartProfilerTimer --> ActualStartTime\n    StopProfilerTimer --> ActualDuration\n    \n    MarkRenderStarted --> StartProfilerTimer\n    MarkRenderStopped --> StopProfilerTimer\n    TransferDuration --> TreeBaseDuration\n    \n    CommitProfilerUpdate --> PushEffectDurations\n    CommitProfilerUpdate --> PopEffectDurations\n    \n    LogComponentRender --> ConsoleTimeStamp\n    LogComponentRender --> PerformanceMeasure\n    LogComponentMount --> ConsoleTimeStamp\n    LogComponentEffect --> PerformanceMeasure\n    \n    RecordRenderTime --> LogComponentRender\n    RecordCommitTime --> CommitProfilerUpdate\n```\n\n**Sources:** [packages/react-reconciler/src/ReactProfilerTimer.js:1-700](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:1-600]()\n\n---\n\n## Profiler Component API\n\nThe public `<Profiler>` component allows measuring rendering costs programmatically:\n\n```mermaid\ngraph LR\n    subgraph "Component Tree"\n        App["App Component"]\n        ProfilerNode["<Profiler id=\'navigation\'<br/>onRender=callback>"]\n        Children["Navigation children"]\n    end\n    \n    subgraph "Callback Invocation"\n        OnRenderCallback["onRender callback"]\n        CallbackArgs["Arguments:<br/>id, phase, actualDuration,<br/>baseDuration, startTime,<br/>commitTime"]\n    end\n    \n    subgraph "Profiler Fiber"\n        ProfilerFiber["Profiler Fiber<br/>tag: Profiler"]\n        StateNode["stateNode:<br/>{id, onRender, effectDuration}"]\n    end\n    \n    App --> ProfilerNode\n    ProfilerNode --> Children\n    ProfilerNode --> ProfilerFiber\n    ProfilerFiber --> StateNode\n    ProfilerFiber --> OnRenderCallback\n    OnRenderCallback --> CallbackArgs\n```\n\n### Callback Signature\n\nThe `onRender` callback receives six arguments as defined in `commitProfilerUpdate`:\n\n| Parameter | Type | Description |\n|-----------|------|-------------|\n| `id` | string | Unique identifier for the Profiler |\n| `phase` | "mount" \\| "update" \\| "nested-update" | Render phase type |\n| `actualDuration` | number | Time spent rendering this update (ms) |\n| `baseDuration` | number | Total render time without memoization (ms) |\n| `startTime` | number | When React began rendering (ms from page load) |\n| `commitTime` | number | When React committed the update (ms from page load) |\n\nThe callback is invoked during the layout effects phase via `commitProfilerUpdate`. When `enableProfilerCommitHooks` is enabled, the callback is called synchronously after layout effects but before passive effects.\n\n**Example from tests:**\n```javascript\n// Test verifying callback parameters\n<Profiler id="test" onRender={callback}>\n  <AdvanceTime />\n</Profiler>\n\n// callback receives:\n// id: \'test\'\n// phase: \'mount\'\n// actualDuration: 10  // time spent in this render\n// baseDuration: 10    // time without memo optimizations\n// startTime: 5        // when render started\n// commitTime: 15      // when commit finished\n```\n\n**Sources:** [packages/react/src/__tests__/ReactProfiler-test.internal.js:287-360](), [packages/react-reconciler/src/ReactFiberCommitEffects.js:350-380](), [packages/react-reconciler/src/ReactFiberCommitWork.js:699-734]()\n\n---\n\n## Internal Timing Infrastructure\n\n### Fiber Timing Fields\n\nEach fiber maintains four timing-related fields when `enableProfilerTimer` is enabled. These fields are initialized in the `FiberNode` constructor:\n\n```mermaid\ngraph TB\n    FiberNode["Fiber Node<br/>(FiberNode constructor)"]\n    \n    subgraph "Performance Measurement Fields"\n        ActualDuration["actualDuration: number<br/>Accumulated render time<br/>for this render pass<br/>(starts at -0)"]\n        ActualStartTime["actualStartTime: number<br/>When this fiber began<br/>rendering, or -1 if not started<br/>(initialized to -1.1)"]\n        SelfBaseDuration["selfBaseDuration: number<br/>Most recent render time<br/>excluding children<br/>(starts at -0)"]\n        TreeBaseDuration["treeBaseDuration: number<br/>Total time for subtree<br/>without memoization<br/>(starts at -0)"]\n    end\n    \n    FiberNode --> ActualDuration\n    FiberNode --> ActualStartTime\n    FiberNode --> SelfBaseDuration\n    FiberNode --> TreeBaseDuration\n    \n    style FiberNode fill:#f9f9f9\n```\n\n**Field Semantics:**\n\n- **`actualDuration`**: Accumulates the time spent rendering during the current work-in-progress pass. Updated by `stopProfilerTimerIfRunningAndRecordDuration`.\n- **`actualStartTime`**: Set by `startProfilerTimer` when rendering begins. Value of -1 indicates the fiber hasn\'t started rendering in this pass.\n- **`selfBaseDuration`**: Time for this component alone, excluding children. Calculated during `completeWork`.\n- **`treeBaseDuration`**: Estimated total time including all children if nothing was memoized. Bubbles up via `transferActualDuration`.\n\nThese fields use double values (initialized to -0 and -1.1) to avoid V8 performance cliffs when Object.preventExtensions is applied in DEV mode.\n\n**Sources:** [packages/react-reconciler/src/ReactFiber.js:179-197](), [packages/react-reconciler/src/ReactFiber.js:281-286](), [packages/react-reconciler/src/ReactProfilerTimer.js:324-400]()\n\n### Timer Control Functions\n\nThe profiling system provides functions to start and stop timers during component rendering:\n\n| Function | Location | Purpose |\n|----------|----------|---------|\n| `startProfilerTimer(fiber)` | ReactProfilerTimer.js | Begin timing a fiber\'s render |\n| `stopProfilerTimerIfRunningAndRecordDuration(fiber)` | ReactProfilerTimer.js | Complete timing and record duration |\n| `stopProfilerTimerIfRunningAndRecordIncompleteDuration(fiber)` | ReactProfilerTimer.js | Record partial duration if interrupted |\n| `recordRenderTime(endTime)` | ReactProfilerTimer.js | Mark render phase completion |\n| `recordCommitTime(endTime)` | ReactProfilerTimer.js | Mark commit phase completion |\n\n**Sources:** [packages/react-reconciler/src/ReactProfilerTimer.js:324-400]()\n\n---\n\n## Render Phase Instrumentation\n\nDuring the render phase, React instruments component rendering at key points:\n\n```mermaid\ngraph TD\n    BeginWork["beginWork(fiber)"]\n    PrepareToReadContext["prepareToReadContext()"]\n    MarkStarted["markComponentRenderStarted(fiber)<br/>if enableSchedulingProfiler"]\n    \n    RenderComponent["renderWithHooks() or<br/>callComponentInDEV()"]\n    \n    MarkStopped["markComponentRenderStopped()<br/>if enableSchedulingProfiler"]\n    StopTimer["stopProfilerTimerIfRunning(fiber)<br/>if enableProfilerTimer"]\n    \n    CompleteWork["completeWork(fiber)"]\n    TransferDuration["transferActualDuration(fiber)<br/>Bubble to parent Profiler"]\n    \n    BeginWork --> PrepareToReadContext\n    PrepareToReadContext --> MarkStarted\n    MarkStarted --> RenderComponent\n    RenderComponent --> MarkStopped\n    MarkStopped --> StopTimer\n    StopTimer --> CompleteWork\n    CompleteWork --> TransferDuration\n```\n\n### Component Render Timing\n\nFor function components, the instrumentation occurs in `updateFunctionComponent`:\n\n[packages/react-reconciler/src/ReactFiberBeginWork.js:438-454]()\n\nFor class components, timing wraps lifecycle methods:\n\n[packages/react-reconciler/src/ReactFiberClassComponent.js:56-63]()\n\n### Duration Accumulation\n\nAs the reconciler completes work on child fibers, their `actualDuration` values bubble up to ancestor Profiler components via `transferActualDuration`:\n\n[packages/react-reconciler/src/ReactProfilerTimer.js:680-700]()\n\n**Sources:** [packages/react-reconciler/src/ReactFiberBeginWork.js:438-454](), [packages/react-reconciler/src/ReactProfilerTimer.js:680-700]()\n\n---\n\n## Component Effects Tracking\n\nThe commit phase tracks the execution time of effects (layout and passive) within Profiler boundaries. This is crucial for understanding not just render costs but also effect costs.\n\n### Effect Duration Measurement Flow\n\n```mermaid\ngraph TD\n    subgraph "commitLayoutEffectOnFiber"\n        Start["Enter commitLayoutEffectOnFiber(fiber)"]\n        PushEffectStart["pushComponentEffectStart()<br/>Record start time in componentEffectStartTime"]\n        PushEffectDuration["pushComponentEffectDuration()<br/>Save previous duration"]\n        \n        CheckProfiler{"Is fiber a<br/>Profiler tag?"}\n        \n        PushNested["pushNestedEffectDurations()<br/>Save prevProfilerEffectDuration<br/>Reset profilerEffectDuration = 0"]\n        \n        ExecuteEffects["Execute layout effects<br/>(recursively for children)"]\n        \n        PopNested["popNestedEffectDurations(prev)<br/>Calculate nested duration<br/>Add to profilerEffectDuration"]\n        \n        InvokeCallback["commitProfilerUpdate()<br/>Call onRender with effectDuration"]\n        \n        PopEffectStart["popComponentEffectStart()"]\n        PopEffectDuration["popComponentEffectDuration()<br/>Add elapsed time to componentEffectDuration"]\n    end\n    \n    Start --> PushEffectStart\n    PushEffectStart --> PushEffectDuration\n    PushEffectDuration --> CheckProfiler\n    CheckProfiler -->|Yes| PushNested\n    CheckProfiler -->|No| ExecuteEffects\n    PushNested --> ExecuteEffects\n    ExecuteEffects --> PopNested\n    PopNested --> InvokeCallback\n    ExecuteEffects --> PopEffectStart\n    PopEffectStart --> PopEffectDuration\n    \n    style CheckProfiler fill:#f9f9f9\n    style InvokeCallback fill:#f9f9f9\n```\n\n### Effect Timing Variables\n\nThe profiler maintains several module-level variables for effect timing:\n\n```javascript\n// From ReactProfilerTimer.js\nexport let profilerEffectDuration: number = -0;\nexport let componentEffectStartTime: number = -1.1;\nexport let componentEffectEndTime: number = -1.1;\nexport let componentEffectDuration: number = -0;\n```\n\nThese track:\n- **`profilerEffectDuration`**: Total effect time within current Profiler boundary\n- **`componentEffectStartTime`**: When effect execution started for current component\n- **`componentEffectDuration`**: Accumulated effect time for current component\n\n### Stack-Based Duration Tracking\n\nThe system uses a stack to handle nested Profilers correctly:\n\n```javascript\n// pushNestedEffectDurations saves current duration and resets\nconst prevProfilerEffectDuration = profilerEffectDuration;\nprofilerEffectDuration = 0;\n\n// After children execute effects...\n\n// popNestedEffectDurations calculates and bubbles up\nconst nestedDuration = profilerEffectDuration;\nprofilerEffectDuration = prevDuration + nestedDuration;\n```\n\nThis ensures each Profiler accurately measures only the effects in its subtree, including nested Profilers.\n\n### Profiler Callback with Effect Duration\n\nWhen `commitProfilerUpdate` is called for a Profiler fiber with `enableProfilerCommitHooks` enabled:\n\n[packages/react-reconciler/src/ReactFiberCommitEffects.js:350-380]()\n\nThe callback receives `effectDuration` calculated from `profilerEffectDuration`, which includes:\n- Time executing layout effects in the Profiler\'s subtree\n- Time from nested Profiler components\n- Effect cleanup and setup time\n\n**Sources:** [packages/react-reconciler/src/ReactFiberCommitWork.js:699-734](), [packages/react-reconciler/src/ReactProfilerTimer.js:61-68](), [packages/react-reconciler/src/ReactProfilerTimer.js:123-141]()\n\n---\n\n## Browser DevTools Performance API Integration\n\nWhen `enableComponentPerformanceTrack` is enabled, React integrates with browser DevTools using the Performance API. This creates visual profiling data in Chrome/Edge DevTools Performance panel and Firefox Performance tools.\n\n### Browser API Integration Points\n\n```mermaid\ngraph TB\n    subgraph "React Profiling Events"\n        RenderComplete["Render phase completes<br/>recordRenderTime()"]\n        ComponentRender["Component finishes rendering<br/>stopProfilerTimer()"]\n        EffectExecute["Effects execute<br/>commitLayoutEffects()"]\n        ComponentMount["Component mounts<br/>commitHostMount()"]\n        ComponentUnmount["Component unmounts<br/>safelyCallComponentWillUnmount()"]\n    end\n    \n    subgraph "ReactFiberPerformanceTrack.js Functions"\n        LogRender["logComponentRender(fiber, start, end)<br/>Main render tracking"]\n        LogMount["logComponentMount(fiber, start, end)<br/>Mount event marker"]\n        LogUnmount["logComponentUnmount(fiber, start, end)<br/>Unmount event marker"]\n        LogEffect["logComponentEffect(fiber, start, end)<br/>Effect execution span"]\n    end\n    \n    subgraph "Browser Performance APIs"\n        ConsoleTimeStamp["console.timeStamp(name, start, end,<br/>track, group, color)<br/>Creates timeline marker"]\n        PerformanceMeasure["performance.measure(name, options)<br/>Creates performance span"]\n        PerformanceClear["performance.clearMeasures(name)<br/>Cleanup after logging"]\n    end\n    \n    subgraph "Performance Panel Result"\n        ComponentsTrack["\'Components \' track<br/>Render spans with metadata"]\n        LanesTrack["\'Scheduler \' group<br/>Blocking/Gesture/Transition/etc"]\n        Markers["Timeline markers<br/>Mount/Unmount events"]\n    end\n    \n    ComponentRender --> LogRender\n    ComponentMount --> LogMount\n    ComponentUnmount --> LogUnmount\n    EffectExecute --> LogEffect\n    \n    LogRender --> ConsoleTimeStamp\n    LogRender --> PerformanceMeasure\n    LogMount --> ConsoleTimeStamp\n    LogEffect --> PerformanceMeasure\n    \n    PerformanceMeasure --> PerformanceClear\n    \n    ConsoleTimeStamp --> ComponentsTrack\n    PerformanceMeasure --> ComponentsTrack\n    ConsoleTimeStamp --> Markers\n    \n    RenderComplete --> LanesTrack\n    \n    style ConsoleTimeStamp fill:#f9f9f9\n    style PerformanceMeasure fill:#f9f9f9\n```\n\n### Performance Measure Options\n\nReact uses the extended `performance.measure()` API with DevTools-specific metadata:\n\n```javascript\n// From logComponentRender in ReactFiberPerformanceTrack.js\nconst reusableComponentOptions = {\n  start: startTime,\n  end: endTime,\n  detail: {\n    devtools: {\n      dataType: \'track-entry\',\n      color: \'primary\', // or \'primary-light\', \'primary-dark\', \'error\'\n      track: \'Components \',\n      tooltipText: componentName,\n      properties: [\n        // Array of property changes, warnings, etc.\n      ]\n    }\n  }\n};\n\nperformance.measure(measureName, reusableComponentOptions);\n```\n\nThe `detail.devtools` object is recognized by Chrome DevTools to:\n- Place entries in named tracks ("Components ")\n- Apply color coding based on render duration\n- Add tooltips with component names\n- Attach structured metadata (props changes, warnings)\n\n### Track Organization\n\nPerformance entries are organized into distinct tracks visible in the Performance panel:\n\n| Track/Group | Created By | Entries |\n|-------------|------------|---------|\n| Components  | `logComponentRender()` | Individual component render spans |\n| Scheduler  | `markAllLanesInOrder()` | Lane group initialization markers |\n| Blocking (sub-track) | Lane tracking | Blocking lane renders |\n| Gesture (sub-track) | Lane tracking | Gesture transition renders |\n| Transition (sub-track) | Lane tracking | Transition renders |\n| Suspense (sub-track) | Lane tracking | Retry lane renders |\n| Idle (sub-track) | Lane tracking | Idle priority renders |\n\n### Metadata in Performance Entries\n\nEach component render entry includes rich metadata via the `properties` array:\n\n```javascript\n// Property metadata structure\nproperties: [\n  [\'Props Changed\', changedPropNames.join(\', \')],\n  [\'Deep Equal Props\', deepEqualProps ? \'true\' : \'false\'],\n  [\'Cascading Update\', didCascade ? \'true\' : \'false\'],\n  // ... additional entries\n]\n```\n\nThis metadata appears in the DevTools UI when selecting a performance entry, helping developers identify:\n- Which props changed to trigger the render\n- Whether deeply equal objects caused unnecessary renders\n- If the component updated during another component\'s render\n\n### Console Task Integration\n\nIn development mode with `console.createTask()` support, React links performance entries to the component\'s debug task:\n\n[packages/react-reconciler/src/ReactFiberPerformanceTrack.js:125-137]()\n\nThis allows DevTools to group related async operations and show the component stack that initiated them.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:42-51](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:112-139](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:221-330]()\n\n---\n\n## Update Type Tracking\n\nThe profiling system distinguishes between different types of updates:\n\n```mermaid\ngraph LR\n    subgraph "Update Types"\n        RegularUpdate["REGULAR_UPDATE (0)<br/>Normal setState/dispatch"]\n        SpawnedUpdate["SPAWNED_UPDATE (1)<br/>Update during render"]\n        PingedUpdate["PINGED_UPDATE (2)<br/>Retry after Suspense"]\n    end\n    \n    subgraph "Update Timers"\n        BlockingTimers["Blocking update timers:<br/>blockingUpdateTime,<br/>blockingUpdateTask,<br/>blockingUpdateMethodName"]\n        GestureTimers["Gesture update timers:<br/>gestureUpdateTime,<br/>gestureUpdateTask,<br/>gestureUpdateMethodName"]\n        TransitionTimers["Transition update timers:<br/>transitionUpdateTime,<br/>transitionUpdateTask,<br/>transitionUpdateMethodName"]\n    end\n    \n    subgraph "Event Tracking"\n        EventTime["Event timestamp"]\n        EventType["Event type (click, input, etc)"]\n        EventRepeatTime["Repeat event detection"]\n        SuspendedTime["Time suspended waiting"]\n    end\n    \n    RegularUpdate --> BlockingTimers\n    RegularUpdate --> GestureTimers\n    RegularUpdate --> TransitionTimers\n    \n    BlockingTimers --> EventTime\n    GestureTimers --> EventTime\n    TransitionTimers --> EventTime\n    \n    EventTime --> EventType\n    EventType --> EventRepeatTime\n    EventRepeatTime --> SuspendedTime\n```\n\n### Timer Lifecycle\n\nFor each lane group, the system maintains separate timers:\n\n**Blocking Lane Updates:**\n[packages/react-reconciler/src/ReactProfilerTimer.js:69-78]()\n\n**Gesture Lane Updates (when enabled):**\n[packages/react-reconciler/src/ReactProfilerTimer.js:80-89]()\n\n**Transition Lane Updates:**\n[packages/react-reconciler/src/ReactProfilerTimer.js:92-101]()\n\nThese timers are started when updates are scheduled and are clamped to the render/commit boundaries.\n\n**Sources:** [packages/react-reconciler/src/ReactProfilerTimer.js:52-101](), [packages/react-reconciler/src/ReactProfilerTimer.js:276-343]()\n\n---\n\n## React DevTools Backend Integration\n\nThe profiling system provides data to React DevTools through the DevTools hook, which is injected globally. This allows the standalone DevTools UI to display profiling data collected by the reconciler.\n\n### DevTools Hook Communication\n\n```mermaid\ngraph TB\n    subgraph "Reconciler Commit Phases"\n        CommitRoot["commitRoot(root, ...) in<br/>ReactFiberWorkLoop.js"]\n        LayoutPhase["Layout effects phase<br/>commitLayoutEffects()"]\n        ProfilerCallback["Profiler onRender callbacks<br/>commitProfilerUpdate()"]\n        PassivePhase["Passive effects phase<br/>commitPassiveMountEffects()"]\n    end\n    \n    subgraph "Profiling Data Collection"\n        FiberTree["Fiber tree with<br/>actualDuration, treeBaseDuration"]\n        RootEffectDuration["root.effectDuration<br/>(accumulated during layout)"]\n        UpdateTracker["Update tracking metadata<br/>(_updatedFibers in DEV)"]\n    end\n    \n    subgraph "DevTools Hook Functions"\n        OnCommitRoot["onCommitRootDevTools(root, lanes)<br/>from ReactFiberDevToolsHook.js"]\n        OnPostCommitRoot["onPostCommitRootDevTools()<br/>(after passive effects)"]\n        MarkCommitStarted["markCommitStarted(lanes)<br/>(scheduling profiler)"]\n        MarkCommitStopped["markCommitStopped()<br/>(scheduling profiler)"]\n    end\n    \n    subgraph "DevTools UI"\n        ProfilerPanel["Profiler Panel<br/>(in React DevTools extension)"]\n        FlameGraph["Flame Graph view"]\n        RankedChart["Ranked Chart view"]\n        Timeline["Timeline view"]\n    end\n    \n    CommitRoot --> LayoutPhase\n    LayoutPhase --> ProfilerCallback\n    CommitRoot --> PassivePhase\n    \n    LayoutPhase --> RootEffectDuration\n    ProfilerCallback --> FiberTree\n    \n    CommitRoot --> MarkCommitStarted\n    MarkCommitStarted --> OnCommitRoot\n    OnCommitRoot --> FiberTree\n    OnCommitRoot --> RootEffectDuration\n    \n    PassivePhase --> OnPostCommitRoot\n    \n    OnCommitRoot --> ProfilerPanel\n    ProfilerPanel --> FlameGraph\n    ProfilerPanel --> RankedChart\n    ProfilerPanel --> Timeline\n    \n    style OnCommitRoot fill:#f9f9f9\n    style ProfilerPanel fill:#f9f9f9\n```\n\n### Commit Root Notification\n\nAfter each commit completes, React notifies DevTools via `onCommitRootDevTools`:\n\n[packages/react-reconciler/src/ReactFiberDevToolsHook.js:353-369]()\n\nThis hook is called with:\n- The `FiberRoot` containing the committed fiber tree\n- The `lanes` that were committed\n- Timing information from `commitStartTime` and `commitEndTime`\n\n### Effect Duration on FiberRoot\n\nThe `effectDuration` field on FiberRoot accumulates the total time spent in layout effects:\n\n[packages/react-reconciler/src/ReactFiberCommitWork.js:650-654]()\n\nThis value is calculated using `popNestedEffectDurations` and includes:\n- Time in all layout effect setup and cleanup functions\n- Nested Profiler effect durations\n- Class component lifecycle methods (componentDidMount, componentDidUpdate)\n\n### Debug Information in DEV\n\nWhen `enableUpdaterTracking` is enabled in development mode, transitions track which fibers were updated:\n\n```javascript\n// From ReactFiberWorkLoop.js - requestUpdateLane\nif (__DEV__) {\n  if (!transition._updatedFibers) {\n    transition._updatedFibers = new Set();\n  }\n  transition._updatedFibers.add(fiber);\n}\n```\n\nThis allows DevTools to show which components were affected by a particular transition, helping developers understand the scope of updates.\n\n### Console Task Tracking\n\nIn development mode, each fiber can have an associated `_debugTask` created with `console.createTask()`:\n\n[packages/react-reconciler/src/ReactFiber.js:199-210]()\n\nThis task is used to wrap performance measurements and other async operations, creating a causal chain that DevTools can visualize. The task shows which user interaction or async operation caused a particular component to render.\n\n**Sources:** [packages/react-reconciler/src/ReactFiberDevToolsHook.js:353-369](), [packages/react-reconciler/src/ReactFiberCommitWork.js:650-654](), [packages/react-reconciler/src/ReactFiberWorkLoop.js:792-836](), [packages/react-reconciler/src/ReactFiber.js:199-210]()\n\n---\n\n## Feature Flags\n\nThe profiling system respects several feature flags:\n\n| Flag | File | Purpose |\n|------|------|---------|\n| `enableProfilerTimer` | ReactFeatureFlags | Enable all timing infrastructure |\n| `enableProfilerCommitHooks` | ReactFeatureFlags | Enable Profiler onRender callbacks |\n| `enableProfilerNestedUpdatePhase` | ReactFeatureFlags | Track nested update phase separately |\n| `enableSchedulingProfiler` | ReactFeatureFlags | Enable DevTools scheduling profiler |\n| `enableComponentPerformanceTrack` | ReactFeatureFlags | Enable browser performance timeline |\n\nWhen `enableProfilerTimer` is false, all timing fields are omitted from fibers to reduce memory overhead.\n\n**Sources:** [packages/shared/ReactFeatureFlags.js:1-100](), [packages/react-reconciler/src/ReactFiber.js:179-197]()\n\n---\n\n## Performance Considerations\n\n### Memory Overhead\n\nProfiling adds several fields to each fiber:\n- 4 double-precision numbers (32 bytes on 64-bit systems)\n- Additional tracking state for update types and timers\n\nThis overhead is eliminated in production builds when profiling is disabled.\n\n### Timing Precision\n\nThe system uses `Scheduler.unstable_now()` which delegates to `performance.now()` when available, providing microsecond precision on most platforms:\n\n[packages/react-reconciler/src/ReactProfilerTimer.js:43]()\n\n### Deep Equality Detection\n\nThe performance track system includes warnings for deeply equal props that might benefit from memoization:\n\n[packages/react-reconciler/src/ReactFiberPerformanceTrack.js:216-219](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:269-291]()\n\nThis detection is expensive and only runs in development mode.\n\n**Sources:** [packages/react-reconciler/src/ReactProfilerTimer.js:40-50](), [packages/react-reconciler/src/ReactFiberPerformanceTrack.js:269-291]()\n\n---\n\n# Page: Server-Side Rendering\n\n# Server-Side Rendering\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightClient.js](packages/react-client/src/ReactFlightClient.js)\n- [packages/react-client/src/ReactFlightReplyClient.js](packages/react-client/src/ReactFlightReplyClient.js)\n- [packages/react-client/src/ReactFlightTemporaryReferences.js](packages/react-client/src/ReactFlightTemporaryReferences.js)\n- [packages/react-client/src/__tests__/ReactFlight-test.js](packages/react-client/src/__tests__/ReactFlight-test.js)\n- [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js](packages/react-dom-bindings/src/client/ReactDOMComponentTree.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js)\n- [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js](packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js](packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFloat-test.js](packages/react-dom/src/__tests__/ReactDOMFloat-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js](packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js](packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js)\n- [packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js](packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js)\n- [packages/react-dom/src/__tests__/ReactRenderDocument-test.js](packages/react-dom/src/__tests__/ReactRenderDocument-test.js)\n- [packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js](packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js](packages/react-dom/src/server/ReactDOMFizzServerBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBun.js](packages/react-dom/src/server/ReactDOMFizzServerBun.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerEdge.js](packages/react-dom/src/server/ReactDOMFizzServerEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerNode.js](packages/react-dom/src/server/ReactDOMFizzServerNode.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js](packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticEdge.js](packages/react-dom/src/server/ReactDOMFizzStaticEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticNode.js](packages/react-dom/src/server/ReactDOMFizzStaticNode.js)\n- [packages/react-markup/src/ReactFizzConfigMarkup.js](packages/react-markup/src/ReactFizzConfigMarkup.js)\n- [packages/react-noop-renderer/src/ReactNoopServer.js](packages/react-noop-renderer/src/ReactNoopServer.js)\n- [packages/react-reconciler/src/ReactFiberHydrationContext.js](packages/react-reconciler/src/ReactFiberHydrationContext.js)\n- [packages/react-server-dom-esm/src/ReactFlightESMReferences.js](packages/react-server-dom-esm/src/ReactFlightESMReferences.js)\n- [packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js](packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js)\n- [packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js](packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js)\n- [packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js](packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js)\n- [packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js](packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js)\n- [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js](packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js)\n- [packages/react-server/src/ReactFizzServer.js](packages/react-server/src/ReactFizzServer.js)\n- [packages/react-server/src/ReactFlightReplyServer.js](packages/react-server/src/ReactFlightReplyServer.js)\n- [packages/react-server/src/ReactFlightServer.js](packages/react-server/src/ReactFlightServer.js)\n- [packages/react-server/src/ReactFlightServerTemporaryReferences.js](packages/react-server/src/ReactFlightServerTemporaryReferences.js)\n- [packages/react-server/src/forks/ReactFizzConfig.custom.js](packages/react-server/src/forks/ReactFizzConfig.custom.js)\n- [scripts/error-codes/codes.json](scripts/error-codes/codes.json)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document provides an overview of React\'s server-side rendering capabilities, covering both **HTML streaming (Fizz)** and **Server Components (Flight)**. These two complementary systems enable React applications to render on the server and transmit the results to clients for hydration or consumption.\n\nFor detailed implementation of HTML streaming with Suspense boundaries, see [React Fizz (Streaming SSR)](#5.1). For Server Components serialization and the RSC protocol, see [React Server Components (Flight)](#5.2). For build system integration, see [Build Integration for Server Components](#5.3). For server actions and bidirectional communication, see [Server Actions and Bidirectional Communication](#5.4).\n\nThis page focuses on the high-level architecture, the relationship between Fizz and Flight, and the core request/response model shared by both systems.\n\n## The Two SSR Systems\n\nReact provides two distinct server-side rendering systems that serve different purposes:\n\n| System | Purpose | Output Format | Primary Use Case |\n|--------|---------|---------------|------------------|\n| **Fizz** | HTML Streaming SSR | HTML + JavaScript instructions | Traditional SSR with progressive hydration |\n| **Flight** | Server Components Serialization | Binary/JSON protocol (RSC wire format) | Server Components tree transmission |\n\n**Fizz** (`ReactFizzServer`) renders React components to HTML, streaming the output progressively with support for Suspense boundaries. It generates hydration instructions embedded in `<script>` tags to enable client-side React to attach to the server-rendered HTML.\n\n**Flight** (`ReactFlightServer`) serializes Server Component trees into a compact streaming protocol. It handles module references (Client Components) and streams chunks representing the component tree structure, allowing clients to reconstruct the React element tree without executing Server Component code.\n\nThese systems can be used independently or together. In React Server Components applications, Flight renders the Server Component tree, which may reference Client Components. When rendering to HTML, Fizz consumes the Flight stream and renders Client Components to HTML.\n\nSources: [packages/react-server/src/ReactFizzServer.js:1-100](), [packages/react-server/src/ReactFlightServer.js:1-100]()\n\n## Architecture Overview\n\n```mermaid\ngraph TB\n    subgraph "Server Environment"\n        SC["Server Components<br/>(React Server)"]\n        FlightServer["ReactFlightServer<br/>packages/react-server/src/ReactFlightServer.js"]\n        FizzServer["ReactFizzServer<br/>packages/react-server/src/ReactFizzServer.js"]\n    end\n    \n    subgraph "Network Layer"\n        FlightStream["Flight Stream<br/>RSC Protocol Chunks"]\n        HTMLStream["HTML Stream<br/>+ Hydration Instructions"]\n    end\n    \n    subgraph "Client Environment"\n        FlightClient["ReactFlightClient<br/>packages/react-client/src/ReactFlightClient.js"]\n        Hydration["ReactFiberHydrationContext<br/>Client-side Hydration"]\n        ClientComponents["Client Components<br/>(Browser React)"]\n    end\n    \n    SC -->|"serialize"| FlightServer\n    FlightServer -->|"stream chunks"| FlightStream\n    FlightStream -->|"deserialize"| FlightClient\n    FlightClient -->|"React elements"| ClientComponents\n    \n    SC -->|"render to HTML"| FizzServer\n    FizzServer -->|"stream HTML"| HTMLStream\n    HTMLStream -->|"hydrateRoot()"| Hydration\n    Hydration -->|"attach events"| ClientComponents\n    \n    FlightStream -.->|"integrated mode"| FizzServer\n```\n\n**Diagram: Server-Side Rendering Architecture**\n\nIn an integrated Server Components application, the flow works as follows:\n\n1. Server Components execute in the React Server environment\n2. Flight serializes the Server Component tree, including references to Client Components\n3. Fizz can consume the Flight stream and render Client Components to HTML\n4. The client receives both the HTML (for immediate display) and Flight chunks (for interactivity)\n5. Client-side React hydrates the HTML and processes Flight chunks to reconstruct the component tree\n\nSources: [packages/react-server/src/ReactFlightServer.js:1-200](), [packages/react-server/src/ReactFizzServer.js:1-200](), [packages/react-client/src/ReactFlightClient.js:1-200]()\n\n## Request and Response Model\n\nBoth Fizz and Flight use a request/response architecture with a task-based rendering model:\n\n```mermaid\ngraph LR\n    subgraph "Request Creation"\n        Model["ReactClientValue<br/>or ReactNodeList"]\n        CreateReq["createRequest()<br/>or createPrerenderRequest()"]\n        Req["Request Object"]\n    end\n    \n    subgraph "Request State"\n        Status["status: OPENING | OPEN<br/>| ABORTING | CLOSING | CLOSED"]\n        Tasks["pingedTasks: Array&lt;Task&gt;<br/>abortableTasks: Set&lt;Task&gt;"]\n        Chunks["completedChunks:<br/>Regular | Import | Hint | Error"]\n    end\n    \n    subgraph "Rendering Loop"\n        PerformWork["performWork(request)"]\n        RenderTask["renderTask(task)"]\n        EmitChunks["emitChunk() / writeChunk()"]\n    end\n    \n    subgraph "Output Destination"\n        Dest["Destination<br/>(Stream, WritableStream, etc)"]\n        FlushChunks["flushCompletedChunks()"]\n    end\n    \n    Model --> CreateReq\n    CreateReq --> Req\n    Req --> Status\n    Req --> Tasks\n    Req --> Chunks\n    \n    Tasks --> PerformWork\n    PerformWork --> RenderTask\n    RenderTask --> Chunks\n    Chunks --> FlushChunks\n    FlushChunks --> Dest\n```\n\n**Diagram: Request/Response Processing Model**\n\n### Request Types\n\nBoth systems define a `Request` type that maintains rendering state:\n\n**Fizz Request** [packages/react-server/src/ReactFizzServer.js:367-408]():\n- Manages HTML generation and Suspense boundaries\n- Tracks segments, boundaries, and preamble state\n- Coordinates progressive streaming of HTML chunks\n\n**Flight Request** [packages/react-server/src/ReactFlightServer.js:571-617]():\n- Manages serialization of Server Component trees\n- Tracks module references and serialized values\n- Coordinates streaming of protocol chunks\n\n### Request Lifecycle\n\n```mermaid\nstateDiagram-v2\n    [*] --> OPENING: createRequest()\n    OPENING --> OPEN: startWork()\n    OPEN --> OPEN: performWork()\n    OPEN --> ABORTING: abort()\n    OPEN --> CLOSING: all tasks complete\n    ABORTING --> CLOSED: cleanup\n    CLOSING --> CLOSED: flushCompleted()\n    CLOSED --> [*]\n```\n\n**Diagram: Request Status Lifecycle**\n\nSources: [packages/react-server/src/ReactFizzServer.js:360-554](), [packages/react-server/src/ReactFlightServer.js:527-841]()\n\n## Task-Based Rendering\n\nBoth systems use a task queue to manage rendering work:\n\n### Task Structure\n\n**Fizz Tasks** [packages/react-server/src/ReactFizzServer.js:279-331]():\n```\nRenderTask {\n  node: ReactNodeList          // Content to render\n  blockedSegment: Segment      // Output target\n  blockedBoundary: Root | SuspenseBoundary\n  keyPath: Root | KeyNode      // For tracking postponed content\n  formatContext: FormatContext // HTML/SVG/MathML context\n  thenableState: ThenableState // Suspense tracking\n}\n\nReplayTask {\n  replay: ReplaySet           // Resume from postponed state\n  node: ReactNodeList\n  blockedBoundary: Root | SuspenseBoundary\n  // Similar fields for context\n}\n```\n\n**Flight Tasks** [packages/react-server/src/ReactFlightServer.js:533-549]():\n```\nTask {\n  id: number\n  status: PENDING | COMPLETED | ABORTED | ERRORED | RENDERING\n  model: ReactClientValue      // Value to serialize\n  ping: () => void            // Resume after suspending\n  keyPath: ReactKey           // Parent component keys\n  formatContext: FormatContext\n  thenableState: ThenableState\n}\n```\n\n### Work Loop\n\nBoth systems process tasks in a similar pattern:\n\n1. **Dequeue**: Pop tasks from `request.pingedTasks`\n2. **Render**: Execute task rendering logic (`renderTask`)\n3. **Suspend**: On Suspense, create new task and await Promise\n4. **Complete**: Emit chunks/segments when tasks finish\n5. **Flush**: Write completed output to destination\n\nSources: [packages/react-server/src/ReactFizzServer.js:791-802](), [packages/react-server/src/ReactFlightServer.js:2420-2500]()\n\n## Streaming Output Formats\n\n### Fizz HTML Format\n\nFizz outputs HTML with embedded JavaScript instructions:\n\n```\n<!DOCTYPE html><html><head>...</head><body>\n<div>Server-rendered content</div>\n<!--$?--><template id="B:0"></template>\n<div>Fallback for suspended content...</div>\n<!--/$-->\n\n<script>\n$RC=function(b,c,e){/* completeBoundary runtime */};\n</script>\n<script>\n$RC("B:0","S:1")\n</script>\n```\n\nInstructions include:\n- `$RC`: Complete boundary (reveal suspended content)\n- `$RX`: Client render boundary (error fallback)\n- `$RS`: Complete segment\n- Form state markers for progressive enhancement\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:1-300]()\n\n### Flight Protocol Format\n\nFlight outputs newline-delimited chunks with a typed protocol:\n\n```\n0:{"id":"./ClientComponent.js#","chunks":["client123"],"name":"default"}\n1:I["module1","ClientComponent",123]\n2:{"type":"div","props":{"children":"Hello"}}\n3:@2\n```\n\nChunk types:\n- **Model row** (`id:json`): JSON-encoded value\n- **Module row** (`id:I[...]`): Client module reference\n- **Error row** (`id:E{...}`): Serialized error\n- **Reference** (`@id`): Pointer to another chunk\n- **Promise row** (`id:@...`): Async value placeholder\n- **Debug info** (`id:D{...}`): DEV-only metadata\n\nSources: [packages/react-server/src/ReactFlightServer.js:2700-3200](), [packages/react-client/src/ReactFlightClient.js:149-164]()\n\n## Request Creation APIs\n\n### Fizz APIs\n\n| Function | Purpose | Environment |\n|----------|---------|-------------|\n| `renderToPipeableStream()` | Node.js streams | server.node |\n| `renderToReadableStream()` | Web Streams API | server.browser, server.edge |\n| `renderToStaticMarkup()` | Non-interactive HTML | server.* |\n| `renderToString()` | Synchronous render | server.* |\n\n**Prerendering:**\n- `createPrerenderRequest()` [packages/react-server/src/ReactFizzServer.js:623-655](): Creates request that tracks postponed holes for resume\n- `resumeRequest()` [packages/react-server/src/ReactFizzServer.js:657-749](): Resumes from `PostponedState`\n\nSources: [packages/react-dom/src/server/ReactDOMFizzServerNode.js:1-300](), [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js:1-200]()\n\n### Flight APIs\n\n| Function | Purpose | Environment |\n|----------|---------|-------------|\n| `renderToReadableStream()` | Render to Web Stream | server.browser, server.edge, server.node |\n| `decodeReply()` | Decode form data/request body | server.* |\n| `decodeAction()` | Decode server action reference | server.* |\n\n**Prerendering:**\n- `createPrerenderRequest()` [packages/react-server/src/ReactFlightServer.js:811-841](): Creates request with `onAllReady` and `onFatalError` callbacks\n- Prerender can be resumed or converted to static output\n\nSources: [packages/react-server/src/ReactFlightServer.js:781-841]()\n\n## Integration Points\n\n### Fizz + Flight Integration\n\nWhen rendering Server Components to HTML:\n\n```mermaid\ngraph TB\n    subgraph "Server Render"\n        ServerComp["Server Component Tree"]\n        FlightRender["Flight: renderToReadableStream()"]\n        FlightStream["Flight Stream<br/>(RSC Protocol)"]\n    end\n    \n    subgraph "HTML Generation"\n        FizzConsume["Fizz consumes Flight stream"]\n        ClientCompRender["Render Client Components"]\n        HTMLOutput["HTML + Inline Flight Data"]\n    end\n    \n    subgraph "Client Hydration"\n        ParseHTML["Parse HTML"]\n        ReadFlight["Read inline Flight data"]\n        Reconstruct["Reconstruct component tree"]\n        Hydrate["hydrateRoot()"]\n    end\n    \n    ServerComp --> FlightRender\n    FlightRender --> FlightStream\n    FlightStream --> FizzConsume\n    FizzConsume --> ClientCompRender\n    ClientCompRender --> HTMLOutput\n    \n    HTMLOutput --> ParseHTML\n    HTMLOutput --> ReadFlight\n    ParseHTML --> Hydrate\n    ReadFlight --> Reconstruct\n    Reconstruct --> Hydrate\n```\n\n**Diagram: Integrated SSR with Server Components**\n\nThe Flight stream can be:\n1. **Embedded**: Serialized into `<script>` tags in HTML for immediate consumption\n2. **Separate**: Sent as a parallel stream for progressive enhancement\n3. **Preloaded**: Generated during build and embedded in HTML\n\nSources: [packages/react-server/src/ReactFizzServer.js:1-100](), [packages/react-server/src/ReactFlightServer.js:1-100]()\n\n### Host Configuration\n\nBoth systems use host configs for platform adaptation:\n\n**Fizz Host Config** [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js]():\n- HTML generation (`pushStartInstance`, `pushEndInstance`)\n- Resource management (scripts, stylesheets, preloads)\n- Streaming format (inline scripts vs external runtime)\n\n**Flight Host Config** [packages/react-server/src/ReactFlightServerConfig.js]():\n- Module reference resolution (`resolveClientReferenceMetadata`)\n- Bundler integration (`getClientReferenceKey`)\n- Request storage (`supportsRequestStorage`, `requestStorage`)\n\n## Error Handling and Suspense\n\nBoth systems handle errors and Suspense similarly:\n\n### Suspense Boundaries\n\n**Fizz** [packages/react-server/src/ReactFizzServer.js:804-849]():\n- Creates `SuspenseBoundary` with fallback content\n- Tracks pending tasks within boundary\n- Streams fallback immediately, content when ready\n- Emits completion instruction to reveal content\n\n**Flight** [packages/react-server/src/ReactFlightServer.js:1034-1136]():\n- Serializes Thenable as Promise reference\n- Creates task for resolved value\n- Client reconstructs async boundary\n\n### Error Recovery\n\nBoth systems:\n1. Catch errors during rendering\n2. Call `onError` callback with error info\n3. Emit error chunks/boundaries\n4. Allow client-side error boundaries to handle\n\nSources: [packages/react-server/src/ReactFizzServer.js:2100-2300](), [packages/react-server/src/ReactFlightServer.js:2600-2800]()\n\n## Performance Considerations\n\n### Progressive Streaming\n\n**Fizz** progressively flushes:\n- Shell (initial content) as soon as possible\n- Suspense boundaries when they resolve\n- Resources (scripts, styles) with proper priorities\n\n**Flight** streams:\n- Chunks as components complete\n- Lazy module references\n- Async boundaries incrementally\n\n### Chunking Strategy\n\n**Fizz** uses `progressiveChunkSize` [packages/react-server/src/ReactFizzServer.js:437]():\n- Default: 12,800 bytes (~500ms on 3G)\n- Controls when to flush buffered HTML\n\n**Flight** streams eagerly:\n- Emits chunks immediately when tasks complete\n- No configurable buffering (streams are already buffered)\n\nSources: [packages/react-server/src/ReactFizzServer.js:422-472](), [packages/react-server/src/ReactFlightServer.js:2420-2500]()\n\n## Feature Flags\n\nKey feature flags affecting SSR:\n\n| Flag | Impact |\n|------|--------|\n| `enableHalt` | Allows prerendering to halt on dynamic content |\n| `enablePostpone` | Enables postpone() API for incremental rendering |\n| `enableFizzExternalRuntime` | Uses external runtime script vs inline |\n| `enableAsyncDebugInfo` | Includes async stack traces in DEV |\n| `enableComponentPerformanceTrack` | Tracks component render timing |\n\nSources: [packages/shared/ReactFeatureFlags.js](), [packages/react-server/src/ReactFizzServer.js:177-187](), [packages/react-server/src/ReactFlightServer.js:14-20]()\n\n## Summary\n\nReact\'s server-side rendering encompasses two complementary systems:\n\n- **Fizz** handles HTML streaming with Suspense, progressive hydration, and resource management\n- **Flight** serializes Server Component trees for efficient client consumption\n\nBoth share a task-based rendering model with progressive streaming, Suspense support, and error recovery. They can operate independently or in an integrated mode where Flight output is consumed by Fizz to generate HTML with embedded RSC data.\n\nFor implementation details, see the child pages: [React Fizz (Streaming SSR)](#5.1) for HTML generation, [React Server Components (Flight)](#5.2) for the RSC protocol, [Build Integration for Server Components](#5.3) for bundler integration, and [Server Actions and Bidirectional Communication](#5.4) for client-to-server RPC.\n\n---\n\n# Page: React Fizz (Streaming SSR)\n\n# React Fizz (Streaming SSR)\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js](packages/react-dom-bindings/src/client/ReactDOMComponentTree.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js)\n- [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js](packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js](packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFloat-test.js](packages/react-dom/src/__tests__/ReactDOMFloat-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js](packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js](packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js)\n- [packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js](packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js)\n- [packages/react-dom/src/__tests__/ReactRenderDocument-test.js](packages/react-dom/src/__tests__/ReactRenderDocument-test.js)\n- [packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js](packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js](packages/react-dom/src/server/ReactDOMFizzServerBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBun.js](packages/react-dom/src/server/ReactDOMFizzServerBun.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerEdge.js](packages/react-dom/src/server/ReactDOMFizzServerEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerNode.js](packages/react-dom/src/server/ReactDOMFizzServerNode.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js](packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticEdge.js](packages/react-dom/src/server/ReactDOMFizzStaticEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticNode.js](packages/react-dom/src/server/ReactDOMFizzStaticNode.js)\n- [packages/react-markup/src/ReactFizzConfigMarkup.js](packages/react-markup/src/ReactFizzConfigMarkup.js)\n- [packages/react-noop-renderer/src/ReactNoopServer.js](packages/react-noop-renderer/src/ReactNoopServer.js)\n- [packages/react-reconciler/src/ReactFiberHydrationContext.js](packages/react-reconciler/src/ReactFiberHydrationContext.js)\n- [packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js](packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js)\n- [packages/react-server/src/ReactFizzServer.js](packages/react-server/src/ReactFizzServer.js)\n- [packages/react-server/src/forks/ReactFizzConfig.custom.js](packages/react-server/src/forks/ReactFizzConfig.custom.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nReact Fizz is the streaming server-side rendering (SSR) system that generates HTML progressively, sending content to the client as it becomes ready. This document covers the core Fizz rendering engine, its request/task/segment model, resource management, and platform-specific implementations for Node.js, Web streams, and static generation.\n\nFor information about React Server Components (RSC) and the Flight protocol, see [React Server Components (Flight)](#5.2). For client-side hydration, see [Hydration System](#6.3).\n\n## High-Level Architecture\n\nReact Fizz operates as a streaming HTML renderer that processes React elements and outputs HTML chunks incrementally. The system is platform-agnostic at its core, with platform-specific adapters for different streaming targets.\n\n**Fizz Architecture Overview**\n\n```mermaid\ngraph TB\n    subgraph "Entry Points"\n        NodeEntry["renderToPipeableStream<br/>(Node.js)"]\n        BrowserEntry["renderToReadableStream<br/>(Web Streams)"]\n        StaticEntry["prerender<br/>(Static Generation)"]\n    end\n    \n    subgraph "Core Engine (ReactFizzServer)"\n        CreateRequest["createRequest()<br/>createPrerenderRequest()<br/>resumeRequest()"]\n        StartWork["startWork()<br/>Process pingedTasks"]\n        PerformWork["performWork()<br/>Main work loop"]\n        RenderTask["renderNode()<br/>Component rendering"]\n    end\n    \n    subgraph "State Management"\n        Request["Request<br/>allPendingTasks<br/>pingedTasks<br/>completedBoundaries"]\n        Task["Task<br/>RenderTask | ReplayTask<br/>node, segment, boundary"]\n        Segment["Segment<br/>chunks, children<br/>status, boundary"]\n        Boundary["SuspenseBoundary<br/>pendingTasks<br/>completedSegments<br/>contentState/fallbackState"]\n    end\n    \n    subgraph "Output Management"\n        RenderState["RenderState<br/>hoistableChunks<br/>bootstrapChunks<br/>styles, scripts"]\n        ResumableState["ResumableState<br/>resumable resources<br/>idPrefix, nextFormID"]\n        FlushFunctions["writeCompletedRoot()<br/>writeCompletedBoundary()<br/>writeCompletedSegment()"]\n    end\n    \n    subgraph "Platform Streaming"\n        Destination["Destination<br/>(Writable | Controller)"]\n        StreamConfig["ReactServerStreamConfig<br/>writeChunk()<br/>scheduleWork()"]\n    end\n    \n    NodeEntry --> CreateRequest\n    BrowserEntry --> CreateRequest\n    StaticEntry --> CreateRequest\n    \n    CreateRequest --> Request\n    CreateRequest --> StartWork\n    StartWork --> PerformWork\n    PerformWork --> RenderTask\n    \n    RenderTask --> Task\n    Task --> Segment\n    Task --> Boundary\n    \n    Request --> RenderState\n    Request --> ResumableState\n    \n    PerformWork --> FlushFunctions\n    FlushFunctions --> StreamConfig\n    StreamConfig --> Destination\n    \n    Boundary --> RenderState\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:1-4000](), [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:1-500](), [packages/react-dom/src/server/ReactDOMFizzServerNode.js:1-300]()\n\n## Core Data Structures\n\n### Request\n\nThe `Request` is the top-level rendering context that tracks the entire SSR operation.\n\n**Request Structure**\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `destination` | `Destination \\| null` | Output stream target |\n| `resumableState` | `ResumableState` | Serializable state for resuming |\n| `renderState` | `RenderState` | Per-request working state |\n| `allPendingTasks` | `number` | Total tasks to complete |\n| `pendingRootTasks` | `number` | Tasks blocking shell completion |\n| `pingedTasks` | `Array<Task>` | High-priority tasks ready to work |\n| `completedBoundaries` | `Array<SuspenseBoundary>` | Boundaries ready to flush |\n| `clientRenderedBoundaries` | `Array<SuspenseBoundary>` | Errored boundaries |\n| `partialBoundaries` | `Array<SuspenseBoundary>` | Boundaries with partial content |\n| `abortableTasks` | `Set<Task>` | Tasks that can be aborted |\n| `trackedPostpones` | `PostponedHoles \\| null` | For prerendering resume |\n\nSources: [packages/react-server/src/ReactFizzServer.js:359-400]()\n\n### Task Types\n\nTasks represent units of work in the rendering pipeline. There are two types:\n\n**RenderTask vs ReplayTask**\n\n```mermaid\ngraph LR\n    subgraph "RenderTask"\n        RT_replay["replay: null"]\n        RT_node["node: ReactNodeList"]\n        RT_segment["blockedSegment: Segment"]\n        RT_boundary["blockedBoundary: Root|SuspenseBoundary"]\n        RT_render["Writes to segment.chunks"]\n    end\n    \n    subgraph "ReplayTask"\n        RPT_replay["replay: ReplaySet"]\n        RPT_node["node: ReactNodeList"]\n        RPT_segment["blockedSegment: null"]\n        RPT_boundary["blockedBoundary: Root|SuspenseBoundary"]\n        RPT_render["Validates against replay nodes"]\n    end\n    \n    RT_node --> RT_render\n    RT_segment --> RT_render\n    \n    RPT_replay --> RPT_render\n    RPT_node --> RPT_render\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:272-324]()\n\n### Segment\n\nA `Segment` represents a chunk of HTML output with its rendering status.\n\n**Segment Lifecycle**\n\n```mermaid\nstateDiagram-v2\n    [*] --> PENDING: createPendingSegment()\n    PENDING --> RENDERING: Start rendering\n    RENDERING --> COMPLETED: finishedTask()\n    RENDERING --> ERRORED: Error occurred\n    RENDERING --> POSTPONED: postponed()\n    RENDERING --> ABORTED: abortTask()\n    COMPLETED --> FLUSHED: flushSegment()\n    PENDING --> ABORTED: abortTask()\n```\n\n| Status | Value | Description |\n|--------|-------|-------------|\n| `PENDING` | 0 | Waiting to render |\n| `COMPLETED` | 1 | Rendered successfully |\n| `FLUSHED` | 2 | Written to destination |\n| `ABORTED` | 3 | Rendering canceled |\n| `ERRORED` | 4 | Error during rendering |\n| `POSTPONED` | 5 | Postponed for later |\n| `RENDERING` | 6 | Currently rendering |\n\nSources: [packages/react-server/src/ReactFizzServer.js:326-351]()\n\n### SuspenseBoundary\n\nA `SuspenseBoundary` manages Suspense boundaries, tracking pending work and managing fallback rendering.\n\n**SuspenseBoundary Fields**\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `status` | `0 \\| 1 \\| 4 \\| 5` | PENDING, COMPLETED, CLIENT_RENDERED, POSTPONED |\n| `rootSegmentID` | `number` | ID for boundary\'s root segment |\n| `pendingTasks` | `number` | Tasks blocking completion |\n| `completedSegments` | `Array<Segment>` | Ready but not flushed |\n| `byteSize` | `number` | Total size for inlining decisions |\n| `defer` | `boolean` | Never inline deferred boundaries |\n| `contentState` | `HoistableState` | Resources for content |\n| `fallbackState` | `HoistableState` | Resources for fallback |\n| `fallbackAbortableTasks` | `Set<Task>` | Cancel if content completes |\n| `errorDigest` | `?string` | Error hash if errored |\n\nSources: [packages/react-server/src/ReactFizzServer.js:248-270]()\n\n## Rendering Pipeline\n\nThe rendering pipeline flows from request creation through task processing to HTML output.\n\n**Complete Rendering Flow**\n\n```mermaid\ngraph TB\n    subgraph "1. Initialization"\n        Create["createRequest(children, options)"]\n        RootSegment["createPendingSegment()<br/>Root segment"]\n        RootTask["createRenderTask()<br/>Initial task"]\n        PushTask["pingedTasks.push(rootTask)"]\n    end\n    \n    subgraph "2. Work Loop"\n        StartWork["startWork(request)"]\n        PerformWork["performWork(request)"]\n        ProcessTask["processTask(task)"]\n        RenderNode["renderNode(request, task, node)"]\n    end\n    \n    subgraph "3. Component Rendering"\n        CheckType["Check node type<br/>(Element, Suspense, etc.)"]\n        RenderElement["renderElement(task, type, props)"]\n        RenderSuspense["renderSuspenseBoundary(task, props)"]\n        RenderText["pushTextInstance(target, text)"]\n    end\n    \n    subgraph "4. Segment Completion"\n        FinishTask["finishedTask(request, boundary, segment)"]\n        CompleteSegment["segment.status = COMPLETED"]\n        DecrementPending["boundary.pendingTasks--"]\n        CheckBoundary["pendingTasks === 0?"]\n    end\n    \n    subgraph "5. Boundary Completion"\n        CompleteBoundary["boundary.status = COMPLETED"]\n        QueueBoundary["completedBoundaries.push(boundary)"]\n        FlushBoundary["flushCompletedBoundary()"]\n    end\n    \n    subgraph "6. Output"\n        WriteInstructions["writeCompletedBoundaryInstruction()"]\n        WriteSegments["writeCompletedSegmentInstruction()"]\n        FlushDestination["flushBuffered(destination)"]\n    end\n    \n    Create --> RootSegment\n    RootSegment --> RootTask\n    RootTask --> PushTask\n    PushTask --> StartWork\n    \n    StartWork --> PerformWork\n    PerformWork --> ProcessTask\n    ProcessTask --> RenderNode\n    \n    RenderNode --> CheckType\n    CheckType --> RenderElement\n    CheckType --> RenderSuspense\n    CheckType --> RenderText\n    \n    RenderElement --> FinishTask\n    FinishTask --> CompleteSegment\n    CompleteSegment --> DecrementPending\n    DecrementPending --> CheckBoundary\n    \n    CheckBoundary -->|Yes| CompleteBoundary\n    CompleteBoundary --> QueueBoundary\n    QueueBoundary --> FlushBoundary\n    \n    FlushBoundary --> WriteInstructions\n    WriteInstructions --> WriteSegments\n    WriteSegments --> FlushDestination\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:548-800](), [packages/react-server/src/ReactFizzServer.js:1600-2000]()\n\n## Task Scheduling and Execution\n\n### Task Creation\n\nTasks are created when starting rendering or when Suspense boundaries need to render their content or fallback.\n\n**Task Creation Functions**\n\n```mermaid\ngraph LR\n    subgraph "Task Factories"\n        CreateRenderTask["createRenderTask()<br/>Regular rendering"]\n        CreateReplayTask["createReplayTask()<br/>Resume rendering"]\n    end\n    \n    subgraph "Task Properties"\n        Node["node: ReactNodeList<br/>What to render"]\n        Segment["blockedSegment: Segment<br/>Where to write (render only)"]\n        Boundary["blockedBoundary: Root|SuspenseBoundary<br/>Parent boundary"]\n        Context["context: ContextSnapshot<br/>treeContext, legacyContext"]\n        FormatContext["formatContext: FormatContext<br/>HTML/SVG/MathML context"]\n        KeyPath["keyPath: Root|KeyNode<br/>Component key path"]\n    end\n    \n    subgraph "Task Lifecycle"\n        AddToAbortSet["abortSet.add(task)"]\n        IncrementPending["allPendingTasks++<br/>boundary.pendingTasks++"]\n        PingTask["pingTask(request, task)<br/>Schedule work"]\n    end\n    \n    CreateRenderTask --> Node\n    CreateRenderTask --> Segment\n    CreateReplayTask --> Node\n    \n    Node --> AddToAbortSet\n    Segment --> IncrementPending\n    Boundary --> IncrementPending\n    IncrementPending --> PingTask\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:843-953]()\n\n### performWork Loop\n\nThe `performWork` function is the main work loop that processes tasks and flushes output.\n\n**performWork Execution**\n\n```mermaid\ngraph TB\n    Entry["performWork(request)"]\n    \n    subgraph "Task Processing"\n        CheckStatus["request.status === OPEN?"]\n        PopTask["task = pingedTasks.pop()"]\n        HasTask["task !== undefined?"]\n        \n        SetCurrentRequest["currentRequest = request"]\n        RenderWithResumeId["renderNodeWithResumeId(request, task)"]\n        \n        RerenderTask["Try rerender task<br/>if it suspended"]\n        ClearCurrentRequest["currentRequest = null"]\n    end\n    \n    subgraph "Flushing Boundaries"\n        FlushClientRendered["flushClientRenderedBoundaries()<br/>Error boundaries"]\n        FlushCompleted["flushCompletedBoundaries()<br/>Ready boundaries"]\n        FlushPartial["flushPartialBoundaries()<br/>Partial boundaries"]\n    end\n    \n    subgraph "Completion"\n        AllComplete["allPendingTasks === 0?"]\n        CloseRequest["request.status = CLOSED<br/>close(destination)"]\n        FlushHeaders["flushHeaders()<br/>Send Link headers"]\n    end\n    \n    Entry --> CheckStatus\n    CheckStatus -->|Yes| PopTask\n    PopTask --> HasTask\n    HasTask -->|Yes| SetCurrentRequest\n    SetCurrentRequest --> RenderWithResumeId\n    RenderWithResumeId --> RerenderTask\n    RerenderTask --> ClearCurrentRequest\n    ClearCurrentRequest --> PopTask\n    \n    HasTask -->|No| FlushClientRendered\n    FlushClientRendered --> FlushCompleted\n    FlushCompleted --> FlushPartial\n    FlushPartial --> AllComplete\n    \n    AllComplete -->|Yes| CloseRequest\n    CloseRequest --> FlushHeaders\n    \n    CheckStatus -->|No| FlushHeaders\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:2800-3000]()\n\n### renderNode Dispatch\n\nThe `renderNode` function dispatches to specialized rendering logic based on node type.\n\n**Node Type Dispatch**\n\n| Node Type | Symbol | Rendering Function |\n|-----------|--------|-------------------|\n| React Element | `REACT_ELEMENT_TYPE` | `renderElement(request, task, type, props, ref)` |\n| Lazy Component | `REACT_LAZY_TYPE` | `renderLazyComponent(request, task, lazyComponent)` |\n| Suspense | `REACT_SUSPENSE_TYPE` | `renderSuspenseBoundary(request, task, props)` |\n| SuspenseList | `REACT_SUSPENSE_LIST_TYPE` | `renderSuspenseList(request, task, props)` |\n| Fragment | `REACT_FRAGMENT_TYPE` | `renderNodeFragment(request, task, children)` |\n| Provider | `REACT_CONTEXT_TYPE` | `pushProvider(context, value)` |\n| Forward Ref | `REACT_FORWARD_REF_TYPE` | `renderForwardRef(request, task, render, props, ref)` |\n| Memo | `REACT_MEMO_TYPE` | `renderMemo(request, task, type, props)` |\n| Portal | `REACT_PORTAL_TYPE` | Error - not supported |\n| String/Number | primitive | `pushTextInstance(segment, text)` |\n| Array | `isArray(node)` | `renderChildrenArray(request, task, children)` |\n| Async Iterable | `node[ASYNC_ITERATOR]` | `renderAsyncIterable(request, task, iterable)` |\n\nSources: [packages/react-server/src/ReactFizzServer.js:1800-2400]()\n\n## Suspense Boundary Management\n\nSuspense boundaries enable streaming and progressive rendering by allowing parts of the tree to suspend while other parts complete.\n\n**Suspense Boundary Rendering Flow**\n\n```mermaid\ngraph TB\n    subgraph "Boundary Setup"\n        CreateBoundary["createSuspenseBoundary(request, row, fallbackTasks, defer)"]\n        ContentSegment["Create content segment<br/>segment.boundary = boundary"]\n        FallbackSegment["Create fallback segment"]\n        \n        ContentTask["createRenderTask(content)<br/>boundary.pendingTasks++"]\n        FallbackTask["createRenderTask(fallback)<br/>fallbackAbortableTasks.add()"]\n    end\n    \n    subgraph "Content Rendering"\n        RenderContent["Render content children"]\n        ContentSuspends["Content suspends?"]\n        ContentComplete["Content completes<br/>boundary.pendingTasks--"]\n    end\n    \n    subgraph "Boundary States"\n        Pending["PENDING<br/>Still waiting"]\n        Completed["COMPLETED<br/>Content ready<br/>cancelFallbackTasks()"]\n        ClientRendered["CLIENT_RENDERED<br/>Error occurred"]\n    end\n    \n    subgraph "Output Decision"\n        CheckEligible["isEligibleForOutlining()<br/>byteSize > 500"]\n        Inline["Inline content<br/>Write directly"]\n        Outline["Outline boundary<br/>Write template + script"]\n    end\n    \n    CreateBoundary --> ContentSegment\n    CreateBoundary --> FallbackSegment\n    ContentSegment --> ContentTask\n    FallbackSegment --> FallbackTask\n    \n    ContentTask --> RenderContent\n    RenderContent --> ContentSuspends\n    ContentSuspends -->|Yes| Pending\n    ContentSuspends -->|No| ContentComplete\n    \n    ContentComplete --> Completed\n    Completed --> CheckEligible\n    \n    CheckEligible -->|Small| Inline\n    CheckEligible -->|Large| Outline\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:796-841](), [packages/react-server/src/ReactFizzServer.js:2500-2700]()\n\n### Boundary Completion and Flushing\n\nWhen a boundary completes, it moves through queues before being flushed to the output.\n\n**Boundary Flush Process**\n\n```mermaid\ngraph LR\n    subgraph "Completion"\n        DecPending["boundary.pendingTasks--"]\n        CheckZero["pendingTasks === 0?"]\n        SetCompleted["boundary.status = COMPLETED"]\n    end\n    \n    subgraph "Queueing"\n        QueueCompleted["completedBoundaries.push(boundary)"]\n        CheckShell["Shell completed?"]\n        QueuePartial["partialBoundaries.push(boundary)"]\n    end\n    \n    subgraph "Flushing"\n        FlushCompleted["flushCompletedBoundary(request, destination, boundary)"]\n        WriteStart["writeStartCompletedSuspenseBoundary()"]\n        WriteSegments["Write all completedSegments"]\n        WriteEnd["writeEndCompletedSuspenseBoundary()"]\n        WriteInstruction["writeCompletedBoundaryInstruction(boundaryID, contentSegmentID)"]\n    end\n    \n    DecPending --> CheckZero\n    CheckZero -->|Yes| SetCompleted\n    SetCompleted --> CheckShell\n    CheckShell -->|Complete| QueueCompleted\n    CheckShell -->|Not complete| QueuePartial\n    \n    QueueCompleted --> FlushCompleted\n    FlushCompleted --> WriteStart\n    WriteStart --> WriteSegments\n    WriteSegments --> WriteEnd\n    WriteEnd --> WriteInstruction\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:3200-3500]()\n\n## Resource Management\n\nReact Fizz manages resources (scripts, stylesheets, preloads) through the `RenderState` and `ResumableState` structures to optimize loading and prevent duplicates.\n\n**Resource State Architecture**\n\n```mermaid\ngraph TB\n    subgraph "ResumableState (Serializable)"\n        DNS["dnsResources: {[key]: Exists}<br/>DNS prefetches"]\n        Connect["connectResources:<br/>default/anonymous/credentials<br/>{[key]: Exists}"]\n        Style["styleResources: {[key]: Exists|Preloaded}"]\n        Script["scriptResources: {[key]: Exists|Preloaded}"]\n        ModuleScript["moduleScriptResources: {[key]: Exists|Preloaded}"]\n        Image["imageResources: {[key]: Preloaded}"]\n    end\n    \n    subgraph "RenderState (Per-Request)"\n        Preconnects["preconnects: Set<Resource><br/>Flush early"]\n        FontPreloads["fontPreloads: Set<Resource><br/>Flush early"]\n        HighImagePreloads["highImagePreloads: Set<Resource><br/>Flush early"]\n        Styles["styles: Map<string, StyleQueue><br/>Stylesheets + dependencies"]\n        Scripts["scripts: Set<Resource><br/>Script tags"]\n        BulkPreloads["bulkPreloads: Set<Resource><br/>Regular preloads"]\n    end\n    \n    subgraph "HoistableState (Per-Boundary)"\n        BoundaryStyles["styles: Set<string><br/>Required stylesheets"]\n        BoundaryScripts["scripts: Set<string><br/>Required scripts"]\n    end\n    \n    subgraph "Headers"\n        HeadersObj["headers: {<br/>preconnects: string,<br/>fontPreloads: string,<br/>highImagePreloads: string,<br/>remainingCapacity: number<br/>}"]\n        OnHeaders["onHeaders(headers: HeadersDescriptor)"]\n    end\n    \n    DNS --> Preconnects\n    Connect --> Preconnects\n    Style --> Styles\n    Script --> Scripts\n    Image --> HighImagePreloads\n    \n    Styles --> BoundaryStyles\n    Scripts --> BoundaryScripts\n    \n    Preconnects --> HeadersObj\n    FontPreloads --> HeadersObj\n    HighImagePreloads --> HeadersObj\n    HeadersObj --> OnHeaders\n```\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:260-310](), [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:148-234]()\n\n### Resource Deduplication\n\nResources are tracked in `ResumableState` to prevent duplicate output across boundaries and resume scenarios.\n\n**Resource Tracking Types**\n\n| Type | Tracked By | Values |\n|------|-----------|--------|\n| DNS Prefetch | `href` | `EXISTS` (null) |\n| Preconnect | `href` + `crossOrigin` | `EXISTS` (null) |\n| Stylesheet | `href` | `EXISTS` \\| `[crossOrigin, integrity]` |\n| Script | `src` | `EXISTS` \\| `[crossOrigin, integrity]` |\n| Module | `src` | `EXISTS` \\| `[crossOrigin, integrity]` |\n| Image Preload | `href` + `imageSrcSet` + `imageSizes` | `[]` (empty array) |\n| Font Preload | `href` | `[]` (empty array) |\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:236-258]()\n\n### Resource Flushing Order\n\nResources are flushed in a specific order to optimize page load performance.\n\n**Resource Flush Sequence**\n\n```mermaid\ngraph TB\n    Start["Start Flushing"]\n    \n    subgraph "Shell Phase"\n        Charset["1. charsetChunks<br/><meta charset>"]\n        Viewport["2. viewportChunks<br/><meta viewport>"]\n        EarlyPreconnects["3. preconnects (Set)<br/><link rel=preconnect>"]\n        EarlyFontPreloads["4. fontPreloads (Set)<br/><link rel=preload as=font>"]\n        EarlyImagePreloads["5. highImagePreloads (Set)<br/><link rel=preload as=image fetchpriority=high>"]\n        Hoistables["6. hoistableChunks<br/>Other <link>/<meta> tags"]\n    end\n    \n    subgraph "Boundary Phase"\n        BoundaryStyles["7. Boundary styles<br/>writeHoistablesForBoundary()"]\n        BoundaryScripts["8. Boundary scripts<br/>Required dependencies"]\n    end\n    \n    subgraph "Late Resources"\n        BulkPreloads["9. bulkPreloads<br/>Regular priority preloads"]\n        BootstrapScripts["10. bootstrapScripts<br/>Application initialization"]\n    end\n    \n    Start --> Charset\n    Charset --> Viewport\n    Viewport --> EarlyPreconnects\n    EarlyPreconnects --> EarlyFontPreloads\n    EarlyFontPreloads --> EarlyImagePreloads\n    EarlyImagePreloads --> Hoistables\n    Hoistables --> BoundaryStyles\n    BoundaryStyles --> BoundaryScripts\n    BoundaryScripts --> BulkPreloads\n    BulkPreloads --> BootstrapScripts\n```\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:3800-4200]()\n\n## Platform-Specific Implementations\n\nReact Fizz has multiple entry points for different JavaScript environments, each adapting the core engine to platform-specific streaming APIs.\n\n**Platform Entry Points**\n\n```mermaid\ngraph TB\n    subgraph "Node.js"\n        NodeEntry["ReactDOMFizzServerNode.js<br/>renderToPipeableStream()"]\n        NodeStream["Node Writable Stream"]\n        NodeDestination["Destination = Writable"]\n    end\n    \n    subgraph "Web Browsers / Workers"\n        BrowserEntry["ReactDOMFizzServerBrowser.js<br/>renderToReadableStream()"]\n        WebStream["ReadableStream (Web Streams API)"]\n        WebDestination["Destination = ReadableStreamController"]\n    end\n    \n    subgraph "Edge Runtime"\n        EdgeEntry["ReactDOMFizzServerEdge.js<br/>renderToReadableStream()"]\n        EdgeStream["ReadableStream"]\n    end\n    \n    subgraph "Bun Runtime"\n        BunEntry["ReactDOMFizzServerBun.js<br/>renderToReadableStream()"]\n        BunStream["ReadableStream"]\n    end\n    \n    subgraph "Static Generation"\n        StaticNode["ReactDOMFizzStaticNode.js<br/>prerender()"]\n        StaticBrowser["ReactDOMFizzStaticBrowser.js<br/>prerender()"]\n        StaticEdge["ReactDOMFizzStaticEdge.js<br/>prerender()"]\n        PrerenderRequest["createPrerenderRequest()<br/>trackedPostpones"]\n    end\n    \n    subgraph "Core Engine"\n        FizzServer["ReactFizzServer.js<br/>createRequest()<br/>performWork()"]\n        StreamConfig["ReactServerStreamConfig<br/>writeChunk()<br/>scheduleWork()"]\n    end\n    \n    NodeEntry --> NodeStream\n    NodeStream --> NodeDestination\n    NodeDestination --> FizzServer\n    \n    BrowserEntry --> WebStream\n    WebStream --> WebDestination\n    WebDestination --> FizzServer\n    \n    EdgeEntry --> EdgeStream\n    BunEntry --> BunStream\n    EdgeStream --> FizzServer\n    BunStream --> FizzServer\n    \n    StaticNode --> PrerenderRequest\n    StaticBrowser --> PrerenderRequest\n    StaticEdge --> PrerenderRequest\n    PrerenderRequest --> FizzServer\n    \n    FizzServer --> StreamConfig\n```\n\nSources: [packages/react-dom/src/server/ReactDOMFizzServerNode.js:1-300](), [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js:1-200](), [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js:1-200]()\n\n### Node.js: renderToPipeableStream\n\nThe Node.js implementation uses Node\'s `Writable` stream interface with backpressure support.\n\n**Node.js Streaming Flow**\n\n```mermaid\ngraph LR\n    subgraph "API"\n        Render["renderToPipeableStream(children, options)"]\n        PipeableStream["PipeableStream<br/>{pipe, abort}"]\n    end\n    \n    subgraph "Setup"\n        CreateReq["createRequestImpl()<br/>createResumableState()<br/>createRenderState()"]\n        StartWork["startWork(request)"]\n    end\n    \n    subgraph "Streaming"\n        Pipe["pipe(destination: Writable)"]\n        DrainHandler["\'drain\' event<br/>startFlowing()"]\n        ErrorHandler["\'error\' event<br/>abort()"]\n        CloseHandler["\'close\' event<br/>abort()"]\n    end\n    \n    subgraph "Callbacks"\n        OnShellReady["onShellReady()<br/>Initial HTML ready"]\n        OnAllReady["onAllReady()<br/>All content ready"]\n        OnShellError["onShellError(error)<br/>Shell failed"]\n    end\n    \n    Render --> CreateReq\n    CreateReq --> StartWork\n    StartWork --> PipeableStream\n    \n    PipeableStream --> Pipe\n    Pipe --> DrainHandler\n    Pipe --> ErrorHandler\n    Pipe --> CloseHandler\n    \n    StartWork --> OnShellReady\n    StartWork --> OnAllReady\n    StartWork --> OnShellError\n```\n\nSources: [packages/react-dom/src/server/ReactDOMFizzServerNode.js:131-166]()\n\n### Browser/Edge: renderToReadableStream\n\nThe browser implementation uses the Web Streams API\'s `ReadableStream` with a bytes source.\n\n**Web Streams Flow**\n\n```mermaid\ngraph LR\n    subgraph "API"\n        Render["renderToReadableStream(children, options)"]\n        Promise["Promise<ReactDOMServerReadableStream>"]\n        ReadableStream["ReadableStream & {allReady: Promise}"]\n    end\n    \n    subgraph "Controller"\n        BytesSource["ReadableStream({type: \'bytes\'})"]\n        Pull["pull(controller)<br/>startFlowing(request, controller)"]\n        Cancel["cancel(reason)<br/>abort(request, reason)"]\n    end\n    \n    subgraph "Promises"\n        ShellPromise["Shell promise<br/>resolve(stream)"]\n        AllReadyPromise["allReady promise<br/>resolve when done"]\n    end\n    \n    subgraph "Error Handling"\n        OnShellReady["onShellReady()<br/>resolve shell promise"]\n        OnShellError["onShellError(error)<br/>reject shell promise"]\n        OnFatalError["onFatalError(error)<br/>reject allReady"]\n    end\n    \n    Render --> BytesSource\n    BytesSource --> Pull\n    BytesSource --> Cancel\n    \n    Pull --> OnShellReady\n    OnShellReady --> ShellPromise\n    ShellPromise --> Promise\n    Promise --> ReadableStream\n    \n    ReadableStream --> AllReadyPromise\n    OnFatalError --> AllReadyPromise\n```\n\nSources: [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js:75-165]()\n\n## Prerendering and Resumability\n\nPrerendering generates static HTML while tracking postponed boundaries for later resumption.\n\n**Prerender Architecture**\n\n```mermaid\ngraph TB\n    subgraph "Prerender Request"\n        CreatePrerender["createPrerenderRequest(children)<br/>trackedPostpones = {<br/>  workingMap: Map<KeyNode, ReplayNode>,<br/>  rootNodes: Array<ReplayNode>,<br/>  rootSlots: ResumeSlots<br/>}"]\n    end\n    \n    subgraph "Tracking Postponed Holes"\n        ComponentKey["keyPath: Root|KeyNode<br/>Unique path in tree"]\n        ReplayNode["ReplayNode<br/>[name, key, children, slots]"]\n        ReplaySuspense["ReplaySuspenseBoundary<br/>[name, key, children, contentSlots, fallback, rootSegmentID]"]\n        WorkingMap["workingMap.set(keyPath, replayNode)"]\n    end\n    \n    subgraph "Completion"\n        PostponedState["getPostponedState(request)<br/>{<br/>  replayNodes,<br/>  replaySlots,<br/>  resumableState,<br/>  nextSegmentId,<br/>  ...formatContext<br/>}"]\n    end\n    \n    subgraph "Resume"\n        ResumeRequest["resumeRequest(children, postponedState)<br/>OR<br/>resumeAndPrerenderRequest(children, postponedState)"]\n        CreateReplayTasks["createReplayTask(replay: ReplaySet)<br/>Validates against tracked nodes"]\n        ReplayContinue["Continue from postponed holes"]\n    end\n    \n    CreatePrerender --> ComponentKey\n    ComponentKey --> ReplayNode\n    ReplayNode --> ReplaySuspense\n    ReplaySuspense --> WorkingMap\n    WorkingMap --> PostponedState\n    \n    PostponedState --> ResumeRequest\n    ResumeRequest --> CreateReplayTasks\n    CreateReplayTasks --> ReplayContinue\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:615-770]()\n\n### PostponedState Structure\n\nThe `PostponedState` captures everything needed to resume rendering from postponed boundaries.\n\n**PostponedState Fields**\n\n| Field | Type | Purpose |\n|-------|------|---------|\n| `replayNodes` | `Array<ReplayNode>` | Tree of tracked component keys |\n| `replaySlots` | `ResumeSlots` | Segment IDs to resume |\n| `resumableState` | `ResumableState` | Resource state to continue |\n| `nextSegmentId` | `number` | Next available segment ID |\n| `rootFormatContext` | `FormatContext` | HTML/SVG/MathML context |\n| `progressiveChunkSize` | `number` | Chunk size setting |\n\nSources: [packages/react-server/src/ReactFizzServer.js:3900-4000]()\n\n### ReplayTask Validation\n\nWhen resuming, `ReplayTask` instances validate that the component tree matches the tracked structure.\n\n**Replay Validation Flow**\n\n```mermaid\ngraph TB\n    RenderReplay["renderNode(request, task, node)<br/>task.replay !== null"]\n    \n    subgraph "Key Matching"\n        GetKey["getKeyPath(task)"]\n        FindReplayNode["Find matching ReplayNode<br/>in replay.nodes"]\n        KeyMatches["Keys match?"]\n    end\n    \n    subgraph "Suspense Handling"\n        IsSuspense["Is Suspense boundary?"]\n        ReplaySuspenseBoundary["Cast to ReplaySuspenseBoundary"]\n        ResumeChildren["Create ReplayTask for children"]\n        ResumeFallback["Track fallback if present"]\n    end\n    \n    subgraph "Error Cases"\n        NoMatch["No matching ReplayNode"]\n        AbortReplay["Abort replay<br/>Client render boundary"]\n    end\n    \n    RenderReplay --> GetKey\n    GetKey --> FindReplayNode\n    FindReplayNode --> KeyMatches\n    \n    KeyMatches -->|Yes| IsSuspense\n    KeyMatches -->|No| NoMatch\n    NoMatch --> AbortReplay\n    \n    IsSuspense -->|Yes| ReplaySuspenseBoundary\n    ReplaySuspenseBoundary --> ResumeChildren\n    ReplaySuspenseBoundary --> ResumeFallback\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:1900-2100]()\n\n## Streaming Format and Instructions\n\nReact Fizz can output HTML in two formats: inline scripts or data attributes with an external runtime.\n\n**Streaming Formats**\n\n| Format | Value | Configuration | Use Case |\n|--------|-------|---------------|----------|\n| `ScriptStreamingFormat` | 0 | Default | Inline instructions in `<script>` tags |\n| `DataStreamingFormat` | 1 | `unstable_externalRuntimeSrc` | Instructions via data attributes, separate runtime |\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:122-124]()\n\n### Instruction State Bits\n\nThe `InstructionState` tracks which instructions have been sent to avoid duplication.\n\n**InstructionState Flags**\n\n| Flag | Bit | Purpose |\n|------|-----|---------|\n| `SentCompleteSegmentFunction` | 0b000000001 | `completeSegment` function sent |\n| `SentCompleteBoundaryFunction` | 0b000000010 | `completeBoundary` function sent |\n| `SentClientRenderFunction` | 0b000000100 | `clientRenderBoundary` function sent |\n| `SentStyleInsertionFunction` | 0b000001000 | `completeBoundaryWithStyles` sent |\n| `SentFormReplayingRuntime` | 0b000010000 | Form replaying runtime sent |\n| `SentCompletedShellId` | 0b000100000 | Shell completion marker sent |\n| `SentMarkShellTime` | 0b001000000 | Shell timing marker sent |\n| `NeedUpgradeToViewTransitions` | 0b010000000 | View transitions needed |\n| `SentUpgradeToViewTransitions` | 0b100000000 | View transition upgrade sent |\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:127-136]()\n\n### Boundary Completion Instructions\n\nWhen a boundary completes, an inline script or data attribute instructs the client to reveal the content.\n\n**Boundary Instruction Output**\n\n```mermaid\ngraph LR\n    subgraph "Inline Script Format"\n        ScriptStart["<script>"]\n        FunctionCall["$RC(boundaryID, contentSegmentID)"]\n        ScriptEnd["</script>"]\n    end\n    \n    subgraph "Data Attribute Format"\n        Template["<template id=B:boundaryID"]\n        DataAttr["data-dgst=errorDigest"]\n        DataRender["data-msg=errorMessage"]\n        TemplateEnd["></template>"]\n    end\n    \n    subgraph "Client Processing"\n        Runtime["React runtime on client"]\n        RevealContent["Reveal completed content"]\n        RemoveFallback["Remove fallback"]\n    end\n    \n    ScriptStart --> FunctionCall\n    FunctionCall --> ScriptEnd\n    ScriptEnd --> Runtime\n    \n    Template --> DataAttr\n    DataAttr --> DataRender\n    DataRender --> TemplateEnd\n    TemplateEnd --> Runtime\n    \n    Runtime --> RevealContent\n    RevealContent --> RemoveFallback\n```\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:4500-4700]()\n\n## Error Handling and Recovery\n\nReact Fizz handles errors at different levels with different recovery strategies.\n\n**Error Handling Hierarchy**\n\n```mermaid\ngraph TB\n    subgraph "Error Types"\n        RootError["Root Error<br/>No error boundary"]\n        BoundaryError["Boundary Error<br/>Within Suspense"]\n        FallbackError["Fallback Error<br/>Within fallback"]\n    end\n    \n    subgraph "Root Error Handling"\n        RootAbort["Abort entire request"]\n        RejectPromise["Reject entry point promise"]\n        CloseWithError["closeWithError(destination, error)"]\n    end\n    \n    subgraph "Boundary Error Handling"\n        MarkClientRendered["boundary.status = CLIENT_RENDERED<br/>boundary.errorDigest = digest"]\n        QueueClientRender["clientRenderedBoundaries.push(boundary)"]\n        FlushClientRender["writeClientRenderBoundaryInstruction(boundaryID, digest, message)"]\n    end\n    \n    subgraph "Error Callbacks"\n        OnError["onError(error, errorInfo)<br/>Returns error digest"]\n        OnShellError["onShellError(error)<br/>Called for shell errors"]\n        OnFatalError["onFatalError(error)<br/>Called for unrecoverable errors"]\n    end\n    \n    RootError --> RootAbort\n    RootAbort --> OnShellError\n    RootAbort --> OnFatalError\n    RootAbort --> RejectPromise\n    RejectPromise --> CloseWithError\n    \n    BoundaryError --> MarkClientRendered\n    MarkClientRendered --> OnError\n    OnError --> QueueClientRender\n    QueueClientRender --> FlushClientRender\n    \n    FallbackError --> RootAbort\n```\n\nSources: [packages/react-server/src/ReactFizzServer.js:3600-3800]()\n\n### Error Information\n\nThe `onError` callback receives detailed error information for logging and monitoring.\n\n**ErrorInfo Structure**\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `componentStack` | `string` | Component stack trace |\n| `error` | `mixed` | The thrown error object |\n| `errorInfo.digest` | `?string` | Error hash for client matching |\n\nSources: [packages/react-server/src/ReactFizzServer.js:384-400]()\n\n## Performance Optimizations\n\n### Progressive Chunk Size\n\nThe `progressiveChunkSize` option controls how much HTML is buffered before flushing.\n\n**Default Chunk Size Calculation**\n\nThe default of 12,800 bytes is based on:\n- 3G network speed: ~500 kbits/second\n- Target: Send content every 500ms\n- 500ms  (500 kbits/s)  0.8 (realistic throughput)  0.5 (HTML overhead) / 2 = 12.5kb\n\nSources: [packages/react-server/src/ReactFizzServer.js:414-429]()\n\n### Boundary Inlining\n\nSmall boundaries can be inlined directly instead of being outlined with separate instructions.\n\n**Outlining Eligibility**\n\n```javascript\nfunction isEligibleForOutlining(request, boundary) {\n  return (\n    (boundary.byteSize > 500 ||\n      hasSuspenseyContent(boundary.contentState) ||\n      boundary.defer) &&\n    boundary.preamble === null\n  );\n}\n```\n\n- Boundaries < 500 bytes: Inlined\n- Boundaries  500 bytes: Outlined with instructions\n- Defer boundaries: Always outlined\n- Preamble boundaries: Never outlined (for render-blocking)\n\nSources: [packages/react-server/src/ReactFizzServer.js:466-482]()\n\n### Early Headers\n\nThe `onHeaders` callback allows sending `Link` headers before any HTML for early hints.\n\n**Header Capacity Management**\n\nResources are accumulated into Link headers until capacity is reached:\n- Default capacity: 2000 UTF-16 code units (~2KB)\n- Priority order: preconnects, font preloads, high-priority image preloads\n- Remaining resources flush in HTML `<link>` tags\n\nSources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js:367-489]()\n\n---\n\n# Page: React Server Components (Flight)\n\n# React Server Components (Flight)\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightClient.js](packages/react-client/src/ReactFlightClient.js)\n- [packages/react-client/src/ReactFlightReplyClient.js](packages/react-client/src/ReactFlightReplyClient.js)\n- [packages/react-client/src/ReactFlightTemporaryReferences.js](packages/react-client/src/ReactFlightTemporaryReferences.js)\n- [packages/react-client/src/__tests__/ReactFlight-test.js](packages/react-client/src/__tests__/ReactFlight-test.js)\n- [packages/react-server-dom-esm/src/ReactFlightESMReferences.js](packages/react-server-dom-esm/src/ReactFlightESMReferences.js)\n- [packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js](packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js)\n- [packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js](packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js)\n- [packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js](packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js)\n- [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js](packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js)\n- [packages/react-server/src/ReactFlightReplyServer.js](packages/react-server/src/ReactFlightReplyServer.js)\n- [packages/react-server/src/ReactFlightServer.js](packages/react-server/src/ReactFlightServer.js)\n- [packages/react-server/src/ReactFlightServerTemporaryReferences.js](packages/react-server/src/ReactFlightServerTemporaryReferences.js)\n- [scripts/error-codes/codes.json](scripts/error-codes/codes.json)\n\n</details>\n\n\n\nReact Server Components (Flight) is React\'s protocol and runtime system for executing React components on the server, serializing them into a streamable format, and reconstructing them on the client. This system enables server-side computation while maintaining React\'s component model and interactivity on the client.\n\nFor information about streaming server-side rendering with HTML output, see [React Fizz (Streaming SSR)](#5.1). For traditional server rendering patterns, see [Legacy Server Rendering](#5.3).\n\n## Architecture Overview\n\nReact Flight is the protocol and runtime for React Server Components (RSC). It serializes component trees on the server into a streaming wire format and reconstructs them on the client. The protocol enables server-side components to pass serialized data, client component references, and server function references to the client.\n\n### Server-to-Client Data Flow\n\n```mermaid\ngraph TB\n    SC["Server Component<br/>ReactElement"]\n    Request["Request<br/>(RequestInstance)"]\n    Task["Task<br/>(render unit)"]\n    Model["ReactClientValue<br/>(serializable model)"]\n    Chunks["Chunk Array<br/>(completedRegularChunks)"]\n    Stream["Destination<br/>(WritableStream)"]\n    \n    SC -->|"renderToPipeableStream()"| Request\n    Request -->|"createTask()"| Task\n    Task -->|"renderModelDestructive()"| Model\n    Model -->|"emitChunk()"| Chunks\n    Chunks -->|"flushBuffered()"| Stream\n    \n    subgraph "Client Side"\n        Response["Response<br/>(_chunks Map)"]\n        ReactPromise["ReactPromise<br/>(SomeChunk)"]\n        Element["React Element"]\n    end\n    \n    Stream -->|"processFullRow()"| Response\n    Response -->|"getChunk()"| ReactPromise\n    ReactPromise -->|"initializeModelChunk()"| Element\n```\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:651-777](), [packages/react-client/src/ReactFlightClient.js:245-331](), [packages/react-client/src/ReactFlightClient.js:1437-1580]()\n\n## Core Components\n\n### Flight Server (ReactFlightServer)\n\nThe Flight server executes React components and serializes their output into chunks. The `Request` object maintains serialization state and manages chunk emission.\n\n#### Request Structure\n\n```mermaid\ngraph TD\n    Request["Request"]\n    \n    Request --> status["status: OPENING|OPEN|ABORTING|CLOSING|CLOSED"]\n    Request --> destination["destination: Destination"]\n    Request --> bundlerConfig["bundlerConfig: ClientManifest"]\n    Request --> chunks["Chunk Arrays"]\n    Request --> writtenObjects["writtenObjects: WeakMap"]\n    Request --> cache["cache: Map<Function, mixed>"]\n    \n    chunks --> completedRegularChunks["completedRegularChunks"]\n    chunks --> completedErrorChunks["completedErrorChunks"]\n    chunks --> completedImportChunks["completedImportChunks"]\n    chunks --> completedHintChunks["completedHintChunks"]\n    \n    Task["Task"]\n    Task --> id["id: number"]\n    Task --> model["model: ReactClientValue"]\n    Task --> keyPath["keyPath: ReactKey"]\n    Task --> formatContext["formatContext: FormatContext"]\n```\n\n**Key Types and Functions:**\n\n| Symbol | Type | Purpose |\n|--------|------|---------|\n| `Request` | Object | Central state for a Flight render, tracks chunks and serialization |\n| `Task` | Object | Unit of work for rendering a component tree segment |\n| `ReactClientValue` | Type | Union of all serializable types (elements, primitives, references) |\n| `createRequest()` | Function | Initializes request with `bundlerConfig` and callbacks |\n| `createTask()` | Function | Creates a task with `id`, `model`, and `keyPath` |\n| `renderModelDestructive()` | Function | Main serialization dispatcher, mutates model to JSON-compatible form |\n| `emitChunk()` | Function | Writes chunk rows to destination stream |\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:569-615](), [packages/react-server/src/ReactFlightServer.js:533-549](), [packages/react-server/src/ReactFlightServer.js:1756-1858]()\n\n### Flight Client (ReactFlightClient)\n\nThe Flight client parses the streamed protocol and reconstructs React elements. It maintains a `Response` object with a `Map` of chunks that transition through states.\n\n#### Client Architecture\n\n```mermaid\ngraph TD\n    Response["Response"]\n    \n    Response --> _chunks["_chunks: Map<number, SomeChunk>"]\n    Response --> _bundlerConfig["_bundlerConfig: ServerConsumerModuleMap"]\n    Response --> _fromJSON["_fromJSON: (key, value) => any"]\n    Response --> _stringDecoder["_stringDecoder: StringDecoder"]\n    Response --> _closed["_closed: boolean"]\n    \n    SomeChunk["SomeChunk<T>"]\n    SomeChunk --> PendingChunk["PendingChunk<br/>status: \'pending\'"]\n    SomeChunk --> BlockedChunk["BlockedChunk<br/>status: \'blocked\'"]\n    SomeChunk --> ResolvedModelChunk["ResolvedModelChunk<br/>status: \'resolved_model\'"]\n    SomeChunk --> ResolvedModuleChunk["ResolvedModuleChunk<br/>status: \'resolved_module\'"]\n    SomeChunk --> InitializedChunk["InitializedChunk<br/>status: \'fulfilled\'"]\n    SomeChunk --> ErroredChunk["ErroredChunk<br/>status: \'rejected\'"]\n```\n\n**Key Functions:**\n\n| Function | Input | Output | Purpose |\n|----------|-------|--------|---------|\n| `createFromReadableStream()` | `stream: ReadableStream` | `Promise<T>` | Creates Response, starts stream parsing |\n| `processFullRow()` | `response: Response, row: string` | `void` | Parses row format: `id:tag data` |\n| `parseModelString()` | `response: Response, json: string` | `any` | Parses JSON with special prefixes (`$`, `@`, etc.) |\n| `getChunk()` | `response: Response, id: number` | `SomeChunk<T>` | Retrieves or creates chunk by ID |\n| `initializeModelChunk()` | `chunk: ResolvedModelChunk` | `void` | Converts JSON model to React element |\n| `readChunk()` | `chunk: SomeChunk<T>` | `T` | Synchronously reads initialized chunk or throws |\n\n**Row Parser State Machine:**\n\nThe client processes incoming bytes through a state machine defined by `RowParserState`:\n\n| State | Value | Parsing |\n|-------|-------|---------|\n| `ROW_ID` | `0` | Reading chunk ID (hexadecimal) |\n| `ROW_TAG` | `1` | Reading row type tag (single char) |\n| `ROW_LENGTH` | `2` | Reading length field for binary chunks |\n| `ROW_CHUNK_BY_NEWLINE` | `3` | Reading text chunk until `\\n` |\n| `ROW_CHUNK_BY_LENGTH` | `4` | Reading binary chunk by byte count |\n\n**Sources:** [packages/react-client/src/ReactFlightClient.js:345-383](), [packages/react-client/src/ReactFlightClient.js:146-152](), [packages/react-client/src/ReactFlightClient.js:162-235](), [packages/react-client/src/ReactFlightClient.js:1437-1580]()\n\n## Wire Protocol Format\n\n### Row-Based Streaming Protocol\n\nFlight streams data as newline-delimited rows. Each row has the format: `{id}:{tag}{data}\\n`\n\n**Row Format Components:**\n\n| Component | Format | Description |\n|-----------|--------|-------------|\n| `id` | Hex integer | Unique chunk identifier (e.g., `0`, `1a`, `2f`) |\n| `:` | Delimiter | Separates ID from tag |\n| `tag` | Single char | Row type indicator |\n| `data` | Variable | JSON string, binary length, or empty |\n| `\\n` | Terminator | Marks end of row (except binary chunks) |\n\n**Row Tags:**\n\n| Tag | Name | Data Format | Purpose |\n|-----|------|-------------|---------|\n| `J` | Model | JSON string | Serialized model/element |\n| `M` | Module (Client Reference) | JSON string | Client component reference |\n| `E` | Error | JSON error object | Error chunk |\n| `T` | Hint/Metadata | JSON string | Preload hints, metadata |\n| `@` | Promise | Promise ID | Async chunk reference |\n| `H` | Halt (DEV) | Empty | Indicates stopped resolution |\n| `R` | ReadableStream start | Empty | Stream initialization |\n| `r` | BYOB stream start | Empty | Binary stream initialization |\n| `C` | Stream close | Empty or final value | Stream completion |\n| `X` | Async iterator start | Empty | Iterator initialization |\n| `x` | Iterator instance | Empty | Single-shot iterator |\n\n**Example Row Sequences:**\n\n```\n0:J{"type":"div","props":{"children":"Hello"}}\n1:M{"id":"./ClientComponent.js","chunks":["chunk1"],"name":"default"}\n2:@3\n3:J"Resolved value"\n```\n\n**Sources:** [packages/react-client/src/ReactFlightClient.js:1437-1580](), [packages/react-server/src/ReactFlightServer.js:1860-1930]()\n\n### Value Serialization Encoding\n\nThe server encodes special values with prefix markers in JSON strings:\n\n```mermaid\ngraph TD\n    Value["Value to Serialize"]\n    \n    Value -->|"reference to chunk"| RefPrefix["$ + hex ID<br/>e.g., \'$5\'"]\n    Value -->|"Promise"| PromisePrefix["$@ + hex ID<br/>e.g., \'$@a\'"]\n    Value -->|"Server Reference"| ServerPrefix["$F + hex ID<br/>e.g., \'$F3\'"]\n    Value -->|"Client Reference"| ClientPrefix["$$id<br/>e.g., \'$$./Component.js#default\'"]\n    Value -->|"Symbol"| SymbolPrefix["$S + symbol key<br/>e.g., \'$Sreact.element\'"]\n    Value -->|"-0"| NegZero["$-0"]\n    Value -->|"Infinity"| Inf["$Infinity"]\n    Value -->|"-Infinity"| NegInf["$-Infinity"]\n    Value -->|"NaN"| NotANumber["$NaN"]\n    Value -->|"undefined"| Undef["$undefined"]\n    Value -->|"Date"| DatePrefix["$D + ISO string<br/>e.g., \'$D2023-01-01T00:00:00.000Z\'"]\n    Value -->|"BigInt"| BigIntPrefix["$n + decimal<br/>e.g., \'$n12345\'"]\n    Value -->|"Map"| MapPrefix["$Q + hex ID"]\n    Value -->|"Set"| SetPrefix["$W + hex ID"]\n    Value -->|"FormData"| FormDataPrefix["$K + hex ID"]\n    Value -->|"Blob/ArrayBuffer"| BlobPrefix["$B + hex ID"]\n    Value -->|"Iterator"| IteratorPrefix["$i + hex ID"]\n    Value -->|"Typed Array"| TypedArrayPrefix["$O + type + hex ID<br/>e.g., \'$OUint8Array1\'"]\n    Value -->|"Error"| ErrorPrefix["$E + serialized error"]\n    Value -->|"String starting with $"| Escaped["$$ + rest of string"]\n```\n\n**Key Encoding Functions:**\n\n| Function | Return | Purpose |\n|----------|--------|---------|\n| `serializeByValueID(id)` | `\'$\' + id.toString(16)` | References to other chunks |\n| `serializePromiseID(id)` | `\'$@\' + id.toString(16)` | Async chunk placeholders |\n| `serializeServerReferenceID(id)` | `\'$F\' + id.toString(16)` | Server function references |\n| `serializeClientReference(ref)` | `\'$$\' + ref.$$id` | Client component module path |\n| `serializeNumber(n)` | Special string or number | Handles `-0`, `Infinity`, `NaN` |\n| `serializeSymbol(sym)` | `\'$S\' + key` | Well-known React symbols |\n| `escapeStringValue(s)` | `\'$\' + s` if starts with `$` | Escapes `$` prefix in strings |\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:1860-1930](), [packages/react-server/src/ReactFlightServer.js:1932-2042](), [packages/react-client/src/ReactFlightClient.js:1583-1800]()\n\n### Chunk States and Transitions\n\nChunks transition through states as data arrives and is processed:\n\n```mermaid\nstateDiagram-v2\n    [*] --> PENDING: getChunk() creates\n    PENDING --> BLOCKED: waiting on dependencies\n    PENDING --> RESOLVED_MODEL: receiveModel() called\n    PENDING --> RESOLVED_MODULE: receiveModule() called\n    PENDING --> ERRORED: triggerErrorOnChunk()\n    \n    BLOCKED --> RESOLVED_MODEL: dependencies resolved\n    BLOCKED --> ERRORED: dependency failed\n    \n    RESOLVED_MODEL --> INITIALIZED: initializeModelChunk() success\n    RESOLVED_MODEL --> BLOCKED: circular dependencies found\n    RESOLVED_MODEL --> ERRORED: initializeModelChunk() throws\n    \n    RESOLVED_MODULE --> INITIALIZED: initializeModuleChunk() loads\n    \n    INITIALIZED --> [*]\n    ERRORED --> [*]\n```\n\n**State Transitions:**\n\n- **PENDING  RESOLVED_MODEL**: Server sends `J` (JSON model) row with matching ID\n- **PENDING  RESOLVED_MODULE**: Server sends `M` (module reference) row  \n- **RESOLVED_MODEL  INITIALIZED**: `initializeModelChunk()` parses JSON and resolves references\n- **RESOLVED_MODULE  INITIALIZED**: `initializeModuleChunk()` loads client module\n- **BLOCKED**: Created when chunk references another pending chunk\n- **ERRORED**: Server sends `E` row or initialization throws\n\n**Sources:** [packages/react-client/src/ReactFlightClient.js:154-243](), [packages/react-client/src/ReactFlightClient.js:767-908](), [packages/react-client/src/ReactFlightClient.js:1126-1206]()\n\n## Component and Function References\n\n### Client References (Client Components)\n\nClient references represent components that must execute on the client. They are serialized as module metadata that the client can load.\n\n**Server-Side Handling:**\n\n```mermaid\ngraph LR\n    ServerComp["Server Component"]\n    Import["import ClientComp from \'./Client.js\'"]\n    ClientRef["ClientReference<br/>{$$typeof: CLIENT_REFERENCE,<br/>$$id: \'./Client.js#default\'}"]\n    Serialize["serializeClientReference()"]\n    Row["Row: M tag<br/>{id, chunks, name}"]\n    \n    ServerComp --> Import\n    Import --> ClientRef\n    ClientRef --> Serialize\n    Serialize --> Row\n```\n\n**Client-Side Resolution:**\n\n```mermaid\ngraph LR\n    Row["M row received"]\n    CreateChunk["createResolvedModuleChunk()"]\n    ResolvedModule["ResolvedModuleChunk<br/>status: \'resolved_module\'"]\n    InitModule["initializeModuleChunk()"]\n    LoadModule["resolveClientReference()"]\n    PreloadModule["preloadModule()"]\n    RequireModule["requireModule()"]\n    ClientComp["Client Component Function"]\n    \n    Row --> CreateChunk\n    CreateChunk --> ResolvedModule\n    ResolvedModule --> InitModule\n    InitModule --> LoadModule\n    LoadModule --> PreloadModule\n    PreloadModule --> RequireModule\n    RequireModule --> ClientComp\n```\n\n**Key Functions:**\n\n| Side | Function | Purpose |\n|------|----------|---------|\n| Server | `isClientReference(value)` | Checks `$$typeof === CLIENT_REFERENCE` |\n| Server | `getClientReferenceKey(ref)` | Extracts module path from reference |\n| Server | `resolveClientReferenceMetadata(config, ref)` | Gets chunk info from `ClientManifest` |\n| Client | `resolveClientReference(metadata)` | Creates lazy wrapper for module |\n| Client | `preloadModule(metadata)` | Preloads chunks (async) |\n| Client | `requireModule(metadata)` | Synchronously imports module |\n\n**ClientManifest Structure:**\n\nThe server uses a `ClientManifest` (bundler-generated) to map references to chunk IDs:\n\n```typescript\n{\n  "./ClientComponent.js#default": {\n    id: "client-chunk-123",\n    chunks: ["chunk-abc.js", "chunk-def.js"],\n    name: "default"\n  }\n}\n```\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:1932-2042](), [packages/react-client/src/ReactFlightClient.js:1208-1274](), [packages/react-client/src/ReactFlightClient.js:882-908]()\n\n### Server References (Server Actions)\n\nServer references enable client-to-server RPC. The client can call these functions, and Flight serializes arguments, invokes the server function, and returns results.\n\n**Server-Side Creation:**\n\n```mermaid\ngraph TD\n    ServerFunc["async function myAction(data) { }"]\n    Register["registerServerReference(fn, id, name)"]\n    Proxy["Server Reference Proxy<br/>{$$typeof: SERVER_REFERENCE,<br/>$$id: \'module#myAction\',<br/>$$bound: null}"]\n    Serialize["serializeServerReference()"]\n    Row["Row: F tag<br/>id + bound args"]\n    \n    ServerFunc --> Register\n    Register --> Proxy\n    Proxy --> Serialize\n    Serialize --> Row\n```\n\n**Client-Side Invocation:**\n\n```mermaid\ngraph LR\n    ClientCall["clientRef(arg1, arg2)"]\n    CallServer["callServer(id, args)"]\n    EncodeReply["encodeReply([arg1, arg2])"]\n    FormData["FormData with serialized args"]\n    ServerInvoke["Server receives request"]\n    DecodeReply["decodeReply(body, serverMap)"]\n    Invoke["serverFunc(...args)"]\n    Result["Flight response with result"]\n    \n    ClientCall --> CallServer\n    CallServer --> EncodeReply\n    EncodeReply --> FormData\n    FormData --> ServerInvoke\n    ServerInvoke --> DecodeReply\n    DecodeReply --> Invoke\n    Invoke --> Result\n```\n\n**Key Functions:**\n\n| Side | Function | Purpose |\n|------|----------|---------|\n| Server | `registerServerReference(fn, id, name)` | Marks function as server reference |\n| Server | `getServerReferenceId(ref)` | Extracts module ID |\n| Server | `getServerReferenceBoundArguments(ref)` | Gets pre-bound arguments (from `.bind()`) |\n| Client | `createServerReference(id, callServer)` | Creates callable proxy |\n| Client | `callServer(id, args)` | User-provided RPC implementation |\n| Client | `encodeReply(value)` | Serializes arguments to FormData |\n| Server | `decodeReply(body, serverMap)` | Deserializes FormData to values |\n\n**Bound Server References:**\n\nServer references can be partially applied with `.bind()`:\n\n```javascript\n// Server\nexport async function deleteItem(userId, itemId) { ... }\n\n// Server component passes bound reference\nconst boundDelete = deleteItem.bind(null, currentUserId);\nreturn <Button action={boundDelete} />\n```\n\nThe bound arguments are serialized in the Flight stream, and the client proxy includes them when calling back.\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:2044-2143](), [packages/react-client/src/ReactFlightClient.js:1583-1650](), [packages/react-client/src/ReactFlightReplyClient.js:179-560](), [packages/react-server/src/ReactFlightReplyServer.js:400-650]()\n\n## Request Lifecycle\n\n### Server Render Flow\n\n```mermaid\ngraph TD\n    Entry["renderToPipeableStream(model, config)"]\n    CreateReq["createRequest(RENDER, model, bundlerConfig, ...)"]\n    Request["Request<br/>{status: OPENING, nextChunkId: 0}"]\n    RootTask["createTask(request, model, null, ...)"]\n    PingedTasks["pingedTasks array"]\n    \n    Entry --> CreateReq\n    CreateReq --> Request\n    Request --> RootTask\n    RootTask --> PingedTasks\n    \n    StartWork["startWork(request)"]\n    PerformWork["performWork(request)"]\n    RetryTask["retryTask(request, task)"]\n    RenderModel["renderModelDestructive(request, task, ...)"]\n    EmitChunk["emitChunk(request, task.id, model)"]\n    FlushChunks["flushCompletedChunks(request)"]\n    \n    PingedTasks --> StartWork\n    StartWork --> PerformWork\n    PerformWork --> RetryTask\n    RetryTask --> RenderModel\n    RenderModel --> EmitChunk\n    EmitChunk --> FlushChunks\n```\n\n**Processing Steps:**\n\n1. **Initialization**: `createRequest()` creates `Request` with `OPENING` status and root task\n2. **Work Loop**: `performWork()` processes `pingedTasks` array, rendering each task\n3. **Serialization**: `renderModelDestructive()` recursively serializes model, mutating it to JSON-compatible form\n4. **Chunk Emission**: `emitChunk()` generates row string and adds to `completedRegularChunks`\n5. **Flushing**: `flushCompletedChunks()` writes accumulated chunks to destination stream\n6. **Completion**: When all tasks done, status transitions to `CLOSED` and stream is closed\n\n**Key Task States:**\n\n| Task Status | Value | Description |\n|-------------|-------|-------------|\n| `PENDING` | `0` | Task created but not started |\n| `COMPLETED` | `1` | Task finished successfully |\n| `ABORTED` | `3` | Task aborted due to error/abort |\n| `ERRORED` | `4` | Task threw error during render |\n| `RENDERING` | `5` | Task currently executing |\n\n**Sources:** [packages/react-server/src/ReactFlightServer.js:779-807](), [packages/react-server/src/ReactFlightServer.js:1373-1445](), [packages/react-server/src/ReactFlightServer.js:1447-1533]()\n\n### Client Parsing Flow\n\n```mermaid\ngraph TD\n    CreateResp["createFromReadableStream(stream, options)"]\n    Response["Response<br/>{_chunks: new Map(), _closed: false}"]\n    ReadStream["Read stream chunks"]\n    ProcessBinary["processBinaryChunk(response, chunk)"]\n    ParseRow["Parse row: id:tag data"]\n    ProcessRow["processFullRow(response, row)"]\n    \n    CreateResp --> Response\n    Response --> ReadStream\n    ReadStream --> ProcessBinary\n    ProcessBinary --> ParseRow\n    ParseRow --> ProcessRow\n    \n    ResolveModel["resolveModel(response, id, model)"]\n    ResolveModule["resolveModule(response, id, metadata)"]\n    ResolveError["resolveError(response, id, error)"]\n    GetChunk["getChunk(response, id)"]\n    CreateChunk["createPendingChunk() or fetch from _chunks"]\n    UpdateChunk["Update chunk status and value"]\n    WakeListeners["Wake pending .then() listeners"]\n    \n    ProcessRow -->|"J tag"| ResolveModel\n    ProcessRow -->|"M tag"| ResolveModule\n    ProcessRow -->|"E tag"| ResolveError\n    \n    ResolveModel --> GetChunk\n    GetChunk --> CreateChunk\n    CreateChunk --> UpdateChunk\n    UpdateChunk --> WakeListeners\n```\n\n**Parsing States:**\n\nThe parser maintains state between stream chunks:\n\n| Parser State | Processing |\n|--------------|------------|\n| `ROW_ID` | Reading chunk ID in hex (e.g., `1a`) |\n| `ROW_TAG` | Reading single-char tag after `:` |\n| `ROW_LENGTH` | Reading length field for binary data |\n| `ROW_CHUNK_BY_NEWLINE` | Accumulating row until `\\n` |\n| `ROW_CHUNK_BY_LENGTH` | Reading exact byte count for binary |\n\n**Processing Steps:**\n\n1. **Stream Reading**: `processBinaryChunk()` processes incoming bytes\n2. **Row Parsing**: State machine extracts `id`, `tag`, and `data` from each row\n3. **Row Processing**: `processFullRow()` dispatches based on tag\n4. **Chunk Resolution**: Updates or creates chunk in `_chunks` Map\n5. **Listener Notification**: Wakes any promises/callbacks waiting on this chunk\n6. **Initialization**: When chunk read via `readChunk()`, calls `initializeModelChunk()` if needed\n\n**Sources:** [packages/react-client/src/ReactFlightClient.js:1437-1580](), [packages/react-client/src/ReactFlightClient.js:1626-1935](), [packages/react-client/src/ReactFlightClient.js:852-880]()\n\n## Configuration and Integration\n\n### Environment-Specific Configurations\n\nFlight supports multiple deployment environments through configuration modules:\n\n- `ReactFlightServerConfig` - Server-side environment configuration\n- `ReactFlightClientConfig` - Client-side environment configuration  \n- Webpack integration through `ReactFlightWebpackPlugin`\n- Turbopack integration for Next.js environments\n\n**Sources:** [packages/react-server-dom-webpack/src/ReactFlightWebpackPlugin.js:1-50](), [packages/react-server-dom-webpack/src/ReactFlightWebpackNodeLoader.js:1-30]()\n\n### Performance and Debugging\n\nFlight includes performance tracking and debugging capabilities:\n\n- Component render timing with `enableComponentPerformanceTrack`\n- Async operation tracking with `enableAsyncDebugInfo`  \n- Console log forwarding from server to client\n- Stack trace preservation across server-client boundary\n\n**Sources:** [packages/react-client/src/ReactFlightPerformanceTrack.js:75-140](), [packages/react-server/src/__tests__/ReactFlightAsyncDebugInfo-test.js:105-150]()\n\n---\n\n# Page: Build Integration for Server Components\n\n# Build Integration for Server Components\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightClient.js](packages/react-client/src/ReactFlightClient.js)\n- [packages/react-client/src/ReactFlightReplyClient.js](packages/react-client/src/ReactFlightReplyClient.js)\n- [packages/react-client/src/ReactFlightTemporaryReferences.js](packages/react-client/src/ReactFlightTemporaryReferences.js)\n- [packages/react-client/src/__tests__/ReactFlight-test.js](packages/react-client/src/__tests__/ReactFlight-test.js)\n- [packages/react-dom/npm/server.browser.js](packages/react-dom/npm/server.browser.js)\n- [packages/react-dom/npm/server.bun.js](packages/react-dom/npm/server.bun.js)\n- [packages/react-dom/npm/server.edge.js](packages/react-dom/npm/server.edge.js)\n- [packages/react-dom/npm/server.node.js](packages/react-dom/npm/server.node.js)\n- [packages/react-dom/server.browser.js](packages/react-dom/server.browser.js)\n- [packages/react-dom/server.bun.js](packages/react-dom/server.bun.js)\n- [packages/react-dom/server.edge.js](packages/react-dom/server.edge.js)\n- [packages/react-dom/server.node.js](packages/react-dom/server.node.js)\n- [packages/react-dom/src/server/react-dom-server.bun.js](packages/react-dom/src/server/react-dom-server.bun.js)\n- [packages/react-dom/src/server/react-dom-server.bun.stable.js](packages/react-dom/src/server/react-dom-server.bun.stable.js)\n- [packages/react-server-dom-esm/src/ReactFlightESMReferences.js](packages/react-server-dom-esm/src/ReactFlightESMReferences.js)\n- [packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js](packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js)\n- [packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js](packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js)\n- [packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js](packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js)\n- [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js](packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js)\n- [packages/react-server/src/ReactFlightReplyServer.js](packages/react-server/src/ReactFlightReplyServer.js)\n- [packages/react-server/src/ReactFlightServer.js](packages/react-server/src/ReactFlightServer.js)\n- [packages/react-server/src/ReactFlightServerTemporaryReferences.js](packages/react-server/src/ReactFlightServerTemporaryReferences.js)\n- [scripts/error-codes/codes.json](scripts/error-codes/codes.json)\n- [scripts/jest/setupHostConfigs.js](scripts/jest/setupHostConfigs.js)\n- [scripts/rollup/build.js](scripts/rollup/build.js)\n- [scripts/rollup/bundles.js](scripts/rollup/bundles.js)\n- [scripts/rollup/forks.js](scripts/rollup/forks.js)\n- [scripts/rollup/modules.js](scripts/rollup/modules.js)\n- [scripts/rollup/packaging.js](scripts/rollup/packaging.js)\n- [scripts/rollup/sync.js](scripts/rollup/sync.js)\n- [scripts/rollup/validate/index.js](scripts/rollup/validate/index.js)\n- [scripts/rollup/wrappers.js](scripts/rollup/wrappers.js)\n- [scripts/shared/inlinedHostConfigs.js](scripts/shared/inlinedHostConfigs.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document explains how bundlers integrate with React Server Components (RSC) through build-time plugins, manifest generation, and directive processing. It covers the Webpack plugin implementation, module reference systems, and how the build toolchain transforms code containing `\'use client\'` and `\'use server\'` directives into the appropriate module references and manifests.\n\nFor information about the runtime behavior of Flight serialization and deserialization, see [React Server Components (Flight)](#5.2). For server actions and client-to-server communication, see [Server Actions and Bidirectional Communication](#5.4).\n\n---\n\n## Build Integration Architecture\n\nThe build integration for React Server Components consists of several cooperating systems that run at build time to analyze modules, generate manifests, and transform code references.\n\n**Build Integration Flow**\n\n```mermaid\ngraph TB\n    subgraph "Source Code"\n        ServerComponents["Server Components<br/>(no directive)"]\n        ClientComponents["Client Components<br/>\'use client\'"]\n        ServerActions["Server Actions<br/>\'use server\'"]\n    end\n    \n    subgraph "Build Process"\n        WebpackPlugin["ReactFlightWebpackPlugin"]\n        NodeLoader["react-server-dom-webpack/node-loader"]\n        \n        WebpackPlugin -->|analyzes| DirectiveDetection["Directive Detection"]\n        WebpackPlugin -->|generates| ClientManifest["Client Manifest<br/>clientReferenceMap"]\n        WebpackPlugin -->|generates| ServerManifest["Server Manifest<br/>serverReferenceMap"]\n        \n        DirectiveDetection -->|\'use client\'| ClientModuleTransform["Client Module Transform"]\n        DirectiveDetection -->|\'use server\'| ServerModuleTransform["Server Module Transform"]\n    end\n    \n    subgraph "Output Artifacts"\n        ServerBundle["Server Bundle<br/>react-server condition"]\n        ClientBundle["Client Bundle<br/>default condition"]\n        \n        ClientManifest -->|consumed by| ServerBundle\n        ServerManifest -->|consumed by| ClientBundle\n    end\n    \n    subgraph "Runtime"\n        FlightServer["Flight Server<br/>ReactFlightServer.js"]\n        FlightClient["Flight Client<br/>ReactFlightClient.js"]\n        \n        FlightServer -->|serializes with| ClientManifest\n        FlightClient -->|deserializes with| ServerManifest\n    end\n    \n    ServerComponents --> WebpackPlugin\n    ClientComponents --> WebpackPlugin\n    ServerActions --> WebpackPlugin\n    \n    ServerBundle --> FlightServer\n    ClientBundle --> FlightClient\n```\n\nSources: [scripts/rollup/bundles.js:524-558](), [packages/react-server/src/ReactFlightServer.js:1-100](), [packages/react-client/src/ReactFlightClient.js:1-100]()\n\n---\n\n## Webpack Plugin Implementation\n\nThe `ReactFlightWebpackPlugin` is the primary build-time integration point. It analyzes modules for directives, transforms module references, and generates the client and server manifests.\n\n**Plugin Bundle Configuration**\n\n| Property | Value |\n|----------|-------|\n| Entry Point | `react-server-dom-webpack/plugin` |\n| Bundle Type | `NODE_ES2015` |\n| Module Type | `RENDERER_UTILS` |\n| Global Name | `ReactServerWebpackPlugin` |\n| Externals | `fs`, `path`, `url`, `neo-async` |\n\nThe plugin operates as a Webpack compilation plugin that hooks into the module graph construction process to identify client and server boundaries.\n\n**Module Analysis Process**\n\n```mermaid\ngraph LR\n    subgraph "Webpack Compilation"\n        ModuleGraph["Webpack Module Graph"]\n        \n        ModuleGraph -->|for each module| AnalyzeModule["Analyze Module"]\n        \n        AnalyzeModule -->|check| HasDirective{"Has \'use client\'<br/>or \'use server\'?"}\n        \n        HasDirective -->|yes| RegisterReference["Register Module Reference"]\n        HasDirective -->|no| CheckImports["Check Imports"]\n        \n        RegisterReference -->|\'use client\'| AddToClientManifest["Add to Client Manifest"]\n        RegisterReference -->|\'use server\'| AddToServerManifest["Add to Server Manifest"]\n        \n        CheckImports -->|imports client module| ProxyModule["Create Proxy Module"]\n    end\n    \n    subgraph "Reference Generation"\n        AddToClientManifest --> GenerateClientID["Generate Client ID<br/>module path + export name"]\n        AddToServerManifest --> GenerateServerID["Generate Server ID<br/>module path + export name"]\n        \n        GenerateClientID --> ClientMetadata["Client Reference Metadata<br/>{id, chunks, name}"]\n        GenerateServerID --> ServerMetadata["Server Reference Metadata<br/>{id, bound}"]\n    end\n```\n\nSources: [scripts/rollup/bundles.js:524-533]()\n\n---\n\n## Module Reference System\n\nReact Server Components use a module reference system to represent code that crosses the server/client boundary. These references are opaque identifiers that get resolved at runtime using the manifests.\n\n**Client Reference Structure**\n\nA client reference represents a module that should be loaded on the client. When server code imports a client component, it receives a reference instead of the actual module.\n\n```mermaid\ngraph TB\n    subgraph "Server-Side"\n        ServerCode["Server Component Code"]\n        ClientRefProxy["Client Reference Proxy<br/>$$typeof: \'react.client.reference\'"]\n        \n        ServerCode -->|imports| ClientRefProxy\n    end\n    \n    subgraph "Client Manifest Entry"\n        ManifestEntry["Client Manifest Entry"]\n        \n        ManifestEntry -->|contains| ModuleID["id: \'path/to/module.js#Component\'"]\n        ManifestEntry -->|contains| ChunkIDs["chunks: [\'client-chunk-123\']"]\n        ManifestEntry -->|contains| ExportName["name: \'Component\' or \'*\'"]\n    end\n    \n    subgraph "Serialization"\n        FlightProtocol["Flight Protocol Stream"]\n        \n        ClientRefProxy -->|serialized as| ModuleReference["M1:{id,chunks,name}"]\n        ModuleReference -->|written to| FlightProtocol\n    end\n    \n    subgraph "Client-Side"\n        FlightClient["Flight Client"]\n        ManifestLookup["Manifest Lookup"]\n        ModuleLoader["Module Loader"]\n        \n        FlightProtocol -->|read by| FlightClient\n        FlightClient -->|resolves with| ManifestLookup\n        ManifestLookup -->|loads| ModuleLoader\n        ModuleLoader -->|returns| ActualComponent["Actual Component Implementation"]\n    end\n    \n    ClientRefProxy -.manifest key.-> ManifestEntry\n```\n\nSources: [packages/react-client/src/ReactFlightClient.js:1-100](), [packages/react-server/src/ReactFlightServer.js:79-101]()\n\n**Server Reference Structure**\n\nA server reference represents a function that should execute on the server. When client code calls a server action, it sends a reference and arguments back to the server.\n\n```mermaid\ngraph TB\n    subgraph "Client-Side"\n        ClientCode["Client Component Code"]\n        ServerRefFunc["Server Reference Function<br/>$$typeof: \'react.server.reference\'"]\n        \n        ClientCode -->|calls| ServerRefFunc\n        ServerRefFunc -->|serializes| ServerRefCall["Call: {id, args}"]\n    end\n    \n    subgraph "Server Manifest Entry"\n        ServerManifestEntry["Server Manifest Entry"]\n        \n        ServerManifestEntry -->|contains| ServerModuleID["id: \'path/to/actions.js#saveData\'"]\n        ServerManifestEntry -->|contains| BoundArgs["bound: null or Array"]\n    end\n    \n    subgraph "Server-Side"\n        FlightReply["Flight Reply Processor"]\n        ManifestResolve["Manifest Resolution"]\n        ActualFunction["Actual Server Function"]\n        \n        ServerRefCall -->|sent to| FlightReply\n        FlightReply -->|resolves with| ManifestResolve\n        ManifestResolve -->|loads| ActualFunction\n        ActualFunction -->|executes| ReturnValue["Return Value"]\n    end\n    \n    ServerRefFunc -.manifest key.-> ServerManifestEntry\n```\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:52-80](), [packages/react-server/src/ReactFlightReplyServer.js:1-50]()\n\n---\n\n## Directive Processing\n\nThe build system processes two types of directives: `\'use client\'` and `\'use server\'`. These directives must appear at the top of the module, before any other code.\n\n**Directive Detection and Transformation**\n\n| Directive | Location | Meaning | Build Transformation |\n|-----------|----------|---------|---------------------|\n| `\'use client\'` | Top of file | Entire module runs on client | Replace with client reference proxy in server bundle |\n| `\'use server\'` | Top of file | Entire module exports server actions | Replace with server reference proxies in client bundle |\n| `\'use server\'` | Inside function | Single function is server action | Extract and create server reference |\n\n**Client Directive Processing Flow**\n\n```mermaid\ngraph TB\n    subgraph "Source Module"\n        ClientDirective["\'use client\'<br/>export function Button() {...}"]\n    end\n    \n    subgraph "Server Bundle Transform"\n        DetectDirective["Detect \'use client\' Directive"]\n        GenerateProxy["Generate Proxy Module"]\n        \n        DetectDirective --> GenerateProxy\n        GenerateProxy --> ProxyContent["Proxy exports client references<br/>for each export"]\n    end\n    \n    subgraph "Client Bundle Transform"\n        IncludeOriginal["Include Original Module"]\n        AddChunkInfo["Add to Chunk Manifest"]\n        \n        IncludeOriginal --> AddChunkInfo\n    end\n    \n    subgraph "Manifest Generation"\n        ClientManifestEntry["Client Manifest Entry<br/>{<br/>  id: \'Button.js\',<br/>  chunks: [\'chunk-123\'],<br/>  name: \'Button\'<br/>}"]\n    end\n    \n    ClientDirective -->|server bundle| DetectDirective\n    ClientDirective -->|client bundle| IncludeOriginal\n    \n    ProxyContent --> ClientManifestEntry\n    AddChunkInfo --> ClientManifestEntry\n```\n\nSources: [scripts/rollup/bundles.js:448-522]()\n\n**Server Directive Processing Flow**\n\n```mermaid\ngraph TB\n    subgraph "Source Module"\n        ServerDirective["\'use server\'<br/>export async function saveData() {...}"]\n    end\n    \n    subgraph "Client Bundle Transform"\n        DetectServerDirective["Detect \'use server\' Directive"]\n        GenerateServerProxy["Generate Server Reference Proxy"]\n        \n        DetectServerDirective --> GenerateServerProxy\n        GenerateServerProxy --> ProxyFunc["Proxy function calls server<br/>via callServer()"]\n    end\n    \n    subgraph "Server Bundle Transform"\n        KeepOriginal["Keep Original Implementation"]\n        RegisterAction["Register in Server Manifest"]\n        \n        KeepOriginal --> RegisterAction\n    end\n    \n    subgraph "Manifest Generation"\n        ServerManifestEntry["Server Manifest Entry<br/>{<br/>  id: \'actions.js#saveData\',<br/>  bound: null<br/>}"]\n    end\n    \n    ServerDirective -->|client bundle| DetectServerDirective\n    ServerDirective -->|server bundle| KeepOriginal\n    \n    ProxyFunc --> ServerManifestEntry\n    RegisterAction --> ServerManifestEntry\n```\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:1-100](), [packages/react-server/src/ReactFlightReplyServer.js:1-50]()\n\n---\n\n## Manifest Structures\n\nThe build process generates two manifest files that enable runtime module resolution across the server/client boundary.\n\n**Client Manifest Format**\n\nThe client manifest maps module IDs to chunk information, allowing the server to serialize client references that the client can resolve.\n\n```mermaid\ngraph TB\n    subgraph "Client Manifest Structure"\n        ClientManifest["clientReferenceManifest"]\n        \n        ClientManifest --> ModuleMap["Module Map<br/>{[moduleId]: ModuleExports}"]\n        \n        ModuleMap --> ModuleExports["Module Exports<br/>{[exportName]: ExportInfo}"]\n        \n        ModuleExports --> ExportInfo["Export Info"]\n        \n        ExportInfo --> ExportID["id: string<br/>\'path/to/module#export\'"]\n        ExportInfo --> ExportChunks["chunks: Array<string><br/>[\'chunk-abc\', \'chunk-def\']"]\n        ExportInfo --> ExportName["name: string<br/>\'ComponentName\' or \'*\'"]\n    end\n    \n    subgraph "Example Entry"\n        Example["ClientButton.js:<br/>{<br/>  \'Button\': {<br/>    id: \'./ClientButton.js#Button\',<br/>    chunks: [\'client-chunk-123\'],<br/>    name: \'Button\'<br/>  },<br/>  \'*\': {<br/>    id: \'./ClientButton.js#*\',<br/>    chunks: [\'client-chunk-123\'],<br/>    name: \'*\'<br/>  }<br/>}"]\n    end\n```\n\n**Client Manifest Runtime Usage**\n\n| Stage | Operation | Manifest Usage |\n|-------|-----------|----------------|\n| Server Render | Encounter client component | Look up module ID in manifest to get chunks |\n| Flight Serialization | Serialize client reference | Include `{id, chunks, name}` in stream |\n| Client Receive | Deserialize reference | Use chunks to preload/load module |\n| Client Render | Instantiate component | Import module and get export by name |\n\nSources: [packages/react-server/src/ReactFlightServer.js:79-101](), [packages/react-client/src/ReactFlightClient.js:44-64]()\n\n**Server Manifest Format**\n\nThe server manifest maps server action IDs to module locations, allowing the client to invoke server functions.\n\n```mermaid\ngraph TB\n    subgraph "Server Manifest Structure"\n        ServerManifest["serverReferenceManifest"]\n        \n        ServerManifest --> ActionMap["Action Map<br/>{[actionId]: ActionInfo}"]\n        \n        ActionMap --> ActionInfo["Action Info"]\n        \n        ActionInfo --> ActionID["id: string<br/>\'actions.js#saveData\'"]\n        ActionInfo --> BoundArgs["bound: null | Promise<Array>"]\n    end\n    \n    subgraph "Example Entry"\n        ServerExample["Server Actions:<br/>{<br/>  \'actions.js#saveData\': {<br/>    id: \'actions.js#saveData\',<br/>    bound: null<br/>  },<br/>  \'actions.js#deleteData\': {<br/>    id: \'actions.js#deleteData\',<br/>    bound: Promise.resolve([userId])<br/>  }<br/>}"]\n    end\n```\n\n**Server Manifest Runtime Usage**\n\n| Stage | Operation | Manifest Usage |\n|-------|-----------|----------------|\n| Client Render | Receive server reference | Store reference with `$$typeof` marker |\n| Client Invoke | Call server function | Serialize `{id, args}` with Flight Reply |\n| Server Receive | Deserialize call | Look up action ID in manifest |\n| Server Execute | Load and invoke | Require module and call export by name |\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:52-80](), [packages/react-server/src/ReactFlightReplyServer.js:1-50]()\n\n---\n\n## Module Loading Integration\n\nThe build integration includes module loaders that handle the `react-server` condition at runtime, ensuring the correct versions of modules are loaded in each environment.\n\n**Node.js Loader Configuration**\n\n| Property | Value |\n|----------|-------|\n| Entry Point | `react-server-dom-webpack/node-loader` |\n| Bundle Type | `ESM_PROD` |\n| Condition | `react-server` |\n| External | `acorn` (for AST parsing) |\n\nThe Node.js loader uses ESM loader hooks to intercept module resolution and ensure that modules with the `react-server` export condition are loaded in the server environment.\n\n**Module Resolution Flow**\n\n```mermaid\ngraph TB\n    subgraph "Import Statement"\n        ImportReact["import React from \'react\'"]\n    end\n    \n    subgraph "Node.js Loader Hooks"\n        ResolveHook["resolve() hook"]\n        LoadHook["load() hook"]\n        \n        ResolveHook -->|check conditions| ConditionCheck{"Has react-server<br/>export condition?"}\n        \n        ConditionCheck -->|yes| UseReactServer["Use react.react-server.js"]\n        ConditionCheck -->|no| UseDefault["Use index.js"]\n        \n        UseReactServer --> LoadHook\n        UseDefault --> LoadHook\n    end\n    \n    subgraph "Package Exports"\n        PackageJson["package.json exports field"]\n        \n        PackageJson --> ReactServerExport["\'react-server\': \'./react.react-server.js\'"]\n        PackageJson --> DefaultExport["\'default\': \'./index.js\'"]\n    end\n    \n    ImportReact --> ResolveHook\n    ReactServerExport -.used by.-> UseReactServer\n    DefaultExport -.used by.-> UseDefault\n```\n\nSources: [scripts/rollup/bundles.js:535-545](), [packages/react/package.json:24-42]()\n\n**CommonJS Module Registration**\n\nFor CommonJS environments, a registration module handles module loading:\n\n| Property | Value |\n|----------|-------|\n| Entry Point | `react-server-dom-webpack/src/ReactFlightWebpackNodeRegister` |\n| Name | `react-server-dom-webpack-node-register` |\n| Condition | `react-server` |\n| Externals | `url`, `module`, `react-server-dom-webpack/server` |\n\nThis module hooks into Node\'s `require()` system to apply the `react-server` condition for CommonJS modules.\n\nSources: [scripts/rollup/bundles.js:547-558]()\n\n---\n\n## Build Output Organization\n\nThe build system produces separate bundles for server and client environments, each consuming the appropriate manifest.\n\n**Bundle Type Matrix**\n\n| Bundle | Entry Points | Condition | Consumes Manifest | Target Environment |\n|--------|--------------|-----------|-------------------|--------------------|\n| Server | `react-server-dom-webpack/server.{node,browser,edge}` | `react-server` | Client Manifest | Node.js, Edge Runtime, Browser (SSR) |\n| Client | `react-server-dom-webpack/client.{node,browser,edge}` | default | Server Manifest | Node.js (for SSR), Browser |\n| Plugin | `react-server-dom-webpack/plugin` | N/A | Generates both | Build time only |\n| Loader | `react-server-dom-webpack/node-loader` | `react-server` | N/A | Node.js ESM runtime |\n\n**Server Bundle Configuration**\n\n```mermaid\ngraph LR\n    subgraph "Server Entry Points"\n        ServerBrowser["server.browser"]\n        ServerNode["server.node"]\n        ServerEdge["server.edge"]\n    end\n    \n    subgraph "Configuration"\n        Condition["condition: \'react-server\'"]\n        Externals["externals:<br/>react, react-dom,<br/>crypto, stream, util"]\n        GlobalName["global: \'ReactServerDOMServer\'"]\n    end\n    \n    subgraph "Consumes"\n        ClientManifest2["Client Manifest"]\n    end\n    \n    ServerBrowser --> Condition\n    ServerNode --> Condition\n    ServerEdge --> Condition\n    \n    Condition --> ClientManifest2\n    Externals --> ClientManifest2\n```\n\nSources: [scripts/rollup/bundles.js:448-489]()\n\n**Client Bundle Configuration**\n\n```mermaid\ngraph LR\n    subgraph "Client Entry Points"\n        ClientBrowser["client.browser"]\n        ClientNode["client.node"]\n        ClientEdge["client.edge"]\n    end\n    \n    subgraph "Configuration"\n        NoCondition["condition: default"]\n        ClientExternals["externals:<br/>react, react-dom,<br/>util, crypto"]\n        ClientGlobalName["global: \'ReactServerDOMClient\'"]\n    end\n    \n    subgraph "Consumes"\n        ServerManifest2["Server Manifest"]\n    end\n    \n    ClientBrowser --> NoCondition\n    ClientNode --> NoCondition\n    ClientEdge --> NoCondition\n    \n    NoCondition --> ServerManifest2\n    ClientExternals --> ServerManifest2\n```\n\nSources: [scripts/rollup/bundles.js:491-522]()\n\n---\n\n## Fork System Integration\n\nThe build system uses a fork mechanism to provide different implementations of shared modules based on the bundle type and environment.\n\n**React Shared Internals Forking**\n\n```mermaid\ngraph TB\n    subgraph "Import Statement"\n        ImportShared["import ReactSharedInternals"]\n    end\n    \n    subgraph "Fork Resolution"\n        ForkCheck{"Check bundle<br/>condition"}\n        \n        ForkCheck -->|react-server| ServerInternals["ReactSharedInternalsServer"]\n        ForkCheck -->|default| ClientInternals["ReactSharedInternalsClient"]\n    end\n    \n    subgraph "Implementation Files"\n        ServerImpl["packages/react-server/src/<br/>ReactSharedInternalsServer.js"]\n        ClientImpl["packages/react/src/<br/>ReactSharedInternalsClient.js"]\n    end\n    \n    ImportShared --> ForkCheck\n    ServerInternals --> ServerImpl\n    ClientInternals --> ClientImpl\n```\n\n**Fork Configuration Table**\n\n| Module | Condition | Fork Target | Purpose |\n|--------|-----------|-------------|---------|\n| `shared/ReactSharedInternals.js` | `react-server` | `ReactSharedInternalsServer.js` | Server-specific internals (Flight hooks) |\n| `shared/ReactSharedInternals.js` | default | `ReactSharedInternalsClient.js` | Client-specific internals (useState, etc.) |\n| `shared/ReactDOMSharedInternals.js` | `react-server` | N/A | Not available in react-server |\n| `shared/ReactDOMSharedInternals.js` | default | `ReactDOMSharedInternals.js` | DOM-specific internals |\n\nSources: [scripts/rollup/forks.js:52-131](), [scripts/rollup/build.js:354-403]()\n\n---\n\n## Integration with Other Bundlers\n\nWhile the primary implementation uses Webpack, the architecture supports other bundlers through similar plugin systems.\n\n**Turbopack Integration**\n\n| Bundle | Entry Point | Notes |\n|--------|-------------|-------|\n| Server | `react-server-dom-turbopack/server.{browser,node,edge}` | Similar to Webpack server |\n| Client | `react-server-dom-turbopack/client.{browser,node,edge}` | Similar to Webpack client |\n\nThe Turbopack integration follows the same manifest generation and module reference patterns, but uses Turbopack\'s native plugin system instead of Webpack\'s.\n\nSources: [scripts/rollup/bundles.js:560-672]()\n\n**Unbundled (Development) Integration**\n\nFor development and testing without a bundler:\n\n| Bundle | Entry Point | Purpose |\n|--------|-------------|---------|\n| Server | `react-server-dom-unbundled/server.node` | No bundling, direct module resolution |\n| Client | `react-server-dom-unbundled/client.node` | No bundling, direct module imports |\n\nThis configuration is used primarily in tests to validate the Flight protocol without bundler complexity.\n\nSources: Test files show usage of WebpackMock utilities that simulate manifest generation without actual bundling.\n\n---\n\n## Summary\n\nThe build integration for React Server Components operates through:\n\n1. **Plugin System**: `ReactFlightWebpackPlugin` analyzes modules and generates manifests\n2. **Module References**: Abstract representations of cross-boundary modules with `$$typeof` markers\n3. **Directive Processing**: Transform `\'use client\'` and `\'use server\'` directives into appropriate references\n4. **Manifest Generation**: Create client manifest (server  client) and server manifest (client  server)\n5. **Module Loading**: Use condition-based resolution with `react-server` export condition\n6. **Fork System**: Provide environment-specific implementations of shared modules\n\nThe architecture is bundler-agnostic, with implementations for Webpack, Turbopack, and unbundled environments all following the same manifest and reference patterns.\n\nSources: [scripts/rollup/bundles.js:448-672](), [scripts/rollup/forks.js:1-300](), [scripts/rollup/build.js:1-600]()\n\n---\n\n# Page: Server Actions and Bidirectional Communication\n\n# Server Actions and Bidirectional Communication\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-client/src/ReactFlightClient.js](packages/react-client/src/ReactFlightClient.js)\n- [packages/react-client/src/ReactFlightReplyClient.js](packages/react-client/src/ReactFlightReplyClient.js)\n- [packages/react-client/src/ReactFlightTemporaryReferences.js](packages/react-client/src/ReactFlightTemporaryReferences.js)\n- [packages/react-client/src/__tests__/ReactFlight-test.js](packages/react-client/src/__tests__/ReactFlight-test.js)\n- [packages/react-server-dom-esm/src/ReactFlightESMReferences.js](packages/react-server-dom-esm/src/ReactFlightESMReferences.js)\n- [packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js](packages/react-server-dom-parcel/src/ReactFlightParcelReferences.js)\n- [packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js](packages/react-server-dom-turbopack/src/ReactFlightTurbopackReferences.js)\n- [packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js](packages/react-server-dom-unbundled/src/ReactFlightUnbundledReferences.js)\n- [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js](packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOM-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMBrowser-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMEdge-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMNode-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReply-test.js)\n- [packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js](packages/react-server-dom-webpack/src/__tests__/ReactFlightDOMReplyEdge-test.js)\n- [packages/react-server/src/ReactFlightReplyServer.js](packages/react-server/src/ReactFlightReplyServer.js)\n- [packages/react-server/src/ReactFlightServer.js](packages/react-server/src/ReactFlightServer.js)\n- [packages/react-server/src/ReactFlightServerTemporaryReferences.js](packages/react-server/src/ReactFlightServerTemporaryReferences.js)\n- [scripts/error-codes/codes.json](scripts/error-codes/codes.json)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis page documents React\'s server action system and bidirectional communication protocol. Server actions enable client code to invoke server-side functions, creating a communication channel from client to server. This complements the server-to-client RSC protocol documented in [React Server Components (Flight)](#5.2).\n\nKey topics covered:\n- **Server References**: Functions that can be serialized and invoked from the client\n- **Reply Encoding**: How client arguments are serialized and sent to the server\n- **Reply Decoding**: How the server deserializes client data\n- **Form Integration**: Using server actions as form actions for progressive enhancement\n- **Bound Arguments**: Pre-binding arguments to server functions\n\nFor server-to-client streaming, see [React Server Components (Flight)](#5.2). For build-time module resolution, see [Build Integration for Server Components](#5.3).\n\n---\n\n## Server Reference Architecture\n\nServer references are special function objects that can be serialized and sent to the client, then invoked to trigger server-side execution.\n\n### Server Reference Structure\n\n```mermaid\ngraph TB\n    subgraph "Server Reference Object"\n        SR["ServerReference&lt;T&gt;"]\n        SR --> typeof["$$typeof: SERVER_REFERENCE_TAG"]\n        SR --> id["$$id: string"]\n        SR --> bound["$$bound: null | Array&lt;ReactClientValue&gt;"]\n        SR --> location["$$location?: Error (DEV only)"]\n    end\n    \n    subgraph "Symbol Tags"\n        SERVER_TAG["SERVER_REFERENCE_TAG<br/>Symbol.for(\'react.server.reference\')"]\n        CLIENT_TAG["CLIENT_REFERENCE_TAG<br/>Symbol.for(\'react.client.reference\')"]\n    end\n    \n    typeof -.-> SERVER_TAG\n    \n    subgraph "Registration"\n        registerServerReference["registerServerReference()"]\n        isServerReference["isServerReference()"]\n    end\n    \n    registerServerReference --> SR\n    SR --> isServerReference\n    \n    style SR fill:#f9f9f9\n    style typeof fill:#e8f4f8\n    style id fill:#e8f4f8\n    style bound fill:#e8f4f8\n```\n\n**Server Reference Registration**\n\nServer references are created using `registerServerReference()`:\n\nSources: [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js:111-130]()\n\nThe registration process:\n1. Marks the function with `$$typeof: SERVER_REFERENCE_TAG`\n2. Assigns a unique `$$id` (module path + export name)\n3. Initializes `$$bound` to `null`\n4. Attaches custom `.bind()` implementation\n5. In DEV, adds `$$location` for debugging\n\n### Custom Bind Implementation\n\nServer references override `Function.prototype.bind` to support argument binding:\n\n```mermaid\ngraph LR\n    subgraph "Bind Process"\n        Original["serverAction"]\n        BindCall["serverAction.bind(null, arg1, arg2)"]\n        NewRef["New ServerReference"]\n    end\n    \n    Original --> BindCall\n    BindCall --> NewRef\n    \n    subgraph "New Reference Properties"\n        NewRef --> id2["$$id: same as original"]\n        NewRef --> bound2["$$bound: [arg1, arg2]"]\n        NewRef --> bind2["bind: custom implementation"]\n    end\n    \n    style BindCall fill:#fff4e1\n    style NewRef fill:#f9f9f9\n```\n\nSources: [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js:62-103]()\n\nWhen `.bind()` is called on a server reference:\n1. Uses native `Function.prototype.bind` to create new function\n2. Copies `$$typeof` and `$$id` from original\n3. Concatenates new args with `$$bound` from original\n4. Attaches custom `.bind()` to the new function\n\n**Important**: The first argument (thisArg) must be `null` or `undefined`. In DEV, a warning is logged if a non-null thisArg is provided.\n\n---\n\n## Reply Encoding Protocol\n\nThe reply encoding protocol serializes client-side JavaScript values into a format that can be transmitted to the server and reconstructed.\n\n### Encoding Architecture\n\n```mermaid\ngraph TB\n    subgraph "Client Side"\n        ClientValue["Client JavaScript Value"]\n        encodeReply["ReactServerDOMClient.encodeReply()"]\n        processReply["processReply()"]\n        resolveToJSON["resolveToJSON() recursion"]\n    end\n    \n    ClientValue --> encodeReply\n    encodeReply --> processReply\n    processReply --> resolveToJSON\n    \n    subgraph "Serialization Output"\n        StringOutput["JSON string"]\n        FormDataOutput["FormData (for streams/blobs)"]\n    end\n    \n    resolveToJSON --> StringOutput\n    resolveToJSON --> FormDataOutput\n    \n    subgraph "Special Encodings"\n        ServerRef["Server Reference  $h{id}"]\n        Promise["Promise  $@{id}"]\n        TypedArray["TypedArray  ${tag}{id}"]\n        Stream["ReadableStream  $R{id}"]\n        FormDataRef["FormData  $K{id}"]\n        Undefined["undefined  $undefined"]\n        BigInt["BigInt  $n{value}"]\n        Date["Date  $D{isoString}"]\n    end\n    \n    resolveToJSON -.-> ServerRef\n    resolveToJSON -.-> Promise\n    resolveToJSON -.-> TypedArray\n    resolveToJSON -.-> Stream\n    resolveToJSON -.-> FormDataRef\n    resolveToJSON -.-> Undefined\n    resolveToJSON -.-> BigInt\n    resolveToJSON -.-> Date\n    \n    style encodeReply fill:#e8f4f8\n    style processReply fill:#e8f4f8\n```\n\n**Encoding Entry Point**\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:183-465]()\n\nThe `processReply()` function coordinates encoding:\n1. Maintains a `writtenObjects` WeakMap to handle circular references\n2. Tracks `pendingParts` for async values\n3. Upgrades to FormData when binary data or streams are present\n4. Returns either a JSON string or FormData\n\n### Value Encoding Reference\n\n| Type | Encoding | Example |\n|------|----------|---------|\n| `undefined` | `"$undefined"` | `undefined  "$undefined"` |\n| `-0` | `"$-0"` | `-0  "$-0"` |\n| `Infinity` | `"$Infinity"` | `Infinity  "$Infinity"` |\n| `NaN` | `"$NaN"` | `NaN  "$NaN"` |\n| `BigInt` | `"$n" + value` | `123n  "$n123"` |\n| `Date` | `"$D" + isoString` | `new Date()  "$D2024-01-01..."` |\n| `Map` | `"$Q" + id` | Outlined as separate chunk |\n| `Set` | `"$W" + id` | Outlined as separate chunk |\n| `FormData` | `"$K" + id` | Outlined as separate chunk |\n| `Blob` | `"$B" + id` | Outlined as separate chunk |\n| `TypedArray` | `"$" + tag + id` | `Uint8Array  "$o{id}"` |\n| `Promise` | `"$@" + id` | Async resolution |\n| `ServerReference` | `"$h" + id` | Bound args outlined separately |\n| `Iterator` | `"$i" + id` | Single-shot iteration |\n| `AsyncIterable` | `"$x" + id` | Multi-shot async iteration |\n| `ReadableStream` | `"$R" + id` (text) or `"$r" + id` (binary) | Streaming chunks |\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:103-170]()\n\n### Server Reference Encoding\n\nWhen encoding a server reference with bound arguments:\n\n```mermaid\ngraph TB\n    ServerRef["Server Reference"]\n    CheckBound{"Has $$bound?"}\n    \n    ServerRef --> CheckBound\n    \n    CheckBound -->|No| Simple["Encode as $h{id}"]\n    CheckBound -->|Yes| Complex["Outline bound args"]\n    \n    Complex --> EncodeArgs["processReply() on $$bound array"]\n    EncodeArgs --> OutlineChunk["Create separate chunk for args"]\n    OutlineChunk --> Reference["Encode as $h{id} with args reference"]\n    \n    style ServerRef fill:#f9f9f9\n    style Complex fill:#fff4e1\n```\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:556-607]()\n\nProcess:\n1. Check if `$$bound` is non-null\n2. If bound, outline the arguments array as a separate reply chunk\n3. Encode reference as `{id: $$id, bound: chunkId}` structure\n4. If not bound, encode as simple string `"$h" + id`\n\n### Streaming Values\n\nFor streams and async iterables, the encoding creates streaming channels:\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:260-304](), [packages/react-client/src/ReactFlightReplyClient.js:306-381]()\n\n**ReadableStream Encoding:**\n1. Upgrade to FormData mode\n2. Allocate a stream ID\n3. Create a reader and start reading\n4. For each chunk, append serialized value to FormData with stream ID\n5. When done, append close signal `"C"`\n\n**AsyncIterable Encoding:**\n1. Similar to ReadableStream\n2. Distinguish between single-shot (iterator === iterable) and multi-shot\n3. Encode close instruction with optional final value\n\n---\n\n## Reply Decoding Protocol\n\nThe server reconstructs client values from the encoded reply format.\n\n### Decoding Architecture\n\n```mermaid\ngraph TB\n    subgraph "Server Side"\n        EncodedInput["FormData or string body"]\n        decodeReply["ReactServerDOMServer.decodeReply()"]\n        createResponse["createResponse()"]\n        processReplyChunk["processReplyChunk()"]\n    end\n    \n    EncodedInput --> decodeReply\n    decodeReply --> createResponse\n    createResponse --> processReplyChunk\n    \n    subgraph "Response State"\n        ChunksMap["_chunks: Map&lt;number, Chunk&gt;"]\n        FormDataStore["_formData: FormData"]\n        BundlerConfig["_bundlerConfig: ServerManifest"]\n        TempRefs["_temporaryReferences"]\n    end\n    \n    createResponse --> ChunksMap\n    createResponse --> FormDataStore\n    createResponse --> BundlerConfig\n    createResponse --> TempRefs\n    \n    subgraph "Chunk Processing"\n        ParseJSON["JSON.parse() with revivers"]\n        InitializeChunk["initializeModelChunk()"]\n        ResolveRefs["Resolve cross-references"]\n    end\n    \n    processReplyChunk --> ParseJSON\n    ParseJSON --> InitializeChunk\n    InitializeChunk --> ResolveRefs\n    \n    subgraph "Output"\n        ReconstructedValue["Reconstructed JavaScript Value"]\n    end\n    \n    ResolveRefs --> ReconstructedValue\n    \n    style decodeReply fill:#e8f4f8\n    style createResponse fill:#e8f4f8\n```\n\n**Decoding Entry Point**\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:1113-1183]()\n\nThe `decodeReply()` function:\n1. Creates a `Response` object to track state\n2. Parses FormData entries or JSON string\n3. For each chunk, calls `processReplyChunk()`\n4. Returns root chunk (ID 0) as a Promise\n5. Resolves when all referenced chunks are initialized\n\n### Chunk State Machine\n\nEach chunk in the reply goes through these states:\n\n```mermaid\nstateDiagram-v2\n    [*] --> PENDING: Create chunk\n    PENDING --> RESOLVED_MODEL: Receive data\n    RESOLVED_MODEL --> INITIALIZED: Parse JSON\n    RESOLVED_MODEL --> BLOCKED: Reference not ready\n    BLOCKED --> INITIALIZED: All refs ready\n    PENDING --> ERRORED: Parsing error\n    INITIALIZED --> [*]\n    ERRORED --> [*]\n```\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:53-107]()\n\nChunk types:\n- **PendingChunk**: Waiting for data\n- **BlockedChunk**: Data received but references unresolved\n- **ResolvedModelChunk**: JSON string ready to parse\n- **InitializedChunk**: Final value ready\n- **ErroredChunk**: Failed to decode\n\n### JSON Revival\n\nThe decoder uses custom JSON revivers to handle special encodings:\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:595-951]()\n\nThe `parseModelString()` function handles prefixed values:\n- `"$undefined"`  `undefined`\n- `"$-0"`  `-0`\n- `"$Infinity"`  `Infinity`\n- `"$NaN"`  `NaN`\n- `"$n{digits}"`  `BigInt`\n- `"$D{isoString}"`  `Date`\n- `"$Q{id}"`  Reference to Map chunk\n- `"$W{id}"`  Reference to Set chunk\n- `"$h{id}"`  Server reference with optional bound args\n- `"$@{id}"`  Promise reference\n- `"${tag}{id}"`  Typed array reference\n\n### Server Reference Resolution\n\nWhen decoding a server reference:\n\n```mermaid\ngraph TB\n    RefString["$h{id} string"]\n    Parse["Parse reference structure"]\n    \n    RefString --> Parse\n    \n    HasBound{"Has bound args?"}\n    Parse --> HasBound\n    \n    HasBound -->|No| ResolveModule["resolveServerReference(bundlerConfig, id)"]\n    HasBound -->|Yes| DecodeBound["Decode bound args chunk"]\n    \n    DecodeBound --> CreateBound["createBoundServerReference()"]\n    CreateBound --> BoundFunc["Function with bound args"]\n    \n    ResolveModule --> Module["Server module function"]\n    \n    style Parse fill:#e8f4f8\n    style CreateBound fill:#fff4e1\n```\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:716-778]()\n\nProcess:\n1. Parse `$$id` from the reference\n2. If `$$bound` exists, decode the bound arguments chunk\n3. Use `resolveServerReference()` to load the module\n4. If bound, call `createBoundServerReference()` from Reply Client\n5. Return executable function\n\n---\n\n## Form Actions and Progressive Enhancement\n\nServer actions integrate with HTML forms to enable progressive enhancement, where forms work even without JavaScript.\n\n### Form Action Encoding\n\n```mermaid\ngraph TB\n    subgraph "Server Rendering"\n        ServerAction["Server Action Function"]\n        RenderForm["<form action={serverAction}>"]\n    end\n    \n    ServerAction --> RenderForm\n    \n    subgraph "HTML Output"\n        FormTag["<form action=... enctype=...>"]\n        HiddenInputs["Hidden inputs with encoded action"]\n    end\n    \n    RenderForm --> FormTag\n    RenderForm --> HiddenInputs\n    \n    subgraph "Client Behavior"\n        JSDisabled["JS Disabled: Native form submit"]\n        JSEnabled["JS Enabled: Intercept with React"]\n    end\n    \n    FormTag --> JSDisabled\n    FormTag --> JSEnabled\n    \n    JSDisabled --> HTTPPost["POST to server action endpoint"]\n    JSEnabled --> CallAction["Call action with FormData"]\n    \n    style RenderForm fill:#e8f4f8\n    style JSEnabled fill:#d4f4dd\n```\n\n**Form Action Flow**\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:642-686]()\n\nThe `encodeFormAction()` callback is provided by integrations (webpack, etc.):\n1. Takes a server reference ID and bound arguments\n2. Returns a `ReactCustomFormAction` object\n3. Contains action URL and method for form submission\n4. React inserts hidden inputs to encode the action\n\n**Progressive Enhancement:**\n- **Without JS**: Form submits normally to server action endpoint\n- **With JS**: React intercepts submit, encodes FormData, calls action directly\n- Result: Forms work regardless of JS availability\n\n### Form Data Encoding\n\nWhen a form is submitted:\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:688-763]()\n\nThe `encodeFormData()` function:\n1. Walks the FormData entries\n2. Identifies which entries are files/blobs\n3. Creates a filtered FormData with only files\n4. Encodes non-file entries as JSON\n5. Appends the JSON structure to FormData\n6. Returns the combined FormData\n\nThis allows mixing structured data (objects, arrays) with file uploads in a single form submission.\n\n---\n\n## Bound Arguments\n\nServer actions support partial application through `.bind()`, enabling arguments to be pre-bound on the server before sending to the client.\n\n### Binding Flow\n\n```mermaid\nsequenceDiagram\n    participant Server as Server (RSC Render)\n    participant Client as Client\n    participant ServerExec as Server (Action Execution)\n    \n    Server->>Server: Define serverAction()\n    Server->>Server: boundAction = serverAction.bind(null, \'presetArg\')\n    Server->>Client: Serialize boundAction with $$bound\n    \n    Note over Client: Client receives:<br/>{$$id, $$bound: chunk ref}\n    \n    Client->>Client: User calls boundAction(\'userArg\')\n    Client->>Client: encodeReply([\'userArg\'])\n    Client->>ServerExec: POST with encoded args\n    \n    ServerExec->>ServerExec: decodeReply()  [\'userArg\']\n    ServerExec->>ServerExec: Decode $$bound  [\'presetArg\']\n    ServerExec->>ServerExec: Concat: [\'presetArg\', \'userArg\']\n    ServerExec->>ServerExec: Execute serverAction(\'presetArg\', \'userArg\')\n    ServerExec->>Client: Return result\n```\n\n**Bound Arguments Storage**\n\nSources: [packages/react-server/src/ReactFlightServer.js:2507-2566]()\n\nWhen serializing a server reference with `$$bound`:\n1. Server outlines the bound array as a separate chunk\n2. Serializes the reference as `{id, bound}` structure\n3. Client reconstructs with bound args attached\n4. On invocation, concatenates bound args with call args\n\n**Chaining Binds**\n\nMultiple `.bind()` calls accumulate arguments:\n\n```javascript\nconst action1 = serverAction.bind(null, \'a\');\n// action1.$$bound = [\'a\']\n\nconst action2 = action1.bind(null, \'b\');\n// action2.$$bound = [\'a\', \'b\']\n```\n\nSources: [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js:77-80]()\n\n---\n\n## Streaming and Async Values\n\nBoth encoding and decoding support streaming and asynchronous values, enabling progressive data transmission.\n\n### Streaming Reply Encoding\n\n```mermaid\ngraph TB\n    subgraph "Client Encoding Stream"\n        AsyncValue["Promise or AsyncIterable"]\n        StreamID["Allocate stream ID"]\n        InitialReply["Return $@{id} immediately"]\n    end\n    \n    AsyncValue --> StreamID\n    StreamID --> InitialReply\n    \n    subgraph "Async Resolution"\n        ResolveValue["Value resolves"]\n        EncodeResolved["Encode resolved value"]\n        AppendChunk["Append to FormData with stream ID"]\n    end\n    \n    InitialReply --> ResolveValue\n    ResolveValue --> EncodeResolved\n    EncodeResolved --> AppendChunk\n    \n    subgraph "Stream Completion"\n        CloseSignal["Append \'C\' close signal"]\n        ResolvePending["Resolve pending parts counter"]\n    end\n    \n    AppendChunk --> CloseSignal\n    CloseSignal --> ResolvePending\n    \n    style AsyncValue fill:#fff4e1\n    style InitialReply fill:#e8f4f8\n```\n\n**Promise Encoding**\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:466-554]()\n\nThe `serializePromise()` function:\n1. Returns immediately with `$@{id}` reference\n2. Attaches `.then()` handlers to the promise\n3. When resolved, encodes the value\n4. Appends encoded value to FormData with the stream ID\n5. When FormData is complete, resolves the `processReply()` promise\n\n### Async Iterable Encoding\n\nSources: [packages/react-client/src/ReactFlightReplyClient.js:306-381]()\n\nThe `serializeAsyncIterable()` function:\n1. Distinguishes single-shot (iterator === iterable) vs multi-shot\n2. Encodes as `$x{id}` or `$X{id}`\n3. For each iteration result, appends to FormData\n4. Encodes done values if non-undefined\n5. Closes stream with `"C"` signal\n\n### Streaming Reply Decoding\n\nOn the server, streamed values are reconstructed progressively:\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:352-469]()\n\n**Stream Chunk Processing:**\n1. Each FormData entry with a stream ID is a chunk\n2. The first entry creates the stream structure\n3. Subsequent entries enqueue values\n4. The `"C"` entry closes the stream\n\n**Async Iterable Reconstruction:**\n\nSources: [packages/react-server/src/ReactFlightReplyServer.js:411-469]()\n\nThe `createAsyncIterable()` function:\n1. Creates a controller with enqueue/close/error methods\n2. Returns an async iterable that yields queued values\n3. Distinguishes single-shot vs multi-shot based on prefix\n\n---\n\n## Execution Flow Diagram\n\nThis diagram shows a complete round-trip from server action definition to execution:\n\n```mermaid\nsequenceDiagram\n    participant ServerRender as Server (RSC Render)\n    participant FlightStream as Flight Stream\n    participant ClientRuntime as Client Runtime\n    participant UserCode as User Code\n    participant ReplyEncoding as Reply Encoding\n    participant ServerAction as Server (Action Exec)\n    participant ServerModule as Server Module\n    \n    ServerRender->>ServerRender: Define greet(name)\n    ServerRender->>ServerRender: registerServerReference(greet, id)\n    ServerRender->>FlightStream: Serialize {$$typeof, $$id, $$bound}\n    \n    FlightStream->>ClientRuntime: Stream server reference\n    ClientRuntime->>ClientRuntime: Reconstruct proxy function\n    ClientRuntime->>UserCode: Provide greet()\n    \n    Note over UserCode: User clicks button,<br/>calls greet(\'Alice\')\n    \n    UserCode->>ReplyEncoding: greet(\'Alice\')\n    ReplyEncoding->>ReplyEncoding: encodeReply([\'Alice\'])\n    ReplyEncoding->>ServerAction: POST body with encoded args\n    \n    ServerAction->>ServerAction: decodeReply(body)\n    ServerAction->>ServerAction: resolveServerReference(id)\n    ServerAction->>ServerModule: Load module\n    ServerModule->>ServerAction: Return greet function\n    ServerAction->>ServerAction: Execute greet(...decodedArgs)\n    ServerAction->>ClientRuntime: Return result\n    \n    ClientRuntime->>UserCode: Resolve promise with result\n```\n\n**Complete Workflow:**\n\n1. **Server Render Phase**: Define and register server actions\n2. **Flight Streaming**: Serialize references with IDs\n3. **Client Reconstruction**: Create callable proxy functions\n4. **User Invocation**: Call action from client code\n5. **Reply Encoding**: Serialize arguments as FormData/JSON\n6. **Server Reception**: Decode reply and resolve module\n7. **Execution**: Run actual server function\n8. **Result Return**: Stream response back to client\n\nSources: [packages/react-server/src/ReactFlightServer.js:2507-2566](), [packages/react-client/src/ReactFlightReplyClient.js:183-465](), [packages/react-server/src/ReactFlightReplyServer.js:1113-1183]()\n\n---\n\n## Key Implementation Files\n\n| Component | File Path | Key Functions |\n|-----------|-----------|---------------|\n| Server Reference Registration | [packages/react-server-dom-webpack/src/ReactFlightWebpackReferences.js]() | `registerServerReference()`, `isServerReference()`, custom `bind()` |\n| Reply Encoding | [packages/react-client/src/ReactFlightReplyClient.js]() | `encodeReply()`, `processReply()`, `resolveToJSON()` |\n| Reply Decoding | [packages/react-server/src/ReactFlightReplyServer.js]() | `decodeReply()`, `processReplyChunk()`, `parseModelString()` |\n| Server Reference Execution | [packages/react-server/src/ReactFlightReplyServer.js:716-778]() | Server reference resolution and bound arg handling |\n| Form Action Encoding | [packages/react-client/src/ReactFlightReplyClient.js:642-763]() | `encodeFormAction()`, `encodeFormData()` |\n| Bound Server References | [packages/react-client/src/ReactFlightReplyClient.js:69-71]() | `createBoundServerReference()`, `registerBoundServerReference()` |\n\nSources: All files listed in the table above.\n\n---\n\n# Page: Platform Implementations\n\n# Platform Implementations\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis section documents React\'s **platform implementations**the concrete renderers that adapt React\'s reconciler to specific environments. React maintains official implementations for browser DOM ([React DOM Implementation](#6.1)) and React Native ([React Native Renderers](#6.2)), along with specialized features like client-side hydration ([Hydration System](#6.3)) and view transitions ([View Transitions and Gesture Scheduling](#6.4)).\n\nThe foundation enabling these diverse platforms is the **host configuration abstraction layer**an interface between the reconciler and platform-specific code. The host config provides platform-specific implementations of operations like creating instances, updating properties, and managing tree structure. This abstraction allows the same reconciler logic to render to browser DOM, React Native, canvas-based renderers, test environments, and custom targets.\n\nFor the reconciler\'s architecture and how it processes the Fiber tree, see [React Reconciler](#4).\n\n## Platform Overview\n\nReact\'s architecture separates the **reconciler** (platform-agnostic tree diffing and scheduling) from **renderers** (platform-specific instance management and DOM/native manipulation). The primary platforms are:\n\n**React DOM** ([ReactFiberConfigDOM](#6.1)): Renders to browser DOM. Supports mutation mode, hydration of server-rendered HTML, resource management (stylesheets, scripts), singleton components (document head), and view transitions.\n\n**React Native Fabric** ([ReactFiberConfigFabric](#6.2)): New React Native architecture using persistence mode with immutable shadow nodes. Communicates with `nativeFabricUIManager` for native UI operations.\n\n**React Native Legacy** ([ReactFiberConfigNative](#6.2)): Original React Native renderer using mutation mode. Communicates with `UIManager` for native view management.\n\n**Test Renderer** ([ReactFiberConfigTestHost](#6.2)): In-memory tree representation for snapshot testing without actual rendering.\n\n**Noop Renderer** (createReactNoop): Testing-only renderer supporting both mutation and persistence modes for validating reconciler behavior.\n\nEach platform implements the host configuration interface to provide its specific behavior while using the shared reconciler logic.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-153](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-82](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:1-58](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:1-26](), [packages/react-noop-renderer/src/createReactNoop.js:1-111]()\n\n## Host Configuration Architecture\n\nThe host configuration interface defines a contract between the reconciler and the platform. The reconciler calls host config methods during the render and commit phases to perform platform-specific operations. Each renderer (react-dom, react-native-renderer, react-test-renderer, etc.) provides its own implementation of this interface.\n\n```mermaid\ngraph TB\n    subgraph "React Core"\n        Reconciler["Reconciler<br/>(WorkLoop, BeginWork, CommitWork)"]\n    end\n    \n    subgraph "Host Config Interface"\n        HostConfigInterface["Host Configuration Interface<br/>createInstance, commitUpdate,<br/>appendChild, etc."]\n    end\n    \n    subgraph "Platform Implementations"\n        DOM["ReactFiberConfigDOM<br/>Browser DOM operations"]\n        Fabric["ReactFiberConfigFabric<br/>React Native Fabric<br/>(Persistence Mode)"]\n        NativeLegacy["ReactFiberConfigNative<br/>React Native Legacy<br/>(Mutation Mode)"]\n        TestRenderer["ReactFiberConfigTestHost<br/>Test environment"]\n        NoopRenderer["createReactNoop<br/>Testing reconciler"]\n        CustomRenderer["ReactFiberConfig.custom<br/>Third-party renderers"]\n    end\n    \n    subgraph "Native APIs"\n        BrowserAPIs["Browser DOM APIs<br/>document.createElement,<br/>appendChild, etc."]\n        FabricUIManager["nativeFabricUIManager<br/>createNode, cloneNode,<br/>completeRoot"]\n        LegacyUIManager["UIManager<br/>createView, updateView,<br/>manageChildren"]\n        MemoryTree["In-Memory Tree<br/>(for testing)"]\n    end\n    \n    Reconciler -->|"calls"| HostConfigInterface\n    \n    HostConfigInterface -->|"implemented by"| DOM\n    HostConfigInterface -->|"implemented by"| Fabric\n    HostConfigInterface -->|"implemented by"| NativeLegacy\n    HostConfigInterface -->|"implemented by"| TestRenderer\n    HostConfigInterface -->|"implemented by"| NoopRenderer\n    HostConfigInterface -->|"implemented by"| CustomRenderer\n    \n    DOM --> BrowserAPIs\n    Fabric --> FabricUIManager\n    NativeLegacy --> LegacyUIManager\n    TestRenderer --> MemoryTree\n    NoopRenderer --> MemoryTree\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-292](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-160](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:1-115](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:1-59](), [packages/react-noop-renderer/src/createReactNoop.js:1-111]()\n\n## Core Host Configuration Methods\n\nThe host configuration interface consists of several categories of methods that the reconciler invokes at different stages of the rendering process.\n\n```mermaid\ngraph LR\n    subgraph "Instance Management"\n        createInstance["createInstance<br/>(type, props, rootContainer, hostContext)"]\n        createTextInstance["createTextInstance<br/>(text, rootContainer, hostContext)"]\n        createHoistableInstance["createHoistableInstance<br/>(type, props, rootContainer)<br/>(DOM only)"]\n    end\n    \n    subgraph "Context Management"\n        getRootHostContext["getRootHostContext<br/>(rootContainer)"]\n        getChildHostContext["getChildHostContext<br/>(parentContext, type)"]\n    end\n    \n    subgraph "Initial Render"\n        appendInitialChild["appendInitialChild<br/>(parent, child)"]\n        finalizeInitialChildren["finalizeInitialChildren<br/>(instance, type, props)"]\n    end\n    \n    subgraph "Commit Phase"\n        commitMount["commitMount<br/>(instance, type, props)"]\n        commitUpdate["commitUpdate<br/>(instance, type, oldProps, newProps)"]\n        commitTextUpdate["commitTextUpdate<br/>(textInstance, oldText, newText)"]\n    end\n    \n    subgraph "Tree Manipulation - Mutation"\n        appendChild["appendChild<br/>(parent, child)"]\n        insertBefore["insertBefore<br/>(parent, child, beforeChild)"]\n        removeChild["removeChild<br/>(parent, child)"]\n    end\n    \n    subgraph "Tree Manipulation - Persistence"\n        cloneInstance["cloneInstance<br/>(instance, type, oldProps, newProps)"]\n        createContainerChildSet["createContainerChildSet"]\n        replaceContainerChildren["replaceContainerChildren<br/>(container, newChildren)"]\n    end\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:484-608](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:176-220](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:130-169](), [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:56-188]()\n\n## Platform Type Definitions\n\nEach platform implementation defines its own types for instances, containers, and other platform-specific data structures:\n\n| Type | ReactFiberConfigDOM | ReactFiberConfigFabric | ReactFiberConfigNative | ReactFiberConfigTestHost |\n|------|---------------------|------------------------|------------------------|--------------------------|\n| **Type** | `string` (element tag name) | `string` (view type) | `string` (view type) | `string` |\n| **Instance** | `Element` (DOM element) | `{node: Node, canonical: {...}}` (shadow node) | `ReactNativeFiberHostComponent` | `{type, props, children, tag: \'INSTANCE\'}` |\n| **TextInstance** | `Text` (DOM text node) | `{node: Node}` (text shadow node) | `number` (text tag) | `{text, tag: \'TEXT\'}` |\n| **Container** | `Element \\| Document \\| DocumentFragment` | `{containerTag: number, publicInstance}` | `{containerTag: number, publicInstance}` | `{children: [], createNodeMock, tag: \'CONTAINER\'}` |\n| **HostContext** | `HostContextNamespace` (0=None, 1=SVG, 2=Math) | `{isInAParentText: boolean}` | `{isInAParentText: boolean}` | `Object` (NO_CONTEXT) |\n| **UpdatePayload** | `Array<mixed>` (property updates) | `Object` (attribute payload) | `Object` (unused) | `Object` |\n| **Mode** | Mutation | Persistence | Mutation | Mutation |\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:153-250](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:93-139](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:59-73](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:26-58]()\n\n## Mutation vs Persistence Modes\n\nHost configurations can operate in two different modes depending on the platform\'s capabilities:\n\n```mermaid\ngraph TB\n    subgraph "Mutation Mode (DOM, React Native Legacy, Test Renderer)"\n        MutationFlag["supportsMutation = true<br/>supportsPersistence = false"]\n        \n        MutationRender["Render Phase:<br/>Create instances and build tree"]\n        MutationCommit["Commit Phase:<br/>Mutate existing instances in-place"]\n        \n        MutationOps["Operations:<br/> appendChild<br/> insertBefore<br/> removeChild<br/> commitUpdate (mutate props)<br/> commitTextUpdate"]\n        \n        MutationFlag --> MutationRender\n        MutationRender --> MutationCommit\n        MutationCommit --> MutationOps\n    end\n    \n    subgraph "Persistence Mode (React Native Fabric)"\n        PersistenceFlag["supportsMutation = false<br/>supportsPersistence = true"]\n        \n        PersistenceRender["Render Phase:<br/>Clone and build new tree"]\n        PersistenceCommit["Commit Phase:<br/>Replace entire tree atomically"]\n        \n        PersistenceOps["Operations:<br/> cloneInstance<br/> createContainerChildSet<br/> appendChildToContainerChildSet<br/> replaceContainerChildren<br/> No in-place mutations"]\n        \n        PersistenceFlag --> PersistenceRender\n        PersistenceRender --> PersistenceCommit\n        PersistenceCommit --> PersistenceOps\n    end\n```\n\n**Mutation Mode** (DOM, React Native Legacy): Instances can be mutated in place. The reconciler creates instances once and then updates them by calling methods like `commitUpdate`, `appendChild`, `removeChild`. This is more memory efficient but requires careful synchronization.\n\n**Persistence Mode** (React Native Fabric): Instances are immutable. The reconciler clones instances to create modified versions, builds a complete new tree, and replaces the old tree atomically. This provides better concurrency characteristics and aligns with React Native\'s new architecture.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:811](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:449](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:377](), [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js:22]()\n\n## Platform-Specific Instance Creation\n\nEach platform implements `createInstance` differently based on its underlying rendering API. DOM creates actual browser elements with namespace handling for SVG/MathML, while React Native allocates tags and communicates with native UI managers. For detailed implementation specifics, see [React DOM Implementation](#6.1) and [React Native Renderers](#6.2).\n\n**DOM**: Calls `document.createElement()` or `document.createElementNS()` based on namespace context, then sets initial properties and caches the fiber node reference.\n\n**React Native Fabric**: Allocates a unique tag, gets the view configuration, creates an attribute payload, and calls `nativeFabricUIManager.createNode()` to create an immutable shadow node.\n\n**React Native Legacy**: Allocates a tag, creates an update payload, calls `UIManager.createView()`, and wraps the result in a `ReactNativeFiberHostComponent` instance.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:484-608](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:176-220](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:130-169]()\n\n## Host Context Management\n\nHost context flows down the tree during rendering and provides namespace/environment information needed for instance creation. Different platforms use it for different purposes:\n\n**DOM**: Tracks namespace (None, SVG, Math) to create elements with the correct namespace. SVG and MathML elements require `createElementNS`.\n\n```\ngetRootHostContext: Determine initial namespace from root element\ngetChildHostContext: Update namespace when entering/leaving <svg>, <math>, or <foreignObject>\n```\n\n**React Native**: Tracks whether rendering is occurring within a Text component, which affects validation (text strings must be inside `<Text>`).\n\n```\ngetRootHostContext: Returns {isInAParentText: false}\ngetChildHostContext: Updates isInAParentText based on component type (RCTText, AndroidTextInput, etc.)\n```\n\n**Test/Noop Renderers**: Returns a constant `NO_CONTEXT` object since no special context is needed.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:302-406](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:259-291](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:264-287]()\n\n## Priority and Event Management\n\nHost configurations provide methods for managing update priorities and tracking events:\n\n| Method | Purpose | DOM Implementation | React Native Implementation |\n|--------|---------|-------------------|----------------------------|\n| `setCurrentUpdatePriority` | Set the current update priority | Stores in module variable | Stores in module variable |\n| `getCurrentUpdatePriority` | Get the current update priority | Returns stored priority | Returns stored priority |\n| `resolveUpdatePriority` | Resolve priority for a batch of work | Returns current or defers to event priority | Returns current or default priority |\n| `trackSchedulerEvent` | Track the current browser event | Stores `window.event` | No-op |\n| `resolveEventType` | Get the current event type | Returns `window.event.type` | Returns null |\n| `resolveEventTimeStamp` | Get the current event timestamp | Returns `window.event.timeStamp` | Returns -1.1 |\n| `shouldAttemptEagerTransition` | Check if should render transitions synchronously | Checks if `popstate` event | Returns false |\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:709-747](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:386-433](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:343-371]()\n\n## Commit Lifecycle Methods\n\nThe reconciler invokes these methods during the commit phase to finalize changes:\n\n**`prepareForCommit(containerInfo)`**: Called before mutations begin. Returns an object that will be passed to `resetAfterCommit`. DOM uses this to disable events and capture selection state. React Native returns null (no-op).\n\n**`resetAfterCommit(containerInfo)`**: Called after mutations complete. DOM restores event handling and selection. React Native is a no-op.\n\n**`commitMount(instance, type, props, internalInstanceHandle)`**: Called for instances that returned `true` from `finalizeInitialChildren`. Used to implement effects that should happen after the instance is in the tree (e.g., auto-focus, triggering image load events).\n\n**`commitUpdate(instance, type, oldProps, newProps, internalInstanceHandle)`**: Called to update an existing instance with new props. DOM calls `updateProperties` to diff and apply property changes. React Native calls `UIManager.updateView` with diffed payload.\n\n**`commitTextUpdate(textInstance, oldText, newText)`**: Called to update a text node. DOM sets `nodeValue`, React Native calls `UIManager.updateView`.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:412-450](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:813-872](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:917-942](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:317-467]()\n\n## Hydration Support\n\nReact DOM implements client-side **hydration** to attach React to server-rendered HTML. The host config provides methods for traversing and validating existing DOM nodes during initial render:\n\n**`hydrateInstance(instance, type, props, hostContext)`**: Validates and updates a DOM element to match React props. Returns an update payload if properties differ.\n\n**`hydrateTextInstance(textInstance, text, internalInstanceHandle)`**: Validates text node content matches expected text. Returns `true` if text differs (triggering a warning in DEV).\n\n**`getNextHydratableSibling(instance)`**: Returns the next DOM sibling that can be hydrated.\n\n**`getFirstHydratableChild(parentInstance)`**: Returns the first hydratable child of a DOM node.\n\n**`hydrateRootInstance(container)`**: Clears comment nodes and prepares the root container for hydration.\n\n**`shouldDeleteUnhydratedTailInstances()`**: Returns `true` to delete remaining DOM nodes after hydration completes.\n\nThe hydration process handles mismatches, supports Suspense boundaries, and enables selective hydration for improved time-to-interactive. For complete details, see [Hydration System](#6.3).\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1281-1590]()\n\n## View Transitions and Gesture Scheduling\n\nReact DOM includes experimental support for the View Transition API to enable smooth animated transitions between UI states. The host config provides methods for managing view transition instances and gesture-driven animations:\n\n**`startViewTransition(root, updater, options)`**: Initiates a view transition with callback for custom animation timelines.\n\n**`cloneMutableInstance(instance, keepChildren)`**: Clones DOM elements to create animation pairs for view transitions.\n\n**View Transition Instance Management**: Methods for applying/restoring transition names, measuring instance geometry, and tracking viewport visibility.\n\n**Gesture Scheduling**: Integration with gesture recognizers to drive view transitions based on user input (swipes, drags).\n\nThe system coordinates with `ReactFiberCommitViewTransitions` to identify animated elements, clone instances for animation pairs, measure geometry changes, and execute transition animations. For complete details, see [View Transitions and Gesture Scheduling](#6.4).\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:613-638](), [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js:1-50](), [packages/react-reconciler/src/ReactFiberApplyGesture.js:1-100]()\n\n## Testing and Third-Party Renderers\n\n### Test Renderer\n\nThe test renderer creates an in-memory tree representation without rendering to any actual surface. Instances are plain objects with `tag: \'INSTANCE\'` or `tag: \'TEXT\'`. This is used for snapshot testing and asserting on React\'s output without a DOM.\n\n**Sources:** [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:158-174](), [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:216-227]()\n\n### Noop Renderer\n\nThe noop renderer is similar to the test renderer but provides both mutation and persistence mode implementations. It\'s primarily used for testing the reconciler itself and validating reconciler behavior without platform-specific complications.\n\n**Sources:** [packages/react-noop-renderer/src/createReactNoop.js:111-452]()\n\n### Custom Renderers (Third-Party)\n\nThe `react-reconciler` package allows third parties to create custom renderers by passing a host config object to the reconciler factory function. The `ReactFiberConfig.custom.js` file serves as a shim that forwards all host config methods from a `$$$config` variable (passed as an argument to the reconciler bundle).\n\n```mermaid\ngraph LR\n    CustomRenderer["Custom Renderer Package"]\n    HostConfigObject["Host Config Object<br/>{createInstance, commitUpdate, ...}"]\n    ReconcilerFactory["ReactFiberReconciler(config)"]\n    ReconcilerInstance["Reconciler Instance<br/>{createContainer, updateContainer, ...}"]\n    \n    CustomRenderer --> HostConfigObject\n    HostConfigObject --> ReconcilerFactory\n    ReconcilerFactory --> ReconcilerInstance\n    \n    ReconcilerInstance -->|"calls during render/commit"| HostConfigObject\n```\n\n**Sources:** [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js:1-285](), [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js:41-121]()\n\n## Optional Features and Capabilities\n\nHost configurations can opt into or out of various capabilities by implementing specific methods or setting flags:\n\n| Feature | Flag/Methods | DOM | Fabric | Native Legacy | Test |\n|---------|-------------|-----|--------|---------------|------|\n| **Mutation** | `supportsMutation` |  |  |  |  |\n| **Persistence** | `supportsPersistence` |  |  |  |  |\n| **Hydration** | `supportsHydration` |  |  |  |  |\n| **Microtasks** | `supportsMicrotasks` |  |  |  |  |\n| **Resources** | `supportsResources` |  |  |  |  |\n| **Singletons** | `supportsSingletons` |  |  |  |  |\n| **Test Selectors** | `supportsTestSelectors` |  |  |  |  |\n| **Fragment Instances** | `createFragmentInstance` |  |  | No-op | No-op |\n| **View Transitions** | `startViewTransition` | Planned | No-op | No-op | No-op |\n\nMost platforms import default implementations for unsupported features from modules like `ReactFiberConfigWithNoHydration`, `ReactFiberConfigWithNoResources`, etc., which provide no-op implementations or throw errors.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:292](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:160-165](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:115-121](), [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js:22-60]()\n\n## Summary\n\nThe host configuration abstraction is the foundation of React\'s platform independence. By defining a clear interface between the reconciler and platform-specific code, React can:\n\n- Render to vastly different targets (DOM, native mobile, canvas, terminals, etc.)\n- Support different rendering paradigms (mutation vs persistence)\n- Optimize for platform-specific capabilities (hydration, resources, singletons)\n- Enable third-party renderers without forking the reconciler\n\nEach platform implementation makes trade-offs based on its constraintsDOM uses mutation for efficiency and hydration support, Fabric uses persistence for better concurrency, test renderers prioritize simplicity and determinism. The host config interface accommodates all these approaches while keeping the reconciler\'s core logic platform-agnostic.\n\n---\n\n# Page: React DOM Implementation\n\n# React DOM Implementation\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes the React DOM host configuration implementation (`ReactFiberConfigDOM`), which serves as the bridge between React\'s reconciler and the browser\'s DOM APIs. This implementation defines how React creates, updates, and manages DOM elements during rendering and commits.\n\nFor information about the host configuration abstraction itself, see [Host Configuration Abstraction](#4.6). For hydration-specific functionality, see [Hydration System](#6.3). For view transition coordination, see [View Transitions and Gesture Scheduling](#6.4).\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-150]()\n\n## Architecture Overview\n\nThe DOM host configuration implements the interface expected by the React reconciler, translating reconciler operations into browser DOM manipulations. It operates in mutation mode, directly modifying the DOM tree as changes occur.\n\n```mermaid\ngraph TB\n    subgraph "React Reconciler"\n        Reconciler["React Reconciler<br/>Work Loop & Commit"]\n        HostConfigInterface["Host Config Interface<br/>createInstance, commitUpdate, etc."]\n    end\n    \n    subgraph "ReactFiberConfigDOM"\n        InstanceCreation["Instance Creation<br/>createInstance()<br/>createTextInstance()"]\n        PropertyMgmt["Property Management<br/>setInitialProperties()<br/>updateProperties()"]\n        MutationOps["Mutation Operations<br/>appendChild()<br/>insertBefore()<br/>commitUpdate()"]\n        EventIntegration["Event Integration<br/>listenToAllSupportedEvents()"]\n        ResourceMgmt["Resource Management<br/>createHoistableInstance()"]\n        HostContext["Host Context<br/>Namespace Tracking"]\n    end\n    \n    subgraph "Browser APIs"\n        DOM["DOM APIs<br/>createElement, appendChild, etc."]\n        EventSystem["Browser Event System"]\n    end\n    \n    Reconciler --> HostConfigInterface\n    HostConfigInterface --> InstanceCreation\n    HostConfigInterface --> PropertyMgmt\n    HostConfigInterface --> MutationOps\n    HostConfigInterface --> ResourceMgmt\n    HostConfigInterface --> HostContext\n    \n    InstanceCreation --> DOM\n    PropertyMgmt --> DOM\n    MutationOps --> DOM\n    EventIntegration --> EventSystem\n    ResourceMgmt --> DOM\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-292]()\n\n## Type System\n\nReactFiberConfigDOM defines the core types that represent DOM constructs within the reconciler.\n\n### Core Types\n\n| Type | Definition | Description |\n|------|------------|-------------|\n| `Type` | `string` | Element type (e.g., \'div\', \'span\') |\n| `Props` | `object` | React props object with DOM-specific properties |\n| `Container` | `Element \\| Document \\| DocumentFragment` | Root container element with `_reactRootContainer` field |\n| `Instance` | `Element` | A DOM element instance |\n| `TextInstance` | `Text` | A DOM text node |\n| `HostContext` | `HostContextDev \\| HostContextProd` | Namespace context (SVG, MathML, or HTML) |\n| `UpdatePayload` | `Array<mixed>` | Array of alternating property keys and values |\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:153-248]()\n\n### Instance Types Diagram\n\n```mermaid\ngraph LR\n    Container["Container<br/>(Element/Document/DocumentFragment)"]\n    Instance["Instance<br/>(Element)"]\n    TextInstance["TextInstance<br/>(Text)"]\n    HydratableInstance["HydratableInstance<br/>(Instance | TextInstance | SuspenseInstance | ActivityInstance)"]\n    \n    Container -->|"contains"| Instance\n    Container -->|"contains"| TextInstance\n    Instance -->|"children"| Instance\n    Instance -->|"children"| TextInstance\n    Instance -.->|"is a"| HydratableInstance\n    TextInstance -.->|"is a"| HydratableInstance\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:211-237]()\n\n## Host Context Management\n\nThe host context tracks the current namespace (HTML, SVG, MathML) to ensure elements are created with the correct namespace URI. This is critical for proper rendering of SVG and MathML elements within HTML documents.\n\n### Namespace Constants\n\n```mermaid\ngraph TD\n    HostContextNamespace["HostContextNamespace<br/>opaque type: 0 | 1 | 2"]\n    \n    HostContextNamespace --> None["HostContextNamespaceNone = 0<br/>(HTML namespace)"]\n    HostContextNamespace --> Svg["HostContextNamespaceSvg = 1<br/>(SVG namespace)"]\n    HostContextNamespace --> Math["HostContextNamespaceMath = 2<br/>(MathML namespace)"]\n```\n\n### Context Flow\n\nThe reconciler calls `getRootHostContext` when entering a root container, then `getChildHostContext` for each child element to determine the appropriate namespace.\n\n```mermaid\ngraph TB\n    GetRoot["getRootHostContext(rootContainer)"]\n    CheckNodeType{"rootContainer<br/>nodeType"}\n    DocumentNode["DOCUMENT_NODE or<br/>DOCUMENT_FRAGMENT_NODE"]\n    ElementNode["ELEMENT_NODE"]\n    \n    GetRoot --> CheckNodeType\n    CheckNodeType -->|"9 or 11"| DocumentNode\n    CheckNodeType -->|"1"| ElementNode\n    \n    DocumentNode --> CheckDocElement{"documentElement<br/>namespaceURI"}\n    CheckDocElement -->|"svg"| ReturnSvg["Return HostContextNamespaceSvg"]\n    CheckDocElement -->|"math"| ReturnMath["Return HostContextNamespaceMath"]\n    CheckDocElement -->|"other"| ReturnNone["Return HostContextNamespaceNone"]\n    \n    ElementNode --> GetOwnContext["getOwnHostContext(namespaceURI)"]\n    GetOwnContext --> GetChildContext["getChildHostContextProd(context, type)"]\n```\n\nKey functions:\n- `getRootHostContext(rootContainerInstance)` [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:302-355]()\n- `getChildHostContext(parentHostContext, type)` [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:391-406]()\n- `getChildHostContextProd(parentNamespace, type)` [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:368-389]()\n\n### Namespace Transitions\n\nSpecial handling exists for namespace transitions:\n- Entering `<svg>` from HTML switches to SVG namespace\n- Entering `<math>` from HTML switches to MathML namespace  \n- `<foreignObject>` within SVG returns to HTML namespace\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:284-406]()\n\n## Instance Creation\n\nDOM instances are created during the reconciler\'s render phase and finalized during the commit phase.\n\n### Regular Instance Creation\n\n```mermaid\ngraph TB\n    CreateInstance["createInstance(type, props, rootContainer, hostContext, fiber)"]\n    \n    CreateInstance --> CheckContext{"hostContext<br/>namespace"}\n    \n    CheckContext -->|"Svg"| CreateSvg["ownerDocument.createElementNS<br/>(SVG_NAMESPACE, type)"]\n    CheckContext -->|"Math"| CreateMath["ownerDocument.createElementNS<br/>(MATH_NAMESPACE, type)"]\n    CheckContext -->|"None"| CheckSpecial{"Special element?"}\n    \n    CheckSpecial -->|"\'script\'"| CreateScript["Create via innerHTML<br/>to prevent execution"]\n    CheckSpecial -->|"\'select\'"| CreateSelect["createElement(\'select\')<br/>+ handle multiple/size"]\n    CheckSpecial -->|"other"| CreateNormal["createElement(type)"]\n    \n    CreateSvg --> Cache["precacheFiberNode(fiber, element)"]\n    CreateMath --> Cache\n    CreateScript --> Cache\n    CreateSelect --> Cache\n    CreateNormal --> Cache\n    \n    Cache --> UpdateProps["updateFiberProps(element, props)"]\n    UpdateProps --> Return["Return element"]\n```\n\nThe `createInstance` function:\n1. Determines the owner document from the root container\n2. Creates the element with the appropriate namespace\n3. Caches the fiber-to-DOM mapping via `precacheFiberNode`\n4. Stores props on the DOM node via `updateFiberProps`\n5. Does NOT call `setInitialProperties` (that happens in `finalizeInitialChildren`)\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:484-608]()\n\n### Hoistable Instance Creation\n\nHoistable instances are special DOM elements (like `<link>`, `<style>`, `<script>`) that can be "hoisted" to the document head for resource management.\n\n```mermaid\ngraph LR\n    CreateHoistable["createHoistableInstance(type, props, rootContainer, fiber)"]\n    CreateHoistable --> CreateElem["createElement(type)"]\n    CreateElem --> PrecacheAndProps["precacheFiberNode + updateFiberProps"]\n    PrecacheAndProps --> SetInitial["setInitialProperties(element, type, props)"]\n    SetInitial --> Mark["markNodeAsHoistable(element)"]\n    Mark --> Return["Return element"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:452-468]()\n\n### Text Instance Creation\n\nText nodes are simpler:\n\n```mermaid\ngraph LR\n    CreateText["createTextInstance(text, rootContainer, hostContext, fiber)"]\n    CreateText --> Validate["validateTextNesting<br/>(DEV only)"]\n    Validate --> CreateNode["ownerDocument.createTextNode(text)"]\n    CreateNode --> Precache["precacheFiberNode(fiber, textNode)"]\n    Precache --> Return["Return textNode"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:679-701]()\n\n## Property Management\n\nProperties (React props) are translated into DOM attributes and properties through dedicated helper modules.\n\n### Property Application Flow\n\n```mermaid\ngraph TB\n    Mount["Mount (New Element)"]\n    Update["Update (Existing Element)"]\n    \n    Mount --> AppendChild["appendInitialChild(parent, child)"]\n    AppendChild --> Finalize["finalizeInitialChildren(element, type, props)"]\n    Finalize --> SetInitial["setInitialProperties(element, type, props)"]\n    \n    Update --> CommitUpdate["commitUpdate(element, type, oldProps, newProps)"]\n    CommitUpdate --> UpdateProps["updateProperties(element, type, oldProps, newProps)"]\n    UpdateProps --> UpdateFiberProps["updateFiberProps(element, newProps)"]\n```\n\nKey functions from `ReactDOMComponent`:\n- `setInitialProperties(domElement, tag, props)` - Applied during finalization [packages/react-dom-bindings/src/client/ReactDOMComponent.js]()\n- `updateProperties(domElement, tag, lastProps, nextProps)` - Applied during commit update [packages/react-dom-bindings/src/client/ReactDOMComponent.js]()\n\nSpecial property handling includes:\n- `dangerouslySetInnerHTML` - Sets innerHTML\n- `children` (when string/number) - Sets textContent  \n- `style` - Object converted to CSS string\n- `autoFocus` - Handled in `commitMount`\n- Event handlers - Registered with event system\n- `value`, `checked`, `selected` - Special form control properties\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:78-86](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:917-930]()\n\n## Mutation Operations\n\nReactFiberConfigDOM operates in mutation mode (`supportsMutation = true`), directly modifying the DOM tree. All mutation operations support the `moveBefore` API when available.\n\n### Core Mutation Methods\n\n| Method | Purpose | When Called |\n|--------|---------|-------------|\n| `appendChild(parent, child)` | Append child to end | Repositioning during updates |\n| `appendChildToContainer(container, child)` | Append to root container | Mounting root content |\n| `insertBefore(parent, child, before)` | Insert child before sibling | Reordering, insertion |\n| `insertInContainerBefore(container, child, before)` | Insert into root before sibling | Root-level insertions |\n| `removeChild(parent, child)` | Remove child from parent | Deletions |\n| `removeChildFromContainer(container, child)` | Remove from root | Root-level deletions |\n\n### moveBefore Feature Detection\n\nReact detects and uses the `moveBefore` DOM API when available for more efficient repositioning:\n\n```mermaid\ngraph TB\n    AppendChild["appendChild(parentInstance, child)"]\n    \n    CheckMoveBefore{"supportsMoveBefore &&<br/>child.parentNode !== null"}\n    \n    AppendChild --> CheckMoveBefore\n    CheckMoveBefore -->|"true"| UseMoveBefore["parentInstance.moveBefore(child, null)"]\n    CheckMoveBefore -->|"false"| UseAppend["parentInstance.appendChild(child)"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:944-960]()\n\n### Commit Operations\n\n```mermaid\ngraph TB\n    CommitMount["commitMount(element, type, props, fiber)"]\n    CommitUpdate["commitUpdate(element, type, oldProps, newProps, fiber)"]\n    CommitTextUpdate["commitTextUpdate(textInstance, oldText, newText)"]\n    \n    CommitMount --> CheckAutoFocus{"type matches form element<br/>& autoFocus?"}\n    CheckAutoFocus -->|"yes"| Focus["element.focus()"]\n    CheckAutoFocus -->|"img + src"| ReassignSrc["Reassign src/srcSet<br/>to trigger load event"]\n    \n    CommitUpdate --> UpdateProperties["updateProperties(element, type, oldProps, newProps)"]\n    UpdateProperties --> UpdateFiberProps["updateFiberProps(element, newProps)"]\n    \n    CommitTextUpdate --> SetNodeValue["textInstance.nodeValue = newText"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:813-872](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:917-942]()\n\n## Event System Integration\n\nReactFiberConfigDOM integrates with React\'s synthetic event system through several key functions.\n\n### Event Setup\n\n```mermaid\ngraph LR\n    PrepareForCommit["prepareForCommit(container)"]\n    PrepareForCommit --> DisableEvents["ReactBrowserEventEmitterSetEnabled(false)"]\n    DisableEvents --> SaveSelection["getSelectionInformation(container)"]\n    \n    ResetAfterCommit["resetAfterCommit(container)"]\n    ResetAfterCommit --> RestoreSelection["restoreSelection(selectionInfo, container)"]\n    RestoreSelection --> EnableEvents["ReactBrowserEventEmitterSetEnabled(true)"]\n    \n    PreparePortal["preparePortalMount(portalInstance)"]\n    PreparePortal --> ListenAll["listenToAllSupportedEvents(portalInstance)"]\n```\n\nThe event system is temporarily disabled during commits to prevent unwanted event dispatching while the DOM is being mutated.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:412-450](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:767-769]()\n\n### Priority and Event Tracking\n\n```mermaid\ngraph TB\n    TrackEvent["trackSchedulerEvent()"]\n    TrackEvent --> SaveEvent["schedulerEvent = window.event"]\n    \n    ResolveType["resolveEventType()"]\n    ResolveType --> CheckEvent{"event && event !== schedulerEvent?"}\n    CheckEvent -->|"yes"| ReturnType["Return event.type"]\n    CheckEvent -->|"no"| ReturnNull["Return null"]\n    \n    ResolveTimestamp["resolveEventTimeStamp()"]\n    ResolveTimestamp --> CheckEvent2{"event && event !== schedulerEvent?"}\n    CheckEvent2 -->|"yes"| ReturnTS["Return event.timeStamp"]\n    CheckEvent2 -->|"no"| ReturnDefault["Return -1.1"]\n```\n\nThese functions help the reconciler determine the priority and nature of the current event for scheduling purposes.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:734-747]()\n\n### Eager Transitions\n\n```mermaid\ngraph TB\n    ShouldAttempt["shouldAttemptEagerTransition()"]\n    CheckEventType{"event.type === \'popstate\'"}\n    \n    ShouldAttempt --> CheckEventType\n    CheckEventType -->|"no"| ReturnFalse["Return false"]\n    CheckEventType -->|"yes"| CheckCached{"event === currentPopstateTransitionEvent?"}\n    CheckCached -->|"yes"| ReturnFalse2["Return false<br/>(already attempted)"]\n    CheckCached -->|"no"| CacheAndReturn["currentPopstateTransitionEvent = event<br/>Return true"]\n```\n\nThis optimization attempts to render popstate transitions synchronously to avoid flicker during browser history navigation.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:709-732]()\n\n## Resource Management\n\nReactFiberConfigDOM implements special handling for "hoistable" resources - elements like stylesheets and scripts that should be singleton instances in the document head.\n\n### Hoistable Elements\n\nResources are marked as hoistable through the `markNodeAsHoistable` function, which sets an internal flag on the DOM node:\n\n```mermaid\ngraph LR\n    CreateHoistable["createHoistableInstance()"]\n    CreateHoistable --> CreateElement["createElement(type)"]\n    CreateElement --> SetProps["setInitialProperties()"]\n    SetProps --> MarkHoistable["markNodeAsHoistable(element)"]\n    \n    CheckHoistable["isMarkedHoistable(element)"]\n    CheckHoistable --> ReadFlag["Check internal flag"]\n    \n    GetResources["getResourcesFromRoot(root)"]\n    GetResources --> ReturnSet["Return Set of hoistable instances"]\n```\n\nThe hoisting mechanism ensures that:\n- Multiple identical `<link>` or `<script>` elements are deduplicated\n- Resources are moved to the document `<head>`\n- Resources persist across re-renders if they remain in the tree\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js:56-59](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:452-468]()\n\n### Resource Validation\n\nFor stylesheet links, React validates props to ensure correct resource semantics:\n\n```mermaid\ngraph TB\n    ValidateLink["validateLinkPropsForStyleResource(props)"]\n    \n    ValidateLink --> CheckRel{"props.rel === \'stylesheet\'?"}\n    CheckRel -->|"no"| Error1["Warn: link must have rel=\'stylesheet\'"]\n    \n    CheckRel -->|"yes"| CheckHref{"props.href present?"}\n    CheckHref -->|"no"| Error2["Warn: stylesheet link must have href"]\n    \n    CheckHref -->|"yes"| CheckOnLoad{"props.onLoad or props.onError?"}\n    CheckOnLoad -->|"yes"| Error3["Warn: stylesheet links in head<br/>cannot have onLoad/onError"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js:138]()\n\n## Special Element Handling\n\nSeveral element types require special treatment beyond standard property application.\n\n### Script Elements\n\nScript tags must be created in a way that prevents execution:\n\n```mermaid\ngraph LR\n    CreateScript["Creating \'script\' element"]\n    CreateDiv["Create temporary div"]\n    SetInnerHTML["div.innerHTML = \'<script></script>\'"]\n    ExtractScript["Extract script element"]\n    RemoveFromDiv["div.removeChild(firstChild)"]\n    Return["Return non-executing script element"]\n    \n    CreateScript --> CreateDiv --> SetInnerHTML --> ExtractScript --> RemoveFromDiv --> Return\n```\n\nThis ensures scripts don\'t execute during render, only during commit if explicitly mounted.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:523-542]()\n\n### Select Elements\n\nSelect elements handle `multiple` and `size` props specially:\n\n```mermaid\ngraph TB\n    CreateSelect["Creating \'select\' element"]\n    \n    CheckMultiple{"props.multiple?"}\n    CreateSelect --> CheckMultiple\n    \n    CheckMultiple -->|"true"| SetMultiple["element.multiple = true"]\n    CheckMultiple -->|"false"| CheckSize{"props.size?"}\n    \n    CheckSize -->|"yes"| SetSize["element.size = props.size<br/>(enables multi-select mode)"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:544-562]()\n\n### Form Controls (Input, Textarea, Select)\n\nForm controls have specialized prop handling:\n- `finalizeInitialChildren` returns `true` for inputs, selects, textareas to schedule `commitMount`\n- `commitMount` handles `autoFocus` by calling `element.focus()`\n- Dedicated modules handle controlled vs uncontrolled state: `ReactDOMInput`, `ReactDOMTextarea`, `ReactDOMSelect`\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:625-643](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:813-872]()\n\n### Image Elements\n\nImages receive special handling in `commitMount` to ensure `onLoad` events fire correctly:\n\n```mermaid\ngraph TB\n    CommitMountImg["commitMount for \'img\'"]\n    \n    CheckSrc{"props.src present?"}\n    CommitMountImg --> CheckSrc\n    \n    CheckSrc -->|"yes"| CheckObjectSrc{"src is object<br/>(Blob/MediaStream)?"}\n    CheckObjectSrc -->|"yes"| SetSrcObject["setSrcObject(element, type, src)"]\n    CheckObjectSrc -->|"no"| ReassignSrc["element.src = src<br/>(triggers new load)"]\n    \n    CheckSrc -->|"no"| CheckSrcSet{"props.srcSet present?"}\n    CheckSrcSet -->|"yes"| ReassignSrcSet["element.srcset = srcSet"]\n```\n\nThe reassignment ensures that even if the image has already loaded, the `onLoad` handler will be called again.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:838-869]()\n\n## Hydration Support\n\nReactFiberConfigDOM provides hydration functions to match server-rendered HTML with React\'s virtual DOM during client-side hydration. This is a large topic covered in detail in [Hydration System](#6.3).\n\nKey hydration functions exported:\n- `hydrateProperties(domElement, tag, props)` - Matches and validates props\n- `hydrateText(textInstance, text)` - Validates text content\n- `diffHydratedProperties(domElement, tag, props)` - Produces update payload for mismatches\n- `diffHydratedText(textInstance, text)` - Checks for text mismatches\n\nHydration also handles special cases:\n- Dehydrated Suspense boundaries (marked with comment nodes)\n- Form state markers for preserving form data across SSR\n- Input/textarea/select state synchronization via `hydrateInput`, `hydrateTextarea`, `hydrateSelect`\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:81-89](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:874-915]()\n\n## View Transitions and Scheduling\n\nReactFiberConfigDOM includes stubs and partial implementations for view transitions, which enable animated transitions between states. Full details are in [View Transitions and Gesture Scheduling](#6.4).\n\n### View Transition Lifecycle\n\nThe host config provides functions called by the reconciler during view transitions:\n\n| Function | Purpose |\n|----------|---------|\n| `measureInstance(instance)` | Capture instance measurements before transition |\n| `cloneRootViewTransitionContainer(root)` | Clone the root for "old" state capture |\n| `startViewTransition(...)` | Begin coordinating the transition animation |\n| `applyViewTransitionName(instance, name, className)` | Apply CSS view-transition-name |\n| `stopViewTransition(transition)` | End the transition |\n\n### Gesture Scheduling\n\nGesture timeline integration (for scrubbing through transitions) is also stubbed:\n\n```mermaid\ngraph LR\n    StartGesture["startGestureTransition(container, timeline, ...)"]\n    StartGesture --> MutationCB["mutationCallback()"]\n    MutationCB --> AnimateCB["animateCallback()"]\n    AnimateCB --> Return["Return null<br/>(no actual animation)"]\n```\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1094-1358]()\n\n## Component Tree Mapping\n\nReactFiberConfigDOM maintains a mapping between DOM nodes and React fibers to support:\n- Event dispatching (finding the React instance for a DOM node)\n- React DevTools (inspecting the component tree)\n- Public instance access (refs)\n\n### Mapping Functions\n\n```mermaid\ngraph TB\n    subgraph "Fiber to DOM"\n        PrecacheFiber["precacheFiberNode(fiber, domNode)"]\n        PrecacheFiber --> StoreOnNode["domNode[internalInstanceKey] = fiber"]\n    end\n    \n    subgraph "DOM to Fiber"\n        GetInstance["getInstanceFromNode(domNode)"]\n        GetInstance --> ReadKey["return domNode[internalInstanceKey]"]\n    end\n    \n    subgraph "Props Storage"\n        UpdateFiberProps["updateFiberProps(domNode, props)"]\n        UpdateFiberProps --> StoreProps["domNode[internalPropsKey] = props"]\n        \n        GetFiberProps["getFiberCurrentPropsFromNode(domNode)"]\n        GetFiberProps --> ReadProps["return domNode[internalPropsKey]"]\n    end\n```\n\nThese mappings are established during instance creation and used throughout the lifecycle for event handling and introspection.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js:47-60]()\n\n## Summary\n\nReactFiberConfigDOM serves as the critical bridge between React\'s platform-agnostic reconciler and the browser DOM. It:\n\n- **Creates DOM instances** with proper namespacing (HTML, SVG, MathML)\n- **Manages properties** by translating React props to DOM attributes/properties\n- **Performs mutations** efficiently using native DOM APIs (with `moveBefore` optimization)\n- **Integrates events** by coordinating with React\'s synthetic event system\n- **Handles resources** through hoisting mechanisms for stylesheets and scripts\n- **Supports hydration** by matching server-rendered HTML with the React tree\n- **Enables view transitions** for animated state changes (experimental)\n\nThe implementation is mutation-based (unlike React Native\'s persistence mode) and optimized for the browser environment, with special handling for form controls, scripts, images, and other HTML-specific elements.\n\n**Sources:** [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-1500]()\n\n---\n\n# Page: React Native Renderers\n\n# React Native Renderers\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React Native\'s renderer implementations, which enable React to target native mobile platforms (iOS and Android). React Native provides two distinct renderers: **Fabric** (the new architecture using persistence mode) and **Legacy/Paper** (the old architecture using mutation mode). Both implement the host config interface defined by the reconciler to bridge React\'s virtual representation with platform-specific native UI components.\n\nFor information about the general host configuration abstraction, see [Host Configuration Abstraction](#4.6). For React DOM\'s implementation, see [React DOM Implementation](#6.1).\n\n---\n\n## Host Config Interface\n\nReact Native renderers implement the same host config interface as other renderers, providing platform-specific implementations of instance creation, updates, and tree manipulation. The reconciler calls these methods to perform platform operations without knowing the underlying implementation details.\n\n### Core Type Definitions\n\nBoth renderers define these fundamental types:\n\n| Type | Fabric | Legacy |\n|------|--------|--------|\n| `Type` | `string` (component type) | `string` (component type) |\n| `Instance` | Object with `node` and `canonical` | `ReactNativeFiberHostComponent` |\n| `TextInstance` | Object with `node` | `number` (native tag) |\n| `Container` | `{containerTag, publicInstance}` | `{containerTag, publicInstance}` |\n| `Props` | `Object` | `Object` |\n| `HostContext` | `{isInAParentText: boolean}` | `{isInAParentText: boolean}` |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:93-134](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:59-73]()\n\n---\n\n## Fabric Renderer (New Architecture)\n\n### Architecture Overview\n\n```mermaid\ngraph TB\n    Reconciler["React Reconciler"]\n    FabricConfig["ReactFiberConfigFabric"]\n    FabricUIManager["nativeFabricUIManager"]\n    ShadowTree["C++ Shadow Tree"]\n    NativeUI["Native UI Components"]\n    \n    Reconciler -->|"Host config calls"| FabricConfig\n    FabricConfig -->|"createNode()<br/>cloneNode()<br/>appendChild()"| FabricUIManager\n    FabricUIManager -->|"Synchronous updates"| ShadowTree\n    ShadowTree -->|"commitRoot()"| NativeUI\n    \n    subgraph "JavaScript Layer"\n        Reconciler\n        FabricConfig\n    end\n    \n    subgraph "Native Bridge"\n        FabricUIManager\n    end\n    \n    subgraph "Native Layer"\n        ShadowTree\n        NativeUI\n    end\n```\n\nFabric Renderer Architecture\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:31-60]()\n\n### Instance Structure\n\nFabric uses a **canonical instance pattern** where all clones of an instance share a common data structure:\n\n```mermaid\ngraph LR\n    Instance1["Instance (clone 1)"]\n    Instance2["Instance (clone 2)"]\n    Instance3["Instance (clone 3)"]\n    Canonical["Canonical Object"]\n    Node1["Shadow Node 1"]\n    Node2["Shadow Node 2"]\n    Node3["Shadow Node 3"]\n    \n    Instance1 -->|"node"| Node1\n    Instance2 -->|"node"| Node2\n    Instance3 -->|"node"| Node3\n    \n    Instance1 -->|"canonical"| Canonical\n    Instance2 -->|"canonical"| Canonical\n    Instance3 -->|"canonical"| Canonical\n    \n    Canonical -->|"nativeTag"| Tag["Unique Tag"]\n    Canonical -->|"viewConfig"| ViewConfig["View Configuration"]\n    Canonical -->|"currentProps"| Props["Current Props"]\n    Canonical -->|"internalInstanceHandle"| Fiber["Fiber Reference"]\n    Canonical -->|"publicInstance"| Public["Public Instance (lazy)"]\n```\n\nFabric Instance Canonical Pattern\n\nThe canonical object contains:\n- `nativeTag`: Unique identifier (even numbers starting from 2)\n- `viewConfig`: Native component configuration from registry\n- `currentProps`: Current props for event handling\n- `internalInstanceHandle`: Reference to the Fiber\n- `publicInstance`: Lazily created public instance for refs\n- `publicRootInstance`: Root instance (nulled after public instance creation)\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:95-113]()\n\n### Tag Allocation\n\nFabric tags follow a specific pattern:\n- Start at `2` and increment by `2` for each new instance\n- `tag % 10 === 1` means it\'s a root tag\n- `tag % 2 === 0` means it\'s a Fabric tag\n- This ensures Fabric tags never overlap with Legacy tags\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:86-89]()\n\n### Persistence Mode Operations\n\nFabric uses **persistence mode** (`supportsPersistence = true`), meaning it creates new shadow node instances rather than mutating existing ones:\n\n| Operation | Implementation |\n|-----------|----------------|\n| `createInstance` | `createNode(tag, viewName, rootTag, props, handle)` |\n| `cloneInstance` | `cloneNodeWithNewProps()` or `cloneNodeWithNewChildren()` |\n| `appendInitialChild` | `appendChildNode(parent.node, child.node)` |\n| `createContainerChildSet` | Returns `[]` (array mode) |\n| `appendChildToContainerChildSet` | `childSet.push(child.node)` |\n| `finalizeContainerChildren` | No-op (children replaced in next step) |\n| `replaceContainerChildren` | `completeRoot(containerTag, newChildren)` |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:449-561]()\n\n### Native UI Manager Integration\n\nFabric communicates with the native layer through `nativeFabricUIManager`:\n\n```mermaid\ngraph TB\n    createNode["createNode(tag, viewName, rootTag, props, handle)"]\n    cloneNode["cloneNodeWithNewProps(node, props)"]\n    appendChild["appendChildNode(parent, child)"]\n    completeRoot["completeRoot(containerTag, children)"]\n    registerEventHandler["registerEventHandler(dispatchEvent)"]\n    \n    createNode -->|"Returns"| ShadowNode["Shadow Node"]\n    cloneNode -->|"Returns"| ClonedNode["Cloned Shadow Node"]\n    appendChild -->|"Mutates"| ParentNode["Parent Shadow Tree"]\n    completeRoot -->|"Commits"| NativeUI["Native UI Tree"]\n    registerEventHandler -->|"Sets"| EventBridge["Event Bridge"]\n```\n\nFabric UI Manager API\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:45-60]()\n\n---\n\n## Legacy Renderer (Old Architecture/Paper)\n\n### Architecture Overview\n\n```mermaid\ngraph TB\n    Reconciler["React Reconciler"]\n    LegacyConfig["ReactFiberConfigNative"]\n    UIManager["UIManager"]\n    NativeBridge["Native Bridge (async)"]\n    NativeUI["Native UI Components"]\n    \n    Reconciler -->|"Host config calls"| LegacyConfig\n    LegacyConfig -->|"createView()<br/>updateView()<br/>manageChildren()"| UIManager\n    UIManager -->|"JSON over bridge"| NativeBridge\n    NativeBridge -->|"Async updates"| NativeUI\n    \n    subgraph "JavaScript Layer"\n        Reconciler\n        LegacyConfig\n        UIManager\n    end\n    \n    subgraph "Native Layer"\n        NativeBridge\n        NativeUI\n    end\n```\n\nLegacy Renderer Architecture\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:14-20]()\n\n### Instance Structure\n\nLegacy renderer uses `ReactNativeFiberHostComponent` as instances, which are simpler objects with:\n- `_nativeTag`: The native view tag\n- `_children`: Array of child instances\n- `viewConfig`: View configuration\n- Internal methods for event handling\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:29](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:157-169]()\n\n### Tag Allocation\n\nLegacy tags use a different allocation strategy:\n- Start at `3` and increment by `2`\n- Skip tags where `tag % 10 === 1` (reserved for root tags)\n- Skip tags where `tag % 2 === 0` (reserved for Fabric tags)\n\n```javascript\nfunction allocateTag() {\n  let tag = nextReactTag;\n  if (tag % 10 === 1) {\n    tag += 2;\n  }\n  nextReactTag = tag + 2;\n  return tag;\n}\n```\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:94-102]()\n\n### Mutation Mode Operations\n\nLegacy uses **mutation mode** (`supportsMutation = true`), directly mutating the native view hierarchy:\n\n| Operation | Implementation |\n|-----------|----------------|\n| `createInstance` | `UIManager.createView(tag, viewName, rootTag, props)` |\n| `commitUpdate` | `UIManager.updateView(tag, viewName, updatePayload)` |\n| `appendChild` | `UIManager.manageChildren(parent, moveFrom, moveTo, add, addAt, remove)` |\n| `insertBefore` | `UIManager.manageChildren()` with calculated indices |\n| `removeChild` | `UIManager.manageChildren()` with removeAtIndices |\n| `commitTextUpdate` | `UIManager.updateView(tag, \'RCTRawText\', {text})` |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:377-541]()\n\n### UIManager Integration\n\nThe Legacy renderer uses the `UIManager` module to communicate with native:\n\n```mermaid\ngraph LR\n    createView["UIManager.createView(tag, viewName, rootTag, props)"]\n    updateView["UIManager.updateView(tag, viewName, props)"]\n    manageChildren["UIManager.manageChildren(parent, moveFrom, moveTo, add, addAt, remove)"]\n    setChildren["UIManager.setChildren(parent, children)"]\n    \n    createView -->|"Async"| NativeQueue["Native Command Queue"]\n    updateView -->|"Async"| NativeQueue\n    manageChildren -->|"Async"| NativeQueue\n    setChildren -->|"Async"| NativeQueue\n    \n    NativeQueue -->|"Batched"| NativeUI["Native UI Thread"]\n```\n\nLegacy UIManager API\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigNative.js:150-155](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:392-410]()\n\n---\n\n## Key Differences Between Fabric and Legacy\n\n### Comparison Table\n\n| Aspect | Fabric | Legacy |\n|--------|--------|--------|\n| **Mode** | Persistence | Mutation |\n| **Instance Type** | `{node, canonical}` | `ReactNativeFiberHostComponent` |\n| **Text Instance** | `{node, publicInstance?}` | `number` (tag only) |\n| **Tag Pattern** | Even numbers (2, 4, 6...) | Odd numbers (3, 5, 7...) skipping multiples of 10 |\n| **Native API** | `nativeFabricUIManager` (synchronous) | `UIManager` (asynchronous) |\n| **Cloning** | `cloneNodeWithNewProps/Children()` | Not supported |\n| **Child Updates** | Replace entire child set | `manageChildren()` with indices |\n| **Event Registration** | `registerEventHandler(dispatchEvent)` | Implicit via `UIManager` |\n| **Public Instance** | Lazily created via `createPublicInstance` | Instance itself (or Fabric compat) |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:449](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:377]()\n\n### Architectural Comparison Diagram\n\n```mermaid\ngraph TB\n    subgraph "Fabric (New)"\n        FabricReact["React Tree"]\n        FabricClone["Clone Operations<br/>(persistence)"]\n        FabricShadow["Shadow Tree<br/>(synchronous)"]\n        FabricCommit["completeRoot()"]\n        FabricNative["Native UI"]\n        \n        FabricReact --> FabricClone\n        FabricClone --> FabricShadow\n        FabricShadow --> FabricCommit\n        FabricCommit --> FabricNative\n    end\n    \n    subgraph "Legacy (Old)"\n        LegacyReact["React Tree"]\n        LegacyMutate["Mutation Operations"]\n        LegacyQueue["Command Queue<br/>(asynchronous)"]\n        LegacyNative["Native UI"]\n        \n        LegacyReact --> LegacyMutate\n        LegacyMutate --> LegacyQueue\n        LegacyQueue --> LegacyNative\n    end\n```\n\nFabric vs Legacy Architecture\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-8](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:1-8]()\n\n---\n\n## Instance Management and Public Instances\n\n### Public Instance Creation\n\nBoth renderers expose instances to user code via refs, but they handle this differently:\n\n**Fabric:**\n- Public instances are created lazily via `createPublicInstance(tag, viewConfig, handle, rootInstance)`\n- Stored in the `canonical.publicInstance` field\n- All clones share the same public instance through the canonical object\n- `getPublicInstance()` creates on first access\n\n**Legacy:**\n- The instance itself serves as the public instance\n- Simpler model without lazy initialization\n- Compatibility layer exists for Fabric instances in mixed environments\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:293-325](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:289-315]()\n\n### Host Context Management\n\nBoth renderers track whether the current tree position is inside a text component:\n\n```mermaid\ngraph TD\n    Root["Root Context<br/>{isInAParentText: false}"]\n    View["<View><br/>isInAParentText: false"]\n    Text["<Text><br/>isInAParentText: true"]\n    TextInput["<TextInput><br/>isInAParentText: true"]\n    String["Text String<br/>(must be in text)"]\n    \n    Root --> View\n    View --> Text\n    Text --> String\n    View --> TextInput\n    \n    Text -.->|"Sets true"| String\n    TextInput -.->|"Sets true"| String\n```\n\nHost Context Propagation\n\nThe context prevents raw text strings from appearing outside text components. In DEV mode, this triggers a warning.\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:259-291](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:264-287]()\n\n---\n\n## Fragment Refs Support\n\nFabric includes support for fragment instance handles, enabling refs to fragments. The `FragmentInstance` class implements DOM-like APIs for native components:\n\n### FragmentInstance Implementation\n\n```mermaid\nclassDiagram\n    class FragmentInstance {\n        -Fiber _fragmentFiber\n        -Set~IntersectionObserver~ _observers\n        +observeUsing(observer)\n        +unobserveUsing(observer)\n        +compareDocumentPosition(otherNode)\n        +getRootNode(options)\n        +getClientRects()\n    }\n    \n    class IntersectionObserver {\n        +observe(target)\n        +unobserve(target)\n    }\n    \n    FragmentInstance --> IntersectionObserver : manages\n    FragmentInstance --> Fiber : references\n```\n\nFragmentInstance Class Structure\n\n### Key Methods\n\n| Method | Purpose | Implementation |\n|--------|---------|----------------|\n| `observeUsing()` | Attach IntersectionObserver | Traverses fragment, calls `observer.observe()` on each child |\n| `unobserveUsing()` | Detach IntersectionObserver | Traverses fragment, calls `observer.unobserve()` on each child |\n| `compareDocumentPosition()` | Compare positions | Uses first/last child positions with special empty fragment handling |\n| `getRootNode()` | Get root container | Delegates to parent host fiber\'s `getRootNode()` |\n| `getClientRects()` | Get bounding rects | Collects `getBoundingClientRect()` from all children |\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:646-799]()\n\n### Fragment Traversal\n\nFragment instances use `traverseFragmentInstance()` from the reconciler to walk the fragment\'s children:\n\n```mermaid\ngraph TB\n    FragmentFiber["Fragment Fiber"]\n    Child1["Host Component 1"]\n    Child2["Host Component 2"]\n    Child3["Nested Fragment"]\n    Child3a["Host Component 3a"]\n    Child3b["Host Component 3b"]\n    \n    FragmentFiber --> Child1\n    FragmentFiber --> Child2\n    FragmentFiber --> Child3\n    Child3 --> Child3a\n    Child3 --> Child3b\n    \n    Traverse["traverseFragmentInstance(fiber, callback, data)"]\n    Traverse -.->|"Visits"| Child1\n    Traverse -.->|"Visits"| Child2\n    Traverse -.->|"Recursively visits"| Child3a\n    Traverse -.->|"Recursively visits"| Child3b\n```\n\nFragment Traversal Pattern\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:27-29](), [packages/react-native-renderer/src/ReactFiberConfigFabric.js:672-678]()\n\n---\n\n## Props and Attribute Handling\n\n### Attribute Payload Creation\n\nBoth renderers use the React Native view configuration registry to validate and transform props:\n\n```mermaid\ngraph LR\n    Props["Component Props"]\n    ViewConfig["View Config<br/>(from registry)"]\n    ValidAttributes["validAttributes"]\n    \n    Props --> CreatePayload["createAttributePayload()"]\n    ViewConfig --> CreatePayload\n    ValidAttributes --> CreatePayload\n    \n    CreatePayload --> Payload["Native Attribute Payload"]\n    \n    Payload --> FabricCreate["Fabric: createNode()"]\n    Payload --> LegacyCreate["Legacy: UIManager.createView()"]\n```\n\nAttribute Payload Flow\n\n**Fabric:**\n```javascript\nconst updatePayload = createAttributePayload(\n  props,\n  viewConfig.validAttributes,\n);\nconst node = createNode(tag, viewConfig.uiViewClassName, rootTag, updatePayload, handle);\n```\n\n**Legacy:**\n```javascript\nconst updatePayload = create(props, viewConfig.validAttributes);\nUIManager.createView(tag, viewConfig.uiViewClassName, rootTag, updatePayload);\n```\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:196-207](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:148-155]()\n\n### Update Payload Diffing\n\nWhen props change, both renderers compute a diff to minimize native updates:\n\n**Fabric:**\n```javascript\nconst updatePayload = diffAttributePayloads(\n  oldProps,\n  newProps,\n  viewConfig.validAttributes,\n);\n// Updates canonical.currentProps for events\ninstance.canonical.currentProps = newProps;\n```\n\n**Legacy:**\n```javascript\nconst updatePayload = diff(oldProps, newProps, viewConfig.validAttributes);\nif (updatePayload != null) {\n  UIManager.updateView(tag, viewConfig.uiViewClassName, updatePayload);\n}\n```\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:460-468](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:452-467]()\n\n---\n\n## Event Priority Integration\n\nBoth renderers integrate with the React event priority system to map native events to React priorities:\n\n### Priority Resolution\n\n```mermaid\ngraph TD\n    GetPriority["resolveUpdatePriority()"]\n    CurrentPriority["currentUpdatePriority<br/>(from setState, etc)"]\n    FabricPriority["fabricGetCurrentEventPriority()<br/>(from native)"]\n    \n    GetPriority --> CheckCurrent{{"currentUpdatePriority<br/>!== NoEventPriority?"}}\n    CheckCurrent -->|Yes| CurrentPriority\n    CheckCurrent -->|No| FabricPriority\n    \n    FabricPriority --> MapPriority["Map to React Priority"]\n    MapPriority --> Discrete["DiscreteEventPriority<br/>(clicks, inputs)"]\n    MapPriority --> Continuous["ContinuousEventPriority<br/>(scrolls, drags)"]\n    MapPriority --> Idle["IdleEventPriority"]\n    MapPriority --> Default["DefaultEventPriority"]\n```\n\nEvent Priority Resolution (Fabric)\n\n**Fabric Priority Mapping:**\n| Fabric Priority | React Priority |\n|----------------|----------------|\n| `FabricDiscretePriority` | `DiscreteEventPriority` |\n| `FabricContinuousPriority` | `ContinuousEventPriority` |\n| `FabricIdlePriority` | `IdleEventPriority` |\n| `FabricDefaultPriority` | `DefaultEventPriority` |\n\n**Legacy:** Always returns `DefaultEventPriority` (no native priority integration).\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:395-419](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:352-357]()\n\n---\n\n## Summary\n\nReact Native provides two renderer implementations that bridge React\'s platform-agnostic reconciler to native mobile UI:\n\n1. **Fabric** (new architecture): Uses persistence mode with synchronous shadow tree operations, enabling better performance and simpler concurrency support\n2. **Legacy/Paper** (old architecture): Uses mutation mode with asynchronous command batching via the bridge\n\nBoth implement the same host config interface but with fundamentally different operational models. Fabric\'s persistence approach aligns better with React\'s concurrent rendering model, while Legacy maintains backward compatibility with existing React Native applications.\n\nThe key architectural components are:\n- **Tag allocation** strategies ensuring Fabric and Legacy tags don\'t conflict\n- **Instance management** patterns (canonical sharing vs direct instances)\n- **Native bridge integration** (synchronous vs asynchronous)\n- **Public instance creation** for refs\n- **Fragment refs support** (Fabric only)\n- **Attribute payload** creation and diffing\n- **Event priority** mapping (enhanced in Fabric)\n\n**Sources:** [packages/react-native-renderer/src/ReactFiberConfigFabric.js:1-838](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:1-751]()\n\n---\n\n# Page: Hydration System\n\n# Hydration System\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js](packages/react-dom-bindings/src/client/ReactDOMComponentTree.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js)\n- [packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js](packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js)\n- [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js](packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js](packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js](packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMFloat-test.js](packages/react-dom/src/__tests__/ReactDOMFloat-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js](packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js)\n- [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js](packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js)\n- [packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js](packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js)\n- [packages/react-dom/src/__tests__/ReactRenderDocument-test.js](packages/react-dom/src/__tests__/ReactRenderDocument-test.js)\n- [packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js](packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js](packages/react-dom/src/server/ReactDOMFizzServerBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerBun.js](packages/react-dom/src/server/ReactDOMFizzServerBun.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerEdge.js](packages/react-dom/src/server/ReactDOMFizzServerEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzServerNode.js](packages/react-dom/src/server/ReactDOMFizzServerNode.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js](packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticEdge.js](packages/react-dom/src/server/ReactDOMFizzStaticEdge.js)\n- [packages/react-dom/src/server/ReactDOMFizzStaticNode.js](packages/react-dom/src/server/ReactDOMFizzStaticNode.js)\n- [packages/react-markup/src/ReactFizzConfigMarkup.js](packages/react-markup/src/ReactFizzConfigMarkup.js)\n- [packages/react-noop-renderer/src/ReactNoopServer.js](packages/react-noop-renderer/src/ReactNoopServer.js)\n- [packages/react-reconciler/src/ReactFiberHydrationContext.js](packages/react-reconciler/src/ReactFiberHydrationContext.js)\n- [packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js](packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js)\n- [packages/react-server/src/ReactFizzServer.js](packages/react-server/src/ReactFizzServer.js)\n- [packages/react-server/src/forks/ReactFizzConfig.custom.js](packages/react-server/src/forks/ReactFizzConfig.custom.js)\n\n</details>\n\n\n\nThis document describes React\'s hydration system, which attaches React to server-rendered HTML, transforming static markup into an interactive application. Hydration reuses existing DOM nodes rather than creating new ones, validating that the server and client render the same content.\n\nFor server-side rendering fundamentals, see [React Fizz (Streaming SSR)](#5.1). For broader React DOM rendering concepts, see [React DOM](#4.1). For the underlying reconciliation mechanics, see [Fiber Architecture and Work Loop](#3.1).\n</thinking>\n\n## Hydration Overview\n\nHydration is the process of attaching React\'s event listeners and internal state to server-rendered HTML. Instead of creating new DOM nodes, React walks the existing DOM tree, attaching Fiber nodes to existing elements and validating that the client render matches the server render.\n\n```mermaid\ngraph TD\n    SSR["Server-Rendered HTML<br/>(ReactDOMFizzServer)"]\n    Container["DOM Container"]\n    HydrateRoot["ReactDOMClient.hydrateRoot()"]\n    HydrationContext["ReactFiberHydrationContext"]\n    FiberTree["Fiber Tree"]\n    AttachedDOM["Attached DOM with Event Listeners"]\n    \n    SSR --> Container\n    Container --> HydrateRoot\n    HydrateRoot --> HydrationContext\n    HydrationContext --> FiberTree\n    FiberTree --> AttachedDOM\n```\n\n**Hydration Flow**\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1-1500](), [packages/react-reconciler/src/ReactFiberHydrationContext.js:1-100]()\n\n## Hydration Context State\n\nReact maintains hydration state in `ReactFiberHydrationContext`, tracking the current position in the DOM tree and whether hydration is in progress.\n\n| State Variable | Type | Purpose |\n|---------------|------|---------|\n| `hydrationParentFiber` | `Fiber | null` | Current fiber being hydrated |\n| `nextHydratableInstance` | `HydratableInstance | null` | Next DOM node to hydrate |\n| `isHydrating` | `boolean` | Whether currently hydrating |\n| `didSuspendOrErrorDEV` | `boolean` | Suppress warnings after errors |\n| `hydrationDiffRootDEV` | `HydrationDiffNode | null` | Tracked diffs for error reporting |\n| `hydrationErrors` | `Array<CapturedValue> | null` | Collected hydration errors |\n\n```mermaid\ngraph TD\n    BeginWork["beginWork()"]\n    TryToClaimNextHydratableInstance["tryToClaimNextHydratableInstance()"]\n    NextHydratableInstance["nextHydratableInstance"]\n    CanHydrate["canHydrateInstance()"]\n    PopHydrationState["popHydrationState()"]\n    \n    BeginWork --> TryToClaimNextHydratableInstance\n    TryToClaimNextHydratableInstance --> NextHydratableInstance\n    NextHydratableInstance --> CanHydrate\n    CanHydrate -->|"match"| AttachFiber["Attach Fiber to DOM node"]\n    CanHydrate -->|"mismatch"| RecordMismatch["deleteHydratableInstance()"]\n    BeginWork --> PopHydrationState\n```\n\n**Hydration State Management**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:78-95](), [packages/react-reconciler/src/ReactFiberHydrationContext.js:135-200]()\n\n## Hydration Process\n\nDuring hydration, React walks the Fiber tree and the DOM tree in parallel, attempting to match each Fiber to an existing DOM node.\n\n### Host Component Hydration\n\nFor host components (DOM elements), React validates the tag name and props, attaching the existing DOM node to the Fiber.\n\n```mermaid\nsequenceDiagram\n    participant Reconciler\n    participant HydrationContext\n    participant HostConfig\n    participant DOM\n    \n    Reconciler->>HydrationContext: tryToClaimNextHydratableInstance()\n    HydrationContext->>DOM: Get nextHydratableInstance\n    HydrationContext->>HostConfig: canHydrateInstance(type, instance)\n    HostConfig-->>HydrationContext: true/false\n    alt Can Hydrate\n        HydrationContext->>HostConfig: hydrateInstance(instance, type, props)\n        HostConfig->>DOM: Validate props\n        HostConfig-->>HydrationContext: updatePayload | null\n        HydrationContext->>Reconciler: Attach instance to fiber\n    else Cannot Hydrate\n        HydrationContext->>HydrationContext: deleteHydratableInstance()\n        HydrationContext->>Reconciler: Create new instance\n    end\n```\n\n**Host Component Hydration Sequence**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:400-500](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1200-1350]()\n\n### Text Node Hydration\n\nText nodes are compared directly. If the text content differs, React logs a warning but uses the existing node.\n\n```mermaid\ngraph TD\n    TryHydrateText["tryToClaimNextHydratableInstance()<br/>(text)"]\n    CanHydrateText["canHydrateTextInstance()"]\n    HydrateText["hydrateTextInstance()"]\n    DiffText["diffHydratedTextForDevWarnings()"]\n    \n    TryHydrateText --> CanHydrateText\n    CanHydrateText -->|"is text node"| HydrateText\n    CanHydrateText -->|"wrong type"| DeleteAndCreate["Delete + Create new"]\n    HydrateText --> DiffText\n    DiffText -->|"DEV only"| LogWarning["Log mismatch warning"]\n```\n\n**Text Node Hydration**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:500-550](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1350-1400]()\n\n## Mismatch Detection and Recovery\n\nWhen React detects a mismatch between server-rendered HTML and client render, it attempts recovery by deleting the mismatched server node and creating the correct client node.\n\n### Mismatch Types\n\n| Mismatch Type | Detection Method | Recovery Strategy |\n|--------------|------------------|-------------------|\n| Tag name mismatch | `canHydrateInstance()` returns false | Delete server node, insert client node |\n| Text mismatch | `diffHydratedText()` compares strings | Use server text, log warning |\n| Missing children | No DOM node for Fiber child | Insert client-rendered child |\n| Extra DOM nodes | DOM nodes without Fiber | Delete extra nodes |\n| Prop mismatch | `diffHydratedProperties()` | Apply client props, log warning |\n\n```mermaid\ngraph TD\n    BeginHydration["Begin Hydration"]\n    TryClaim["tryToClaimNextHydratableInstance()"]\n    Validate["Validate node type and props"]\n    \n    Match["Match Found"]\n    Mismatch["Mismatch Detected"]\n    \n    DeleteServer["deleteHydratableInstance()"]\n    InsertClient["insertNonHydratedInstance()"]\n    LogError["queueHydrationError()"]\n    \n    BeginHydration --> TryClaim\n    TryClaim --> Validate\n    Validate --> Match\n    Validate --> Mismatch\n    \n    Mismatch --> DeleteServer\n    Mismatch --> InsertClient\n    Mismatch --> LogError\n    \n    Match --> ContinueHydration["Continue Hydration"]\n```\n\n**Mismatch Recovery Flow**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:300-400](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1400-1500]()\n\n### Hydration Diff Tracking (DEV)\n\nIn development, React builds a tree of hydration differences to provide detailed error messages with component stacks.\n\n```mermaid\ngraph TD\n    DetectMismatch["Detect Mismatch"]\n    BuildDiffNode["buildHydrationDiffNode()"]\n    RecordDiff["Record in hydrationDiffRootDEV"]\n    ThrowError["throwOnHydrationMismatch()"]\n    DescribeDiff["describeDiff()"]\n    ErrorWithStack["Error with Component Stack"]\n    \n    DetectMismatch --> BuildDiffNode\n    BuildDiffNode --> RecordDiff\n    RecordDiff --> ThrowError\n    ThrowError --> DescribeDiff\n    DescribeDiff --> ErrorWithStack\n```\n\n**Hydration Diff Reporting**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:96-135](), [packages/react-reconciler/src/ReactFiberHydrationDiffs.js:1-200]()\n\n## Dehydrated Suspense Boundaries\n\nWhen React Fizz server renders a Suspense boundary that suspended, it emits special HTML comment markers to indicate dehydrated content. These markers allow the client to skip hydrating the fallback and wait for the real content.\n\n### Suspense Boundary Markers\n\nReact uses specific comment node data to mark Suspense boundaries in SSR output:\n\n| Marker | Data Attribute | Purpose |\n|--------|---------------|---------|\n| Pending Start | `$?` | Suspense that hasn\'t resolved yet |\n| Fallback Start | `$!` | Suspense showing fallback |\n| Complete Start | `$` | Completed Suspense |\n| End | `/$` | End of Suspense boundary |\n\n```mermaid\ngraph TD\n    ServerRender["Server Render<br/>(ReactFizzServer)"]\n    SuspensePending["Component Suspends"]\n    EmitMarker["Emit <!--$?--> marker"]\n    StreamFallback["Stream fallback HTML"]\n    \n    ClientHydrate["Client Hydration"]\n    FindMarker["Find dehydrated boundary"]\n    SkipFallback["Skip hydrating fallback"]\n    WaitForContent["Wait for streamed content"]\n    HydrateContent["Hydrate real content"]\n    \n    ServerRender --> SuspensePending\n    SuspensePending --> EmitMarker\n    EmitMarker --> StreamFallback\n    \n    ClientHydrate --> FindMarker\n    FindMarker --> SkipFallback\n    SkipFallback --> WaitForContent\n    WaitForContent --> HydrateContent\n```\n\n**Dehydrated Suspense Boundary Flow**\n\nSources: [packages/react-server/src/ReactFizzServer.js:262-274](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:262-274]()\n\n### Suspense Instance Recognition\n\nThe client recognizes dehydrated Suspense boundaries by checking comment node data attributes.\n\n```mermaid\ngraph TD\n    GetNextSibling["getNextHydratableSibling()"]\n    CheckComment["Check if Comment node"]\n    CheckData["Check node.data"]\n    \n    SuspenseStart["SUSPENSE_*_DATA"]\n    ActivityStart["ACTIVITY_*_DATA"]\n    RegularComment["Regular comment"]\n    \n    GetNextSibling --> CheckComment\n    CheckComment --> CheckData\n    CheckData --> SuspenseStart\n    CheckData --> ActivityStart\n    CheckData --> RegularComment\n    \n    SuspenseStart --> CreateDehydratedFragment["createFiberFromDehydratedFragment()"]\n    ActivityStart --> HandleActivity["Handle Activity boundary"]\n    RegularComment --> SkipNode["Skip to next sibling"]\n```\n\n**Suspense Instance Recognition**\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1120-1180](), [packages/react-reconciler/src/ReactFiberHydrationContext.js:550-650]()\n\n### Hydrating Dehydrated Boundaries\n\nWhen React encounters a dehydrated Suspense boundary, it creates a `DehydratedFragment` fiber and skips the initial content, waiting for the server stream to complete.\n\n```mermaid\nsequenceDiagram\n    participant Reconciler\n    participant HydrationContext\n    participant FiberTree\n    participant SuspenseComponent\n    \n    Reconciler->>HydrationContext: tryToClaimNextHydratableInstance()\n    HydrationContext->>HydrationContext: Check for suspense marker\n    HydrationContext->>FiberTree: createFiberFromDehydratedFragment()\n    FiberTree->>SuspenseComponent: Mount with dehydrated state\n    SuspenseComponent->>SuspenseComponent: Register _reactRetry callback\n    \n    Note over SuspenseComponent: Wait for server completion\n    \n    SuspenseComponent->>SuspenseComponent: Receive completion signal\n    SuspenseComponent->>HydrationContext: Hydrate real content\n    HydrationContext->>FiberTree: Replace dehydrated fiber\n```\n\n**Dehydrated Fragment Hydration**\n\nSources: [packages/react-reconciler/src/ReactFiber.js:800-850](), [packages/react-reconciler/src/ReactFiberHydrationContext.js:700-800]()\n\n## Selective Hydration\n\nSelective hydration allows React to prioritize hydrating Suspense boundaries based on user interactions, improving perceived performance.\n\n### Priority-Based Hydration\n\nWhen a user interacts with a dehydrated boundary, React immediately schedules that boundary for hydration at a higher priority.\n\n| Interaction Type | Priority | Scheduling |\n|-----------------|----------|-----------|\n| Click, focus, submit | Discrete | Sync hydration |\n| Hover, scroll | Continuous | High priority |\n| No interaction | Default | Normal priority |\n\n```mermaid\ngraph TD\n    UserClick["User clicks dehydrated area"]\n    FindTarget["findInstanceBlockingEvent()"]\n    CheckHydrated["Check if target hydrated"]\n    \n    IsDehydrated["Target is dehydrated"]\n    ScheduleHydration["attemptDiscreteHydration()"]\n    QueueEvent["queueDiscreteEvent()"]\n    \n    CompleteHydration["Hydration completes"]\n    ReplayEvent["replayUnblockedEvents()"]\n    DispatchToHandler["Dispatch to event handler"]\n    \n    UserClick --> FindTarget\n    FindTarget --> CheckHydrated\n    CheckHydrated --> IsDehydrated\n    IsDehydrated --> ScheduleHydration\n    IsDehydrated --> QueueEvent\n    ScheduleHydration --> CompleteHydration\n    CompleteHydration --> ReplayEvent\n    ReplayEvent --> DispatchToHandler\n```\n\n**Selective Hydration with Event Replay**\n\nSources: [packages/react-dom-bindings/src/events/ReactDOMEventReplaying.js:1-300](), [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js:146-200]()\n\n### Event Queueing and Replay\n\nEvents targeting dehydrated content are queued until hydration completes, then replayed to ensure they\'re handled correctly.\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant EventSystem\n    participant HydrationContext\n    participant QueuedEvent\n    participant EventHandler\n    \n    User->>EventSystem: Click on dehydrated area\n    EventSystem->>HydrationContext: attemptDiscreteHydration()\n    EventSystem->>QueuedEvent: queueDiscreteEvent()\n    \n    Note over HydrationContext: Hydrate boundary at high priority\n    \n    HydrationContext->>HydrationContext: Complete hydration\n    HydrationContext->>QueuedEvent: replayUnblockedEvents()\n    QueuedEvent->>EventHandler: Dispatch original event\n    EventHandler->>User: Handle interaction\n```\n\n**Event Replay Flow**\n\nSources: [packages/react-dom-bindings/src/events/ReactDOMEventReplaying.js:150-250](), [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js:728-850]()\n\n### Multiple Boundary Prioritization\n\nWhen multiple Suspense boundaries are dehydrated, React hydrates the one the user interacted with first, deferring others.\n\n```mermaid\ngraph TD\n    MultipleBoundaries["Multiple Dehydrated Boundaries"]\n    \n    BoundaryA["Boundary A<br/>(dehydrated)"]\n    BoundaryB["Boundary B<br/>(dehydrated)"]\n    BoundaryC["Boundary C<br/>(dehydrated)"]\n    \n    UserInteraction["User clicks Boundary B"]\n    \n    PrioritizeB["Prioritize Boundary B"]\n    HydrateB["Hydrate B first"]\n    HydrateRest["Hydrate A & C later"]\n    \n    MultipleBoundaries --> BoundaryA\n    MultipleBoundaries --> BoundaryB\n    MultipleBoundaries --> BoundaryC\n    \n    UserInteraction --> PrioritizeB\n    PrioritizeB --> HydrateB\n    HydrateB --> HydrateRest\n```\n\n**Multi-Boundary Prioritization**\n\nSources: [packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js:300-400]()\n\n## Error Handling and Recovery\n\nReact\'s hydration system includes comprehensive error handling to recover from mismatches and provide useful diagnostics.\n\n### Recoverable Errors\n\nHydration mismatches are treated as recoverable errors. React logs the error via `onRecoverableError` callback but continues rendering.\n\n| Error Type | Recovery Strategy | User Impact |\n|-----------|------------------|-------------|\n| Tag mismatch | Client render subtree | Flicker during replacement |\n| Text mismatch | Use server text | Dev warning only |\n| Missing attribute | Apply client attribute | Attribute updates |\n| Extra DOM nodes | Delete extra nodes | Removed from DOM |\n\n```mermaid\ngraph TD\n    DetectError["Detect Hydration Mismatch"]\n    CaptureError["createCapturedValueAtFiber()"]\n    QueueError["queueHydrationError()"]\n    \n    ClientRenderBoundary["Find nearest Suspense boundary"]\n    UnmountServer["Unmount server subtree"]\n    MountClient["Mount client tree"]\n    \n    CallRecoverable["onRecoverableError()"]\n    LogWarning["Log warning in DEV"]\n    \n    DetectError --> CaptureError\n    CaptureError --> QueueError\n    QueueError --> ClientRenderBoundary\n    ClientRenderBoundary --> UnmountServer\n    UnmountServer --> MountClient\n    MountClient --> CallRecoverable\n    MountClient --> LogWarning\n```\n\n**Error Recovery Process**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:850-950](), [packages/react-reconciler/src/ReactCapturedValue.js:1-50]()\n\n### HydrationMismatchException\n\nIn DEV, React throws `HydrationMismatchException` with detailed component stacks and diff information.\n\n```mermaid\ngraph TD\n    BuildDiff["buildHydrationDiffNode()"]\n    CollectAncestors["Collect ancestor path"]\n    ThrowException["throwOnHydrationMismatch()"]\n    \n    ServerProps["Record server props"]\n    ClientProps["Record client props"]\n    DescribeDiff["describeDiff()"]\n    \n    FormatError["Format error message"]\n    ComponentStack["Generate component stack"]\n    ThrowError["Throw HydrationMismatchException"]\n    \n    BuildDiff --> CollectAncestors\n    BuildDiff --> ServerProps\n    BuildDiff --> ClientProps\n    ThrowException --> DescribeDiff\n    DescribeDiff --> FormatError\n    FormatError --> ComponentStack\n    ComponentStack --> ThrowError\n```\n\n**HydrationMismatchException Generation**\n\nSources: [packages/react-reconciler/src/ReactFiberHydrationContext.js:950-1050](), [packages/react-reconciler/src/ReactFiberHydrationDiffs.js:50-150]()\n\n## Integration Points\n\nThe DOM event system and selective hydration work together to provide seamless interactivity in server-rendered applications:\n\n1. **Event Detection**: The event system identifies user interactions that should trigger hydration\n2. **Priority Assignment**: Different event types receive different hydration priorities\n3. **Boundary Targeting**: Events target specific Suspense boundaries for hydration\n4. **Event Queueing**: Original events are queued during hydration\n5. **Replay Execution**: Events are replayed after hydration completes\n\nThis integration ensures that server-rendered applications feel responsive while optimizing initial load performance through strategic hydration.\n\nSources: [packages/react-dom/src/__tests__/ReactDOMServerSelectiveHydration-test.internal.js:1-2200](), [packages/react-dom/src/events/__tests__/DOMPluginEventSystem-test.internal.js:1-2000]()\n\n---\n\n# Page: View Transitions and Gesture Scheduling\n\n# View Transitions and Gesture Scheduling\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [fixtures/view-transition/README.md](fixtures/view-transition/README.md)\n- [fixtures/view-transition/public/favicon.ico](fixtures/view-transition/public/favicon.ico)\n- [fixtures/view-transition/public/index.html](fixtures/view-transition/public/index.html)\n- [fixtures/view-transition/src/components/Chrome.css](fixtures/view-transition/src/components/Chrome.css)\n- [fixtures/view-transition/src/components/Chrome.js](fixtures/view-transition/src/components/Chrome.js)\n- [fixtures/view-transition/src/components/Page.css](fixtures/view-transition/src/components/Page.css)\n- [fixtures/view-transition/src/components/Page.js](fixtures/view-transition/src/components/Page.js)\n- [fixtures/view-transition/src/components/SwipeRecognizer.js](fixtures/view-transition/src/components/SwipeRecognizer.js)\n- [packages/react-art/src/ReactFiberConfigART.js](packages/react-art/src/ReactFiberConfigART.js)\n- [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js)\n- [packages/react-native-renderer/src/ReactFiberConfigFabric.js](packages/react-native-renderer/src/ReactFiberConfigFabric.js)\n- [packages/react-native-renderer/src/ReactFiberConfigNative.js](packages/react-native-renderer/src/ReactFiberConfigNative.js)\n- [packages/react-noop-renderer/src/createReactNoop.js](packages/react-noop-renderer/src/createReactNoop.js)\n- [packages/react-reconciler/src/ReactFiberApplyGesture.js](packages/react-reconciler/src/ReactFiberApplyGesture.js)\n- [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js](packages/react-reconciler/src/ReactFiberCommitViewTransitions.js)\n- [packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js](packages/react-reconciler/src/ReactFiberConfigWithNoMutation.js)\n- [packages/react-reconciler/src/ReactFiberGestureScheduler.js](packages/react-reconciler/src/ReactFiberGestureScheduler.js)\n- [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js](packages/react-reconciler/src/ReactFiberViewTransitionComponent.js)\n- [packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js](packages/react-reconciler/src/__tests__/ReactFiberHostContext-test.internal.js)\n- [packages/react-reconciler/src/forks/ReactFiberConfig.custom.js](packages/react-reconciler/src/forks/ReactFiberConfig.custom.js)\n- [packages/react-test-renderer/src/ReactFiberConfigTestHost.js](packages/react-test-renderer/src/ReactFiberConfigTestHost.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes React\'s view transition and gesture scheduling systems, which coordinate smooth animations and gesture-driven updates with React\'s rendering lifecycle. View transitions integrate with the browser\'s View Transition API to animate between UI states, while gesture scheduling manages gesture-driven animations (such as scroll-linked or drag-based animations) by scheduling renders at specific points along a gesture timeline.\n\nFor information about the general reconciler architecture and commit phase, see [React Reconciler](#4). For lane-based scheduling and priorities, see [Lane-Based Scheduling and Priorities](#4.4).\n\n---\n\n## Overview\n\nReact\'s view transition and gesture scheduling systems provide host configuration APIs that allow renderers to:\n\n1. **Coordinate view transitions** - Apply view-transition-name CSS properties, measure DOM changes, and manage the lifecycle of browser view transitions\n2. **Schedule gesture-driven renders** - Queue gestures, track their progress along timelines, and render at specific animation offsets\n3. **Detect visual changes** - Measure instance dimensions and positions to determine what changed during updates\n4. **Manage transition lifecycle** - Start, stop, and cancel transitions in coordination with React\'s commit phases\n\nThese systems are primarily implemented for the DOM renderer, with stub implementations in React Native and test renderers.\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js]()\n\n---\n\n## Host Configuration Interface\n\n### Core Types and Data Structures\n\n**Type Hierarchy and Relationships**\n\n```mermaid\ngraph TB\n    subgraph "View Transition Types"\n        VTI["ViewTransitionInstance<br/>{name, group, imagePair, old, new}"]\n        VTS["ViewTransitionState<br/>{autoName, paired, clones, ref}"]\n        RVT["RunningViewTransition<br/>Platform-specific handle"]\n        IM["InstanceMeasurement<br/>Position & size data"]\n    end\n    \n    subgraph "Gesture Types"\n        GT["GestureTimeline<br/>Timeline provider"]\n        SG["ScheduledGesture<br/>{provider, count, rangeStart,<br/>rangeEnd, types, running, commit}"]\n    end\n    \n    subgraph "Host Config Methods"\n        SVTN["applyViewTransitionName()"]\n        RVTN["restoreViewTransitionName()"]\n        CMI["cloneMutableInstance()"]\n        MI["measureInstance()"]\n        MCI["measureClonedInstance()"]\n        SVT["startViewTransition()"]\n        SGT["startGestureTransition()"]\n        GGO["getCurrentGestureOffset()"]\n    end\n    \n    VTS --> VTI\n    VTI --> SVTN\n    RVT --> SVT\n    RVT --> SGT\n    IM --> MI\n    IM --> MCI\n    GT --> SGT\n    GT --> GGO\n    SG --> SGT\n    VTS --> CMI\n```\n\n**ViewTransitionState Structure**\n\nThe `ViewTransitionState` is attached to ViewTransition fiber nodes and tracks transition lifecycle:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `autoName` | `null \\| string` | Auto-generated view-transition-name (when name prop is \'auto\') |\n| `paired` | `null \\| ViewTransitionState` | Paired instance during enter/exit transitions |\n| `clones` | `null \\| Array<Instance>` | Cloned host instances during gesture apply phase |\n| `ref` | `null \\| ViewTransitionInstance` | Current ref instance exposed to user code |\n\n**ViewTransitionInstance Structure**\n\nThe `ViewTransitionInstance` represents a view transition element with animatable pseudo-elements:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `name` | `string` | The view-transition-name identifying this element |\n| `group` | `mixin$Animatable` | The ::view-transition-group pseudo-element |\n| `imagePair` | `mixin$Animatable` | The ::view-transition-image-pair pseudo-element |\n| `old` | `mixin$Animatable` | The ::view-transition-old pseudo-element |\n| `new` | `mixin$Animatable` | The ::view-transition-new pseudo-element |\n\n**ScheduledGesture Structure**\n\nGestures are queued and tracked in a linked list per `FiberRoot.pendingGestures`:\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `provider` | `GestureTimeline` | The timeline provider (e.g., ScrollTimeline) |\n| `count` | `number` | Reference count for active starts |\n| `rangeStart` | `number` | Start percentage (0-100) of current state |\n| `rangeEnd` | `number` | End percentage (0-100) of destination state |\n| `types` | `null \\| TransitionTypes` | Transition type annotations from addTransitionType |\n| `running` | `null \\| RunningViewTransition` | Active transition handle |\n| `commit` | `null \\| (() => void)` | Deferred commit callback |\n| `committing` | `boolean` | Whether gesture should commit on release |\n| `revertLane` | `Lane` | Lane used to schedule revert render |\n| `prev` | `null \\| ScheduledGesture` | Previous gesture in linked list |\n| `next` | `null \\| ScheduledGesture` | Next gesture in linked list |\n\nSources: [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js:19-24](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:253-259](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js:31-43]()\n\n---\n\n## View Transition Lifecycle\n\n### ViewTransition Component and State Management\n\n**ViewTransition Name Resolution**\n\nThe `getViewTransitionName` function in `ReactFiberViewTransitionComponent.js` resolves the transition name:\n\n1. If `props.name` is explicitly set (and not \'auto\'), use that name\n2. Otherwise, if `instance.autoName` exists, use the cached auto-generated name\n3. Otherwise, generate a unique name: `\'_\' + identifierPrefix + \'t_\' + globalClientId + \'_\'`\n\nThe `getViewTransitionClassName` function resolves CSS classes based on:\n- `props.default` - Default class for all transitions\n- `props.enter` / `props.exit` / `props.share` - Event-specific classes\n- Active transition types from `getPendingTransitionTypes()`\n\n**Class Name Selection by Type**\n\n```mermaid\ngraph LR\n    subgraph "Props"\n        D["props.default"]\n        E["props.enter / exit / share"]\n    end\n    \n    subgraph "Runtime"\n        TT["getPendingTransitionTypes()"]\n        ATT["Active types array"]\n    end\n    \n    subgraph "Resolution"\n        GCBT["getClassNameByType()"]\n        Result["Resolved className"]\n    end\n    \n    D --> GCBT\n    E --> GCBT\n    TT --> ATT\n    ATT --> GCBT\n    GCBT --> Result\n    \n    Result --> Apply["applyViewTransitionName(instance, name, className)"]\n```\n\nSources: [packages/react-reconciler/src/ReactFiberViewTransitionComponent.js:28-92]()\n\n### Applying and Managing View Transition Names\n\n**View Transition Name Application Sequence**\n\n```mermaid\nsequenceDiagram\n    participant R as Reconciler\n    participant CV as ReactFiberCommitViewTransitions\n    participant H as Host Config\n    participant D as DOM Element\n    participant V as View Transition API\n    \n    Note over R,CV: Before Mutation Phase\n    R->>CV: commitAppearingPairViewTransitions()\n    CV->>CV: Find paired enter/exit transitions\n    CV->>H: applyViewTransitionName(instance, name, className)\n    H->>D: element.style.viewTransitionName = name\n    H->>D: element.style.viewTransitionClass = className\n    \n    Note over R,V: Mutation Phase\n    R->>H: startViewTransition(container, types, callbacks...)\n    H->>V: document.startViewTransition(() => mutationCallback())\n    V-->>H: transition handle\n    H->>R: mutationCallback()\n    H->>R: layoutCallback()\n    H->>R: spawnedWorkCallback()\n    \n    Note over V,H: Animation Phase\n    V->>V: Capture old state pseudo-elements\n    V->>V: Apply DOM mutations\n    V->>V: Capture new state pseudo-elements\n    V->>V: Animate between states\n    \n    Note over R,H: After Animation\n    V->>H: Animation completes\n    H->>R: finishedAnimation() (profiling)\n    \n    Note over R,D: Cleanup Phase\n    R->>H: restoreViewTransitionName(instance, props)\n    H->>D: Restore original view-transition-name\n```\n\n**Key Host Config Methods:**\n\n- **`applyViewTransitionName(instance, name, className)`** - Sets `view-transition-name` and optional `view-transition-class` CSS properties\n- **`restoreViewTransitionName(instance, props)`** - Restores the view-transition-name from props after transition completes\n- **`cancelViewTransitionName(instance, name, props)`** - Removes view-transition-name from an element\n- **`cancelRootViewTransitionName(rootContainer)`** - Cancels view transition name on the root container\n- **`restoreRootViewTransitionName(rootContainer)`** - Restores root container\'s view transition name\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1212-1297](), [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js:232-285](), [packages/react-noop-renderer/src/createReactNoop.js:799-826]()\n\n### Starting and Stopping View Transitions\n\n**startViewTransition Host Config Method**\n\nThe `startViewTransition` method coordinates a view transition with React\'s commit phases:\n\n```javascript\nstartViewTransition(\n  rootContainer: Container,\n  transitionTypes: null | TransitionTypes,\n  mutationCallback: () => void,\n  layoutCallback: () => void,\n  afterMutationCallback: () => void,\n  spawnedWorkCallback: () => void,\n  passiveCallback: () => mixed,\n  errorCallback: mixed => void,\n  blockedCallback: string => void,  // Profiling-only\n  finishedAnimation: () => void      // Profiling-only\n): null | RunningViewTransition\n```\n\n**DOM Implementation**\n\nThe DOM renderer in `ReactFiberConfigDOM.js` wraps the native View Transition API:\n\n1. Calls `document.startViewTransition(() => { mutationCallback(); })` to start the transition\n2. Attaches `.finished` promise handler to call `finishedAnimation()` for profiling\n3. Returns the transition object which has `.skipTransition()` method\n4. If animation detection enabled, uses `suspendOnActiveViewTransition()` to wait for animation\n\n**Callback Execution Order:**\n\n1. **`mutationCallback()`** - Executed inside `document.startViewTransition()` to apply DOM changes\n2. **`layoutCallback()`** - Called immediately after mutation to execute layout effects\n3. **`afterMutationCallback()`** - Called after mutations complete (skipped in some paths)\n4. **`spawnedWorkCallback()`** - Called to signal that spawned work needs scheduling\n5. **`passiveCallback()`** - Called during passive effects phase (skipped in some paths)\n6. **`finishedAnimation()`** - Called when animation completes (profiling builds only)\n\n**Stopping Transitions**\n\nThe `stopViewTransition(transition)` method cancels an active transition:\n- In DOM: Calls `transition.skipTransition()` to abort the animation\n- In test renderers: No-op since no actual animation occurs\n\n**Transition Lifecycle Tracking**\n\n```mermaid\ngraph TB\n    subgraph "Start Transition"\n        SVT["startViewTransition()"]\n        DVT["document.startViewTransition()"]\n        MutCB["mutationCallback()"]\n        LayoutCB["layoutCallback()"]\n    end\n    \n    subgraph "Running State"\n        RVT["RunningViewTransition handle"]\n        FP["transition.finished Promise"]\n    end\n    \n    subgraph "Completion"\n        FA["finishedAnimation()"]\n        Cleanup["Restore view transition names"]\n    end\n    \n    SVT --> DVT\n    DVT --> MutCB\n    MutCB --> LayoutCB\n    DVT --> RVT\n    RVT --> FP\n    FP --> FA\n    FA --> Cleanup\n    \n    RVT --> |"stopViewTransition()"| Skip["transition.skipTransition()"]\n    Skip --> Cleanup\n```\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1299-1412](), [packages/react-noop-renderer/src/createReactNoop.js:854-896](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:668-690]()\n\n---\n\n## Apply Gesture Phase\n\n### Instance Cloning for Gestures\n\nDuring gesture transitions, React clones the tree to create a snapshot that can be animated while the live tree renders the destination state. The cloning process is managed by `ReactFiberApplyGesture.js`.\n\n**Cloning Architecture**\n\n```mermaid\ngraph TB\n    subgraph "Original Tree"\n        OF["Original Fiber Tree"]\n        OHI["Original Host Instances"]\n    end\n    \n    subgraph "Cloning Process"\n        CMI["cloneMutableInstance(instance, keepChildren)"]\n        CMTI["cloneMutableTextInstance(textInstance)"]\n        Clone["Clone Tree Construction"]\n    end\n    \n    subgraph "Cloned Tree"\n        CF["Cloned Fiber References"]\n        CHI["Cloned Host Instances"]\n        VTS["ViewTransitionState.clones"]\n    end\n    \n    OF --> CMI\n    OHI --> CMI\n    CMI --> Clone\n    CMTI --> Clone\n    Clone --> CHI\n    Clone --> VTS\n    CF --> CHI\n```\n\n**Visit Phases**\n\nThe apply gesture algorithm uses different visit phases to determine cloning behavior:\n\n| Phase | Value | Description |\n|-------|-------|-------------|\n| `CLONE_UPDATE` | 0 | Mutations or layout changes in this subtree |\n| `CLONE_EXIT` | 1 | Inside reappearing offscreen before next ViewTransition/HostComponent |\n| `CLONE_UNHIDE` | 2 | Inside reappearing offscreen before next HostComponent |\n| `CLONE_APPEARING_PAIR` | 3 | Finding paired appearing transitions |\n| `CLONE_UNCHANGED` | 4 | No changes but walking to clone tree |\n| `INSERT_EXIT` | 5 | Inside newly mounted tree before next ViewTransition/HostComponent |\n| `INSERT_APPEND` | 6 | Inside newly mounted tree before next HostComponent |\n| `INSERT_APPEARING_PAIR` | 7 | Inside newly mounted tree finding pairs |\n\n**Cloning and Mutation Tracking**\n\n```mermaid\nsequenceDiagram\n    participant WL as Work Loop\n    participant AG as ReactFiberApplyGesture\n    participant MT as ReactFiberMutationTracking\n    participant HC as Host Config\n    \n    Note over WL,AG: Apply Gesture Phase\n    WL->>AG: applyGestureToRoot(root, gesture)\n    AG->>MT: pushMutationContext(viewTransitionMutationContext)\n    AG->>AG: Walk fiber tree with visitPhase\n    \n    loop For each ViewTransition boundary\n        AG->>AG: Detect if mutations/layout changes\n        AG->>HC: cloneMutableInstance(instance, keepChildren)\n        HC-->>AG: Cloned instance\n        AG->>AG: Store in ViewTransitionState.clones\n        AG->>HC: applyViewTransitionName(clone, name, className)\n    end\n    \n    AG->>MT: popMutationContext()\n    AG->>MT: Apply tracked mutations to clones\n    AG->>HC: Insert cloned tree into DOM\n```\n\n**Instance Cloning Methods:**\n\n- **`cloneMutableInstance(instance, keepChildren)`** - Clones a host instance, optionally keeping children\n- **`cloneMutableTextInstance(textInstance)`** - Clones a text instance\n- **`cloneRootViewTransitionContainer(rootContainer)`** - Clones the root container for transitions\n\nSources: [packages/react-reconciler/src/ReactFiberApplyGesture.js:104-316](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:613-638]()\n\n### Measurement System\n\n**Instance Measurement and Change Detection**\n\nReact measures instance positions and sizes to determine what changed during a transition:\n\n```mermaid\ngraph TB\n    subgraph "Measurement Phase"\n        MI["measureInstance(instance)"]\n        MCI["measureClonedInstance(clone)"]\n        IM["InstanceMeasurement<br/>{position, size, viewport}"]\n    end\n    \n    subgraph "Change Detection"\n        WIV["wasInstanceInViewport(measurement)"]\n        HIC["hasInstanceChanged(oldMeasurement, newMeasurement)"]\n        HIAP["hasInstanceAffectedParent(oldMeasurement, newMeasurement)"]\n    end\n    \n    subgraph "Decision Logic"\n        Decision["Should animate?"]\n        Apply["Apply view transition name"]\n        Skip["Skip transition"]\n    end\n    \n    MI --> IM\n    MCI --> IM\n    IM --> WIV\n    IM --> HIC\n    IM --> HIAP\n    \n    WIV --> Decision\n    HIC --> Decision\n    HIAP --> Decision\n    \n    Decision --> |"Yes"| Apply\n    Decision --> |"No"| Skip\n```\n\n**Measurement API Methods:**\n\n| Method | Purpose | Implementation |\n|--------|---------|----------------|\n| `measureInstance(instance)` | Captures position and size before changes | DOM: Uses `getBoundingClientRect()` |\n| `measureClonedInstance(instance)` | Measures a cloned instance | DOM: Uses `getBoundingClientRect()` on clone |\n| `wasInstanceInViewport(measurement)` | Checks if instance was in viewport | DOM: Compares bounds to window dimensions |\n| `hasInstanceChanged(oldMeasurement, newMeasurement)` | Detects position/size changes | DOM: Compares measurement values |\n| `hasInstanceAffectedParent(oldMeasurement, newMeasurement)` | Checks if parent layout affected | DOM: Compares parent-relative positions |\n\n**Root Container Cloning:**\n\nFor view transitions involving the root, React clones the entire container:\n\n- **`cloneRootViewTransitionContainer(rootContainer)`** - Creates a snapshot clone of the root\n- **`removeRootViewTransitionClone(rootContainer, clone)`** - Removes the cloned snapshot after transition\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1508-1584](), [packages/react-noop-renderer/src/createReactNoop.js:828-852](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:639-666]()\n\n---\n\n## Gesture Scheduling System\n\n### Gesture Queue and Lifecycle\n\n**FiberRoot Gesture State Management**\n\n```mermaid\ngraph TB\n    subgraph "FiberRoot State"\n        PG["root.pendingGestures<br/>(ScheduledGesture linked list)"]\n        SG["root.stoppingGestures<br/>(Gestures to stop)"]\n        PL["root.pendingLanes"]\n        GL["GestureLane bit"]\n    end\n    \n    subgraph "Scheduling Operations"\n        SchG["scheduleGesture(root, provider)"]\n        StSG["startScheduledGesture(root, timeline, options, types)"]\n        CanG["cancelScheduledGesture(root, gesture)"]\n        DelG["deleteScheduledGesture(root, gesture)"]\n        StopG["stopCompletedGestures(root)"]\n    end\n    \n    subgraph "Work Loop Integration"\n        ERS["ensureRootIsScheduled(root)"]\n        RGL["renderOnGestureLane()"]\n        AGR["applyGestureToRoot()"]\n    end\n    \n    SchG --> PG\n    StSG --> PG\n    CanG --> SG\n    DelG --> PG\n    StopG --> SG\n    \n    PG --> GL\n    GL --> PL\n    PL --> ERS\n    ERS --> RGL\n    RGL --> AGR\n```\n\n### Scheduling Gestures\n\n**scheduleGesture Function Flow**\n\nThe `scheduleGesture(root, provider)` function in `ReactFiberGestureScheduler.js` adds a gesture to the pending queue:\n\n1. Searches `root.pendingGestures` linked list for matching `provider`\n2. If found, returns existing `ScheduledGesture`\n3. If not found, creates new `ScheduledGesture` with initial state:\n   - `count: 0` (not yet started)\n   - `rangeStart: 0, rangeEnd: 100` (uninitialized)\n   - `types: null` (no transition types yet)\n   - `running: null` (no active transition)\n4. Appends to linked list\n5. Calls `ensureRootIsScheduled(root)` to schedule render work\n\n**startScheduledGesture Activation**\n\nThe `startScheduledGesture(root, gestureTimeline, gestureOptions, transitionTypes)` function activates a gesture:\n\n1. Calculates `rangeStart` from `gestureOptions.rangeStart` or `getCurrentGestureOffset(gestureTimeline)`\n2. Calculates `rangeEnd` from `gestureOptions.rangeEnd` or heuristic based on current offset:\n   - If `rangeStart < 50`, default `rangeEnd = 100`\n   - If `rangeStart >= 50`, default `rangeEnd = 0`\n3. Finds matching gesture in `root.pendingGestures`\n4. Increments `gesture.count` (reference counting)\n5. Updates `gesture.rangeStart`, `gesture.rangeEnd`\n6. Merges `transitionTypes` into `gesture.types` array (deduplicates)\n7. Returns the `ScheduledGesture` for tracking\n\n**Gesture Lifecycle Sequence**\n\n```mermaid\nsequenceDiagram\n    participant Hook as startGestureTransition hook\n    participant GS as ReactFiberGestureScheduler\n    participant FR as FiberRoot\n    participant WL as Work Loop\n    participant AG as ReactFiberApplyGesture\n    \n    Note over Hook,GS: Schedule Phase\n    Hook->>GS: scheduleGesture(root, provider)\n    GS->>FR: Search pendingGestures\n    alt Gesture exists\n        FR-->>GS: Return existing ScheduledGesture\n    else New gesture\n        GS->>FR: Create & append ScheduledGesture\n        GS->>GS: ensureRootIsScheduled(root)\n    end\n    GS-->>Hook: Return ScheduledGesture\n    \n    Note over Hook,GS: Start Phase\n    Hook->>GS: startScheduledGesture(root, timeline, options, types)\n    GS->>GS: Calculate rangeStart/rangeEnd\n    GS->>FR: gesture.count++, update ranges & types\n    GS-->>Hook: Return ScheduledGesture\n    \n    Note over FR,AG: Render Phase\n    FR->>WL: Render on GestureLane\n    WL->>AG: applyGestureToRoot(root, gesture)\n    AG->>AG: Clone tree, apply mutations\n    AG->>FR: gesture.running = startGestureTransition(...)\n    \n    Note over Hook,GS: Cancel Phase\n    Hook->>GS: cancelScheduledGesture(root, gesture)\n    GS->>FR: gesture.count--\n    alt count === 0\n        GS->>GS: Delete gesture from list\n        alt Has runningTransition & pending lanes\n            GS->>FR: Move to root.stoppingGestures\n        else Has runningTransition & no pending work\n            GS->>GS: stopViewTransition(runningTransition)\n        end\n    end\n    \n    Note over FR,WL: Post-Commit\n    WL->>GS: stopCompletedGestures(root)\n    GS->>GS: Stop all deferred transitions\n```\n\nSources: [packages/react-reconciler/src/ReactFiberGestureScheduler.js:48-130]()\n\n### Canceling and Stopping Gestures\n\n**cancelScheduledGesture Implementation**\n\nThe `cancelScheduledGesture(root, gesture)` function handles gesture cleanup with reference counting:\n\n1. If `gesture.revertLane !== NoLane`, entangles it with any new transition lanes to ensure they commit together\n2. Decrements `gesture.count`\n3. If `count === 0`:\n   - Determines whether to commit or revert based on final offset:\n     - If `rangeStart < rangeEnd`: commit if `finalOffset > midpoint`\n     - If `rangeStart > rangeEnd`: commit if `finalOffset < midpoint`\n   - If committing and has `gesture.running`:\n     - Sets `gesture.committing = true`\n     - Schedules render on `GestureLane` to commit\n   - Otherwise, calls `deleteScheduledGesture(root, gesture)` to remove\n\n**deleteScheduledGesture Linked List Management**\n\nThe `deleteScheduledGesture(root, gesture)` function removes gesture from queue:\n\n1. Updates linked list pointers:\n   - `gesture.prev.next = gesture.next`\n   - `gesture.next.prev = gesture.prev`\n2. If removing head, updates `root.pendingGestures = gesture.next`\n3. If queue becomes empty (`root.pendingGestures === null`):\n   - Clears `GestureLane` from `root.pendingLanes` via `markRootFinished(root, GestureLane)`\n4. If `gesture.running` exists:\n   - If blocking/transition lanes pending: moves to `root.stoppingGestures`\n   - Otherwise: immediately calls `stopViewTransition(gesture.running)`\n\n**stopCompletedGestures Deferred Cleanup**\n\nThe `stopCompletedGestures(root)` function is called after commit:\n\n1. Checks if `root.stoppingGestures` is non-null\n2. Iterates through linked list of deferred gestures\n3. Calls `stopViewTransition(gesture.running)` for each\n4. Clears `root.stoppingGestures = null`\n\n**Commit Handling**\n\nIf `gesture.committing === true` during render:\n1. Applies mutations to commit the destination state\n2. After commit, triggers revert transition if new gesture scheduled\n3. Otherwise, completes normally without revert\n\nSources: [packages/react-reconciler/src/ReactFiberGestureScheduler.js:132-198]()\n\n---\n\n## Gesture Timeline Integration\n\n### Starting Gesture Transitions\n\nThe `startGestureTransition` method initiates a gesture-driven view transition:\n\n```javascript\nstartGestureTransition(\n  rootContainer: Container,\n  timeline: GestureTimeline,\n  rangeStart: number,\n  rangeEnd: number,\n  transitionTypes: null | TransitionTypes,\n  mutationCallback: () => void,\n  animateCallback: () => void,\n  errorCallback: mixed => void,\n  finishedAnimation: () => void\n): null | RunningViewTransition\n```\n\n**Execution Flow:**\n\n1. Calls `mutationCallback()` to apply DOM mutations\n2. Calls `animateCallback()` to set up animations along the timeline\n3. Optionally calls `finishedAnimation()` for profiling\n4. Returns handle to cancel the gesture transition\n\n**`getCurrentGestureOffset(provider)`** - Queries current position along the gesture timeline (0-100 percentage).\n\nSources: [packages/react-noop-renderer/src/createReactNoop.js:874-897](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:694-730]()\n\n---\n\n## Platform-Specific Implementations\n\n### DOM Renderer Implementation\n\nThe DOM renderer in `ReactFiberConfigDOM.js` provides full view transition support:\n\n**View Transition Name Management**\n\n```javascript\n// Apply view transition name and class\nfunction applyViewTransitionName(instance, name, className) {\n  const style = instance.style;\n  if (typeof style.viewTransitionName === \'string\') {\n    style.viewTransitionName = name;\n    if (className != null) {\n      style.viewTransitionClass = className;\n    }\n  }\n}\n\n// Restore from props\nfunction restoreViewTransitionName(instance, props) {\n  const style = instance.style;\n  if (typeof style.viewTransitionName === \'string\') {\n    const propName = props.style?.viewTransitionName ?? \n                     props.style?.[\'view-transition-name\'];\n    style.viewTransitionName = propName ?? \'\';\n    // Also restore viewTransitionClass...\n  }\n}\n```\n\n**Native View Transition API Integration**\n\nThe `startViewTransition` implementation wraps the browser API:\n\n```javascript\nfunction startViewTransition(\n  rootContainer,\n  transitionTypes,\n  mutationCallback,\n  layoutCallback,\n  afterMutationCallback,\n  spawnedWorkCallback,\n  passiveCallback,\n  errorCallback,\n  blockedCallback,\n  finishedAnimation\n) {\n  const transition = document.startViewTransition(() => {\n    mutationCallback();\n  });\n  \n  layoutCallback();\n  afterMutationCallback();\n  spawnedWorkCallback();\n  \n  transition.finished.then(() => {\n    finishedAnimation();\n  });\n  \n  return transition;\n}\n```\n\n**Measurement Implementation**\n\n- **`measureInstance(instance)`** - Uses `instance.getBoundingClientRect()` to capture position/size\n- **`wasInstanceInViewport(measurement)`** - Compares bounds to `window.innerWidth` and `window.innerHeight`\n- **`hasInstanceChanged(oldMeasurement, newMeasurement)`** - Compares rect properties\n- **`hasInstanceAffectedParent(oldMeasurement, newMeasurement)`** - Checks parent-relative position changes\n\n**Event-Driven Scheduling**\n\n- **`shouldAttemptEagerTransition()`** - Returns `true` during popstate events to render transitions synchronously\n- **`trackSchedulerEvent()`** - Captures `window.event` in `schedulerEvent` variable\n- **`resolveEventType()`** - Returns `window.event.type` if it differs from `schedulerEvent`\n- **`resolveEventTimeStamp()`** - Returns `window.event.timeStamp` for timing\n\n**Instance Cloning**\n\n```javascript\nfunction cloneMutableInstance(instance, keepChildren) {\n  return instance.cloneNode(keepChildren);\n}\n\nfunction cloneMutableTextInstance(textInstance) {\n  return textInstance.cloneNode(false);\n}\n```\n\nSources: [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:613-638](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1212-1297](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:1299-1412](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js:733-770]()\n\n### React Native Implementations\n\n**Fabric Renderer (New Architecture)**\n\nReact Native\'s Fabric renderer in `ReactFiberConfigFabric.js` provides stub implementations:\n\n```javascript\n// View transition names - not yet implemented\nexport function applyViewTransitionName(instance, name, className) {\n  // Not yet implemented\n}\n\n// Start view transition - executes callbacks but no animation\nexport function startViewTransition(...callbacks) {\n  mutationCallback();\n  layoutCallback();\n  // Skip afterMutationCallback - not needed\n  spawnedWorkCallback();\n  // Skip passiveCallback - spawned work will schedule\n  return null;\n}\n\n// Start gesture transition - executes callbacks but no animation\nexport function startGestureTransition(...callbacks) {\n  mutationCallback();\n  animateCallback();\n  if (enableProfilerTimer) {\n    finishedAnimation();\n  }\n  return null;\n}\n\n// Gesture offset - throws error\nexport function getCurrentGestureOffset(provider) {\n  throw new Error(\'startGestureTransition is not yet supported in React Native.\');\n}\n```\n\n**Legacy Renderer (Old Architecture)**\n\nThe legacy renderer in `ReactFiberConfigNative.js` has identical stub implementations. Both renderers execute the callbacks to ensure React\'s commit phases complete correctly, but no actual animations occur since React Native doesn\'t have a native view transition API.\n\n**Measurement Methods**\n\nAll measurement methods return null or dummy values:\n- `measureInstance(instance)` returns `null`\n- `measureClonedInstance(instance)` returns `null`\n- `wasInstanceInViewport(measurement)` returns `true`\n- `hasInstanceChanged(old, new)` returns `false`\n- `hasInstanceAffectedParent(old, new)` returns `false`\n\nSources: [packages/react-native-renderer/src/ReactFiberConfigFabric.js:593-730](), [packages/react-native-renderer/src/ReactFiberConfigNative.js:593-730]()\n\n### Test Renderer Implementation\n\n**react-test-renderer**\n\nThe test renderer in `ReactFiberConfigTestHost.js` provides no-op implementations that allow tests to execute:\n\n```javascript\nexport function startViewTransition(...callbacks) {\n  mutationCallback();\n  layoutCallback();\n  // Skip afterMutationCallback\n  spawnedWorkCallback();\n  // Skip passiveCallback\n  return null;\n}\n\nexport function startGestureTransition(...callbacks) {\n  mutationCallback();\n  animateCallback();\n  if (enableProfilerTimer) {\n    finishedAnimation();\n  }\n  return null;\n}\n\nexport function cloneMutableInstance(instance, keepChildren) {\n  return {\n    type: instance.type,\n    props: instance.props,\n    isHidden: instance.isHidden,\n    children: keepChildren ? instance.children : [],\n    internalInstanceHandle: null,\n    rootContainerInstance: instance.rootContainerInstance,\n    tag: \'INSTANCE\',\n  };\n}\n```\n\n**react-noop-renderer**\n\nThe noop renderer used in React\'s internal tests has more sophisticated implementations for testing purposes:\n- Tracks call counts via `hostCloneCounter`\n- Maintains instance relationships\n- Validates clone operations\n\nSources: [packages/react-test-renderer/src/ReactFiberConfigTestHost.js:176-458](), [packages/react-noop-renderer/src/createReactNoop.js:243-288](), [packages/react-noop-renderer/src/createReactNoop.js:799-897]()\n\n---\n\n## Integration with Reconciler\n\n### Gesture Lane Scheduling\n\nGestures use a dedicated lane (`GestureLane`) defined in `ReactFiberLane.js`:\n\n**Lane Assignment Flow**\n\n```mermaid\ngraph TB\n    subgraph "Component Layer"\n        Hook["startGestureTransition() hook"]\n        Action["User gesture action"]\n    end\n    \n    subgraph "Scheduling Layer"\n        SG["scheduleGesture(root, provider)"]\n        SSG["startScheduledGesture(root, timeline, options)"]\n        ERS["ensureRootIsScheduled(root)"]\n    end\n    \n    subgraph "Lane Management"\n        PL["root.pendingLanes"]\n        GL["GestureLane bit"]\n        MRE["markRootEntangled()"]\n    end\n    \n    subgraph "Work Loop"\n        RGL["performWorkOnRoot(GestureLane)"]\n        AGR["applyGestureToRoot()"]\n        Commit["Commit phase"]\n    end\n    \n    Action --> Hook\n    Hook --> SG\n    SG --> GL\n    GL --> PL\n    SG --> ERS\n    Hook --> SSG\n    SSG --> MRE\n    \n    ERS --> RGL\n    RGL --> AGR\n    AGR --> Commit\n    \n    Commit --> SCG["stopCompletedGestures()"]\n```\n\n**Lane Lifecycle:**\n\n1. `scheduleGesture()` adds gesture to `root.pendingGestures` and implicitly adds `GestureLane` to `root.pendingLanes`\n2. `ensureRootIsScheduled(root)` schedules work on `GestureLane`\n3. During render, `applyGestureToRoot()` processes the gesture\n4. `deleteScheduledGesture()` clears `GestureLane` via `markRootFinished(root, GestureLane)` when queue empties\n5. If gesture has blocking/transition work, lane stays set until commit completes\n\n**Entanglement:**\n\nWhen canceling a gesture with `revertLane !== NoLane`, the revert lane is entangled with new transition lanes via `markRootEntangled()` to ensure they commit together.\n\nSources: [packages/react-reconciler/src/ReactFiberLane.js:108](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js:17-22](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js:138-141]()\n\n### Commit Phase Integration\n\n**View Transition Commit Sequence**\n\n```mermaid\nsequenceDiagram\n    participant WL as Work Loop\n    participant CV as ReactFiberCommitViewTransitions\n    participant HC as Host Config\n    participant AG as ReactFiberApplyGesture\n    participant GS as ReactFiberGestureScheduler\n    \n    Note over WL,CV: Before Mutation Phase\n    WL->>CV: Track appearing view transitions\n    WL->>CV: commitAppearingPairViewTransitions()\n    CV->>HC: applyViewTransitionName() for pairs\n    \n    Note over WL,HC: Mutation Phase\n    WL->>HC: startViewTransition(callbacks...)\n    HC->>HC: document.startViewTransition(() => mutationCallback())\n    HC->>WL: Execute mutation effects\n    \n    Note over WL,HC: Layout Phase\n    HC->>WL: layoutCallback()\n    WL->>WL: Execute layout effects\n    \n    Note over WL,HC: After Mutation\n    HC->>WL: spawnedWorkCallback()\n    WL->>WL: Schedule spawned work\n    \n    Note over WL,HC: Passive Phase\n    HC->>WL: passiveCallback()\n    WL->>WL: Execute passive effects\n    \n    Note over WL,GS: Cleanup Phase\n    WL->>GS: stopCompletedGestures(root)\n    GS->>HC: stopViewTransition() for deferred gestures\n    GS->>GS: Clear root.stoppingGestures\n```\n\n**Phase Responsibilities:**\n\n| Phase | Responsibilities |\n|-------|------------------|\n| **Before Mutation** | Track appearing ViewTransitions, find pairs, measure instances |\n| **Mutation** | Start view transition, apply DOM mutations in mutationCallback |\n| **Layout** | Execute layout effects, measure after layout |\n| **After Mutation** | Coordinate spawned work, insert cloned trees for gestures |\n| **Passive** | Execute passive effects, schedule any remaining work |\n| **Post-Commit** | Stop deferred gesture transitions, clean up stoppingGestures |\n\n**Gesture Apply Phase:**\n\nFor gesture transitions, `applyGestureToRoot()` is called during the render phase (not commit):\n1. Clones the fiber tree to create a snapshot\n2. Applies mutations to clones\n3. Inserts cloned tree into DOM\n4. Starts `startGestureTransition()` with timeline\n5. Stores handle in `gesture.running`\n\nSources: [packages/react-reconciler/src/ReactFiberCommitViewTransitions.js:232-285](), [packages/react-reconciler/src/ReactFiberApplyGesture.js:317-800](), [packages/react-reconciler/src/ReactFiberGestureScheduler.js:185-198]()\n\n---\n\n## Summary\n\nReact\'s view transition and gesture scheduling systems provide:\n\n| Component | Purpose | Key Types | Key Methods |\n|-----------|---------|-----------|-------------|\n| **View Transitions** | Browser API integration | `ViewTransitionInstance`, `RunningViewTransition` | `startViewTransition`, `applyViewTransitionName`, measurement methods |\n| **Gesture Scheduling** | Timeline-driven animations | `ScheduledGesture`, `GestureTimeline` | `scheduleGesture`, `startScheduledGesture`, `cancelScheduledGesture` |\n| **Measurement** | Change detection | `InstanceMeasurement` | `measureInstance`, `hasInstanceChanged`, `wasInstanceInViewport` |\n| **Host Config** | Platform abstraction | Platform-specific handles | All methods implemented per-platform |\n\nThe DOM renderer provides full support for these features, while React Native and test renderers provide stub implementations that maintain API compatibility without actual animations.\n\nSources: [packages/react-reconciler/src/ReactFiberGestureScheduler.js](), [packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js](), [packages/react-noop-renderer/src/createReactNoop.js]()\n\n---\n\n# Page: Developer Tools and Debugging\n\n# Developer Tools and Debugging\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [fixtures/devtools/standalone/index.html](fixtures/devtools/standalone/index.html)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-devtools-core/README.md](packages/react-devtools-core/README.md)\n- [packages/react-devtools-core/src/backend.js](packages/react-devtools-core/src/backend.js)\n- [packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js](packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js)\n- [packages/react-devtools-extensions/src/contentScripts/installHook.js](packages/react-devtools-extensions/src/contentScripts/installHook.js)\n- [packages/react-devtools-extensions/src/contentScripts/messages.js](packages/react-devtools-extensions/src/contentScripts/messages.js)\n- [packages/react-devtools-inline/src/backend.js](packages/react-devtools-inline/src/backend.js)\n- [packages/react-devtools-shared/src/__tests__/componentStacks-test.js](packages/react-devtools-shared/src/__tests__/componentStacks-test.js)\n- [packages/react-devtools-shared/src/__tests__/console-test.js](packages/react-devtools-shared/src/__tests__/console-test.js)\n- [packages/react-devtools-shared/src/__tests__/inspectedElement-test.js](packages/react-devtools-shared/src/__tests__/inspectedElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js](packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/setupTests.js](packages/react-devtools-shared/src/__tests__/setupTests.js)\n- [packages/react-devtools-shared/src/__tests__/store-test.js](packages/react-devtools-shared/src/__tests__/store-test.js)\n- [packages/react-devtools-shared/src/attachRenderer.js](packages/react-devtools-shared/src/attachRenderer.js)\n- [packages/react-devtools-shared/src/backend/agent.js](packages/react-devtools-shared/src/backend/agent.js)\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js](packages/react-devtools-shared/src/backend/fiber/renderer.js)\n- [packages/react-devtools-shared/src/backend/legacy/renderer.js](packages/react-devtools-shared/src/backend/legacy/renderer.js)\n- [packages/react-devtools-shared/src/backend/types.js](packages/react-devtools-shared/src/backend/types.js)\n- [packages/react-devtools-shared/src/backend/views/Highlighter/index.js](packages/react-devtools-shared/src/backend/views/Highlighter/index.js)\n- [packages/react-devtools-shared/src/backendAPI.js](packages/react-devtools-shared/src/backendAPI.js)\n- [packages/react-devtools-shared/src/bridge.js](packages/react-devtools-shared/src/bridge.js)\n- [packages/react-devtools-shared/src/devtools/store.js](packages/react-devtools-shared/src/devtools/store.js)\n- [packages/react-devtools-shared/src/devtools/utils.js](packages/react-devtools-shared/src/devtools/utils.js)\n- [packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js](packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js)\n- [packages/react-devtools-shared/src/devtools/views/utils.js](packages/react-devtools-shared/src/devtools/views/utils.js)\n- [packages/react-devtools-shared/src/frontend/types.js](packages/react-devtools-shared/src/frontend/types.js)\n- [packages/react-devtools-shared/src/hook.js](packages/react-devtools-shared/src/hook.js)\n- [packages/react-devtools-shared/src/hydration.js](packages/react-devtools-shared/src/hydration.js)\n- [packages/react-devtools-shared/src/utils.js](packages/react-devtools-shared/src/utils.js)\n- [packages/react-devtools-shell/src/app/ElementTypes/index.js](packages/react-devtools-shell/src/app/ElementTypes/index.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js](packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js](packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js](packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/react/src/ReactForwardRef.js](packages/react/src/ReactForwardRef.js)\n- [packages/react/src/ReactMemo.js](packages/react/src/ReactMemo.js)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\nThe React repository provides comprehensive developer tooling that operates across the development lifecycle:\n\n| Tool | Phase | Purpose |\n|------|-------|---------|\n| **eslint-plugin-react-hooks** | Edit/Build Time | Statically validates Rules of Hooks and dependency arrays |\n| **React DevTools** | Runtime | Inspects component trees, profiles performance, debugs state |\n| **Console Patching** | Runtime | Appends component stacks to console messages |\n| **Performance Tracks** | Runtime | Emits User Timing marks for Performance panel |\n\nReact DevTools consists of a backend that attaches to React renderers via `__REACT_DEVTOOLS_GLOBAL_HOOK__`, a frontend that displays component trees and profiling data, and a versioned bridge protocol for communication. The ESLint plugin uses AST analysis to enforce Hook usage patterns. Console patching infrastructure enhances error messages with component stacks.\n\n**Sources:**\n- [packages/react-devtools-shared/src/hook.js:58-86]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1006-1102]()\n- [packages/eslint-plugin-react-hooks/src/RulesOfHooks.ts:1-50]()\n\n## React DevTools\n\nReact DevTools provides runtime inspection and profiling of React applications. The system consists of:\n\n- **Backend**: Attaches to React renderers via `__REACT_DEVTOOLS_GLOBAL_HOOK__.inject()`, wraps Fiber nodes in `DevToolsInstance` objects with stable IDs\n- **Frontend**: Displays component trees, state/props, and profiling data through the `Store` class\n- **Bridge**: Versioned protocol (version 2) for communication, serializes tree mutations as compact integer arrays\n\nDevTools Tooling Ecosystem\n\n```mermaid\ngraph TB\n    subgraph Packages["DevTools Packages"]\n        hook["react-devtools-shared/src/hook.js<br/>__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        backend["react-devtools-shared/src/backend/<br/>agent.js, renderer.js"]\n        frontend["react-devtools-shared/src/devtools/<br/>store.js, views/"]\n        bridge["react-devtools-shared/src/bridge.js<br/>FrontendBridge, BackendBridge"]\n    end\n    \n    subgraph Distributions["Distribution Models"]\n        standalone["react-devtools<br/>Electron + WebSocket"]\n        extension["react-devtools-extensions<br/>Chrome/Firefox/Edge"]\n        inline["react-devtools-inline<br/>Embeddable UI"]\n    end\n    \n    subgraph ReactApp["React Application"]\n        renderer["ReactDOM/ReactNative<br/>renderer.inject()"]\n        fibers["Fiber tree"]\n    end\n    \n    hook --> renderer\n    renderer --> backend\n    backend --> bridge\n    bridge --> frontend\n    \n    backend --> standalone\n    backend --> extension\n    backend --> inline\n    \n    renderer --> fibers\n    backend -.->|"wraps"| fibers\n    \n    style hook fill:#f9f9f9\n    style backend fill:#f9f9f9\n    style bridge fill:#f9f9f9\n```\n\nKey capabilities:\n- **Component Tree**: `Store` maintains `_idToElement`, `_ownersMap`, `_roots` to track component hierarchy\n- **State Inspection**: `inspectHooksOfFiber()` extracts hook values, `cleanForBridge()` serializes complex data\n- **Performance Profiling**: `injectProfilingHooks()` collects `fiberActualDurations`, effect timings\n- **Suspense Debugging**: `_idToSuspense` tracks suspension state, visualizes boundaries spatially\n\nDevTools supports three deployment models: standalone Electron app, browser extensions, and inline embeddable UI. See page 7.1 for detailed architecture and page 7.2 for distribution details.\n\n**Sources:**\n- [packages/react-devtools-shared/src/hook.js:58-86]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:183-292]()\n- [packages/react-devtools-shared/src/devtools/store.js:143-348]()\n- [packages/react-devtools-shared/src/bridge.js:47-73]()\n- [packages/react-devtools/package.json:1-32]()\n\n## Console Integration and Debugging Utilities\n\nBeyond the DevTools UI, React provides several runtime debugging utilities that enhance the browser console experience.\n\n### Console Patching\n\nConsole Patching Implementation (hook.js)\n\n```mermaid\ngraph TB\n    subgraph HookSetup["Global Hook Setup (hook.js:58-110)"]\n        installHook["installHook()"]\n        GlobalHook["window.__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        settings["settings: DevToolsHookSettings"]\n    end\n    \n    subgraph Patching["Console Method Patching (hook.js:110-267)"]\n        targetMethod["console.error/warn/log"]\n        savedMethod["Save original method"]\n        overrideMethod["Override with patched version"]\n        checkSettings["if settings.appendComponentStack"]\n        formatArgs["formatConsoleArguments()"]\n    end\n    \n    subgraph StackGen["Component Stack Generation"]\n        getCurrentFiber["renderer.getCurrentFiber()"]\n        getStack["getStackByFiberInDevAndProd()<br/>or getOwnerStackByFiberInDev()"]\n        appendStack["Append to console args"]\n        callOriginal["Call original console method"]\n    end\n    \n    installHook --> GlobalHook\n    GlobalHook --> settings\n    targetMethod --> savedMethod\n    savedMethod --> overrideMethod\n    overrideMethod --> checkSettings\n    checkSettings -->|"true"| formatArgs\n    formatArgs --> getCurrentFiber\n    getCurrentFiber --> getStack\n    getStack --> appendStack\n    appendStack --> callOriginal\n    checkSettings -->|"false"| callOriginal\n```\n\nThe hook patches console methods in [hook.js:110-267](). Key implementation details:\n\n- **Settings**: `DevToolsHookSettings` controls behavior\n  - `appendComponentStack` - Whether to append stacks (default: true in dev)\n  - `breakOnConsoleErrors` - Debugger breakpoint on errors\n- **Stack Extraction**: Calls `renderer.getCurrentFiber()` to get active Fiber, then `getStackByFiberInDevAndProd()` or `getOwnerStackByFiberInDev()` [renderer.js:133-138]()\n- **Formatting**: `formatConsoleArguments()` inserts ANSI/CSS styling for dimmed component stacks\n\n### Component Stacks\n\nReact 19.1+ supports **Owner Stacks** which show logical component ownership rather than the render tree hierarchy:\n\n- `captureOwnerStack()` - Public API to capture owner stack at any point [CHANGELOG.md:98]()\n- `supportsOwnerStacks()` - Backend check for owner stack support [DevToolsFiberComponentStack.js:136-137]()\n- `getOwnerStackByFiberInDev()` - Extracts owner chain from Fiber [DevToolsFiberComponentStack.js:135-138]()\n- `formatOwnerStack()` - Formats owner stack for display [DevToolsOwnerStack.js]()\n\nOwner stacks differ from traditional component stacks:\n- Show which component created an element (owner), not which component rendered it (parent)\n- Useful for HOCs and render props where ownership  parent-child relationship\n- Work across server-client boundaries in Server Components\n\n### Performance Tracks\n\nReact 19.2+ emits User Timing API marks that appear in the Performance panel [CHANGELOG.md:12]():\n\n- Profiling hooks injected via `injectProfilingHooks()` [renderer.js:1106-1119]()\n- Marks created for:\n  - Component render start/end\n  - Commit phase start/end  \n  - Passive effects start/end\n- `supportsPerformanceTracks` capability flag [store.js:86]()\n\n**Sources:**\n- [packages/react-devtools-shared/src/hook.js:110-267]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:133-138]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1106-1119]()\n- [packages/react-devtools-shared/src/devtools/store.js:86]()\n- [CHANGELOG.md:12]()\n- [CHANGELOG.md:86]()\n\n## ESLint Plugin for React Hooks\n\nThe `eslint-plugin-react-hooks` package enforces Hook usage patterns through static AST analysis. It provides two rules:\n\n| Rule | Severity | Purpose |\n|------|----------|---------|\n| `rules-of-hooks` | error | Ensures Hooks are only called at top level, not in loops/conditions |\n| `exhaustive-deps` | warn | Validates dependency arrays for `useEffect`, `useMemo`, `useCallback` |\n\nESLint Plugin Analysis Flow\n\n```mermaid\ngraph TB\n    subgraph RulesOfHooks["rules-of-hooks"]\n        visitCall["Visit CallExpression"]\n        matchHook["Match /^use[A-Z]/ pattern"]\n        getCodePath["ESLint CodePathSegment"]\n        checkContext["isInsideLoop()<br/>isInsideConditional()"]\n        reportViolation["Report: Hook in loop/condition"]\n    end\n    \n    subgraph ExhaustiveDeps["exhaustive-deps"]\n        visitEffect["Visit useEffect/useMemo/useCallback"]\n        extractDeps["Extract dependency array"]\n        analyzeScope["Analyze callback scope"]\n        collectRefs["collectReferencesInScope()"]\n        checkStable["Filter stable values:<br/>setState, dispatch, ref.current"]\n        diffDeps["Compare vs declared deps"]\n        suggestFix["Suggest missing/extra deps"]\n    end\n    \n    visitCall --> matchHook\n    matchHook --> getCodePath\n    getCodePath --> checkContext\n    checkContext -->|"invalid"| reportViolation\n    \n    visitEffect --> extractDeps\n    visitEffect --> analyzeScope\n    analyzeScope --> collectRefs\n    collectRefs --> checkStable\n    extractDeps --> diffDeps\n    checkStable --> diffDeps\n    diffDeps --> suggestFix\n    \n    style visitCall fill:#f9f9f9\n    style visitEffect fill:#f9f9f9\n```\n\nThe plugin uses ESLint\'s `CodePath` API to track control flow and detects violations through visitor pattern on `CallExpression` nodes. `rules-of-hooks` validates calling context, while `exhaustive-deps` analyzes closure scope to identify missing dependencies.\n\nConfiguration example:\n```javascript\nimport reactHooks from \'eslint-plugin-react-hooks\';\nexport default [reactHooks.configs.flat.recommended];\n```\n\nOptions include `additionalHooks` for custom hook patterns and `enableDangerousAutofixThreshold` for automatic fixes. See page 7.3 for detailed implementation.\n\n**Sources:**\n- [packages/eslint-plugin-react-hooks/src/RulesOfHooks.ts:1-50]()\n- [packages/eslint-plugin-react-hooks/src/ExhaustiveDeps.ts:1-100]()\n- [packages/eslint-plugin-react-hooks/README.md:1-150]()\n\n## Build and Distribution\n\n### Package Structure\n\nThe DevTools codebase is organized into several npm packages:\n\n| Package | Purpose | Main Exports |\n|---------|---------|--------------|\n| `react-devtools` | Standalone Electron app | Binary: `bin.js` |\n| `react-devtools-core` | Backend + WebSocket server | `backend.js`, `standalone.js` |\n| `react-devtools-inline` | Embeddable UI | `backend.js`, `frontend.js` |\n| `react-devtools-extensions` | Browser extensions | Not published to npm |\n| `react-devtools-shared` | Shared utilities | Internal only |\n| `eslint-plugin-react-hooks` | ESLint rules | Plugin export |\n\n**Sources:**\n- [packages/react-devtools/package.json:1-32]()\n- [packages/react-devtools-core/package.json:1-38]()\n- [packages/react-devtools-inline/package.json:1-52]()\n\n### Build Process\n\nDevTools Build System (Webpack)\n\n```mermaid\ngraph TB\n    subgraph Sources["Source Packages"]\n        shared["react-devtools-shared/src/"]\n        backend["backend/"]\n        frontend["devtools/"]\n        core["react-devtools-core/src/"]\n        inline["react-devtools-inline/src/"]\n    end\n    \n    subgraph WebpackConfigs["Webpack Configurations"]\n        backendWebpack["webpack.backend.js"]\n        standaloneWebpack["webpack.standalone.js"]\n        extensionWebpack["chrome/webpack.config.js<br/>firefox/webpack.config.js"]\n    end\n    \n    subgraph Artifacts["Build Artifacts"]\n        coreBackend["react-devtools-core/dist/backend.js"]\n        coreStandalone["react-devtools-core/dist/standalone.js"]\n        inlineBackend["react-devtools-inline/dist/backend.js"]\n        inlineFrontend["react-devtools-inline/dist/frontend.js"]\n        extensionBundle["extensions/chrome/build/react_devtools_backend.js"]\n    end\n    \n    shared --> backendWebpack\n    backend --> backendWebpack\n    shared --> standaloneWebpack\n    frontend --> standaloneWebpack\n    \n    backendWebpack --> coreBackend\n    standaloneWebpack --> coreStandalone\n    backendWebpack --> inlineBackend\n    standaloneWebpack --> inlineFrontend\n    extensionWebpack --> extensionBundle\n```\n\n**Build Environment Variables**:\n\n| Variable | Values | Effect |\n|----------|--------|--------|\n| `NODE_ENV` | `development`, `production` | Affects `__DEV__` checks, minification |\n| `FEATURE_FLAG_TARGET` | `core`, `backend-fb` | Enables Meta-internal features |\n| Source Maps | Generated for inline/extension builds | `devtool: \'source-map\'` in webpack config |\n\n**Bundle Targets**:\n- **backend.js**: Runs in application context, exports `initialize()` [backend/index.js]()\n- **frontend.js**: UI bundle with React DevTools components\n- **standalone.js**: Combined frontend with WebSocket client\n\nThe build system uses Webpack DefinePlugin to inline environment-specific constants, and BabelPlugin for JSX transformation.\n\n**Sources:**\n- [packages/react-devtools-core/package.json:17-25]()\n- [packages/react-devtools-inline/package.json:19-21]()\n\n### Version Compatibility\n\nDevTools maintains backward and forward compatibility through:\n\n1. **Bridge Protocol Versioning**: Current version is 2 [bridge.js:66-69]()\n2. **Unsupported Renderer Detection**: Shows warnings for too-old React versions\n3. **NPM Version Ranges**: Protocol includes `minNpmVersion` and `maxNpmVersion` [bridge.js:32-34]()\n\nWhen versions mismatch:\n- Newer backend  older frontend: Backend sends `minNpmVersion`, frontend shows upgrade prompt\n- Older backend  newer frontend: Frontend uses embedded version map to show downgrade instructions\n\n**Sources:**\n- [packages/react-devtools-shared/src/bridge.js:47-73]()\n- [packages/react-devtools-shared/src/devtools/store.js:169-220]()\n\n---\n\n# Page: React DevTools Architecture\n\n# React DevTools Architecture\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [fixtures/devtools/standalone/index.html](fixtures/devtools/standalone/index.html)\n- [packages/react-devtools-core/README.md](packages/react-devtools-core/README.md)\n- [packages/react-devtools-core/src/backend.js](packages/react-devtools-core/src/backend.js)\n- [packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js](packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js)\n- [packages/react-devtools-extensions/src/contentScripts/installHook.js](packages/react-devtools-extensions/src/contentScripts/installHook.js)\n- [packages/react-devtools-extensions/src/contentScripts/messages.js](packages/react-devtools-extensions/src/contentScripts/messages.js)\n- [packages/react-devtools-inline/src/backend.js](packages/react-devtools-inline/src/backend.js)\n- [packages/react-devtools-shared/src/__tests__/componentStacks-test.js](packages/react-devtools-shared/src/__tests__/componentStacks-test.js)\n- [packages/react-devtools-shared/src/__tests__/console-test.js](packages/react-devtools-shared/src/__tests__/console-test.js)\n- [packages/react-devtools-shared/src/__tests__/inspectedElement-test.js](packages/react-devtools-shared/src/__tests__/inspectedElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js](packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/setupTests.js](packages/react-devtools-shared/src/__tests__/setupTests.js)\n- [packages/react-devtools-shared/src/__tests__/store-test.js](packages/react-devtools-shared/src/__tests__/store-test.js)\n- [packages/react-devtools-shared/src/attachRenderer.js](packages/react-devtools-shared/src/attachRenderer.js)\n- [packages/react-devtools-shared/src/backend/agent.js](packages/react-devtools-shared/src/backend/agent.js)\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js](packages/react-devtools-shared/src/backend/fiber/renderer.js)\n- [packages/react-devtools-shared/src/backend/legacy/renderer.js](packages/react-devtools-shared/src/backend/legacy/renderer.js)\n- [packages/react-devtools-shared/src/backend/types.js](packages/react-devtools-shared/src/backend/types.js)\n- [packages/react-devtools-shared/src/backend/views/Highlighter/index.js](packages/react-devtools-shared/src/backend/views/Highlighter/index.js)\n- [packages/react-devtools-shared/src/backendAPI.js](packages/react-devtools-shared/src/backendAPI.js)\n- [packages/react-devtools-shared/src/bridge.js](packages/react-devtools-shared/src/bridge.js)\n- [packages/react-devtools-shared/src/devtools/store.js](packages/react-devtools-shared/src/devtools/store.js)\n- [packages/react-devtools-shared/src/devtools/utils.js](packages/react-devtools-shared/src/devtools/utils.js)\n- [packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js](packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js)\n- [packages/react-devtools-shared/src/devtools/views/utils.js](packages/react-devtools-shared/src/devtools/views/utils.js)\n- [packages/react-devtools-shared/src/frontend/types.js](packages/react-devtools-shared/src/frontend/types.js)\n- [packages/react-devtools-shared/src/hook.js](packages/react-devtools-shared/src/hook.js)\n- [packages/react-devtools-shared/src/hydration.js](packages/react-devtools-shared/src/hydration.js)\n- [packages/react-devtools-shared/src/utils.js](packages/react-devtools-shared/src/utils.js)\n- [packages/react-devtools-shell/src/app/ElementTypes/index.js](packages/react-devtools-shell/src/app/ElementTypes/index.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js](packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js](packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js](packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js)\n- [packages/react/src/ReactForwardRef.js](packages/react/src/ReactForwardRef.js)\n- [packages/react/src/ReactMemo.js](packages/react/src/ReactMemo.js)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes the architecture of React DevTools, the debugging and profiling tooling for React applications. It covers the three-tier architecture (Backend, Bridge, Frontend), the instrumentation mechanism, the bridge protocol for cross-context communication, and the various distribution channels (browser extensions, standalone app, inline embedding).\n\nFor information about the ESLint plugin for React hooks, see [7.2](#7.2). For details about React\'s internal reconciler and Fiber architecture that DevTools instruments, see [4.1](#4.1).\n\n---\n\n## High-Level Architecture\n\nReact DevTools uses a **three-tier architecture** that separates concerns between application instrumentation, communication, and user interface:\n\n```mermaid\ngraph TB\n    subgraph "Application Context"\n        App["React Application"]\n        Hook["__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        Renderer["React Renderer<br/>(react-dom, react-native)"]\n        Backend["DevTools Backend<br/>FiberRenderer/LegacyRenderer"]\n        Agent["Agent<br/>Command Dispatcher"]\n    end\n    \n    subgraph "Communication Layer"\n        Bridge["Bridge Protocol<br/>EventEmitter + Wall"]\n    end\n    \n    subgraph "DevTools UI Context"\n        Store["Store<br/>Tree State Manager<br/>_idToElement Map"]\n        ProfilerStore["ProfilerStore<br/>Profiling Data"]\n        ComponentsPanel["Components Panel"]\n        ProfilerPanel["Profiler Panel"]\n    end\n    \n    App --> Renderer\n    Renderer -->|"inject()"| Hook\n    Hook -->|"attach()"| Backend\n    Backend --> Agent\n    Agent <-->|"send/listen"| Bridge\n    Bridge <-->|"operations"| Store\n    Store --> ComponentsPanel\n    ProfilerStore --> ProfilerPanel\n    Store --> ProfilerStore\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1007-1014]()\n- [packages/react-devtools-shared/src/backend/agent.js:263-276]()\n- [packages/react-devtools-shared/src/devtools/store.js:143-169]()\n- [packages/react-devtools-shared/src/hook.js:58-68]()\n\nThe architecture separates concerns:\n- **Backend** runs in the same JavaScript context as the React application, instrumenting the reconciler\n- **Bridge** provides version-agnostic message passing between backend and frontend\n- **Frontend** runs in a separate context (extension panel, standalone window, or embedded iframe) and provides the UI\n\n---\n\n## Backend Architecture\n\n### Global Hook Injection\n\nThe DevTools backend uses a global hook installed on `window.__REACT_DEVTOOLS_GLOBAL_HOOK__` to intercept React renderer initialization. This hook is a de facto public API that React renderers detect and call during initialization.\n\n**DevToolsHook Object Structure:**\n\n```mermaid\ngraph TB\n    Hook["__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n    \n    subgraph "Core Properties"\n        renderers["renderers: Map<RendererID, ReactRenderer>"]\n        rendererInterfaces["rendererInterfaces: Map<RendererID, RendererInterface>"]\n        backends["backends: Map<string, DevToolsBackend>"]\n        listeners["listeners: {[event]: Array<Handler>}"]\n    end\n    \n    subgraph "React Callbacks"\n        inject["inject(renderer): number | null"]\n        onCommitFiberRoot["onCommitFiberRoot(rendererID, root, priority?)"]\n        onCommitFiberUnmount["onCommitFiberUnmount(rendererID, fiber)"]\n    end\n    \n    subgraph "DevTools Callbacks"\n        emit["emit(event, data)"]\n        on["on(event, handler)"]\n        sub["sub(event, handler)"]\n    end\n    \n    subgraph "Settings"\n        settings["settings: DevToolsHookSettings"]\n    end\n    \n    Hook --> renderers\n    Hook --> rendererInterfaces\n    Hook --> backends\n    Hook --> listeners\n    Hook --> inject\n    Hook --> onCommitFiberRoot\n    Hook --> onCommitFiberUnmount\n    Hook --> emit\n    Hook --> on\n    Hook --> sub\n    Hook --> settings\n```\n\n**Hook Installation Flow:**\n\n```mermaid\nsequenceDiagram\n    participant PageLoad as "Page Load"\n    participant installHook as "installHook()"\n    participant Hook as "__REACT_DEVTOOLS_GLOBAL_HOOK__"\n    participant Renderer as "React Renderer"\n    participant Backend as "Backend attach()"\n    \n    PageLoad->>installHook: Execute\n    installHook->>Hook: Create hook object\n    installHook->>Hook: Set listeners, backends, renderers Maps\n    installHook->>Hook: Define inject(), onCommitFiberRoot(), etc.\n    \n    Note over Renderer: React loads and initializes\n    \n    Renderer->>Hook: Check for __REACT_DEVTOOLS_GLOBAL_HOOK__\n    Renderer->>Hook: call inject(renderer)\n    Hook->>Hook: Assign rendererID = ++UID\n    Hook->>Hook: renderers.set(rendererID, renderer)\n    Hook->>Hook: emit("renderer", {id, renderer})\n    Hook->>Backend: Listener receives "renderer" event\n    Backend->>Backend: Call attach(hook, rendererID, renderer)\n    Backend->>Hook: rendererInterfaces.set(rendererID, interface)\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/hook.js:59-230]()\n- [packages/react-devtools-shared/src/backend/types.js:552-593]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1004-1028]()\n\nThe hook is installed early, before React loads, by:\n- **Browser extensions**: injected via content script executing `installHook.js`\n- **Standalone app**: served from local HTTP server on `http://localhost:8097`\n- **Inline embedding**: bundled in the page via `activate(window)`\n\n**Sources:**\n- [packages/react-devtools-extensions/src/contentScripts/installHook.js:1-85]()\n- [packages/react-devtools-core/src/backend.js:63-150]()\n- [packages/react-devtools-inline/src/backend.js:1-100]()\n\n### Backend Renderer Interface\n\nThe backend provides a `RendererInterface` that handles all interactions with a specific React renderer:\n\n| Method | Purpose |\n|--------|---------|\n| `flushInitialOperations()` | Send initial tree state to frontend |\n| `findHostInstancesForElementID()` | Map DevTools element ID to DOM/host instances |\n| `inspectElement()` | Retrieve detailed props/state/hooks for an element |\n| `overrideProps()` / `overrideHookState()` | Live-edit component data |\n| `getProfilingData()` | Collect profiling measurements |\n| `setTraceUpdatesEnabled()` | Enable/disable render highlighting |\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/types.js:412-455]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1007-1425]()\n\n### Fiber Tree Instrumentation\n\nThe backend instruments React\'s Fiber reconciler by creating a parallel data structure that mirrors the component tree. For each Fiber, the backend creates either a `FiberInstance`, `VirtualInstance`, or `FilteredFiberInstance`:\n\n```mermaid\ngraph TB\n    subgraph "React Reconciler"\n        FiberTree["Fiber Tree<br/>(React Internal)"]\n        FiberNode1["Fiber Node"]\n        FiberNode2["Fiber Node"]\n    end\n    \n    subgraph "DevTools Backend"\n        DevToolsTree["DevTools Instance Tree"]\n        FiberInstance["FiberInstance<br/>{kind: 0, id, data: Fiber}"]\n        VirtualInstance["VirtualInstance<br/>{kind: 1, id, data: ReactComponentInfo}"]\n        FilteredInstance["FilteredFiberInstance<br/>{kind: 2, data: Fiber}"]\n    end\n    \n    subgraph "Maps"\n        idToElement["idToDevToolsInstanceMap<br/>Map<id, DevToolsInstance>"]\n        rootToFiber["rootToFiberInstanceMap<br/>Map<FiberRoot, FiberInstance>"]\n        publicToElement["publicInstanceToDevToolsInstanceMap<br/>Map<HostInstance, DevToolsInstance>"]\n    end\n    \n    FiberNode1 -.->|"instruments"| FiberInstance\n    FiberNode2 -.->|"instruments"| VirtualInstance\n    FiberInstance --> DevToolsTree\n    VirtualInstance --> DevToolsTree\n    FilteredInstance -.->|"filtered but tracked"| DevToolsTree\n    \n    DevToolsTree --> idToElement\n    DevToolsTree --> rootToFiber\n    DevToolsTree --> publicToElement\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:185-293]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:864-888]()\n\nInstance types:\n- **FiberInstance** (`kind: 0`): Represents a stateful Fiber pair (current/work-in-progress) for client components\n- **VirtualInstance** (`kind: 1`): Represents server components or optimized-away components that don\'t create Fibers\n- **FilteredFiberInstance** (`kind: 2`): Hidden by component filters but tracked to find host instances\n\n### Tree Operations Protocol\n\nThe backend sends tree mutations to the frontend as compact numeric arrays called **operations**. Each operation is prefixed with an operation code:\n\n| Operation Code | Constant | Purpose |\n|----------------|----------|---------|\n| `1` | `TREE_OPERATION_ADD` | Add new element to tree |\n| `2` | `TREE_OPERATION_REMOVE` | Remove element(s) from tree |\n| `3` | `TREE_OPERATION_REORDER_CHILDREN` | Reorder children of an element |\n| `4` | `TREE_OPERATION_UPDATE_TREE_BASE_DURATION` | Update profiling duration |\n| `5` | `TREE_OPERATION_UPDATE_ERRORS_OR_WARNINGS` | Update error/warning counts |\n| `7` | `TREE_OPERATION_SET_SUBTREE_MODE` | Update StrictMode status |\n| `8` | `SUSPENSE_TREE_OPERATION_ADD` | Add Suspense boundary |\n| `12` | `SUSPENSE_TREE_OPERATION_SUSPENDERS` | Update Suspense state |\n\n**Sources:**\n- [packages/react-devtools-shared/src/constants.js:20-32]()\n- [packages/react-devtools-shared/src/utils.js:224-464]()\n\nOperations include a string table to avoid repetition:\n\n```\n[rendererID, rootID, stringTableSize, ...encodedStrings, ...operations]\n```\n\nThis compact format minimizes serialization overhead when sending tree updates across the bridge.\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1426-1600]()\n\n---\n\n## Bridge Protocol\n\n### Protocol Versioning\n\nThe bridge uses a versioned protocol to handle compatibility between different DevTools versions. The protocol version is negotiated on connection:\n\n```mermaid\nsequenceDiagram\n    participant Backend\n    participant Bridge\n    participant Frontend\n    \n    Backend->>Bridge: emit("bridgeProtocol", {version: 2})\n    Bridge->>Frontend: "bridgeProtocol" event\n    Frontend->>Frontend: Check compatibility\n    alt Versions compatible\n        Frontend->>Backend: Continue normal operation\n    else Backend newer\n        Frontend->>Frontend: Display upgrade prompt\n    else Frontend newer\n        Frontend->>Frontend: Display downgrade prompt\n    end\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/bridge.js:36-73]()\n- [packages/react-devtools-shared/src/devtools/store.js:273-320]()\n\nThe `BRIDGE_PROTOCOL` array defines version history with NPM version ranges:\n\n```javascript\n// Protocol version 2 added StrictMode support\n{\n  version: 2,\n  minNpmVersion: \'4.22.0\',\n  maxNpmVersion: null,\n}\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/bridge.js:47-70]()\n\n### Message Passing\n\nThe bridge is built on two abstractions:\n- **EventEmitter**: For typed event handling with `addListener()` / `emit()`\n- **Wall**: For low-level message transport with `send()` / `listen()`\n\n```mermaid\ngraph LR\n    subgraph "Backend Context"\n        BackendCode["Backend Code"]\n        BackendBridge["BackendBridge<br/>extends EventEmitter"]\n        BackendWall["Wall Implementation"]\n    end\n    \n    subgraph "Frontend Context"\n        FrontendWall["Wall Implementation"]\n        FrontendBridge["FrontendBridge<br/>extends EventEmitter"]\n        FrontendCode["Frontend Code"]\n    end\n    \n    BackendCode -->|"emit(\'operations\', data)"| BackendBridge\n    BackendBridge -->|"wall.send()"| BackendWall\n    BackendWall -.->|"postMessage/WebSocket/etc"| FrontendWall\n    FrontendWall -->|"wall.listen()"| FrontendBridge\n    FrontendBridge -->|"emit(\'operations\')"| FrontendCode\n    \n    FrontendCode -->|"emit(\'inspectElement\', params)"| FrontendBridge\n    FrontendBridge -->|"wall.send()"| FrontendWall\n    FrontendWall -.->|"postMessage/WebSocket/etc"| BackendWall\n    BackendWall -->|"wall.listen()"| BackendBridge\n    BackendBridge -->|"emit(\'inspectElement\')"| BackendCode\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/bridge.js:1-10]()\n- [packages/react-devtools-shared/src/backend/agent.js:307-356]()\n\n### Transport Implementations\n\nThe Wall abstraction enables different transport mechanisms for different environments:\n\n| Environment | Wall Implementation | Transport Mechanism |\n|-------------|---------------------|---------------------|\n| Browser Extension | `chrome.runtime.connect()` | Chrome extension messaging |\n| Standalone App | WebSocket | TCP socket over localhost |\n| Inline Embedding | `window.postMessage()` | Same-page iframe messaging |\n| React Native | WebSocket or Metro | RN debugging protocol |\n\n**Sources:**\n- [packages/react-devtools-extensions/chrome/manifest.json:1-65]()\n- [packages/react-devtools-core/package.json:1-38]()\n- [packages/react-devtools-inline/package.json:1-52]()\n\n---\n\n## Frontend Architecture\n\n### Store\n\nThe `Store` class is the single source of truth for the component tree state on the frontend. It processes operations from the backend and maintains several maps:\n\n```mermaid\ngraph TB\n    Store["Store"]\n    \n    subgraph "Core State"\n        idToElement["_idToElement<br/>Map<id, Element>"]\n        roots["_roots<br/>Array<rootID>"]\n        ownersMap["_ownersMap<br/>Map<id, Set<id>>"]\n        errorsAndWarnings["_errorsAndWarnings<br/>Map<id, {errorCount, warningCount}>"]\n    end\n    \n    subgraph "Suspense State"\n        idToSuspense["_idToSuspense<br/>Map<id, SuspenseNode>"]\n        rtree["_rtree<br/>RBush spatial index"]\n    end\n    \n    subgraph "Metadata"\n        rootIDToRendererID["_rootIDToRendererID<br/>Map<rootID, rendererID>"]\n        rootIDToCapabilities["_rootIDToCapabilities<br/>Map<rootID, Capabilities>"]\n    end\n    \n    Store --> idToElement\n    Store --> roots\n    Store --> ownersMap\n    Store --> errorsAndWarnings\n    Store --> idToSuspense\n    Store --> rtree\n    Store --> rootIDToRendererID\n    Store --> rootIDToCapabilities\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/store.js:143-272]()\n- [packages/react-devtools-shared/src/devtools/store.js:197-236]()\n\nThe Store processes operations in `onBridgeOperations()`:\n\n1. Parse string table from operations array\n2. Iterate through operations\n3. For each operation type (ADD, REMOVE, etc.), update internal maps\n4. Emit `mutated` event to trigger UI updates\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/store.js:1139-1784]()\n\n### Component State Serialization\n\nElement inspection uses a request-response pattern with **dehydration** and **hydration** to handle complex nested objects efficiently.\n\n**Serialization Pipeline:**\n\n```mermaid\ngraph TB\n    subgraph "Backend Serialization"\n        Fiber["Fiber Node"]\n        inspectElementRaw["inspectElementRaw(fiber)"]\n        getPropsForFiber["Get fiber.memoizedProps"]\n        getStateForFiber["Get fiber.memoizedState"]\n        getHooksForFiber["inspectHooksOfFiber()"]\n        dehydrate["dehydrate(data, path, cleaned)"]\n    end\n    \n    subgraph "Dehydrated Data Structure"\n        DehydratedData["{data: Array, cleaned: Array, unserializable: Array}"]\n        meta["Dehydrated objects: {inspectable, type, preview_short, preview_long}"]\n    end\n    \n    subgraph "Frontend Hydration"\n        InspectedElement["InspectedElement"]\n        hydrate["hydrate(data, cleaned, unserializable)"]\n        AddMetaSymbols["Add meta[Symbol] properties"]\n    end\n    \n    Fiber --> inspectElementRaw\n    inspectElementRaw --> getPropsForFiber\n    inspectElementRaw --> getStateForFiber\n    inspectElementRaw --> getHooksForFiber\n    getPropsForFiber --> dehydrate\n    getStateForFiber --> dehydrate\n    getHooksForFiber --> dehydrate\n    dehydrate --> DehydratedData\n    DehydratedData --> meta\n    \n    DehydratedData --> InspectedElement\n    InspectedElement --> hydrate\n    hydrate --> AddMetaSymbols\n```\n\n**Dehydration Process:**\n\nThe `dehydrate()` function recursively traverses objects and replaces complex values with `Dehydrated` metadata:\n\n| Value Type | Dehydration Strategy |\n|------------|---------------------|\n| Primitives (string, number, boolean) | Pass through unchanged |\n| Shallow objects (depth < 2) | Recursively dehydrate properties |\n| Deep objects (depth >= 2) | Replace with `{inspectable: true, type, preview_short, preview_long}` |\n| Arrays | Dehydrate each element |\n| React Elements | Replace with `{type: "react_element", preview}` |\n| Functions | Replace with `{type: "function", name}` |\n| Symbols | Replace with `{type: "symbol", name}` |\n| Unserializable (BigInt, ArrayBuffer) | Mark in `unserializable` array |\n\n**Sources:**\n- [packages/react-devtools-shared/src/hydration.js:200-350]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:2900-3100]()\n\n**Inspection Request-Response Flow:**\n\n```mermaid\nsequenceDiagram\n    participant UI as "UI Component"\n    participant Context as "InspectedElementContext"\n    participant Bridge\n    participant Agent\n    participant Backend as "fiber/renderer.js"\n    \n    UI->>Context: Read inspectedElement\n    Context->>Context: fetchElement(id, path)\n    Context->>Bridge: send("inspectElement", {id, path: null, requestID, rendererID})\n    Bridge->>Agent: emit("inspectElement", params)\n    Agent->>Backend: inspectElement(requestID, id, inspectedPaths, forceFullData)\n    \n    Backend->>Backend: Find DevToolsInstance by id\n    Backend->>Backend: inspectElementRaw(instance)\n    Backend->>Backend: Get props from fiber.memoizedProps\n    Backend->>Backend: Get state from fiber.memoizedState\n    Backend->>Backend: Call inspectHooksOfFiber(fiber, currentDispatcherRef)\n    Backend->>Backend: dehydrate(props, [], cleaned, unserializable)\n    Backend->>Backend: dehydrate(state, [], cleaned, unserializable)\n    Backend->>Backend: dehydrate(hooks, [], cleaned, unserializable)\n    \n    Backend->>Agent: Return InspectedElementPayload\n    Agent->>Bridge: send("inspectedElement", payload)\n    Bridge->>Context: emit("inspectedElement")\n    Context->>Context: hydrate(payload.value)\n    Context->>UI: Update inspected element\n    \n    Note over UI: User clicks to expand nested object\n    \n    UI->>Context: inspectPaths(["props", "user", "address"])\n    Context->>Bridge: send("inspectElement", {id, path: ["props","user","address"]})\n    Backend->>Backend: getInObject(fiber.memoizedProps, path)\n    Backend->>Backend: dehydrate(value at path)\n    Backend->>Agent: Return {type: "hydrated-path", path, value}\n    Agent->>Bridge: send("inspectedElement")\n    Context->>Context: fillInPath(data, path, value)\n```\n\n**Hooks Inspection:**\n\nThe backend uses `react-debug-tools` to inspect hooks:\n\n```javascript\n// In inspectElementRaw()\nimport {inspectHooksOfFiber} from \'react-debug-tools\';\n\nconst hooks = inspectHooksOfFiber(\n  fiber,\n  currentDispatcherRef, // ReactSharedInternals.H\n);\n```\n\nThis returns a `HooksTree` structure representing the hook call stack:\n\n```typescript\ntype HooksNode = {\n  id: number,\n  isStateEditable: boolean,\n  name: string,\n  value: mixed,\n  subHooks: Array<HooksNode>,\n  hookSource?: {\n    lineNumber: number,\n    columnNumber: number,\n    functionName: string,\n    fileName: string,\n  },\n};\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:2700-2900]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:98]()\n- [packages/react-debug-tools/src/ReactDebugHooks.js:1-500]()\n- [packages/react-devtools-shared/src/hydration.js:1-500]()\n- [packages/react-devtools-shared/src/backendAPI.js:50-200]()\n\n### UI Components\n\nThe frontend UI is organized into major panels:\n\n| Panel | Component | Purpose |\n|-------|-----------|---------|\n| Components | `Components.js` | Tree view + element inspector |\n| Profiler | `Profiler.js` | Commit timeline + flame graph |\n| Settings | `Settings/` | DevTools configuration |\n| Suspense | `SuspenseTab/` | Suspense boundary visualization (experimental) |\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/views/Components/]()\n- [packages/react-devtools-shared/src/devtools/views/Profiler/]()\n\nThe Components panel uses React Context for state management:\n\n```mermaid\ngraph TB\n    TreeContext["TreeContext<br/>(selected element, expansion state)"]\n    StoreContext["StoreContext<br/>(Store instance)"]\n    BridgeContext["BridgeContext<br/>(Bridge instance)"]\n    InspectedElementContext["InspectedElementContext<br/>(inspection cache)"]\n    \n    TreeContext --> Tree["Tree.js<br/>(virtualized tree)"]\n    StoreContext --> Tree\n    BridgeContext --> Tree\n    \n    TreeContext --> Inspector["InspectedElement.js<br/>(props/state/hooks)"]\n    InspectedElementContext --> Inspector\n    BridgeContext --> Inspector\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/views/Components/TreeContext.js]()\n- [packages/react-devtools-shared/src/devtools/views/Components/InspectedElementContext.js]()\n- [packages/react-devtools-shared/src/devtools/views/context.js]()\n\n### Profiling Hooks Integration\n\nThe DevTools backend injects profiling hooks into the React reconciler to collect performance data during renders.\n\n**Profiling Hooks Architecture:**\n\n```mermaid\ngraph TB\n    subgraph "DevTools Backend"\n        createProfilingHooks["createProfilingHooks()"]\n        ProfilingHooks["DevToolsProfilingHooks object"]\n    end\n    \n    subgraph "Profiling Hooks Methods"\n        markRenderScheduled["markRenderScheduled(lane)"]\n        markRenderStarted["markRenderStarted(lanes)"]\n        markComponentRenderStarted["markComponentRenderStarted(fiber)"]\n        markComponentRenderStopped["markComponentRenderStopped()"]\n        markCommitStarted["markCommitStarted(lanes)"]\n        markLayoutEffectsStarted["markLayoutEffectsStarted(lanes)"]\n        markPassiveEffectsStarted["markPassiveEffectsStarted(lanes)"]\n    end\n    \n    subgraph "React Reconciler"\n        Scheduler["Scheduler scheduleCallback()"]\n        WorkLoop["performConcurrentWorkOnRoot()"]\n        beginWork["beginWork(fiber)"]\n        completeWork["completeWork(fiber)"]\n        commitRoot["commitRoot()"]\n    end\n    \n    subgraph "Collected Data"\n        CommitData["CommitDataBackend: {duration, fiberActualDurations, fiberSelfDurations}"]\n        ProfilingData["ProfilingDataBackend: {dataForRoots, timelineData}"]\n    end\n    \n    createProfilingHooks --> ProfilingHooks\n    ProfilingHooks --> markRenderScheduled\n    ProfilingHooks --> markRenderStarted\n    ProfilingHooks --> markComponentRenderStarted\n    \n    Scheduler -->|calls| markRenderScheduled\n    WorkLoop -->|calls| markRenderStarted\n    beginWork -->|calls| markComponentRenderStarted\n    completeWork -->|calls| markComponentRenderStopped\n    commitRoot -->|calls| markCommitStarted\n    commitRoot -->|calls| markLayoutEffectsStarted\n    commitRoot -->|calls| markPassiveEffectsStarted\n    \n    markCommitStarted --> CommitData\n    CommitData --> ProfilingData\n```\n\n**Profiling Session Lifecycle:**\n\n```mermaid\nsequenceDiagram\n    participant Frontend\n    participant Bridge\n    participant Agent\n    participant Backend as "fiber/renderer.js"\n    participant Reconciler as "React Reconciler"\n    \n    Frontend->>Bridge: send("startProfiling", {recordChangeDescriptions, recordTimeline})\n    Bridge->>Agent: emit("startProfiling")\n    Agent->>Backend: startProfiling(recordChangeDescriptions, recordTimeline)\n    Backend->>Backend: Set isProfiling = true\n    Backend->>Backend: Clear profilingData, recordChangeDescriptions flag\n    Backend->>Reconciler: injectProfilingHooks(profilingHooks)\n    \n    Note over Reconciler: App renders and commits...\n    \n    Reconciler->>Backend: markRenderScheduled(lane)\n    Backend->>Backend: Track scheduled update\n    Reconciler->>Backend: markRenderStarted(lanes)\n    Backend->>Backend: currentCommitProfilingMetadata = {startTime}\n    Reconciler->>Backend: markComponentRenderStarted(fiber)\n    Backend->>Backend: Track fiber render start time\n    Reconciler->>Backend: markComponentRenderStopped()\n    Backend->>Backend: Calculate fiber actual duration\n    Reconciler->>Backend: markCommitStarted(lanes)\n    Backend->>Backend: Record commit start\n    Reconciler->>Backend: markCommitStopped()\n    Backend->>Backend: Build CommitDataBackend\n    Backend->>Backend: profilingData.dataForRoots[rootID].commitData.push(data)\n    \n    Note over Reconciler: Multiple commits may occur...\n    \n    Frontend->>Bridge: send("stopProfiling")\n    Bridge->>Agent: emit("stopProfiling")\n    Agent->>Backend: stopProfiling()\n    Backend->>Backend: Set isProfiling = false\n    Frontend->>Bridge: send("getProfilingData", {rendererID})\n    Bridge->>Agent: emit("getProfilingData")\n    Agent->>Backend: getProfilingData()\n    Backend->>Backend: Serialize profilingData\n    Backend->>Agent: Return ProfilingDataBackend\n    Agent->>Bridge: send("profilingData", data)\n    Bridge->>Frontend: emit("profilingData")\n```\n\n**Collected Profiling Metrics:**\n\n| Metric | Source | Purpose |\n|--------|--------|---------|\n| `fiberActualDurations` | `markComponentRenderStarted/Stopped()` | Time spent rendering each fiber |\n| `fiberSelfDurations` | Calculated from actual - children | Time excluding child renders |\n| `effectDuration` | `markLayoutEffectsStarted/Stopped()` | Time in useLayoutEffect/useEffect |\n| `passiveEffectDuration` | `markPassiveEffectsStarted/Stopped()` | Time in passive effects only |\n| `priorityLevel` | From scheduler priority | Render priority (UserBlocking, Normal, etc.) |\n| `changeDescriptions` | `recordProfilingDurations()` | Which props/state changed |\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/profilingHooks.js:1-500]()\n- [packages/react-devtools-shared/src/backend/types.js:500-538]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1105-1300]()\n- [packages/react-devtools-shared/src/devtools/ProfilerStore.js:1-200]()\n\n---\n\n## Distribution Channels\n\nReact DevTools is distributed through multiple channels, each with a different architecture:\n\n### Browser Extensions\n\nBrowser extensions use Manifest V3 with a service worker backend:\n\n```mermaid\ngraph TB\n    subgraph "Extension Components"\n        Background["background.js<br/>Service Worker"]\n        ContentScript["prepareInjection.js<br/>Content Script"]\n        DevToolsPage["main.html<br/>DevTools Page"]\n        Panel["panel.html<br/>DevTools Panel"]\n    end\n    \n    subgraph "Injection"\n        Hook["installHook.js<br/>Injected to page"]\n        Backend["backend.js<br/>Injected to page"]\n    end\n    \n    subgraph "Page Context"\n        App["React Application"]\n    end\n    \n    ContentScript -->|"injectScript()"| Hook\n    Hook --> App\n    Background -->|"chrome.scripting.executeScript"| Backend\n    Backend --> App\n    \n    DevToolsPage -->|"chrome.devtools.panels.create"| Panel\n    Panel <-->|"chrome.runtime.connect"| Background\n    Background <-->|"chrome.tabs.sendMessage"| Backend\n```\n\n**Sources:**\n- [packages/react-devtools-extensions/chrome/manifest.json:40-64]()\n- [packages/react-devtools-extensions/firefox/manifest.json:45-69]()\n\nExtension-specific features:\n- Icon changes color based on React build type (dev/prod)\n- Popup warns if React is not detected\n- Integration with browser Elements panel for DOM node selection\n\n**Sources:**\n- [packages/react-devtools-extensions/chrome/manifest.json:14-22]()\n\n### Standalone Application\n\nThe standalone app is an Electron application that starts a local WebSocket server:\n\n```mermaid\ngraph LR\n    subgraph "Electron App"\n        Main["Main Process<br/>bin.js"]\n        Renderer["Renderer Process<br/>app.html"]\n    end\n    \n    subgraph "Local Server"\n        HTTPServer["HTTP Server<br/>(serves hook script)"]\n        WSServer["WebSocket Server<br/>(bridge transport)"]\n    end\n    \n    subgraph "Browser/App"\n        Page["User\'s Application"]\n        BackendScript["<script> from localhost"]\n    end\n    \n    Main --> HTTPServer\n    Main --> WSServer\n    Main --> Renderer\n    \n    Page -->|"GET http://localhost:8097"| HTTPServer\n    HTTPServer -->|"installHook + backend"| BackendScript\n    BackendScript <-->|"WebSocket"| WSServer\n    WSServer <-->|"IPC"| Renderer\n```\n\n**Sources:**\n- [packages/react-devtools/package.json:11-23]()\n- [packages/react-devtools-core/package.json:1-38]()\n\nThe user adds a script tag to their page:\n\n```html\n<script src="http://localhost:8097"></script>\n```\n\nThis loads the hook and backend, which connect back via WebSocket.\n\n**Sources:**\n- [packages/react-devtools-core/]()\n\n### Inline Embedding\n\nThe inline package allows embedding DevTools directly in a web page:\n\n```javascript\nimport {initialize} from \'react-devtools-inline/frontend\';\nimport {activate} from \'react-devtools-inline/backend\';\n\n// In application context\nactivate(window);\n\n// In DevTools UI context\nconst DevTools = initialize(window);\n```\n\nThis is used for demos, playgrounds, and React Native debugging.\n\n**Sources:**\n- [packages/react-devtools-inline/package.json:12-17]()\n\n### React Native Integration\n\nReact Native embeds the DevTools backend and connects via Metro bundler\'s WebSocket connection or custom RN debugging bridge.\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/views/Highlighter/index.js:1-20]()\n\n---\n\n## Data Flow Examples\n\n### Component Tree Update\n\nWhen a component updates, the following flow occurs:\n\n```mermaid\nsequenceDiagram\n    participant React as "React Reconciler"\n    participant Backend as "Backend Renderer"\n    participant Agent\n    participant Bridge\n    participant Store\n    participant UI\n    \n    React->>Backend: commitMutationEffects()\n    Backend->>Backend: updateFiberRecursively()\n    Backend->>Backend: recordMount(fiber) or recordUnmount(fiber)\n    Backend->>Backend: Build operations array\n    Backend->>Agent: flushPendingEvents()\n    Agent->>Bridge: send("operations", operations)\n    Bridge->>Store: emit("operations", operations)\n    Store->>Store: onBridgeOperations()\n    Store->>Store: Update _idToElement, _roots, etc.\n    Store->>Store: emit("mutated", changes)\n    UI->>UI: Re-render tree view\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:1426-1600]()\n- [packages/react-devtools-shared/src/backend/agent.js:567-700]()\n- [packages/react-devtools-shared/src/devtools/store.js:1139-1784]()\n\n### Element Inspection Data Flow\n\nWhen a user inspects an element, the full flow spans from the UI click to backend serialization:\n\n```mermaid\nsequenceDiagram\n    participant User\n    participant Tree as "Tree.js"\n    participant TreeContext\n    participant InspectedElementContext\n    participant Bridge\n    participant Agent\n    participant RendererInterface as "fiber/renderer.js"\n    \n    User->>Tree: Click element in tree\n    Tree->>TreeContext: selectElementByID(id)\n    TreeContext->>TreeContext: Set selectedElementID state\n    InspectedElementContext->>InspectedElementContext: useEffect detects selectedElementID change\n    InspectedElementContext->>InspectedElementContext: fetchElement(id, null)\n    InspectedElementContext->>Bridge: send("inspectElement", {id, path: null, requestID, rendererID, forceFullData})\n    Bridge->>Agent: emit("inspectElement", params)\n    Agent->>Agent: Look up rendererInterface by rendererID\n    Agent->>RendererInterface: inspectElement(requestID, id, inspectedPaths, forceFullData)\n    \n    RendererInterface->>RendererInterface: idToDevToolsInstanceMap.get(id)\n    RendererInterface->>RendererInterface: inspectElementRaw(instance, path, forceFullData)\n    RendererInterface->>RendererInterface: Extract fiber.memoizedProps\n    RendererInterface->>RendererInterface: Extract fiber.memoizedState\n    RendererInterface->>RendererInterface: inspectHooksOfFiber(fiber, currentDispatcherRef)\n    RendererInterface->>RendererInterface: dehydrate(props, state, hooks)\n    RendererInterface->>RendererInterface: Build InspectedElement payload\n    RendererInterface->>Agent: Return {type: "full-data", value: InspectedElement}\n    \n    Agent->>Bridge: send("inspectedElement", payload)\n    Bridge->>InspectedElementContext: emit("inspectedElement", payload)\n    InspectedElementContext->>InspectedElementContext: hydrate(payload.value)\n    InspectedElementContext->>Tree: Render updated inspector panel\n    Tree->>User: Display props, state, hooks\n```\n\n**Sources:**\n- [packages/react-devtools-shared/src/devtools/views/Components/Tree.js:1-500]()\n- [packages/react-devtools-shared/src/devtools/views/Components/TreeContext.js:1-300]()\n- [packages/react-devtools-shared/src/devtools/views/Components/InspectedElementContext.js:1-400]()\n- [packages/react-devtools-shared/src/backend/agent.js:320-330]()\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:2700-3200]()\n- [packages/react-devtools-shared/src/backendAPI.js:50-200]()\n\n---\n\n## Key Design Decisions\n\n### Why Three-Tier Architecture?\n\nThe separation of backend, bridge, and frontend enables:\n- **Security isolation**: DevTools UI runs in a different context with different privileges\n- **Version independence**: Protocol versioning allows newer backends with older frontends\n- **Multiple transport layers**: Same code works across extensions, standalone, inline, and React Native\n\n### Why Operations Arrays?\n\nCompact numeric arrays minimize serialization overhead:\n- Strings are deduplicated via string table\n- Tree changes encoded as integers\n- No JSON parsing overhead\n- Works well with `postMessage()` structured clone algorithm\n\n**Sources:**\n- [packages/react-devtools-shared/src/utils.js:224-464]()\n\n### Why Dehydration?\n\nLazy loading of nested data:\n- Initial inspection sends shallow representation\n- Deeply nested objects represented as `{inspectable: true}`\n- User expansion triggers path-specific fetch\n- Reduces initial payload size for large component trees\n\n**Sources:**\n- [packages/react-devtools-shared/src/hydration.js:65-250]()\n\n### Why WeakMap for Fiber Tracking?\n\nUsing WeakMaps for `internalInstanceToIDMap` prevents memory leaks:\n- Fibers can be garbage collected without explicit cleanup\n- DevTools doesn\'t hold strong references to unmounted components\n\n**Sources:**\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js:864-873]()\n\n---\n\n# Page: DevTools Distribution and Integration\n\n# DevTools Distribution and Integration\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [fixtures/devtools/standalone/index.html](fixtures/devtools/standalone/index.html)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-devtools-core/README.md](packages/react-devtools-core/README.md)\n- [packages/react-devtools-core/src/backend.js](packages/react-devtools-core/src/backend.js)\n- [packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js](packages/react-devtools-extensions/src/contentScripts/hookSettingsInjector.js)\n- [packages/react-devtools-extensions/src/contentScripts/installHook.js](packages/react-devtools-extensions/src/contentScripts/installHook.js)\n- [packages/react-devtools-extensions/src/contentScripts/messages.js](packages/react-devtools-extensions/src/contentScripts/messages.js)\n- [packages/react-devtools-inline/src/backend.js](packages/react-devtools-inline/src/backend.js)\n- [packages/react-devtools-shared/src/__tests__/componentStacks-test.js](packages/react-devtools-shared/src/__tests__/componentStacks-test.js)\n- [packages/react-devtools-shared/src/__tests__/console-test.js](packages/react-devtools-shared/src/__tests__/console-test.js)\n- [packages/react-devtools-shared/src/__tests__/inspectedElement-test.js](packages/react-devtools-shared/src/__tests__/inspectedElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js](packages/react-devtools-shared/src/__tests__/legacy/inspectElement-test.js)\n- [packages/react-devtools-shared/src/__tests__/setupTests.js](packages/react-devtools-shared/src/__tests__/setupTests.js)\n- [packages/react-devtools-shared/src/__tests__/store-test.js](packages/react-devtools-shared/src/__tests__/store-test.js)\n- [packages/react-devtools-shared/src/attachRenderer.js](packages/react-devtools-shared/src/attachRenderer.js)\n- [packages/react-devtools-shared/src/backend/agent.js](packages/react-devtools-shared/src/backend/agent.js)\n- [packages/react-devtools-shared/src/backend/fiber/renderer.js](packages/react-devtools-shared/src/backend/fiber/renderer.js)\n- [packages/react-devtools-shared/src/backend/legacy/renderer.js](packages/react-devtools-shared/src/backend/legacy/renderer.js)\n- [packages/react-devtools-shared/src/backend/types.js](packages/react-devtools-shared/src/backend/types.js)\n- [packages/react-devtools-shared/src/backend/views/Highlighter/index.js](packages/react-devtools-shared/src/backend/views/Highlighter/index.js)\n- [packages/react-devtools-shared/src/backendAPI.js](packages/react-devtools-shared/src/backendAPI.js)\n- [packages/react-devtools-shared/src/bridge.js](packages/react-devtools-shared/src/bridge.js)\n- [packages/react-devtools-shared/src/devtools/store.js](packages/react-devtools-shared/src/devtools/store.js)\n- [packages/react-devtools-shared/src/devtools/utils.js](packages/react-devtools-shared/src/devtools/utils.js)\n- [packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js](packages/react-devtools-shared/src/devtools/views/Profiler/CommitTreeBuilder.js)\n- [packages/react-devtools-shared/src/devtools/views/utils.js](packages/react-devtools-shared/src/devtools/views/utils.js)\n- [packages/react-devtools-shared/src/frontend/types.js](packages/react-devtools-shared/src/frontend/types.js)\n- [packages/react-devtools-shared/src/hook.js](packages/react-devtools-shared/src/hook.js)\n- [packages/react-devtools-shared/src/hydration.js](packages/react-devtools-shared/src/hydration.js)\n- [packages/react-devtools-shared/src/utils.js](packages/react-devtools-shared/src/utils.js)\n- [packages/react-devtools-shell/src/app/ElementTypes/index.js](packages/react-devtools-shell/src/app/ElementTypes/index.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js](packages/react-devtools-shell/src/app/InspectableElements/SimpleValues.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js](packages/react-devtools-shell/src/app/InspectableElements/SymbolKeys.js)\n- [packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js](packages/react-devtools-shell/src/app/InspectableElements/UnserializableProps.js)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/react/src/ReactForwardRef.js](packages/react/src/ReactForwardRef.js)\n- [packages/react/src/ReactMemo.js](packages/react/src/ReactMemo.js)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\n## Purpose and Scope\n\nThis document describes how React DevTools is packaged and distributed across different platforms, and how each distribution integrates with React applications. DevTools exists in multiple formsbrowser extensions, a standalone Electron application, and an embeddable inline libraryall sharing a common backend but using different integration strategies.\n\nFor information about the DevTools architecture and communication protocol between frontend and backend, see [React DevTools Architecture](#7.1).\n\n## Distribution Packages Overview\n\nReact DevTools is published as four distinct npm packages, each serving different use cases:\n\n| Package | Purpose | Primary Use Case |\n|---------|---------|------------------|\n| `react-devtools` | Standalone Electron app | Debugging React Native apps |\n| `react-devtools-core` | Backend and standalone server | Custom integrations, React Native |\n| `react-devtools-inline` | Embeddable frontend + backend | Integrated developer tools in web apps |\n| `react-devtools-extensions` | Browser extensions | Debugging web apps in Chrome, Firefox, Edge |\n\nEach package shares the `react-devtools-shared` codebase but bundles it differently for its target environment.\n\n**Diagram: Distribution Package Architecture**\n\n```mermaid\ngraph TB\n    Shared["react-devtools-shared<br/>(Core functionality)"]\n    \n    subgraph "Distribution Packages"\n        Standalone["react-devtools<br/>Electron app<br/>bin.js, app.js"]\n        Core["react-devtools-core<br/>Backend + Server<br/>backend.js, standalone.js"]\n        Inline["react-devtools-inline<br/>Embeddable<br/>backend.js, frontend.js"]\n        Extensions["react-devtools-extensions<br/>Browser Extensions<br/>Chrome, Firefox, Edge"]\n    end\n    \n    Shared -->|"bundles into"| Standalone\n    Shared -->|"bundles into"| Core\n    Shared -->|"bundles into"| Inline\n    Shared -->|"bundles into"| Extensions\n    \n    subgraph "Build Process"\n        Webpack["Webpack Configurations<br/>webpack.backend.js<br/>webpack.standalone.js<br/>webpack.config.js"]\n    end\n    \n    Webpack -->|"builds"| Standalone\n    Webpack -->|"builds"| Core\n    Webpack -->|"builds"| Inline\n    Webpack -->|"builds"| Extensions\n    \n    subgraph "Target Environments"\n        RN["React Native Apps"]\n        Web["Web Applications"]\n        Browser["Browser DevTools Panel"]\n    end\n    \n    Standalone -->|"connects to"| RN\n    Core -->|"integrates with"| RN\n    Inline -->|"embeds in"| Web\n    Extensions -->|"runs in"| Browser\n```\n\nSources: [packages/react-devtools/package.json:1-32](), [packages/react-devtools-core/package.json:1-38](), [packages/react-devtools-inline/package.json:1-52]()\n\n## Bridge Protocol and Version Compatibility\n\nAll DevTools distributions communicate using a versioned bridge protocol defined in `BRIDGE_PROTOCOL`. This enables graceful handling of version mismatches between frontend and backend.\n\n**Protocol Version Management**\n\nThe bridge protocol uses semantic versioning to track breaking changes:\n\n```mermaid\ngraph LR\n    Frontend["Frontend<br/>(DevTools UI)"]\n    Backend["Backend<br/>(Injected in app)"]\n    Bridge["Bridge Protocol<br/>currentBridgeProtocol"]\n    \n    Frontend -->|"sends/receives messages"| Bridge\n    Backend -->|"sends/receives messages"| Bridge\n    \n    subgraph "Version Checking"\n        V0["Version 0<br/>< 4.11.0"]\n        V1["Version 1<br/>4.13.0 - 4.21.0"]\n        V2["Version 2<br/>4.22.0+<br/>(current)"]\n    end\n    \n    Bridge -->|"version history"| V0\n    Bridge -->|"version history"| V1\n    Bridge -->|"version history"| V2\n    \n    subgraph "Compatibility Checks"\n        UpgradePrompt["Upgrade Prompt<br/>(newer backend)"]\n        DowngradePrompt["Downgrade Prompt<br/>(newer frontend)"]\n    end\n    \n    Frontend -->|"if mismatch"| UpgradePrompt\n    Frontend -->|"if mismatch"| DowngradePrompt\n```\n\nThe protocol version is checked during initialization. Each version includes:\n- `version`: Protocol version number\n- `minNpmVersion`: Minimum compatible npm package version\n- `maxNpmVersion`: Maximum compatible npm package version\n\nWhen incompatibility is detected, the Store sets `_unsupportedBridgeProtocolDetected` and the UI displays an appropriate message.\n\nSources: [packages/react-devtools-shared/src/bridge.js:26-73](), [packages/react-devtools-shared/src/devtools/store.js:254-256]()\n\n## Browser Extensions\n\nBrowser extensions for Chrome, Firefox, and Edge follow Manifest V3 specifications and share most code while adapting to browser-specific APIs.\n\n**Extension Architecture**\n\n```mermaid\ngraph TB\n    subgraph "Extension Components"\n        Background["Background Service Worker<br/>build/background.js"]\n        ContentScript["Content Script<br/>build/prepareInjection.js<br/>(runs at document_start)"]\n        DevToolsPage["DevTools Page<br/>main.html"]\n        Panel["DevTools Panel<br/>panel.html"]\n        Popup["Action Popup<br/>popups/disabled.html"]\n    end\n    \n    subgraph "Injection Process"\n        Hook["Global Hook Script<br/>installHook()"]\n        Backend["Backend Renderer<br/>renderer.js"]\n    end\n    \n    subgraph "Target Page"\n        ReactApp["React Application<br/>window.__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n    end\n    \n    ContentScript -->|"injects"| Hook\n    Hook -->|"installed on"| ReactApp\n    Backend -->|"connects to"| ReactApp\n    \n    Background -->|"manages"| ContentScript\n    DevToolsPage -->|"creates"| Panel\n    Panel -->|"loads"| Backend\n    \n    Panel <-->|"Bridge messages"| Backend\n```\n\n**Manifest Structure**\n\nEach browser has a slightly different manifest configuration:\n\n| Property | Chrome/Edge | Firefox | Purpose |\n|----------|-------------|---------|---------|\n| `manifest_version` | 3 | 3 | Manifest V3 for all browsers |\n| `background` | `service_worker` | `scripts` | Background script execution model |\n| `permissions` | tabs, storage, scripting | tabs, storage, scripting, clipboardWrite | Required permissions |\n| `optional_permissions` | clipboardWrite | - | User-granted permissions |\n| `browser_specific_settings` | - | gecko.id, strict_min_version | Firefox-specific metadata |\n\n**Content Script Injection**\n\nThe extension injects `prepareInjection.js` at `document_start` to ensure the global hook is available before React loads:\n\n1. Content script runs immediately when page loads\n2. Injects the global hook into the page context\n3. The hook intercepts React renderer registrations\n4. When DevTools panel opens, backend connects to hook\n\nSources: [packages/react-devtools-extensions/chrome/manifest.json:1-65](), [packages/react-devtools-extensions/firefox/manifest.json:1-70](), [packages/react-devtools-extensions/edge/manifest.json:1-65]()\n\n## Standalone Electron Application\n\nThe `react-devtools` package provides a standalone Electron application for debugging React Native applications.\n\n**Package Structure**\n\n```mermaid\ngraph TB\n    subgraph "react-devtools Package"\n        Bin["bin.js<br/>(CLI entry point)"]\n        App["app.js<br/>(Main process)"]\n        AppHTML["app.html<br/>(Renderer process)"]\n        Preload["preload.js<br/>(Preload script)"]\n    end\n    \n    subgraph "Dependencies"\n        Electron["electron ^23.1.2"]\n        Core["react-devtools-core"]\n        InternalIP["internal-ip<br/>(Network detection)"]\n        UpdateNotifier["update-notifier<br/>(Version checks)"]\n    end\n    \n    Bin -->|"spawns"| Electron\n    Electron -->|"loads"| App\n    App -->|"creates window with"| AppHTML\n    App -->|"configures"| Preload\n    \n    Core -->|"provides backend"| App\n    InternalIP -->|"detects IP for"| App\n    UpdateNotifier -->|"checks version"| Bin\n    \n    subgraph "Connection Modes"\n        WebSocket["WebSocket Server<br/>(Default port 8097)"]\n        ReactNative["React Native App<br/>connects via ws://"]\n    end\n    \n    Core -->|"starts"| WebSocket\n    ReactNative -->|"connects to"| WebSocket\n```\n\n**Startup Flow**\n\nWhen running `react-devtools` from the command line:\n\n1. `bin.js` checks for updates via `update-notifier`\n2. Spawns Electron with `app.js` as entry point\n3. `app.js` starts a WebSocket server using `react-devtools-core`\n4. Creates Electron window loading `app.html`\n5. React Native app connects to WebSocket server\n6. Frontend and backend communicate over WebSocket bridge\n\n**Command-Line Options**\n\nThe standalone app supports these options:\n- `--port`: WebSocket server port (default: 8097)\n- `--host`: Host to bind to (default: localhost)\n- `--https`: Use HTTPS for secure connections\n- `--react-devtools-port`: Alternative port specification\n\nSources: [packages/react-devtools/package.json:1-32](), [packages/react-devtools-core/package.json:1-38]()\n\n## Inline Embeddable Library\n\nThe `react-devtools-inline` package enables embedding DevTools directly into web applications, useful for development environments and internal tools.\n\n**Package Exports**\n\n```mermaid\ngraph LR\n    subgraph "react-devtools-inline Exports"\n        Backend["backend.js<br/>(Backend bundle)"]\n        Frontend["frontend.js<br/>(Frontend UI bundle)"]\n        HookNames["hookNames.js<br/>(Hook name resolution)"]\n    end\n    \n    subgraph "Build Artifacts"\n        BackendBundle["dist/backend.js<br/>(Webpack bundle)"]\n        FrontendBundle["dist/frontend.js<br/>(Webpack bundle)"]\n    end\n    \n    Backend -->|"exports from"| BackendBundle\n    Frontend -->|"exports from"| FrontendBundle\n    \n    subgraph "Usage Pattern"\n        InitBackend["initialize(contentWindow,<br/>{ bridge, store })"]\n        CreateFrontend["createRoot(container).render(<br/>DevTools bridge={bridge} store={store} />)"]\n    end\n    \n    Backend -->|"provides"| InitBackend\n    Frontend -->|"provides"| CreateFrontend\n    \n    subgraph "Communication"\n        Wall["Wall<br/>(Message passing abstraction)"]\n        BridgeInline["FrontendBridge + BackendBridge"]\n    end\n    \n    InitBackend -->|"uses"| Wall\n    CreateFrontend -->|"uses"| Wall\n    Wall -->|"implements"| BridgeInline\n```\n\n**Integration Example**\n\nTo embed DevTools inline:\n\n```javascript\n// Backend initialization (in target iframe/window)\nimport {initialize as initBackend} from \'react-devtools-inline/backend\';\n\n// Frontend rendering (in host page)\nimport {initialize as initFrontend} from \'react-devtools-inline/frontend\';\nimport {createRoot} from \'react-dom/client\';\n\n// Create bridges\nconst wall = {\n  listen(listener) { /* handle messages */ },\n  send(event, payload) { /* send messages */ }\n};\n\n// Initialize backend in target window\ninitBackend(targetWindow, { wall });\n\n// Render frontend\nconst {bridge, store} = initFrontend(wall);\nconst container = document.getElementById(\'devtools\');\ncreateRoot(container).render(<DevTools bridge={bridge} store={store} />);\n```\n\nThe inline library bundles all shared code into self-contained artifacts that can be loaded independently.\n\nSources: [packages/react-devtools-inline/package.json:1-52]()\n\n## Core Library for Custom Integrations\n\nThe `react-devtools-core` package provides the backend and a standalone server for custom DevTools integrations, primarily used by React Native.\n\n**Package Exports and Build Targets**\n\n```mermaid\ngraph TB\n    subgraph "react-devtools-core"\n        MainExport["main: ./dist/backend.js"]\n        BackendJS["backend.js"]\n        StandaloneJS["standalone.js"]\n    end\n    \n    subgraph "Build Scripts"\n        BuildBackend["build:backend<br/>webpack.backend.js"]\n        BuildBackendFB["build:backend:fb<br/>FEATURE_FLAG_TARGET=core/backend-fb"]\n        BuildStandalone["build:standalone<br/>webpack.standalone.js"]\n        BuildStandaloneFB["build:standalone:fb<br/>FEATURE_FLAG_TARGET=core/standalone-fb"]\n    end\n    \n    BuildBackend -->|"produces"| BackendJS\n    BuildBackendFB -->|"produces"| BackendJS\n    BuildStandalone -->|"produces"| StandaloneJS\n    BuildStandaloneFB -->|"produces"| StandaloneJS\n    \n    subgraph "Feature Flag Targeting"\n        CoreBackend["Core Backend<br/>(OSS)"]\n        CoreBackendFB["Core Backend FB<br/>(Internal)"]\n        CoreStandalone["Core Standalone<br/>(OSS)"]\n        CoreStandaloneFB["Core Standalone FB<br/>(Internal)"]\n    end\n    \n    BuildBackend -->|"targets"| CoreBackend\n    BuildBackendFB -->|"targets"| CoreBackendFB\n    BuildStandalone -->|"targets"| CoreStandalone\n    BuildStandaloneFB -->|"targets"| CoreStandaloneFB\n    \n    subgraph "Dependencies"\n        WS["ws ^7<br/>(WebSocket)"]\n        ShellQuote["shell-quote ^1.6.1<br/>(Command parsing)"]\n    end\n    \n    StandaloneJS -->|"uses"| WS\n    StandaloneJS -->|"uses"| ShellQuote\n```\n\n**Integration Modes**\n\nThe core library supports two integration modes:\n\n1. **Backend-only**: Import `backend.js` to inject the backend into a custom environment\n2. **Standalone server**: Import `standalone.js` to start a WebSocket server for remote connections\n\n**WebSocket Server API**\n\nThe standalone server exposes these methods:\n\n```javascript\nimport {initialize} from \'react-devtools-core/standalone\';\n\nconst server = await initialize({\n  port: 8097,\n  host: \'localhost\',\n  httpsOptions: null, // Optional TLS config\n  onDisconnect: () => { /* cleanup */ },\n  onError: (error) => { /* error handling */ }\n});\n\n// Server provides:\n// - server.close() - Stop the server\n// - server.port - Actual port (useful for port 0)\n```\n\nReact Native integrates by connecting to this WebSocket server during development.\n\nSources: [packages/react-devtools-core/package.json:1-38]()\n\n## Backend Injection Mechanisms\n\nThe DevTools backend must be injected into the target application before React loads. Different distributions use different injection strategies.\n\n**Injection Strategies by Distribution**\n\n```mermaid\ngraph TB\n    subgraph "Browser Extensions"\n        ExtContentScript["Content Script<br/>document_start"]\n        ExtInject["Script Injection<br/>(inline script tag)"]\n        ExtHook["Global Hook Installation<br/>window.__REACT_DEVTOOLS_GLOBAL_HOOK__"]\n        \n        ExtContentScript -->|"injects"| ExtInject\n        ExtInject -->|"installs"| ExtHook\n    end\n    \n    subgraph "Standalone/Core"\n        WSServer["WebSocket Server"]\n        RNClient["React Native Client<br/>setupDevtools()"]\n        RNHook["Native Hook<br/>(RN DevTools integration)"]\n        \n        WSServer -->|"awaits connection"| RNClient\n        RNClient -->|"installs"| RNHook\n    end\n    \n    subgraph "Inline"\n        InlineInit["initialize(window)"]\n        InlineHook["Direct Hook Install<br/>(same context)"]\n        \n        InlineInit -->|"installs"| InlineHook\n    end\n    \n    subgraph "React Application"\n        ReactRenderer["React Renderer<br/>reconcilerVersion"]\n        RendererDetection["Renderer Detection<br/>hook.renderers.set(id, renderer)"]\n        BackendBridge["BackendBridge<br/>operations, events"]\n        \n        ExtHook -->|"detects"| ReactRenderer\n        RNHook -->|"detects"| ReactRenderer\n        InlineHook -->|"detects"| ReactRenderer\n        \n        ReactRenderer -->|"registers with"| RendererDetection\n        RendererDetection -->|"creates"| BackendBridge\n    end\n```\n\n**Global Hook Interface**\n\nAll injection mechanisms install a global hook with this interface:\n\n```javascript\nwindow.__REACT_DEVTOOLS_GLOBAL_HOOK__ = {\n  renderers: Map<RendererID, ReactRenderer>,\n  supportsFiber: true,\n  inject(renderer) { /* called by React */ },\n  onCommitFiberRoot(rendererID, root, priorityLevel) { /* fiber commits */ },\n  onCommitFiberUnmount(rendererID, fiber) { /* fiber unmounts */ },\n  // Backend connection\n  backends: Map<RendererID, RendererInterface>,\n  // Settings from DevTools\n  settings: DevToolsHookSettings\n}\n```\n\nThe hook must be installed synchronously before React loads to intercept renderer registration.\n\n**Backend Initialization Sequence**\n\n```mermaid\nsequenceDiagram\n    participant Hook as Global Hook\n    participant React as React Renderer\n    participant Backend as DevTools Backend\n    participant Agent as Agent\n    participant Bridge as Bridge\n    \n    Note over Hook: 1. Hook installed<br/>(before React loads)\n    \n    React->>Hook: inject(renderer)\n    Hook->>Hook: renderers.set(id, renderer)\n    \n    Note over Backend: 2. Backend connects<br/>(when DevTools opens)\n    \n    Backend->>Hook: Check hook.renderers\n    Backend->>Agent: Create Agent(bridge)\n    \n    loop For each renderer\n        Backend->>Backend: attach(renderer, rendererID)\n        Backend->>Agent: Add RendererInterface\n    end\n    \n    Agent->>Bridge: Send \'operations\' messages\n    Bridge->>Agent: Receive commands\n    \n    Note over React,Backend: 3. Ongoing communication\n    \n    React->>Hook: onCommitFiberRoot(id, root)\n    Hook->>Backend: Forward to backend\n    Backend->>Agent: Process commit\n    Agent->>Bridge: Send tree operations\n```\n\nThe backend uses `Agent` to coordinate multiple `RendererInterface` instances (one per React renderer) and communicate with the frontend via the `Bridge`.\n\nSources: [packages/react-devtools-shared/src/backend/fiber/renderer.js:1007-1014](), [packages/react-devtools-shared/src/backend/agent.js:1-694]()\n\n## Settings and Configuration\n\nDevTools settings can be configured in two places:\n\n1. **Hook Settings**: Injected before React loads via `window.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings`\n2. **Frontend Settings**: Stored in localStorage and synchronized via bridge\n\n**Settings Flow**\n\n```mermaid\ngraph TB\n    subgraph "Settings Sources"\n        HookSettings["Hook Settings<br/>window.__REACT_DEVTOOLS_GLOBAL_HOOK__.settings"]\n        LocalStorage["localStorage<br/>React::DevTools::*"]\n        EnvVars["Environment Variables<br/>process.env.EDITOR_URL"]\n    end\n    \n    subgraph "Backend"\n        BackendInit["Backend Initialization<br/>reads hook.settings"]\n        BackendAgent["Agent<br/>_hookSettings"]\n    end\n    \n    subgraph "Frontend"\n        Store["Store<br/>componentFilters,<br/>collapseNodesByDefault"]\n        SettingsContext["SettingsContext<br/>UI preferences"]\n    end\n    \n    HookSettings -->|"read at init"| BackendInit\n    BackendInit -->|"stores in"| BackendAgent\n    BackendAgent -->|"sends \'hookSettings\'"| Store\n    \n    LocalStorage -->|"loads into"| Store\n    LocalStorage -->|"loads into"| SettingsContext\n    EnvVars -->|"default values"| SettingsContext\n    \n    Store -->|"persists to"| LocalStorage\n    SettingsContext -->|"persists to"| LocalStorage\n```\n\n**Configurable Settings**\n\nKey settings and their storage locations:\n\n| Setting | Storage | Default | Purpose |\n|---------|---------|---------|---------|\n| `componentFilters` | localStorage | `[{type: ElementType, isEnabled: true}]` | Component tree filtering |\n| `collapseNodesByDefault` | localStorage | `true` | Auto-collapse tree nodes |\n| `recordChangeDescriptions` | localStorage | `false` | Profile change descriptions |\n| `EDITOR_URL` | process.env | `\'vscode://file/{path}:{line}:{column}\'` | Open in editor URL pattern |\n| `appendComponentStack` | hook.settings | varies | Append stacks to console |\n| `breakOnConsoleErrors` | hook.settings | varies | Break on console.error |\n| `showInlineWarningsAndErrors` | hook.settings | varies | Display inline errors |\n| `hideConsoleLogsInStrictMode` | hook.settings | varies | Dim duplicate logs |\n\nSettings can be provided at backend initialization time:\n\n```javascript\nimport {installHook} from \'react-devtools-core/backend\';\n\ninstallHook(window, {\n  appendComponentStack: true,\n  breakOnConsoleErrors: false,\n  showInlineWarningsAndErrors: true,\n  hideConsoleLogsInStrictMode: true\n});\n```\n\nSources: [packages/react-devtools-shared/src/backend/types.js:519-534](), [packages/react-devtools-shared/src/devtools/store.js:273-320](), [packages/react-devtools-shared/src/devtools/views/Settings/SettingsContext.js:1-196]()\n\n## Distribution File Sizes and Dependencies\n\nEach distribution has different size constraints and dependency requirements:\n\n**Package Dependencies**\n\n| Package | Runtime Dependencies | Dev Dependencies | Key External Deps |\n|---------|---------------------|------------------|-------------------|\n| `react-devtools` | electron, react-devtools-core, internal-ip | - | Large (Electron app) |\n| `react-devtools-core` | ws, shell-quote | webpack, workerize-loader | Minimal |\n| `react-devtools-inline` | @jridgewell/sourcemap-codec, source-map-js | webpack, babel, playwright | Medium |\n| `react-devtools-extensions` | - | webpack, babel | None (bundled) |\n\n**Build Artifact Sizes** (approximate):\n\n- Browser extensions: ~1-2 MB bundled\n- Standalone app: ~100 MB (includes Electron)\n- Core backend: ~500 KB bundled\n- Inline library: ~1 MB (frontend + backend)\n\nExtensions must minimize bundle size as Chrome Web Store has size limits. The build process uses Closure Compiler for production builds to aggressively minify and tree-shake.\n\nSources: [packages/react-devtools/package.json:24-30](), [packages/react-devtools-core/package.json:27-37](), [packages/react-devtools-inline/package.json:24-51]()\n\n---\n\n# Page: ESLint Plugin for React Hooks\n\n# ESLint Plugin for React Hooks\n\n<details>\n<summary>Relevant source files</summary>\n\nThe following files were used as context for generating this wiki page:\n\n- [.eslintrc.js](.eslintrc.js)\n- [package.json](package.json)\n- [packages/eslint-plugin-react-hooks/package.json](packages/eslint-plugin-react-hooks/package.json)\n- [packages/jest-react/package.json](packages/jest-react/package.json)\n- [packages/react-art/package.json](packages/react-art/package.json)\n- [packages/react-dom/package.json](packages/react-dom/package.json)\n- [packages/react-is/package.json](packages/react-is/package.json)\n- [packages/react-native-renderer/package.json](packages/react-native-renderer/package.json)\n- [packages/react-noop-renderer/package.json](packages/react-noop-renderer/package.json)\n- [packages/react-reconciler/package.json](packages/react-reconciler/package.json)\n- [packages/react-test-renderer/package.json](packages/react-test-renderer/package.json)\n- [packages/react/package.json](packages/react/package.json)\n- [packages/scheduler/package.json](packages/scheduler/package.json)\n- [packages/shared/ReactVersion.js](packages/shared/ReactVersion.js)\n- [scripts/flow/config/flowconfig](scripts/flow/config/flowconfig)\n- [scripts/flow/createFlowConfigs.js](scripts/flow/createFlowConfigs.js)\n- [scripts/flow/environment.js](scripts/flow/environment.js)\n- [scripts/rollup/validate/eslintrc.cjs.js](scripts/rollup/validate/eslintrc.cjs.js)\n- [scripts/rollup/validate/eslintrc.cjs2015.js](scripts/rollup/validate/eslintrc.cjs2015.js)\n- [scripts/rollup/validate/eslintrc.esm.js](scripts/rollup/validate/eslintrc.esm.js)\n- [scripts/rollup/validate/eslintrc.fb.js](scripts/rollup/validate/eslintrc.fb.js)\n- [scripts/rollup/validate/eslintrc.rn.js](scripts/rollup/validate/eslintrc.rn.js)\n- [yarn.lock](yarn.lock)\n\n</details>\n\n\n\nThe ESLint plugin for React Hooks (`eslint-plugin-react-hooks`) is a static analysis tool that enforces the Rules of Hooksthe constraints that govern how React Hooks must be called to ensure correct behavior. The plugin provides two primary rules: `rules-of-hooks` validates that Hooks are only called at the top level of React function components or custom Hooks, and `exhaustive-deps` ensures that effect dependencies are correctly declared.\n\nFor information about the Hooks system implementation itself, see [React Hooks System](#4.3). For DevTools integration with Hooks inspection, see [React DevTools Architecture](#7.1).\n\n---\n\n## Purpose and Scope\n\nThe plugin statically analyzes JavaScript and TypeScript code to detect violations of Hook calling conventions before runtime. It prevents common mistakes such as conditional Hook calls, Hook calls inside loops, or missing effect dependencies that would cause bugs or inconsistent behavior. The plugin integrates directly into the ESLint workflow and supports modern JavaScript syntax including JSX, TypeScript, and Flow.\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:1-68]()\n\n---\n\n## Package Structure and Distribution\n\n```mermaid\ngraph TB\n    subgraph "Package Distribution"\n        PackageJSON["eslint-plugin-react-hooks<br/>package.json"]\n        IndexJS["index.js<br/>Main entry point"]\n        IndexDTS["index.d.ts<br/>TypeScript definitions"]\n        CJSDir["cjs/<br/>Compiled CommonJS"]\n    end\n    \n    subgraph "Source Code (TypeScript)"\n        SrcDir["src/<br/>TypeScript source"]\n        RulesOfHooks["RulesOfHooks.ts<br/>Top-level call validation"]\n        ExhaustiveDeps["ExhaustiveDeps.ts<br/>Dependency validation"]\n    end\n    \n    subgraph "Build Process"\n        TSCompile["TypeScript Compiler"]\n        TSConfig["tsconfig.json"]\n    end\n    \n    subgraph "Dependencies"\n        BabelCore["@babel/core<br/>Parser infrastructure"]\n        BabelParser["@babel/parser<br/>JavaScript parsing"]\n        HermesParser["hermes-parser<br/>Alternative parser"]\n        Zod["zod<br/>Schema validation"]\n    end\n    \n    SrcDir --> TSCompile\n    TSConfig --> TSCompile\n    TSCompile --> CJSDir\n    CJSDir --> IndexJS\n    \n    RulesOfHooks -.part of.-> SrcDir\n    ExhaustiveDeps -.part of.-> SrcDir\n    \n    IndexJS --> PackageJSON\n    IndexDTS --> PackageJSON\n    \n    BabelCore -.required by.-> IndexJS\n    BabelParser -.required by.-> IndexJS\n    HermesParser -.required by.-> IndexJS\n    Zod -.required by.-> IndexJS\n```\n\n**Distribution Format**\n\nThe plugin is distributed as an npm package with the following structure:\n\n| File/Directory | Purpose |\n|----------------|---------|\n| `index.js` | Main entry point that exports the plugin configuration |\n| `index.d.ts` | TypeScript type definitions for IDE integration |\n| `cjs/` | Compiled CommonJS modules from TypeScript source |\n| `package.json` | Package metadata with peer dependency on ESLint 3.x-9.x |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:1-68]()\n\n---\n\n## Integration with React Repository\n\nThe React repository uses the plugin in two distinct ways:\n\n```mermaid\ngraph TB\n    subgraph "React Repository ESLint Setup"\n        RootESLint[".eslintrc.js<br/>Root configuration"]\n        \n        subgraph "Plugin Usage"\n            PublishedPlugin["eslint-plugin-react-hooks-published<br/>npm:eslint-plugin-react-hooks@^5.2.0"]\n            InternalPlugin["eslint-plugin-react-internal<br/>link:./scripts/eslint-rules"]\n        end\n        \n        subgraph "Applied To"\n            DevToolsCode["react-devtools*/**/*.js<br/>DevTools packages"]\n            PluginSource["packages/eslint-plugin-react-hooks/src/**/*<br/>Plugin\'s own TypeScript code"]\n        end\n    end\n    \n    subgraph "Rule Application"\n        RulesOfHooksRule["rules-of-hooks: ERROR<br/>Enforces Hook calling rules"]\n        TSESLintRules["@typescript-eslint rules<br/>For plugin source code"]\n    end\n    \n    RootESLint --> PublishedPlugin\n    RootESLint --> InternalPlugin\n    \n    PublishedPlugin --> DevToolsCode\n    RulesOfHooksRule --> DevToolsCode\n    \n    PluginSource --> TSESLintRules\n```\n\n**Configuration Override for DevTools**\n\nThe plugin is explicitly enabled for DevTools code to catch Hook violations:\n\n```javascript\n// .eslintrc.js lines 522-528\n{\n  files: [\'packages/react-devtools-*/**/*.js\'],\n  excludedFiles: \'**/__tests__/**/*.js\',\n  plugins: [\'eslint-plugin-react-hooks-published\'],\n  rules: {\n    \'react-hooks-published/rules-of-hooks\': ERROR,\n  },\n}\n```\n\n**Configuration Override for Plugin Source**\n\nThe plugin\'s own TypeScript source code has specialized linting configuration:\n\n```javascript\n// .eslintrc.js lines 530-548\n{\n  files: [\'packages/eslint-plugin-react-hooks/src/**/*\'],\n  extends: [\'plugin:@typescript-eslint/recommended\'],\n  parser: \'@typescript-eslint/parser\',\n  plugins: [\'@typescript-eslint\', \'eslint-plugin\'],\n  rules: {\n    \'@typescript-eslint/no-explicit-any\': OFF,\n    \'@typescript-eslint/no-non-null-assertion\': OFF,\n    \'@typescript-eslint/array-type\': [ERROR, {default: \'generic\'}],\n    \'es/no-optional-chaining\': OFF,\n    \'eslint-plugin/prefer-object-rule\': ERROR,\n    \'eslint-plugin/require-meta-fixable\': [ERROR, {catchNoFixerButFixableProperty: true}],\n    \'eslint-plugin/require-meta-has-suggestions\': ERROR,\n  },\n}\n```\n\n**Sources:** [.eslintrc.js:522-548](), [package.json:74-75]()\n\n---\n\n## Core Rules\n\nThe plugin exports two primary ESLint rules:\n\n### rules-of-hooks\n\nValidates that Hooks follow the calling conventions required for correct operation:\n\n| Validation | Description |\n|------------|-------------|\n| **Top-level only** | Hooks must not be called inside loops, conditions, or nested functions |\n| **React functions only** | Hooks must be called from React function components or custom Hooks |\n| **Consistent order** | The order of Hook calls must remain constant across renders |\n\n### exhaustive-deps\n\nEnsures that effect Hooks declare all dependencies correctly:\n\n| Validation | Description |\n|------------|-------------|\n| **Complete dependency list** | All reactive values used inside effects must be in the dependency array |\n| **No unnecessary dependencies** | Warns about dependencies that don\'t need to be in the array |\n| **Stable references** | Detects when dependencies change on every render |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:1-68]()\n\n---\n\n## Parser Support and AST Analysis\n\nThe plugin supports multiple JavaScript parsers to handle different syntax variants:\n\n```mermaid\ngraph LR\n    subgraph "Input Code"\n        JSX["JSX<br/>React components"]\n        TS["TypeScript<br/>Type annotations"]\n        Flow["Flow<br/>Type annotations"]\n        HermesCode["Hermes<br/>React Native syntax"]\n    end\n    \n    subgraph "Parser Selection"\n        BabelParser["@babel/parser<br/>Default JavaScript/JSX/TS"]\n        HermesParser["hermes-parser<br/>React Native specific"]\n        ESLintParser["ESLint configured parser<br/>From ESLint config"]\n    end\n    \n    subgraph "AST Processing"\n        ASTNodes["AST Node Types<br/>CallExpression, Identifier, etc."]\n        Visitors["ESLint Rule Visitors<br/>Traverse and analyze"]\n    end\n    \n    subgraph "Rule Logic"\n        CallSiteAnalysis["Hook Call Site Detection<br/>Find use* calls"]\n        ScopeAnalysis["Scope Analysis<br/>Determine function context"]\n        DependencyTracking["Dependency Tracking<br/>Track reactive values"]\n    end\n    \n    JSX --> BabelParser\n    TS --> BabelParser\n    Flow --> BabelParser\n    HermesCode --> HermesParser\n    \n    BabelParser --> ASTNodes\n    HermesParser --> ASTNodes\n    ESLintParser --> ASTNodes\n    \n    ASTNodes --> Visitors\n    Visitors --> CallSiteAnalysis\n    Visitors --> ScopeAnalysis\n    Visitors --> DependencyTracking\n```\n\n**Parser Dependencies**\n\n| Package | Version | Purpose |\n|---------|---------|---------|\n| `@babel/core` | ^7.24.4 | Core transformation infrastructure |\n| `@babel/parser` | ^7.24.4 | JavaScript/JSX/TypeScript parsing |\n| `hermes-parser` | ^0.25.1 | React Native and Flow syntax support |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:41-46]()\n\n---\n\n## Schema Validation with Zod\n\nThe plugin uses Zod for validating rule options and configurations:\n\n```mermaid\ngraph TB\n    subgraph "Rule Configuration Input"\n        UserConfig["User-provided ESLint config<br/>{rules: {...}}"]\n        RuleOptions["Rule-specific options<br/>Arrays or objects"]\n    end\n    \n    subgraph "Zod Schema Validation"\n        ZodSchema["Zod Schema Definitions<br/>Type-safe validation"]\n        ValidationError["zod-validation-error<br/>User-friendly error messages"]\n    end\n    \n    subgraph "Validated Output"\n        TypedOptions["Typed Rule Options<br/>Safe to use in rule logic"]\n        ErrorMessages["Validation Error Messages<br/>Displayed to user"]\n    end\n    \n    UserConfig --> RuleOptions\n    RuleOptions --> ZodSchema\n    ZodSchema --> TypedOptions\n    ZodSchema --> ValidationError\n    ValidationError --> ErrorMessages\n```\n\n**Validation Benefits**\n\n- **Type Safety**: Rule options are validated against schemas before use\n- **Clear Error Messages**: `zod-validation-error` converts Zod errors to readable ESLint diagnostics\n- **Runtime Guarantees**: Invalid configurations are caught early with helpful feedback\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:45-46]()\n\n---\n\n## Testing Infrastructure\n\n```mermaid\ngraph TB\n    subgraph "Test Organization"\n        TestDir["__tests__/<br/>Test files"]\n        RulesTests["RulesOfHooks.test.ts<br/>Hook calling rule tests"]\n        DepsTests["ExhaustiveDeps.test.ts<br/>Dependency rule tests"]\n    end\n    \n    subgraph "Test Framework"\n        Jest["Jest ^29.5.0<br/>Test runner"]\n        BabelCompiler["@babel/preset-typescript<br/>Compile tests"]\n    end\n    \n    subgraph "Test Utilities"\n        ESLintTester["ESLint RuleTester<br/>Rule testing API"]\n        ParserVariants["Multiple Parser Tests<br/>Babel, TypeScript ESLint, etc."]\n    end\n    \n    subgraph "Test Coverage"\n        ValidCases["Valid Code Examples<br/>Should not trigger errors"]\n        InvalidCases["Invalid Code Examples<br/>Should report violations"]\n        EdgeCases["Edge Cases<br/>Complex scenarios"]\n    end\n    \n    TestDir --> RulesTests\n    TestDir --> DepsTests\n    \n    RulesTests --> Jest\n    DepsTests --> Jest\n    \n    Jest --> BabelCompiler\n    Jest --> ESLintTester\n    \n    ESLintTester --> ParserVariants\n    ParserVariants --> ValidCases\n    ParserVariants --> InvalidCases\n    ParserVariants --> EdgeCases\n```\n\n**Test Execution**\n\nThe plugin\'s test suite is run with:\n\n```bash\n# packages/eslint-plugin-react-hooks/package.json lines 23-26\n"scripts": {\n  "build:compiler": "cd ../../compiler && yarn workspace babel-plugin-react-compiler build",\n  "test": "yarn build:compiler && jest",\n  "typecheck": "tsc --noEmit"\n}\n```\n\n**Parser Compatibility Testing**\n\nThe test suite validates behavior across multiple ESLint parser configurations:\n\n| Parser | Package | Use Case |\n|--------|---------|----------|\n| `babel-eslint` | ^10.0.3 | Legacy Babel parser |\n| `@typescript-eslint/parser` v2-v5 | Multiple versions | TypeScript files across ESLint versions |\n| `eslint` v7-v9 | Multiple versions | Compatibility with different ESLint versions |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:23-26,48-66]()\n\n---\n\n## Build and Compilation Process\n\n```mermaid\ngraph LR\n    subgraph "Source Files"\n        TSSource["src/**/*.ts<br/>TypeScript source"]\n        TSConfig["tsconfig.json<br/>TypeScript config"]\n    end\n    \n    subgraph "Compilation"\n        TypeScript["tsc<br/>TypeScript compiler"]\n        StrictConfig["@tsconfig/strictest<br/>Strict type checking"]\n    end\n    \n    subgraph "Output"\n        CJSOutput["cjs/<br/>CommonJS modules"]\n        DTS["*.d.ts<br/>Type definitions"]\n    end\n    \n    subgraph "Package Artifacts"\n        IndexJS["index.js<br/>Exports rules"]\n        IndexDTS["index.d.ts<br/>Type definitions"]\n    end\n    \n    TSSource --> TypeScript\n    TSConfig --> TypeScript\n    StrictConfig -.configures.-> TypeScript\n    \n    TypeScript --> CJSOutput\n    TypeScript --> DTS\n    \n    CJSOutput --> IndexJS\n    DTS --> IndexDTS\n```\n\n**TypeScript Configuration**\n\nThe plugin uses strict TypeScript settings for type safety:\n\n```typescript\n// Configured via @tsconfig/strictest\n{\n  "extends": "@tsconfig/strictest",\n  // Strict null checks, no implicit any, etc.\n}\n```\n\n**Compilation Command**\n\n```bash\n# TypeScript check without emitting\n"typecheck": "tsc --noEmit"\n```\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:26,52]()\n\n---\n\n## Version Compatibility and Peer Dependencies\n\n| Component | Version Range | Notes |\n|-----------|---------------|-------|\n| **Node.js** | >=18 | Minimum required version |\n| **ESLint** | ^3.0.0 \\|\\| ^4.0.0 \\|\\| ^5.0.0 \\|\\| ^6.0.0 \\|\\| ^7.0.0 \\|\\| ^8.0.0-0 \\|\\| ^9.0.0 | Supports all modern ESLint versions |\n| **Zod** | ^3.25.0 \\|\\| ^4.0.0 | Schema validation library |\n| **React** (indirect) | Any version with Hooks (16.8+) | Plugin works with any React version that supports Hooks |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:34-46]()\n\n---\n\n## Integration with Build System\n\nThe plugin is integrated into the React repository\'s build and validation workflow:\n\n```mermaid\ngraph TB\n    subgraph "Developer Workflow"\n        CodeChange["Developer modifies code"]\n        GitCommit["Git commit"]\n    end\n    \n    subgraph "Lint Stage"\n        ESLintRun["yarn lint<br/>node ./scripts/tasks/eslint.js"]\n        PluginExecution["ESLint runs react-hooks plugin"]\n    end\n    \n    subgraph "Build Stage"\n        BuildAll["yarn build<br/>node ./scripts/rollup/build-all-release-channels.js"]\n        BuildValidation["yarn lint-build<br/>node ./scripts/rollup/validate/index.js"]\n    end\n    \n    subgraph "Test Stage"\n        TestRun["yarn test<br/>node ./scripts/jest/jest-cli.js"]\n        PluginTests["yarn test in eslint-plugin-react-hooks"]\n    end\n    \n    CodeChange --> GitCommit\n    GitCommit --> ESLintRun\n    ESLintRun --> PluginExecution\n    \n    PluginExecution --> BuildAll\n    BuildAll --> BuildValidation\n    \n    BuildValidation --> TestRun\n    TestRun --> PluginTests\n```\n\n**Lint Command**\n\nThe repository\'s lint script applies ESLint (including the Hooks plugin) to all source files:\n\n```bash\n# package.json line 134\n"lint": "node ./scripts/tasks/eslint.js"\n```\n\n**Sources:** [package.json:134-135](), [.eslintrc.js:522-548]()\n\n---\n\n## Rule Enforcement in Different Environments\n\nThe plugin\'s rules are selectively applied based on the code environment:\n\n| Environment | Rule Application | Configuration |\n|-------------|------------------|---------------|\n| **DevTools packages** | `rules-of-hooks` enforced | [.eslintrc.js:522-528]() |\n| **Core React packages** | Not explicitly enabled in config | Developers expected to know Hook rules |\n| **Test files** | Excluded from `react-devtools-*` enforcement | `excludedFiles: \'**/__tests__/**/*.js\'` |\n| **Plugin source code** | TypeScript ESLint rules only | [.eslintrc.js:530-548]() |\n\n**Rationale for Selective Application**\n\n- DevTools uses Hooks extensively and benefits from automated checking\n- Core React packages are authored by developers intimately familiar with Hook rules\n- Test files may intentionally violate Hook rules to test error handling\n\n**Sources:** [.eslintrc.js:522-548]()\n\n---\n\n## Relationship to React Compiler\n\nThe plugin\'s test infrastructure coordinates with the React Compiler (Babel plugin):\n\n```bash\n# packages/eslint-plugin-react-hooks/package.json lines 24-25\n"build:compiler": "cd ../../compiler && yarn workspace babel-plugin-react-compiler build",\n"test": "yarn build:compiler && jest"\n```\n\n**Compiler Integration**\n\nThe React Compiler automatically memoizes components and values, potentially affecting how dependency arrays should be specified. The ESLint plugin\'s tests ensure compatibility with compiler-transformed code.\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:24-25]()\n\n---\n\n## Development and Contribution Workflow\n\n```mermaid\ngraph TB\n    subgraph "Local Development"\n        CloneRepo["Clone facebook/react"]\n        InstallDeps["yarn install"]\n        NavigatePlugin["cd packages/eslint-plugin-react-hooks"]\n    end\n    \n    subgraph "Making Changes"\n        EditSource["Edit src/*.ts files"]\n        RunTests["yarn test"]\n        TypeCheck["yarn typecheck"]\n    end\n    \n    subgraph "Integration Testing"\n        LinkPlugin["Test in consuming project"]\n        YarnLink["yarn link eslint-plugin-react-hooks"]\n    end\n    \n    subgraph "Pull Request"\n        CommitChanges["Commit changes"]\n        CIValidation["CI runs full test suite"]\n        ReviewMerge["Code review and merge"]\n    end\n    \n    CloneRepo --> InstallDeps\n    InstallDeps --> NavigatePlugin\n    NavigatePlugin --> EditSource\n    \n    EditSource --> RunTests\n    EditSource --> TypeCheck\n    \n    RunTests --> LinkPlugin\n    TypeCheck --> LinkPlugin\n    \n    LinkPlugin --> YarnLink\n    YarnLink --> CommitChanges\n    \n    CommitChanges --> CIValidation\n    CIValidation --> ReviewMerge\n```\n\n**Local Development Commands**\n\n```bash\n# Run the plugin\'s test suite\ncd packages/eslint-plugin-react-hooks\nyarn test\n\n# Type check without building\nyarn typecheck\n\n# Test against consuming application\nyarn link\ncd /path/to/your/app\nyarn link eslint-plugin-react-hooks\n```\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:23-26]()\n\n---\n\n## Key Files and Their Roles\n\n| File Path | Purpose |\n|-----------|---------|\n| `packages/eslint-plugin-react-hooks/package.json` | Package metadata, dependencies, and scripts |\n| `packages/eslint-plugin-react-hooks/index.js` | Main entry point exporting rules |\n| `packages/eslint-plugin-react-hooks/index.d.ts` | TypeScript type definitions |\n| `packages/eslint-plugin-react-hooks/src/RulesOfHooks.ts` | Implementation of `rules-of-hooks` rule |\n| `packages/eslint-plugin-react-hooks/src/ExhaustiveDeps.ts` | Implementation of `exhaustive-deps` rule |\n| `packages/eslint-plugin-react-hooks/tsconfig.json` | TypeScript compiler configuration |\n| `.eslintrc.js` (root) | Configures plugin usage in React repository |\n\n**Sources:** [packages/eslint-plugin-react-hooks/package.json:1-68](), [.eslintrc.js:522-548]()', is_error=False)